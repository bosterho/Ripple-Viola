{ Compiled on Wed Aug 14 12:35:20 2024 }
on init
  declare $sksp_dummy
  declare $concat_it
  declare $concat_offset
  declare $string_it
  declare $list_it
  declare $preproc_i
  message("")
  declare ~power_curve_norm
  declare %hide_states[2] := ($HIDE_WHOLE_CONTROL, $HIDE_PART_NOTHING)
  declare $array_i
  declare %black_keys[5] := (1, 3, 6, 8, 10)
  declare !tempo_names[9]
  !tempo_names[0] := "1/32"
  !tempo_names[1] := "1/16 T"
  !tempo_names[2] := "1/16"
  !tempo_names[3] := "1/8 T"
  !tempo_names[4] := "1/8"
  !tempo_names[5] := "1/4 T"
  !tempo_names[6] := "1/4"
  !tempo_names[7] := "1/2"
  !tempo_names[8] := "Bar"
  declare !NOTE_NAME[127]
  declare const $NOTE_NAME__SIZE := 127
  !NOTE_NAME[0] := "C"
  !NOTE_NAME[1] := "C#"
  !NOTE_NAME[2] := "D"
  !NOTE_NAME[3] := "D#"
  !NOTE_NAME[4] := "E"
  !NOTE_NAME[5] := "F"
  !NOTE_NAME[6] := "F#"
  !NOTE_NAME[7] := "G"
  !NOTE_NAME[8] := "G#"
  !NOTE_NAME[9] := "A"
  !NOTE_NAME[10] := "A#"
  !NOTE_NAME[11] := "B"
  !NOTE_NAME[12] := "C"
  !NOTE_NAME[13] := "C#"
  !NOTE_NAME[14] := "D"
  !NOTE_NAME[15] := "D#"
  !NOTE_NAME[16] := "E"
  !NOTE_NAME[17] := "F"
  !NOTE_NAME[18] := "F#"
  !NOTE_NAME[19] := "G"
  !NOTE_NAME[20] := "G#"
  !NOTE_NAME[21] := "A"
  !NOTE_NAME[22] := "A#"
  !NOTE_NAME[23] := "B"
  !NOTE_NAME[24] := "C"
  !NOTE_NAME[25] := "C#"
  !NOTE_NAME[26] := "D"
  !NOTE_NAME[27] := "D#"
  !NOTE_NAME[28] := "E"
  !NOTE_NAME[29] := "F"
  !NOTE_NAME[30] := "F#"
  !NOTE_NAME[31] := "G"
  !NOTE_NAME[32] := "G#"
  !NOTE_NAME[33] := "A"
  !NOTE_NAME[34] := "A#"
  !NOTE_NAME[35] := "B"
  !NOTE_NAME[36] := "C"
  !NOTE_NAME[37] := "C#"
  !NOTE_NAME[38] := "D"
  !NOTE_NAME[39] := "D#"
  !NOTE_NAME[40] := "E"
  !NOTE_NAME[41] := "F"
  !NOTE_NAME[42] := "F#"
  !NOTE_NAME[43] := "G"
  !NOTE_NAME[44] := "G#"
  !NOTE_NAME[45] := "A"
  !NOTE_NAME[46] := "A#"
  !NOTE_NAME[47] := "B"
  !NOTE_NAME[48] := "C"
  !NOTE_NAME[49] := "C#"
  !NOTE_NAME[50] := "D"
  !NOTE_NAME[51] := "D#"
  !NOTE_NAME[52] := "E"
  !NOTE_NAME[53] := "F"
  !NOTE_NAME[54] := "F#"
  !NOTE_NAME[55] := "G"
  !NOTE_NAME[56] := "G#"
  !NOTE_NAME[57] := "A"
  !NOTE_NAME[58] := "A#"
  !NOTE_NAME[59] := "B"
  !NOTE_NAME[60] := "C"
  !NOTE_NAME[61] := "C#"
  !NOTE_NAME[62] := "D"
  !NOTE_NAME[63] := "D#"
  !NOTE_NAME[64] := "E"
  !NOTE_NAME[65] := "F"
  !NOTE_NAME[66] := "F#"
  !NOTE_NAME[67] := "G"
  !NOTE_NAME[68] := "G#"
  !NOTE_NAME[69] := "A"
  !NOTE_NAME[70] := "A#"
  !NOTE_NAME[71] := "B"
  !NOTE_NAME[72] := "C"
  !NOTE_NAME[73] := "C#"
  !NOTE_NAME[74] := "D"
  !NOTE_NAME[75] := "D#"
  !NOTE_NAME[76] := "E"
  !NOTE_NAME[77] := "F"
  !NOTE_NAME[78] := "F#"
  !NOTE_NAME[79] := "G"
  !NOTE_NAME[80] := "G#"
  !NOTE_NAME[81] := "A"
  !NOTE_NAME[82] := "A#"
  !NOTE_NAME[83] := "B"
  !NOTE_NAME[84] := "C"
  !NOTE_NAME[85] := "C#"
  !NOTE_NAME[86] := "D"
  !NOTE_NAME[87] := "D#"
  !NOTE_NAME[88] := "E"
  !NOTE_NAME[89] := "F"
  !NOTE_NAME[90] := "F#"
  !NOTE_NAME[91] := "G"
  !NOTE_NAME[92] := "G#"
  !NOTE_NAME[93] := "A"
  !NOTE_NAME[94] := "A#"
  !NOTE_NAME[95] := "B"
  !NOTE_NAME[96] := "C"
  !NOTE_NAME[97] := "C#"
  !NOTE_NAME[98] := "D"
  !NOTE_NAME[99] := "D#"
  !NOTE_NAME[100] := "E"
  !NOTE_NAME[101] := "F"
  !NOTE_NAME[102] := "F#"
  !NOTE_NAME[103] := "G"
  !NOTE_NAME[104] := "G#"
  !NOTE_NAME[105] := "A"
  !NOTE_NAME[106] := "A#"
  !NOTE_NAME[107] := "B"
  !NOTE_NAME[108] := "C"
  !NOTE_NAME[109] := "C#"
  !NOTE_NAME[110] := "D"
  !NOTE_NAME[111] := "D#"
  !NOTE_NAME[112] := "E"
  !NOTE_NAME[113] := "F"
  !NOTE_NAME[114] := "F#"
  !NOTE_NAME[115] := "G"
  !NOTE_NAME[116] := "G#"
  !NOTE_NAME[117] := "A"
  !NOTE_NAME[118] := "A#"
  !NOTE_NAME[119] := "B"
  !NOTE_NAME[120] := "C"
  !NOTE_NAME[121] := "C#"
  !NOTE_NAME[122] := "D"
  !NOTE_NAME[123] := "D#"
  !NOTE_NAME[124] := "E"
  !NOTE_NAME[125] := "F"
  !NOTE_NAME[126] := "F#"
  declare const $MEM_SIZE := 1000000
  declare const $STACK_SIZE := 1000
  declare const $MAX_TASKS := $MEM_SIZE/$STACK_SIZE-1
  declare const $TASK_0 := $MEM_SIZE-($STACK_SIZE*$MAX_TASKS)
  declare const $TOO_MANY_TASKS := 1
  declare const $STACK_OVERFLOW := 2
  declare const $STACK_UNDERFLOW := 3
  declare %p[$MEM_SIZE]
  declare $sp
  $sp := $TASK_0+$STACK_SIZE
  declare $fp
  $fp := $TASK_0+$STACK_SIZE
  declare $tx
  declare %tstate__id[$MAX_TASKS]
  declare %tstate__sp[$MAX_TASKS]
  declare %tstate__fp[$MAX_TASKS]
  declare %tstate__fs[$MAX_TASKS]
  $tx := 0
  while ($tx<$MAX_TASKS)
    %tstate__fs[$tx] := $TASK_0+($tx*$STACK_SIZE)
    inc($tx)
  end while
  $tx := 0
  %tstate__id[0] := -1
  pgs_create_key(TCM_EXCEPTION,5)
  pgs_set_key_val(TCM_EXCEPTION,$CURRENT_SCRIPT_SLOT,0)
  set_key_pressed_support(1)
  set_snapshot_type(3)
  declare %dev_mode[1]
  load_array(%dev_mode,2)
  set_listener($NI_SIGNAL_TIMER_MS,1000000/30)
  set_listener($NI_SIGNAL_TRANSP_START,1)
  set_listener($NI_SIGNAL_TRANSP_STOP,1)
  SET_CONDITION(NO_SYS_SCRIPT_PEDAL)
  declare $i
  declare const $DOWN := 0
  declare const $UP := 1
  declare const $SHORT := 0
  declare const $LONG := 1
  declare const $NUM_RRS := 4
  declare const $MAX_NUM_CHORD_IDS := 1000
  declare const $control__vol := 0
  declare const $control__reverb := 1
  declare const $control__speed := 2
  declare const $control__direction := 3
  declare const $control__legato := 4
  declare const $control__releaseSamples := 5
  declare const $control__reverb_type := 6
  declare %custom_event_active[1000000]
  declare %custom_event_source[1000000]
  declare %custom_event_note[1000000]
  declare %custom_event_velocity[1000000]
  declare %custom_event_low_note[1000000]
  declare %custom_event_high_note[1000000]
  declare %custom_event_origin_note[1000000]
  declare %custom_event_dest_note[1000000]
  declare %custom_event_first_note[1000000]
  declare %custom_event_second_note[1000000]
  declare %custom_event_direction[1000000]
  declare %custom_event_artic[1000000]
  declare %custom_event_voice[1000000]
  declare %custom_event_note_off_timestamp[1000000]
  declare %custom_event_marked_for_release[1000000]
  declare %custom_event_play_release_sample[1000000]
  declare %custom_event_release_length[1000000]
  declare %custom_event_release_sample_length[1000000]
  declare %custom_event_release_note[1000000]
  declare %custom_event_release_dynamic[1000000]
  declare %custom_event_brightness_when_released[1000000]
  declare %custom_event_waiting_for_release_sample[1000000]
  declare %custom_event_fading_out_for_release_sample[1000000]
  declare %custom_event_rls_sample_id[1000000]
  declare %custom_event_crossfading[1000000]
  declare %custom_event_releasing[1000000]
  declare %custom_event_triggered_by_mf[1000000]
  declare %custom_event_ripple_index[1000000]
  declare %custom_event_preview_being_stopped[1000000]
  declare const $RECORDED_DURATION_QUARTER := 545455
  declare const $RECORDED_DURATION_EIGHTH := 272727
  declare const $MAX_INTERVAL := 5
  declare const $MIN_BRIGHTNESS := 24
  declare !speed_texts[5]
  !speed_texts[0] := "Half"
  !speed_texts[1] := "Triplet"
  !speed_texts[2] := "Original"
  !speed_texts[3] := "Triplet"
  !speed_texts[4] := "Double"
  declare const $speed_texts__SIZE := 5
  declare const $speedMode__halfSpeed := 0
  declare const $speedMode__slowTripletSpeed := 1
  declare const $speedMode__fullSpeed := 2
  declare const $speedMode__fastTripletSpeed := 3
  declare const $speedMode__doubleSpeed := 4
  declare ?speeds[5]
  ?speeds[0] := 2.0
  ?speeds[1] := 1.333
  ?speeds[2] := 1.0
  ?speeds[3] := 0.666
  ?speeds[4] := 0.5
  declare ?latency_offset_multipliers[5]
  ?latency_offset_multipliers[0] := 0.5
  ?latency_offset_multipliers[1] := 0.3333
  ?latency_offset_multipliers[2] := 0.0
  ?latency_offset_multipliers[3] := -0.3333
  ?latency_offset_multipliers[4] := -1.0
  declare !articulation_texts[3]
  !articulation_texts[0] := "Quarters"
  !articulation_texts[1] := "Eighths"
  !articulation_texts[2] := "Sixteenths"
  declare const $articulation_texts__SIZE := 3
  declare const $artic__quarters := 0
  declare const $artic__eighths := 1
  declare const $artic__sixteenths := 2
  declare !direction_texts[3]
  !direction_texts[0] := "Down"
  !direction_texts[1] := "As Played"
  !direction_texts[2] := "Up"
  declare const $direction_texts__SIZE := 3
  declare const $directionMode__down := 0
  declare const $directionMode__asPlayed := 1
  declare const $directionMode__up := 2
  declare !legato_texts[4]
  !legato_texts[0] := "Off"
  !legato_texts[1] := "Sync to Pitch"
  !legato_texts[2] := "Sync to Ripple"
  !legato_texts[3] := "Sync to Swell"
  declare const $legato_texts__SIZE := 4
  declare !vel_to_start_texts[2]
  !vel_to_start_texts[0] := "Vel to Start Off"
  !vel_to_start_texts[1] := "Vel to Start On"
  declare const $vel_to_start_texts__SIZE := 2
  declare const $legatoMode__noLegato := 0
  declare const $legatoMode__syncToPitch := 1
  declare const $legatoMode__syncToRipple := 2
  declare const $legatoMode__syncToSwell := 3
  declare !releaseSamples_texts[6]
  !releaseSamples_texts[0] := "Off"
  !releaseSamples_texts[1] := "Auto"
  !releaseSamples_texts[2] := "1"
  !releaseSamples_texts[3] := "2"
  !releaseSamples_texts[4] := "3"
  !releaseSamples_texts[5] := "4"
  declare const $releaseSamples_texts__SIZE := 6
  declare const $releaseSampleMode__noReleaseSample := 0
  declare const $releaseSampleMode__autoRelease := 1
  declare const $releaseSampleMode__Release0 := 2
  declare const $releaseSampleMode__Release1 := 3
  declare const $releaseSampleMode__Release2 := 4
  declare const $releaseSampleMode__Release3 := 5
  declare !_option_texts[7*10]
  declare const $option_texts__SIZE_D1 := 7
  declare const $option_texts__SIZE_D2 := 10
  declare !_option_texts_shortened[7*10]
  declare const $option_texts_shortened__SIZE_D1 := 7
  declare const $option_texts_shortened__SIZE_D2 := 10
  $i := 0
  while ($i<num_elements(!speed_texts))
    !_option_texts[10*$control__speed+$i] := !speed_texts[$i]
    inc($i)
  end while
  $i := 0
  while ($i<num_elements(!direction_texts))
    !_option_texts[10*$control__direction+$i] := !direction_texts[$i]
    inc($i)
  end while
  $i := 0
  while ($i<num_elements(!legato_texts))
    !_option_texts[10*$control__legato+$i] := !legato_texts[$i]
    inc($i)
  end while
  $i := 0
  while ($i<num_elements(!releaseSamples_texts))
    !_option_texts[10*$control__releaseSamples+$i] := !releaseSamples_texts[$i]
    inc($i)
  end while
  $array_i := 0
  while ($array_i<num_elements(!_option_texts))
    !_option_texts_shortened[$array_i] := !_option_texts[$array_i]
    inc($array_i)
  end while
  !_option_texts_shortened[10*$control__legato+0] := "Off"
  !_option_texts_shortened[10*$control__legato+1] := "Pitches"
  !_option_texts_shortened[10*$control__legato+2] := "Ripples"
  !_option_texts_shortened[10*$control__legato+3] := "Swells"
  declare %release_group[3]
  %release_group[$artic__quarters] := find_group("quarters releases")
  %release_group[$artic__eighths] := find_group("eighths releases")
  %release_group[$artic__sixteenths] := find_group("eighths releases")
  declare const $LOWEST_KEY := 36
  declare const $HIGHEST_KEY := 72
  declare %articulation_keyswitches[3] := (31, 32, 33)
  declare %speed_keyswitches[5] := (72+5, 72+6, 72+7, 72+8, 72+9)
  declare %direction_keyswitches[3] := (72+13, 72+14, 72+15)
  declare %legato_keyswitches[4] := (72+17, 72+18, 72+19, 72+20)
  declare %vel_to_start_keyswitches[2] := (72+21, 72+22)
  declare %release_sample_keyswitches[6] := (72+24, 72+25, 72+26, 72+27, 72+28, 72+29)
  declare %release_trigger_keyswitches[2] := (24, 108)
  declare %all_keyswitches[64]
  declare $total_num_keyswitches
  $i := 0
  while ($i<3)
    %all_keyswitches[$total_num_keyswitches] := %articulation_keyswitches[$i]
    inc($total_num_keyswitches)
    inc($i)
  end while
  $i := 0
  while ($i<5)
    %all_keyswitches[$total_num_keyswitches] := %speed_keyswitches[$i]
    inc($total_num_keyswitches)
    inc($i)
  end while
  $i := 0
  while ($i<3)
    %all_keyswitches[$total_num_keyswitches] := %direction_keyswitches[$i]
    inc($total_num_keyswitches)
    inc($i)
  end while
  $i := 0
  while ($i<4)
    %all_keyswitches[$total_num_keyswitches] := %legato_keyswitches[$i]
    inc($total_num_keyswitches)
    inc($i)
  end while
  $i := 0
  while ($i<6)
    %all_keyswitches[$total_num_keyswitches] := %release_sample_keyswitches[$i]
    inc($total_num_keyswitches)
    inc($i)
  end while
  $i := 0
  while ($i<=1)
    %all_keyswitches[$total_num_keyswitches] := %vel_to_start_keyswitches[$i]
    inc($total_num_keyswitches)
    inc($i)
  end while
  declare %rec_time_sample_lengths[3]
  %rec_time_sample_lengths[$artic__quarters] := $RECORDED_DURATION_QUARTER*16
  %rec_time_sample_lengths[$artic__eighths] := $RECORDED_DURATION_QUARTER*8
  %rec_time_sample_lengths[$artic__sixteenths] := $RECORDED_DURATION_QUARTER*8
  declare %rec_time_ripple_lengths[3]
  %rec_time_ripple_lengths[$artic__quarters] := $RECORDED_DURATION_QUARTER*2
  %rec_time_ripple_lengths[$artic__eighths] := $RECORDED_DURATION_QUARTER
  %rec_time_ripple_lengths[$artic__sixteenths] := $RECORDED_DURATION_QUARTER
  declare %ripple_length_ticks[3]
  %ripple_length_ticks[$artic__quarters] := 960*2
  %ripple_length_ticks[$artic__eighths] := 960
  %ripple_length_ticks[$artic__sixteenths] := 960
  declare %sample_length_ticks[3]
  %sample_length_ticks[$artic__quarters] := 960*16
  %sample_length_ticks[$artic__eighths] := 960*8
  %sample_length_ticks[$artic__sixteenths] := 960*8
  declare %pitch_fractions[3]
  %pitch_fractions[$artic__quarters] := 2
  %pitch_fractions[$artic__eighths] := 2
  %pitch_fractions[$artic__sixteenths] := 4
  declare %stop_offset_rec_time[3]
  %stop_offset_rec_time[$artic__sixteenths] := -20000
  declare %rls_note_timestamp[128]
  declare $latency
  declare %ripples_fading_out[128]
  declare $num_ripples_fading_out
  declare %num_rls_spl_ids[128]
  declare ~db
  declare ~vol
  declare $_
  declare $timestamp_version_shown
  declare $num_active_ripples
  declare $num_keys_active
  declare $num_keys_down
  declare %key_active[128]
  declare %key_down[128]
  declare %rls_note_ids[128]
  declare %notes_to_release[1000]
  declare %voices_to_release[1000]
  declare $num_notes_to_release
  declare %num_ripple_voices[128]
  declare %key_timestamp[128]
  declare %key_history[100]
  declare %ripple_id_history[64]
  declare $direction
  declare $row
  declare $first_ripple_timestamp
  declare $latency_adjusted_first_ripple_timestamp
  declare $cur_midi_page
  make_persistent($cur_midi_page)
  read_persistent_var($cur_midi_page)
  declare $cur_artic
  make_persistent($cur_artic)
  read_persistent_var($cur_artic)
  declare $all_keys_inactive := 1
  declare %velo[128]
  declare %event_ids[128]
  declare %ctrl_ids[7]
  declare $recent_release_trigger_key
  $recent_release_trigger_key := %release_trigger_keyswitches[0]
  declare ~midiInstructions_opacity := 0.0
  declare ~midiCover_opacity := 0.0
  declare ~smoothed_midiInstructions_opacity
  declare ~smoothed_midiCover_opacity
  declare %_midi_event_id[80*1000]
  declare const $midi_event_id__SIZE_D1 := 80
  declare const $midi_event_id__SIZE_D2 := 1000
  declare %_midi_command[80*1000]
  declare const $midi_command__SIZE_D1 := 80
  declare const $midi_command__SIZE_D2 := 1000
  declare %_midi_pos[80*1000]
  declare const $midi_pos__SIZE_D1 := 80
  declare const $midi_pos__SIZE_D2 := 1000
  declare %_midi_byte_1[80*1000]
  declare const $midi_byte_1__SIZE_D1 := 80
  declare const $midi_byte_1__SIZE_D2 := 1000
  declare %_midi_byte_2[80*1000]
  declare const $midi_byte_2__SIZE_D1 := 80
  declare const $midi_byte_2__SIZE_D2 := 1000
  declare %_midi_length[80*1000]
  declare const $midi_length__SIZE_D1 := 80
  declare const $midi_length__SIZE_D2 := 1000
  declare %clip_length[80]
  declare %clip_loop_enabled[80]
  declare %num_midi_events[80]
  declare %num_midi_notes[80]
  declare %num_midi_ccs[80]
  declare %time_started[80]
  declare %cur_event[80]
  declare %playing[80]
  declare %looping[80]
  declare %midi_file_pos_ticks[80]
  declare %cb_id[80]
  declare $hist_i
  declare $voice_i
  declare $par_i
  declare $key_i
  declare $ripple_i
  declare $b
  declare $g
  declare $v
  declare $r
  declare $k
  declare $n
  declare $e
  declare $c
  declare $event_i
  declare $other_event_i
  declare $row_i
  declare $vel_i
  declare $clip_i
  mf_reset()
  mf_set_buffer_size(1000)
  mf_set_num_export_areas(80+1)
  mf_insert_file(get_folder($GET_FOLDER_PATCH_DIR) & "/Midi/midi.mid",0,0,0)
  declare !clip_names[80]
  load_array(!clip_names,2)
  $clip_i := 0
  while ($clip_i<80)
    mf_get_first($clip_i)
    while (mf_get_command() # 0)
      if (mf_get_command()=$MIDI_COMMAND_NOTE_ON)
        %_midi_event_id[1000*$clip_i+%num_midi_events[$clip_i]] := mf_get_id()
        %custom_event_source[mf_get_id() mod 1000000] := -1
        %_midi_command[1000*$clip_i+%num_midi_events[$clip_i]] := mf_get_command()
        %_midi_pos[1000*$clip_i+%num_midi_events[$clip_i]] := mf_get_pos()
        %_midi_byte_1[1000*$clip_i+%num_midi_events[$clip_i]] := mf_get_byte_one()
        %_midi_byte_2[1000*$clip_i+%num_midi_events[$clip_i]] := mf_get_byte_two()
        %_midi_length[1000*$clip_i+%num_midi_events[$clip_i]] := mf_get_note_length()
        inc(%num_midi_events[$clip_i])
        inc(%num_midi_notes[$clip_i])
      end if
      mf_get_next($clip_i)
    end while
    mf_get_first($clip_i)
    while (mf_get_command() # 0)
      if (mf_get_command()=$MIDI_COMMAND_CC and (mf_get_byte_one()=64))
        declare $cc_inserted
        $cc_inserted := 0
        $event_i := 0
        while ($event_i<%num_midi_events[$clip_i])
          if ($cc_inserted=0)
            declare $insert_index
            $insert_index := -1
            if ($event_i=0)
              if (mf_get_pos()<%_midi_pos[1000*$clip_i+0])
                $insert_index := 0
              end if
            end if
            if (in_range($event_i,1,%num_midi_events[$clip_i]-2))
              if (mf_get_pos()>%_midi_pos[1000*$clip_i+$event_i] and (mf_get_pos()<%_midi_pos[1000*$clip_i+$event_i+1]))
                $insert_index := $event_i+1
              end if
            end if
            if ($event_i=(%num_midi_events[$clip_i]-1))
              if (mf_get_pos()>%_midi_pos[1000*$clip_i+(%num_midi_events[$clip_i]-1)])
                $insert_index := %num_midi_events[$clip_i]
              end if
            end if
            if (mf_get_pos()=%_midi_pos[1000*$clip_i+$event_i])
              $insert_index := $event_i
            end if
            if ($insert_index # -1)
              $cc_inserted := 1
              $other_event_i := 1000-1
              while ($other_event_i>=($insert_index+1))
                %_midi_event_id[1000*$clip_i+$other_event_i] := %_midi_event_id[1000*$clip_i+($other_event_i-1)]
                %_midi_command[1000*$clip_i+$other_event_i] := %_midi_command[1000*$clip_i+($other_event_i-1)]
                %_midi_pos[1000*$clip_i+$other_event_i] := %_midi_pos[1000*$clip_i+($other_event_i-1)]
                %_midi_byte_1[1000*$clip_i+$other_event_i] := %_midi_byte_1[1000*$clip_i+($other_event_i-1)]
                %_midi_byte_2[1000*$clip_i+$other_event_i] := %_midi_byte_2[1000*$clip_i+($other_event_i-1)]
                %_midi_length[1000*$clip_i+$other_event_i] := %_midi_length[1000*$clip_i+($other_event_i-1)]
                dec($other_event_i)
              end while
              %_midi_event_id[1000*$clip_i+$insert_index] := mf_get_id()
              %_midi_command[1000*$clip_i+$insert_index] := mf_get_command()
              %_midi_pos[1000*$clip_i+$insert_index] := mf_get_pos()
              %_midi_byte_1[1000*$clip_i+$insert_index] := mf_get_byte_one()
              %_midi_byte_2[1000*$clip_i+$insert_index] := mf_get_byte_two()
            end if
          end if
          inc($event_i)
        end while
        inc(%num_midi_events[$clip_i])
        inc(%num_midi_ccs[$clip_i])
      end if
      mf_get_next($clip_i)
    end while
    inc($clip_i)
  end while
  $clip_i := 0
  while ($clip_i<80)
    mf_get_first($clip_i)
    while (mf_get_command() # 0)
      if (mf_get_command()=$MIDI_COMMAND_CC)
        if (mf_get_byte_one()=103)
          %clip_length[$clip_i] := mf_get_pos()
          if (mf_get_byte_two()=127)
            %clip_loop_enabled[$clip_i] := 1
          else
            %clip_loop_enabled[$clip_i] := 0
          end if
        end if
      end if
      mf_get_next($clip_i)
    end while
    inc($clip_i)
  end while
  declare ui_panel $ripples_panel
  set_control_par(get_ui_id($ripples_panel),$CONTROL_PAR_Z_LAYER,-1)
  declare %ripple[64]
  declare ui_slider $ripple0(0,127)
  declare ui_slider $ripple1(0,127)
  declare ui_slider $ripple2(0,127)
  declare ui_slider $ripple3(0,127)
  declare ui_slider $ripple4(0,127)
  declare ui_slider $ripple5(0,127)
  declare ui_slider $ripple6(0,127)
  declare ui_slider $ripple7(0,127)
  declare ui_slider $ripple8(0,127)
  declare ui_slider $ripple9(0,127)
  declare ui_slider $ripple10(0,127)
  declare ui_slider $ripple11(0,127)
  declare ui_slider $ripple12(0,127)
  declare ui_slider $ripple13(0,127)
  declare ui_slider $ripple14(0,127)
  declare ui_slider $ripple15(0,127)
  declare ui_slider $ripple16(0,127)
  declare ui_slider $ripple17(0,127)
  declare ui_slider $ripple18(0,127)
  declare ui_slider $ripple19(0,127)
  declare ui_slider $ripple20(0,127)
  declare ui_slider $ripple21(0,127)
  declare ui_slider $ripple22(0,127)
  declare ui_slider $ripple23(0,127)
  declare ui_slider $ripple24(0,127)
  declare ui_slider $ripple25(0,127)
  declare ui_slider $ripple26(0,127)
  declare ui_slider $ripple27(0,127)
  declare ui_slider $ripple28(0,127)
  declare ui_slider $ripple29(0,127)
  declare ui_slider $ripple30(0,127)
  declare ui_slider $ripple31(0,127)
  declare ui_slider $ripple32(0,127)
  declare ui_slider $ripple33(0,127)
  declare ui_slider $ripple34(0,127)
  declare ui_slider $ripple35(0,127)
  declare ui_slider $ripple36(0,127)
  declare ui_slider $ripple37(0,127)
  declare ui_slider $ripple38(0,127)
  declare ui_slider $ripple39(0,127)
  declare ui_slider $ripple40(0,127)
  declare ui_slider $ripple41(0,127)
  declare ui_slider $ripple42(0,127)
  declare ui_slider $ripple43(0,127)
  declare ui_slider $ripple44(0,127)
  declare ui_slider $ripple45(0,127)
  declare ui_slider $ripple46(0,127)
  declare ui_slider $ripple47(0,127)
  declare ui_slider $ripple48(0,127)
  declare ui_slider $ripple49(0,127)
  declare ui_slider $ripple50(0,127)
  declare ui_slider $ripple51(0,127)
  declare ui_slider $ripple52(0,127)
  declare ui_slider $ripple53(0,127)
  declare ui_slider $ripple54(0,127)
  declare ui_slider $ripple55(0,127)
  declare ui_slider $ripple56(0,127)
  declare ui_slider $ripple57(0,127)
  declare ui_slider $ripple58(0,127)
  declare ui_slider $ripple59(0,127)
  declare ui_slider $ripple60(0,127)
  declare ui_slider $ripple61(0,127)
  declare ui_slider $ripple62(0,127)
  declare ui_slider $ripple63(0,127)
  $preproc_i := 0
  while ($preproc_i<=63)
    %ripple[$preproc_i] := get_ui_id($ripple0)+$preproc_i
    inc($preproc_i)
  end while
  $i := 0
  while ($i<num_elements(%ripple))
    set_control_par(%ripple[$i],$CONTROL_PAR_PARENT_PANEL,get_ui_id($ripples_panel))
    set_control_par(%ripple[$i],$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
    inc($i)
  end while
  declare %ripple_swell[64]
  declare ui_slider $ripple_swell0(0,127)
  declare ui_slider $ripple_swell1(0,127)
  declare ui_slider $ripple_swell2(0,127)
  declare ui_slider $ripple_swell3(0,127)
  declare ui_slider $ripple_swell4(0,127)
  declare ui_slider $ripple_swell5(0,127)
  declare ui_slider $ripple_swell6(0,127)
  declare ui_slider $ripple_swell7(0,127)
  declare ui_slider $ripple_swell8(0,127)
  declare ui_slider $ripple_swell9(0,127)
  declare ui_slider $ripple_swell10(0,127)
  declare ui_slider $ripple_swell11(0,127)
  declare ui_slider $ripple_swell12(0,127)
  declare ui_slider $ripple_swell13(0,127)
  declare ui_slider $ripple_swell14(0,127)
  declare ui_slider $ripple_swell15(0,127)
  declare ui_slider $ripple_swell16(0,127)
  declare ui_slider $ripple_swell17(0,127)
  declare ui_slider $ripple_swell18(0,127)
  declare ui_slider $ripple_swell19(0,127)
  declare ui_slider $ripple_swell20(0,127)
  declare ui_slider $ripple_swell21(0,127)
  declare ui_slider $ripple_swell22(0,127)
  declare ui_slider $ripple_swell23(0,127)
  declare ui_slider $ripple_swell24(0,127)
  declare ui_slider $ripple_swell25(0,127)
  declare ui_slider $ripple_swell26(0,127)
  declare ui_slider $ripple_swell27(0,127)
  declare ui_slider $ripple_swell28(0,127)
  declare ui_slider $ripple_swell29(0,127)
  declare ui_slider $ripple_swell30(0,127)
  declare ui_slider $ripple_swell31(0,127)
  declare ui_slider $ripple_swell32(0,127)
  declare ui_slider $ripple_swell33(0,127)
  declare ui_slider $ripple_swell34(0,127)
  declare ui_slider $ripple_swell35(0,127)
  declare ui_slider $ripple_swell36(0,127)
  declare ui_slider $ripple_swell37(0,127)
  declare ui_slider $ripple_swell38(0,127)
  declare ui_slider $ripple_swell39(0,127)
  declare ui_slider $ripple_swell40(0,127)
  declare ui_slider $ripple_swell41(0,127)
  declare ui_slider $ripple_swell42(0,127)
  declare ui_slider $ripple_swell43(0,127)
  declare ui_slider $ripple_swell44(0,127)
  declare ui_slider $ripple_swell45(0,127)
  declare ui_slider $ripple_swell46(0,127)
  declare ui_slider $ripple_swell47(0,127)
  declare ui_slider $ripple_swell48(0,127)
  declare ui_slider $ripple_swell49(0,127)
  declare ui_slider $ripple_swell50(0,127)
  declare ui_slider $ripple_swell51(0,127)
  declare ui_slider $ripple_swell52(0,127)
  declare ui_slider $ripple_swell53(0,127)
  declare ui_slider $ripple_swell54(0,127)
  declare ui_slider $ripple_swell55(0,127)
  declare ui_slider $ripple_swell56(0,127)
  declare ui_slider $ripple_swell57(0,127)
  declare ui_slider $ripple_swell58(0,127)
  declare ui_slider $ripple_swell59(0,127)
  declare ui_slider $ripple_swell60(0,127)
  declare ui_slider $ripple_swell61(0,127)
  declare ui_slider $ripple_swell62(0,127)
  declare ui_slider $ripple_swell63(0,127)
  $preproc_i := 0
  while ($preproc_i<=63)
    %ripple_swell[$preproc_i] := get_ui_id($ripple_swell0)+$preproc_i
    inc($preproc_i)
  end while
  $i := 0
  while ($i<num_elements(%ripple_swell))
    set_control_par(%ripple_swell[$i],$CONTROL_PAR_PARENT_PANEL,get_ui_id($ripples_panel))
    set_control_par(%ripple_swell[$i],$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
    inc($i)
  end while
  make_perfview
  set_ui_width_px(900)
  set_ui_height_px(427)
  set_control_par_str($INST_ICON_ID,$CONTROL_PAR_PICTURE,"ui_icon")
  set_control_par_str($INST_WALLPAPER_ID,$CONTROL_PAR_PICTURE,"ui_background")
  declare $figma_counter
  declare $figma_counter_multi_line_labels
  declare %UI_x[621] := (0, 2, 692, 498, 340, 109, 607, 168, 48, 2, 26, 0, 2, 294, 11, 740, 592, 444, 296, 740, 592, 444, 296, 11, 740, 592, 444, 296, 740, 592, 444, 296, 11, 740, 592, 444, 296, 740, 592, 444, 296, ...
  11, 740, 592, 444, 296, 740, 592, 444, 296, 11, 740, 592, 444, 296, 740, 592, 444, 296, 11, 740, 592, 444, 296, 740, 592, 444, 296, 11, 740, 592, 444, 296, 740, 592, 444, 296, 11, 740, 592, 444, ...
  296, 740, 592, 444, 296, 11, 740, 592, 444, 296, 740, 592, 444, 296, 11, 740, 592, 444, 296, 740, 592, 444, 296, 146, 120, 94, 68, 28, -1, 161, 139, 93, 44, 13, 116, 129, 54, 7, 183, 137, ...
  86, 41, 5, 9, 435, 316, 197, 716, -1, 31, 63, 95, 127, 159, 191, 223, 255, 287, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, ...
  107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, ...
  107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 107, 106, 107, 107, 107, 107, 124, 181, 10, -1, 345, 0, 0, 0, 0, 0, 0, 0, 0, -10, 4, 0, 0, 0, 5, 704, 12, 27, ...
  47, 88, 27, 4, 6, 17, 57, 62, 3, 236, 829, 806, 760, 714, 668, 645, 599, 553, 783, 737, 691, 622, 576, 530, 484, 438, 392, 369, 323, 277, 507, 461, 415, 346, 300, 254, 208, 162, 116, 93, ...
  47, 1, 231, 185, 139, 70, 24, 865, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ...
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ...
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ...
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ...
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ...
  0, 0, 0, 0, 0, 0, 0, 0, -1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ...
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 60, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ...
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ...
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
  declare %UI_y[621] := (0, 330, 14, 14, 14, 14, 234, 8, 8, 234, 131, 0, 1, 201, 242, 92, 92, 92, 92, 0, 0, 0, 0, 242, 92, 92, 92, 92, 0, 0, 0, 0, 242, 92, 92, 92, 92, 0, 0, 0, 0, ...
  242, 92, 92, 92, 92, 0, 0, 0, 0, 242, 92, 92, 92, 92, 0, 0, 0, 0, 242, 92, 92, 92, 92, 0, 0, 0, 0, 242, 92, 92, 92, 92, 0, 0, 0, 0, 242, 92, 92, 92, ...
  92, 0, 0, 0, 0, 242, 92, 92, 92, 92, 0, 0, 0, 0, 242, 92, 92, 92, 92, 0, 0, 0, 0, 49, 49, 49, 49, 49, 49, -1, 49, 49, 49, 49, -1, 49, 49, 49, 49, 49, ...
  49, 49, 49, 70, 26, 26, 26, 6, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ...
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ...
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 241, 241, 241, -1, 3, -1, -1, 2, -1, -1, -1, -1, -1, 17, 17, 17, 17, 0, 0, 2, -1, -1, ...
  -1, -1, 27, 24, 72, 13, 71, 14, 70, 75, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, ...
  1, 1, 1, 1, 1, 1, 1, 49, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ...
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ...
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ...
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ...
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ...
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ...
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 43, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ...
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, ...
  0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0)
  declare %UI_width[621] := (900, 896, 197, 175, 165, 231, 291, 74, 83, 604, 852, 898, 896, 310, 876, 136, 136, 136, 136, 136, 136, 136, 136, 876, 136, 136, 136, 136, 136, 136, 136, 136, 876, 136, 136, 136, 136, 136, 136, 136, 136, ...
  876, 136, 136, 136, 136, 136, 136, 136, 136, 876, 136, 136, 136, 136, 136, 136, 136, 136, 876, 136, 136, 136, 136, 136, 136, 136, 136, 876, 136, 136, 136, 136, 136, 136, 136, 136, 876, 136, 136, 136, ...
  136, 136, 136, 136, 136, 876, 136, 136, 136, 136, 136, 136, 136, 136, 876, 136, 136, 136, 136, 136, 136, 136, 136, 27, 27, 27, 27, 39, 34, 36, 48, 55, 53, 35, 76, 26, 61, 43, 48, 45, ...
  52, 45, 35, 54, 133, 91, 91, 170, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, ...
  28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 28, ...
  28, 28, 28, 28, 28, 28, 28, 28, 28, 28, 29, 29, 29, 29, 29, 29, 29, 28, 58, 115, 115, 901, 210, 899, 899, 899, 899, 899, 899, 899, 899, 201, 182, 165, 225, 74, 74, 193, 145, 131, ...
  100, 70, 74, 174, 30, 33, 18, 46, 77, 430, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, ...
  22, 22, 22, 22, 22, 22, 22, 38, 896, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 285, 136, 109, 136, 136, 109, 136, ...
  136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 285, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, ...
  136, 109, 136, 285, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 285, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, ...
  136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 285, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 285, 136, ...
  109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 285, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, ...
  109, 136, 136, 109, 136, 136, 109, 136, 285, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 285, 136, 109, 136, 136, 109, 136, ...
  136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 136, 109, 136, 285, 53, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, ...
  136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, ...
  136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136, 136)
  declare %UI_height[621] := (427, 95, 68, 64, 64, 64, 95, 85, 88, 95, 38, 427, 424, 24, 182, 80, 80, 80, 80, 80, 80, 80, 80, 182, 80, 80, 80, 80, 80, 80, 80, 80, 182, 80, 80, 80, 80, 80, 80, 80, 80, ...
  182, 80, 80, 80, 80, 80, 80, 80, 80, 182, 80, 80, 80, 80, 80, 80, 80, 80, 182, 80, 80, 80, 80, 80, 80, 80, 80, 182, 80, 80, 80, 80, 80, 80, 80, 80, 182, 80, 80, 80, ...
  80, 80, 80, 80, 80, 182, 80, 80, 80, 80, 80, 80, 80, 80, 182, 80, 80, 80, 80, 80, 80, 80, 80, 15, 15, 15, 15, 19, 15, 20, 19, 19, 19, 15, 20, 15, 15, 15, 15, 15, ...
  15, 15, 15, 19, 43, 43, 43, 50, 23, 23, 23, 23, 23, 23, 23, 23, 23, 23, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, ...
  27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 27, ...
  27, 27, 27, 27, 27, 27, 27, 27, 27, 27, 28, 28, 28, 28, 28, 28, 28, 27, 174, 174, 174, 147, 63, 423, 423, 423, 423, 423, 423, 427, 426, 33, 33, 33, 33, 74, 74, 70, 21, 21, ...
  21, 21, 45, 45, 30, 52, 13, 35, 18, 49, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, ...
  36, 36, 36, 36, 36, 36, 36, 18, 424, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 173, 80, 80, 80, 80, 80, 80, ...
  80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 173, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, ...
  80, 80, 80, 173, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 173, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, ...
  80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 173, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 173, 80, ...
  80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 173, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, ...
  80, 80, 80, 80, 80, 80, 80, 80, 173, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 173, 80, 80, 80, 80, 80, 80, ...
  80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 173, 18, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, ...
  80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, ...
  80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80, 80)
  declare %UI_skin[621] := (-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, ...
  0, 0, 0, 3, 4, 5, 6, 3, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, ...
  8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, ...
  8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 8, 0, 9, 10, 0, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 24, 25, 26, 27, ...
  28, 29, 30, 31, 32, 33, 34, 35, 0, 36, 37, 37, 37, 37, 37, 37, 37, 37, 38, 38, 38, 38, 38, 37, 37, 37, 37, 37, 37, 37, 38, 38, 38, 38, 38, 37, 37, 37, 37, 37, ...
  37, 37, 38, 38, 38, 38, 38, 0, 39, 40, 3, 41, 40, 3, 42, 40, 3, 43, 40, 3, 44, 40, 3, 45, 40, 3, 46, 40, 3, 47, 40, 3, 48, 49, 40, 3, 50, 40, 3, 51, ...
  40, 3, 52, 40, 3, 53, 40, 3, 54, 40, 3, 55, 40, 3, 56, 40, 3, 57, 58, 40, 3, 59, 40, 3, 60, 40, 3, 61, 40, 3, 62, 40, 3, 63, 40, 3, 64, 40, 3, 65, ...
  40, 3, 66, 67, 40, 3, 68, 40, 3, 69, 40, 3, 70, 40, 3, 71, 40, 3, 72, 40, 3, 73, 40, 3, 74, 40, 3, 75, 76, 40, 3, 77, 40, 3, 78, 40, 3, 79, 40, 3, ...
  80, 40, 3, 81, 40, 3, 82, 40, 3, 83, 40, 3, 84, 85, 40, 3, 86, 40, 3, 87, 40, 3, 88, 40, 3, 89, 40, 3, 90, 40, 3, 91, 40, 3, 92, 40, 3, 93, 94, 40, ...
  3, 95, 40, 3, 96, 40, 3, 97, 40, 3, 98, 40, 3, 99, 40, 3, 100, 40, 3, 101, 40, 3, 102, 103, 40, 3, 104, 40, 3, 105, 40, 3, 106, 40, 3, 107, 40, 3, 108, 40, ...
  3, 109, 40, 3, 110, 40, 3, 111, 112, 40, 3, 113, 40, 3, 114, 40, 3, 115, 40, 3, 116, 40, 3, 117, 40, 3, 118, 40, 3, 119, 40, 3, 120, 121, 40, 3, 122, 40, 3, 123, ...
  40, 3, 124, 40, 3, 125, 40, 3, 126, 40, 3, 127, 40, 3, 128, 40, 3, 129, 130, 0, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 149, 150, ...
  151, 152, 153, 154, 155, 156, 157, 158, 159, 160, 161, 162, 163, 164, 165, 166, 167, 168, 169, 170, 171, 172, 173, 174, 175, 176, 177, 178, 179, 180, 181, 182, 183, 184, 185, 186, 187, 188, 189, 190, ...
  191, 192, 193, 194, 195, 196, 197, 198, 199, 200, 201, 202, 203, 204, 205, 206, 207, 208, 209, 210)
  declare %UI_font[621] := (-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, 0, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1)
  declare %UI_label_text[621] := (-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, 0, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1)
  declare %UI_default_value[621] := (-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1)
  declare %UI_mouse_behaviour[621] := (-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -800, -800, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1)
  declare %UI_mouse_behaviour_x[621] := (-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1)
  declare %UI_mouse_behaviour_y[621] := (-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1)
  declare %UI_z_layer[621] := (-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, 0, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 1, 1, 1, 1, 1, -1, -1, -1, -1, -1, -1, -1, 1, 1, 1, 1, 1, -1, -1, -1, -1, -1, ...
  -1, -1, 1, 1, 1, 1, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1)
  declare !skin_picture[211]
  !skin_picture[0] := "label_transparent"
  !skin_picture[1] := "release samples mw control"
  !skin_picture[2] := "vel to sample start"
  !skin_picture[3] := "blank"
  !skin_picture[4] := "sixteenths"
  !skin_picture[5] := "eighths"
  !skin_picture[6] := "quarters"
  !skin_picture[7] := "dot"
  !skin_picture[8] := "preview"
  !skin_picture[9] := "next midi page"
  !skin_picture[10] := "prev midi page"
  !skin_picture[11] := "title"
  !skin_picture[12] := "switch_releaseSamplesInfoDisp"
  !skin_picture[13] := "switch_legatoInfoDisp"
  !skin_picture[14] := "switch_directionInfoDisp"
  !skin_picture[15] := "switch_speedInfoDisp"
  !skin_picture[16] := "switch_optionsInfoDisp"
  !skin_picture[17] := "switch_articulationsInfoDisp"
  !skin_picture[18] := "switch_generalInfoDisp"
  !skin_picture[19] := "switch_titleInfoDisp"
  !skin_picture[20] := "6 step slider"
  !skin_picture[21] := "4 step slider"
  !skin_picture[22] := "3 step slider"
  !skin_picture[23] := "5 step slider"
  !skin_picture[24] := "knob"
  !skin_picture[25] := "Logo animation"
  !skin_picture[26] := "release samples info"
  !skin_picture[27] := "legato info"
  !skin_picture[28] := "direction info"
  !skin_picture[29] := "speed info"
  !skin_picture[30] := "options info"
  !skin_picture[31] := "articulations info"
  !skin_picture[32] := "general info"
  !skin_picture[33] := "lightbulb"
  !skin_picture[34] := "reverb menu"
  !skin_picture[35] := "latency"
  !skin_picture[36] := "label_midiInstructions"
  !skin_picture[37] := "white key"
  !skin_picture[38] := "black key"
  !skin_picture[39] := "label_midiCover"
  !skin_picture[40] := "label_clipOutline"
  !skin_picture[41] := "clip79"
  !skin_picture[42] := "clip78"
  !skin_picture[43] := "clip77"
  !skin_picture[44] := "clip76"
  !skin_picture[45] := "clip75"
  !skin_picture[46] := "clip74"
  !skin_picture[47] := "clip73"
  !skin_picture[48] := "clip72"
  !skin_picture[49] := "label_midiPg9Description"
  !skin_picture[50] := "clip71"
  !skin_picture[51] := "clip70"
  !skin_picture[52] := "clip69"
  !skin_picture[53] := "clip68"
  !skin_picture[54] := "clip67"
  !skin_picture[55] := "clip66"
  !skin_picture[56] := "clip65"
  !skin_picture[57] := "clip64"
  !skin_picture[58] := "label_midiPg8Description"
  !skin_picture[59] := "clip63"
  !skin_picture[60] := "clip62"
  !skin_picture[61] := "clip61"
  !skin_picture[62] := "clip60"
  !skin_picture[63] := "clip59"
  !skin_picture[64] := "clip58"
  !skin_picture[65] := "clip57"
  !skin_picture[66] := "clip56"
  !skin_picture[67] := "label_midiPg7Description"
  !skin_picture[68] := "clip55"
  !skin_picture[69] := "clip54"
  !skin_picture[70] := "clip53"
  !skin_picture[71] := "clip52"
  !skin_picture[72] := "clip51"
  !skin_picture[73] := "clip50"
  !skin_picture[74] := "clip49"
  !skin_picture[75] := "clip48"
  !skin_picture[76] := "label_midiPg6Description"
  !skin_picture[77] := "clip47"
  !skin_picture[78] := "clip46"
  !skin_picture[79] := "clip45"
  !skin_picture[80] := "clip44"
  !skin_picture[81] := "clip43"
  !skin_picture[82] := "clip42"
  !skin_picture[83] := "clip41"
  !skin_picture[84] := "clip40"
  !skin_picture[85] := "label_midiPg5Description"
  !skin_picture[86] := "clip39"
  !skin_picture[87] := "clip38"
  !skin_picture[88] := "clip37"
  !skin_picture[89] := "clip36"
  !skin_picture[90] := "clip35"
  !skin_picture[91] := "clip34"
  !skin_picture[92] := "clip33"
  !skin_picture[93] := "clip32"
  !skin_picture[94] := "label_midiPg4Description"
  !skin_picture[95] := "clip31"
  !skin_picture[96] := "clip30"
  !skin_picture[97] := "clip29"
  !skin_picture[98] := "clip28"
  !skin_picture[99] := "clip27"
  !skin_picture[100] := "clip26"
  !skin_picture[101] := "clip25"
  !skin_picture[102] := "clip24"
  !skin_picture[103] := "label_midiPg3Description"
  !skin_picture[104] := "clip23"
  !skin_picture[105] := "clip22"
  !skin_picture[106] := "clip21"
  !skin_picture[107] := "clip20"
  !skin_picture[108] := "clip19"
  !skin_picture[109] := "clip18"
  !skin_picture[110] := "clip17"
  !skin_picture[111] := "clip16"
  !skin_picture[112] := "label_midiPg2Description"
  !skin_picture[113] := "clip15"
  !skin_picture[114] := "clip14"
  !skin_picture[115] := "clip13"
  !skin_picture[116] := "clip12"
  !skin_picture[117] := "clip11"
  !skin_picture[118] := "clip10"
  !skin_picture[119] := "clip9"
  !skin_picture[120] := "clip8"
  !skin_picture[121] := "label_midiPg1Description"
  !skin_picture[122] := "clip7"
  !skin_picture[123] := "clip6"
  !skin_picture[124] := "clip5"
  !skin_picture[125] := "clip4"
  !skin_picture[126] := "clip3"
  !skin_picture[127] := "clip2"
  !skin_picture[128] := "clip1"
  !skin_picture[129] := "clip0"
  !skin_picture[130] := "label_midiPg0Description"
  !skin_picture[131] := "clip title 79"
  !skin_picture[132] := "clip title 78"
  !skin_picture[133] := "clip title 77"
  !skin_picture[134] := "clip title 76"
  !skin_picture[135] := "clip title 75"
  !skin_picture[136] := "clip title 74"
  !skin_picture[137] := "clip title 73"
  !skin_picture[138] := "clip title 72"
  !skin_picture[139] := "clip title 71"
  !skin_picture[140] := "clip title 70"
  !skin_picture[141] := "clip title 69"
  !skin_picture[142] := "clip title 68"
  !skin_picture[143] := "clip title 67"
  !skin_picture[144] := "clip title 66"
  !skin_picture[145] := "clip title 65"
  !skin_picture[146] := "clip title 64"
  !skin_picture[147] := "clip title 63"
  !skin_picture[148] := "clip title 62"
  !skin_picture[149] := "clip title 60"
  !skin_picture[150] := "clip title 61"
  !skin_picture[151] := "clip title 59"
  !skin_picture[152] := "clip title 58"
  !skin_picture[153] := "clip title 57"
  !skin_picture[154] := "clip title 56"
  !skin_picture[155] := "clip title 55"
  !skin_picture[156] := "clip title 54"
  !skin_picture[157] := "clip title 53"
  !skin_picture[158] := "clip title 52"
  !skin_picture[159] := "clip title 51"
  !skin_picture[160] := "clip title 50"
  !skin_picture[161] := "clip title 49"
  !skin_picture[162] := "clip title 48"
  !skin_picture[163] := "clip title 47"
  !skin_picture[164] := "clip title 46"
  !skin_picture[165] := "clip title 45"
  !skin_picture[166] := "clip title 44"
  !skin_picture[167] := "clip title 43"
  !skin_picture[168] := "clip title 42"
  !skin_picture[169] := "clip title 41"
  !skin_picture[170] := "clip title 40"
  !skin_picture[171] := "clip title 39"
  !skin_picture[172] := "clip title 38"
  !skin_picture[173] := "clip title 37"
  !skin_picture[174] := "clip title 36"
  !skin_picture[175] := "clip title 35"
  !skin_picture[176] := "clip title 34"
  !skin_picture[177] := "clip title 33"
  !skin_picture[178] := "clip title 32"
  !skin_picture[179] := "clip title 31"
  !skin_picture[180] := "clip title 30"
  !skin_picture[181] := "clip title 29"
  !skin_picture[182] := "clip title 28"
  !skin_picture[183] := "clip title 27"
  !skin_picture[184] := "clip title 26"
  !skin_picture[185] := "clip title 25"
  !skin_picture[186] := "clip title 24"
  !skin_picture[187] := "clip title 23"
  !skin_picture[188] := "clip title 22"
  !skin_picture[189] := "clip title 21"
  !skin_picture[190] := "clip title 20"
  !skin_picture[191] := "clip title 19"
  !skin_picture[192] := "clip title 18"
  !skin_picture[193] := "clip title 17"
  !skin_picture[194] := "clip title 16"
  !skin_picture[195] := "clip title 15"
  !skin_picture[196] := "clip title 14"
  !skin_picture[197] := "clip title 13"
  !skin_picture[198] := "clip title 12"
  !skin_picture[199] := "clip title 11"
  !skin_picture[200] := "clip title 10"
  !skin_picture[201] := "clip title 9"
  !skin_picture[202] := "clip title 8"
  !skin_picture[203] := "clip title 7"
  !skin_picture[204] := "clip title 6"
  !skin_picture[205] := "clip title 5"
  !skin_picture[206] := "clip title 4"
  !skin_picture[207] := "clip title 3"
  !skin_picture[208] := "clip title 2"
  !skin_picture[209] := "clip title 1"
  !skin_picture[210] := "clip title 0"
  declare !_labels_text[2*10]
  declare const $labels_text__SIZE_D1 := 2
  declare const $labels_text__SIZE_D2 := 10
  !_labels_text[10*0+0] := "EXPRESSION"
  !_labels_text[10*1+0] := "v1.0"
  declare %MULTI_LINE_DATA[2] := (1, 1)
  declare %font_file_ids[2]
  %font_file_ids[0] := get_font_id("Khula Regular Size 15")
  %font_file_ids[1] := get_font_id("Khula Bold Size 11 on")
  declare ui_panel $panel_UI
  declare ui_panel $panel_options
  declare ui_panel $panel_releaseSamples
  declare ui_panel $panel_legato
  declare ui_panel $panel_direction
  declare ui_panel $panel_speed
  declare ui_panel $panel_fx
  declare ui_panel $panel_reverb
  declare ui_panel $panel_vol
  declare ui_panel $panel_articulations
  declare ui_panel $panel_keyboard
  declare ui_panel $panel_midi
  declare ui_panel $panel_midiCover
  declare ui_panel $panel_midiPgChooser
  declare ui_panel $panel_midiPg9
  declare ui_panel $panel_clip79
  declare ui_panel $panel_clip78
  declare ui_panel $panel_clip77
  declare ui_panel $panel_clip76
  declare ui_panel $panel_clip75
  declare ui_panel $panel_clip74
  declare ui_panel $panel_clip73
  declare ui_panel $panel_clip72
  declare ui_panel $panel_midiPg8
  declare ui_panel $panel_clip71
  declare ui_panel $panel_clip70
  declare ui_panel $panel_clip69
  declare ui_panel $panel_clip68
  declare ui_panel $panel_clip67
  declare ui_panel $panel_clip66
  declare ui_panel $panel_clip65
  declare ui_panel $panel_clip64
  declare ui_panel $panel_midiPg7
  declare ui_panel $panel_clip63
  declare ui_panel $panel_clip62
  declare ui_panel $panel_clip61
  declare ui_panel $panel_clip60
  declare ui_panel $panel_clip59
  declare ui_panel $panel_clip58
  declare ui_panel $panel_clip57
  declare ui_panel $panel_clip56
  declare ui_panel $panel_midiPg6
  declare ui_panel $panel_clip55
  declare ui_panel $panel_clip54
  declare ui_panel $panel_clip53
  declare ui_panel $panel_clip52
  declare ui_panel $panel_clip51
  declare ui_panel $panel_clip50
  declare ui_panel $panel_clip49
  declare ui_panel $panel_clip48
  declare ui_panel $panel_midiPg5
  declare ui_panel $panel_clip47
  declare ui_panel $panel_clip46
  declare ui_panel $panel_clip45
  declare ui_panel $panel_clip44
  declare ui_panel $panel_clip43
  declare ui_panel $panel_clip42
  declare ui_panel $panel_clip41
  declare ui_panel $panel_clip40
  declare ui_panel $panel_midiPg4
  declare ui_panel $panel_clip39
  declare ui_panel $panel_clip38
  declare ui_panel $panel_clip37
  declare ui_panel $panel_clip36
  declare ui_panel $panel_clip35
  declare ui_panel $panel_clip34
  declare ui_panel $panel_clip33
  declare ui_panel $panel_clip32
  declare ui_panel $panel_midiPg3
  declare ui_panel $panel_clip31
  declare ui_panel $panel_clip30
  declare ui_panel $panel_clip29
  declare ui_panel $panel_clip28
  declare ui_panel $panel_clip27
  declare ui_panel $panel_clip26
  declare ui_panel $panel_clip25
  declare ui_panel $panel_clip24
  declare ui_panel $panel_midiPg2
  declare ui_panel $panel_clip23
  declare ui_panel $panel_clip22
  declare ui_panel $panel_clip21
  declare ui_panel $panel_clip20
  declare ui_panel $panel_clip19
  declare ui_panel $panel_clip18
  declare ui_panel $panel_clip17
  declare ui_panel $panel_clip16
  declare ui_panel $panel_midiPg1
  declare ui_panel $panel_clip15
  declare ui_panel $panel_clip14
  declare ui_panel $panel_clip13
  declare ui_panel $panel_clip12
  declare ui_panel $panel_clip11
  declare ui_panel $panel_clip10
  declare ui_panel $panel_clip9
  declare ui_panel $panel_clip8
  declare ui_panel $panel_midiPg0
  declare ui_panel $panel_clip7
  declare ui_panel $panel_clip6
  declare ui_panel $panel_clip5
  declare ui_panel $panel_clip4
  declare ui_panel $panel_clip3
  declare ui_panel $panel_clip2
  declare ui_panel $panel_clip1
  declare ui_panel $panel_clip0
  declare ui_switch $switch_Release3
  make_persistent($switch_Release3)
  read_persistent_var($switch_Release3)
  declare ui_switch $switch_Release2
  make_persistent($switch_Release2)
  read_persistent_var($switch_Release2)
  declare ui_switch $switch_Release1
  make_persistent($switch_Release1)
  read_persistent_var($switch_Release1)
  declare ui_switch $switch_Release0
  make_persistent($switch_Release0)
  read_persistent_var($switch_Release0)
  declare ui_switch $switch_autoRelease
  make_persistent($switch_autoRelease)
  read_persistent_var($switch_autoRelease)
  declare ui_switch $switch_noReleaseSample
  make_persistent($switch_noReleaseSample)
  read_persistent_var($switch_noReleaseSample)
  declare ui_switch $switch_releaseSamplesModwheelControl
  make_persistent($switch_releaseSamplesModwheelControl)
  read_persistent_var($switch_releaseSamplesModwheelControl)
  declare ui_switch $switch_syncToSwell
  make_persistent($switch_syncToSwell)
  read_persistent_var($switch_syncToSwell)
  declare ui_switch $switch_syncToRipple
  make_persistent($switch_syncToRipple)
  read_persistent_var($switch_syncToRipple)
  declare ui_switch $switch_syncToPitch
  make_persistent($switch_syncToPitch)
  read_persistent_var($switch_syncToPitch)
  declare ui_switch $switch_noLegato
  make_persistent($switch_noLegato)
  read_persistent_var($switch_noLegato)
  declare ui_switch $switch_velToSampleStart
  make_persistent($switch_velToSampleStart)
  read_persistent_var($switch_velToSampleStart)
  declare ui_switch $switch_up
  make_persistent($switch_up)
  read_persistent_var($switch_up)
  declare ui_switch $switch_asPlayed
  make_persistent($switch_asPlayed)
  read_persistent_var($switch_asPlayed)
  declare ui_switch $switch_down
  make_persistent($switch_down)
  read_persistent_var($switch_down)
  declare ui_switch $switch_doubleSpeed
  make_persistent($switch_doubleSpeed)
  read_persistent_var($switch_doubleSpeed)
  declare ui_switch $switch_fastTripletSpeed
  make_persistent($switch_fastTripletSpeed)
  read_persistent_var($switch_fastTripletSpeed)
  declare ui_switch $switch_fullSpeed
  make_persistent($switch_fullSpeed)
  read_persistent_var($switch_fullSpeed)
  declare ui_switch $switch_slowTripletSpeed
  make_persistent($switch_slowTripletSpeed)
  read_persistent_var($switch_slowTripletSpeed)
  declare ui_switch $switch_halfSpeed
  make_persistent($switch_halfSpeed)
  read_persistent_var($switch_halfSpeed)
  declare ui_switch $switch_reverbToggle
  make_persistent($switch_reverbToggle)
  read_persistent_var($switch_reverbToggle)
  declare ui_switch $switch_sixteenths
  make_persistent($switch_sixteenths)
  read_persistent_var($switch_sixteenths)
  declare ui_switch $switch_eighths
  make_persistent($switch_eighths)
  read_persistent_var($switch_eighths)
  declare ui_switch $switch_quarters
  make_persistent($switch_quarters)
  read_persistent_var($switch_quarters)
  declare ui_switch $switch_logoAnimTrigger
  make_persistent($switch_logoAnimTrigger)
  read_persistent_var($switch_logoAnimTrigger)
  declare ui_switch $switch_midiPgChooser0
  make_persistent($switch_midiPgChooser0)
  read_persistent_var($switch_midiPgChooser0)
  declare ui_switch $switch_midiPgChooser1
  make_persistent($switch_midiPgChooser1)
  read_persistent_var($switch_midiPgChooser1)
  declare ui_switch $switch_midiPgChooser2
  make_persistent($switch_midiPgChooser2)
  read_persistent_var($switch_midiPgChooser2)
  declare ui_switch $switch_midiPgChooser3
  make_persistent($switch_midiPgChooser3)
  read_persistent_var($switch_midiPgChooser3)
  declare ui_switch $switch_midiPgChooser4
  make_persistent($switch_midiPgChooser4)
  read_persistent_var($switch_midiPgChooser4)
  declare ui_switch $switch_midiPgChooser5
  make_persistent($switch_midiPgChooser5)
  read_persistent_var($switch_midiPgChooser5)
  declare ui_switch $switch_midiPgChooser6
  make_persistent($switch_midiPgChooser6)
  read_persistent_var($switch_midiPgChooser6)
  declare ui_switch $switch_midiPgChooser7
  make_persistent($switch_midiPgChooser7)
  read_persistent_var($switch_midiPgChooser7)
  declare ui_switch $switch_midiPgChooser8
  make_persistent($switch_midiPgChooser8)
  read_persistent_var($switch_midiPgChooser8)
  declare ui_switch $switch_midiPgChooser9
  make_persistent($switch_midiPgChooser9)
  read_persistent_var($switch_midiPgChooser9)
  declare ui_switch $switch_preview79
  make_persistent($switch_preview79)
  read_persistent_var($switch_preview79)
  declare ui_switch $switch_preview78
  make_persistent($switch_preview78)
  read_persistent_var($switch_preview78)
  declare ui_switch $switch_preview77
  make_persistent($switch_preview77)
  read_persistent_var($switch_preview77)
  declare ui_switch $switch_preview76
  make_persistent($switch_preview76)
  read_persistent_var($switch_preview76)
  declare ui_switch $switch_preview75
  make_persistent($switch_preview75)
  read_persistent_var($switch_preview75)
  declare ui_switch $switch_preview74
  make_persistent($switch_preview74)
  read_persistent_var($switch_preview74)
  declare ui_switch $switch_preview73
  make_persistent($switch_preview73)
  read_persistent_var($switch_preview73)
  declare ui_switch $switch_preview72
  make_persistent($switch_preview72)
  read_persistent_var($switch_preview72)
  declare ui_switch $switch_preview71
  make_persistent($switch_preview71)
  read_persistent_var($switch_preview71)
  declare ui_switch $switch_preview70
  make_persistent($switch_preview70)
  read_persistent_var($switch_preview70)
  declare ui_switch $switch_preview69
  make_persistent($switch_preview69)
  read_persistent_var($switch_preview69)
  declare ui_switch $switch_preview68
  make_persistent($switch_preview68)
  read_persistent_var($switch_preview68)
  declare ui_switch $switch_preview67
  make_persistent($switch_preview67)
  read_persistent_var($switch_preview67)
  declare ui_switch $switch_preview66
  make_persistent($switch_preview66)
  read_persistent_var($switch_preview66)
  declare ui_switch $switch_preview65
  make_persistent($switch_preview65)
  read_persistent_var($switch_preview65)
  declare ui_switch $switch_preview64
  make_persistent($switch_preview64)
  read_persistent_var($switch_preview64)
  declare ui_switch $switch_preview63
  make_persistent($switch_preview63)
  read_persistent_var($switch_preview63)
  declare ui_switch $switch_preview62
  make_persistent($switch_preview62)
  read_persistent_var($switch_preview62)
  declare ui_switch $switch_preview61
  make_persistent($switch_preview61)
  read_persistent_var($switch_preview61)
  declare ui_switch $switch_preview60
  make_persistent($switch_preview60)
  read_persistent_var($switch_preview60)
  declare ui_switch $switch_preview59
  make_persistent($switch_preview59)
  read_persistent_var($switch_preview59)
  declare ui_switch $switch_preview58
  make_persistent($switch_preview58)
  read_persistent_var($switch_preview58)
  declare ui_switch $switch_preview57
  make_persistent($switch_preview57)
  read_persistent_var($switch_preview57)
  declare ui_switch $switch_preview56
  make_persistent($switch_preview56)
  read_persistent_var($switch_preview56)
  declare ui_switch $switch_preview55
  make_persistent($switch_preview55)
  read_persistent_var($switch_preview55)
  declare ui_switch $switch_preview54
  make_persistent($switch_preview54)
  read_persistent_var($switch_preview54)
  declare ui_switch $switch_preview53
  make_persistent($switch_preview53)
  read_persistent_var($switch_preview53)
  declare ui_switch $switch_preview52
  make_persistent($switch_preview52)
  read_persistent_var($switch_preview52)
  declare ui_switch $switch_preview51
  make_persistent($switch_preview51)
  read_persistent_var($switch_preview51)
  declare ui_switch $switch_preview50
  make_persistent($switch_preview50)
  read_persistent_var($switch_preview50)
  declare ui_switch $switch_preview49
  make_persistent($switch_preview49)
  read_persistent_var($switch_preview49)
  declare ui_switch $switch_preview48
  make_persistent($switch_preview48)
  read_persistent_var($switch_preview48)
  declare ui_switch $switch_preview47
  make_persistent($switch_preview47)
  read_persistent_var($switch_preview47)
  declare ui_switch $switch_preview46
  make_persistent($switch_preview46)
  read_persistent_var($switch_preview46)
  declare ui_switch $switch_preview45
  make_persistent($switch_preview45)
  read_persistent_var($switch_preview45)
  declare ui_switch $switch_preview44
  make_persistent($switch_preview44)
  read_persistent_var($switch_preview44)
  declare ui_switch $switch_preview43
  make_persistent($switch_preview43)
  read_persistent_var($switch_preview43)
  declare ui_switch $switch_preview42
  make_persistent($switch_preview42)
  read_persistent_var($switch_preview42)
  declare ui_switch $switch_preview41
  make_persistent($switch_preview41)
  read_persistent_var($switch_preview41)
  declare ui_switch $switch_preview40
  make_persistent($switch_preview40)
  read_persistent_var($switch_preview40)
  declare ui_switch $switch_preview39
  make_persistent($switch_preview39)
  read_persistent_var($switch_preview39)
  declare ui_switch $switch_preview38
  make_persistent($switch_preview38)
  read_persistent_var($switch_preview38)
  declare ui_switch $switch_preview37
  make_persistent($switch_preview37)
  read_persistent_var($switch_preview37)
  declare ui_switch $switch_preview36
  make_persistent($switch_preview36)
  read_persistent_var($switch_preview36)
  declare ui_switch $switch_preview35
  make_persistent($switch_preview35)
  read_persistent_var($switch_preview35)
  declare ui_switch $switch_preview34
  make_persistent($switch_preview34)
  read_persistent_var($switch_preview34)
  declare ui_switch $switch_preview33
  make_persistent($switch_preview33)
  read_persistent_var($switch_preview33)
  declare ui_switch $switch_preview32
  make_persistent($switch_preview32)
  read_persistent_var($switch_preview32)
  declare ui_switch $switch_preview31
  make_persistent($switch_preview31)
  read_persistent_var($switch_preview31)
  declare ui_switch $switch_preview30
  make_persistent($switch_preview30)
  read_persistent_var($switch_preview30)
  declare ui_switch $switch_preview29
  make_persistent($switch_preview29)
  read_persistent_var($switch_preview29)
  declare ui_switch $switch_preview28
  make_persistent($switch_preview28)
  read_persistent_var($switch_preview28)
  declare ui_switch $switch_preview27
  make_persistent($switch_preview27)
  read_persistent_var($switch_preview27)
  declare ui_switch $switch_preview26
  make_persistent($switch_preview26)
  read_persistent_var($switch_preview26)
  declare ui_switch $switch_preview25
  make_persistent($switch_preview25)
  read_persistent_var($switch_preview25)
  declare ui_switch $switch_preview24
  make_persistent($switch_preview24)
  read_persistent_var($switch_preview24)
  declare ui_switch $switch_preview23
  make_persistent($switch_preview23)
  read_persistent_var($switch_preview23)
  declare ui_switch $switch_preview22
  make_persistent($switch_preview22)
  read_persistent_var($switch_preview22)
  declare ui_switch $switch_preview21
  make_persistent($switch_preview21)
  read_persistent_var($switch_preview21)
  declare ui_switch $switch_preview20
  make_persistent($switch_preview20)
  read_persistent_var($switch_preview20)
  declare ui_switch $switch_preview19
  make_persistent($switch_preview19)
  read_persistent_var($switch_preview19)
  declare ui_switch $switch_preview18
  make_persistent($switch_preview18)
  read_persistent_var($switch_preview18)
  declare ui_switch $switch_preview17
  make_persistent($switch_preview17)
  read_persistent_var($switch_preview17)
  declare ui_switch $switch_preview16
  make_persistent($switch_preview16)
  read_persistent_var($switch_preview16)
  declare ui_switch $switch_preview15
  make_persistent($switch_preview15)
  read_persistent_var($switch_preview15)
  declare ui_switch $switch_preview14
  make_persistent($switch_preview14)
  read_persistent_var($switch_preview14)
  declare ui_switch $switch_preview13
  make_persistent($switch_preview13)
  read_persistent_var($switch_preview13)
  declare ui_switch $switch_preview12
  make_persistent($switch_preview12)
  read_persistent_var($switch_preview12)
  declare ui_switch $switch_preview11
  make_persistent($switch_preview11)
  read_persistent_var($switch_preview11)
  declare ui_switch $switch_preview10
  make_persistent($switch_preview10)
  read_persistent_var($switch_preview10)
  declare ui_switch $switch_preview9
  make_persistent($switch_preview9)
  read_persistent_var($switch_preview9)
  declare ui_switch $switch_preview8
  make_persistent($switch_preview8)
  read_persistent_var($switch_preview8)
  declare ui_switch $switch_preview7
  make_persistent($switch_preview7)
  read_persistent_var($switch_preview7)
  declare ui_switch $switch_preview6
  make_persistent($switch_preview6)
  read_persistent_var($switch_preview6)
  declare ui_switch $switch_preview5
  make_persistent($switch_preview5)
  read_persistent_var($switch_preview5)
  declare ui_switch $switch_preview4
  make_persistent($switch_preview4)
  read_persistent_var($switch_preview4)
  declare ui_switch $switch_preview3
  make_persistent($switch_preview3)
  read_persistent_var($switch_preview3)
  declare ui_switch $switch_preview2
  make_persistent($switch_preview2)
  read_persistent_var($switch_preview2)
  declare ui_switch $switch_preview1
  make_persistent($switch_preview1)
  read_persistent_var($switch_preview1)
  declare ui_switch $switch_preview0
  make_persistent($switch_preview0)
  read_persistent_var($switch_preview0)
  declare ui_switch $switch_closeMidi2
  make_persistent($switch_closeMidi2)
  read_persistent_var($switch_closeMidi2)
  declare ui_switch $switch_nextMidiPg
  make_persistent($switch_nextMidiPg)
  read_persistent_var($switch_nextMidiPg)
  declare ui_switch $switch_prevMidiPg
  make_persistent($switch_prevMidiPg)
  read_persistent_var($switch_prevMidiPg)
  declare ui_switch $switch_closeMidi
  make_persistent($switch_closeMidi)
  read_persistent_var($switch_closeMidi)
  declare ui_switch $switch_title
  make_persistent($switch_title)
  read_persistent_var($switch_title)
  declare ui_switch $switch_releaseSamplesInfoDisp
  make_persistent($switch_releaseSamplesInfoDisp)
  read_persistent_var($switch_releaseSamplesInfoDisp)
  declare ui_switch $switch_legatoInfoDisp
  make_persistent($switch_legatoInfoDisp)
  read_persistent_var($switch_legatoInfoDisp)
  declare ui_switch $switch_directionInfoDisp
  make_persistent($switch_directionInfoDisp)
  read_persistent_var($switch_directionInfoDisp)
  declare ui_switch $switch_speedInfoDisp
  make_persistent($switch_speedInfoDisp)
  read_persistent_var($switch_speedInfoDisp)
  declare ui_switch $switch_optionsInfoDisp
  make_persistent($switch_optionsInfoDisp)
  read_persistent_var($switch_optionsInfoDisp)
  declare ui_switch $switch_articulationsInfoDisp
  make_persistent($switch_articulationsInfoDisp)
  read_persistent_var($switch_articulationsInfoDisp)
  declare ui_switch $switch_generalInfoDisp
  make_persistent($switch_generalInfoDisp)
  read_persistent_var($switch_generalInfoDisp)
  declare ui_switch $switch_titleInfoDisp
  make_persistent($switch_titleInfoDisp)
  read_persistent_var($switch_titleInfoDisp)
  declare ui_slider $slider_releaseSamples(0,5)
  make_persistent($slider_releaseSamples)
  read_persistent_var($slider_releaseSamples)
  declare ui_slider $slider_legato(0,3)
  make_persistent($slider_legato)
  read_persistent_var($slider_legato)
  declare ui_slider $slider_direction(0,2)
  make_persistent($slider_direction)
  read_persistent_var($slider_direction)
  declare ui_slider $slider_speed(0,4)
  make_persistent($slider_speed)
  read_persistent_var($slider_speed)
  declare ui_slider $slider_reverb(0,1000000)
  make_persistent($slider_reverb)
  read_persistent_var($slider_reverb)
  declare ui_slider $slider_vol(0,1000000)
  make_persistent($slider_vol)
  read_persistent_var($slider_vol)
  declare ui_slider $slider_logoAnim(0,127)
  make_persistent($slider_logoAnim)
  read_persistent_var($slider_logoAnim)
  declare ui_button $button_releaseSamplesInfo
  make_persistent($button_releaseSamplesInfo)
  read_persistent_var($button_releaseSamplesInfo)
  declare ui_button $button_legatoInfo
  make_persistent($button_legatoInfo)
  read_persistent_var($button_legatoInfo)
  declare ui_button $button_directionInfo
  make_persistent($button_directionInfo)
  read_persistent_var($button_directionInfo)
  declare ui_button $button_speedInfo
  make_persistent($button_speedInfo)
  read_persistent_var($button_speedInfo)
  declare ui_button $button_optionsInfo
  make_persistent($button_optionsInfo)
  read_persistent_var($button_optionsInfo)
  declare ui_button $button_articulationsInfo
  make_persistent($button_articulationsInfo)
  read_persistent_var($button_articulationsInfo)
  declare ui_button $button_generalInfo
  make_persistent($button_generalInfo)
  read_persistent_var($button_generalInfo)
  declare ui_button $button_showMidi
  make_persistent($button_showMidi)
  read_persistent_var($button_showMidi)
  declare ui_menu $menu_reverb
  make_persistent($menu_reverb)
  read_persistent_var($menu_reverb)
  declare ui_menu $menu_latency
  make_persistent($menu_latency)
  read_persistent_var($menu_latency)
  declare ui_label $label_vol(1,1)
  make_persistent($label_vol)
  read_persistent_var($label_vol)
  declare ui_label $label_midiInstructions(1,1)
  make_persistent($label_midiInstructions)
  read_persistent_var($label_midiInstructions)
  declare ui_label $label_oct2__note12(1,1)
  make_persistent($label_oct2__note12)
  read_persistent_var($label_oct2__note12)
  declare ui_label $label_oct2__note11(1,1)
  make_persistent($label_oct2__note11)
  read_persistent_var($label_oct2__note11)
  declare ui_label $label_oct2__note9(1,1)
  make_persistent($label_oct2__note9)
  read_persistent_var($label_oct2__note9)
  declare ui_label $label_oct2__note7(1,1)
  make_persistent($label_oct2__note7)
  read_persistent_var($label_oct2__note7)
  declare ui_label $label_oct2__note5(1,1)
  make_persistent($label_oct2__note5)
  read_persistent_var($label_oct2__note5)
  declare ui_label $label_oct2__note4(1,1)
  make_persistent($label_oct2__note4)
  read_persistent_var($label_oct2__note4)
  declare ui_label $label_oct2__note2(1,1)
  make_persistent($label_oct2__note2)
  read_persistent_var($label_oct2__note2)
  declare ui_label $label_oct2__note0(1,1)
  make_persistent($label_oct2__note0)
  read_persistent_var($label_oct2__note0)
  declare ui_label $label_oct2__note10(1,1)
  make_persistent($label_oct2__note10)
  read_persistent_var($label_oct2__note10)
  declare ui_label $label_oct2__note8(1,1)
  make_persistent($label_oct2__note8)
  read_persistent_var($label_oct2__note8)
  declare ui_label $label_oct2__note6(1,1)
  make_persistent($label_oct2__note6)
  read_persistent_var($label_oct2__note6)
  declare ui_label $label_oct2__note3(1,1)
  make_persistent($label_oct2__note3)
  read_persistent_var($label_oct2__note3)
  declare ui_label $label_oct2__note1(1,1)
  make_persistent($label_oct2__note1)
  read_persistent_var($label_oct2__note1)
  declare ui_label $label_oct1__note11(1,1)
  make_persistent($label_oct1__note11)
  read_persistent_var($label_oct1__note11)
  declare ui_label $label_oct1__note9(1,1)
  make_persistent($label_oct1__note9)
  read_persistent_var($label_oct1__note9)
  declare ui_label $label_oct1__note7(1,1)
  make_persistent($label_oct1__note7)
  read_persistent_var($label_oct1__note7)
  declare ui_label $label_oct1__note5(1,1)
  make_persistent($label_oct1__note5)
  read_persistent_var($label_oct1__note5)
  declare ui_label $label_oct1__note4(1,1)
  make_persistent($label_oct1__note4)
  read_persistent_var($label_oct1__note4)
  declare ui_label $label_oct1__note2(1,1)
  make_persistent($label_oct1__note2)
  read_persistent_var($label_oct1__note2)
  declare ui_label $label_oct1__note0(1,1)
  make_persistent($label_oct1__note0)
  read_persistent_var($label_oct1__note0)
  declare ui_label $label_oct1__note10(1,1)
  make_persistent($label_oct1__note10)
  read_persistent_var($label_oct1__note10)
  declare ui_label $label_oct1__note8(1,1)
  make_persistent($label_oct1__note8)
  read_persistent_var($label_oct1__note8)
  declare ui_label $label_oct1__note6(1,1)
  make_persistent($label_oct1__note6)
  read_persistent_var($label_oct1__note6)
  declare ui_label $label_oct1__note3(1,1)
  make_persistent($label_oct1__note3)
  read_persistent_var($label_oct1__note3)
  declare ui_label $label_oct1__note1(1,1)
  make_persistent($label_oct1__note1)
  read_persistent_var($label_oct1__note1)
  declare ui_label $label_oct0__note11(1,1)
  make_persistent($label_oct0__note11)
  read_persistent_var($label_oct0__note11)
  declare ui_label $label_oct0__note9(1,1)
  make_persistent($label_oct0__note9)
  read_persistent_var($label_oct0__note9)
  declare ui_label $label_oct0__note7(1,1)
  make_persistent($label_oct0__note7)
  read_persistent_var($label_oct0__note7)
  declare ui_label $label_oct0__note5(1,1)
  make_persistent($label_oct0__note5)
  read_persistent_var($label_oct0__note5)
  declare ui_label $label_oct0__note4(1,1)
  make_persistent($label_oct0__note4)
  read_persistent_var($label_oct0__note4)
  declare ui_label $label_oct0__note2(1,1)
  make_persistent($label_oct0__note2)
  read_persistent_var($label_oct0__note2)
  declare ui_label $label_oct0__note0(1,1)
  make_persistent($label_oct0__note0)
  read_persistent_var($label_oct0__note0)
  declare ui_label $label_oct0__note10(1,1)
  make_persistent($label_oct0__note10)
  read_persistent_var($label_oct0__note10)
  declare ui_label $label_oct0__note8(1,1)
  make_persistent($label_oct0__note8)
  read_persistent_var($label_oct0__note8)
  declare ui_label $label_oct0__note6(1,1)
  make_persistent($label_oct0__note6)
  read_persistent_var($label_oct0__note6)
  declare ui_label $label_oct0__note3(1,1)
  make_persistent($label_oct0__note3)
  read_persistent_var($label_oct0__note3)
  declare ui_label $label_oct0__note1(1,1)
  make_persistent($label_oct0__note1)
  read_persistent_var($label_oct0__note1)
  declare ui_label $label_version(1,1)
  make_persistent($label_version)
  read_persistent_var($label_version)
  declare ui_label $label_midiCover(1,1)
  make_persistent($label_midiCover)
  read_persistent_var($label_midiCover)
  declare ui_label $label_clipOutline79(1,1)
  make_persistent($label_clipOutline79)
  read_persistent_var($label_clipOutline79)
  declare ui_label $label_clip_dnd79(1,1)
  make_persistent($label_clip_dnd79)
  read_persistent_var($label_clip_dnd79)
  declare ui_label $label_clip79(1,1)
  make_persistent($label_clip79)
  read_persistent_var($label_clip79)
  declare ui_label $label_clipOutline78(1,1)
  make_persistent($label_clipOutline78)
  read_persistent_var($label_clipOutline78)
  declare ui_label $label_clip_dnd78(1,1)
  make_persistent($label_clip_dnd78)
  read_persistent_var($label_clip_dnd78)
  declare ui_label $label_clip78(1,1)
  make_persistent($label_clip78)
  read_persistent_var($label_clip78)
  declare ui_label $label_clipOutline77(1,1)
  make_persistent($label_clipOutline77)
  read_persistent_var($label_clipOutline77)
  declare ui_label $label_clip_dnd77(1,1)
  make_persistent($label_clip_dnd77)
  read_persistent_var($label_clip_dnd77)
  declare ui_label $label_clip77(1,1)
  make_persistent($label_clip77)
  read_persistent_var($label_clip77)
  declare ui_label $label_clipOutline76(1,1)
  make_persistent($label_clipOutline76)
  read_persistent_var($label_clipOutline76)
  declare ui_label $label_clip_dnd76(1,1)
  make_persistent($label_clip_dnd76)
  read_persistent_var($label_clip_dnd76)
  declare ui_label $label_clip76(1,1)
  make_persistent($label_clip76)
  read_persistent_var($label_clip76)
  declare ui_label $label_clipOutline75(1,1)
  make_persistent($label_clipOutline75)
  read_persistent_var($label_clipOutline75)
  declare ui_label $label_clip_dnd75(1,1)
  make_persistent($label_clip_dnd75)
  read_persistent_var($label_clip_dnd75)
  declare ui_label $label_clip75(1,1)
  make_persistent($label_clip75)
  read_persistent_var($label_clip75)
  declare ui_label $label_clipOutline74(1,1)
  make_persistent($label_clipOutline74)
  read_persistent_var($label_clipOutline74)
  declare ui_label $label_clip_dnd74(1,1)
  make_persistent($label_clip_dnd74)
  read_persistent_var($label_clip_dnd74)
  declare ui_label $label_clip74(1,1)
  make_persistent($label_clip74)
  read_persistent_var($label_clip74)
  declare ui_label $label_clipOutline73(1,1)
  make_persistent($label_clipOutline73)
  read_persistent_var($label_clipOutline73)
  declare ui_label $label_clip_dnd73(1,1)
  make_persistent($label_clip_dnd73)
  read_persistent_var($label_clip_dnd73)
  declare ui_label $label_clip73(1,1)
  make_persistent($label_clip73)
  read_persistent_var($label_clip73)
  declare ui_label $label_clipOutline72(1,1)
  make_persistent($label_clipOutline72)
  read_persistent_var($label_clipOutline72)
  declare ui_label $label_clip_dnd72(1,1)
  make_persistent($label_clip_dnd72)
  read_persistent_var($label_clip_dnd72)
  declare ui_label $label_clip72(1,1)
  make_persistent($label_clip72)
  read_persistent_var($label_clip72)
  declare ui_label $label_midiPg9Description(1,1)
  make_persistent($label_midiPg9Description)
  read_persistent_var($label_midiPg9Description)
  declare ui_label $label_clipOutline71(1,1)
  make_persistent($label_clipOutline71)
  read_persistent_var($label_clipOutline71)
  declare ui_label $label_clip_dnd71(1,1)
  make_persistent($label_clip_dnd71)
  read_persistent_var($label_clip_dnd71)
  declare ui_label $label_clip71(1,1)
  make_persistent($label_clip71)
  read_persistent_var($label_clip71)
  declare ui_label $label_clipOutline70(1,1)
  make_persistent($label_clipOutline70)
  read_persistent_var($label_clipOutline70)
  declare ui_label $label_clip_dnd70(1,1)
  make_persistent($label_clip_dnd70)
  read_persistent_var($label_clip_dnd70)
  declare ui_label $label_clip70(1,1)
  make_persistent($label_clip70)
  read_persistent_var($label_clip70)
  declare ui_label $label_clipOutline69(1,1)
  make_persistent($label_clipOutline69)
  read_persistent_var($label_clipOutline69)
  declare ui_label $label_clip_dnd69(1,1)
  make_persistent($label_clip_dnd69)
  read_persistent_var($label_clip_dnd69)
  declare ui_label $label_clip69(1,1)
  make_persistent($label_clip69)
  read_persistent_var($label_clip69)
  declare ui_label $label_clipOutline68(1,1)
  make_persistent($label_clipOutline68)
  read_persistent_var($label_clipOutline68)
  declare ui_label $label_clip_dnd68(1,1)
  make_persistent($label_clip_dnd68)
  read_persistent_var($label_clip_dnd68)
  declare ui_label $label_clip68(1,1)
  make_persistent($label_clip68)
  read_persistent_var($label_clip68)
  declare ui_label $label_clipOutline67(1,1)
  make_persistent($label_clipOutline67)
  read_persistent_var($label_clipOutline67)
  declare ui_label $label_clip_dnd67(1,1)
  make_persistent($label_clip_dnd67)
  read_persistent_var($label_clip_dnd67)
  declare ui_label $label_clip67(1,1)
  make_persistent($label_clip67)
  read_persistent_var($label_clip67)
  declare ui_label $label_clipOutline66(1,1)
  make_persistent($label_clipOutline66)
  read_persistent_var($label_clipOutline66)
  declare ui_label $label_clip_dnd66(1,1)
  make_persistent($label_clip_dnd66)
  read_persistent_var($label_clip_dnd66)
  declare ui_label $label_clip66(1,1)
  make_persistent($label_clip66)
  read_persistent_var($label_clip66)
  declare ui_label $label_clipOutline65(1,1)
  make_persistent($label_clipOutline65)
  read_persistent_var($label_clipOutline65)
  declare ui_label $label_clip_dnd65(1,1)
  make_persistent($label_clip_dnd65)
  read_persistent_var($label_clip_dnd65)
  declare ui_label $label_clip65(1,1)
  make_persistent($label_clip65)
  read_persistent_var($label_clip65)
  declare ui_label $label_clipOutline64(1,1)
  make_persistent($label_clipOutline64)
  read_persistent_var($label_clipOutline64)
  declare ui_label $label_clip_dnd64(1,1)
  make_persistent($label_clip_dnd64)
  read_persistent_var($label_clip_dnd64)
  declare ui_label $label_clip64(1,1)
  make_persistent($label_clip64)
  read_persistent_var($label_clip64)
  declare ui_label $label_midiPg8Description(1,1)
  make_persistent($label_midiPg8Description)
  read_persistent_var($label_midiPg8Description)
  declare ui_label $label_clipOutline63(1,1)
  make_persistent($label_clipOutline63)
  read_persistent_var($label_clipOutline63)
  declare ui_label $label_clip_dnd63(1,1)
  make_persistent($label_clip_dnd63)
  read_persistent_var($label_clip_dnd63)
  declare ui_label $label_clip63(1,1)
  make_persistent($label_clip63)
  read_persistent_var($label_clip63)
  declare ui_label $label_clipOutline62(1,1)
  make_persistent($label_clipOutline62)
  read_persistent_var($label_clipOutline62)
  declare ui_label $label_clip_dnd62(1,1)
  make_persistent($label_clip_dnd62)
  read_persistent_var($label_clip_dnd62)
  declare ui_label $label_clip62(1,1)
  make_persistent($label_clip62)
  read_persistent_var($label_clip62)
  declare ui_label $label_clipOutline61(1,1)
  make_persistent($label_clipOutline61)
  read_persistent_var($label_clipOutline61)
  declare ui_label $label_clip_dnd61(1,1)
  make_persistent($label_clip_dnd61)
  read_persistent_var($label_clip_dnd61)
  declare ui_label $label_clip61(1,1)
  make_persistent($label_clip61)
  read_persistent_var($label_clip61)
  declare ui_label $label_clipOutline60(1,1)
  make_persistent($label_clipOutline60)
  read_persistent_var($label_clipOutline60)
  declare ui_label $label_clip_dnd60(1,1)
  make_persistent($label_clip_dnd60)
  read_persistent_var($label_clip_dnd60)
  declare ui_label $label_clip60(1,1)
  make_persistent($label_clip60)
  read_persistent_var($label_clip60)
  declare ui_label $label_clipOutline59(1,1)
  make_persistent($label_clipOutline59)
  read_persistent_var($label_clipOutline59)
  declare ui_label $label_clip_dnd59(1,1)
  make_persistent($label_clip_dnd59)
  read_persistent_var($label_clip_dnd59)
  declare ui_label $label_clip59(1,1)
  make_persistent($label_clip59)
  read_persistent_var($label_clip59)
  declare ui_label $label_clipOutline58(1,1)
  make_persistent($label_clipOutline58)
  read_persistent_var($label_clipOutline58)
  declare ui_label $label_clip_dnd58(1,1)
  make_persistent($label_clip_dnd58)
  read_persistent_var($label_clip_dnd58)
  declare ui_label $label_clip58(1,1)
  make_persistent($label_clip58)
  read_persistent_var($label_clip58)
  declare ui_label $label_clipOutline57(1,1)
  make_persistent($label_clipOutline57)
  read_persistent_var($label_clipOutline57)
  declare ui_label $label_clip_dnd57(1,1)
  make_persistent($label_clip_dnd57)
  read_persistent_var($label_clip_dnd57)
  declare ui_label $label_clip57(1,1)
  make_persistent($label_clip57)
  read_persistent_var($label_clip57)
  declare ui_label $label_clipOutline56(1,1)
  make_persistent($label_clipOutline56)
  read_persistent_var($label_clipOutline56)
  declare ui_label $label_clip_dnd56(1,1)
  make_persistent($label_clip_dnd56)
  read_persistent_var($label_clip_dnd56)
  declare ui_label $label_clip56(1,1)
  make_persistent($label_clip56)
  read_persistent_var($label_clip56)
  declare ui_label $label_midiPg7Description(1,1)
  make_persistent($label_midiPg7Description)
  read_persistent_var($label_midiPg7Description)
  declare ui_label $label_clipOutline55(1,1)
  make_persistent($label_clipOutline55)
  read_persistent_var($label_clipOutline55)
  declare ui_label $label_clip_dnd55(1,1)
  make_persistent($label_clip_dnd55)
  read_persistent_var($label_clip_dnd55)
  declare ui_label $label_clip55(1,1)
  make_persistent($label_clip55)
  read_persistent_var($label_clip55)
  declare ui_label $label_clipOutline54(1,1)
  make_persistent($label_clipOutline54)
  read_persistent_var($label_clipOutline54)
  declare ui_label $label_clip_dnd54(1,1)
  make_persistent($label_clip_dnd54)
  read_persistent_var($label_clip_dnd54)
  declare ui_label $label_clip54(1,1)
  make_persistent($label_clip54)
  read_persistent_var($label_clip54)
  declare ui_label $label_clipOutline53(1,1)
  make_persistent($label_clipOutline53)
  read_persistent_var($label_clipOutline53)
  declare ui_label $label_clip_dnd53(1,1)
  make_persistent($label_clip_dnd53)
  read_persistent_var($label_clip_dnd53)
  declare ui_label $label_clip53(1,1)
  make_persistent($label_clip53)
  read_persistent_var($label_clip53)
  declare ui_label $label_clipOutline52(1,1)
  make_persistent($label_clipOutline52)
  read_persistent_var($label_clipOutline52)
  declare ui_label $label_clip_dnd52(1,1)
  make_persistent($label_clip_dnd52)
  read_persistent_var($label_clip_dnd52)
  declare ui_label $label_clip52(1,1)
  make_persistent($label_clip52)
  read_persistent_var($label_clip52)
  declare ui_label $label_clipOutline51(1,1)
  make_persistent($label_clipOutline51)
  read_persistent_var($label_clipOutline51)
  declare ui_label $label_clip_dnd51(1,1)
  make_persistent($label_clip_dnd51)
  read_persistent_var($label_clip_dnd51)
  declare ui_label $label_clip51(1,1)
  make_persistent($label_clip51)
  read_persistent_var($label_clip51)
  declare ui_label $label_clipOutline50(1,1)
  make_persistent($label_clipOutline50)
  read_persistent_var($label_clipOutline50)
  declare ui_label $label_clip_dnd50(1,1)
  make_persistent($label_clip_dnd50)
  read_persistent_var($label_clip_dnd50)
  declare ui_label $label_clip50(1,1)
  make_persistent($label_clip50)
  read_persistent_var($label_clip50)
  declare ui_label $label_clipOutline49(1,1)
  make_persistent($label_clipOutline49)
  read_persistent_var($label_clipOutline49)
  declare ui_label $label_clip_dnd49(1,1)
  make_persistent($label_clip_dnd49)
  read_persistent_var($label_clip_dnd49)
  declare ui_label $label_clip49(1,1)
  make_persistent($label_clip49)
  read_persistent_var($label_clip49)
  declare ui_label $label_clipOutline48(1,1)
  make_persistent($label_clipOutline48)
  read_persistent_var($label_clipOutline48)
  declare ui_label $label_clip_dnd48(1,1)
  make_persistent($label_clip_dnd48)
  read_persistent_var($label_clip_dnd48)
  declare ui_label $label_clip48(1,1)
  make_persistent($label_clip48)
  read_persistent_var($label_clip48)
  declare ui_label $label_midiPg6Description(1,1)
  make_persistent($label_midiPg6Description)
  read_persistent_var($label_midiPg6Description)
  declare ui_label $label_clipOutline47(1,1)
  make_persistent($label_clipOutline47)
  read_persistent_var($label_clipOutline47)
  declare ui_label $label_clip_dnd47(1,1)
  make_persistent($label_clip_dnd47)
  read_persistent_var($label_clip_dnd47)
  declare ui_label $label_clip47(1,1)
  make_persistent($label_clip47)
  read_persistent_var($label_clip47)
  declare ui_label $label_clipOutline46(1,1)
  make_persistent($label_clipOutline46)
  read_persistent_var($label_clipOutline46)
  declare ui_label $label_clip_dnd46(1,1)
  make_persistent($label_clip_dnd46)
  read_persistent_var($label_clip_dnd46)
  declare ui_label $label_clip46(1,1)
  make_persistent($label_clip46)
  read_persistent_var($label_clip46)
  declare ui_label $label_clipOutline45(1,1)
  make_persistent($label_clipOutline45)
  read_persistent_var($label_clipOutline45)
  declare ui_label $label_clip_dnd45(1,1)
  make_persistent($label_clip_dnd45)
  read_persistent_var($label_clip_dnd45)
  declare ui_label $label_clip45(1,1)
  make_persistent($label_clip45)
  read_persistent_var($label_clip45)
  declare ui_label $label_clipOutline44(1,1)
  make_persistent($label_clipOutline44)
  read_persistent_var($label_clipOutline44)
  declare ui_label $label_clip_dnd44(1,1)
  make_persistent($label_clip_dnd44)
  read_persistent_var($label_clip_dnd44)
  declare ui_label $label_clip44(1,1)
  make_persistent($label_clip44)
  read_persistent_var($label_clip44)
  declare ui_label $label_clipOutline43(1,1)
  make_persistent($label_clipOutline43)
  read_persistent_var($label_clipOutline43)
  declare ui_label $label_clip_dnd43(1,1)
  make_persistent($label_clip_dnd43)
  read_persistent_var($label_clip_dnd43)
  declare ui_label $label_clip43(1,1)
  make_persistent($label_clip43)
  read_persistent_var($label_clip43)
  declare ui_label $label_clipOutline42(1,1)
  make_persistent($label_clipOutline42)
  read_persistent_var($label_clipOutline42)
  declare ui_label $label_clip_dnd42(1,1)
  make_persistent($label_clip_dnd42)
  read_persistent_var($label_clip_dnd42)
  declare ui_label $label_clip42(1,1)
  make_persistent($label_clip42)
  read_persistent_var($label_clip42)
  declare ui_label $label_clipOutline41(1,1)
  make_persistent($label_clipOutline41)
  read_persistent_var($label_clipOutline41)
  declare ui_label $label_clip_dnd41(1,1)
  make_persistent($label_clip_dnd41)
  read_persistent_var($label_clip_dnd41)
  declare ui_label $label_clip41(1,1)
  make_persistent($label_clip41)
  read_persistent_var($label_clip41)
  declare ui_label $label_clipOutline40(1,1)
  make_persistent($label_clipOutline40)
  read_persistent_var($label_clipOutline40)
  declare ui_label $label_clip_dnd40(1,1)
  make_persistent($label_clip_dnd40)
  read_persistent_var($label_clip_dnd40)
  declare ui_label $label_clip40(1,1)
  make_persistent($label_clip40)
  read_persistent_var($label_clip40)
  declare ui_label $label_midiPg5Description(1,1)
  make_persistent($label_midiPg5Description)
  read_persistent_var($label_midiPg5Description)
  declare ui_label $label_clipOutline39(1,1)
  make_persistent($label_clipOutline39)
  read_persistent_var($label_clipOutline39)
  declare ui_label $label_clip_dnd39(1,1)
  make_persistent($label_clip_dnd39)
  read_persistent_var($label_clip_dnd39)
  declare ui_label $label_clip39(1,1)
  make_persistent($label_clip39)
  read_persistent_var($label_clip39)
  declare ui_label $label_clipOutline38(1,1)
  make_persistent($label_clipOutline38)
  read_persistent_var($label_clipOutline38)
  declare ui_label $label_clip_dnd38(1,1)
  make_persistent($label_clip_dnd38)
  read_persistent_var($label_clip_dnd38)
  declare ui_label $label_clip38(1,1)
  make_persistent($label_clip38)
  read_persistent_var($label_clip38)
  declare ui_label $label_clipOutline37(1,1)
  make_persistent($label_clipOutline37)
  read_persistent_var($label_clipOutline37)
  declare ui_label $label_clip_dnd37(1,1)
  make_persistent($label_clip_dnd37)
  read_persistent_var($label_clip_dnd37)
  declare ui_label $label_clip37(1,1)
  make_persistent($label_clip37)
  read_persistent_var($label_clip37)
  declare ui_label $label_clipOutline36(1,1)
  make_persistent($label_clipOutline36)
  read_persistent_var($label_clipOutline36)
  declare ui_label $label_clip_dnd36(1,1)
  make_persistent($label_clip_dnd36)
  read_persistent_var($label_clip_dnd36)
  declare ui_label $label_clip36(1,1)
  make_persistent($label_clip36)
  read_persistent_var($label_clip36)
  declare ui_label $label_clipOutline35(1,1)
  make_persistent($label_clipOutline35)
  read_persistent_var($label_clipOutline35)
  declare ui_label $label_clip_dnd35(1,1)
  make_persistent($label_clip_dnd35)
  read_persistent_var($label_clip_dnd35)
  declare ui_label $label_clip35(1,1)
  make_persistent($label_clip35)
  read_persistent_var($label_clip35)
  declare ui_label $label_clipOutline34(1,1)
  make_persistent($label_clipOutline34)
  read_persistent_var($label_clipOutline34)
  declare ui_label $label_clip_dnd34(1,1)
  make_persistent($label_clip_dnd34)
  read_persistent_var($label_clip_dnd34)
  declare ui_label $label_clip34(1,1)
  make_persistent($label_clip34)
  read_persistent_var($label_clip34)
  declare ui_label $label_clipOutline33(1,1)
  make_persistent($label_clipOutline33)
  read_persistent_var($label_clipOutline33)
  declare ui_label $label_clip_dnd33(1,1)
  make_persistent($label_clip_dnd33)
  read_persistent_var($label_clip_dnd33)
  declare ui_label $label_clip33(1,1)
  make_persistent($label_clip33)
  read_persistent_var($label_clip33)
  declare ui_label $label_clipOutline32(1,1)
  make_persistent($label_clipOutline32)
  read_persistent_var($label_clipOutline32)
  declare ui_label $label_clip_dnd32(1,1)
  make_persistent($label_clip_dnd32)
  read_persistent_var($label_clip_dnd32)
  declare ui_label $label_clip32(1,1)
  make_persistent($label_clip32)
  read_persistent_var($label_clip32)
  declare ui_label $label_midiPg4Description(1,1)
  make_persistent($label_midiPg4Description)
  read_persistent_var($label_midiPg4Description)
  declare ui_label $label_clipOutline31(1,1)
  make_persistent($label_clipOutline31)
  read_persistent_var($label_clipOutline31)
  declare ui_label $label_clip_dnd31(1,1)
  make_persistent($label_clip_dnd31)
  read_persistent_var($label_clip_dnd31)
  declare ui_label $label_clip31(1,1)
  make_persistent($label_clip31)
  read_persistent_var($label_clip31)
  declare ui_label $label_clipOutline30(1,1)
  make_persistent($label_clipOutline30)
  read_persistent_var($label_clipOutline30)
  declare ui_label $label_clip_dnd30(1,1)
  make_persistent($label_clip_dnd30)
  read_persistent_var($label_clip_dnd30)
  declare ui_label $label_clip30(1,1)
  make_persistent($label_clip30)
  read_persistent_var($label_clip30)
  declare ui_label $label_clipOutline29(1,1)
  make_persistent($label_clipOutline29)
  read_persistent_var($label_clipOutline29)
  declare ui_label $label_clip_dnd29(1,1)
  make_persistent($label_clip_dnd29)
  read_persistent_var($label_clip_dnd29)
  declare ui_label $label_clip29(1,1)
  make_persistent($label_clip29)
  read_persistent_var($label_clip29)
  declare ui_label $label_clipOutline28(1,1)
  make_persistent($label_clipOutline28)
  read_persistent_var($label_clipOutline28)
  declare ui_label $label_clip_dnd28(1,1)
  make_persistent($label_clip_dnd28)
  read_persistent_var($label_clip_dnd28)
  declare ui_label $label_clip28(1,1)
  make_persistent($label_clip28)
  read_persistent_var($label_clip28)
  declare ui_label $label_clipOutline27(1,1)
  make_persistent($label_clipOutline27)
  read_persistent_var($label_clipOutline27)
  declare ui_label $label_clip_dnd27(1,1)
  make_persistent($label_clip_dnd27)
  read_persistent_var($label_clip_dnd27)
  declare ui_label $label_clip27(1,1)
  make_persistent($label_clip27)
  read_persistent_var($label_clip27)
  declare ui_label $label_clipOutline26(1,1)
  make_persistent($label_clipOutline26)
  read_persistent_var($label_clipOutline26)
  declare ui_label $label_clip_dnd26(1,1)
  make_persistent($label_clip_dnd26)
  read_persistent_var($label_clip_dnd26)
  declare ui_label $label_clip26(1,1)
  make_persistent($label_clip26)
  read_persistent_var($label_clip26)
  declare ui_label $label_clipOutline25(1,1)
  make_persistent($label_clipOutline25)
  read_persistent_var($label_clipOutline25)
  declare ui_label $label_clip_dnd25(1,1)
  make_persistent($label_clip_dnd25)
  read_persistent_var($label_clip_dnd25)
  declare ui_label $label_clip25(1,1)
  make_persistent($label_clip25)
  read_persistent_var($label_clip25)
  declare ui_label $label_clipOutline24(1,1)
  make_persistent($label_clipOutline24)
  read_persistent_var($label_clipOutline24)
  declare ui_label $label_clip_dnd24(1,1)
  make_persistent($label_clip_dnd24)
  read_persistent_var($label_clip_dnd24)
  declare ui_label $label_clip24(1,1)
  make_persistent($label_clip24)
  read_persistent_var($label_clip24)
  declare ui_label $label_midiPg3Description(1,1)
  make_persistent($label_midiPg3Description)
  read_persistent_var($label_midiPg3Description)
  declare ui_label $label_clipOutline23(1,1)
  make_persistent($label_clipOutline23)
  read_persistent_var($label_clipOutline23)
  declare ui_label $label_clip_dnd23(1,1)
  make_persistent($label_clip_dnd23)
  read_persistent_var($label_clip_dnd23)
  declare ui_label $label_clip23(1,1)
  make_persistent($label_clip23)
  read_persistent_var($label_clip23)
  declare ui_label $label_clipOutline22(1,1)
  make_persistent($label_clipOutline22)
  read_persistent_var($label_clipOutline22)
  declare ui_label $label_clip_dnd22(1,1)
  make_persistent($label_clip_dnd22)
  read_persistent_var($label_clip_dnd22)
  declare ui_label $label_clip22(1,1)
  make_persistent($label_clip22)
  read_persistent_var($label_clip22)
  declare ui_label $label_clipOutline21(1,1)
  make_persistent($label_clipOutline21)
  read_persistent_var($label_clipOutline21)
  declare ui_label $label_clip_dnd21(1,1)
  make_persistent($label_clip_dnd21)
  read_persistent_var($label_clip_dnd21)
  declare ui_label $label_clip21(1,1)
  make_persistent($label_clip21)
  read_persistent_var($label_clip21)
  declare ui_label $label_clipOutline20(1,1)
  make_persistent($label_clipOutline20)
  read_persistent_var($label_clipOutline20)
  declare ui_label $label_clip_dnd20(1,1)
  make_persistent($label_clip_dnd20)
  read_persistent_var($label_clip_dnd20)
  declare ui_label $label_clip20(1,1)
  make_persistent($label_clip20)
  read_persistent_var($label_clip20)
  declare ui_label $label_clipOutline19(1,1)
  make_persistent($label_clipOutline19)
  read_persistent_var($label_clipOutline19)
  declare ui_label $label_clip_dnd19(1,1)
  make_persistent($label_clip_dnd19)
  read_persistent_var($label_clip_dnd19)
  declare ui_label $label_clip19(1,1)
  make_persistent($label_clip19)
  read_persistent_var($label_clip19)
  declare ui_label $label_clipOutline18(1,1)
  make_persistent($label_clipOutline18)
  read_persistent_var($label_clipOutline18)
  declare ui_label $label_clip_dnd18(1,1)
  make_persistent($label_clip_dnd18)
  read_persistent_var($label_clip_dnd18)
  declare ui_label $label_clip18(1,1)
  make_persistent($label_clip18)
  read_persistent_var($label_clip18)
  declare ui_label $label_clipOutline17(1,1)
  make_persistent($label_clipOutline17)
  read_persistent_var($label_clipOutline17)
  declare ui_label $label_clip_dnd17(1,1)
  make_persistent($label_clip_dnd17)
  read_persistent_var($label_clip_dnd17)
  declare ui_label $label_clip17(1,1)
  make_persistent($label_clip17)
  read_persistent_var($label_clip17)
  declare ui_label $label_clipOutline16(1,1)
  make_persistent($label_clipOutline16)
  read_persistent_var($label_clipOutline16)
  declare ui_label $label_clip_dnd16(1,1)
  make_persistent($label_clip_dnd16)
  read_persistent_var($label_clip_dnd16)
  declare ui_label $label_clip16(1,1)
  make_persistent($label_clip16)
  read_persistent_var($label_clip16)
  declare ui_label $label_midiPg2Description(1,1)
  make_persistent($label_midiPg2Description)
  read_persistent_var($label_midiPg2Description)
  declare ui_label $label_clipOutline15(1,1)
  make_persistent($label_clipOutline15)
  read_persistent_var($label_clipOutline15)
  declare ui_label $label_clip_dnd15(1,1)
  make_persistent($label_clip_dnd15)
  read_persistent_var($label_clip_dnd15)
  declare ui_label $label_clip15(1,1)
  make_persistent($label_clip15)
  read_persistent_var($label_clip15)
  declare ui_label $label_clipOutline14(1,1)
  make_persistent($label_clipOutline14)
  read_persistent_var($label_clipOutline14)
  declare ui_label $label_clip_dnd14(1,1)
  make_persistent($label_clip_dnd14)
  read_persistent_var($label_clip_dnd14)
  declare ui_label $label_clip14(1,1)
  make_persistent($label_clip14)
  read_persistent_var($label_clip14)
  declare ui_label $label_clipOutline13(1,1)
  make_persistent($label_clipOutline13)
  read_persistent_var($label_clipOutline13)
  declare ui_label $label_clip_dnd13(1,1)
  make_persistent($label_clip_dnd13)
  read_persistent_var($label_clip_dnd13)
  declare ui_label $label_clip13(1,1)
  make_persistent($label_clip13)
  read_persistent_var($label_clip13)
  declare ui_label $label_clipOutline12(1,1)
  make_persistent($label_clipOutline12)
  read_persistent_var($label_clipOutline12)
  declare ui_label $label_clip_dnd12(1,1)
  make_persistent($label_clip_dnd12)
  read_persistent_var($label_clip_dnd12)
  declare ui_label $label_clip12(1,1)
  make_persistent($label_clip12)
  read_persistent_var($label_clip12)
  declare ui_label $label_clipOutline11(1,1)
  make_persistent($label_clipOutline11)
  read_persistent_var($label_clipOutline11)
  declare ui_label $label_clip_dnd11(1,1)
  make_persistent($label_clip_dnd11)
  read_persistent_var($label_clip_dnd11)
  declare ui_label $label_clip11(1,1)
  make_persistent($label_clip11)
  read_persistent_var($label_clip11)
  declare ui_label $label_clipOutline10(1,1)
  make_persistent($label_clipOutline10)
  read_persistent_var($label_clipOutline10)
  declare ui_label $label_clip_dnd10(1,1)
  make_persistent($label_clip_dnd10)
  read_persistent_var($label_clip_dnd10)
  declare ui_label $label_clip10(1,1)
  make_persistent($label_clip10)
  read_persistent_var($label_clip10)
  declare ui_label $label_clipOutline9(1,1)
  make_persistent($label_clipOutline9)
  read_persistent_var($label_clipOutline9)
  declare ui_label $label_clip_dnd9(1,1)
  make_persistent($label_clip_dnd9)
  read_persistent_var($label_clip_dnd9)
  declare ui_label $label_clip9(1,1)
  make_persistent($label_clip9)
  read_persistent_var($label_clip9)
  declare ui_label $label_clipOutline8(1,1)
  make_persistent($label_clipOutline8)
  read_persistent_var($label_clipOutline8)
  declare ui_label $label_clip_dnd8(1,1)
  make_persistent($label_clip_dnd8)
  read_persistent_var($label_clip_dnd8)
  declare ui_label $label_clip8(1,1)
  make_persistent($label_clip8)
  read_persistent_var($label_clip8)
  declare ui_label $label_midiPg1Description(1,1)
  make_persistent($label_midiPg1Description)
  read_persistent_var($label_midiPg1Description)
  declare ui_label $label_clipOutline7(1,1)
  make_persistent($label_clipOutline7)
  read_persistent_var($label_clipOutline7)
  declare ui_label $label_clip_dnd7(1,1)
  make_persistent($label_clip_dnd7)
  read_persistent_var($label_clip_dnd7)
  declare ui_label $label_clip7(1,1)
  make_persistent($label_clip7)
  read_persistent_var($label_clip7)
  declare ui_label $label_clipOutline6(1,1)
  make_persistent($label_clipOutline6)
  read_persistent_var($label_clipOutline6)
  declare ui_label $label_clip_dnd6(1,1)
  make_persistent($label_clip_dnd6)
  read_persistent_var($label_clip_dnd6)
  declare ui_label $label_clip6(1,1)
  make_persistent($label_clip6)
  read_persistent_var($label_clip6)
  declare ui_label $label_clipOutline5(1,1)
  make_persistent($label_clipOutline5)
  read_persistent_var($label_clipOutline5)
  declare ui_label $label_clip_dnd5(1,1)
  make_persistent($label_clip_dnd5)
  read_persistent_var($label_clip_dnd5)
  declare ui_label $label_clip5(1,1)
  make_persistent($label_clip5)
  read_persistent_var($label_clip5)
  declare ui_label $label_clipOutline4(1,1)
  make_persistent($label_clipOutline4)
  read_persistent_var($label_clipOutline4)
  declare ui_label $label_clip_dnd4(1,1)
  make_persistent($label_clip_dnd4)
  read_persistent_var($label_clip_dnd4)
  declare ui_label $label_clip4(1,1)
  make_persistent($label_clip4)
  read_persistent_var($label_clip4)
  declare ui_label $label_clipOutline3(1,1)
  make_persistent($label_clipOutline3)
  read_persistent_var($label_clipOutline3)
  declare ui_label $label_clip_dnd3(1,1)
  make_persistent($label_clip_dnd3)
  read_persistent_var($label_clip_dnd3)
  declare ui_label $label_clip3(1,1)
  make_persistent($label_clip3)
  read_persistent_var($label_clip3)
  declare ui_label $label_clipOutline2(1,1)
  make_persistent($label_clipOutline2)
  read_persistent_var($label_clipOutline2)
  declare ui_label $label_clip_dnd2(1,1)
  make_persistent($label_clip_dnd2)
  read_persistent_var($label_clip_dnd2)
  declare ui_label $label_clip2(1,1)
  make_persistent($label_clip2)
  read_persistent_var($label_clip2)
  declare ui_label $label_clipOutline1(1,1)
  make_persistent($label_clipOutline1)
  read_persistent_var($label_clipOutline1)
  declare ui_label $label_clip_dnd1(1,1)
  make_persistent($label_clip_dnd1)
  read_persistent_var($label_clip_dnd1)
  declare ui_label $label_clip1(1,1)
  make_persistent($label_clip1)
  read_persistent_var($label_clip1)
  declare ui_label $label_clipOutline0(1,1)
  make_persistent($label_clipOutline0)
  read_persistent_var($label_clipOutline0)
  declare ui_label $label_clip_dnd0(1,1)
  make_persistent($label_clip_dnd0)
  read_persistent_var($label_clip_dnd0)
  declare ui_label $label_clip0(1,1)
  make_persistent($label_clip0)
  read_persistent_var($label_clip0)
  declare ui_label $label_midiPg0Description(1,1)
  make_persistent($label_midiPg0Description)
  read_persistent_var($label_midiPg0Description)
  declare ui_label $label_latency(1,1)
  make_persistent($label_latency)
  read_persistent_var($label_latency)
  declare ui_xy ?xypad_clipTitle79[32]
  make_persistent(?xypad_clipTitle79)
  read_persistent_var(?xypad_clipTitle79)
  declare ui_xy ?xypad_clipTitle78[32]
  make_persistent(?xypad_clipTitle78)
  read_persistent_var(?xypad_clipTitle78)
  declare ui_xy ?xypad_clipTitle77[32]
  make_persistent(?xypad_clipTitle77)
  read_persistent_var(?xypad_clipTitle77)
  declare ui_xy ?xypad_clipTitle76[32]
  make_persistent(?xypad_clipTitle76)
  read_persistent_var(?xypad_clipTitle76)
  declare ui_xy ?xypad_clipTitle75[32]
  make_persistent(?xypad_clipTitle75)
  read_persistent_var(?xypad_clipTitle75)
  declare ui_xy ?xypad_clipTitle74[32]
  make_persistent(?xypad_clipTitle74)
  read_persistent_var(?xypad_clipTitle74)
  declare ui_xy ?xypad_clipTitle73[32]
  make_persistent(?xypad_clipTitle73)
  read_persistent_var(?xypad_clipTitle73)
  declare ui_xy ?xypad_clipTitle72[32]
  make_persistent(?xypad_clipTitle72)
  read_persistent_var(?xypad_clipTitle72)
  declare ui_xy ?xypad_clipTitle71[32]
  make_persistent(?xypad_clipTitle71)
  read_persistent_var(?xypad_clipTitle71)
  declare ui_xy ?xypad_clipTitle70[32]
  make_persistent(?xypad_clipTitle70)
  read_persistent_var(?xypad_clipTitle70)
  declare ui_xy ?xypad_clipTitle69[32]
  make_persistent(?xypad_clipTitle69)
  read_persistent_var(?xypad_clipTitle69)
  declare ui_xy ?xypad_clipTitle68[32]
  make_persistent(?xypad_clipTitle68)
  read_persistent_var(?xypad_clipTitle68)
  declare ui_xy ?xypad_clipTitle67[32]
  make_persistent(?xypad_clipTitle67)
  read_persistent_var(?xypad_clipTitle67)
  declare ui_xy ?xypad_clipTitle66[32]
  make_persistent(?xypad_clipTitle66)
  read_persistent_var(?xypad_clipTitle66)
  declare ui_xy ?xypad_clipTitle65[32]
  make_persistent(?xypad_clipTitle65)
  read_persistent_var(?xypad_clipTitle65)
  declare ui_xy ?xypad_clipTitle64[32]
  make_persistent(?xypad_clipTitle64)
  read_persistent_var(?xypad_clipTitle64)
  declare ui_xy ?xypad_clipTitle63[32]
  make_persistent(?xypad_clipTitle63)
  read_persistent_var(?xypad_clipTitle63)
  declare ui_xy ?xypad_clipTitle62[32]
  make_persistent(?xypad_clipTitle62)
  read_persistent_var(?xypad_clipTitle62)
  declare ui_xy ?xypad_clipTitle61[32]
  make_persistent(?xypad_clipTitle61)
  read_persistent_var(?xypad_clipTitle61)
  declare ui_xy ?xypad_clipTitle60[32]
  make_persistent(?xypad_clipTitle60)
  read_persistent_var(?xypad_clipTitle60)
  declare ui_xy ?xypad_clipTitle59[32]
  make_persistent(?xypad_clipTitle59)
  read_persistent_var(?xypad_clipTitle59)
  declare ui_xy ?xypad_clipTitle58[32]
  make_persistent(?xypad_clipTitle58)
  read_persistent_var(?xypad_clipTitle58)
  declare ui_xy ?xypad_clipTitle57[32]
  make_persistent(?xypad_clipTitle57)
  read_persistent_var(?xypad_clipTitle57)
  declare ui_xy ?xypad_clipTitle56[32]
  make_persistent(?xypad_clipTitle56)
  read_persistent_var(?xypad_clipTitle56)
  declare ui_xy ?xypad_clipTitle55[32]
  make_persistent(?xypad_clipTitle55)
  read_persistent_var(?xypad_clipTitle55)
  declare ui_xy ?xypad_clipTitle54[32]
  make_persistent(?xypad_clipTitle54)
  read_persistent_var(?xypad_clipTitle54)
  declare ui_xy ?xypad_clipTitle53[32]
  make_persistent(?xypad_clipTitle53)
  read_persistent_var(?xypad_clipTitle53)
  declare ui_xy ?xypad_clipTitle52[32]
  make_persistent(?xypad_clipTitle52)
  read_persistent_var(?xypad_clipTitle52)
  declare ui_xy ?xypad_clipTitle51[32]
  make_persistent(?xypad_clipTitle51)
  read_persistent_var(?xypad_clipTitle51)
  declare ui_xy ?xypad_clipTitle50[32]
  make_persistent(?xypad_clipTitle50)
  read_persistent_var(?xypad_clipTitle50)
  declare ui_xy ?xypad_clipTitle49[32]
  make_persistent(?xypad_clipTitle49)
  read_persistent_var(?xypad_clipTitle49)
  declare ui_xy ?xypad_clipTitle48[32]
  make_persistent(?xypad_clipTitle48)
  read_persistent_var(?xypad_clipTitle48)
  declare ui_xy ?xypad_clipTitle47[32]
  make_persistent(?xypad_clipTitle47)
  read_persistent_var(?xypad_clipTitle47)
  declare ui_xy ?xypad_clipTitle46[32]
  make_persistent(?xypad_clipTitle46)
  read_persistent_var(?xypad_clipTitle46)
  declare ui_xy ?xypad_clipTitle45[32]
  make_persistent(?xypad_clipTitle45)
  read_persistent_var(?xypad_clipTitle45)
  declare ui_xy ?xypad_clipTitle44[32]
  make_persistent(?xypad_clipTitle44)
  read_persistent_var(?xypad_clipTitle44)
  declare ui_xy ?xypad_clipTitle43[32]
  make_persistent(?xypad_clipTitle43)
  read_persistent_var(?xypad_clipTitle43)
  declare ui_xy ?xypad_clipTitle42[32]
  make_persistent(?xypad_clipTitle42)
  read_persistent_var(?xypad_clipTitle42)
  declare ui_xy ?xypad_clipTitle41[32]
  make_persistent(?xypad_clipTitle41)
  read_persistent_var(?xypad_clipTitle41)
  declare ui_xy ?xypad_clipTitle40[32]
  make_persistent(?xypad_clipTitle40)
  read_persistent_var(?xypad_clipTitle40)
  declare ui_xy ?xypad_clipTitle39[32]
  make_persistent(?xypad_clipTitle39)
  read_persistent_var(?xypad_clipTitle39)
  declare ui_xy ?xypad_clipTitle38[32]
  make_persistent(?xypad_clipTitle38)
  read_persistent_var(?xypad_clipTitle38)
  declare ui_xy ?xypad_clipTitle37[32]
  make_persistent(?xypad_clipTitle37)
  read_persistent_var(?xypad_clipTitle37)
  declare ui_xy ?xypad_clipTitle36[32]
  make_persistent(?xypad_clipTitle36)
  read_persistent_var(?xypad_clipTitle36)
  declare ui_xy ?xypad_clipTitle35[32]
  make_persistent(?xypad_clipTitle35)
  read_persistent_var(?xypad_clipTitle35)
  declare ui_xy ?xypad_clipTitle34[32]
  make_persistent(?xypad_clipTitle34)
  read_persistent_var(?xypad_clipTitle34)
  declare ui_xy ?xypad_clipTitle33[32]
  make_persistent(?xypad_clipTitle33)
  read_persistent_var(?xypad_clipTitle33)
  declare ui_xy ?xypad_clipTitle32[32]
  make_persistent(?xypad_clipTitle32)
  read_persistent_var(?xypad_clipTitle32)
  declare ui_xy ?xypad_clipTitle31[32]
  make_persistent(?xypad_clipTitle31)
  read_persistent_var(?xypad_clipTitle31)
  declare ui_xy ?xypad_clipTitle30[32]
  make_persistent(?xypad_clipTitle30)
  read_persistent_var(?xypad_clipTitle30)
  declare ui_xy ?xypad_clipTitle29[32]
  make_persistent(?xypad_clipTitle29)
  read_persistent_var(?xypad_clipTitle29)
  declare ui_xy ?xypad_clipTitle28[32]
  make_persistent(?xypad_clipTitle28)
  read_persistent_var(?xypad_clipTitle28)
  declare ui_xy ?xypad_clipTitle27[32]
  make_persistent(?xypad_clipTitle27)
  read_persistent_var(?xypad_clipTitle27)
  declare ui_xy ?xypad_clipTitle26[32]
  make_persistent(?xypad_clipTitle26)
  read_persistent_var(?xypad_clipTitle26)
  declare ui_xy ?xypad_clipTitle25[32]
  make_persistent(?xypad_clipTitle25)
  read_persistent_var(?xypad_clipTitle25)
  declare ui_xy ?xypad_clipTitle24[32]
  make_persistent(?xypad_clipTitle24)
  read_persistent_var(?xypad_clipTitle24)
  declare ui_xy ?xypad_clipTitle23[32]
  make_persistent(?xypad_clipTitle23)
  read_persistent_var(?xypad_clipTitle23)
  declare ui_xy ?xypad_clipTitle22[32]
  make_persistent(?xypad_clipTitle22)
  read_persistent_var(?xypad_clipTitle22)
  declare ui_xy ?xypad_clipTitle21[32]
  make_persistent(?xypad_clipTitle21)
  read_persistent_var(?xypad_clipTitle21)
  declare ui_xy ?xypad_clipTitle20[32]
  make_persistent(?xypad_clipTitle20)
  read_persistent_var(?xypad_clipTitle20)
  declare ui_xy ?xypad_clipTitle19[32]
  make_persistent(?xypad_clipTitle19)
  read_persistent_var(?xypad_clipTitle19)
  declare ui_xy ?xypad_clipTitle18[32]
  make_persistent(?xypad_clipTitle18)
  read_persistent_var(?xypad_clipTitle18)
  declare ui_xy ?xypad_clipTitle17[32]
  make_persistent(?xypad_clipTitle17)
  read_persistent_var(?xypad_clipTitle17)
  declare ui_xy ?xypad_clipTitle16[32]
  make_persistent(?xypad_clipTitle16)
  read_persistent_var(?xypad_clipTitle16)
  declare ui_xy ?xypad_clipTitle15[32]
  make_persistent(?xypad_clipTitle15)
  read_persistent_var(?xypad_clipTitle15)
  declare ui_xy ?xypad_clipTitle14[32]
  make_persistent(?xypad_clipTitle14)
  read_persistent_var(?xypad_clipTitle14)
  declare ui_xy ?xypad_clipTitle13[32]
  make_persistent(?xypad_clipTitle13)
  read_persistent_var(?xypad_clipTitle13)
  declare ui_xy ?xypad_clipTitle12[32]
  make_persistent(?xypad_clipTitle12)
  read_persistent_var(?xypad_clipTitle12)
  declare ui_xy ?xypad_clipTitle11[32]
  make_persistent(?xypad_clipTitle11)
  read_persistent_var(?xypad_clipTitle11)
  declare ui_xy ?xypad_clipTitle10[32]
  make_persistent(?xypad_clipTitle10)
  read_persistent_var(?xypad_clipTitle10)
  declare ui_xy ?xypad_clipTitle9[32]
  make_persistent(?xypad_clipTitle9)
  read_persistent_var(?xypad_clipTitle9)
  declare ui_xy ?xypad_clipTitle8[32]
  make_persistent(?xypad_clipTitle8)
  read_persistent_var(?xypad_clipTitle8)
  declare ui_xy ?xypad_clipTitle7[32]
  make_persistent(?xypad_clipTitle7)
  read_persistent_var(?xypad_clipTitle7)
  declare ui_xy ?xypad_clipTitle6[32]
  make_persistent(?xypad_clipTitle6)
  read_persistent_var(?xypad_clipTitle6)
  declare ui_xy ?xypad_clipTitle5[32]
  make_persistent(?xypad_clipTitle5)
  read_persistent_var(?xypad_clipTitle5)
  declare ui_xy ?xypad_clipTitle4[32]
  make_persistent(?xypad_clipTitle4)
  read_persistent_var(?xypad_clipTitle4)
  declare ui_xy ?xypad_clipTitle3[32]
  make_persistent(?xypad_clipTitle3)
  read_persistent_var(?xypad_clipTitle3)
  declare ui_xy ?xypad_clipTitle2[32]
  make_persistent(?xypad_clipTitle2)
  read_persistent_var(?xypad_clipTitle2)
  declare ui_xy ?xypad_clipTitle1[32]
  make_persistent(?xypad_clipTitle1)
  read_persistent_var(?xypad_clipTitle1)
  declare ui_xy ?xypad_clipTitle0[32]
  make_persistent(?xypad_clipTitle0)
  read_persistent_var(?xypad_clipTitle0)
  declare %UI_ID[10000] := (0)
  %UI_ID[0] := get_ui_id($panel_UI)
  $figma_counter := 1
  while ($figma_counter<621)
    %UI_ID[$figma_counter] := %UI_ID[0]+$figma_counter
    inc($figma_counter)
  end while
  declare %panel_idx[621] := (0, 1, 1, 1, 1, 0, 6, 6, 0, 0, 0, 11, 11, 11, 14, 14, 14, 14, 14, 14, 14, 14, 11, 23, 23, 23, 23, 23, 23, 23, 23, 11, 32, 32, 32, 32, 32, 32, 32, 32, 11, ...
  41, 41, 41, 41, 41, 41, 41, 41, 11, 50, 50, 50, 50, 50, 50, 50, 50, 11, 59, 59, 59, 59, 59, 59, 59, 59, 11, 68, 68, 68, 68, 68, 68, 68, 68, 11, 77, 77, 77, 77, ...
  77, 77, 77, 77, 11, 86, 86, 86, 86, 86, 86, 86, 86, 11, 95, 95, 95, 95, 95, 95, 95, 95, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 4, 4, 4, 5, 5, 5, ...
  5, 5, 7, 9, 9, 9, 0, 13, 13, 13, 13, 13, 13, 13, 13, 13, 13, 15, 16, 17, 18, 19, 20, 21, 22, 24, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, ...
  40, 42, 43, 44, 45, 46, 47, 48, 49, 51, 52, 53, 54, 55, 56, 57, 58, 60, 61, 62, 63, 64, 65, 66, 67, 69, 70, 71, 72, 73, 74, 75, 76, 78, 79, 80, 81, 82, 83, 84, ...
  85, 87, 88, 89, 90, 91, 92, 93, 94, 96, 97, 98, 99, 100, 101, 102, 103, 11, 11, 11, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 3, 4, 5, 7, 8, 0, 2, 3, 4, ...
  5, 1, 9, 0, 0, 7, 0, 8, 0, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, ...
  10, 10, 10, 10, 10, 10, 0, 12, 15, 15, 15, 16, 16, 16, 17, 17, 17, 18, 18, 18, 19, 19, 19, 20, 20, 20, 21, 21, 21, 22, 22, 22, 14, 24, 24, 24, 25, 25, 25, 26, ...
  26, 26, 27, 27, 27, 28, 28, 28, 29, 29, 29, 30, 30, 30, 31, 31, 31, 23, 33, 33, 33, 34, 34, 34, 35, 35, 35, 36, 36, 36, 37, 37, 37, 38, 38, 38, 39, 39, 39, 40, ...
  40, 40, 32, 42, 42, 42, 43, 43, 43, 44, 44, 44, 45, 45, 45, 46, 46, 46, 47, 47, 47, 48, 48, 48, 49, 49, 49, 41, 51, 51, 51, 52, 52, 52, 53, 53, 53, 54, 54, 54, ...
  55, 55, 55, 56, 56, 56, 57, 57, 57, 58, 58, 58, 50, 60, 60, 60, 61, 61, 61, 62, 62, 62, 63, 63, 63, 64, 64, 64, 65, 65, 65, 66, 66, 66, 67, 67, 67, 59, 69, 69, ...
  69, 70, 70, 70, 71, 71, 71, 72, 72, 72, 73, 73, 73, 74, 74, 74, 75, 75, 75, 76, 76, 76, 68, 78, 78, 78, 79, 79, 79, 80, 80, 80, 81, 81, 81, 82, 82, 82, 83, 83, ...
  83, 84, 84, 84, 85, 85, 85, 77, 87, 87, 87, 88, 88, 88, 89, 89, 89, 90, 90, 90, 91, 91, 91, 92, 92, 92, 93, 93, 93, 94, 94, 94, 86, 96, 96, 96, 97, 97, 97, 98, ...
  98, 98, 99, 99, 99, 100, 100, 100, 101, 101, 101, 102, 102, 102, 103, 103, 103, 95, 0, 15, 16, 17, 18, 19, 20, 21, 22, 24, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, ...
  38, 39, 40, 42, 43, 44, 45, 46, 47, 48, 49, 51, 52, 53, 54, 55, 56, 57, 58, 60, 61, 62, 63, 64, 65, 66, 67, 69, 70, 71, 72, 73, 74, 75, 76, 78, 79, 80, 81, 82, ...
  83, 84, 85, 87, 88, 89, 90, 91, 92, 93, 94, 96, 97, 98, 99, 100, 101, 102, 103)
  declare %element_idx[621] := (1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, ...
  42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, ...
  82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, ...
  122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 153, 154, 155, 156, 157, 158, 159, 160, 161, ...
  162, 163, 164, 165, 166, 167, 168, 169, 170, 171, 172, 173, 174, 175, 176, 177, 178, 179, 180, 181, 182, 183, 184, 185, 186, 187, 188, 189, 190, 191, 192, 193, 194, 195, 196, 197, 198, 199, 200, 201, ...
  202, 203, 204, 205, 206, 207, 208, 209, 210, 211, 212, 213, 214, 215, 216, 217, 218, 219, 220, 221, 222, 223, 224, 225, 226, 227, 228, 229, 230, 231, 232, 233, 234, 235, 236, 237, 238, 239, 240, 241, ...
  242, 243, 244, 245, 246, 247, 248, 249, 250, 251, 252, 253, 254, 255, 256, 257, 258, 259, 260, 261, 262, 263, 264, 265, 266, 267, 268, 269, 270, 271, 272, 273, 274, 275, 276, 277, 278, 279, 280, 281, ...
  282, 283, 284, 285, 286, 287, 288, 289, 290, 291, 292, 293, 294, 295, 296, 297, 298, 299, 300, 301, 302, 303, 304, 305, 306, 307, 308, 309, 310, 311, 312, 313, 314, 315, 316, 317, 318, 319, 320, 321, ...
  322, 323, 324, 325, 326, 327, 328, 329, 330, 331, 332, 333, 334, 335, 336, 337, 338, 339, 340, 341, 342, 343, 344, 345, 346, 347, 348, 349, 350, 351, 352, 353, 354, 355, 356, 357, 358, 359, 360, 361, ...
  362, 363, 364, 365, 366, 367, 368, 369, 370, 371, 372, 373, 374, 375, 376, 377, 378, 379, 380, 381, 382, 383, 384, 385, 386, 387, 388, 389, 390, 391, 392, 393, 394, 395, 396, 397, 398, 399, 400, 401, ...
  402, 403, 404, 405, 406, 407, 408, 409, 410, 411, 412, 413, 414, 415, 416, 417, 418, 419, 420, 421, 422, 423, 424, 425, 426, 427, 428, 429, 430, 431, 432, 433, 434, 435, 436, 437, 438, 439, 440, 441, ...
  442, 443, 444, 445, 446, 447, 448, 449, 450, 451, 452, 453, 454, 455, 456, 457, 458, 459, 460, 461, 462, 463, 464, 465, 466, 467, 468, 469, 470, 471, 472, 473, 474, 475, 476, 477, 478, 479, 480, 481, ...
  482, 483, 484, 485, 486, 487, 488, 489, 490, 491, 492, 493, 494, 495, 496, 497, 498, 499, 500, 501, 502, 503, 504, 505, 506, 507, 508, 509, 510, 511, 512, 513, 514, 515, 516, 517, 518, 519, 520, 521, ...
  522, 523, 524, 525, 526, 527, 528, 529, 530, 531, 532, 533, 534, 535, 536, 537, 538, 539, 540, 541, 542, 543, 544, 545, 546, 547, 548, 549, 550, 551, 552, 553, 554, 555, 556, 557, 558, 559, 560, 561, ...
  562, 563, 564, 565, 566, 567, 568, 569, 570, 571, 572, 573, 574, 575, 576, 577, 578, 579, 580, 581, 582, 583, 584, 585, 586, 587, 588, 589, 590, 591, 592, 593, 594, 595, 596, 597, 598, 599, 600, 601, ...
  602, 603, 604, 605, 606, 607, 608, 609, 610, 611, 612, 613, 614, 615, 616, 617, 618, 619, 620)
  $figma_counter := 1
  while ($figma_counter<num_elements(%panel_idx))
    if (%panel_idx[$figma_counter] # -1)
      set_control_par(%UI_ID[$figma_counter],$CONTROL_PAR_PARENT_PANEL,%UI_ID[%panel_idx[$figma_counter-1]])
    end if
    inc($figma_counter)
  end while
  $figma_counter := 0
  while ($figma_counter<621)
    set_control_par_str(%UI_ID[$figma_counter],$CONTROL_PAR_TEXT,"")
    set_control_par(%UI_ID[$figma_counter],$CONTROL_PAR_WIDTH,%UI_width[$figma_counter])
    set_control_par(%UI_ID[$figma_counter],$CONTROL_PAR_HEIGHT,%UI_height[$figma_counter])
    set_control_par(%UI_ID[$figma_counter],$CONTROL_PAR_POS_X,%UI_x[$figma_counter])
    set_control_par(%UI_ID[$figma_counter],$CONTROL_PAR_POS_Y,%UI_y[$figma_counter])
    set_control_par(%UI_ID[$figma_counter],$CONTROL_PAR_DEFAULT_VALUE,%UI_default_value[$figma_counter])
    set_control_par(%UI_ID[$figma_counter],$CONTROL_PAR_Z_LAYER,%UI_z_layer[$figma_counter])
    if (%UI_mouse_behaviour[$figma_counter] # -1)
      set_control_par(%UI_ID[$figma_counter],$CONTROL_PAR_MOUSE_BEHAVIOUR,%UI_mouse_behaviour[$figma_counter])
    end if
    if (%UI_mouse_behaviour_x[$figma_counter] # -1)
      set_control_par(%UI_ID[$figma_counter],$CONTROL_PAR_MOUSE_BEHAVIOUR_X,%UI_mouse_behaviour_x[$figma_counter])
    end if
    if (%UI_mouse_behaviour_y[$figma_counter] # -1)
      set_control_par(%UI_ID[$figma_counter],$CONTROL_PAR_MOUSE_BEHAVIOUR_Y,%UI_mouse_behaviour[$figma_counter])
    end if
    if (%UI_skin[$figma_counter] # -1)
      set_control_par_str(%UI_ID[$figma_counter],$CONTROL_PAR_PICTURE,!skin_picture[%UI_skin[$figma_counter]])
    end if
    if (%UI_label_text[$figma_counter]>-1)
      set_control_par_str(%UI_ID[$figma_counter],$CONTROL_PAR_TEXT,!_labels_text[10*%UI_label_text[$figma_counter]+0])
      set_control_par(%UI_ID[$figma_counter],$CONTROL_PAR_TEXTPOS_Y,0)
      if (%MULTI_LINE_DATA[%UI_label_text[$figma_counter]]>1)
        $figma_counter_multi_line_labels := 0
        while ($figma_counter_multi_line_labels<(%MULTI_LINE_DATA[%UI_label_text[$figma_counter]]-1))
          set_control_par_str(%UI_ID[$figma_counter],$CONTROL_PAR_TEXTLINE,!_labels_text[10*%UI_label_text[$figma_counter]+$figma_counter_multi_line_labels+1])
          inc($figma_counter_multi_line_labels)
        end while
      end if
    end if
    if (%UI_font[$figma_counter] # -1)
      set_control_par(%UI_ID[$figma_counter],$CONTROL_PAR_FONT_TYPE,%font_file_ids[%UI_font[$figma_counter]])
    end if
    set_control_par(%UI_ID[$figma_counter],$CONTROL_PAR_HIDE,$HIDE_PART_NOTHING)
    inc($figma_counter)
  end while
  set_control_par_str($INST_ICON_ID,$CONTROL_PAR_PICTURE,"insticon")
  set_control_par(get_ui_id($label_version),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
  declare %panel_midiPg[10]
  declare %switch_midiPgChooser[10]
  %panel_midiPg[0] := get_ui_id($panel_midiPg0)
  %switch_midiPgChooser[0] := get_ui_id($switch_midiPgChooser0)
  %panel_midiPg[1] := get_ui_id($panel_midiPg1)
  %switch_midiPgChooser[1] := get_ui_id($switch_midiPgChooser1)
  %panel_midiPg[2] := get_ui_id($panel_midiPg2)
  %switch_midiPgChooser[2] := get_ui_id($switch_midiPgChooser2)
  %panel_midiPg[3] := get_ui_id($panel_midiPg3)
  %switch_midiPgChooser[3] := get_ui_id($switch_midiPgChooser3)
  %panel_midiPg[4] := get_ui_id($panel_midiPg4)
  %switch_midiPgChooser[4] := get_ui_id($switch_midiPgChooser4)
  %panel_midiPg[5] := get_ui_id($panel_midiPg5)
  %switch_midiPgChooser[5] := get_ui_id($switch_midiPgChooser5)
  %panel_midiPg[6] := get_ui_id($panel_midiPg6)
  %switch_midiPgChooser[6] := get_ui_id($switch_midiPgChooser6)
  %panel_midiPg[7] := get_ui_id($panel_midiPg7)
  %switch_midiPgChooser[7] := get_ui_id($switch_midiPgChooser7)
  %panel_midiPg[8] := get_ui_id($panel_midiPg8)
  %switch_midiPgChooser[8] := get_ui_id($switch_midiPgChooser8)
  %panel_midiPg[9] := get_ui_id($panel_midiPg9)
  %switch_midiPgChooser[9] := get_ui_id($switch_midiPgChooser9)
  $i := 0
  while ($i<10)
    set_control_par(%switch_midiPgChooser[$i],$CONTROL_PAR_VALUE,0)
    inc($i)
  end while
  set_control_par(%switch_midiPgChooser[0],$CONTROL_PAR_VALUE,1)
  declare %mf_cursor[80]
  declare ui_slider $mf_cursor0(0,1000)
  declare ui_slider $mf_cursor1(0,1000)
  declare ui_slider $mf_cursor2(0,1000)
  declare ui_slider $mf_cursor3(0,1000)
  declare ui_slider $mf_cursor4(0,1000)
  declare ui_slider $mf_cursor5(0,1000)
  declare ui_slider $mf_cursor6(0,1000)
  declare ui_slider $mf_cursor7(0,1000)
  declare ui_slider $mf_cursor8(0,1000)
  declare ui_slider $mf_cursor9(0,1000)
  declare ui_slider $mf_cursor10(0,1000)
  declare ui_slider $mf_cursor11(0,1000)
  declare ui_slider $mf_cursor12(0,1000)
  declare ui_slider $mf_cursor13(0,1000)
  declare ui_slider $mf_cursor14(0,1000)
  declare ui_slider $mf_cursor15(0,1000)
  declare ui_slider $mf_cursor16(0,1000)
  declare ui_slider $mf_cursor17(0,1000)
  declare ui_slider $mf_cursor18(0,1000)
  declare ui_slider $mf_cursor19(0,1000)
  declare ui_slider $mf_cursor20(0,1000)
  declare ui_slider $mf_cursor21(0,1000)
  declare ui_slider $mf_cursor22(0,1000)
  declare ui_slider $mf_cursor23(0,1000)
  declare ui_slider $mf_cursor24(0,1000)
  declare ui_slider $mf_cursor25(0,1000)
  declare ui_slider $mf_cursor26(0,1000)
  declare ui_slider $mf_cursor27(0,1000)
  declare ui_slider $mf_cursor28(0,1000)
  declare ui_slider $mf_cursor29(0,1000)
  declare ui_slider $mf_cursor30(0,1000)
  declare ui_slider $mf_cursor31(0,1000)
  declare ui_slider $mf_cursor32(0,1000)
  declare ui_slider $mf_cursor33(0,1000)
  declare ui_slider $mf_cursor34(0,1000)
  declare ui_slider $mf_cursor35(0,1000)
  declare ui_slider $mf_cursor36(0,1000)
  declare ui_slider $mf_cursor37(0,1000)
  declare ui_slider $mf_cursor38(0,1000)
  declare ui_slider $mf_cursor39(0,1000)
  declare ui_slider $mf_cursor40(0,1000)
  declare ui_slider $mf_cursor41(0,1000)
  declare ui_slider $mf_cursor42(0,1000)
  declare ui_slider $mf_cursor43(0,1000)
  declare ui_slider $mf_cursor44(0,1000)
  declare ui_slider $mf_cursor45(0,1000)
  declare ui_slider $mf_cursor46(0,1000)
  declare ui_slider $mf_cursor47(0,1000)
  declare ui_slider $mf_cursor48(0,1000)
  declare ui_slider $mf_cursor49(0,1000)
  declare ui_slider $mf_cursor50(0,1000)
  declare ui_slider $mf_cursor51(0,1000)
  declare ui_slider $mf_cursor52(0,1000)
  declare ui_slider $mf_cursor53(0,1000)
  declare ui_slider $mf_cursor54(0,1000)
  declare ui_slider $mf_cursor55(0,1000)
  declare ui_slider $mf_cursor56(0,1000)
  declare ui_slider $mf_cursor57(0,1000)
  declare ui_slider $mf_cursor58(0,1000)
  declare ui_slider $mf_cursor59(0,1000)
  declare ui_slider $mf_cursor60(0,1000)
  declare ui_slider $mf_cursor61(0,1000)
  declare ui_slider $mf_cursor62(0,1000)
  declare ui_slider $mf_cursor63(0,1000)
  declare ui_slider $mf_cursor64(0,1000)
  declare ui_slider $mf_cursor65(0,1000)
  declare ui_slider $mf_cursor66(0,1000)
  declare ui_slider $mf_cursor67(0,1000)
  declare ui_slider $mf_cursor68(0,1000)
  declare ui_slider $mf_cursor69(0,1000)
  declare ui_slider $mf_cursor70(0,1000)
  declare ui_slider $mf_cursor71(0,1000)
  declare ui_slider $mf_cursor72(0,1000)
  declare ui_slider $mf_cursor73(0,1000)
  declare ui_slider $mf_cursor74(0,1000)
  declare ui_slider $mf_cursor75(0,1000)
  declare ui_slider $mf_cursor76(0,1000)
  declare ui_slider $mf_cursor77(0,1000)
  declare ui_slider $mf_cursor78(0,1000)
  declare ui_slider $mf_cursor79(0,1000)
  $preproc_i := 0
  while ($preproc_i<=79)
    %mf_cursor[$preproc_i] := get_ui_id($mf_cursor0)+$preproc_i
    inc($preproc_i)
  end while
  declare %midi_clip_panel_id[80]
  declare %midi_clip_id[80]
  declare %midi_clip_dnd_id[80]
  declare %midi_clip_preview_id[80]
  declare %midi_clip_title_id[80]
  %midi_clip_panel_id[0] := get_ui_id($panel_clip0)
  %midi_clip_id[0] := get_ui_id($label_clip0)
  %midi_clip_dnd_id[0] := get_ui_id($label_clip_dnd0)
  %midi_clip_preview_id[0] := get_ui_id($switch_preview0)
  %midi_clip_title_id[0] := get_ui_id(?xypad_clipTitle0)
  %midi_clip_panel_id[1] := get_ui_id($panel_clip1)
  %midi_clip_id[1] := get_ui_id($label_clip1)
  %midi_clip_dnd_id[1] := get_ui_id($label_clip_dnd1)
  %midi_clip_preview_id[1] := get_ui_id($switch_preview1)
  %midi_clip_title_id[1] := get_ui_id(?xypad_clipTitle1)
  %midi_clip_panel_id[2] := get_ui_id($panel_clip2)
  %midi_clip_id[2] := get_ui_id($label_clip2)
  %midi_clip_dnd_id[2] := get_ui_id($label_clip_dnd2)
  %midi_clip_preview_id[2] := get_ui_id($switch_preview2)
  %midi_clip_title_id[2] := get_ui_id(?xypad_clipTitle2)
  %midi_clip_panel_id[3] := get_ui_id($panel_clip3)
  %midi_clip_id[3] := get_ui_id($label_clip3)
  %midi_clip_dnd_id[3] := get_ui_id($label_clip_dnd3)
  %midi_clip_preview_id[3] := get_ui_id($switch_preview3)
  %midi_clip_title_id[3] := get_ui_id(?xypad_clipTitle3)
  %midi_clip_panel_id[4] := get_ui_id($panel_clip4)
  %midi_clip_id[4] := get_ui_id($label_clip4)
  %midi_clip_dnd_id[4] := get_ui_id($label_clip_dnd4)
  %midi_clip_preview_id[4] := get_ui_id($switch_preview4)
  %midi_clip_title_id[4] := get_ui_id(?xypad_clipTitle4)
  %midi_clip_panel_id[5] := get_ui_id($panel_clip5)
  %midi_clip_id[5] := get_ui_id($label_clip5)
  %midi_clip_dnd_id[5] := get_ui_id($label_clip_dnd5)
  %midi_clip_preview_id[5] := get_ui_id($switch_preview5)
  %midi_clip_title_id[5] := get_ui_id(?xypad_clipTitle5)
  %midi_clip_panel_id[6] := get_ui_id($panel_clip6)
  %midi_clip_id[6] := get_ui_id($label_clip6)
  %midi_clip_dnd_id[6] := get_ui_id($label_clip_dnd6)
  %midi_clip_preview_id[6] := get_ui_id($switch_preview6)
  %midi_clip_title_id[6] := get_ui_id(?xypad_clipTitle6)
  %midi_clip_panel_id[7] := get_ui_id($panel_clip7)
  %midi_clip_id[7] := get_ui_id($label_clip7)
  %midi_clip_dnd_id[7] := get_ui_id($label_clip_dnd7)
  %midi_clip_preview_id[7] := get_ui_id($switch_preview7)
  %midi_clip_title_id[7] := get_ui_id(?xypad_clipTitle7)
  %midi_clip_panel_id[8] := get_ui_id($panel_clip8)
  %midi_clip_id[8] := get_ui_id($label_clip8)
  %midi_clip_dnd_id[8] := get_ui_id($label_clip_dnd8)
  %midi_clip_preview_id[8] := get_ui_id($switch_preview8)
  %midi_clip_title_id[8] := get_ui_id(?xypad_clipTitle8)
  %midi_clip_panel_id[9] := get_ui_id($panel_clip9)
  %midi_clip_id[9] := get_ui_id($label_clip9)
  %midi_clip_dnd_id[9] := get_ui_id($label_clip_dnd9)
  %midi_clip_preview_id[9] := get_ui_id($switch_preview9)
  %midi_clip_title_id[9] := get_ui_id(?xypad_clipTitle9)
  %midi_clip_panel_id[10] := get_ui_id($panel_clip10)
  %midi_clip_id[10] := get_ui_id($label_clip10)
  %midi_clip_dnd_id[10] := get_ui_id($label_clip_dnd10)
  %midi_clip_preview_id[10] := get_ui_id($switch_preview10)
  %midi_clip_title_id[10] := get_ui_id(?xypad_clipTitle10)
  %midi_clip_panel_id[11] := get_ui_id($panel_clip11)
  %midi_clip_id[11] := get_ui_id($label_clip11)
  %midi_clip_dnd_id[11] := get_ui_id($label_clip_dnd11)
  %midi_clip_preview_id[11] := get_ui_id($switch_preview11)
  %midi_clip_title_id[11] := get_ui_id(?xypad_clipTitle11)
  %midi_clip_panel_id[12] := get_ui_id($panel_clip12)
  %midi_clip_id[12] := get_ui_id($label_clip12)
  %midi_clip_dnd_id[12] := get_ui_id($label_clip_dnd12)
  %midi_clip_preview_id[12] := get_ui_id($switch_preview12)
  %midi_clip_title_id[12] := get_ui_id(?xypad_clipTitle12)
  %midi_clip_panel_id[13] := get_ui_id($panel_clip13)
  %midi_clip_id[13] := get_ui_id($label_clip13)
  %midi_clip_dnd_id[13] := get_ui_id($label_clip_dnd13)
  %midi_clip_preview_id[13] := get_ui_id($switch_preview13)
  %midi_clip_title_id[13] := get_ui_id(?xypad_clipTitle13)
  %midi_clip_panel_id[14] := get_ui_id($panel_clip14)
  %midi_clip_id[14] := get_ui_id($label_clip14)
  %midi_clip_dnd_id[14] := get_ui_id($label_clip_dnd14)
  %midi_clip_preview_id[14] := get_ui_id($switch_preview14)
  %midi_clip_title_id[14] := get_ui_id(?xypad_clipTitle14)
  %midi_clip_panel_id[15] := get_ui_id($panel_clip15)
  %midi_clip_id[15] := get_ui_id($label_clip15)
  %midi_clip_dnd_id[15] := get_ui_id($label_clip_dnd15)
  %midi_clip_preview_id[15] := get_ui_id($switch_preview15)
  %midi_clip_title_id[15] := get_ui_id(?xypad_clipTitle15)
  %midi_clip_panel_id[16] := get_ui_id($panel_clip16)
  %midi_clip_id[16] := get_ui_id($label_clip16)
  %midi_clip_dnd_id[16] := get_ui_id($label_clip_dnd16)
  %midi_clip_preview_id[16] := get_ui_id($switch_preview16)
  %midi_clip_title_id[16] := get_ui_id(?xypad_clipTitle16)
  %midi_clip_panel_id[17] := get_ui_id($panel_clip17)
  %midi_clip_id[17] := get_ui_id($label_clip17)
  %midi_clip_dnd_id[17] := get_ui_id($label_clip_dnd17)
  %midi_clip_preview_id[17] := get_ui_id($switch_preview17)
  %midi_clip_title_id[17] := get_ui_id(?xypad_clipTitle17)
  %midi_clip_panel_id[18] := get_ui_id($panel_clip18)
  %midi_clip_id[18] := get_ui_id($label_clip18)
  %midi_clip_dnd_id[18] := get_ui_id($label_clip_dnd18)
  %midi_clip_preview_id[18] := get_ui_id($switch_preview18)
  %midi_clip_title_id[18] := get_ui_id(?xypad_clipTitle18)
  %midi_clip_panel_id[19] := get_ui_id($panel_clip19)
  %midi_clip_id[19] := get_ui_id($label_clip19)
  %midi_clip_dnd_id[19] := get_ui_id($label_clip_dnd19)
  %midi_clip_preview_id[19] := get_ui_id($switch_preview19)
  %midi_clip_title_id[19] := get_ui_id(?xypad_clipTitle19)
  %midi_clip_panel_id[20] := get_ui_id($panel_clip20)
  %midi_clip_id[20] := get_ui_id($label_clip20)
  %midi_clip_dnd_id[20] := get_ui_id($label_clip_dnd20)
  %midi_clip_preview_id[20] := get_ui_id($switch_preview20)
  %midi_clip_title_id[20] := get_ui_id(?xypad_clipTitle20)
  %midi_clip_panel_id[21] := get_ui_id($panel_clip21)
  %midi_clip_id[21] := get_ui_id($label_clip21)
  %midi_clip_dnd_id[21] := get_ui_id($label_clip_dnd21)
  %midi_clip_preview_id[21] := get_ui_id($switch_preview21)
  %midi_clip_title_id[21] := get_ui_id(?xypad_clipTitle21)
  %midi_clip_panel_id[22] := get_ui_id($panel_clip22)
  %midi_clip_id[22] := get_ui_id($label_clip22)
  %midi_clip_dnd_id[22] := get_ui_id($label_clip_dnd22)
  %midi_clip_preview_id[22] := get_ui_id($switch_preview22)
  %midi_clip_title_id[22] := get_ui_id(?xypad_clipTitle22)
  %midi_clip_panel_id[23] := get_ui_id($panel_clip23)
  %midi_clip_id[23] := get_ui_id($label_clip23)
  %midi_clip_dnd_id[23] := get_ui_id($label_clip_dnd23)
  %midi_clip_preview_id[23] := get_ui_id($switch_preview23)
  %midi_clip_title_id[23] := get_ui_id(?xypad_clipTitle23)
  %midi_clip_panel_id[24] := get_ui_id($panel_clip24)
  %midi_clip_id[24] := get_ui_id($label_clip24)
  %midi_clip_dnd_id[24] := get_ui_id($label_clip_dnd24)
  %midi_clip_preview_id[24] := get_ui_id($switch_preview24)
  %midi_clip_title_id[24] := get_ui_id(?xypad_clipTitle24)
  %midi_clip_panel_id[25] := get_ui_id($panel_clip25)
  %midi_clip_id[25] := get_ui_id($label_clip25)
  %midi_clip_dnd_id[25] := get_ui_id($label_clip_dnd25)
  %midi_clip_preview_id[25] := get_ui_id($switch_preview25)
  %midi_clip_title_id[25] := get_ui_id(?xypad_clipTitle25)
  %midi_clip_panel_id[26] := get_ui_id($panel_clip26)
  %midi_clip_id[26] := get_ui_id($label_clip26)
  %midi_clip_dnd_id[26] := get_ui_id($label_clip_dnd26)
  %midi_clip_preview_id[26] := get_ui_id($switch_preview26)
  %midi_clip_title_id[26] := get_ui_id(?xypad_clipTitle26)
  %midi_clip_panel_id[27] := get_ui_id($panel_clip27)
  %midi_clip_id[27] := get_ui_id($label_clip27)
  %midi_clip_dnd_id[27] := get_ui_id($label_clip_dnd27)
  %midi_clip_preview_id[27] := get_ui_id($switch_preview27)
  %midi_clip_title_id[27] := get_ui_id(?xypad_clipTitle27)
  %midi_clip_panel_id[28] := get_ui_id($panel_clip28)
  %midi_clip_id[28] := get_ui_id($label_clip28)
  %midi_clip_dnd_id[28] := get_ui_id($label_clip_dnd28)
  %midi_clip_preview_id[28] := get_ui_id($switch_preview28)
  %midi_clip_title_id[28] := get_ui_id(?xypad_clipTitle28)
  %midi_clip_panel_id[29] := get_ui_id($panel_clip29)
  %midi_clip_id[29] := get_ui_id($label_clip29)
  %midi_clip_dnd_id[29] := get_ui_id($label_clip_dnd29)
  %midi_clip_preview_id[29] := get_ui_id($switch_preview29)
  %midi_clip_title_id[29] := get_ui_id(?xypad_clipTitle29)
  %midi_clip_panel_id[30] := get_ui_id($panel_clip30)
  %midi_clip_id[30] := get_ui_id($label_clip30)
  %midi_clip_dnd_id[30] := get_ui_id($label_clip_dnd30)
  %midi_clip_preview_id[30] := get_ui_id($switch_preview30)
  %midi_clip_title_id[30] := get_ui_id(?xypad_clipTitle30)
  %midi_clip_panel_id[31] := get_ui_id($panel_clip31)
  %midi_clip_id[31] := get_ui_id($label_clip31)
  %midi_clip_dnd_id[31] := get_ui_id($label_clip_dnd31)
  %midi_clip_preview_id[31] := get_ui_id($switch_preview31)
  %midi_clip_title_id[31] := get_ui_id(?xypad_clipTitle31)
  %midi_clip_panel_id[32] := get_ui_id($panel_clip32)
  %midi_clip_id[32] := get_ui_id($label_clip32)
  %midi_clip_dnd_id[32] := get_ui_id($label_clip_dnd32)
  %midi_clip_preview_id[32] := get_ui_id($switch_preview32)
  %midi_clip_title_id[32] := get_ui_id(?xypad_clipTitle32)
  %midi_clip_panel_id[33] := get_ui_id($panel_clip33)
  %midi_clip_id[33] := get_ui_id($label_clip33)
  %midi_clip_dnd_id[33] := get_ui_id($label_clip_dnd33)
  %midi_clip_preview_id[33] := get_ui_id($switch_preview33)
  %midi_clip_title_id[33] := get_ui_id(?xypad_clipTitle33)
  %midi_clip_panel_id[34] := get_ui_id($panel_clip34)
  %midi_clip_id[34] := get_ui_id($label_clip34)
  %midi_clip_dnd_id[34] := get_ui_id($label_clip_dnd34)
  %midi_clip_preview_id[34] := get_ui_id($switch_preview34)
  %midi_clip_title_id[34] := get_ui_id(?xypad_clipTitle34)
  %midi_clip_panel_id[35] := get_ui_id($panel_clip35)
  %midi_clip_id[35] := get_ui_id($label_clip35)
  %midi_clip_dnd_id[35] := get_ui_id($label_clip_dnd35)
  %midi_clip_preview_id[35] := get_ui_id($switch_preview35)
  %midi_clip_title_id[35] := get_ui_id(?xypad_clipTitle35)
  %midi_clip_panel_id[36] := get_ui_id($panel_clip36)
  %midi_clip_id[36] := get_ui_id($label_clip36)
  %midi_clip_dnd_id[36] := get_ui_id($label_clip_dnd36)
  %midi_clip_preview_id[36] := get_ui_id($switch_preview36)
  %midi_clip_title_id[36] := get_ui_id(?xypad_clipTitle36)
  %midi_clip_panel_id[37] := get_ui_id($panel_clip37)
  %midi_clip_id[37] := get_ui_id($label_clip37)
  %midi_clip_dnd_id[37] := get_ui_id($label_clip_dnd37)
  %midi_clip_preview_id[37] := get_ui_id($switch_preview37)
  %midi_clip_title_id[37] := get_ui_id(?xypad_clipTitle37)
  %midi_clip_panel_id[38] := get_ui_id($panel_clip38)
  %midi_clip_id[38] := get_ui_id($label_clip38)
  %midi_clip_dnd_id[38] := get_ui_id($label_clip_dnd38)
  %midi_clip_preview_id[38] := get_ui_id($switch_preview38)
  %midi_clip_title_id[38] := get_ui_id(?xypad_clipTitle38)
  %midi_clip_panel_id[39] := get_ui_id($panel_clip39)
  %midi_clip_id[39] := get_ui_id($label_clip39)
  %midi_clip_dnd_id[39] := get_ui_id($label_clip_dnd39)
  %midi_clip_preview_id[39] := get_ui_id($switch_preview39)
  %midi_clip_title_id[39] := get_ui_id(?xypad_clipTitle39)
  %midi_clip_panel_id[40] := get_ui_id($panel_clip40)
  %midi_clip_id[40] := get_ui_id($label_clip40)
  %midi_clip_dnd_id[40] := get_ui_id($label_clip_dnd40)
  %midi_clip_preview_id[40] := get_ui_id($switch_preview40)
  %midi_clip_title_id[40] := get_ui_id(?xypad_clipTitle40)
  %midi_clip_panel_id[41] := get_ui_id($panel_clip41)
  %midi_clip_id[41] := get_ui_id($label_clip41)
  %midi_clip_dnd_id[41] := get_ui_id($label_clip_dnd41)
  %midi_clip_preview_id[41] := get_ui_id($switch_preview41)
  %midi_clip_title_id[41] := get_ui_id(?xypad_clipTitle41)
  %midi_clip_panel_id[42] := get_ui_id($panel_clip42)
  %midi_clip_id[42] := get_ui_id($label_clip42)
  %midi_clip_dnd_id[42] := get_ui_id($label_clip_dnd42)
  %midi_clip_preview_id[42] := get_ui_id($switch_preview42)
  %midi_clip_title_id[42] := get_ui_id(?xypad_clipTitle42)
  %midi_clip_panel_id[43] := get_ui_id($panel_clip43)
  %midi_clip_id[43] := get_ui_id($label_clip43)
  %midi_clip_dnd_id[43] := get_ui_id($label_clip_dnd43)
  %midi_clip_preview_id[43] := get_ui_id($switch_preview43)
  %midi_clip_title_id[43] := get_ui_id(?xypad_clipTitle43)
  %midi_clip_panel_id[44] := get_ui_id($panel_clip44)
  %midi_clip_id[44] := get_ui_id($label_clip44)
  %midi_clip_dnd_id[44] := get_ui_id($label_clip_dnd44)
  %midi_clip_preview_id[44] := get_ui_id($switch_preview44)
  %midi_clip_title_id[44] := get_ui_id(?xypad_clipTitle44)
  %midi_clip_panel_id[45] := get_ui_id($panel_clip45)
  %midi_clip_id[45] := get_ui_id($label_clip45)
  %midi_clip_dnd_id[45] := get_ui_id($label_clip_dnd45)
  %midi_clip_preview_id[45] := get_ui_id($switch_preview45)
  %midi_clip_title_id[45] := get_ui_id(?xypad_clipTitle45)
  %midi_clip_panel_id[46] := get_ui_id($panel_clip46)
  %midi_clip_id[46] := get_ui_id($label_clip46)
  %midi_clip_dnd_id[46] := get_ui_id($label_clip_dnd46)
  %midi_clip_preview_id[46] := get_ui_id($switch_preview46)
  %midi_clip_title_id[46] := get_ui_id(?xypad_clipTitle46)
  %midi_clip_panel_id[47] := get_ui_id($panel_clip47)
  %midi_clip_id[47] := get_ui_id($label_clip47)
  %midi_clip_dnd_id[47] := get_ui_id($label_clip_dnd47)
  %midi_clip_preview_id[47] := get_ui_id($switch_preview47)
  %midi_clip_title_id[47] := get_ui_id(?xypad_clipTitle47)
  %midi_clip_panel_id[48] := get_ui_id($panel_clip48)
  %midi_clip_id[48] := get_ui_id($label_clip48)
  %midi_clip_dnd_id[48] := get_ui_id($label_clip_dnd48)
  %midi_clip_preview_id[48] := get_ui_id($switch_preview48)
  %midi_clip_title_id[48] := get_ui_id(?xypad_clipTitle48)
  %midi_clip_panel_id[49] := get_ui_id($panel_clip49)
  %midi_clip_id[49] := get_ui_id($label_clip49)
  %midi_clip_dnd_id[49] := get_ui_id($label_clip_dnd49)
  %midi_clip_preview_id[49] := get_ui_id($switch_preview49)
  %midi_clip_title_id[49] := get_ui_id(?xypad_clipTitle49)
  %midi_clip_panel_id[50] := get_ui_id($panel_clip50)
  %midi_clip_id[50] := get_ui_id($label_clip50)
  %midi_clip_dnd_id[50] := get_ui_id($label_clip_dnd50)
  %midi_clip_preview_id[50] := get_ui_id($switch_preview50)
  %midi_clip_title_id[50] := get_ui_id(?xypad_clipTitle50)
  %midi_clip_panel_id[51] := get_ui_id($panel_clip51)
  %midi_clip_id[51] := get_ui_id($label_clip51)
  %midi_clip_dnd_id[51] := get_ui_id($label_clip_dnd51)
  %midi_clip_preview_id[51] := get_ui_id($switch_preview51)
  %midi_clip_title_id[51] := get_ui_id(?xypad_clipTitle51)
  %midi_clip_panel_id[52] := get_ui_id($panel_clip52)
  %midi_clip_id[52] := get_ui_id($label_clip52)
  %midi_clip_dnd_id[52] := get_ui_id($label_clip_dnd52)
  %midi_clip_preview_id[52] := get_ui_id($switch_preview52)
  %midi_clip_title_id[52] := get_ui_id(?xypad_clipTitle52)
  %midi_clip_panel_id[53] := get_ui_id($panel_clip53)
  %midi_clip_id[53] := get_ui_id($label_clip53)
  %midi_clip_dnd_id[53] := get_ui_id($label_clip_dnd53)
  %midi_clip_preview_id[53] := get_ui_id($switch_preview53)
  %midi_clip_title_id[53] := get_ui_id(?xypad_clipTitle53)
  %midi_clip_panel_id[54] := get_ui_id($panel_clip54)
  %midi_clip_id[54] := get_ui_id($label_clip54)
  %midi_clip_dnd_id[54] := get_ui_id($label_clip_dnd54)
  %midi_clip_preview_id[54] := get_ui_id($switch_preview54)
  %midi_clip_title_id[54] := get_ui_id(?xypad_clipTitle54)
  %midi_clip_panel_id[55] := get_ui_id($panel_clip55)
  %midi_clip_id[55] := get_ui_id($label_clip55)
  %midi_clip_dnd_id[55] := get_ui_id($label_clip_dnd55)
  %midi_clip_preview_id[55] := get_ui_id($switch_preview55)
  %midi_clip_title_id[55] := get_ui_id(?xypad_clipTitle55)
  %midi_clip_panel_id[56] := get_ui_id($panel_clip56)
  %midi_clip_id[56] := get_ui_id($label_clip56)
  %midi_clip_dnd_id[56] := get_ui_id($label_clip_dnd56)
  %midi_clip_preview_id[56] := get_ui_id($switch_preview56)
  %midi_clip_title_id[56] := get_ui_id(?xypad_clipTitle56)
  %midi_clip_panel_id[57] := get_ui_id($panel_clip57)
  %midi_clip_id[57] := get_ui_id($label_clip57)
  %midi_clip_dnd_id[57] := get_ui_id($label_clip_dnd57)
  %midi_clip_preview_id[57] := get_ui_id($switch_preview57)
  %midi_clip_title_id[57] := get_ui_id(?xypad_clipTitle57)
  %midi_clip_panel_id[58] := get_ui_id($panel_clip58)
  %midi_clip_id[58] := get_ui_id($label_clip58)
  %midi_clip_dnd_id[58] := get_ui_id($label_clip_dnd58)
  %midi_clip_preview_id[58] := get_ui_id($switch_preview58)
  %midi_clip_title_id[58] := get_ui_id(?xypad_clipTitle58)
  %midi_clip_panel_id[59] := get_ui_id($panel_clip59)
  %midi_clip_id[59] := get_ui_id($label_clip59)
  %midi_clip_dnd_id[59] := get_ui_id($label_clip_dnd59)
  %midi_clip_preview_id[59] := get_ui_id($switch_preview59)
  %midi_clip_title_id[59] := get_ui_id(?xypad_clipTitle59)
  %midi_clip_panel_id[60] := get_ui_id($panel_clip60)
  %midi_clip_id[60] := get_ui_id($label_clip60)
  %midi_clip_dnd_id[60] := get_ui_id($label_clip_dnd60)
  %midi_clip_preview_id[60] := get_ui_id($switch_preview60)
  %midi_clip_title_id[60] := get_ui_id(?xypad_clipTitle60)
  %midi_clip_panel_id[61] := get_ui_id($panel_clip61)
  %midi_clip_id[61] := get_ui_id($label_clip61)
  %midi_clip_dnd_id[61] := get_ui_id($label_clip_dnd61)
  %midi_clip_preview_id[61] := get_ui_id($switch_preview61)
  %midi_clip_title_id[61] := get_ui_id(?xypad_clipTitle61)
  %midi_clip_panel_id[62] := get_ui_id($panel_clip62)
  %midi_clip_id[62] := get_ui_id($label_clip62)
  %midi_clip_dnd_id[62] := get_ui_id($label_clip_dnd62)
  %midi_clip_preview_id[62] := get_ui_id($switch_preview62)
  %midi_clip_title_id[62] := get_ui_id(?xypad_clipTitle62)
  %midi_clip_panel_id[63] := get_ui_id($panel_clip63)
  %midi_clip_id[63] := get_ui_id($label_clip63)
  %midi_clip_dnd_id[63] := get_ui_id($label_clip_dnd63)
  %midi_clip_preview_id[63] := get_ui_id($switch_preview63)
  %midi_clip_title_id[63] := get_ui_id(?xypad_clipTitle63)
  %midi_clip_panel_id[64] := get_ui_id($panel_clip64)
  %midi_clip_id[64] := get_ui_id($label_clip64)
  %midi_clip_dnd_id[64] := get_ui_id($label_clip_dnd64)
  %midi_clip_preview_id[64] := get_ui_id($switch_preview64)
  %midi_clip_title_id[64] := get_ui_id(?xypad_clipTitle64)
  %midi_clip_panel_id[65] := get_ui_id($panel_clip65)
  %midi_clip_id[65] := get_ui_id($label_clip65)
  %midi_clip_dnd_id[65] := get_ui_id($label_clip_dnd65)
  %midi_clip_preview_id[65] := get_ui_id($switch_preview65)
  %midi_clip_title_id[65] := get_ui_id(?xypad_clipTitle65)
  %midi_clip_panel_id[66] := get_ui_id($panel_clip66)
  %midi_clip_id[66] := get_ui_id($label_clip66)
  %midi_clip_dnd_id[66] := get_ui_id($label_clip_dnd66)
  %midi_clip_preview_id[66] := get_ui_id($switch_preview66)
  %midi_clip_title_id[66] := get_ui_id(?xypad_clipTitle66)
  %midi_clip_panel_id[67] := get_ui_id($panel_clip67)
  %midi_clip_id[67] := get_ui_id($label_clip67)
  %midi_clip_dnd_id[67] := get_ui_id($label_clip_dnd67)
  %midi_clip_preview_id[67] := get_ui_id($switch_preview67)
  %midi_clip_title_id[67] := get_ui_id(?xypad_clipTitle67)
  %midi_clip_panel_id[68] := get_ui_id($panel_clip68)
  %midi_clip_id[68] := get_ui_id($label_clip68)
  %midi_clip_dnd_id[68] := get_ui_id($label_clip_dnd68)
  %midi_clip_preview_id[68] := get_ui_id($switch_preview68)
  %midi_clip_title_id[68] := get_ui_id(?xypad_clipTitle68)
  %midi_clip_panel_id[69] := get_ui_id($panel_clip69)
  %midi_clip_id[69] := get_ui_id($label_clip69)
  %midi_clip_dnd_id[69] := get_ui_id($label_clip_dnd69)
  %midi_clip_preview_id[69] := get_ui_id($switch_preview69)
  %midi_clip_title_id[69] := get_ui_id(?xypad_clipTitle69)
  %midi_clip_panel_id[70] := get_ui_id($panel_clip70)
  %midi_clip_id[70] := get_ui_id($label_clip70)
  %midi_clip_dnd_id[70] := get_ui_id($label_clip_dnd70)
  %midi_clip_preview_id[70] := get_ui_id($switch_preview70)
  %midi_clip_title_id[70] := get_ui_id(?xypad_clipTitle70)
  %midi_clip_panel_id[71] := get_ui_id($panel_clip71)
  %midi_clip_id[71] := get_ui_id($label_clip71)
  %midi_clip_dnd_id[71] := get_ui_id($label_clip_dnd71)
  %midi_clip_preview_id[71] := get_ui_id($switch_preview71)
  %midi_clip_title_id[71] := get_ui_id(?xypad_clipTitle71)
  %midi_clip_panel_id[72] := get_ui_id($panel_clip72)
  %midi_clip_id[72] := get_ui_id($label_clip72)
  %midi_clip_dnd_id[72] := get_ui_id($label_clip_dnd72)
  %midi_clip_preview_id[72] := get_ui_id($switch_preview72)
  %midi_clip_title_id[72] := get_ui_id(?xypad_clipTitle72)
  %midi_clip_panel_id[73] := get_ui_id($panel_clip73)
  %midi_clip_id[73] := get_ui_id($label_clip73)
  %midi_clip_dnd_id[73] := get_ui_id($label_clip_dnd73)
  %midi_clip_preview_id[73] := get_ui_id($switch_preview73)
  %midi_clip_title_id[73] := get_ui_id(?xypad_clipTitle73)
  %midi_clip_panel_id[74] := get_ui_id($panel_clip74)
  %midi_clip_id[74] := get_ui_id($label_clip74)
  %midi_clip_dnd_id[74] := get_ui_id($label_clip_dnd74)
  %midi_clip_preview_id[74] := get_ui_id($switch_preview74)
  %midi_clip_title_id[74] := get_ui_id(?xypad_clipTitle74)
  %midi_clip_panel_id[75] := get_ui_id($panel_clip75)
  %midi_clip_id[75] := get_ui_id($label_clip75)
  %midi_clip_dnd_id[75] := get_ui_id($label_clip_dnd75)
  %midi_clip_preview_id[75] := get_ui_id($switch_preview75)
  %midi_clip_title_id[75] := get_ui_id(?xypad_clipTitle75)
  %midi_clip_panel_id[76] := get_ui_id($panel_clip76)
  %midi_clip_id[76] := get_ui_id($label_clip76)
  %midi_clip_dnd_id[76] := get_ui_id($label_clip_dnd76)
  %midi_clip_preview_id[76] := get_ui_id($switch_preview76)
  %midi_clip_title_id[76] := get_ui_id(?xypad_clipTitle76)
  %midi_clip_panel_id[77] := get_ui_id($panel_clip77)
  %midi_clip_id[77] := get_ui_id($label_clip77)
  %midi_clip_dnd_id[77] := get_ui_id($label_clip_dnd77)
  %midi_clip_preview_id[77] := get_ui_id($switch_preview77)
  %midi_clip_title_id[77] := get_ui_id(?xypad_clipTitle77)
  %midi_clip_panel_id[78] := get_ui_id($panel_clip78)
  %midi_clip_id[78] := get_ui_id($label_clip78)
  %midi_clip_dnd_id[78] := get_ui_id($label_clip_dnd78)
  %midi_clip_preview_id[78] := get_ui_id($switch_preview78)
  %midi_clip_title_id[78] := get_ui_id(?xypad_clipTitle78)
  %midi_clip_panel_id[79] := get_ui_id($panel_clip79)
  %midi_clip_id[79] := get_ui_id($label_clip79)
  %midi_clip_dnd_id[79] := get_ui_id($label_clip_dnd79)
  %midi_clip_preview_id[79] := get_ui_id($switch_preview79)
  %midi_clip_title_id[79] := get_ui_id(?xypad_clipTitle79)
  declare %midi_page_panel_id[10]
  %midi_page_panel_id[0] := get_ui_id($panel_midiPg0)
  %midi_page_panel_id[1] := get_ui_id($panel_midiPg1)
  %midi_page_panel_id[2] := get_ui_id($panel_midiPg2)
  %midi_page_panel_id[3] := get_ui_id($panel_midiPg3)
  %midi_page_panel_id[4] := get_ui_id($panel_midiPg4)
  %midi_page_panel_id[5] := get_ui_id($panel_midiPg5)
  %midi_page_panel_id[6] := get_ui_id($panel_midiPg6)
  %midi_page_panel_id[7] := get_ui_id($panel_midiPg7)
  %midi_page_panel_id[8] := get_ui_id($panel_midiPg8)
  %midi_page_panel_id[9] := get_ui_id($panel_midiPg9)
  declare %clip_info_cursor[80]
  $i := 0
  while ($i<80)
    mf_set_export_area(!clip_names[$i],-1,-1,$i,$i)
    mf_copy_export_area($i+1)
    set_control_par(%midi_clip_dnd_id[$i],$CONTROL_PAR_MIDI_EXPORT_AREA_IDX,$i+1)
    set_control_par(%midi_clip_dnd_id[$i],$CONTROL_PAR_DND_BEHAVIOUR,1)
    set_control_par(%midi_clip_preview_id[$i],$CONTROL_PAR_Z_LAYER,1)
    set_control_par(%midi_clip_preview_id[$i],$CONTROL_PAR_VALUE,0)
    set_control_par_str(%mf_cursor[$i],$CONTROL_PAR_PICTURE,"mf_cursor")
    set_control_par(%mf_cursor[$i],$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
    set_control_par(%mf_cursor[$i],$CONTROL_PAR_PARENT_PANEL,%midi_clip_panel_id[$i])
    set_control_par(%mf_cursor[$i],$CONTROL_PAR_POS_X,0)
    set_control_par(%mf_cursor[$i],$CONTROL_PAR_POS_Y,0)
    set_control_par_str(%midi_clip_title_id[$i],$CONTROL_PAR_PICTURE,"blank")
    $c := 0
    while ($c<=15)
      set_control_par_str_arr(%midi_clip_title_id[$i],$CONTROL_PAR_CURSOR_PICTURE,"blank",$c*2)
      inc($c)
    end while
    set_control_par_str_arr(%midi_clip_title_id[$i],$CONTROL_PAR_CURSOR_PICTURE,"clip title " & $i,0)
    set_control_par(%midi_clip_title_id[$i],$CONTROL_PAR_PARENT_PANEL,%midi_clip_panel_id[$i])
    set_control_par(%midi_clip_title_id[$i],$CONTROL_PAR_POS_X,get_control_par(%midi_clip_id[$i],$CONTROL_PAR_POS_X))
    set_control_par(%midi_clip_title_id[$i],$CONTROL_PAR_POS_Y,get_control_par(%midi_clip_id[$i],$CONTROL_PAR_POS_Y))
    set_control_par(%midi_clip_title_id[$i],$CONTROL_PAR_WIDTH,get_control_par(%midi_clip_id[$i],$CONTROL_PAR_WIDTH))
    set_control_par(%midi_clip_title_id[$i],$CONTROL_PAR_HEIGHT,get_control_par(%midi_clip_id[$i],$CONTROL_PAR_HEIGHT))
    inc($i)
  end while
  $button_showMidi := 0
  set_control_par(get_ui_id($switch_closeMidi),$CONTROL_PAR_HIDE,%hide_states[$button_showMidi])
  set_control_par(get_ui_id($panel_midi),$CONTROL_PAR_HIDE,%hide_states[$button_showMidi])
  $i := 0
  while ($i<10)
    set_control_par(%panel_midiPg[$i],$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
    inc($i)
  end while
  set_control_par(%panel_midiPg[$cur_midi_page],$CONTROL_PAR_HIDE,%hide_states[$button_showMidi])
  set_control_par(get_ui_id($label_midiInstructions),$CONTROL_PAR_HIDE,%hide_states[$button_showMidi])
  ~midiInstructions_opacity := int_to_real($button_showMidi)
  ~midiCover_opacity := int_to_real($button_showMidi)
  set_control_par(get_ui_id($panel_articulations),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($panel_fx),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($panel_speed),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($slider_speed),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($panel_direction),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($slider_direction),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($panel_legato),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($slider_legato),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($panel_releaseSamples),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($slider_releaseSamples),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($button_generalInfo),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($button_optionsInfo),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($menu_latency),$CONTROL_PAR_TEXTPOS_Y,100)
  add_menu_item($menu_latency,"Latency: 0 ms",0)
  add_menu_item($menu_latency,"Latency: 50 ms",50)
  add_menu_item($menu_latency,"Latency: 100 ms",100)
  set_control_par(get_ui_id($label_latency),$CONTROL_PAR_FONT_TYPE,get_font_id("Khula Bold Size 11 on"))
  set_control_par(get_ui_id($label_latency),$CONTROL_PAR_TEXT_ALIGNMENT,1)
  set_control_par_str(get_ui_id($label_latency),$CONTROL_PAR_TEXT,$menu_latency & "ms")
  set_control_par(get_ui_id($panel_midi),$CONTROL_PAR_Z_LAYER,0)
  set_control_par(get_ui_id($switch_titleInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
  set_control_par(get_ui_id($switch_generalInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
  set_control_par(get_ui_id($switch_articulationsInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
  set_control_par(get_ui_id($switch_optionsInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
  set_control_par(get_ui_id($switch_speedInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
  set_control_par(get_ui_id($switch_directionInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
  set_control_par(get_ui_id($switch_legatoInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
  set_control_par(get_ui_id($switch_releaseSamplesInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
  set_control_par(get_ui_id($switch_titleInfoDisp),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($switch_generalInfoDisp),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($switch_articulationsInfoDisp),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($switch_optionsInfoDisp),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($switch_speedInfoDisp),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($switch_directionInfoDisp),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($switch_legatoInfoDisp),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($switch_releaseSamplesInfoDisp),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($panel_midiPgChooser),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($switch_midiPgChooser0),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($switch_midiPgChooser1),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($panel_articulations),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($panel_fx),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($panel_speed),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($panel_direction),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($panel_legato),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($panel_releaseSamples),$CONTROL_PAR_Z_LAYER,1)
  declare %key_ids[128]
  %key_ids[0+$LOWEST_KEY] := get_ui_id($label_oct0__note0)
  %key_ids[0+$LOWEST_KEY+12] := get_ui_id($label_oct1__note0)
  %key_ids[0+$LOWEST_KEY+(12*2)] := get_ui_id($label_oct2__note0)
  %key_ids[1+$LOWEST_KEY] := get_ui_id($label_oct0__note1)
  %key_ids[1+$LOWEST_KEY+12] := get_ui_id($label_oct1__note1)
  %key_ids[1+$LOWEST_KEY+(12*2)] := get_ui_id($label_oct2__note1)
  %key_ids[2+$LOWEST_KEY] := get_ui_id($label_oct0__note2)
  %key_ids[2+$LOWEST_KEY+12] := get_ui_id($label_oct1__note2)
  %key_ids[2+$LOWEST_KEY+(12*2)] := get_ui_id($label_oct2__note2)
  %key_ids[3+$LOWEST_KEY] := get_ui_id($label_oct0__note3)
  %key_ids[3+$LOWEST_KEY+12] := get_ui_id($label_oct1__note3)
  %key_ids[3+$LOWEST_KEY+(12*2)] := get_ui_id($label_oct2__note3)
  %key_ids[4+$LOWEST_KEY] := get_ui_id($label_oct0__note4)
  %key_ids[4+$LOWEST_KEY+12] := get_ui_id($label_oct1__note4)
  %key_ids[4+$LOWEST_KEY+(12*2)] := get_ui_id($label_oct2__note4)
  %key_ids[5+$LOWEST_KEY] := get_ui_id($label_oct0__note5)
  %key_ids[5+$LOWEST_KEY+12] := get_ui_id($label_oct1__note5)
  %key_ids[5+$LOWEST_KEY+(12*2)] := get_ui_id($label_oct2__note5)
  %key_ids[6+$LOWEST_KEY] := get_ui_id($label_oct0__note6)
  %key_ids[6+$LOWEST_KEY+12] := get_ui_id($label_oct1__note6)
  %key_ids[6+$LOWEST_KEY+(12*2)] := get_ui_id($label_oct2__note6)
  %key_ids[7+$LOWEST_KEY] := get_ui_id($label_oct0__note7)
  %key_ids[7+$LOWEST_KEY+12] := get_ui_id($label_oct1__note7)
  %key_ids[7+$LOWEST_KEY+(12*2)] := get_ui_id($label_oct2__note7)
  %key_ids[8+$LOWEST_KEY] := get_ui_id($label_oct0__note8)
  %key_ids[8+$LOWEST_KEY+12] := get_ui_id($label_oct1__note8)
  %key_ids[8+$LOWEST_KEY+(12*2)] := get_ui_id($label_oct2__note8)
  %key_ids[9+$LOWEST_KEY] := get_ui_id($label_oct0__note9)
  %key_ids[9+$LOWEST_KEY+12] := get_ui_id($label_oct1__note9)
  %key_ids[9+$LOWEST_KEY+(12*2)] := get_ui_id($label_oct2__note9)
  %key_ids[10+$LOWEST_KEY] := get_ui_id($label_oct0__note10)
  %key_ids[10+$LOWEST_KEY+12] := get_ui_id($label_oct1__note10)
  %key_ids[10+$LOWEST_KEY+(12*2)] := get_ui_id($label_oct2__note10)
  %key_ids[11+$LOWEST_KEY] := get_ui_id($label_oct0__note11)
  %key_ids[11+$LOWEST_KEY+12] := get_ui_id($label_oct1__note11)
  %key_ids[11+$LOWEST_KEY+(12*2)] := get_ui_id($label_oct2__note11)
  %key_ids[72] := get_ui_id($label_oct2__note12)
  $key_i := $LOWEST_KEY
  while ($key_i<=$HIGHEST_KEY)
    set_control_par(%key_ids[$key_i],$CONTROL_PAR_VALUE,0)
    inc($key_i)
  end while
  declare !reverb_preset_names[3]
  !reverb_preset_names[0] := "Small"
  !reverb_preset_names[1] := "Medium"
  !reverb_preset_names[2] := "Large"
  declare %_reverb_preset[3*8]
  make_persistent(%_reverb_preset)
  read_persistent_var(%_reverb_preset)
  declare const $reverb_preset__SIZE_D1 := 3
  declare const $reverb_preset__SIZE_D2 := 8
  $i := 0
  while ($i<3)
    add_menu_item($menu_reverb,!reverb_preset_names[$i],$i)
    inc($i)
  end while
  set_control_par(get_ui_id($switch_reverbToggle),$CONTROL_PAR_TEXT_ALIGNMENT,0)
  set_control_par_str(get_ui_id($switch_reverbToggle),$CONTROL_PAR_TEXT,"REVERB")
  set_control_par(get_ui_id($label_vol),$CONTROL_PAR_FONT_TYPE,get_font_id("Khula Bold Size 11 on"))
  set_control_par(get_ui_id($switch_reverbToggle),$CONTROL_PAR_FONT_TYPE,get_font_id("Khula Bold Size 11 off"))
  set_control_par(get_ui_id($switch_reverbToggle),$CONTROL_PAR_FONT_TYPE_ON,get_font_id("Khula Bold Size 11 on"))
  set_control_par(get_ui_id($switch_reverbToggle),$CONTROL_PAR_FONT_TYPE_OFF_PRESSED,get_font_id("Khula Bold Size 11 off pressed"))
  set_control_par(get_ui_id($switch_reverbToggle),$CONTROL_PAR_FONT_TYPE_ON_PRESSED,get_font_id("Khula Bold Size 11 on pressed"))
  set_control_par(get_ui_id($switch_reverbToggle),$CONTROL_PAR_FONT_TYPE_OFF_HOVER,get_font_id("Khula Bold Size 11 off hover"))
  set_control_par(get_ui_id($switch_reverbToggle),$CONTROL_PAR_FONT_TYPE_ON_HOVER,get_font_id("Khula Bold Size 11 on hover"))
  set_control_par(get_ui_id($switch_reverbToggle),$CONTROL_PAR_DISABLE_TEXT_SHIFTING,1)
  set_control_par_str(get_ui_id($switch_reverbToggle),$CONTROL_PAR_AUTOMATION_NAME,0)
  declare %articulation_ids[3]
  %articulation_ids[$artic__quarters] := get_ui_id($switch_quarters)
  %articulation_ids[$artic__eighths] := get_ui_id($switch_eighths)
  %articulation_ids[$artic__sixteenths] := get_ui_id($switch_sixteenths)
  $i := 0
  while ($i<3)
    set_control_par(%articulation_ids[$i],$CONTROL_PAR_ALLOW_AUTOMATION,0)
    inc($i)
  end while
  declare %speed_ids[5]
  %speed_ids[$speedMode__halfSpeed] := get_ui_id($switch_halfSpeed)
  %speed_ids[$speedMode__slowTripletSpeed] := get_ui_id($switch_slowTripletSpeed)
  %speed_ids[$speedMode__fullSpeed] := get_ui_id($switch_fullSpeed)
  %speed_ids[$speedMode__fastTripletSpeed] := get_ui_id($switch_fastTripletSpeed)
  %speed_ids[$speedMode__doubleSpeed] := get_ui_id($switch_doubleSpeed)
  $i := 0
  while ($i<num_elements(%speed_ids))
    set_control_par(%speed_ids[$i],$CONTROL_PAR_FONT_TYPE,get_font_id("Khula Bold Size 11 off"))
    set_control_par(%speed_ids[$i],$CONTROL_PAR_FONT_TYPE_ON,get_font_id("Khula Bold Size 11 on"))
    set_control_par(%speed_ids[$i],$CONTROL_PAR_FONT_TYPE_OFF_PRESSED,get_font_id("Khula Bold Size 11 off pressed"))
    set_control_par(%speed_ids[$i],$CONTROL_PAR_FONT_TYPE_ON_PRESSED,get_font_id("Khula Bold Size 11 on pressed"))
    set_control_par(%speed_ids[$i],$CONTROL_PAR_FONT_TYPE_OFF_HOVER,get_font_id("Khula Bold Size 11 off hover"))
    set_control_par(%speed_ids[$i],$CONTROL_PAR_FONT_TYPE_ON_HOVER,get_font_id("Khula Bold Size 11 on hover"))
    set_control_par_str(%speed_ids[$i],$CONTROL_PAR_TEXT,!speed_texts[$i])
    set_control_par(%speed_ids[$i],$CONTROL_PAR_WIDTH,get_control_par(%speed_ids[$i],$CONTROL_PAR_WIDTH)+14)
    inc($i)
  end while
  declare %direction_ids[3]
  %direction_ids[$directionMode__down] := get_ui_id($switch_down)
  %direction_ids[$directionMode__asPlayed] := get_ui_id($switch_asPlayed)
  %direction_ids[$directionMode__up] := get_ui_id($switch_up)
  $i := 0
  while ($i<num_elements(%direction_ids))
    set_control_par(%direction_ids[$i],$CONTROL_PAR_FONT_TYPE,get_font_id("Khula Bold Size 11 off"))
    set_control_par(%direction_ids[$i],$CONTROL_PAR_FONT_TYPE_ON,get_font_id("Khula Bold Size 11 on"))
    set_control_par(%direction_ids[$i],$CONTROL_PAR_FONT_TYPE_OFF_PRESSED,get_font_id("Khula Bold Size 11 off pressed"))
    set_control_par(%direction_ids[$i],$CONTROL_PAR_FONT_TYPE_ON_PRESSED,get_font_id("Khula Bold Size 11 on pressed"))
    set_control_par(%direction_ids[$i],$CONTROL_PAR_FONT_TYPE_OFF_HOVER,get_font_id("Khula Bold Size 11 off hover"))
    set_control_par(%direction_ids[$i],$CONTROL_PAR_FONT_TYPE_ON_HOVER,get_font_id("Khula Bold Size 11 on hover"))
    set_control_par_str(%direction_ids[$i],$CONTROL_PAR_TEXT,!direction_texts[$i])
    inc($i)
  end while
  set_control_par(get_ui_id($switch_down),$CONTROL_PAR_WIDTH,get_control_par(get_ui_id($switch_down),$CONTROL_PAR_WIDTH)+13)
  set_control_par(get_ui_id($switch_asPlayed),$CONTROL_PAR_WIDTH,get_control_par(get_ui_id($switch_asPlayed),$CONTROL_PAR_WIDTH)+19)
  set_control_par(get_ui_id($switch_up),$CONTROL_PAR_WIDTH,get_control_par(get_ui_id($switch_up),$CONTROL_PAR_WIDTH)+7)
  declare %legato_ids[4]
  %legato_ids[$legatoMode__noLegato] := get_ui_id($switch_noLegato)
  %legato_ids[$legatoMode__syncToPitch] := get_ui_id($switch_syncToPitch)
  %legato_ids[$legatoMode__syncToRipple] := get_ui_id($switch_syncToRipple)
  %legato_ids[$legatoMode__syncToSwell] := get_ui_id($switch_syncToSwell)
  $i := 0
  while ($i<num_elements(%legato_ids))
    set_control_par(%legato_ids[$i],$CONTROL_PAR_FONT_TYPE,get_font_id("Khula Bold Size 11 off"))
    set_control_par(%legato_ids[$i],$CONTROL_PAR_FONT_TYPE_ON,get_font_id("Khula Bold Size 11 on"))
    set_control_par(%legato_ids[$i],$CONTROL_PAR_FONT_TYPE_OFF_PRESSED,get_font_id("Khula Bold Size 11 off pressed"))
    set_control_par(%legato_ids[$i],$CONTROL_PAR_FONT_TYPE_ON_PRESSED,get_font_id("Khula Bold Size 11 on pressed"))
    set_control_par(%legato_ids[$i],$CONTROL_PAR_FONT_TYPE_OFF_HOVER,get_font_id("Khula Bold Size 11 off hover"))
    set_control_par(%legato_ids[$i],$CONTROL_PAR_FONT_TYPE_ON_HOVER,get_font_id("Khula Bold Size 11 on hover"))
    set_control_par_str(%legato_ids[$i],$CONTROL_PAR_TEXT,!_option_texts_shortened[10*$control__legato+$i])
    inc($i)
  end while
  declare %releaseSamples_ids[6]
  %releaseSamples_ids[$releaseSampleMode__noReleaseSample] := get_ui_id($switch_noReleaseSample)
  %releaseSamples_ids[$releaseSampleMode__autoRelease] := get_ui_id($switch_autoRelease)
  %releaseSamples_ids[$releaseSampleMode__Release0] := get_ui_id($switch_Release0)
  %releaseSamples_ids[$releaseSampleMode__Release1] := get_ui_id($switch_Release1)
  %releaseSamples_ids[$releaseSampleMode__Release2] := get_ui_id($switch_Release2)
  %releaseSamples_ids[$releaseSampleMode__Release3] := get_ui_id($switch_Release3)
  $i := 0
  while ($i<num_elements(%releaseSamples_ids))
    set_control_par(%releaseSamples_ids[$i],$CONTROL_PAR_FONT_TYPE,get_font_id("Khula Bold Size 11 off"))
    set_control_par(%releaseSamples_ids[$i],$CONTROL_PAR_FONT_TYPE_ON,get_font_id("Khula Bold Size 11 on"))
    set_control_par(%releaseSamples_ids[$i],$CONTROL_PAR_FONT_TYPE_OFF_PRESSED,get_font_id("Khula Bold Size 11 off pressed"))
    set_control_par(%releaseSamples_ids[$i],$CONTROL_PAR_FONT_TYPE_ON_PRESSED,get_font_id("Khula Bold Size 11 on pressed"))
    set_control_par(%releaseSamples_ids[$i],$CONTROL_PAR_FONT_TYPE_OFF_HOVER,get_font_id("Khula Bold Size 11 off hover"))
    set_control_par(%releaseSamples_ids[$i],$CONTROL_PAR_FONT_TYPE_ON_HOVER,get_font_id("Khula Bold Size 11 on hover"))
    set_control_par_str(%releaseSamples_ids[$i],$CONTROL_PAR_TEXT,!releaseSamples_texts[$i])
    inc($i)
  end while
  set_control_par(get_ui_id($switch_noReleaseSample),$CONTROL_PAR_POS_X,get_control_par(get_ui_id($switch_noReleaseSample),$CONTROL_PAR_POS_X)+7)
  set_control_par(get_ui_id($switch_autoRelease),$CONTROL_PAR_POS_X,get_control_par(get_ui_id($switch_autoRelease),$CONTROL_PAR_POS_X)+9)
  set_control_par(get_ui_id($switch_autoRelease),$CONTROL_PAR_WIDTH,get_control_par(get_ui_id($switch_autoRelease),$CONTROL_PAR_WIDTH)+10)
  set_control_par(get_ui_id($switch_Release0),$CONTROL_PAR_POS_X,get_control_par(get_ui_id($switch_Release0),$CONTROL_PAR_POS_X)+14)
  set_control_par(get_ui_id($switch_Release1),$CONTROL_PAR_POS_X,get_control_par(get_ui_id($switch_Release1),$CONTROL_PAR_POS_X)+14)
  set_control_par(get_ui_id($switch_Release2),$CONTROL_PAR_POS_X,get_control_par(get_ui_id($switch_Release2),$CONTROL_PAR_POS_X)+16)
  set_control_par(get_ui_id($switch_Release3),$CONTROL_PAR_POS_X,get_control_par(get_ui_id($switch_Release3),$CONTROL_PAR_POS_X)+16)
  set_control_par(get_ui_id($slider_speed),$CONTROL_PAR_MOUSE_BEHAVIOUR,2000)
  set_control_par(get_ui_id($slider_direction),$CONTROL_PAR_MOUSE_BEHAVIOUR,2000)
  set_control_par(get_ui_id($slider_legato),$CONTROL_PAR_MOUSE_BEHAVIOUR,2000)
  set_control_par(get_ui_id($slider_releaseSamples),$CONTROL_PAR_MOUSE_BEHAVIOUR,2000)
  %ctrl_ids[$control__vol] := get_ui_id($slider_vol)
  %ctrl_ids[$control__reverb] := get_ui_id($slider_reverb)
  %ctrl_ids[$control__speed] := get_ui_id($slider_speed)
  %ctrl_ids[$control__direction] := get_ui_id($slider_direction)
  %ctrl_ids[$control__legato] := get_ui_id($slider_legato)
  %ctrl_ids[$control__releaseSamples] := get_ui_id($slider_releaseSamples)
  set_control_par(get_ui_id($slider_speed),$CONTROL_PAR_DEFAULT_VALUE,2)
  set_control_par(get_ui_id($slider_direction),$CONTROL_PAR_DEFAULT_VALUE,1)
  set_control_par(get_ui_id($slider_legato),$CONTROL_PAR_DEFAULT_VALUE,0)
  set_control_par(get_ui_id($slider_vol),$CONTROL_PAR_DEFAULT_VALUE,500000)
  set_control_par(get_ui_id($slider_reverb),$CONTROL_PAR_DEFAULT_VALUE,500000)
  set_control_par(get_ui_id($menu_reverb),$CONTROL_PAR_TEXTPOS_Y,100)
  set_control_par(get_ui_id($slider_vol),$CONTROL_PAR_AUTOMATION_ID,0)
  set_control_par_str(get_ui_id($slider_vol),$CONTROL_PAR_AUTOMATION_NAME,"Expression")
  set_control_par(get_ui_id($slider_reverb),$CONTROL_PAR_AUTOMATION_ID,1)
  set_control_par_str(get_ui_id($slider_reverb),$CONTROL_PAR_AUTOMATION_NAME,"Reverb")
  set_control_par(get_ui_id($slider_speed),$CONTROL_PAR_AUTOMATION_ID,2)
  set_control_par_str(get_ui_id($slider_speed),$CONTROL_PAR_AUTOMATION_NAME,"Speed")
  set_control_par(get_ui_id($slider_direction),$CONTROL_PAR_AUTOMATION_ID,3)
  set_control_par_str(get_ui_id($slider_direction),$CONTROL_PAR_AUTOMATION_NAME,"Direction")
  set_control_par(get_ui_id($slider_legato),$CONTROL_PAR_AUTOMATION_ID,4)
  set_control_par_str(get_ui_id($slider_legato),$CONTROL_PAR_AUTOMATION_NAME,"Sync")
  set_control_par(get_ui_id($slider_releaseSamples),$CONTROL_PAR_AUTOMATION_ID,5)
  set_control_par_str(get_ui_id($slider_releaseSamples),$CONTROL_PAR_AUTOMATION_NAME,"Release Samples")
  set_voice_limit($NI_VL_TMPRO_STANDARD,32*2)
  declare @siln2
  @siln2 := "START_EVENTS_INTEGERS_ENGINE"
  set_engine_par($ENGINE_PAR_SPEED,1000000-((4*8+4-1)*90909),$artic__quarters,-1,-1)
  set_engine_par($ENGINE_PAR_SPEED,1000000-((20-1)*90909),$artic__eighths,-1,-1)
  set_engine_par($ENGINE_PAR_SPEED,1000000-((19-1)*90909),$artic__sixteenths,-1,-1)
  set_engine_par($ENGINE_PAR_SPEED,1000000-((16-1)*90909),find_group("quarters releases"),-1,-1)
  set_engine_par($ENGINE_PAR_SPEED,1000000-((12-1)*90909),find_group("eighths releases"),-1,-1)
  declare $_other_clip_i80
  declare $_ticks_until_next_event80
  declare $_note80
  declare $_velocity80
  declare $_length80
  declare $_note_id82
  declare $_cc_num80
  declare $_other_clip_i79
  declare $_ticks_until_next_event79
  declare $_note79
  declare $_velocity79
  declare $_length79
  declare $_note_id81
  declare $_cc_num79
  declare $_other_clip_i78
  declare $_ticks_until_next_event78
  declare $_note78
  declare $_velocity78
  declare $_length78
  declare $_note_id80
  declare $_cc_num78
  declare $_other_clip_i77
  declare $_ticks_until_next_event77
  declare $_note77
  declare $_velocity77
  declare $_length77
  declare $_note_id79
  declare $_cc_num77
  declare $_other_clip_i76
  declare $_ticks_until_next_event76
  declare $_note76
  declare $_velocity76
  declare $_length76
  declare $_note_id78
  declare $_cc_num76
  declare $_other_clip_i75
  declare $_ticks_until_next_event75
  declare $_note75
  declare $_velocity75
  declare $_length75
  declare $_note_id77
  declare $_cc_num75
  declare $_other_clip_i74
  declare $_ticks_until_next_event74
  declare $_note74
  declare $_velocity74
  declare $_length74
  declare $_note_id76
  declare $_cc_num74
  declare $_other_clip_i73
  declare $_ticks_until_next_event73
  declare $_note73
  declare $_velocity73
  declare $_length73
  declare $_note_id75
  declare $_cc_num73
  declare $_other_clip_i72
  declare $_ticks_until_next_event72
  declare $_note72
  declare $_velocity72
  declare $_length72
  declare $_note_id74
  declare $_cc_num72
  declare $_other_clip_i71
  declare $_ticks_until_next_event71
  declare $_note71
  declare $_velocity71
  declare $_length71
  declare $_note_id73
  declare $_cc_num71
  declare $_other_clip_i70
  declare $_ticks_until_next_event70
  declare $_note70
  declare $_velocity70
  declare $_length70
  declare $_note_id72
  declare $_cc_num70
  declare $_other_clip_i69
  declare $_ticks_until_next_event69
  declare $_note69
  declare $_velocity69
  declare $_length69
  declare $_note_id71
  declare $_cc_num69
  declare $_other_clip_i68
  declare $_ticks_until_next_event68
  declare $_note68
  declare $_velocity68
  declare $_length68
  declare $_note_id70
  declare $_cc_num68
  declare $_other_clip_i67
  declare $_ticks_until_next_event67
  declare $_note67
  declare $_velocity67
  declare $_length67
  declare $_note_id69
  declare $_cc_num67
  declare $_other_clip_i66
  declare $_ticks_until_next_event66
  declare $_note66
  declare $_velocity66
  declare $_length66
  declare $_note_id68
  declare $_cc_num66
  declare $_other_clip_i65
  declare $_ticks_until_next_event65
  declare $_note65
  declare $_velocity65
  declare $_length65
  declare $_note_id67
  declare $_cc_num65
  declare $_other_clip_i64
  declare $_ticks_until_next_event64
  declare $_note64
  declare $_velocity64
  declare $_length64
  declare $_note_id66
  declare $_cc_num64
  declare $_other_clip_i63
  declare $_ticks_until_next_event63
  declare $_note63
  declare $_velocity63
  declare $_length63
  declare $_note_id65
  declare $_cc_num63
  declare $_other_clip_i62
  declare $_ticks_until_next_event62
  declare $_note62
  declare $_velocity62
  declare $_length62
  declare $_note_id64
  declare $_cc_num62
  declare $_other_clip_i61
  declare $_ticks_until_next_event61
  declare $_note61
  declare $_velocity61
  declare $_length61
  declare $_note_id63
  declare $_cc_num61
  declare $_other_clip_i60
  declare $_ticks_until_next_event60
  declare $_note60
  declare $_velocity60
  declare $_length60
  declare $_note_id62
  declare $_cc_num60
  declare $_other_clip_i59
  declare $_ticks_until_next_event59
  declare $_note59
  declare $_velocity59
  declare $_length59
  declare $_note_id61
  declare $_cc_num59
  declare $_other_clip_i58
  declare $_ticks_until_next_event58
  declare $_note58
  declare $_velocity58
  declare $_length58
  declare $_note_id60
  declare $_cc_num58
  declare $_other_clip_i57
  declare $_ticks_until_next_event57
  declare $_note57
  declare $_velocity57
  declare $_length57
  declare $_note_id59
  declare $_cc_num57
  declare $_other_clip_i56
  declare $_ticks_until_next_event56
  declare $_note56
  declare $_velocity56
  declare $_length56
  declare $_note_id58
  declare $_cc_num56
  declare $_other_clip_i55
  declare $_ticks_until_next_event55
  declare $_note55
  declare $_velocity55
  declare $_length55
  declare $_note_id57
  declare $_cc_num55
  declare $_other_clip_i54
  declare $_ticks_until_next_event54
  declare $_note54
  declare $_velocity54
  declare $_length54
  declare $_note_id56
  declare $_cc_num54
  declare $_other_clip_i53
  declare $_ticks_until_next_event53
  declare $_note53
  declare $_velocity53
  declare $_length53
  declare $_note_id55
  declare $_cc_num53
  declare $_other_clip_i52
  declare $_ticks_until_next_event52
  declare $_note52
  declare $_velocity52
  declare $_length52
  declare $_note_id54
  declare $_cc_num52
  declare $_other_clip_i51
  declare $_ticks_until_next_event51
  declare $_note51
  declare $_velocity51
  declare $_length51
  declare $_note_id53
  declare $_cc_num51
  declare $_other_clip_i50
  declare $_ticks_until_next_event50
  declare $_note50
  declare $_velocity50
  declare $_length50
  declare $_note_id52
  declare $_cc_num50
  declare $_other_clip_i49
  declare $_ticks_until_next_event49
  declare $_note49
  declare $_velocity49
  declare $_length49
  declare $_note_id51
  declare $_cc_num49
  declare $_other_clip_i48
  declare $_ticks_until_next_event48
  declare $_note48
  declare $_velocity48
  declare $_length48
  declare $_note_id50
  declare $_cc_num48
  declare $_other_clip_i47
  declare $_ticks_until_next_event47
  declare $_note47
  declare $_velocity47
  declare $_length47
  declare $_note_id49
  declare $_cc_num47
  declare $_other_clip_i46
  declare $_ticks_until_next_event46
  declare $_note46
  declare $_velocity46
  declare $_length46
  declare $_note_id48
  declare $_cc_num46
  declare $_other_clip_i45
  declare $_ticks_until_next_event45
  declare $_note45
  declare $_velocity45
  declare $_length45
  declare $_note_id47
  declare $_cc_num45
  declare $_other_clip_i44
  declare $_ticks_until_next_event44
  declare $_note44
  declare $_velocity44
  declare $_length44
  declare $_note_id46
  declare $_cc_num44
  declare $_other_clip_i43
  declare $_ticks_until_next_event43
  declare $_note43
  declare $_velocity43
  declare $_length43
  declare $_note_id45
  declare $_cc_num43
  declare $_other_clip_i42
  declare $_ticks_until_next_event42
  declare $_note42
  declare $_velocity42
  declare $_length42
  declare $_note_id44
  declare $_cc_num42
  declare $_other_clip_i41
  declare $_ticks_until_next_event41
  declare $_note41
  declare $_velocity41
  declare $_length41
  declare $_note_id43
  declare $_cc_num41
  declare $_other_clip_i40
  declare $_ticks_until_next_event40
  declare $_note40
  declare $_velocity40
  declare $_length40
  declare $_note_id42
  declare $_cc_num40
  declare $_other_clip_i39
  declare $_ticks_until_next_event39
  declare $_note39
  declare $_velocity39
  declare $_length39
  declare $_note_id41
  declare $_cc_num39
  declare $_other_clip_i38
  declare $_ticks_until_next_event38
  declare $_note38
  declare $_velocity38
  declare $_length38
  declare $_note_id40
  declare $_cc_num38
  declare $_other_clip_i37
  declare $_ticks_until_next_event37
  declare $_note37
  declare $_velocity37
  declare $_length37
  declare $_note_id39
  declare $_cc_num37
  declare $_other_clip_i36
  declare $_ticks_until_next_event36
  declare $_note36
  declare $_velocity36
  declare $_length36
  declare $_note_id38
  declare $_cc_num36
  declare $_other_clip_i35
  declare $_ticks_until_next_event35
  declare $_note35
  declare $_velocity35
  declare $_length35
  declare $_note_id37
  declare $_cc_num35
  declare $_other_clip_i34
  declare $_ticks_until_next_event34
  declare $_note34
  declare $_velocity34
  declare $_length34
  declare $_note_id36
  declare $_cc_num34
  declare $_other_clip_i33
  declare $_ticks_until_next_event33
  declare $_note33
  declare $_velocity33
  declare $_length33
  declare $_note_id35
  declare $_cc_num33
  declare $_other_clip_i32
  declare $_ticks_until_next_event32
  declare $_note32
  declare $_velocity32
  declare $_length32
  declare $_note_id34
  declare $_cc_num32
  declare $_other_clip_i31
  declare $_ticks_until_next_event31
  declare $_note31
  declare $_velocity31
  declare $_length31
  declare $_note_id33
  declare $_cc_num31
  declare $_other_clip_i30
  declare $_ticks_until_next_event30
  declare $_note30
  declare $_velocity30
  declare $_length30
  declare $_note_id32
  declare $_cc_num30
  declare $_other_clip_i29
  declare $_ticks_until_next_event29
  declare $_note29
  declare $_velocity29
  declare $_length29
  declare $_note_id31
  declare $_cc_num29
  declare $_other_clip_i28
  declare $_ticks_until_next_event28
  declare $_note28
  declare $_velocity28
  declare $_length28
  declare $_note_id30
  declare $_cc_num28
  declare $_other_clip_i27
  declare $_ticks_until_next_event27
  declare $_note27
  declare $_velocity27
  declare $_length27
  declare $_note_id29
  declare $_cc_num27
  declare $_other_clip_i26
  declare $_ticks_until_next_event26
  declare $_note26
  declare $_velocity26
  declare $_length26
  declare $_note_id28
  declare $_cc_num26
  declare $_other_clip_i25
  declare $_ticks_until_next_event25
  declare $_note25
  declare $_velocity25
  declare $_length25
  declare $_note_id27
  declare $_cc_num25
  declare $_other_clip_i24
  declare $_ticks_until_next_event24
  declare $_note24
  declare $_velocity24
  declare $_length24
  declare $_note_id26
  declare $_cc_num24
  declare $_other_clip_i23
  declare $_ticks_until_next_event23
  declare $_note23
  declare $_velocity23
  declare $_length23
  declare $_note_id25
  declare $_cc_num23
  declare $_other_clip_i22
  declare $_ticks_until_next_event22
  declare $_note22
  declare $_velocity22
  declare $_length22
  declare $_note_id24
  declare $_cc_num22
  declare $_other_clip_i21
  declare $_ticks_until_next_event21
  declare $_note21
  declare $_velocity21
  declare $_length21
  declare $_note_id23
  declare $_cc_num21
  declare $_other_clip_i20
  declare $_ticks_until_next_event20
  declare $_note20
  declare $_velocity20
  declare $_length20
  declare $_note_id22
  declare $_cc_num20
  declare $_other_clip_i19
  declare $_ticks_until_next_event19
  declare $_note19
  declare $_velocity19
  declare $_length19
  declare $_note_id21
  declare $_cc_num19
  declare $_other_clip_i18
  declare $_ticks_until_next_event18
  declare $_note18
  declare $_velocity18
  declare $_length18
  declare $_note_id20
  declare $_cc_num18
  declare $_other_clip_i17
  declare $_ticks_until_next_event17
  declare $_note17
  declare $_velocity17
  declare $_length17
  declare $_note_id19
  declare $_cc_num17
  declare $_other_clip_i16
  declare $_ticks_until_next_event16
  declare $_note16
  declare $_velocity16
  declare $_length16
  declare $_note_id18
  declare $_cc_num16
  declare $_other_clip_i15
  declare $_ticks_until_next_event15
  declare $_note15
  declare $_velocity15
  declare $_length15
  declare $_note_id17
  declare $_cc_num15
  declare $_other_clip_i14
  declare $_ticks_until_next_event14
  declare $_note14
  declare $_velocity14
  declare $_length14
  declare $_note_id16
  declare $_cc_num14
  declare $_other_clip_i13
  declare $_ticks_until_next_event13
  declare $_note13
  declare $_velocity13
  declare $_length13
  declare $_note_id15
  declare $_cc_num13
  declare $_other_clip_i12
  declare $_ticks_until_next_event12
  declare $_note12
  declare $_velocity12
  declare $_length12
  declare $_note_id14
  declare $_cc_num12
  declare $_other_clip_i11
  declare $_ticks_until_next_event11
  declare $_note11
  declare $_velocity11
  declare $_length11
  declare $_note_id13
  declare $_cc_num11
  declare $_other_clip_i10
  declare $_ticks_until_next_event10
  declare $_note10
  declare $_velocity10
  declare $_length10
  declare $_note_id12
  declare $_cc_num10
  declare $_other_clip_i9
  declare $_ticks_until_next_event9
  declare $_note9
  declare $_velocity9
  declare $_length9
  declare $_note_id11
  declare $_cc_num9
  declare $_other_clip_i8
  declare $_ticks_until_next_event8
  declare $_note8
  declare $_velocity8
  declare $_length8
  declare $_note_id10
  declare $_cc_num8
  declare $_other_clip_i7
  declare $_ticks_until_next_event7
  declare $_note7
  declare $_velocity7
  declare $_length7
  declare $_note_id9
  declare $_cc_num7
  declare $_other_clip_i6
  declare $_ticks_until_next_event6
  declare $_note6
  declare $_velocity6
  declare $_length6
  declare $_note_id8
  declare $_cc_num6
  declare $_other_clip_i5
  declare $_ticks_until_next_event5
  declare $_note5
  declare $_velocity5
  declare $_length5
  declare $_note_id7
  declare $_cc_num5
  declare $_other_clip_i4
  declare $_ticks_until_next_event4
  declare $_note4
  declare $_velocity4
  declare $_length4
  declare $_note_id6
  declare $_cc_num4
  declare $_other_clip_i3
  declare $_ticks_until_next_event3
  declare $_note3
  declare $_velocity3
  declare $_length3
  declare $_note_id5
  declare $_cc_num3
  declare $_other_clip_i2
  declare $_ticks_until_next_event2
  declare $_note2
  declare $_velocity2
  declare $_length2
  declare $_note_id4
  declare $_cc_num2
  declare $_other_clip_i
  declare $_ticks_until_next_event
  declare $_note
  declare $_velocity
  declare $_length
  declare $_note_id3
  declare $_cc_num
  declare %_event_ids[128]
  declare $_e
  declare $_prev_cc64
  declare $_r5
  declare $_artic4
  declare $_offset_rec_time4
  declare $_rec_time_play_pos
  declare $_rec_time_pos_in_ripple
  declare $_time_til_end_of_ripple2
  declare $_play_release_sample
  declare $_triggered_by_keyswitch := 0
  declare $_fade_out_time
  declare $_rls_note
  declare $_prev_rls_note_rec_time
  declare $_vol
  declare $_offset := 0
  declare $_cur_ripple
  declare $_vel
  declare $_history_index
  declare $_ks_index
  declare %_notes[32]
  declare %_intervals[32]
  declare %_played_notes[32]
  declare %_played_intervals[32]
  declare %__notes[32]
  declare %__intervals[32]
  declare $_num_ripples := 0
  declare $_closest_neighbor := -1
  declare $_closest_neighbor_interval := 12
  declare %_neighbor[32]
  declare %_lower_neighbor[32]
  declare %_upper_neighbor[32]
  declare $_num_neighbors := 0
  declare $_num_lower_neighbors := 0
  declare $_num_upper_neighbors := 0
  declare $_dir
  declare $_sign
  declare $_other_note
  declare $_lower_neighbor_time_held
  declare $_upper_neighbor_time_held
  declare $_make_ripples_to_both_adjacent_neighbors
  declare $_low_note2
  declare $_high_note2
  declare $_origin_note2
  declare $_dest_note
  declare $_first_note
  declare $_second_note
  declare $_real_ripple_length
  declare $_real_pitch_length
  declare $_real_sample_length
  declare $_do_legato
  declare $_offset_real_time
  declare $_offset_rec_time3
  declare $_real_legato_time
  declare $_latency_real_time
  declare $_vel_offset
  declare $_already_playing := 0
  declare $_note_id2
  declare $_volume
  declare $_fade_in_time := 0
  declare $_real_pos_in_ripple
  declare $_time_til_end_of_ripple
  declare $_real_pos_in_pitch
  declare $_time_til_end_of_pitch
  declare $_time_played
  declare $_clip_length_ms
  declare $_key_i3
  declare $_r4
  declare $_artic3
  declare $_latency2
  declare $_offset_rec_time2
  declare $_sample_start2
  declare $_release_dynamic
  declare $_release_sample_length
  declare $_origin_note
  declare $_r3
  declare $_artic2
  declare $_pos_in_swell2
  declare $_sample_start
  declare $_note_id
  declare $_r2
  declare $_time_since_note_off2
  declare $_release_length
  declare $_brightness_when_released
  declare $_value
  declare $_artic
  declare $_latency
  declare $_offset_rec_time
  declare $__time_since_note_off2
  declare $__release_length
  declare $__brightness_when_released
  declare $__value
  declare $_low_note
  declare $_high_note
  declare $_direction
  declare $_interval
  declare $__artic
  declare ~_speed_curve
  declare ~_brightness_curve
  declare $_play_pos_in_beat
  declare ~_value_norm
  declare $_pos_in_swell
  declare $__pos_in_swell
  declare $_key_i2
  declare $_key_i
  declare $_index
  declare $_hist_i
  declare $_note_found := 0
  declare @_checkmark
  declare $_i
end on

function set_key_colors_and_types_and_names
  $key_i := 0
  while ($key_i<=127)
    set_key_type($key_i,$NI_KEY_TYPE_NONE)
    set_key_name($key_i,"")
    $_index := search(%articulation_keyswitches,$key_i)
    if ($_index # -1)
      set_key_color($key_i,$KEY_COLOR_RED)
      set_key_name($key_i,!articulation_texts[$_index])
      set_key_type($key_i,$NI_KEY_TYPE_CONTROL)
    end if
    if (in_range($key_i,$LOWEST_KEY,$HIGHEST_KEY))
      set_key_color($key_i,$KEY_COLOR_DEFAULT)
      set_key_type($key_i,$NI_KEY_TYPE_DEFAULT)
    end if
    $_index := search(%speed_keyswitches,$key_i)
    if ($_index # -1)
      set_key_color($key_i,$KEY_COLOR_GREEN)
      set_key_name($key_i,!speed_texts[$_index])
      set_key_type($key_i,$NI_KEY_TYPE_CONTROL)
    end if
    $_index := search(%direction_keyswitches,$key_i)
    if ($_index # -1)
      set_key_color($key_i,$KEY_COLOR_YELLOW)
      set_key_name($key_i,!direction_texts[$_index])
      set_key_type($key_i,$NI_KEY_TYPE_CONTROL)
    end if
    $_index := search(%legato_keyswitches,$key_i)
    if ($_index # -1)
      set_key_color($key_i,$KEY_COLOR_PURPLE)
      set_key_name($key_i,!legato_texts[$_index])
      set_key_type($key_i,$NI_KEY_TYPE_CONTROL)
    end if
    $_index := search(%release_sample_keyswitches,$key_i)
    if ($_index # -1)
      set_key_color($key_i,$KEY_COLOR_ORANGE)
      set_key_name($key_i,!releaseSamples_texts[$_index])
      set_key_type($key_i,$NI_KEY_TYPE_CONTROL)
    end if
    $_index := search(%vel_to_start_keyswitches,$key_i)
    if ($_index # -1)
      set_key_color($key_i,$KEY_COLOR_BLUE)
      set_key_name($key_i,!vel_to_start_texts[$_index])
      set_key_type($key_i,$NI_KEY_TYPE_CONTROL)
    end if
    $_index := search(%release_trigger_keyswitches,$key_i)
    if ($_index # -1)
      set_key_color($key_i,$KEY_COLOR_RED)
      set_key_name($key_i,"Release Trigger Key")
      set_key_type($key_i,$NI_KEY_TYPE_CONTROL)
    end if
    inc($key_i)
  end while
end function

function crossfaded_looping
  $_r3 := 0
  while ($_r3<64)
    if (event_status(%ripple_id_history[$_r3])=$EVENT_STATUS_NOTE_QUEUE)
      $_artic2 := %custom_event_artic[%ripple_id_history[$_r3] mod 1000000]
      if (%custom_event_releasing[%ripple_id_history[$_r3] mod 1000000]=0)
        $_pos_in_swell2 := get_event_par(%ripple_id_history[$_r3],$EVENT_PAR_PLAY_POS)-(500*1000)
        if ($_pos_in_swell2>%rec_time_sample_lengths[$_artic2])
          fade_out(%ripple_id_history[$_r3],$DURATION_SIXTEENTH,1)
          $_sample_start := $_pos_in_swell2 mod %rec_time_sample_lengths[$_artic2]+(500*1000)
          if (%custom_event_preview_being_stopped[%ripple_id_history[$_r3] mod 1000000]=0)
            $_note_id := play_note(get_event_par(%ripple_id_history[$_r3],$EVENT_PAR_NOTE),get_event_par(%ripple_id_history[$_r3],$EVENT_PAR_VELOCITY),$_sample_start,0)
            set_event_par_arr($_note_id,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_event_par_arr($_note_id,$EVENT_PAR_ALLOW_GROUP,1,$_artic2)
            change_vol($_note_id,get_event_par(%ripple_id_history[$_r3],$EVENT_PAR_VOLUME),0)
            fade_in($_note_id,$DURATION_SIXTEENTH)
            %custom_event_active[$_note_id mod 1000000] := %custom_event_active[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_source[$_note_id mod 1000000] := %custom_event_source[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_note[$_note_id mod 1000000] := %custom_event_note[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_velocity[$_note_id mod 1000000] := %custom_event_velocity[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_low_note[$_note_id mod 1000000] := %custom_event_low_note[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_high_note[$_note_id mod 1000000] := %custom_event_high_note[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_origin_note[$_note_id mod 1000000] := %custom_event_origin_note[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_dest_note[$_note_id mod 1000000] := %custom_event_dest_note[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_first_note[$_note_id mod 1000000] := %custom_event_first_note[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_second_note[$_note_id mod 1000000] := %custom_event_second_note[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_direction[$_note_id mod 1000000] := %custom_event_direction[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_artic[$_note_id mod 1000000] := %custom_event_artic[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_voice[$_note_id mod 1000000] := %custom_event_voice[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_note_off_timestamp[$_note_id mod 1000000] := %custom_event_note_off_timestamp[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_marked_for_release[$_note_id mod 1000000] := %custom_event_marked_for_release[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_play_release_sample[$_note_id mod 1000000] := %custom_event_play_release_sample[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_release_length[$_note_id mod 1000000] := %custom_event_release_length[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_release_sample_length[$_note_id mod 1000000] := %custom_event_release_sample_length[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_release_note[$_note_id mod 1000000] := %custom_event_release_note[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_release_dynamic[$_note_id mod 1000000] := %custom_event_release_dynamic[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_brightness_when_released[$_note_id mod 1000000] := %custom_event_brightness_when_released[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_waiting_for_release_sample[$_note_id mod 1000000] := %custom_event_waiting_for_release_sample[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_fading_out_for_release_sample[$_note_id mod 1000000] := %custom_event_fading_out_for_release_sample[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_rls_sample_id[$_note_id mod 1000000] := %custom_event_rls_sample_id[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_crossfading[$_note_id mod 1000000] := %custom_event_crossfading[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_releasing[$_note_id mod 1000000] := %custom_event_releasing[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_triggered_by_mf[$_note_id mod 1000000] := %custom_event_triggered_by_mf[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_ripple_index[$_note_id mod 1000000] := %custom_event_ripple_index[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_preview_being_stopped[$_note_id mod 1000000] := %custom_event_preview_being_stopped[%ripple_id_history[$_r3] mod 1000000]
            %ripple_id_history[$_r3] := $_note_id
          end if
        end if
      end if
    end if
    inc($_r3)
  end while
end function

function fade_out_ripples_when_release_sample_sounds
  $_r4 := 0
  while ($_r4<64)
    if (event_status(%ripple_id_history[$_r4])=$EVENT_STATUS_NOTE_QUEUE)
      $_artic3 := %custom_event_artic[%ripple_id_history[$_r4] mod 1000000]
      $_latency2 := real_to_int(int_to_real(0)+((int_to_real(real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed]))-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
      $_offset_rec_time2 := (500-$_latency2)*1000
      if (get_event_par(%custom_event_rls_sample_id[%ripple_id_history[$_r4] mod 1000000],$EVENT_PAR_PLAY_POS)-$_offset_rec_time2>(%rec_time_ripple_lengths[$_artic3]+%stop_offset_rec_time[$_artic3]))
        if (%custom_event_fading_out_for_release_sample[%ripple_id_history[$_r4] mod 1000000]=0)
          fade_out(%ripple_id_history[$_r4],$DURATION_SIXTEENTH,1)
          %custom_event_fading_out_for_release_sample[%ripple_id_history[$_r4] mod 1000000] := 1
          %custom_event_releasing[%ripple_id_history[$_r4] mod 1000000] := 1
          $_release_dynamic := %custom_event_release_dynamic[%ripple_id_history[$_r4] mod 1000000]
          if ($_release_dynamic=$SHORT)
            $_sample_start2 := real_to_int(int_to_real(%rec_time_ripple_lengths[$_artic3])/3.5)
          else
            if ($_release_dynamic=$LONG)
              $_sample_start2 := 0
            end if
          end if
          $_release_sample_length := %rec_time_ripple_lengths[$_artic3]-$_sample_start2
          $_release_sample_length := real_to_int(int_to_real(0)+((int_to_real($_release_sample_length)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
          $_origin_note := %custom_event_origin_note[%ripple_id_history[$_r4] mod 1000000]
          %custom_event_brightness_when_released[%ripple_id_history[$_r4] mod 1000000] := get_control_par(%ripple_swell[$_r4],$CONTROL_PAR_VALUE)
          %custom_event_release_sample_length[%ripple_id_history[$_r4] mod 1000000] := $_release_sample_length
          %custom_event_note_off_timestamp[%ripple_id_history[$_r4] mod 1000000] := $ENGINE_UPTIME
        end if
      end if
    end if
    inc($_r4)
  end while
end function

function ripple_animations
  $_r2 := 0
  while ($_r2<64)
    if (%custom_event_play_release_sample[%ripple_id_history[$_r2] mod 1000000]=0)
      if (%custom_event_releasing[%ripple_id_history[$_r2] mod 1000000]=1)
        set_control_par(%ripple[$_r2],$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
        if (event_status(%ripple_id_history[$_r2])=$EVENT_STATUS_NOTE_QUEUE)
          $__time_since_note_off2 := $ENGINE_UPTIME-%custom_event_note_off_timestamp[%ripple_id_history[$_r2] mod 1000000]
          $__release_length := %custom_event_release_length[%ripple_id_history[$_r2] mod 1000000]/1000
          $__brightness_when_released := %custom_event_brightness_when_released[%ripple_id_history[$_r2] mod 1000000]
          if ($__release_length=0)
            $__release_length := 1
          end if
          if ($__brightness_when_released=0)
            $__brightness_when_released := 1
          end if
          $__value := real_to_int(int_to_real($__brightness_when_released)+((int_to_real($__time_since_note_off2)-int_to_real(0))/(int_to_real($__release_length)-int_to_real(0))*(int_to_real(0)-int_to_real($__brightness_when_released))))
          if ($__value>0)
            if ($__time_since_note_off2>0)
              set_control_par(%ripple_swell[$_r2],$CONTROL_PAR_VALUE,$__value)
            end if
          end if
        else
          set_control_par(%ripple_swell[$_r2],$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
        end if
      end if
      if (%custom_event_releasing[%ripple_id_history[$_r2] mod 1000000]=0 or (event_status(%ripple_id_history[$_r2])=$EVENT_STATUS_INACTIVE))
        set_control_par(%ripple_swell[$_r2],$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
        set_control_par(%ripple[$_r2],$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
      end if
    else
      if (%custom_event_play_release_sample[%ripple_id_history[$_r2] mod 1000000]=1)
        if (event_status(%ripple_id_history[$_r2])=$EVENT_STATUS_NOTE_QUEUE or (event_status(%custom_event_rls_sample_id[%ripple_id_history[$_r2] mod 1000000])=$EVENT_STATUS_NOTE_QUEUE))
          $__artic := %custom_event_artic[%ripple_id_history[$_r2] mod 1000000]
          $_latency := real_to_int(int_to_real(0)+((int_to_real(real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed]))-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
          $_offset_rec_time := (500-$_latency)*1000
          if (get_event_par(%custom_event_rls_sample_id[%ripple_id_history[$_r2] mod 1000000],$EVENT_PAR_PLAY_POS)-$_offset_rec_time>(%rec_time_ripple_lengths[$__artic]+%stop_offset_rec_time[$__artic]))
            set_control_par(%ripple[$_r2],$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
            $__time_since_note_off2 := $ENGINE_UPTIME-%custom_event_note_off_timestamp[%ripple_id_history[$_r2] mod 1000000]
            $__release_length := %custom_event_release_sample_length[%ripple_id_history[$_r2] mod 1000000]/1000
            $__brightness_when_released := %custom_event_brightness_when_released[%ripple_id_history[$_r2] mod 1000000]
            if ($__release_length=0)
              $__release_length := 1
            end if
            if ($__brightness_when_released=0)
              $__brightness_when_released := 1
            end if
            $__value := real_to_int(int_to_real($__brightness_when_released)+((int_to_real($__time_since_note_off2)-int_to_real(0))/(int_to_real($__release_length)-int_to_real(0))*(int_to_real(0)-int_to_real($__brightness_when_released))))
            if ($__value>0)
              if ($__time_since_note_off2>0)
                set_control_par(%ripple_swell[$_r2],$CONTROL_PAR_VALUE,$__value)
              end if
            else
              set_control_par(%ripple_swell[$_r2],$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
            end if
          end if
        else
          set_control_par(%ripple[$_r2],$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
          set_control_par(%ripple_swell[$_r2],$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
        end if
      end if
    end if
    inc($_r2)
  end while
  $_r2 := 64-1
  while ($_r2>=0)
    if (event_status(%ripple_id_history[$_r2])=$EVENT_STATUS_NOTE_QUEUE)
      if (%custom_event_releasing[%ripple_id_history[$_r2] mod 1000000]=0)
        $_low_note := %custom_event_low_note[%ripple_id_history[$_r2] mod 1000000]
        $_high_note := %custom_event_high_note[%ripple_id_history[$_r2] mod 1000000]
        $_direction := %custom_event_direction[%ripple_id_history[$_r2] mod 1000000]
        $_interval := ($_high_note-$_low_note)*($_direction*2-1)
        $__artic := %custom_event_artic[%ripple_id_history[$_r2] mod 1000000]
        if ($__artic=$artic__quarters)
          ~_speed_curve := 1.0
          ~_brightness_curve := 5.0
        else
          if ($__artic=$artic__eighths)
            ~_speed_curve := 1.5
            ~_brightness_curve := 2.0
          else
            if ($__artic=$artic__sixteenths)
              ~_speed_curve := 0.75
              ~_brightness_curve := 2.0
            end if
          end if
        end if
        set_control_par(%ripple[$_r2],$CONTROL_PAR_POS_X,get_control_par(get_ui_id($panel_keyboard),$CONTROL_PAR_POS_X)+get_control_par(%key_ids[$_low_note],$CONTROL_PAR_POS_X)+(get_control_par(%key_ids[$_low_note],$CONTROL_PAR_WIDTH)/2))
        if ($_interval<0)
          set_control_par(%ripple[$_r2],$CONTROL_PAR_POS_Y,get_control_par(get_ui_id($panel_keyboard),$CONTROL_PAR_POS_Y)-((22*abs($_interval)+1)/2)-1)
        else
          set_control_par(%ripple[$_r2],$CONTROL_PAR_POS_Y,get_control_par(get_ui_id($panel_keyboard),$CONTROL_PAR_POS_Y)+get_control_par(%key_ids[$LOWEST_KEY],$CONTROL_PAR_HEIGHT)-((22*abs($_interval)+1)/2))
        end if
        set_control_par_str(%ripple[$_r2],$CONTROL_PAR_PICTURE,"ripple " & $_interval)
        $_play_pos_in_beat := (get_event_par(%ripple_id_history[$_r2],$EVENT_PAR_PLAY_POS)-(500*1000)) mod %rec_time_ripple_lengths[$__artic]
        ~_value_norm := int_to_real($_play_pos_in_beat)/int_to_real(%rec_time_ripple_lengths[$__artic])
        if (~_value_norm<0.00001)
          ~_value_norm := 0.00001
        end if
        if ($__artic=$artic__sixteenths)
          ~_value_norm := pow(~_value_norm,0.6)
        else
          ~_value_norm := pow(~_value_norm,1.4)
        end if
        set_control_par(%ripple[$_r2],$CONTROL_PAR_VALUE,real_to_int(~_value_norm*127.0))
        set_control_par(%ripple[$_r2],$CONTROL_PAR_HIDE,$HIDE_PART_NOTHING)
        set_control_par(%ripple_swell[$_r2],$CONTROL_PAR_POS_X,get_control_par(%ripple[$_r2],$CONTROL_PAR_POS_X))
        set_control_par(%ripple_swell[$_r2],$CONTROL_PAR_POS_Y,get_control_par(%ripple[$_r2],$CONTROL_PAR_POS_Y))
        set_control_par_str(%ripple_swell[$_r2],$CONTROL_PAR_PICTURE,"ripple swell " & $_interval)
        $__pos_in_swell := get_event_par(%ripple_id_history[$_r2],$EVENT_PAR_PLAY_POS)-(500*1000)
        if ($__pos_in_swell<0)
          $__pos_in_swell := 0
        end if
        $__pos_in_swell := $__pos_in_swell mod %rec_time_sample_lengths[$__artic]
        if (in_range($__pos_in_swell,0,%rec_time_sample_lengths[$__artic]/2))
          set_control_par(%ripple_swell[$_r2],$CONTROL_PAR_VALUE,real_to_int(int_to_real(0)+((int_to_real($__pos_in_swell)-int_to_real(0))/(int_to_real(%rec_time_sample_lengths[$__artic]/2)-int_to_real(0))*(int_to_real(64)-int_to_real(0)))))
        else
          set_control_par(%ripple_swell[$_r2],$CONTROL_PAR_VALUE,real_to_int(int_to_real(64)+((int_to_real($__pos_in_swell)-int_to_real(%rec_time_sample_lengths[$__artic]/2))/(int_to_real(%rec_time_sample_lengths[$__artic])-int_to_real(%rec_time_sample_lengths[$__artic]/2))*(int_to_real(0)-int_to_real(64)))))
        end if
        set_control_par(%ripple_swell[$_r2],$CONTROL_PAR_HIDE,get_control_par(%ripple[$_r2],$CONTROL_PAR_HIDE))
        set_control_par(%ripple_swell[$_r2],$CONTROL_PAR_HIDE,$HIDE_PART_NOTHING)
        %custom_event_brightness_when_released[%ripple_id_history[$_r2] mod 1000000] := get_control_par(%ripple_swell[$_r2],$CONTROL_PAR_VALUE)
      end if
    end if
    dec($_r2)
  end while
end function

function midi_clip_play_cursors
  $clip_i := 0
  while ($clip_i<80)
    if (get_control_par(%midi_clip_preview_id[$clip_i],$CONTROL_PAR_VALUE)=1)
      $_time_played := $ENGINE_UPTIME-%time_started[$clip_i]
      $_clip_length_ms := ticks_to_ms(%clip_length[$clip_i])/1000
      set_control_par(%mf_cursor[$clip_i],$CONTROL_PAR_VALUE,real_to_int(int_to_real(0)+((int_to_real($_time_played)-int_to_real(0))/(int_to_real($_clip_length_ms)-int_to_real(0))*(int_to_real(1000)-int_to_real(0)))))
      set_control_par(%mf_cursor[$clip_i],$CONTROL_PAR_HIDE,$HIDE_PART_NOTHING)
    else
      set_control_par(%mf_cursor[$clip_i],$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
    end if
    inc($clip_i)
  end while
end function

function info_graphics_animation
  if ($PLAYED_VOICES_INST>0)
    ~midiInstructions_opacity := 0.0
  end if
  ~smoothed_midiInstructions_opacity := ~smoothed_midiInstructions_opacity+((~midiInstructions_opacity-~smoothed_midiInstructions_opacity)/30.0)
  if (~smoothed_midiInstructions_opacity<0.0001)
    ~smoothed_midiInstructions_opacity := 0.0
  end if
  set_control_par(get_ui_id($label_midiInstructions),$CONTROL_PAR_PICTURE_STATE,real_to_int(int_to_real(0)+((~smoothed_midiInstructions_opacity-0.0)/(1.0-0.0)*(int_to_real(127)-int_to_real(0)))))
  ~smoothed_midiCover_opacity := ~smoothed_midiCover_opacity+((~midiCover_opacity-~smoothed_midiCover_opacity)/4.0)
  if (~smoothed_midiCover_opacity<0.0001)
    ~smoothed_midiCover_opacity := 0.0
  end if
  set_control_par(get_ui_id($label_midiCover),$CONTROL_PAR_PICTURE_STATE,real_to_int(int_to_real(0)+((~smoothed_midiCover_opacity-0.0)/(1.0-0.0)*(int_to_real(127)-int_to_real(0)))))
end function

function hide_version
  if ($ENGINE_UPTIME-$timestamp_version_shown>1000)
    set_control_par(get_ui_id($label_version),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
  end if
end function

function unpress_all_keys
  $_key_i3 := $LOWEST_KEY
  while ($_key_i3<=$HIGHEST_KEY)
    set_key_pressed($_key_i3,0)
    inc($_key_i3)
  end while
end function

function deactivate_mf_notes
  get_event_ids(%_event_ids)
  $_e := 0
  while ($_e<num_elements(%_event_ids))
    if (%_event_ids[$_e] # 0)
      if (%custom_event_triggered_by_mf[%_event_ids[$_e] mod 1000000]>0)
        %custom_event_active[%_event_ids[$_e] mod 1000000] := 0
      end if
    end if
    inc($_e)
  end while
end function

function count_keys_active
  $num_keys_active := 0
  $_key_i := $LOWEST_KEY
  while ($_key_i<=$HIGHEST_KEY)
    if (%key_active[$_key_i]=1)
      inc($num_keys_active)
    end if
    inc($_key_i)
  end while
end function

function release_marked_ripples
  $_r5 := 0
  while ($_r5<64)
    if (event_status(%ripple_id_history[$_r5])=$EVENT_STATUS_NOTE_QUEUE and (%custom_event_marked_for_release[%ripple_id_history[$_r5] mod 1000000]=1))
      %custom_event_marked_for_release[%ripple_id_history[$_r5] mod 1000000] := 0
      $_artic4 := %custom_event_artic[%ripple_id_history[$_r5] mod 1000000]
      $latency := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
      $_offset_rec_time4 := real_to_int(int_to_real(0)+((int_to_real((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$latency)*1000)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
      $_rec_time_play_pos := get_event_par(%ripple_id_history[$_r5],$EVENT_PAR_PLAY_POS)-$_offset_rec_time4
      $_rec_time_pos_in_ripple := $_rec_time_play_pos mod %rec_time_ripple_lengths[$_artic4]
      $_time_til_end_of_ripple2 := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$_artic4]-$_rec_time_pos_in_ripple)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
      if ($slider_releaseSamples=0)
        $_play_release_sample := 0
      else
        if ($slider_releaseSamples>0)
          $_play_release_sample := 1
        end if
      end if
      $_triggered_by_keyswitch := 0
      if (%key_down[$recent_release_trigger_key]=1)
        $_play_release_sample := 1
        $_triggered_by_keyswitch := 1
      end if
      %custom_event_play_release_sample[%ripple_id_history[$_r5] mod 1000000] := $_play_release_sample
      if ($_play_release_sample=0)
        %custom_event_note_off_timestamp[%ripple_id_history[$_r5] mod 1000000] := $ENGINE_UPTIME
        %custom_event_releasing[%ripple_id_history[$_r5] mod 1000000] := 1
        $_fade_out_time := $_time_til_end_of_ripple2
        if ($_fade_out_time<30000)
          $_fade_out_time := 30000
        end if
        %custom_event_release_length[%ripple_id_history[$_r5] mod 1000000] := $_fade_out_time/5*4
        fade_out(%ripple_id_history[$_r5],$_fade_out_time,1)
      else
        if (%custom_event_waiting_for_release_sample[%ripple_id_history[$_r5] mod 1000000]=0)
          %custom_event_waiting_for_release_sample[%ripple_id_history[$_r5] mod 1000000] := 1
          $_rls_note := %custom_event_origin_note[%ripple_id_history[$_r5] mod 1000000]
          $_prev_rls_note_rec_time := real_to_int(int_to_real(0)+((int_to_real($ENGINE_UPTIME-%rls_note_timestamp[$_rls_note])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))*1000
          if (abs($_prev_rls_note_rec_time-($_rec_time_pos_in_ripple+$_offset_rec_time4))<5000)
            fade_out(%rls_note_ids[$_rls_note],50000,0)
          end if
          $_vol := get_event_par(%ripple_id_history[$_r5],$EVENT_PAR_VOLUME)
          $_offset := 0
          if ($_rec_time_play_pos-$_offset<(%rec_time_sample_lengths[$_artic4]/2))
            $_rec_time_play_pos := $_rec_time_play_pos-$_offset
            if ($_rec_time_play_pos<0)
              $_rec_time_play_pos := 0
            end if
          else
            $_rec_time_play_pos := $_rec_time_play_pos+$_offset
          end if
          if ($slider_releaseSamples=$releaseSampleMode__autoRelease)
            $_cur_ripple := $_rec_time_play_pos/%rec_time_ripple_lengths[$_artic4]
            if ($_cur_ripple>3)
              $_cur_ripple := 4-($_cur_ripple-3)
            end if
          else
            $_cur_ripple := $slider_releaseSamples-2
          end if
          if ($_triggered_by_keyswitch=1)
            $_cur_ripple := real_to_int(int_to_real(0)+((int_to_real(%velo[$recent_release_trigger_key])-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(4)-int_to_real(0))))
          end if
          if ($_cur_ripple<0)
            $_cur_ripple := 0
          end if
          if ($_cur_ripple>3)
            $_cur_ripple := 3
          end if
          $_vel := $_cur_ripple*32+1
          %rls_note_ids[$_rls_note] := play_note($_rls_note,$_vel,$_rec_time_pos_in_ripple+$_offset_rec_time4,0)
          %rls_note_timestamp[$_rls_note] := $ENGINE_UPTIME-real_to_int(int_to_real(0)+((int_to_real(($_rec_time_pos_in_ripple+$_offset_rec_time4)/1000)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
          set_event_par_arr(%rls_note_ids[$_rls_note],$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
          set_event_par_arr(%rls_note_ids[$_rls_note],$EVENT_PAR_ALLOW_GROUP,1,%release_group[$_artic4])
          %custom_event_active[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_active[%ripple_id_history[$_r5] mod 1000000]
          %custom_event_source[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_source[%ripple_id_history[$_r5] mod 1000000]
          %custom_event_note[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_note[%ripple_id_history[$_r5] mod 1000000]
          %custom_event_velocity[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_velocity[%ripple_id_history[$_r5] mod 1000000]
          %custom_event_low_note[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_low_note[%ripple_id_history[$_r5] mod 1000000]
          %custom_event_high_note[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_high_note[%ripple_id_history[$_r5] mod 1000000]
          %custom_event_origin_note[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_origin_note[%ripple_id_history[$_r5] mod 1000000]
          %custom_event_dest_note[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_dest_note[%ripple_id_history[$_r5] mod 1000000]
          %custom_event_first_note[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_first_note[%ripple_id_history[$_r5] mod 1000000]
          %custom_event_second_note[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_second_note[%ripple_id_history[$_r5] mod 1000000]
          %custom_event_direction[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_direction[%ripple_id_history[$_r5] mod 1000000]
          %custom_event_artic[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_artic[%ripple_id_history[$_r5] mod 1000000]
          %custom_event_voice[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_voice[%ripple_id_history[$_r5] mod 1000000]
          %custom_event_note_off_timestamp[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_note_off_timestamp[%ripple_id_history[$_r5] mod 1000000]
          %custom_event_marked_for_release[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_marked_for_release[%ripple_id_history[$_r5] mod 1000000]
          %custom_event_play_release_sample[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_play_release_sample[%ripple_id_history[$_r5] mod 1000000]
          %custom_event_release_length[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_release_length[%ripple_id_history[$_r5] mod 1000000]
          %custom_event_release_sample_length[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_release_sample_length[%ripple_id_history[$_r5] mod 1000000]
          %custom_event_release_note[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_release_note[%ripple_id_history[$_r5] mod 1000000]
          %custom_event_release_dynamic[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_release_dynamic[%ripple_id_history[$_r5] mod 1000000]
          %custom_event_brightness_when_released[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_brightness_when_released[%ripple_id_history[$_r5] mod 1000000]
          %custom_event_waiting_for_release_sample[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_waiting_for_release_sample[%ripple_id_history[$_r5] mod 1000000]
          %custom_event_fading_out_for_release_sample[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_fading_out_for_release_sample[%ripple_id_history[$_r5] mod 1000000]
          %custom_event_rls_sample_id[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_rls_sample_id[%ripple_id_history[$_r5] mod 1000000]
          %custom_event_crossfading[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_crossfading[%ripple_id_history[$_r5] mod 1000000]
          %custom_event_releasing[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_releasing[%ripple_id_history[$_r5] mod 1000000]
          %custom_event_triggered_by_mf[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_triggered_by_mf[%ripple_id_history[$_r5] mod 1000000]
          %custom_event_ripple_index[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_ripple_index[%ripple_id_history[$_r5] mod 1000000]
          %custom_event_preview_being_stopped[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_preview_being_stopped[%ripple_id_history[$_r5] mod 1000000]
          %custom_event_source[%rls_note_ids[$_rls_note] mod 1000000] := -1
          change_vol(%rls_note_ids[$_rls_note],get_event_par(%ripple_id_history[$_r5],$EVENT_PAR_VOLUME),0)
          %custom_event_rls_sample_id[%ripple_id_history[$_r5] mod 1000000] := %rls_note_ids[$_rls_note]
        end if
      end if
    end if
    inc($_r5)
  end while
  call count_keys_active
  if ($num_keys_active=0)
    $all_keys_inactive := 1
  end if
end function

function stop_all_clips_and_ripples
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  $r := 0
  while ($r<64)
    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
      %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
      %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
    end if
    inc($r)
  end while
  $key_i := $LOWEST_KEY
  while ($key_i<=$HIGHEST_KEY)
    set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
    %key_down[$key_i] := 0
    %key_active[$key_i] := 0
    inc($key_i)
  end while
  $clip_i := 0
  while ($clip_i<num_elements(%midi_clip_preview_id))
    set_control_par(%midi_clip_preview_id[$clip_i],$CONTROL_PAR_VALUE,0)
    if (%playing[$clip_i]=1)
      %playing[$clip_i] := 0
      %looping[$clip_i] := 0
    end if
    inc($clip_i)
  end while
  call deactivate_mf_notes
  call release_marked_ripples
end function

function update_latency_label
  set_control_par_str(get_ui_id($label_latency),$CONTROL_PAR_TEXT,$menu_latency & "ms")
end function

function set_reverb_menu_checkmark
  $_i := 0
  while ($_i<3)
    if ($_i=$menu_reverb)
      @_checkmark := " x "
    else
      @_checkmark := "    "
    end if
    set_menu_item_str(get_ui_id($menu_reverb),$_i,@_checkmark & !reverb_preset_names[$_i])
    inc($_i)
  end while
end function

function update_reverb_slider_picture
  if ($switch_reverbToggle=0)
    set_control_par_str(get_ui_id($slider_reverb),$CONTROL_PAR_PICTURE,"knob gray")
  else
    set_control_par_str(get_ui_id($slider_reverb),$CONTROL_PAR_PICTURE,"knob")
  end if
end function

function update_reverb_send_levels
  if (in_range($slider_reverb,0,500000))
    ~vol := 0.0+((int_to_real($slider_reverb)-int_to_real(0))/(int_to_real(500000)-int_to_real(0))*(0.5-0.0))
  else
    if (in_range($slider_reverb,500000,1000000))
      ~vol := 0.5+((int_to_real($slider_reverb)-int_to_real(500000))/(int_to_real(1000000)-int_to_real(500000))*(2.0-0.5))
    end if
  end if
  if (~vol<0.0000001)
    ~vol := 0.0000001
  end if
  ~db := 20.0*(log(~vol)/log(int_to_real(10)))
  set_engine_par($ENGINE_PAR_SENDLEVEL_0,-sh_right(abs($menu_reverb-0)-1,31)*-sh_right(abs($switch_reverbToggle-1)-1,31)*real_to_int(pow(2.0,(~db*1000.0+346768.2342478351)/18000.0)),-1,7,1)
  set_engine_par($ENGINE_PAR_SENDLEVEL_1,-sh_right(abs($menu_reverb-1)-1,31)*-sh_right(abs($switch_reverbToggle-1)-1,31)*real_to_int(pow(2.0,(~db*1000.0+346768.2342478351)/18000.0)),-1,7,1)
  set_engine_par($ENGINE_PAR_SENDLEVEL_2,-sh_right(abs($menu_reverb-2)-1,31)*-sh_right(abs($switch_reverbToggle-1)-1,31)*real_to_int(pow(2.0,(~db*1000.0+346768.2342478351)/18000.0)),-1,7,1)
  set_engine_par($ENGINE_PAR_SENDLEVEL_7,real_to_int(pow(2.0,(~db*1000.0+346768.2342478351)/18000.0)),-1,7,1)
end function

function update_engine_pars
  %p[$sp-4] := $fp
  $fp := $sp-4
  $sp := $fp
  %p[$fp+1] := %ctrl_ids[%p[$fp+3]]
  if (%p[$fp+1] # 0)
    %p[$fp+2] := get_control_par(%p[$fp+1],$CONTROL_PAR_VALUE)
  end if
  select (%p[$fp+3])
    case $control__vol
      if (in_range(%p[$fp+2],0,500000))
        set_engine_par($ENGINE_PAR_SEND_EFFECT_OUTPUT_GAIN,real_to_int(int_to_real(real_to_int(pow(2.0,(-16000.0-12000.0+346768.2342478351)/18000.0)))+((int_to_real(%p[$fp+2])-int_to_real(0))/(int_to_real(500000)-int_to_real(0))*(int_to_real(real_to_int(pow(2.0,(0.0-12000.0+346768.2342478351)/18000.0)))-int_to_real(real_to_int(pow(2.0,(-16000.0-12000.0+346768.2342478351)/18000.0)))))),-1,0,1)
      else
        if (in_range(%p[$fp+2],500000,1000000))
          set_engine_par($ENGINE_PAR_SEND_EFFECT_OUTPUT_GAIN,real_to_int(int_to_real(real_to_int(pow(2.0,(0.0-12000.0+346768.2342478351)/18000.0)))+((int_to_real(%p[$fp+2])-int_to_real(500000))/(int_to_real(1000000)-int_to_real(500000))*(int_to_real(real_to_int(pow(2.0,(8000.0-12000.0+346768.2342478351)/18000.0)))-int_to_real(real_to_int(pow(2.0,(0.0-12000.0+346768.2342478351)/18000.0)))))),-1,0,1)
        end if
      end if
      set_engine_par($ENGINE_PAR_SEQ_HF_GAIN,real_to_int(int_to_real(550000)+((int_to_real(%p[$fp+2])-int_to_real(0))/(int_to_real(1000000)-int_to_real(0))*(int_to_real(650000)-int_to_real(550000)))),-1,6,$NI_MAIN_BUS)
      set_engine_par($ENGINE_PAR_STEREO,real_to_int(int_to_real(400000)+((int_to_real(%p[$fp+2])-int_to_real(0))/(int_to_real(1000000)-int_to_real(0))*(int_to_real(600000)-int_to_real(400000)))),-1,7,$NI_MAIN_BUS)
    case $control__reverb
      call update_reverb_send_levels
    case $control__reverb_type
      call update_reverb_send_levels
    case $control__speed
      $g := 0
      while ($g<$NUM_GROUPS)
        if ($switch_halfSpeed=1)
          set_engine_par($ENGINE_PAR_SPEED_UNIT,$NI_SYNC_UNIT_QUARTER,$g,-1,-1)
        end if
        if ($switch_slowTripletSpeed=1)
          set_engine_par($ENGINE_PAR_SPEED_UNIT,$NI_SYNC_UNIT_QUARTER_TRIPLET,$g,-1,-1)
        end if
        if ($switch_fullSpeed=1)
          set_engine_par($ENGINE_PAR_SPEED_UNIT,$NI_SYNC_UNIT_8TH,$g,-1,-1)
        end if
        if ($switch_fastTripletSpeed=1)
          set_engine_par($ENGINE_PAR_SPEED_UNIT,$NI_SYNC_UNIT_8TH_TRIPLET,$g,-1,-1)
        end if
        if ($switch_doubleSpeed=1)
          set_engine_par($ENGINE_PAR_SPEED_UNIT,$NI_SYNC_UNIT_16TH,$g,-1,-1)
        end if
        inc($g)
      end while
  end select
  $sp := $fp
  $fp := %p[$fp]
  $sp := $sp+4
end function

function update_nks_label
  %p[$sp-4] := $fp
  $fp := $sp-4
  $sp := $fp
  %p[$fp+1] := %ctrl_ids[%p[$fp+3]]
  if (%p[$fp+1] # 0)
    %p[$fp+2] := get_control_par(%p[$fp+1],$CONTROL_PAR_VALUE)
  end if
  select (%p[$fp+3])
    case $control__vol
      set_control_par_str(%p[$fp+1],$CONTROL_PAR_LABEL,$slider_vol/10000 & " %")
    case $control__reverb
      set_control_par_str(%p[$fp+1],$CONTROL_PAR_LABEL,get_engine_par_disp($ENGINE_PAR_SENDLEVEL_7,-1,7,1) & " dB")
    case $control__speed to $control__releaseSamples
      set_control_par_str(%p[$fp+1],$CONTROL_PAR_LABEL,!_option_texts_shortened[10*%p[$fp+3]+%p[$fp+2]])
  end select
  $sp := $fp
  $fp := %p[$fp]
  $sp := $sp+4
end function

function update_midi_visibility
  set_control_par(get_ui_id($switch_closeMidi),$CONTROL_PAR_HIDE,%hide_states[$button_showMidi])
  set_control_par(get_ui_id($panel_midi),$CONTROL_PAR_HIDE,%hide_states[$button_showMidi])
  $i := 0
  while ($i<10)
    set_control_par(%panel_midiPg[$i],$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
    inc($i)
  end while
  set_control_par(%panel_midiPg[$cur_midi_page],$CONTROL_PAR_HIDE,%hide_states[$button_showMidi])
  set_control_par(get_ui_id($label_midiInstructions),$CONTROL_PAR_HIDE,%hide_states[$button_showMidi])
  ~midiInstructions_opacity := int_to_real($button_showMidi)
  ~midiCover_opacity := int_to_real($button_showMidi)
  set_control_par(get_ui_id($panel_articulations),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($panel_fx),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($panel_speed),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($slider_speed),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($panel_direction),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($slider_direction),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($panel_legato),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($slider_legato),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($panel_releaseSamples),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($slider_releaseSamples),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($button_generalInfo),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($button_optionsInfo),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
end function

function update_midi_page_chooser_switches
  $i := 0
  while ($i<10)
    if ($i=$cur_midi_page)
      set_control_par(%switch_midiPgChooser[$i],$CONTROL_PAR_VALUE,1)
    else
      set_control_par(%switch_midiPgChooser[$i],$CONTROL_PAR_VALUE,0)
    end if
    inc($i)
  end while
end function

function count_keys_down
  $num_keys_down := 0
  $_key_i2 := $LOWEST_KEY
  while ($_key_i2<=$HIGHEST_KEY)
    if (%key_down[$_key_i2]=1)
      inc($num_keys_down)
    end if
    inc($_key_i2)
  end while
end function

function update_articulation_switches
  $i := 0
  while ($i<num_elements(%articulation_ids))
    if ($i=$cur_artic)
      set_control_par(%articulation_ids[$i],$CONTROL_PAR_VALUE,1)
    else
      set_control_par(%articulation_ids[$i],$CONTROL_PAR_VALUE,0)
    end if
    inc($i)
  end while
end function

function update_speed_switches
  $i := 0
  while ($i<num_elements(%speed_ids))
    if ($i=$slider_speed)
      set_control_par(%speed_ids[$i],$CONTROL_PAR_VALUE,1)
    else
      set_control_par(%speed_ids[$i],$CONTROL_PAR_VALUE,0)
    end if
    inc($i)
  end while
end function

function update_direction_switches
  $i := 0
  while ($i<num_elements(%direction_ids))
    if ($i=$slider_direction)
      set_control_par(%direction_ids[$i],$CONTROL_PAR_VALUE,1)
    else
      set_control_par(%direction_ids[$i],$CONTROL_PAR_VALUE,0)
    end if
    inc($i)
  end while
end function

function update_legato_switches
  $i := 0
  while ($i<num_elements(%legato_ids))
    if ($i=$slider_legato)
      set_control_par(%legato_ids[$i],$CONTROL_PAR_VALUE,1)
    else
      set_control_par(%legato_ids[$i],$CONTROL_PAR_VALUE,0)
    end if
    inc($i)
  end while
end function

function update_releaseSamples_switches
  $i := 0
  while ($i<num_elements(%releaseSamples_ids))
    if ($i=$slider_releaseSamples)
      set_control_par(%releaseSamples_ids[$i],$CONTROL_PAR_VALUE,1)
    else
      set_control_par(%releaseSamples_ids[$i],$CONTROL_PAR_VALUE,0)
    end if
    inc($i)
  end while
end function

function set_keys_pressed
  $i := 0
  while ($i<3)
    if ($i=$cur_artic)
      set_key_pressed(%articulation_keyswitches[$i],1)
    else
      set_key_pressed(%articulation_keyswitches[$i],0)
    end if
    inc($i)
  end while
  $i := 0
  while ($i<5)
    if ($i=$slider_speed)
      set_key_pressed(%speed_keyswitches[$i],1)
    else
      set_key_pressed(%speed_keyswitches[$i],0)
    end if
    inc($i)
  end while
  $i := 0
  while ($i<3)
    if ($i=$slider_direction)
      set_key_pressed(%direction_keyswitches[$i],1)
    else
      set_key_pressed(%direction_keyswitches[$i],0)
    end if
    inc($i)
  end while
  $i := 0
  while ($i<4)
    if ($i=$slider_legato)
      set_key_pressed(%legato_keyswitches[$i],1)
    else
      set_key_pressed(%legato_keyswitches[$i],0)
    end if
    inc($i)
  end while
  $i := 0
  while ($i<6)
    if ($i=$slider_releaseSamples)
      set_key_pressed(%release_sample_keyswitches[$i],1)
    else
      set_key_pressed(%release_sample_keyswitches[$i],0)
    end if
    inc($i)
  end while
  $i := 0
  while ($i<=1)
    if ($i=$switch_velToSampleStart)
      set_key_pressed(%vel_to_start_keyswitches[$i],1)
    else
      set_key_pressed(%vel_to_start_keyswitches[$i],0)
    end if
    inc($i)
  end while
end function

on persistence_changed
  call set_key_colors_and_types_and_names
  call set_keys_pressed
  call set_reverb_menu_checkmark
  call update_reverb_slider_picture
  call update_midi_page_chooser_switches
  $i := 0
  while ($i<7)
    %p[$sp-1] := $i
    call update_nks_label
    %p[$sp-1] := $i
    call update_engine_pars
    inc($i)
  end while
end on

on note
  %custom_event_source[$EVENT_ID mod 1000000] := -1
  set_event_par_arr($EVENT_ID,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
  set_key_pressed($EVENT_NOTE,1)
  %key_down[$EVENT_NOTE] := 1
  %velo[$EVENT_NOTE] := $EVENT_VELOCITY
  $_ks_index := search(%articulation_keyswitches,$EVENT_NOTE)
  if ($_ks_index # -1)
    $cur_artic := $_ks_index
    call update_articulation_switches
  end if
  $_ks_index := search(%speed_keyswitches,$EVENT_NOTE)
  if ($_ks_index # -1)
    $slider_speed := $_ks_index
    call update_speed_switches
    %p[$sp-1] := $control__speed
    call update_engine_pars
    %p[$sp-1] := $control__speed
    call update_nks_label
  end if
  $_ks_index := search(%direction_keyswitches,$EVENT_NOTE)
  if ($_ks_index # -1)
    $slider_direction := $_ks_index
    call update_direction_switches
    %p[$sp-1] := $control__direction
    call update_nks_label
  end if
  $_ks_index := search(%legato_keyswitches,$EVENT_NOTE)
  if ($_ks_index # -1)
    $slider_legato := $_ks_index
    call update_legato_switches
    %p[$sp-1] := $control__legato
    call update_nks_label
  end if
  $_ks_index := search(%release_sample_keyswitches,$EVENT_NOTE)
  if ($_ks_index # -1)
    $slider_releaseSamples := $_ks_index
    call update_releaseSamples_switches
    %p[$sp-1] := $control__releaseSamples
    call update_nks_label
  end if
  $_ks_index := search(%vel_to_start_keyswitches,$EVENT_NOTE)
  if ($_ks_index # -1)
    $switch_velToSampleStart := $_ks_index
  end if
  $_ks_index := search(%release_trigger_keyswitches,$EVENT_NOTE)
  if ($_ks_index # -1)
    $recent_release_trigger_key := $EVENT_NOTE
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    call release_marked_ripples
  end if
  if (search(%all_keyswitches,$EVENT_NOTE) # -1)
    call set_keys_pressed
  end if
  if (in_range($EVENT_NOTE,$LOWEST_KEY,$HIGHEST_KEY))
    %key_active[$EVENT_NOTE] := 1
    %key_timestamp[$EVENT_NOTE] := $ENGINE_UPTIME
    set_control_par(%key_ids[$EVENT_NOTE],$CONTROL_PAR_PICTURE_STATE,1)
    $key_i := num_elements(%key_history)-2
    while ($key_i>=0)
      %key_history[$key_i+1] := %key_history[$key_i]
      dec($key_i)
    end while
    %key_history[0] := $EVENT_NOTE
    call count_keys_down
    if ($num_keys_down>1)
      $_num_ripples := 0
      $_closest_neighbor := -1
      $_closest_neighbor_interval := 12
      $array_i := 0
      while ($array_i<num_elements(%_neighbor))
        %_neighbor[$array_i] := 0
        inc($array_i)
      end while
      $array_i := 0
      while ($array_i<num_elements(%_lower_neighbor))
        %_lower_neighbor[$array_i] := 0
        inc($array_i)
      end while
      $array_i := 0
      while ($array_i<num_elements(%_upper_neighbor))
        %_upper_neighbor[$array_i] := 0
        inc($array_i)
      end while
      $_num_neighbors := 0
      $_num_lower_neighbors := 0
      $_num_upper_neighbors := 0
      $i := 1
      while ($i<=$MAX_INTERVAL)
        $_dir := 0
        while ($_dir<=1)
          $_sign := $_dir*2-1
          $_other_note := $EVENT_NOTE+($i*$_sign)
          if (%key_down[$_other_note]=1)
            %_neighbor[$_num_neighbors] := $_other_note
            inc($_num_neighbors)
            if ($_other_note<$EVENT_NOTE)
              %_lower_neighbor[$_num_lower_neighbors] := $_other_note
              inc($_num_lower_neighbors)
            end if
            if ($_other_note>$EVENT_NOTE)
              %_upper_neighbor[$_num_upper_neighbors] := $_other_note
              inc($_num_upper_neighbors)
            end if
          end if
          inc($_dir)
        end while
        inc($i)
      end while
      if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
        $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
        $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
        if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
          $_make_ripples_to_both_adjacent_neighbors := 1
        else
          $_make_ripples_to_both_adjacent_neighbors := 0
        end if
        if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
          $_make_ripples_to_both_adjacent_neighbors := 1
        end if
        if ($_make_ripples_to_both_adjacent_neighbors=1)
          %__notes[0] := %_lower_neighbor[0]
          %__intervals[0] := $EVENT_NOTE-%_lower_neighbor[0]
          %__notes[1] := %_upper_neighbor[0]
          %__intervals[1] := $EVENT_NOTE-%_upper_neighbor[0]
          $_num_ripples := 2
        else
          if ($_make_ripples_to_both_adjacent_neighbors=0)
            if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
              %__notes[0] := %_lower_neighbor[0]
              %__intervals[0] := $EVENT_NOTE-%_lower_neighbor[0]
            else
              %__notes[0] := %_upper_neighbor[0]
              %__intervals[0] := $EVENT_NOTE-%_upper_neighbor[0]
            end if
            $_num_ripples := 1
          end if
        end if
      else
        %__notes[0] := %key_history[1]
        %__intervals[0] := %key_history[0]-%key_history[1]
        $_num_ripples := 1
        if (abs(%__intervals[0])>$MAX_INTERVAL)
          if ($_num_neighbors>0)
            %__notes[0] := %_neighbor[0]
            %__intervals[0] := $EVENT_NOTE-%_neighbor[0]
            $_num_ripples := 1
          else
            $array_i := 0
            while ($array_i<num_elements(%__notes))
              %__notes[$array_i] := 0
              inc($array_i)
            end while
            $array_i := 0
            while ($array_i<num_elements(%__intervals))
              %__intervals[$array_i] := 0
              inc($array_i)
            end while
            $_num_ripples := 0
          end if
        end if
      end if
      $array_i := 0
      while ($array_i<num_elements(%__notes))
        %_played_notes[$array_i] := %__notes[$array_i]
        inc($array_i)
      end while
      $array_i := 0
      while ($array_i<num_elements(%__intervals))
        %_played_intervals[$array_i] := %__intervals[$array_i]
        inc($array_i)
      end while
      $ripple_i := 0
      while ($ripple_i<$_num_ripples)
        if ($slider_direction=$directionMode__UP)
          if (%__intervals[$ripple_i]<0)
            %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
            %__intervals[$ripple_i] := -%__intervals[$ripple_i]
          end if
        else
          if ($slider_direction=$directionMode__DOWN)
            if (%__intervals[$ripple_i]>0)
              %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
              %__intervals[$ripple_i] := -%__intervals[$ripple_i]
            end if
          end if
        end if
        if (%__intervals[$ripple_i]<0)
          $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
          $_high_note2 := %__notes[$ripple_i]
        else
          $_low_note2 := %__notes[$ripple_i]
          $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
        end if
        if (%__intervals[$ripple_i]>0)
          $direction := $UP
        else
          $direction := $DOWN
        end if
        $_origin_note2 := %__notes[$ripple_i]
        $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
        $_first_note := %_played_notes[$ripple_i]
        $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
        $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
        $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
        $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
        if ($all_keys_inactive=1)
          $_do_legato := 0
        else
          $_do_legato := 1
        end if
        $all_keys_inactive := 0
        if ($slider_legato=0)
          $_do_legato := 0
        end if
        if ($_do_legato=0)
          $first_ripple_timestamp := $ENGINE_UPTIME
          $_real_legato_time := 0
          $_offset_real_time := 0
        else
          $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
          select ($slider_legato)
            case $legatoMode__syncToPitch
              $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
              $_offset_real_time := $_real_legato_time mod $_real_pitch_length
              $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
            case $legatoMode__syncToRipple
              $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
              $_offset_real_time := $_real_legato_time mod $_real_ripple_length
              $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
            case $legatoMode__syncToSwell
              $_offset_real_time := $_real_legato_time mod $_real_sample_length
          end select
          if ($_offset_real_time<0)
            $_offset_real_time := 0
          end if
        end if
        $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
        $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
        $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
        if ($switch_velToSampleStart=1)
          $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
          $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
          $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
          $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
        end if
        $_already_playing := 0
        $r := 0
        while ($r<64)
          if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
            if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
              $_already_playing := 1
              %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
            end if
          end if
          inc($r)
        end while
        if ($_already_playing=0)
          $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
          if ($switch_velToSampleStart=0)
            $_volume := real_to_int(int_to_real(-7000)+((int_to_real($EVENT_VELOCITY)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
            change_vol($_note_id2,$_volume,0)
          end if
          set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
          set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
          %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
          %custom_event_note[$_note_id2 mod 1000000] := $EVENT_NOTE
          %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
          %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
          %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
          %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
          %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
          %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
          %custom_event_velocity[$_note_id2 mod 1000000] := $EVENT_VELOCITY
          %custom_event_direction[$_note_id2 mod 1000000] := $direction
          %custom_event_source[$_note_id2 mod 1000000] := -1
          %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$EVENT_ID mod 1000000]
          $r := 64-2
          while ($r>=0)
            %ripple_id_history[$r+1] := %ripple_id_history[$r]
            dec($r)
          end while
          %ripple_id_history[0] := $_note_id2
          $_fade_in_time := 0
          if ($_do_legato=0)
            $_fade_in_time := $menu_latency*1000
            if ($_fade_in_time=0)
              $_fade_in_time := 0
            end if
          else
            $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
            $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
            if ($cur_artic=$artic__sixteenths)
              if ($_real_pos_in_ripple<($_real_ripple_length/4))
                $_real_pitch_length := $_real_ripple_length/4
                $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
              else
                $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
              end if
            else
              $_real_pitch_length := $_real_ripple_length/2
              $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
              $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
            end if
            if (in_range($EVENT_VELOCITY,1,48))
              $_fade_in_time := $_time_til_end_of_ripple
            else
              if (in_range($EVENT_VELOCITY,49,96))
                $_fade_in_time := $_time_til_end_of_pitch
              else
                if (in_range($EVENT_VELOCITY,97,127))
                  $_fade_in_time := $_time_til_end_of_pitch/2
                end if
              end if
            end if
            if ($_fade_in_time<ticks_to_ms(192))
              $_fade_in_time := ticks_to_ms(192)
            end if
          end if
          fade_in($_note_id2,$_fade_in_time)
        end if
        inc($ripple_i)
      end while
    end if
  end if
end on

on release
  if (%custom_event_triggered_by_mf[$EVENT_ID mod 1000000]>0 and (%custom_event_active[$EVENT_ID mod 1000000]=0))
    $sksp_dummy := $sksp_dummy
    exit
  end if
  %key_down[$EVENT_NOTE] := 0
  if (search(%all_keyswitches,$EVENT_NOTE)=-1)
    set_key_pressed($EVENT_NOTE,0)
  end if
  if (in_range($EVENT_NOTE,$LOWEST_KEY,$HIGHEST_KEY) and (%custom_event_source[$EVENT_ID mod 1000000]=-1))
    set_control_par(%key_ids[$EVENT_NOTE],$CONTROL_PAR_PICTURE_STATE,0)
    $_note_found := 0
    $_hist_i := 0
    while ($_hist_i<num_elements(%key_history))
      if ($_note_found=0)
        if (%key_history[$_hist_i]=$EVENT_NOTE)
          $_note_found := 1
          $_history_index := $_hist_i
        end if
      end if
      inc($_hist_i)
    end while
    if ($_note_found=0)
      $_history_index := -1
    end if
    if ($_history_index>-1)
      $key_i := $_history_index
      while ($key_i<=(num_elements(%key_history)-2))
        %key_history[$key_i] := %key_history[$key_i+1]
        inc($key_i)
      end while
    end if
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        if ($EVENT_NOTE=%custom_event_second_note[%ripple_id_history[$r] mod 1000000])
          %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        end if
      end if
      inc($r)
    end while
    if (%CC[64]<10)
      %key_active[$EVENT_NOTE] := 0
      call release_marked_ripples
    end if
  end if
end on

on controller
  if ($CC_NUM=64)
    if (%CC[$CC_NUM]<10 and ($_prev_cc64>=10))
      $key_i := $LOWEST_KEY
      while ($key_i<=$HIGHEST_KEY)
        if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
          %key_active[$key_i] := 0
        end if
        inc($key_i)
      end while
      call release_marked_ripples
    end if
    $_prev_cc64 := %CC[$CC_NUM]
  end if
  if ($CC_NUM=1)
    if ($switch_releaseSamplesModwheelControl=1)
      $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$CC_NUM])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
      call update_releaseSamples_switches
      %p[$sp-1] := $control__releaseSamples
      call update_nks_label
      call set_keys_pressed
    end if
  end if
end on

on listener
  if ($NI_SIGNAL_TYPE=$NI_SIGNAL_TIMER_MS)
    call crossfaded_looping
    call fade_out_ripples_when_release_sample_sounds
    call ripple_animations
    call midi_clip_play_cursors
    call info_graphics_animation
    call hide_version
  end if
  if ($NI_SIGNAL_TYPE=$NI_SIGNAL_TRANSP_START)
  end if
  if ($NI_SIGNAL_TYPE=$NI_SIGNAL_TRANSP_STOP)
  end if
end on

on ui_control($button_showMidi)
  if ($button_showMidi=0)
    call stop_all_clips_and_ripples
  end if
  call update_midi_visibility
end on

on ui_control($switch_closeMidi)
  $button_showMidi := 0
  call stop_all_clips_and_ripples
  call update_midi_visibility
end on

on ui_control($switch_closeMidi2)
  $button_showMidi := 0
  call stop_all_clips_and_ripples
  call update_midi_visibility
end on

on ui_control($menu_latency)
  call update_latency_label
end on

on ui_control($switch_title)
  $button_showMidi := 0
  call update_midi_visibility
  if (get_control_par(get_ui_id($switch_titleInfoDisp),$CONTROL_PAR_HIDE)=$HIDE_WHOLE_CONTROL)
    set_control_par(get_ui_id($switch_titleInfoDisp),$CONTROL_PAR_HIDE,$HIDE_PART_NOTHING)
  else
    set_control_par(get_ui_id($switch_titleInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
  end if
end on

on ui_control($switch_titleInfoDisp)
  set_control_par(get_ui_id($switch_titleInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
end on

on ui_control($button_generalInfo)
  $button_showMidi := 0
  call update_midi_visibility
  if (get_control_par(get_ui_id($switch_generalInfoDisp),$CONTROL_PAR_HIDE)=$HIDE_WHOLE_CONTROL)
    set_control_par(get_ui_id($switch_generalInfoDisp),$CONTROL_PAR_HIDE,$HIDE_PART_NOTHING)
  else
    set_control_par(get_ui_id($switch_generalInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
  end if
end on

on ui_control($switch_generalInfoDisp)
  set_control_par(get_ui_id($switch_generalInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
end on

on ui_control($button_articulationsInfo)
  set_control_par(get_ui_id($switch_articulationsInfoDisp),$CONTROL_PAR_HIDE,$HIDE_PART_NOTHING)
end on

on ui_control($switch_articulationsInfoDisp)
  set_control_par(get_ui_id($switch_articulationsInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
end on

on ui_control($button_optionsInfo)
  $button_showMidi := 0
  call update_midi_visibility
  if (get_control_par(get_ui_id($switch_optionsInfoDisp),$CONTROL_PAR_HIDE)=$HIDE_WHOLE_CONTROL)
    set_control_par(get_ui_id($switch_optionsInfoDisp),$CONTROL_PAR_HIDE,$HIDE_PART_NOTHING)
  else
    set_control_par(get_ui_id($switch_optionsInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
  end if
end on

on ui_control($switch_optionsInfoDisp)
  set_control_par(get_ui_id($switch_optionsInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
end on

on ui_control($button_speedInfo)
  set_control_par(get_ui_id($switch_speedInfoDisp),$CONTROL_PAR_HIDE,$HIDE_PART_NOTHING)
end on

on ui_control($switch_speedInfoDisp)
  set_control_par(get_ui_id($switch_speedInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
end on

on ui_control($button_directionInfo)
  set_control_par(get_ui_id($switch_directionInfoDisp),$CONTROL_PAR_HIDE,$HIDE_PART_NOTHING)
end on

on ui_control($switch_directionInfoDisp)
  set_control_par(get_ui_id($switch_directionInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
end on

on ui_control($button_legatoInfo)
  set_control_par(get_ui_id($switch_legatoInfoDisp),$CONTROL_PAR_HIDE,$HIDE_PART_NOTHING)
end on

on ui_control($switch_legatoInfoDisp)
  set_control_par(get_ui_id($switch_legatoInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
end on

on ui_control($button_releaseSamplesInfo)
  set_control_par(get_ui_id($switch_releaseSamplesInfoDisp),$CONTROL_PAR_HIDE,$HIDE_PART_NOTHING)
end on

on ui_control($switch_releaseSamplesInfoDisp)
  set_control_par(get_ui_id($switch_releaseSamplesInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
end on

on ui_control($switch_prevMidiPg)
  $cur_midi_page := ($cur_midi_page+10+-1) mod 10
  call update_midi_visibility
  call update_midi_page_chooser_switches
end on

on ui_control($switch_nextMidiPg)
  $cur_midi_page := ($cur_midi_page+10+1) mod 10
  call update_midi_visibility
  call update_midi_page_chooser_switches
end on

on ui_control($slider_vol)
  %p[$sp-1] := $control__vol
  call update_engine_pars
  %p[$sp-1] := $control__vol
  call update_nks_label
  call set_keys_pressed
end on

on ui_control($menu_reverb)
  call set_reverb_menu_checkmark
  %p[$sp-1] := $control__reverb_type
  call update_engine_pars
end on

on ui_control($switch_reverbToggle)
  call update_reverb_slider_picture
  call update_reverb_send_levels
end on

on ui_control($slider_reverb)
  %p[$sp-1] := $control__reverb
  call update_engine_pars
  %p[$sp-1] := $control__reverb
  call update_nks_label
end on

on ui_control($slider_speed)
  call update_speed_switches
  %p[$sp-1] := $control__speed
  call update_engine_pars
  %p[$sp-1] := $control__speed
  call update_nks_label
  call set_keys_pressed
end on

on ui_control($slider_direction)
  call update_direction_switches
  %p[$sp-1] := $control__direction
  call update_nks_label
  call set_keys_pressed
end on

on ui_control($slider_legato)
  call update_legato_switches
  %p[$sp-1] := $control__legato
  call update_nks_label
  call set_keys_pressed
end on

on ui_control($switch_velToSampleStart)
  call set_keys_pressed
end on

on ui_control($slider_releaseSamples)
  call update_releaseSamples_switches
  %p[$sp-1] := $control__releaseSamples
  call update_nks_label
  call set_keys_pressed
end on

on ui_control($switch_logoAnimTrigger)
  set_control_par(get_ui_id($label_version),$CONTROL_PAR_HIDE,$HIDE_PART_NOTHING)
  $timestamp_version_shown := $ENGINE_UPTIME
  if ($slider_logoAnim=0)
    $slider_logoAnim := 0
    while ($slider_logoAnim<127)
      inc($slider_logoAnim)
      wait(5000)
    end while
    $slider_logoAnim := 0
  end if
end on

on ui_control($switch_midiPgChooser0)
  $cur_midi_page := 0
  call update_midi_visibility
  call update_midi_page_chooser_switches
end on

on ui_control($switch_midiPgChooser1)
  $cur_midi_page := 1
  call update_midi_visibility
  call update_midi_page_chooser_switches
end on

on ui_control($switch_midiPgChooser2)
  $cur_midi_page := 2
  call update_midi_visibility
  call update_midi_page_chooser_switches
end on

on ui_control($switch_midiPgChooser3)
  $cur_midi_page := 3
  call update_midi_visibility
  call update_midi_page_chooser_switches
end on

on ui_control($switch_midiPgChooser4)
  $cur_midi_page := 4
  call update_midi_visibility
  call update_midi_page_chooser_switches
end on

on ui_control($switch_midiPgChooser5)
  $cur_midi_page := 5
  call update_midi_visibility
  call update_midi_page_chooser_switches
end on

on ui_control($switch_midiPgChooser6)
  $cur_midi_page := 6
  call update_midi_visibility
  call update_midi_page_chooser_switches
end on

on ui_control($switch_midiPgChooser7)
  $cur_midi_page := 7
  call update_midi_visibility
  call update_midi_page_chooser_switches
end on

on ui_control($switch_midiPgChooser8)
  $cur_midi_page := 8
  call update_midi_visibility
  call update_midi_page_chooser_switches
end on

on ui_control($switch_midiPgChooser9)
  $cur_midi_page := 9
  call update_midi_visibility
  call update_midi_page_chooser_switches
end on

on ui_control(?xypad_clipTitle0)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle0),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[0]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle0),$CONTROL_PAR_CURSOR_PICTURE,"clip title 0",(%clip_info_cursor[0]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[0]<15)
      inc(%clip_info_cursor[0])
    end if
  end if
end on

on ui_control($switch_preview0)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[0] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[0],$CONTROL_PAR_VALUE)=0)
    %playing[0] := 0
    %looping[0] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i := 0
    while ($_other_clip_i<num_elements(%midi_clip_preview_id))
      if (0 # $_other_clip_i)
        set_control_par(%midi_clip_preview_id[$_other_clip_i],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i]=1)
          %playing[$_other_clip_i] := 0
          %looping[$_other_clip_i] := 0
        end if
      end if
      inc($_other_clip_i)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[0] := 1
    while (%looping[0]=1 and (%cb_id[0]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[0]=0)
        %looping[0] := 0
      end if
      if ($button_showMidi=0)
        %looping[0] := 0
      end if
      %cur_event[0] := 0
      %midi_file_pos_ticks[0] := 0
      %time_started[0] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[0] := 1
      while (%playing[0]=1 and (%cb_id[0]=$NI_CALLBACK_ID))
        if (%cur_event[0]=%num_midi_events[0])
          $_ticks_until_next_event := %clip_length[0]-%midi_file_pos_ticks[0]
        else
          $_ticks_until_next_event := %_midi_pos[1000*0+%cur_event[0]]-%midi_file_pos_ticks[0]
        end if
        if ($_ticks_until_next_event>0)
          wait(ticks_to_ms($_ticks_until_next_event))
        end if
        if (%cur_event[0]>%num_midi_events[0])
          %playing[0] := 0
        end if
        if ($button_showMidi=0)
          %playing[0] := 0
        end if
        if (%playing[0]=1 and (%cb_id[0]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[0] := %midi_file_pos_ticks[0]+$_ticks_until_next_event
          if (%_midi_command[1000*0+%cur_event[0]]=$MIDI_COMMAND_NOTE_ON)
            $_note := %_midi_byte_1[1000*0+%cur_event[0]]
            $_velocity := %_midi_byte_2[1000*0+%cur_event[0]]
            $_length := ticks_to_ms(%_midi_length[1000*0+%cur_event[0]])
            $_note_id3 := play_note($_note,$_velocity,0,$_length)
            %custom_event_triggered_by_mf[$_note_id3 mod 1000000] := 0+1
            %custom_event_active[$_note_id3 mod 1000000] := 1
            %custom_event_source[$_note_id3 mod 1000000] := -1
            set_event_par_arr($_note_id3,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note,1)
            %key_down[$_note] := 1
            %velo[$_note] := $_velocity
            $_ks_index := search(%articulation_keyswitches,$_note)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note] := 1
              %key_timestamp[$_note] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id3 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*0+%cur_event[0]]=$MIDI_COMMAND_CC)
            $_cc_num := %_midi_byte_1[1000*0+%cur_event[0]]
            set_controller($_cc_num,%_midi_byte_2[1000*0+%cur_event[0]])
            wait(1)
            if ($_cc_num=64)
              if (%CC[$_cc_num]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num]
            end if
            if ($_cc_num=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[0])
        end if
        if (%cur_event[0]>%num_midi_events[0])
          %playing[0] := 0
        end if
        if ($button_showMidi=0)
          %playing[0] := 0
        end if
      end while
    end while
    if (%cb_id[0]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[0],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle1)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle1),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[1]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle1),$CONTROL_PAR_CURSOR_PICTURE,"clip title 1",(%clip_info_cursor[1]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[1]<15)
      inc(%clip_info_cursor[1])
    end if
  end if
end on

on ui_control($switch_preview1)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[1] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[1],$CONTROL_PAR_VALUE)=0)
    %playing[1] := 0
    %looping[1] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i2 := 0
    while ($_other_clip_i2<num_elements(%midi_clip_preview_id))
      if (1 # $_other_clip_i2)
        set_control_par(%midi_clip_preview_id[$_other_clip_i2],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i2]=1)
          %playing[$_other_clip_i2] := 0
          %looping[$_other_clip_i2] := 0
        end if
      end if
      inc($_other_clip_i2)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[1] := 1
    while (%looping[1]=1 and (%cb_id[1]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[1]=0)
        %looping[1] := 0
      end if
      if ($button_showMidi=0)
        %looping[1] := 0
      end if
      %cur_event[1] := 0
      %midi_file_pos_ticks[1] := 0
      %time_started[1] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[1] := 1
      while (%playing[1]=1 and (%cb_id[1]=$NI_CALLBACK_ID))
        if (%cur_event[1]=%num_midi_events[1])
          $_ticks_until_next_event2 := %clip_length[1]-%midi_file_pos_ticks[1]
        else
          $_ticks_until_next_event2 := %_midi_pos[1000*1+%cur_event[1]]-%midi_file_pos_ticks[1]
        end if
        if ($_ticks_until_next_event2>0)
          wait(ticks_to_ms($_ticks_until_next_event2))
        end if
        if (%cur_event[1]>%num_midi_events[1])
          %playing[1] := 0
        end if
        if ($button_showMidi=0)
          %playing[1] := 0
        end if
        if (%playing[1]=1 and (%cb_id[1]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[1] := %midi_file_pos_ticks[1]+$_ticks_until_next_event2
          if (%_midi_command[1000*1+%cur_event[1]]=$MIDI_COMMAND_NOTE_ON)
            $_note2 := %_midi_byte_1[1000*1+%cur_event[1]]
            $_velocity2 := %_midi_byte_2[1000*1+%cur_event[1]]
            $_length2 := ticks_to_ms(%_midi_length[1000*1+%cur_event[1]])
            $_note_id4 := play_note($_note2,$_velocity2,0,$_length2)
            %custom_event_triggered_by_mf[$_note_id4 mod 1000000] := 1+1
            %custom_event_active[$_note_id4 mod 1000000] := 1
            %custom_event_source[$_note_id4 mod 1000000] := -1
            set_event_par_arr($_note_id4,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note2,1)
            %key_down[$_note2] := 1
            %velo[$_note2] := $_velocity2
            $_ks_index := search(%articulation_keyswitches,$_note2)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note2)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note2)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note2)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note2)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note2)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note2)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note2
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note2) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note2,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note2] := 1
              %key_timestamp[$_note2] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note2],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note2
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note2+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note2)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note2)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note2-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note2-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note2-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note2-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note2-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity2)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note2
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity2
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id4 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity2,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity2,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity2,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*1+%cur_event[1]]=$MIDI_COMMAND_CC)
            $_cc_num2 := %_midi_byte_1[1000*1+%cur_event[1]]
            set_controller($_cc_num2,%_midi_byte_2[1000*1+%cur_event[1]])
            wait(1)
            if ($_cc_num2=64)
              if (%CC[$_cc_num2]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num2]
            end if
            if ($_cc_num2=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num2])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[1])
        end if
        if (%cur_event[1]>%num_midi_events[1])
          %playing[1] := 0
        end if
        if ($button_showMidi=0)
          %playing[1] := 0
        end if
      end while
    end while
    if (%cb_id[1]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[1],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle2),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[2]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle2),$CONTROL_PAR_CURSOR_PICTURE,"clip title 2",(%clip_info_cursor[2]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[2]<15)
      inc(%clip_info_cursor[2])
    end if
  end if
end on

on ui_control($switch_preview2)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[2] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[2],$CONTROL_PAR_VALUE)=0)
    %playing[2] := 0
    %looping[2] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i3 := 0
    while ($_other_clip_i3<num_elements(%midi_clip_preview_id))
      if (2 # $_other_clip_i3)
        set_control_par(%midi_clip_preview_id[$_other_clip_i3],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i3]=1)
          %playing[$_other_clip_i3] := 0
          %looping[$_other_clip_i3] := 0
        end if
      end if
      inc($_other_clip_i3)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[2] := 1
    while (%looping[2]=1 and (%cb_id[2]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[2]=0)
        %looping[2] := 0
      end if
      if ($button_showMidi=0)
        %looping[2] := 0
      end if
      %cur_event[2] := 0
      %midi_file_pos_ticks[2] := 0
      %time_started[2] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[2] := 1
      while (%playing[2]=1 and (%cb_id[2]=$NI_CALLBACK_ID))
        if (%cur_event[2]=%num_midi_events[2])
          $_ticks_until_next_event3 := %clip_length[2]-%midi_file_pos_ticks[2]
        else
          $_ticks_until_next_event3 := %_midi_pos[1000*2+%cur_event[2]]-%midi_file_pos_ticks[2]
        end if
        if ($_ticks_until_next_event3>0)
          wait(ticks_to_ms($_ticks_until_next_event3))
        end if
        if (%cur_event[2]>%num_midi_events[2])
          %playing[2] := 0
        end if
        if ($button_showMidi=0)
          %playing[2] := 0
        end if
        if (%playing[2]=1 and (%cb_id[2]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[2] := %midi_file_pos_ticks[2]+$_ticks_until_next_event3
          if (%_midi_command[1000*2+%cur_event[2]]=$MIDI_COMMAND_NOTE_ON)
            $_note3 := %_midi_byte_1[1000*2+%cur_event[2]]
            $_velocity3 := %_midi_byte_2[1000*2+%cur_event[2]]
            $_length3 := ticks_to_ms(%_midi_length[1000*2+%cur_event[2]])
            $_note_id5 := play_note($_note3,$_velocity3,0,$_length3)
            %custom_event_triggered_by_mf[$_note_id5 mod 1000000] := 2+1
            %custom_event_active[$_note_id5 mod 1000000] := 1
            %custom_event_source[$_note_id5 mod 1000000] := -1
            set_event_par_arr($_note_id5,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note3,1)
            %key_down[$_note3] := 1
            %velo[$_note3] := $_velocity3
            $_ks_index := search(%articulation_keyswitches,$_note3)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note3)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note3)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note3)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note3)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note3)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note3)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note3
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note3) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note3,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note3] := 1
              %key_timestamp[$_note3] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note3],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note3
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note3+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note3)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note3)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note3-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note3-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note3-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note3-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note3-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity3)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note3
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity3
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id5 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity3,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity3,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity3,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*2+%cur_event[2]]=$MIDI_COMMAND_CC)
            $_cc_num3 := %_midi_byte_1[1000*2+%cur_event[2]]
            set_controller($_cc_num3,%_midi_byte_2[1000*2+%cur_event[2]])
            wait(1)
            if ($_cc_num3=64)
              if (%CC[$_cc_num3]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num3]
            end if
            if ($_cc_num3=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num3])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[2])
        end if
        if (%cur_event[2]>%num_midi_events[2])
          %playing[2] := 0
        end if
        if ($button_showMidi=0)
          %playing[2] := 0
        end if
      end while
    end while
    if (%cb_id[2]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[2],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle3)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle3),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[3]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle3),$CONTROL_PAR_CURSOR_PICTURE,"clip title 3",(%clip_info_cursor[3]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[3]<15)
      inc(%clip_info_cursor[3])
    end if
  end if
end on

on ui_control($switch_preview3)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[3] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[3],$CONTROL_PAR_VALUE)=0)
    %playing[3] := 0
    %looping[3] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i4 := 0
    while ($_other_clip_i4<num_elements(%midi_clip_preview_id))
      if (3 # $_other_clip_i4)
        set_control_par(%midi_clip_preview_id[$_other_clip_i4],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i4]=1)
          %playing[$_other_clip_i4] := 0
          %looping[$_other_clip_i4] := 0
        end if
      end if
      inc($_other_clip_i4)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[3] := 1
    while (%looping[3]=1 and (%cb_id[3]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[3]=0)
        %looping[3] := 0
      end if
      if ($button_showMidi=0)
        %looping[3] := 0
      end if
      %cur_event[3] := 0
      %midi_file_pos_ticks[3] := 0
      %time_started[3] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[3] := 1
      while (%playing[3]=1 and (%cb_id[3]=$NI_CALLBACK_ID))
        if (%cur_event[3]=%num_midi_events[3])
          $_ticks_until_next_event4 := %clip_length[3]-%midi_file_pos_ticks[3]
        else
          $_ticks_until_next_event4 := %_midi_pos[1000*3+%cur_event[3]]-%midi_file_pos_ticks[3]
        end if
        if ($_ticks_until_next_event4>0)
          wait(ticks_to_ms($_ticks_until_next_event4))
        end if
        if (%cur_event[3]>%num_midi_events[3])
          %playing[3] := 0
        end if
        if ($button_showMidi=0)
          %playing[3] := 0
        end if
        if (%playing[3]=1 and (%cb_id[3]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[3] := %midi_file_pos_ticks[3]+$_ticks_until_next_event4
          if (%_midi_command[1000*3+%cur_event[3]]=$MIDI_COMMAND_NOTE_ON)
            $_note4 := %_midi_byte_1[1000*3+%cur_event[3]]
            $_velocity4 := %_midi_byte_2[1000*3+%cur_event[3]]
            $_length4 := ticks_to_ms(%_midi_length[1000*3+%cur_event[3]])
            $_note_id6 := play_note($_note4,$_velocity4,0,$_length4)
            %custom_event_triggered_by_mf[$_note_id6 mod 1000000] := 3+1
            %custom_event_active[$_note_id6 mod 1000000] := 1
            %custom_event_source[$_note_id6 mod 1000000] := -1
            set_event_par_arr($_note_id6,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note4,1)
            %key_down[$_note4] := 1
            %velo[$_note4] := $_velocity4
            $_ks_index := search(%articulation_keyswitches,$_note4)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note4)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note4)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note4)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note4)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note4)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note4)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note4
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note4) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note4,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note4] := 1
              %key_timestamp[$_note4] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note4],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note4
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note4+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note4)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note4)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note4-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note4-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note4-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note4-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note4-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity4)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note4
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity4
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id6 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity4,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity4,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity4,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*3+%cur_event[3]]=$MIDI_COMMAND_CC)
            $_cc_num4 := %_midi_byte_1[1000*3+%cur_event[3]]
            set_controller($_cc_num4,%_midi_byte_2[1000*3+%cur_event[3]])
            wait(1)
            if ($_cc_num4=64)
              if (%CC[$_cc_num4]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num4]
            end if
            if ($_cc_num4=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num4])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[3])
        end if
        if (%cur_event[3]>%num_midi_events[3])
          %playing[3] := 0
        end if
        if ($button_showMidi=0)
          %playing[3] := 0
        end if
      end while
    end while
    if (%cb_id[3]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[3],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle4)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle4),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[4]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle4),$CONTROL_PAR_CURSOR_PICTURE,"clip title 4",(%clip_info_cursor[4]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[4]<15)
      inc(%clip_info_cursor[4])
    end if
  end if
end on

on ui_control($switch_preview4)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[4] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[4],$CONTROL_PAR_VALUE)=0)
    %playing[4] := 0
    %looping[4] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i5 := 0
    while ($_other_clip_i5<num_elements(%midi_clip_preview_id))
      if (4 # $_other_clip_i5)
        set_control_par(%midi_clip_preview_id[$_other_clip_i5],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i5]=1)
          %playing[$_other_clip_i5] := 0
          %looping[$_other_clip_i5] := 0
        end if
      end if
      inc($_other_clip_i5)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[4] := 1
    while (%looping[4]=1 and (%cb_id[4]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[4]=0)
        %looping[4] := 0
      end if
      if ($button_showMidi=0)
        %looping[4] := 0
      end if
      %cur_event[4] := 0
      %midi_file_pos_ticks[4] := 0
      %time_started[4] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[4] := 1
      while (%playing[4]=1 and (%cb_id[4]=$NI_CALLBACK_ID))
        if (%cur_event[4]=%num_midi_events[4])
          $_ticks_until_next_event5 := %clip_length[4]-%midi_file_pos_ticks[4]
        else
          $_ticks_until_next_event5 := %_midi_pos[1000*4+%cur_event[4]]-%midi_file_pos_ticks[4]
        end if
        if ($_ticks_until_next_event5>0)
          wait(ticks_to_ms($_ticks_until_next_event5))
        end if
        if (%cur_event[4]>%num_midi_events[4])
          %playing[4] := 0
        end if
        if ($button_showMidi=0)
          %playing[4] := 0
        end if
        if (%playing[4]=1 and (%cb_id[4]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[4] := %midi_file_pos_ticks[4]+$_ticks_until_next_event5
          if (%_midi_command[1000*4+%cur_event[4]]=$MIDI_COMMAND_NOTE_ON)
            $_note5 := %_midi_byte_1[1000*4+%cur_event[4]]
            $_velocity5 := %_midi_byte_2[1000*4+%cur_event[4]]
            $_length5 := ticks_to_ms(%_midi_length[1000*4+%cur_event[4]])
            $_note_id7 := play_note($_note5,$_velocity5,0,$_length5)
            %custom_event_triggered_by_mf[$_note_id7 mod 1000000] := 4+1
            %custom_event_active[$_note_id7 mod 1000000] := 1
            %custom_event_source[$_note_id7 mod 1000000] := -1
            set_event_par_arr($_note_id7,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note5,1)
            %key_down[$_note5] := 1
            %velo[$_note5] := $_velocity5
            $_ks_index := search(%articulation_keyswitches,$_note5)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note5)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note5)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note5)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note5)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note5)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note5)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note5
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note5) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note5,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note5] := 1
              %key_timestamp[$_note5] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note5],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note5
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note5+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note5)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note5)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note5-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note5-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note5-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note5-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note5-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity5)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note5
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity5
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id7 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity5,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity5,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity5,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*4+%cur_event[4]]=$MIDI_COMMAND_CC)
            $_cc_num5 := %_midi_byte_1[1000*4+%cur_event[4]]
            set_controller($_cc_num5,%_midi_byte_2[1000*4+%cur_event[4]])
            wait(1)
            if ($_cc_num5=64)
              if (%CC[$_cc_num5]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num5]
            end if
            if ($_cc_num5=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num5])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[4])
        end if
        if (%cur_event[4]>%num_midi_events[4])
          %playing[4] := 0
        end if
        if ($button_showMidi=0)
          %playing[4] := 0
        end if
      end while
    end while
    if (%cb_id[4]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[4],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle5)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle5),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[5]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle5),$CONTROL_PAR_CURSOR_PICTURE,"clip title 5",(%clip_info_cursor[5]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[5]<15)
      inc(%clip_info_cursor[5])
    end if
  end if
end on

on ui_control($switch_preview5)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[5] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[5],$CONTROL_PAR_VALUE)=0)
    %playing[5] := 0
    %looping[5] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i6 := 0
    while ($_other_clip_i6<num_elements(%midi_clip_preview_id))
      if (5 # $_other_clip_i6)
        set_control_par(%midi_clip_preview_id[$_other_clip_i6],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i6]=1)
          %playing[$_other_clip_i6] := 0
          %looping[$_other_clip_i6] := 0
        end if
      end if
      inc($_other_clip_i6)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[5] := 1
    while (%looping[5]=1 and (%cb_id[5]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[5]=0)
        %looping[5] := 0
      end if
      if ($button_showMidi=0)
        %looping[5] := 0
      end if
      %cur_event[5] := 0
      %midi_file_pos_ticks[5] := 0
      %time_started[5] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[5] := 1
      while (%playing[5]=1 and (%cb_id[5]=$NI_CALLBACK_ID))
        if (%cur_event[5]=%num_midi_events[5])
          $_ticks_until_next_event6 := %clip_length[5]-%midi_file_pos_ticks[5]
        else
          $_ticks_until_next_event6 := %_midi_pos[1000*5+%cur_event[5]]-%midi_file_pos_ticks[5]
        end if
        if ($_ticks_until_next_event6>0)
          wait(ticks_to_ms($_ticks_until_next_event6))
        end if
        if (%cur_event[5]>%num_midi_events[5])
          %playing[5] := 0
        end if
        if ($button_showMidi=0)
          %playing[5] := 0
        end if
        if (%playing[5]=1 and (%cb_id[5]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[5] := %midi_file_pos_ticks[5]+$_ticks_until_next_event6
          if (%_midi_command[1000*5+%cur_event[5]]=$MIDI_COMMAND_NOTE_ON)
            $_note6 := %_midi_byte_1[1000*5+%cur_event[5]]
            $_velocity6 := %_midi_byte_2[1000*5+%cur_event[5]]
            $_length6 := ticks_to_ms(%_midi_length[1000*5+%cur_event[5]])
            $_note_id8 := play_note($_note6,$_velocity6,0,$_length6)
            %custom_event_triggered_by_mf[$_note_id8 mod 1000000] := 5+1
            %custom_event_active[$_note_id8 mod 1000000] := 1
            %custom_event_source[$_note_id8 mod 1000000] := -1
            set_event_par_arr($_note_id8,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note6,1)
            %key_down[$_note6] := 1
            %velo[$_note6] := $_velocity6
            $_ks_index := search(%articulation_keyswitches,$_note6)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note6)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note6)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note6)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note6)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note6)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note6)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note6
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note6) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note6,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note6] := 1
              %key_timestamp[$_note6] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note6],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note6
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note6+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note6)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note6)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note6-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note6-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note6-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note6-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note6-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity6)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note6
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity6
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id8 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity6,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity6,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity6,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*5+%cur_event[5]]=$MIDI_COMMAND_CC)
            $_cc_num6 := %_midi_byte_1[1000*5+%cur_event[5]]
            set_controller($_cc_num6,%_midi_byte_2[1000*5+%cur_event[5]])
            wait(1)
            if ($_cc_num6=64)
              if (%CC[$_cc_num6]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num6]
            end if
            if ($_cc_num6=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num6])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[5])
        end if
        if (%cur_event[5]>%num_midi_events[5])
          %playing[5] := 0
        end if
        if ($button_showMidi=0)
          %playing[5] := 0
        end if
      end while
    end while
    if (%cb_id[5]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[5],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle6)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle6),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[6]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle6),$CONTROL_PAR_CURSOR_PICTURE,"clip title 6",(%clip_info_cursor[6]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[6]<15)
      inc(%clip_info_cursor[6])
    end if
  end if
end on

on ui_control($switch_preview6)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[6] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[6],$CONTROL_PAR_VALUE)=0)
    %playing[6] := 0
    %looping[6] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i7 := 0
    while ($_other_clip_i7<num_elements(%midi_clip_preview_id))
      if (6 # $_other_clip_i7)
        set_control_par(%midi_clip_preview_id[$_other_clip_i7],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i7]=1)
          %playing[$_other_clip_i7] := 0
          %looping[$_other_clip_i7] := 0
        end if
      end if
      inc($_other_clip_i7)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[6] := 1
    while (%looping[6]=1 and (%cb_id[6]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[6]=0)
        %looping[6] := 0
      end if
      if ($button_showMidi=0)
        %looping[6] := 0
      end if
      %cur_event[6] := 0
      %midi_file_pos_ticks[6] := 0
      %time_started[6] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[6] := 1
      while (%playing[6]=1 and (%cb_id[6]=$NI_CALLBACK_ID))
        if (%cur_event[6]=%num_midi_events[6])
          $_ticks_until_next_event7 := %clip_length[6]-%midi_file_pos_ticks[6]
        else
          $_ticks_until_next_event7 := %_midi_pos[1000*6+%cur_event[6]]-%midi_file_pos_ticks[6]
        end if
        if ($_ticks_until_next_event7>0)
          wait(ticks_to_ms($_ticks_until_next_event7))
        end if
        if (%cur_event[6]>%num_midi_events[6])
          %playing[6] := 0
        end if
        if ($button_showMidi=0)
          %playing[6] := 0
        end if
        if (%playing[6]=1 and (%cb_id[6]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[6] := %midi_file_pos_ticks[6]+$_ticks_until_next_event7
          if (%_midi_command[1000*6+%cur_event[6]]=$MIDI_COMMAND_NOTE_ON)
            $_note7 := %_midi_byte_1[1000*6+%cur_event[6]]
            $_velocity7 := %_midi_byte_2[1000*6+%cur_event[6]]
            $_length7 := ticks_to_ms(%_midi_length[1000*6+%cur_event[6]])
            $_note_id9 := play_note($_note7,$_velocity7,0,$_length7)
            %custom_event_triggered_by_mf[$_note_id9 mod 1000000] := 6+1
            %custom_event_active[$_note_id9 mod 1000000] := 1
            %custom_event_source[$_note_id9 mod 1000000] := -1
            set_event_par_arr($_note_id9,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note7,1)
            %key_down[$_note7] := 1
            %velo[$_note7] := $_velocity7
            $_ks_index := search(%articulation_keyswitches,$_note7)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note7)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note7)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note7)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note7)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note7)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note7)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note7
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note7) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note7,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note7] := 1
              %key_timestamp[$_note7] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note7],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note7
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note7+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note7)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note7)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note7-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note7-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note7-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note7-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note7-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity7)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note7
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity7
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id9 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity7,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity7,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity7,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*6+%cur_event[6]]=$MIDI_COMMAND_CC)
            $_cc_num7 := %_midi_byte_1[1000*6+%cur_event[6]]
            set_controller($_cc_num7,%_midi_byte_2[1000*6+%cur_event[6]])
            wait(1)
            if ($_cc_num7=64)
              if (%CC[$_cc_num7]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num7]
            end if
            if ($_cc_num7=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num7])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[6])
        end if
        if (%cur_event[6]>%num_midi_events[6])
          %playing[6] := 0
        end if
        if ($button_showMidi=0)
          %playing[6] := 0
        end if
      end while
    end while
    if (%cb_id[6]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[6],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle7)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle7),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[7]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle7),$CONTROL_PAR_CURSOR_PICTURE,"clip title 7",(%clip_info_cursor[7]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[7]<15)
      inc(%clip_info_cursor[7])
    end if
  end if
end on

on ui_control($switch_preview7)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[7] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[7],$CONTROL_PAR_VALUE)=0)
    %playing[7] := 0
    %looping[7] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i8 := 0
    while ($_other_clip_i8<num_elements(%midi_clip_preview_id))
      if (7 # $_other_clip_i8)
        set_control_par(%midi_clip_preview_id[$_other_clip_i8],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i8]=1)
          %playing[$_other_clip_i8] := 0
          %looping[$_other_clip_i8] := 0
        end if
      end if
      inc($_other_clip_i8)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[7] := 1
    while (%looping[7]=1 and (%cb_id[7]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[7]=0)
        %looping[7] := 0
      end if
      if ($button_showMidi=0)
        %looping[7] := 0
      end if
      %cur_event[7] := 0
      %midi_file_pos_ticks[7] := 0
      %time_started[7] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[7] := 1
      while (%playing[7]=1 and (%cb_id[7]=$NI_CALLBACK_ID))
        if (%cur_event[7]=%num_midi_events[7])
          $_ticks_until_next_event8 := %clip_length[7]-%midi_file_pos_ticks[7]
        else
          $_ticks_until_next_event8 := %_midi_pos[1000*7+%cur_event[7]]-%midi_file_pos_ticks[7]
        end if
        if ($_ticks_until_next_event8>0)
          wait(ticks_to_ms($_ticks_until_next_event8))
        end if
        if (%cur_event[7]>%num_midi_events[7])
          %playing[7] := 0
        end if
        if ($button_showMidi=0)
          %playing[7] := 0
        end if
        if (%playing[7]=1 and (%cb_id[7]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[7] := %midi_file_pos_ticks[7]+$_ticks_until_next_event8
          if (%_midi_command[1000*7+%cur_event[7]]=$MIDI_COMMAND_NOTE_ON)
            $_note8 := %_midi_byte_1[1000*7+%cur_event[7]]
            $_velocity8 := %_midi_byte_2[1000*7+%cur_event[7]]
            $_length8 := ticks_to_ms(%_midi_length[1000*7+%cur_event[7]])
            $_note_id10 := play_note($_note8,$_velocity8,0,$_length8)
            %custom_event_triggered_by_mf[$_note_id10 mod 1000000] := 7+1
            %custom_event_active[$_note_id10 mod 1000000] := 1
            %custom_event_source[$_note_id10 mod 1000000] := -1
            set_event_par_arr($_note_id10,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note8,1)
            %key_down[$_note8] := 1
            %velo[$_note8] := $_velocity8
            $_ks_index := search(%articulation_keyswitches,$_note8)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note8)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note8)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note8)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note8)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note8)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note8)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note8
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note8) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note8,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note8] := 1
              %key_timestamp[$_note8] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note8],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note8
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note8+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note8)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note8)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note8-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note8-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note8-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note8-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note8-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity8)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note8
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity8
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id10 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity8,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity8,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity8,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*7+%cur_event[7]]=$MIDI_COMMAND_CC)
            $_cc_num8 := %_midi_byte_1[1000*7+%cur_event[7]]
            set_controller($_cc_num8,%_midi_byte_2[1000*7+%cur_event[7]])
            wait(1)
            if ($_cc_num8=64)
              if (%CC[$_cc_num8]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num8]
            end if
            if ($_cc_num8=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num8])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[7])
        end if
        if (%cur_event[7]>%num_midi_events[7])
          %playing[7] := 0
        end if
        if ($button_showMidi=0)
          %playing[7] := 0
        end if
      end while
    end while
    if (%cb_id[7]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[7],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle8)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle8),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[8]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle8),$CONTROL_PAR_CURSOR_PICTURE,"clip title 8",(%clip_info_cursor[8]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[8]<15)
      inc(%clip_info_cursor[8])
    end if
  end if
end on

on ui_control($switch_preview8)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[8] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[8],$CONTROL_PAR_VALUE)=0)
    %playing[8] := 0
    %looping[8] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i9 := 0
    while ($_other_clip_i9<num_elements(%midi_clip_preview_id))
      if (8 # $_other_clip_i9)
        set_control_par(%midi_clip_preview_id[$_other_clip_i9],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i9]=1)
          %playing[$_other_clip_i9] := 0
          %looping[$_other_clip_i9] := 0
        end if
      end if
      inc($_other_clip_i9)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[8] := 1
    while (%looping[8]=1 and (%cb_id[8]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[8]=0)
        %looping[8] := 0
      end if
      if ($button_showMidi=0)
        %looping[8] := 0
      end if
      %cur_event[8] := 0
      %midi_file_pos_ticks[8] := 0
      %time_started[8] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[8] := 1
      while (%playing[8]=1 and (%cb_id[8]=$NI_CALLBACK_ID))
        if (%cur_event[8]=%num_midi_events[8])
          $_ticks_until_next_event9 := %clip_length[8]-%midi_file_pos_ticks[8]
        else
          $_ticks_until_next_event9 := %_midi_pos[1000*8+%cur_event[8]]-%midi_file_pos_ticks[8]
        end if
        if ($_ticks_until_next_event9>0)
          wait(ticks_to_ms($_ticks_until_next_event9))
        end if
        if (%cur_event[8]>%num_midi_events[8])
          %playing[8] := 0
        end if
        if ($button_showMidi=0)
          %playing[8] := 0
        end if
        if (%playing[8]=1 and (%cb_id[8]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[8] := %midi_file_pos_ticks[8]+$_ticks_until_next_event9
          if (%_midi_command[1000*8+%cur_event[8]]=$MIDI_COMMAND_NOTE_ON)
            $_note9 := %_midi_byte_1[1000*8+%cur_event[8]]
            $_velocity9 := %_midi_byte_2[1000*8+%cur_event[8]]
            $_length9 := ticks_to_ms(%_midi_length[1000*8+%cur_event[8]])
            $_note_id11 := play_note($_note9,$_velocity9,0,$_length9)
            %custom_event_triggered_by_mf[$_note_id11 mod 1000000] := 8+1
            %custom_event_active[$_note_id11 mod 1000000] := 1
            %custom_event_source[$_note_id11 mod 1000000] := -1
            set_event_par_arr($_note_id11,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note9,1)
            %key_down[$_note9] := 1
            %velo[$_note9] := $_velocity9
            $_ks_index := search(%articulation_keyswitches,$_note9)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note9)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note9)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note9)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note9)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note9)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note9)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note9
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note9) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note9,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note9] := 1
              %key_timestamp[$_note9] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note9],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note9
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note9+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note9)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note9)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note9-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note9-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note9-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note9-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note9-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity9)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note9
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity9
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id11 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity9,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity9,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity9,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*8+%cur_event[8]]=$MIDI_COMMAND_CC)
            $_cc_num9 := %_midi_byte_1[1000*8+%cur_event[8]]
            set_controller($_cc_num9,%_midi_byte_2[1000*8+%cur_event[8]])
            wait(1)
            if ($_cc_num9=64)
              if (%CC[$_cc_num9]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num9]
            end if
            if ($_cc_num9=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num9])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[8])
        end if
        if (%cur_event[8]>%num_midi_events[8])
          %playing[8] := 0
        end if
        if ($button_showMidi=0)
          %playing[8] := 0
        end if
      end while
    end while
    if (%cb_id[8]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[8],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle9)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle9),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[9]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle9),$CONTROL_PAR_CURSOR_PICTURE,"clip title 9",(%clip_info_cursor[9]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[9]<15)
      inc(%clip_info_cursor[9])
    end if
  end if
end on

on ui_control($switch_preview9)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[9] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[9],$CONTROL_PAR_VALUE)=0)
    %playing[9] := 0
    %looping[9] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i10 := 0
    while ($_other_clip_i10<num_elements(%midi_clip_preview_id))
      if (9 # $_other_clip_i10)
        set_control_par(%midi_clip_preview_id[$_other_clip_i10],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i10]=1)
          %playing[$_other_clip_i10] := 0
          %looping[$_other_clip_i10] := 0
        end if
      end if
      inc($_other_clip_i10)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[9] := 1
    while (%looping[9]=1 and (%cb_id[9]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[9]=0)
        %looping[9] := 0
      end if
      if ($button_showMidi=0)
        %looping[9] := 0
      end if
      %cur_event[9] := 0
      %midi_file_pos_ticks[9] := 0
      %time_started[9] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[9] := 1
      while (%playing[9]=1 and (%cb_id[9]=$NI_CALLBACK_ID))
        if (%cur_event[9]=%num_midi_events[9])
          $_ticks_until_next_event10 := %clip_length[9]-%midi_file_pos_ticks[9]
        else
          $_ticks_until_next_event10 := %_midi_pos[1000*9+%cur_event[9]]-%midi_file_pos_ticks[9]
        end if
        if ($_ticks_until_next_event10>0)
          wait(ticks_to_ms($_ticks_until_next_event10))
        end if
        if (%cur_event[9]>%num_midi_events[9])
          %playing[9] := 0
        end if
        if ($button_showMidi=0)
          %playing[9] := 0
        end if
        if (%playing[9]=1 and (%cb_id[9]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[9] := %midi_file_pos_ticks[9]+$_ticks_until_next_event10
          if (%_midi_command[1000*9+%cur_event[9]]=$MIDI_COMMAND_NOTE_ON)
            $_note10 := %_midi_byte_1[1000*9+%cur_event[9]]
            $_velocity10 := %_midi_byte_2[1000*9+%cur_event[9]]
            $_length10 := ticks_to_ms(%_midi_length[1000*9+%cur_event[9]])
            $_note_id12 := play_note($_note10,$_velocity10,0,$_length10)
            %custom_event_triggered_by_mf[$_note_id12 mod 1000000] := 9+1
            %custom_event_active[$_note_id12 mod 1000000] := 1
            %custom_event_source[$_note_id12 mod 1000000] := -1
            set_event_par_arr($_note_id12,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note10,1)
            %key_down[$_note10] := 1
            %velo[$_note10] := $_velocity10
            $_ks_index := search(%articulation_keyswitches,$_note10)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note10)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note10)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note10)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note10)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note10)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note10)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note10
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note10) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note10,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note10] := 1
              %key_timestamp[$_note10] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note10],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note10
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note10+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note10)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note10)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note10-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note10-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note10-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note10-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note10-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity10)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note10
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity10
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id12 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity10,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity10,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity10,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*9+%cur_event[9]]=$MIDI_COMMAND_CC)
            $_cc_num10 := %_midi_byte_1[1000*9+%cur_event[9]]
            set_controller($_cc_num10,%_midi_byte_2[1000*9+%cur_event[9]])
            wait(1)
            if ($_cc_num10=64)
              if (%CC[$_cc_num10]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num10]
            end if
            if ($_cc_num10=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num10])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[9])
        end if
        if (%cur_event[9]>%num_midi_events[9])
          %playing[9] := 0
        end if
        if ($button_showMidi=0)
          %playing[9] := 0
        end if
      end while
    end while
    if (%cb_id[9]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[9],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle10)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle10),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[10]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle10),$CONTROL_PAR_CURSOR_PICTURE,"clip title 10",(%clip_info_cursor[10]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[10]<15)
      inc(%clip_info_cursor[10])
    end if
  end if
end on

on ui_control($switch_preview10)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[10] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[10],$CONTROL_PAR_VALUE)=0)
    %playing[10] := 0
    %looping[10] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i11 := 0
    while ($_other_clip_i11<num_elements(%midi_clip_preview_id))
      if (10 # $_other_clip_i11)
        set_control_par(%midi_clip_preview_id[$_other_clip_i11],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i11]=1)
          %playing[$_other_clip_i11] := 0
          %looping[$_other_clip_i11] := 0
        end if
      end if
      inc($_other_clip_i11)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[10] := 1
    while (%looping[10]=1 and (%cb_id[10]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[10]=0)
        %looping[10] := 0
      end if
      if ($button_showMidi=0)
        %looping[10] := 0
      end if
      %cur_event[10] := 0
      %midi_file_pos_ticks[10] := 0
      %time_started[10] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[10] := 1
      while (%playing[10]=1 and (%cb_id[10]=$NI_CALLBACK_ID))
        if (%cur_event[10]=%num_midi_events[10])
          $_ticks_until_next_event11 := %clip_length[10]-%midi_file_pos_ticks[10]
        else
          $_ticks_until_next_event11 := %_midi_pos[1000*10+%cur_event[10]]-%midi_file_pos_ticks[10]
        end if
        if ($_ticks_until_next_event11>0)
          wait(ticks_to_ms($_ticks_until_next_event11))
        end if
        if (%cur_event[10]>%num_midi_events[10])
          %playing[10] := 0
        end if
        if ($button_showMidi=0)
          %playing[10] := 0
        end if
        if (%playing[10]=1 and (%cb_id[10]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[10] := %midi_file_pos_ticks[10]+$_ticks_until_next_event11
          if (%_midi_command[1000*10+%cur_event[10]]=$MIDI_COMMAND_NOTE_ON)
            $_note11 := %_midi_byte_1[1000*10+%cur_event[10]]
            $_velocity11 := %_midi_byte_2[1000*10+%cur_event[10]]
            $_length11 := ticks_to_ms(%_midi_length[1000*10+%cur_event[10]])
            $_note_id13 := play_note($_note11,$_velocity11,0,$_length11)
            %custom_event_triggered_by_mf[$_note_id13 mod 1000000] := 10+1
            %custom_event_active[$_note_id13 mod 1000000] := 1
            %custom_event_source[$_note_id13 mod 1000000] := -1
            set_event_par_arr($_note_id13,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note11,1)
            %key_down[$_note11] := 1
            %velo[$_note11] := $_velocity11
            $_ks_index := search(%articulation_keyswitches,$_note11)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note11)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note11)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note11)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note11)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note11)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note11)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note11
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note11) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note11,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note11] := 1
              %key_timestamp[$_note11] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note11],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note11
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note11+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note11)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note11)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note11-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note11-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note11-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note11-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note11-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity11)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note11
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity11
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id13 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity11,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity11,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity11,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*10+%cur_event[10]]=$MIDI_COMMAND_CC)
            $_cc_num11 := %_midi_byte_1[1000*10+%cur_event[10]]
            set_controller($_cc_num11,%_midi_byte_2[1000*10+%cur_event[10]])
            wait(1)
            if ($_cc_num11=64)
              if (%CC[$_cc_num11]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num11]
            end if
            if ($_cc_num11=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num11])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[10])
        end if
        if (%cur_event[10]>%num_midi_events[10])
          %playing[10] := 0
        end if
        if ($button_showMidi=0)
          %playing[10] := 0
        end if
      end while
    end while
    if (%cb_id[10]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[10],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle11)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle11),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[11]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle11),$CONTROL_PAR_CURSOR_PICTURE,"clip title 11",(%clip_info_cursor[11]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[11]<15)
      inc(%clip_info_cursor[11])
    end if
  end if
end on

on ui_control($switch_preview11)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[11] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[11],$CONTROL_PAR_VALUE)=0)
    %playing[11] := 0
    %looping[11] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i12 := 0
    while ($_other_clip_i12<num_elements(%midi_clip_preview_id))
      if (11 # $_other_clip_i12)
        set_control_par(%midi_clip_preview_id[$_other_clip_i12],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i12]=1)
          %playing[$_other_clip_i12] := 0
          %looping[$_other_clip_i12] := 0
        end if
      end if
      inc($_other_clip_i12)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[11] := 1
    while (%looping[11]=1 and (%cb_id[11]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[11]=0)
        %looping[11] := 0
      end if
      if ($button_showMidi=0)
        %looping[11] := 0
      end if
      %cur_event[11] := 0
      %midi_file_pos_ticks[11] := 0
      %time_started[11] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[11] := 1
      while (%playing[11]=1 and (%cb_id[11]=$NI_CALLBACK_ID))
        if (%cur_event[11]=%num_midi_events[11])
          $_ticks_until_next_event12 := %clip_length[11]-%midi_file_pos_ticks[11]
        else
          $_ticks_until_next_event12 := %_midi_pos[1000*11+%cur_event[11]]-%midi_file_pos_ticks[11]
        end if
        if ($_ticks_until_next_event12>0)
          wait(ticks_to_ms($_ticks_until_next_event12))
        end if
        if (%cur_event[11]>%num_midi_events[11])
          %playing[11] := 0
        end if
        if ($button_showMidi=0)
          %playing[11] := 0
        end if
        if (%playing[11]=1 and (%cb_id[11]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[11] := %midi_file_pos_ticks[11]+$_ticks_until_next_event12
          if (%_midi_command[1000*11+%cur_event[11]]=$MIDI_COMMAND_NOTE_ON)
            $_note12 := %_midi_byte_1[1000*11+%cur_event[11]]
            $_velocity12 := %_midi_byte_2[1000*11+%cur_event[11]]
            $_length12 := ticks_to_ms(%_midi_length[1000*11+%cur_event[11]])
            $_note_id14 := play_note($_note12,$_velocity12,0,$_length12)
            %custom_event_triggered_by_mf[$_note_id14 mod 1000000] := 11+1
            %custom_event_active[$_note_id14 mod 1000000] := 1
            %custom_event_source[$_note_id14 mod 1000000] := -1
            set_event_par_arr($_note_id14,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note12,1)
            %key_down[$_note12] := 1
            %velo[$_note12] := $_velocity12
            $_ks_index := search(%articulation_keyswitches,$_note12)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note12)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note12)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note12)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note12)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note12)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note12)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note12
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note12) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note12,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note12] := 1
              %key_timestamp[$_note12] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note12],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note12
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note12+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note12)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note12)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note12-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note12-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note12-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note12-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note12-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity12)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note12
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity12
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id14 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity12,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity12,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity12,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*11+%cur_event[11]]=$MIDI_COMMAND_CC)
            $_cc_num12 := %_midi_byte_1[1000*11+%cur_event[11]]
            set_controller($_cc_num12,%_midi_byte_2[1000*11+%cur_event[11]])
            wait(1)
            if ($_cc_num12=64)
              if (%CC[$_cc_num12]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num12]
            end if
            if ($_cc_num12=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num12])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[11])
        end if
        if (%cur_event[11]>%num_midi_events[11])
          %playing[11] := 0
        end if
        if ($button_showMidi=0)
          %playing[11] := 0
        end if
      end while
    end while
    if (%cb_id[11]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[11],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle12)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle12),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[12]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle12),$CONTROL_PAR_CURSOR_PICTURE,"clip title 12",(%clip_info_cursor[12]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[12]<15)
      inc(%clip_info_cursor[12])
    end if
  end if
end on

on ui_control($switch_preview12)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[12] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[12],$CONTROL_PAR_VALUE)=0)
    %playing[12] := 0
    %looping[12] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i13 := 0
    while ($_other_clip_i13<num_elements(%midi_clip_preview_id))
      if (12 # $_other_clip_i13)
        set_control_par(%midi_clip_preview_id[$_other_clip_i13],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i13]=1)
          %playing[$_other_clip_i13] := 0
          %looping[$_other_clip_i13] := 0
        end if
      end if
      inc($_other_clip_i13)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[12] := 1
    while (%looping[12]=1 and (%cb_id[12]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[12]=0)
        %looping[12] := 0
      end if
      if ($button_showMidi=0)
        %looping[12] := 0
      end if
      %cur_event[12] := 0
      %midi_file_pos_ticks[12] := 0
      %time_started[12] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[12] := 1
      while (%playing[12]=1 and (%cb_id[12]=$NI_CALLBACK_ID))
        if (%cur_event[12]=%num_midi_events[12])
          $_ticks_until_next_event13 := %clip_length[12]-%midi_file_pos_ticks[12]
        else
          $_ticks_until_next_event13 := %_midi_pos[1000*12+%cur_event[12]]-%midi_file_pos_ticks[12]
        end if
        if ($_ticks_until_next_event13>0)
          wait(ticks_to_ms($_ticks_until_next_event13))
        end if
        if (%cur_event[12]>%num_midi_events[12])
          %playing[12] := 0
        end if
        if ($button_showMidi=0)
          %playing[12] := 0
        end if
        if (%playing[12]=1 and (%cb_id[12]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[12] := %midi_file_pos_ticks[12]+$_ticks_until_next_event13
          if (%_midi_command[1000*12+%cur_event[12]]=$MIDI_COMMAND_NOTE_ON)
            $_note13 := %_midi_byte_1[1000*12+%cur_event[12]]
            $_velocity13 := %_midi_byte_2[1000*12+%cur_event[12]]
            $_length13 := ticks_to_ms(%_midi_length[1000*12+%cur_event[12]])
            $_note_id15 := play_note($_note13,$_velocity13,0,$_length13)
            %custom_event_triggered_by_mf[$_note_id15 mod 1000000] := 12+1
            %custom_event_active[$_note_id15 mod 1000000] := 1
            %custom_event_source[$_note_id15 mod 1000000] := -1
            set_event_par_arr($_note_id15,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note13,1)
            %key_down[$_note13] := 1
            %velo[$_note13] := $_velocity13
            $_ks_index := search(%articulation_keyswitches,$_note13)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note13)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note13)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note13)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note13)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note13)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note13)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note13
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note13) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note13,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note13] := 1
              %key_timestamp[$_note13] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note13],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note13
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note13+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note13)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note13)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note13-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note13-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note13-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note13-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note13-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity13)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note13
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity13
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id15 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity13,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity13,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity13,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*12+%cur_event[12]]=$MIDI_COMMAND_CC)
            $_cc_num13 := %_midi_byte_1[1000*12+%cur_event[12]]
            set_controller($_cc_num13,%_midi_byte_2[1000*12+%cur_event[12]])
            wait(1)
            if ($_cc_num13=64)
              if (%CC[$_cc_num13]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num13]
            end if
            if ($_cc_num13=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num13])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[12])
        end if
        if (%cur_event[12]>%num_midi_events[12])
          %playing[12] := 0
        end if
        if ($button_showMidi=0)
          %playing[12] := 0
        end if
      end while
    end while
    if (%cb_id[12]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[12],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle13)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle13),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[13]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle13),$CONTROL_PAR_CURSOR_PICTURE,"clip title 13",(%clip_info_cursor[13]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[13]<15)
      inc(%clip_info_cursor[13])
    end if
  end if
end on

on ui_control($switch_preview13)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[13] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[13],$CONTROL_PAR_VALUE)=0)
    %playing[13] := 0
    %looping[13] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i14 := 0
    while ($_other_clip_i14<num_elements(%midi_clip_preview_id))
      if (13 # $_other_clip_i14)
        set_control_par(%midi_clip_preview_id[$_other_clip_i14],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i14]=1)
          %playing[$_other_clip_i14] := 0
          %looping[$_other_clip_i14] := 0
        end if
      end if
      inc($_other_clip_i14)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[13] := 1
    while (%looping[13]=1 and (%cb_id[13]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[13]=0)
        %looping[13] := 0
      end if
      if ($button_showMidi=0)
        %looping[13] := 0
      end if
      %cur_event[13] := 0
      %midi_file_pos_ticks[13] := 0
      %time_started[13] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[13] := 1
      while (%playing[13]=1 and (%cb_id[13]=$NI_CALLBACK_ID))
        if (%cur_event[13]=%num_midi_events[13])
          $_ticks_until_next_event14 := %clip_length[13]-%midi_file_pos_ticks[13]
        else
          $_ticks_until_next_event14 := %_midi_pos[1000*13+%cur_event[13]]-%midi_file_pos_ticks[13]
        end if
        if ($_ticks_until_next_event14>0)
          wait(ticks_to_ms($_ticks_until_next_event14))
        end if
        if (%cur_event[13]>%num_midi_events[13])
          %playing[13] := 0
        end if
        if ($button_showMidi=0)
          %playing[13] := 0
        end if
        if (%playing[13]=1 and (%cb_id[13]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[13] := %midi_file_pos_ticks[13]+$_ticks_until_next_event14
          if (%_midi_command[1000*13+%cur_event[13]]=$MIDI_COMMAND_NOTE_ON)
            $_note14 := %_midi_byte_1[1000*13+%cur_event[13]]
            $_velocity14 := %_midi_byte_2[1000*13+%cur_event[13]]
            $_length14 := ticks_to_ms(%_midi_length[1000*13+%cur_event[13]])
            $_note_id16 := play_note($_note14,$_velocity14,0,$_length14)
            %custom_event_triggered_by_mf[$_note_id16 mod 1000000] := 13+1
            %custom_event_active[$_note_id16 mod 1000000] := 1
            %custom_event_source[$_note_id16 mod 1000000] := -1
            set_event_par_arr($_note_id16,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note14,1)
            %key_down[$_note14] := 1
            %velo[$_note14] := $_velocity14
            $_ks_index := search(%articulation_keyswitches,$_note14)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note14)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note14)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note14)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note14)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note14)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note14)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note14
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note14) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note14,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note14] := 1
              %key_timestamp[$_note14] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note14],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note14
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note14+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note14)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note14)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note14-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note14-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note14-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note14-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note14-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity14)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note14
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity14
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id16 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity14,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity14,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity14,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*13+%cur_event[13]]=$MIDI_COMMAND_CC)
            $_cc_num14 := %_midi_byte_1[1000*13+%cur_event[13]]
            set_controller($_cc_num14,%_midi_byte_2[1000*13+%cur_event[13]])
            wait(1)
            if ($_cc_num14=64)
              if (%CC[$_cc_num14]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num14]
            end if
            if ($_cc_num14=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num14])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[13])
        end if
        if (%cur_event[13]>%num_midi_events[13])
          %playing[13] := 0
        end if
        if ($button_showMidi=0)
          %playing[13] := 0
        end if
      end while
    end while
    if (%cb_id[13]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[13],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle14)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle14),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[14]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle14),$CONTROL_PAR_CURSOR_PICTURE,"clip title 14",(%clip_info_cursor[14]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[14]<15)
      inc(%clip_info_cursor[14])
    end if
  end if
end on

on ui_control($switch_preview14)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[14] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[14],$CONTROL_PAR_VALUE)=0)
    %playing[14] := 0
    %looping[14] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i15 := 0
    while ($_other_clip_i15<num_elements(%midi_clip_preview_id))
      if (14 # $_other_clip_i15)
        set_control_par(%midi_clip_preview_id[$_other_clip_i15],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i15]=1)
          %playing[$_other_clip_i15] := 0
          %looping[$_other_clip_i15] := 0
        end if
      end if
      inc($_other_clip_i15)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[14] := 1
    while (%looping[14]=1 and (%cb_id[14]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[14]=0)
        %looping[14] := 0
      end if
      if ($button_showMidi=0)
        %looping[14] := 0
      end if
      %cur_event[14] := 0
      %midi_file_pos_ticks[14] := 0
      %time_started[14] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[14] := 1
      while (%playing[14]=1 and (%cb_id[14]=$NI_CALLBACK_ID))
        if (%cur_event[14]=%num_midi_events[14])
          $_ticks_until_next_event15 := %clip_length[14]-%midi_file_pos_ticks[14]
        else
          $_ticks_until_next_event15 := %_midi_pos[1000*14+%cur_event[14]]-%midi_file_pos_ticks[14]
        end if
        if ($_ticks_until_next_event15>0)
          wait(ticks_to_ms($_ticks_until_next_event15))
        end if
        if (%cur_event[14]>%num_midi_events[14])
          %playing[14] := 0
        end if
        if ($button_showMidi=0)
          %playing[14] := 0
        end if
        if (%playing[14]=1 and (%cb_id[14]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[14] := %midi_file_pos_ticks[14]+$_ticks_until_next_event15
          if (%_midi_command[1000*14+%cur_event[14]]=$MIDI_COMMAND_NOTE_ON)
            $_note15 := %_midi_byte_1[1000*14+%cur_event[14]]
            $_velocity15 := %_midi_byte_2[1000*14+%cur_event[14]]
            $_length15 := ticks_to_ms(%_midi_length[1000*14+%cur_event[14]])
            $_note_id17 := play_note($_note15,$_velocity15,0,$_length15)
            %custom_event_triggered_by_mf[$_note_id17 mod 1000000] := 14+1
            %custom_event_active[$_note_id17 mod 1000000] := 1
            %custom_event_source[$_note_id17 mod 1000000] := -1
            set_event_par_arr($_note_id17,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note15,1)
            %key_down[$_note15] := 1
            %velo[$_note15] := $_velocity15
            $_ks_index := search(%articulation_keyswitches,$_note15)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note15)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note15)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note15)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note15)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note15)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note15)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note15
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note15) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note15,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note15] := 1
              %key_timestamp[$_note15] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note15],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note15
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note15+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note15)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note15)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note15-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note15-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note15-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note15-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note15-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity15)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note15
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity15
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id17 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity15,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity15,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity15,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*14+%cur_event[14]]=$MIDI_COMMAND_CC)
            $_cc_num15 := %_midi_byte_1[1000*14+%cur_event[14]]
            set_controller($_cc_num15,%_midi_byte_2[1000*14+%cur_event[14]])
            wait(1)
            if ($_cc_num15=64)
              if (%CC[$_cc_num15]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num15]
            end if
            if ($_cc_num15=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num15])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[14])
        end if
        if (%cur_event[14]>%num_midi_events[14])
          %playing[14] := 0
        end if
        if ($button_showMidi=0)
          %playing[14] := 0
        end if
      end while
    end while
    if (%cb_id[14]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[14],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle15)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle15),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[15]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle15),$CONTROL_PAR_CURSOR_PICTURE,"clip title 15",(%clip_info_cursor[15]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[15]<15)
      inc(%clip_info_cursor[15])
    end if
  end if
end on

on ui_control($switch_preview15)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[15] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[15],$CONTROL_PAR_VALUE)=0)
    %playing[15] := 0
    %looping[15] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i16 := 0
    while ($_other_clip_i16<num_elements(%midi_clip_preview_id))
      if (15 # $_other_clip_i16)
        set_control_par(%midi_clip_preview_id[$_other_clip_i16],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i16]=1)
          %playing[$_other_clip_i16] := 0
          %looping[$_other_clip_i16] := 0
        end if
      end if
      inc($_other_clip_i16)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[15] := 1
    while (%looping[15]=1 and (%cb_id[15]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[15]=0)
        %looping[15] := 0
      end if
      if ($button_showMidi=0)
        %looping[15] := 0
      end if
      %cur_event[15] := 0
      %midi_file_pos_ticks[15] := 0
      %time_started[15] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[15] := 1
      while (%playing[15]=1 and (%cb_id[15]=$NI_CALLBACK_ID))
        if (%cur_event[15]=%num_midi_events[15])
          $_ticks_until_next_event16 := %clip_length[15]-%midi_file_pos_ticks[15]
        else
          $_ticks_until_next_event16 := %_midi_pos[1000*15+%cur_event[15]]-%midi_file_pos_ticks[15]
        end if
        if ($_ticks_until_next_event16>0)
          wait(ticks_to_ms($_ticks_until_next_event16))
        end if
        if (%cur_event[15]>%num_midi_events[15])
          %playing[15] := 0
        end if
        if ($button_showMidi=0)
          %playing[15] := 0
        end if
        if (%playing[15]=1 and (%cb_id[15]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[15] := %midi_file_pos_ticks[15]+$_ticks_until_next_event16
          if (%_midi_command[1000*15+%cur_event[15]]=$MIDI_COMMAND_NOTE_ON)
            $_note16 := %_midi_byte_1[1000*15+%cur_event[15]]
            $_velocity16 := %_midi_byte_2[1000*15+%cur_event[15]]
            $_length16 := ticks_to_ms(%_midi_length[1000*15+%cur_event[15]])
            $_note_id18 := play_note($_note16,$_velocity16,0,$_length16)
            %custom_event_triggered_by_mf[$_note_id18 mod 1000000] := 15+1
            %custom_event_active[$_note_id18 mod 1000000] := 1
            %custom_event_source[$_note_id18 mod 1000000] := -1
            set_event_par_arr($_note_id18,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note16,1)
            %key_down[$_note16] := 1
            %velo[$_note16] := $_velocity16
            $_ks_index := search(%articulation_keyswitches,$_note16)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note16)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note16)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note16)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note16)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note16)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note16)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note16
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note16) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note16,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note16] := 1
              %key_timestamp[$_note16] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note16],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note16
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note16+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note16)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note16)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note16-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note16-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note16-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note16-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note16-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity16)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note16
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity16
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id18 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity16,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity16,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity16,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*15+%cur_event[15]]=$MIDI_COMMAND_CC)
            $_cc_num16 := %_midi_byte_1[1000*15+%cur_event[15]]
            set_controller($_cc_num16,%_midi_byte_2[1000*15+%cur_event[15]])
            wait(1)
            if ($_cc_num16=64)
              if (%CC[$_cc_num16]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num16]
            end if
            if ($_cc_num16=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num16])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[15])
        end if
        if (%cur_event[15]>%num_midi_events[15])
          %playing[15] := 0
        end if
        if ($button_showMidi=0)
          %playing[15] := 0
        end if
      end while
    end while
    if (%cb_id[15]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[15],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle16)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle16),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[16]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle16),$CONTROL_PAR_CURSOR_PICTURE,"clip title 16",(%clip_info_cursor[16]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[16]<15)
      inc(%clip_info_cursor[16])
    end if
  end if
end on

on ui_control($switch_preview16)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[16] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[16],$CONTROL_PAR_VALUE)=0)
    %playing[16] := 0
    %looping[16] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i17 := 0
    while ($_other_clip_i17<num_elements(%midi_clip_preview_id))
      if (16 # $_other_clip_i17)
        set_control_par(%midi_clip_preview_id[$_other_clip_i17],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i17]=1)
          %playing[$_other_clip_i17] := 0
          %looping[$_other_clip_i17] := 0
        end if
      end if
      inc($_other_clip_i17)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[16] := 1
    while (%looping[16]=1 and (%cb_id[16]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[16]=0)
        %looping[16] := 0
      end if
      if ($button_showMidi=0)
        %looping[16] := 0
      end if
      %cur_event[16] := 0
      %midi_file_pos_ticks[16] := 0
      %time_started[16] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[16] := 1
      while (%playing[16]=1 and (%cb_id[16]=$NI_CALLBACK_ID))
        if (%cur_event[16]=%num_midi_events[16])
          $_ticks_until_next_event17 := %clip_length[16]-%midi_file_pos_ticks[16]
        else
          $_ticks_until_next_event17 := %_midi_pos[1000*16+%cur_event[16]]-%midi_file_pos_ticks[16]
        end if
        if ($_ticks_until_next_event17>0)
          wait(ticks_to_ms($_ticks_until_next_event17))
        end if
        if (%cur_event[16]>%num_midi_events[16])
          %playing[16] := 0
        end if
        if ($button_showMidi=0)
          %playing[16] := 0
        end if
        if (%playing[16]=1 and (%cb_id[16]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[16] := %midi_file_pos_ticks[16]+$_ticks_until_next_event17
          if (%_midi_command[1000*16+%cur_event[16]]=$MIDI_COMMAND_NOTE_ON)
            $_note17 := %_midi_byte_1[1000*16+%cur_event[16]]
            $_velocity17 := %_midi_byte_2[1000*16+%cur_event[16]]
            $_length17 := ticks_to_ms(%_midi_length[1000*16+%cur_event[16]])
            $_note_id19 := play_note($_note17,$_velocity17,0,$_length17)
            %custom_event_triggered_by_mf[$_note_id19 mod 1000000] := 16+1
            %custom_event_active[$_note_id19 mod 1000000] := 1
            %custom_event_source[$_note_id19 mod 1000000] := -1
            set_event_par_arr($_note_id19,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note17,1)
            %key_down[$_note17] := 1
            %velo[$_note17] := $_velocity17
            $_ks_index := search(%articulation_keyswitches,$_note17)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note17)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note17)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note17)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note17)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note17)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note17)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note17
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note17) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note17,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note17] := 1
              %key_timestamp[$_note17] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note17],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note17
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note17+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note17)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note17)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note17-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note17-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note17-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note17-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note17-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity17)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note17
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity17
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id19 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity17,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity17,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity17,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*16+%cur_event[16]]=$MIDI_COMMAND_CC)
            $_cc_num17 := %_midi_byte_1[1000*16+%cur_event[16]]
            set_controller($_cc_num17,%_midi_byte_2[1000*16+%cur_event[16]])
            wait(1)
            if ($_cc_num17=64)
              if (%CC[$_cc_num17]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num17]
            end if
            if ($_cc_num17=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num17])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[16])
        end if
        if (%cur_event[16]>%num_midi_events[16])
          %playing[16] := 0
        end if
        if ($button_showMidi=0)
          %playing[16] := 0
        end if
      end while
    end while
    if (%cb_id[16]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[16],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle17)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle17),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[17]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle17),$CONTROL_PAR_CURSOR_PICTURE,"clip title 17",(%clip_info_cursor[17]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[17]<15)
      inc(%clip_info_cursor[17])
    end if
  end if
end on

on ui_control($switch_preview17)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[17] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[17],$CONTROL_PAR_VALUE)=0)
    %playing[17] := 0
    %looping[17] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i18 := 0
    while ($_other_clip_i18<num_elements(%midi_clip_preview_id))
      if (17 # $_other_clip_i18)
        set_control_par(%midi_clip_preview_id[$_other_clip_i18],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i18]=1)
          %playing[$_other_clip_i18] := 0
          %looping[$_other_clip_i18] := 0
        end if
      end if
      inc($_other_clip_i18)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[17] := 1
    while (%looping[17]=1 and (%cb_id[17]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[17]=0)
        %looping[17] := 0
      end if
      if ($button_showMidi=0)
        %looping[17] := 0
      end if
      %cur_event[17] := 0
      %midi_file_pos_ticks[17] := 0
      %time_started[17] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[17] := 1
      while (%playing[17]=1 and (%cb_id[17]=$NI_CALLBACK_ID))
        if (%cur_event[17]=%num_midi_events[17])
          $_ticks_until_next_event18 := %clip_length[17]-%midi_file_pos_ticks[17]
        else
          $_ticks_until_next_event18 := %_midi_pos[1000*17+%cur_event[17]]-%midi_file_pos_ticks[17]
        end if
        if ($_ticks_until_next_event18>0)
          wait(ticks_to_ms($_ticks_until_next_event18))
        end if
        if (%cur_event[17]>%num_midi_events[17])
          %playing[17] := 0
        end if
        if ($button_showMidi=0)
          %playing[17] := 0
        end if
        if (%playing[17]=1 and (%cb_id[17]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[17] := %midi_file_pos_ticks[17]+$_ticks_until_next_event18
          if (%_midi_command[1000*17+%cur_event[17]]=$MIDI_COMMAND_NOTE_ON)
            $_note18 := %_midi_byte_1[1000*17+%cur_event[17]]
            $_velocity18 := %_midi_byte_2[1000*17+%cur_event[17]]
            $_length18 := ticks_to_ms(%_midi_length[1000*17+%cur_event[17]])
            $_note_id20 := play_note($_note18,$_velocity18,0,$_length18)
            %custom_event_triggered_by_mf[$_note_id20 mod 1000000] := 17+1
            %custom_event_active[$_note_id20 mod 1000000] := 1
            %custom_event_source[$_note_id20 mod 1000000] := -1
            set_event_par_arr($_note_id20,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note18,1)
            %key_down[$_note18] := 1
            %velo[$_note18] := $_velocity18
            $_ks_index := search(%articulation_keyswitches,$_note18)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note18)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note18)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note18)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note18)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note18)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note18)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note18
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note18) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note18,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note18] := 1
              %key_timestamp[$_note18] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note18],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note18
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note18+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note18)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note18)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note18-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note18-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note18-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note18-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note18-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity18)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note18
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity18
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id20 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity18,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity18,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity18,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*17+%cur_event[17]]=$MIDI_COMMAND_CC)
            $_cc_num18 := %_midi_byte_1[1000*17+%cur_event[17]]
            set_controller($_cc_num18,%_midi_byte_2[1000*17+%cur_event[17]])
            wait(1)
            if ($_cc_num18=64)
              if (%CC[$_cc_num18]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num18]
            end if
            if ($_cc_num18=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num18])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[17])
        end if
        if (%cur_event[17]>%num_midi_events[17])
          %playing[17] := 0
        end if
        if ($button_showMidi=0)
          %playing[17] := 0
        end if
      end while
    end while
    if (%cb_id[17]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[17],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle18)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle18),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[18]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle18),$CONTROL_PAR_CURSOR_PICTURE,"clip title 18",(%clip_info_cursor[18]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[18]<15)
      inc(%clip_info_cursor[18])
    end if
  end if
end on

on ui_control($switch_preview18)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[18] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[18],$CONTROL_PAR_VALUE)=0)
    %playing[18] := 0
    %looping[18] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i19 := 0
    while ($_other_clip_i19<num_elements(%midi_clip_preview_id))
      if (18 # $_other_clip_i19)
        set_control_par(%midi_clip_preview_id[$_other_clip_i19],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i19]=1)
          %playing[$_other_clip_i19] := 0
          %looping[$_other_clip_i19] := 0
        end if
      end if
      inc($_other_clip_i19)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[18] := 1
    while (%looping[18]=1 and (%cb_id[18]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[18]=0)
        %looping[18] := 0
      end if
      if ($button_showMidi=0)
        %looping[18] := 0
      end if
      %cur_event[18] := 0
      %midi_file_pos_ticks[18] := 0
      %time_started[18] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[18] := 1
      while (%playing[18]=1 and (%cb_id[18]=$NI_CALLBACK_ID))
        if (%cur_event[18]=%num_midi_events[18])
          $_ticks_until_next_event19 := %clip_length[18]-%midi_file_pos_ticks[18]
        else
          $_ticks_until_next_event19 := %_midi_pos[1000*18+%cur_event[18]]-%midi_file_pos_ticks[18]
        end if
        if ($_ticks_until_next_event19>0)
          wait(ticks_to_ms($_ticks_until_next_event19))
        end if
        if (%cur_event[18]>%num_midi_events[18])
          %playing[18] := 0
        end if
        if ($button_showMidi=0)
          %playing[18] := 0
        end if
        if (%playing[18]=1 and (%cb_id[18]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[18] := %midi_file_pos_ticks[18]+$_ticks_until_next_event19
          if (%_midi_command[1000*18+%cur_event[18]]=$MIDI_COMMAND_NOTE_ON)
            $_note19 := %_midi_byte_1[1000*18+%cur_event[18]]
            $_velocity19 := %_midi_byte_2[1000*18+%cur_event[18]]
            $_length19 := ticks_to_ms(%_midi_length[1000*18+%cur_event[18]])
            $_note_id21 := play_note($_note19,$_velocity19,0,$_length19)
            %custom_event_triggered_by_mf[$_note_id21 mod 1000000] := 18+1
            %custom_event_active[$_note_id21 mod 1000000] := 1
            %custom_event_source[$_note_id21 mod 1000000] := -1
            set_event_par_arr($_note_id21,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note19,1)
            %key_down[$_note19] := 1
            %velo[$_note19] := $_velocity19
            $_ks_index := search(%articulation_keyswitches,$_note19)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note19)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note19)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note19)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note19)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note19)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note19)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note19
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note19) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note19,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note19] := 1
              %key_timestamp[$_note19] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note19],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note19
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note19+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note19)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note19)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note19-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note19-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note19-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note19-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note19-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity19)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note19
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity19
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id21 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity19,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity19,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity19,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*18+%cur_event[18]]=$MIDI_COMMAND_CC)
            $_cc_num19 := %_midi_byte_1[1000*18+%cur_event[18]]
            set_controller($_cc_num19,%_midi_byte_2[1000*18+%cur_event[18]])
            wait(1)
            if ($_cc_num19=64)
              if (%CC[$_cc_num19]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num19]
            end if
            if ($_cc_num19=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num19])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[18])
        end if
        if (%cur_event[18]>%num_midi_events[18])
          %playing[18] := 0
        end if
        if ($button_showMidi=0)
          %playing[18] := 0
        end if
      end while
    end while
    if (%cb_id[18]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[18],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle19)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle19),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[19]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle19),$CONTROL_PAR_CURSOR_PICTURE,"clip title 19",(%clip_info_cursor[19]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[19]<15)
      inc(%clip_info_cursor[19])
    end if
  end if
end on

on ui_control($switch_preview19)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[19] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[19],$CONTROL_PAR_VALUE)=0)
    %playing[19] := 0
    %looping[19] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i20 := 0
    while ($_other_clip_i20<num_elements(%midi_clip_preview_id))
      if (19 # $_other_clip_i20)
        set_control_par(%midi_clip_preview_id[$_other_clip_i20],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i20]=1)
          %playing[$_other_clip_i20] := 0
          %looping[$_other_clip_i20] := 0
        end if
      end if
      inc($_other_clip_i20)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[19] := 1
    while (%looping[19]=1 and (%cb_id[19]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[19]=0)
        %looping[19] := 0
      end if
      if ($button_showMidi=0)
        %looping[19] := 0
      end if
      %cur_event[19] := 0
      %midi_file_pos_ticks[19] := 0
      %time_started[19] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[19] := 1
      while (%playing[19]=1 and (%cb_id[19]=$NI_CALLBACK_ID))
        if (%cur_event[19]=%num_midi_events[19])
          $_ticks_until_next_event20 := %clip_length[19]-%midi_file_pos_ticks[19]
        else
          $_ticks_until_next_event20 := %_midi_pos[1000*19+%cur_event[19]]-%midi_file_pos_ticks[19]
        end if
        if ($_ticks_until_next_event20>0)
          wait(ticks_to_ms($_ticks_until_next_event20))
        end if
        if (%cur_event[19]>%num_midi_events[19])
          %playing[19] := 0
        end if
        if ($button_showMidi=0)
          %playing[19] := 0
        end if
        if (%playing[19]=1 and (%cb_id[19]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[19] := %midi_file_pos_ticks[19]+$_ticks_until_next_event20
          if (%_midi_command[1000*19+%cur_event[19]]=$MIDI_COMMAND_NOTE_ON)
            $_note20 := %_midi_byte_1[1000*19+%cur_event[19]]
            $_velocity20 := %_midi_byte_2[1000*19+%cur_event[19]]
            $_length20 := ticks_to_ms(%_midi_length[1000*19+%cur_event[19]])
            $_note_id22 := play_note($_note20,$_velocity20,0,$_length20)
            %custom_event_triggered_by_mf[$_note_id22 mod 1000000] := 19+1
            %custom_event_active[$_note_id22 mod 1000000] := 1
            %custom_event_source[$_note_id22 mod 1000000] := -1
            set_event_par_arr($_note_id22,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note20,1)
            %key_down[$_note20] := 1
            %velo[$_note20] := $_velocity20
            $_ks_index := search(%articulation_keyswitches,$_note20)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note20)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note20)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note20)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note20)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note20)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note20)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note20
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note20) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note20,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note20] := 1
              %key_timestamp[$_note20] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note20],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note20
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note20+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note20)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note20)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note20-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note20-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note20-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note20-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note20-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity20)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note20
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity20
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id22 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity20,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity20,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity20,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*19+%cur_event[19]]=$MIDI_COMMAND_CC)
            $_cc_num20 := %_midi_byte_1[1000*19+%cur_event[19]]
            set_controller($_cc_num20,%_midi_byte_2[1000*19+%cur_event[19]])
            wait(1)
            if ($_cc_num20=64)
              if (%CC[$_cc_num20]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num20]
            end if
            if ($_cc_num20=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num20])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[19])
        end if
        if (%cur_event[19]>%num_midi_events[19])
          %playing[19] := 0
        end if
        if ($button_showMidi=0)
          %playing[19] := 0
        end if
      end while
    end while
    if (%cb_id[19]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[19],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle20)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle20),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[20]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle20),$CONTROL_PAR_CURSOR_PICTURE,"clip title 20",(%clip_info_cursor[20]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[20]<15)
      inc(%clip_info_cursor[20])
    end if
  end if
end on

on ui_control($switch_preview20)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[20] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[20],$CONTROL_PAR_VALUE)=0)
    %playing[20] := 0
    %looping[20] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i21 := 0
    while ($_other_clip_i21<num_elements(%midi_clip_preview_id))
      if (20 # $_other_clip_i21)
        set_control_par(%midi_clip_preview_id[$_other_clip_i21],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i21]=1)
          %playing[$_other_clip_i21] := 0
          %looping[$_other_clip_i21] := 0
        end if
      end if
      inc($_other_clip_i21)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[20] := 1
    while (%looping[20]=1 and (%cb_id[20]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[20]=0)
        %looping[20] := 0
      end if
      if ($button_showMidi=0)
        %looping[20] := 0
      end if
      %cur_event[20] := 0
      %midi_file_pos_ticks[20] := 0
      %time_started[20] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[20] := 1
      while (%playing[20]=1 and (%cb_id[20]=$NI_CALLBACK_ID))
        if (%cur_event[20]=%num_midi_events[20])
          $_ticks_until_next_event21 := %clip_length[20]-%midi_file_pos_ticks[20]
        else
          $_ticks_until_next_event21 := %_midi_pos[1000*20+%cur_event[20]]-%midi_file_pos_ticks[20]
        end if
        if ($_ticks_until_next_event21>0)
          wait(ticks_to_ms($_ticks_until_next_event21))
        end if
        if (%cur_event[20]>%num_midi_events[20])
          %playing[20] := 0
        end if
        if ($button_showMidi=0)
          %playing[20] := 0
        end if
        if (%playing[20]=1 and (%cb_id[20]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[20] := %midi_file_pos_ticks[20]+$_ticks_until_next_event21
          if (%_midi_command[1000*20+%cur_event[20]]=$MIDI_COMMAND_NOTE_ON)
            $_note21 := %_midi_byte_1[1000*20+%cur_event[20]]
            $_velocity21 := %_midi_byte_2[1000*20+%cur_event[20]]
            $_length21 := ticks_to_ms(%_midi_length[1000*20+%cur_event[20]])
            $_note_id23 := play_note($_note21,$_velocity21,0,$_length21)
            %custom_event_triggered_by_mf[$_note_id23 mod 1000000] := 20+1
            %custom_event_active[$_note_id23 mod 1000000] := 1
            %custom_event_source[$_note_id23 mod 1000000] := -1
            set_event_par_arr($_note_id23,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note21,1)
            %key_down[$_note21] := 1
            %velo[$_note21] := $_velocity21
            $_ks_index := search(%articulation_keyswitches,$_note21)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note21)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note21)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note21)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note21)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note21)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note21)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note21
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note21) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note21,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note21] := 1
              %key_timestamp[$_note21] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note21],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note21
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note21+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note21)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note21)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note21-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note21-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note21-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note21-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note21-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity21)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note21
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity21
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id23 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity21,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity21,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity21,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*20+%cur_event[20]]=$MIDI_COMMAND_CC)
            $_cc_num21 := %_midi_byte_1[1000*20+%cur_event[20]]
            set_controller($_cc_num21,%_midi_byte_2[1000*20+%cur_event[20]])
            wait(1)
            if ($_cc_num21=64)
              if (%CC[$_cc_num21]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num21]
            end if
            if ($_cc_num21=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num21])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[20])
        end if
        if (%cur_event[20]>%num_midi_events[20])
          %playing[20] := 0
        end if
        if ($button_showMidi=0)
          %playing[20] := 0
        end if
      end while
    end while
    if (%cb_id[20]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[20],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle21)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle21),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[21]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle21),$CONTROL_PAR_CURSOR_PICTURE,"clip title 21",(%clip_info_cursor[21]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[21]<15)
      inc(%clip_info_cursor[21])
    end if
  end if
end on

on ui_control($switch_preview21)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[21] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[21],$CONTROL_PAR_VALUE)=0)
    %playing[21] := 0
    %looping[21] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i22 := 0
    while ($_other_clip_i22<num_elements(%midi_clip_preview_id))
      if (21 # $_other_clip_i22)
        set_control_par(%midi_clip_preview_id[$_other_clip_i22],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i22]=1)
          %playing[$_other_clip_i22] := 0
          %looping[$_other_clip_i22] := 0
        end if
      end if
      inc($_other_clip_i22)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[21] := 1
    while (%looping[21]=1 and (%cb_id[21]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[21]=0)
        %looping[21] := 0
      end if
      if ($button_showMidi=0)
        %looping[21] := 0
      end if
      %cur_event[21] := 0
      %midi_file_pos_ticks[21] := 0
      %time_started[21] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[21] := 1
      while (%playing[21]=1 and (%cb_id[21]=$NI_CALLBACK_ID))
        if (%cur_event[21]=%num_midi_events[21])
          $_ticks_until_next_event22 := %clip_length[21]-%midi_file_pos_ticks[21]
        else
          $_ticks_until_next_event22 := %_midi_pos[1000*21+%cur_event[21]]-%midi_file_pos_ticks[21]
        end if
        if ($_ticks_until_next_event22>0)
          wait(ticks_to_ms($_ticks_until_next_event22))
        end if
        if (%cur_event[21]>%num_midi_events[21])
          %playing[21] := 0
        end if
        if ($button_showMidi=0)
          %playing[21] := 0
        end if
        if (%playing[21]=1 and (%cb_id[21]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[21] := %midi_file_pos_ticks[21]+$_ticks_until_next_event22
          if (%_midi_command[1000*21+%cur_event[21]]=$MIDI_COMMAND_NOTE_ON)
            $_note22 := %_midi_byte_1[1000*21+%cur_event[21]]
            $_velocity22 := %_midi_byte_2[1000*21+%cur_event[21]]
            $_length22 := ticks_to_ms(%_midi_length[1000*21+%cur_event[21]])
            $_note_id24 := play_note($_note22,$_velocity22,0,$_length22)
            %custom_event_triggered_by_mf[$_note_id24 mod 1000000] := 21+1
            %custom_event_active[$_note_id24 mod 1000000] := 1
            %custom_event_source[$_note_id24 mod 1000000] := -1
            set_event_par_arr($_note_id24,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note22,1)
            %key_down[$_note22] := 1
            %velo[$_note22] := $_velocity22
            $_ks_index := search(%articulation_keyswitches,$_note22)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note22)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note22)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note22)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note22)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note22)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note22)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note22
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note22) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note22,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note22] := 1
              %key_timestamp[$_note22] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note22],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note22
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note22+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note22)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note22)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note22-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note22-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note22-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note22-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note22-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity22)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note22
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity22
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id24 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity22,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity22,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity22,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*21+%cur_event[21]]=$MIDI_COMMAND_CC)
            $_cc_num22 := %_midi_byte_1[1000*21+%cur_event[21]]
            set_controller($_cc_num22,%_midi_byte_2[1000*21+%cur_event[21]])
            wait(1)
            if ($_cc_num22=64)
              if (%CC[$_cc_num22]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num22]
            end if
            if ($_cc_num22=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num22])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[21])
        end if
        if (%cur_event[21]>%num_midi_events[21])
          %playing[21] := 0
        end if
        if ($button_showMidi=0)
          %playing[21] := 0
        end if
      end while
    end while
    if (%cb_id[21]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[21],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle22)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle22),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[22]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle22),$CONTROL_PAR_CURSOR_PICTURE,"clip title 22",(%clip_info_cursor[22]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[22]<15)
      inc(%clip_info_cursor[22])
    end if
  end if
end on

on ui_control($switch_preview22)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[22] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[22],$CONTROL_PAR_VALUE)=0)
    %playing[22] := 0
    %looping[22] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i23 := 0
    while ($_other_clip_i23<num_elements(%midi_clip_preview_id))
      if (22 # $_other_clip_i23)
        set_control_par(%midi_clip_preview_id[$_other_clip_i23],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i23]=1)
          %playing[$_other_clip_i23] := 0
          %looping[$_other_clip_i23] := 0
        end if
      end if
      inc($_other_clip_i23)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[22] := 1
    while (%looping[22]=1 and (%cb_id[22]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[22]=0)
        %looping[22] := 0
      end if
      if ($button_showMidi=0)
        %looping[22] := 0
      end if
      %cur_event[22] := 0
      %midi_file_pos_ticks[22] := 0
      %time_started[22] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[22] := 1
      while (%playing[22]=1 and (%cb_id[22]=$NI_CALLBACK_ID))
        if (%cur_event[22]=%num_midi_events[22])
          $_ticks_until_next_event23 := %clip_length[22]-%midi_file_pos_ticks[22]
        else
          $_ticks_until_next_event23 := %_midi_pos[1000*22+%cur_event[22]]-%midi_file_pos_ticks[22]
        end if
        if ($_ticks_until_next_event23>0)
          wait(ticks_to_ms($_ticks_until_next_event23))
        end if
        if (%cur_event[22]>%num_midi_events[22])
          %playing[22] := 0
        end if
        if ($button_showMidi=0)
          %playing[22] := 0
        end if
        if (%playing[22]=1 and (%cb_id[22]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[22] := %midi_file_pos_ticks[22]+$_ticks_until_next_event23
          if (%_midi_command[1000*22+%cur_event[22]]=$MIDI_COMMAND_NOTE_ON)
            $_note23 := %_midi_byte_1[1000*22+%cur_event[22]]
            $_velocity23 := %_midi_byte_2[1000*22+%cur_event[22]]
            $_length23 := ticks_to_ms(%_midi_length[1000*22+%cur_event[22]])
            $_note_id25 := play_note($_note23,$_velocity23,0,$_length23)
            %custom_event_triggered_by_mf[$_note_id25 mod 1000000] := 22+1
            %custom_event_active[$_note_id25 mod 1000000] := 1
            %custom_event_source[$_note_id25 mod 1000000] := -1
            set_event_par_arr($_note_id25,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note23,1)
            %key_down[$_note23] := 1
            %velo[$_note23] := $_velocity23
            $_ks_index := search(%articulation_keyswitches,$_note23)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note23)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note23)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note23)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note23)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note23)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note23)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note23
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note23) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note23,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note23] := 1
              %key_timestamp[$_note23] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note23],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note23
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note23+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note23)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note23)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note23-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note23-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note23-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note23-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note23-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity23)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note23
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity23
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id25 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity23,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity23,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity23,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*22+%cur_event[22]]=$MIDI_COMMAND_CC)
            $_cc_num23 := %_midi_byte_1[1000*22+%cur_event[22]]
            set_controller($_cc_num23,%_midi_byte_2[1000*22+%cur_event[22]])
            wait(1)
            if ($_cc_num23=64)
              if (%CC[$_cc_num23]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num23]
            end if
            if ($_cc_num23=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num23])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[22])
        end if
        if (%cur_event[22]>%num_midi_events[22])
          %playing[22] := 0
        end if
        if ($button_showMidi=0)
          %playing[22] := 0
        end if
      end while
    end while
    if (%cb_id[22]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[22],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle23)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle23),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[23]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle23),$CONTROL_PAR_CURSOR_PICTURE,"clip title 23",(%clip_info_cursor[23]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[23]<15)
      inc(%clip_info_cursor[23])
    end if
  end if
end on

on ui_control($switch_preview23)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[23] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[23],$CONTROL_PAR_VALUE)=0)
    %playing[23] := 0
    %looping[23] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i24 := 0
    while ($_other_clip_i24<num_elements(%midi_clip_preview_id))
      if (23 # $_other_clip_i24)
        set_control_par(%midi_clip_preview_id[$_other_clip_i24],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i24]=1)
          %playing[$_other_clip_i24] := 0
          %looping[$_other_clip_i24] := 0
        end if
      end if
      inc($_other_clip_i24)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[23] := 1
    while (%looping[23]=1 and (%cb_id[23]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[23]=0)
        %looping[23] := 0
      end if
      if ($button_showMidi=0)
        %looping[23] := 0
      end if
      %cur_event[23] := 0
      %midi_file_pos_ticks[23] := 0
      %time_started[23] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[23] := 1
      while (%playing[23]=1 and (%cb_id[23]=$NI_CALLBACK_ID))
        if (%cur_event[23]=%num_midi_events[23])
          $_ticks_until_next_event24 := %clip_length[23]-%midi_file_pos_ticks[23]
        else
          $_ticks_until_next_event24 := %_midi_pos[1000*23+%cur_event[23]]-%midi_file_pos_ticks[23]
        end if
        if ($_ticks_until_next_event24>0)
          wait(ticks_to_ms($_ticks_until_next_event24))
        end if
        if (%cur_event[23]>%num_midi_events[23])
          %playing[23] := 0
        end if
        if ($button_showMidi=0)
          %playing[23] := 0
        end if
        if (%playing[23]=1 and (%cb_id[23]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[23] := %midi_file_pos_ticks[23]+$_ticks_until_next_event24
          if (%_midi_command[1000*23+%cur_event[23]]=$MIDI_COMMAND_NOTE_ON)
            $_note24 := %_midi_byte_1[1000*23+%cur_event[23]]
            $_velocity24 := %_midi_byte_2[1000*23+%cur_event[23]]
            $_length24 := ticks_to_ms(%_midi_length[1000*23+%cur_event[23]])
            $_note_id26 := play_note($_note24,$_velocity24,0,$_length24)
            %custom_event_triggered_by_mf[$_note_id26 mod 1000000] := 23+1
            %custom_event_active[$_note_id26 mod 1000000] := 1
            %custom_event_source[$_note_id26 mod 1000000] := -1
            set_event_par_arr($_note_id26,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note24,1)
            %key_down[$_note24] := 1
            %velo[$_note24] := $_velocity24
            $_ks_index := search(%articulation_keyswitches,$_note24)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note24)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note24)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note24)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note24)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note24)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note24)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note24
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note24) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note24,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note24] := 1
              %key_timestamp[$_note24] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note24],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note24
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note24+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note24)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note24)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note24-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note24-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note24-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note24-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note24-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity24)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note24
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity24
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id26 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity24,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity24,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity24,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*23+%cur_event[23]]=$MIDI_COMMAND_CC)
            $_cc_num24 := %_midi_byte_1[1000*23+%cur_event[23]]
            set_controller($_cc_num24,%_midi_byte_2[1000*23+%cur_event[23]])
            wait(1)
            if ($_cc_num24=64)
              if (%CC[$_cc_num24]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num24]
            end if
            if ($_cc_num24=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num24])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[23])
        end if
        if (%cur_event[23]>%num_midi_events[23])
          %playing[23] := 0
        end if
        if ($button_showMidi=0)
          %playing[23] := 0
        end if
      end while
    end while
    if (%cb_id[23]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[23],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle24)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle24),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[24]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle24),$CONTROL_PAR_CURSOR_PICTURE,"clip title 24",(%clip_info_cursor[24]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[24]<15)
      inc(%clip_info_cursor[24])
    end if
  end if
end on

on ui_control($switch_preview24)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[24] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[24],$CONTROL_PAR_VALUE)=0)
    %playing[24] := 0
    %looping[24] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i25 := 0
    while ($_other_clip_i25<num_elements(%midi_clip_preview_id))
      if (24 # $_other_clip_i25)
        set_control_par(%midi_clip_preview_id[$_other_clip_i25],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i25]=1)
          %playing[$_other_clip_i25] := 0
          %looping[$_other_clip_i25] := 0
        end if
      end if
      inc($_other_clip_i25)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[24] := 1
    while (%looping[24]=1 and (%cb_id[24]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[24]=0)
        %looping[24] := 0
      end if
      if ($button_showMidi=0)
        %looping[24] := 0
      end if
      %cur_event[24] := 0
      %midi_file_pos_ticks[24] := 0
      %time_started[24] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[24] := 1
      while (%playing[24]=1 and (%cb_id[24]=$NI_CALLBACK_ID))
        if (%cur_event[24]=%num_midi_events[24])
          $_ticks_until_next_event25 := %clip_length[24]-%midi_file_pos_ticks[24]
        else
          $_ticks_until_next_event25 := %_midi_pos[1000*24+%cur_event[24]]-%midi_file_pos_ticks[24]
        end if
        if ($_ticks_until_next_event25>0)
          wait(ticks_to_ms($_ticks_until_next_event25))
        end if
        if (%cur_event[24]>%num_midi_events[24])
          %playing[24] := 0
        end if
        if ($button_showMidi=0)
          %playing[24] := 0
        end if
        if (%playing[24]=1 and (%cb_id[24]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[24] := %midi_file_pos_ticks[24]+$_ticks_until_next_event25
          if (%_midi_command[1000*24+%cur_event[24]]=$MIDI_COMMAND_NOTE_ON)
            $_note25 := %_midi_byte_1[1000*24+%cur_event[24]]
            $_velocity25 := %_midi_byte_2[1000*24+%cur_event[24]]
            $_length25 := ticks_to_ms(%_midi_length[1000*24+%cur_event[24]])
            $_note_id27 := play_note($_note25,$_velocity25,0,$_length25)
            %custom_event_triggered_by_mf[$_note_id27 mod 1000000] := 24+1
            %custom_event_active[$_note_id27 mod 1000000] := 1
            %custom_event_source[$_note_id27 mod 1000000] := -1
            set_event_par_arr($_note_id27,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note25,1)
            %key_down[$_note25] := 1
            %velo[$_note25] := $_velocity25
            $_ks_index := search(%articulation_keyswitches,$_note25)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note25)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note25)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note25)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note25)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note25)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note25)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note25
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note25) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note25,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note25] := 1
              %key_timestamp[$_note25] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note25],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note25
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note25+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note25)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note25)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note25-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note25-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note25-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note25-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note25-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity25)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note25
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity25
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id27 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity25,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity25,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity25,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*24+%cur_event[24]]=$MIDI_COMMAND_CC)
            $_cc_num25 := %_midi_byte_1[1000*24+%cur_event[24]]
            set_controller($_cc_num25,%_midi_byte_2[1000*24+%cur_event[24]])
            wait(1)
            if ($_cc_num25=64)
              if (%CC[$_cc_num25]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num25]
            end if
            if ($_cc_num25=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num25])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[24])
        end if
        if (%cur_event[24]>%num_midi_events[24])
          %playing[24] := 0
        end if
        if ($button_showMidi=0)
          %playing[24] := 0
        end if
      end while
    end while
    if (%cb_id[24]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[24],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle25)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle25),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[25]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle25),$CONTROL_PAR_CURSOR_PICTURE,"clip title 25",(%clip_info_cursor[25]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[25]<15)
      inc(%clip_info_cursor[25])
    end if
  end if
end on

on ui_control($switch_preview25)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[25] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[25],$CONTROL_PAR_VALUE)=0)
    %playing[25] := 0
    %looping[25] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i26 := 0
    while ($_other_clip_i26<num_elements(%midi_clip_preview_id))
      if (25 # $_other_clip_i26)
        set_control_par(%midi_clip_preview_id[$_other_clip_i26],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i26]=1)
          %playing[$_other_clip_i26] := 0
          %looping[$_other_clip_i26] := 0
        end if
      end if
      inc($_other_clip_i26)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[25] := 1
    while (%looping[25]=1 and (%cb_id[25]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[25]=0)
        %looping[25] := 0
      end if
      if ($button_showMidi=0)
        %looping[25] := 0
      end if
      %cur_event[25] := 0
      %midi_file_pos_ticks[25] := 0
      %time_started[25] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[25] := 1
      while (%playing[25]=1 and (%cb_id[25]=$NI_CALLBACK_ID))
        if (%cur_event[25]=%num_midi_events[25])
          $_ticks_until_next_event26 := %clip_length[25]-%midi_file_pos_ticks[25]
        else
          $_ticks_until_next_event26 := %_midi_pos[1000*25+%cur_event[25]]-%midi_file_pos_ticks[25]
        end if
        if ($_ticks_until_next_event26>0)
          wait(ticks_to_ms($_ticks_until_next_event26))
        end if
        if (%cur_event[25]>%num_midi_events[25])
          %playing[25] := 0
        end if
        if ($button_showMidi=0)
          %playing[25] := 0
        end if
        if (%playing[25]=1 and (%cb_id[25]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[25] := %midi_file_pos_ticks[25]+$_ticks_until_next_event26
          if (%_midi_command[1000*25+%cur_event[25]]=$MIDI_COMMAND_NOTE_ON)
            $_note26 := %_midi_byte_1[1000*25+%cur_event[25]]
            $_velocity26 := %_midi_byte_2[1000*25+%cur_event[25]]
            $_length26 := ticks_to_ms(%_midi_length[1000*25+%cur_event[25]])
            $_note_id28 := play_note($_note26,$_velocity26,0,$_length26)
            %custom_event_triggered_by_mf[$_note_id28 mod 1000000] := 25+1
            %custom_event_active[$_note_id28 mod 1000000] := 1
            %custom_event_source[$_note_id28 mod 1000000] := -1
            set_event_par_arr($_note_id28,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note26,1)
            %key_down[$_note26] := 1
            %velo[$_note26] := $_velocity26
            $_ks_index := search(%articulation_keyswitches,$_note26)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note26)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note26)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note26)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note26)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note26)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note26)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note26
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note26) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note26,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note26] := 1
              %key_timestamp[$_note26] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note26],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note26
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note26+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note26)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note26)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note26-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note26-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note26-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note26-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note26-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity26)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note26
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity26
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id28 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity26,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity26,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity26,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*25+%cur_event[25]]=$MIDI_COMMAND_CC)
            $_cc_num26 := %_midi_byte_1[1000*25+%cur_event[25]]
            set_controller($_cc_num26,%_midi_byte_2[1000*25+%cur_event[25]])
            wait(1)
            if ($_cc_num26=64)
              if (%CC[$_cc_num26]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num26]
            end if
            if ($_cc_num26=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num26])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[25])
        end if
        if (%cur_event[25]>%num_midi_events[25])
          %playing[25] := 0
        end if
        if ($button_showMidi=0)
          %playing[25] := 0
        end if
      end while
    end while
    if (%cb_id[25]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[25],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle26)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle26),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[26]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle26),$CONTROL_PAR_CURSOR_PICTURE,"clip title 26",(%clip_info_cursor[26]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[26]<15)
      inc(%clip_info_cursor[26])
    end if
  end if
end on

on ui_control($switch_preview26)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[26] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[26],$CONTROL_PAR_VALUE)=0)
    %playing[26] := 0
    %looping[26] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i27 := 0
    while ($_other_clip_i27<num_elements(%midi_clip_preview_id))
      if (26 # $_other_clip_i27)
        set_control_par(%midi_clip_preview_id[$_other_clip_i27],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i27]=1)
          %playing[$_other_clip_i27] := 0
          %looping[$_other_clip_i27] := 0
        end if
      end if
      inc($_other_clip_i27)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[26] := 1
    while (%looping[26]=1 and (%cb_id[26]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[26]=0)
        %looping[26] := 0
      end if
      if ($button_showMidi=0)
        %looping[26] := 0
      end if
      %cur_event[26] := 0
      %midi_file_pos_ticks[26] := 0
      %time_started[26] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[26] := 1
      while (%playing[26]=1 and (%cb_id[26]=$NI_CALLBACK_ID))
        if (%cur_event[26]=%num_midi_events[26])
          $_ticks_until_next_event27 := %clip_length[26]-%midi_file_pos_ticks[26]
        else
          $_ticks_until_next_event27 := %_midi_pos[1000*26+%cur_event[26]]-%midi_file_pos_ticks[26]
        end if
        if ($_ticks_until_next_event27>0)
          wait(ticks_to_ms($_ticks_until_next_event27))
        end if
        if (%cur_event[26]>%num_midi_events[26])
          %playing[26] := 0
        end if
        if ($button_showMidi=0)
          %playing[26] := 0
        end if
        if (%playing[26]=1 and (%cb_id[26]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[26] := %midi_file_pos_ticks[26]+$_ticks_until_next_event27
          if (%_midi_command[1000*26+%cur_event[26]]=$MIDI_COMMAND_NOTE_ON)
            $_note27 := %_midi_byte_1[1000*26+%cur_event[26]]
            $_velocity27 := %_midi_byte_2[1000*26+%cur_event[26]]
            $_length27 := ticks_to_ms(%_midi_length[1000*26+%cur_event[26]])
            $_note_id29 := play_note($_note27,$_velocity27,0,$_length27)
            %custom_event_triggered_by_mf[$_note_id29 mod 1000000] := 26+1
            %custom_event_active[$_note_id29 mod 1000000] := 1
            %custom_event_source[$_note_id29 mod 1000000] := -1
            set_event_par_arr($_note_id29,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note27,1)
            %key_down[$_note27] := 1
            %velo[$_note27] := $_velocity27
            $_ks_index := search(%articulation_keyswitches,$_note27)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note27)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note27)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note27)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note27)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note27)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note27)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note27
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note27) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note27,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note27] := 1
              %key_timestamp[$_note27] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note27],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note27
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note27+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note27)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note27)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note27-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note27-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note27-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note27-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note27-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity27)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note27
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity27
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id29 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity27,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity27,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity27,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*26+%cur_event[26]]=$MIDI_COMMAND_CC)
            $_cc_num27 := %_midi_byte_1[1000*26+%cur_event[26]]
            set_controller($_cc_num27,%_midi_byte_2[1000*26+%cur_event[26]])
            wait(1)
            if ($_cc_num27=64)
              if (%CC[$_cc_num27]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num27]
            end if
            if ($_cc_num27=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num27])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[26])
        end if
        if (%cur_event[26]>%num_midi_events[26])
          %playing[26] := 0
        end if
        if ($button_showMidi=0)
          %playing[26] := 0
        end if
      end while
    end while
    if (%cb_id[26]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[26],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle27)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle27),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[27]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle27),$CONTROL_PAR_CURSOR_PICTURE,"clip title 27",(%clip_info_cursor[27]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[27]<15)
      inc(%clip_info_cursor[27])
    end if
  end if
end on

on ui_control($switch_preview27)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[27] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[27],$CONTROL_PAR_VALUE)=0)
    %playing[27] := 0
    %looping[27] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i28 := 0
    while ($_other_clip_i28<num_elements(%midi_clip_preview_id))
      if (27 # $_other_clip_i28)
        set_control_par(%midi_clip_preview_id[$_other_clip_i28],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i28]=1)
          %playing[$_other_clip_i28] := 0
          %looping[$_other_clip_i28] := 0
        end if
      end if
      inc($_other_clip_i28)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[27] := 1
    while (%looping[27]=1 and (%cb_id[27]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[27]=0)
        %looping[27] := 0
      end if
      if ($button_showMidi=0)
        %looping[27] := 0
      end if
      %cur_event[27] := 0
      %midi_file_pos_ticks[27] := 0
      %time_started[27] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[27] := 1
      while (%playing[27]=1 and (%cb_id[27]=$NI_CALLBACK_ID))
        if (%cur_event[27]=%num_midi_events[27])
          $_ticks_until_next_event28 := %clip_length[27]-%midi_file_pos_ticks[27]
        else
          $_ticks_until_next_event28 := %_midi_pos[1000*27+%cur_event[27]]-%midi_file_pos_ticks[27]
        end if
        if ($_ticks_until_next_event28>0)
          wait(ticks_to_ms($_ticks_until_next_event28))
        end if
        if (%cur_event[27]>%num_midi_events[27])
          %playing[27] := 0
        end if
        if ($button_showMidi=0)
          %playing[27] := 0
        end if
        if (%playing[27]=1 and (%cb_id[27]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[27] := %midi_file_pos_ticks[27]+$_ticks_until_next_event28
          if (%_midi_command[1000*27+%cur_event[27]]=$MIDI_COMMAND_NOTE_ON)
            $_note28 := %_midi_byte_1[1000*27+%cur_event[27]]
            $_velocity28 := %_midi_byte_2[1000*27+%cur_event[27]]
            $_length28 := ticks_to_ms(%_midi_length[1000*27+%cur_event[27]])
            $_note_id30 := play_note($_note28,$_velocity28,0,$_length28)
            %custom_event_triggered_by_mf[$_note_id30 mod 1000000] := 27+1
            %custom_event_active[$_note_id30 mod 1000000] := 1
            %custom_event_source[$_note_id30 mod 1000000] := -1
            set_event_par_arr($_note_id30,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note28,1)
            %key_down[$_note28] := 1
            %velo[$_note28] := $_velocity28
            $_ks_index := search(%articulation_keyswitches,$_note28)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note28)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note28)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note28)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note28)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note28)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note28)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note28
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note28) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note28,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note28] := 1
              %key_timestamp[$_note28] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note28],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note28
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note28+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note28)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note28)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note28-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note28-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note28-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note28-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note28-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity28)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note28
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity28
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id30 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity28,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity28,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity28,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*27+%cur_event[27]]=$MIDI_COMMAND_CC)
            $_cc_num28 := %_midi_byte_1[1000*27+%cur_event[27]]
            set_controller($_cc_num28,%_midi_byte_2[1000*27+%cur_event[27]])
            wait(1)
            if ($_cc_num28=64)
              if (%CC[$_cc_num28]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num28]
            end if
            if ($_cc_num28=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num28])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[27])
        end if
        if (%cur_event[27]>%num_midi_events[27])
          %playing[27] := 0
        end if
        if ($button_showMidi=0)
          %playing[27] := 0
        end if
      end while
    end while
    if (%cb_id[27]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[27],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle28)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle28),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[28]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle28),$CONTROL_PAR_CURSOR_PICTURE,"clip title 28",(%clip_info_cursor[28]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[28]<15)
      inc(%clip_info_cursor[28])
    end if
  end if
end on

on ui_control($switch_preview28)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[28] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[28],$CONTROL_PAR_VALUE)=0)
    %playing[28] := 0
    %looping[28] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i29 := 0
    while ($_other_clip_i29<num_elements(%midi_clip_preview_id))
      if (28 # $_other_clip_i29)
        set_control_par(%midi_clip_preview_id[$_other_clip_i29],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i29]=1)
          %playing[$_other_clip_i29] := 0
          %looping[$_other_clip_i29] := 0
        end if
      end if
      inc($_other_clip_i29)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[28] := 1
    while (%looping[28]=1 and (%cb_id[28]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[28]=0)
        %looping[28] := 0
      end if
      if ($button_showMidi=0)
        %looping[28] := 0
      end if
      %cur_event[28] := 0
      %midi_file_pos_ticks[28] := 0
      %time_started[28] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[28] := 1
      while (%playing[28]=1 and (%cb_id[28]=$NI_CALLBACK_ID))
        if (%cur_event[28]=%num_midi_events[28])
          $_ticks_until_next_event29 := %clip_length[28]-%midi_file_pos_ticks[28]
        else
          $_ticks_until_next_event29 := %_midi_pos[1000*28+%cur_event[28]]-%midi_file_pos_ticks[28]
        end if
        if ($_ticks_until_next_event29>0)
          wait(ticks_to_ms($_ticks_until_next_event29))
        end if
        if (%cur_event[28]>%num_midi_events[28])
          %playing[28] := 0
        end if
        if ($button_showMidi=0)
          %playing[28] := 0
        end if
        if (%playing[28]=1 and (%cb_id[28]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[28] := %midi_file_pos_ticks[28]+$_ticks_until_next_event29
          if (%_midi_command[1000*28+%cur_event[28]]=$MIDI_COMMAND_NOTE_ON)
            $_note29 := %_midi_byte_1[1000*28+%cur_event[28]]
            $_velocity29 := %_midi_byte_2[1000*28+%cur_event[28]]
            $_length29 := ticks_to_ms(%_midi_length[1000*28+%cur_event[28]])
            $_note_id31 := play_note($_note29,$_velocity29,0,$_length29)
            %custom_event_triggered_by_mf[$_note_id31 mod 1000000] := 28+1
            %custom_event_active[$_note_id31 mod 1000000] := 1
            %custom_event_source[$_note_id31 mod 1000000] := -1
            set_event_par_arr($_note_id31,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note29,1)
            %key_down[$_note29] := 1
            %velo[$_note29] := $_velocity29
            $_ks_index := search(%articulation_keyswitches,$_note29)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note29)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note29)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note29)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note29)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note29)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note29)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note29
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note29) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note29,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note29] := 1
              %key_timestamp[$_note29] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note29],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note29
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note29+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note29)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note29)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note29-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note29-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note29-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note29-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note29-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity29)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note29
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity29
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id31 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity29,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity29,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity29,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*28+%cur_event[28]]=$MIDI_COMMAND_CC)
            $_cc_num29 := %_midi_byte_1[1000*28+%cur_event[28]]
            set_controller($_cc_num29,%_midi_byte_2[1000*28+%cur_event[28]])
            wait(1)
            if ($_cc_num29=64)
              if (%CC[$_cc_num29]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num29]
            end if
            if ($_cc_num29=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num29])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[28])
        end if
        if (%cur_event[28]>%num_midi_events[28])
          %playing[28] := 0
        end if
        if ($button_showMidi=0)
          %playing[28] := 0
        end if
      end while
    end while
    if (%cb_id[28]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[28],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle29)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle29),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[29]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle29),$CONTROL_PAR_CURSOR_PICTURE,"clip title 29",(%clip_info_cursor[29]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[29]<15)
      inc(%clip_info_cursor[29])
    end if
  end if
end on

on ui_control($switch_preview29)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[29] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[29],$CONTROL_PAR_VALUE)=0)
    %playing[29] := 0
    %looping[29] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i30 := 0
    while ($_other_clip_i30<num_elements(%midi_clip_preview_id))
      if (29 # $_other_clip_i30)
        set_control_par(%midi_clip_preview_id[$_other_clip_i30],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i30]=1)
          %playing[$_other_clip_i30] := 0
          %looping[$_other_clip_i30] := 0
        end if
      end if
      inc($_other_clip_i30)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[29] := 1
    while (%looping[29]=1 and (%cb_id[29]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[29]=0)
        %looping[29] := 0
      end if
      if ($button_showMidi=0)
        %looping[29] := 0
      end if
      %cur_event[29] := 0
      %midi_file_pos_ticks[29] := 0
      %time_started[29] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[29] := 1
      while (%playing[29]=1 and (%cb_id[29]=$NI_CALLBACK_ID))
        if (%cur_event[29]=%num_midi_events[29])
          $_ticks_until_next_event30 := %clip_length[29]-%midi_file_pos_ticks[29]
        else
          $_ticks_until_next_event30 := %_midi_pos[1000*29+%cur_event[29]]-%midi_file_pos_ticks[29]
        end if
        if ($_ticks_until_next_event30>0)
          wait(ticks_to_ms($_ticks_until_next_event30))
        end if
        if (%cur_event[29]>%num_midi_events[29])
          %playing[29] := 0
        end if
        if ($button_showMidi=0)
          %playing[29] := 0
        end if
        if (%playing[29]=1 and (%cb_id[29]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[29] := %midi_file_pos_ticks[29]+$_ticks_until_next_event30
          if (%_midi_command[1000*29+%cur_event[29]]=$MIDI_COMMAND_NOTE_ON)
            $_note30 := %_midi_byte_1[1000*29+%cur_event[29]]
            $_velocity30 := %_midi_byte_2[1000*29+%cur_event[29]]
            $_length30 := ticks_to_ms(%_midi_length[1000*29+%cur_event[29]])
            $_note_id32 := play_note($_note30,$_velocity30,0,$_length30)
            %custom_event_triggered_by_mf[$_note_id32 mod 1000000] := 29+1
            %custom_event_active[$_note_id32 mod 1000000] := 1
            %custom_event_source[$_note_id32 mod 1000000] := -1
            set_event_par_arr($_note_id32,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note30,1)
            %key_down[$_note30] := 1
            %velo[$_note30] := $_velocity30
            $_ks_index := search(%articulation_keyswitches,$_note30)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note30)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note30)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note30)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note30)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note30)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note30)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note30
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note30) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note30,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note30] := 1
              %key_timestamp[$_note30] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note30],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note30
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note30+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note30)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note30)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note30-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note30-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note30-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note30-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note30-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity30)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note30
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity30
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id32 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity30,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity30,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity30,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*29+%cur_event[29]]=$MIDI_COMMAND_CC)
            $_cc_num30 := %_midi_byte_1[1000*29+%cur_event[29]]
            set_controller($_cc_num30,%_midi_byte_2[1000*29+%cur_event[29]])
            wait(1)
            if ($_cc_num30=64)
              if (%CC[$_cc_num30]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num30]
            end if
            if ($_cc_num30=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num30])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[29])
        end if
        if (%cur_event[29]>%num_midi_events[29])
          %playing[29] := 0
        end if
        if ($button_showMidi=0)
          %playing[29] := 0
        end if
      end while
    end while
    if (%cb_id[29]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[29],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle30)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle30),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[30]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle30),$CONTROL_PAR_CURSOR_PICTURE,"clip title 30",(%clip_info_cursor[30]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[30]<15)
      inc(%clip_info_cursor[30])
    end if
  end if
end on

on ui_control($switch_preview30)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[30] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[30],$CONTROL_PAR_VALUE)=0)
    %playing[30] := 0
    %looping[30] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i31 := 0
    while ($_other_clip_i31<num_elements(%midi_clip_preview_id))
      if (30 # $_other_clip_i31)
        set_control_par(%midi_clip_preview_id[$_other_clip_i31],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i31]=1)
          %playing[$_other_clip_i31] := 0
          %looping[$_other_clip_i31] := 0
        end if
      end if
      inc($_other_clip_i31)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[30] := 1
    while (%looping[30]=1 and (%cb_id[30]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[30]=0)
        %looping[30] := 0
      end if
      if ($button_showMidi=0)
        %looping[30] := 0
      end if
      %cur_event[30] := 0
      %midi_file_pos_ticks[30] := 0
      %time_started[30] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[30] := 1
      while (%playing[30]=1 and (%cb_id[30]=$NI_CALLBACK_ID))
        if (%cur_event[30]=%num_midi_events[30])
          $_ticks_until_next_event31 := %clip_length[30]-%midi_file_pos_ticks[30]
        else
          $_ticks_until_next_event31 := %_midi_pos[1000*30+%cur_event[30]]-%midi_file_pos_ticks[30]
        end if
        if ($_ticks_until_next_event31>0)
          wait(ticks_to_ms($_ticks_until_next_event31))
        end if
        if (%cur_event[30]>%num_midi_events[30])
          %playing[30] := 0
        end if
        if ($button_showMidi=0)
          %playing[30] := 0
        end if
        if (%playing[30]=1 and (%cb_id[30]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[30] := %midi_file_pos_ticks[30]+$_ticks_until_next_event31
          if (%_midi_command[1000*30+%cur_event[30]]=$MIDI_COMMAND_NOTE_ON)
            $_note31 := %_midi_byte_1[1000*30+%cur_event[30]]
            $_velocity31 := %_midi_byte_2[1000*30+%cur_event[30]]
            $_length31 := ticks_to_ms(%_midi_length[1000*30+%cur_event[30]])
            $_note_id33 := play_note($_note31,$_velocity31,0,$_length31)
            %custom_event_triggered_by_mf[$_note_id33 mod 1000000] := 30+1
            %custom_event_active[$_note_id33 mod 1000000] := 1
            %custom_event_source[$_note_id33 mod 1000000] := -1
            set_event_par_arr($_note_id33,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note31,1)
            %key_down[$_note31] := 1
            %velo[$_note31] := $_velocity31
            $_ks_index := search(%articulation_keyswitches,$_note31)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note31)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note31)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note31)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note31)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note31)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note31)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note31
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note31) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note31,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note31] := 1
              %key_timestamp[$_note31] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note31],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note31
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note31+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note31)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note31)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note31-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note31-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note31-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note31-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note31-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity31)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note31
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity31
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id33 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity31,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity31,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity31,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*30+%cur_event[30]]=$MIDI_COMMAND_CC)
            $_cc_num31 := %_midi_byte_1[1000*30+%cur_event[30]]
            set_controller($_cc_num31,%_midi_byte_2[1000*30+%cur_event[30]])
            wait(1)
            if ($_cc_num31=64)
              if (%CC[$_cc_num31]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num31]
            end if
            if ($_cc_num31=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num31])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[30])
        end if
        if (%cur_event[30]>%num_midi_events[30])
          %playing[30] := 0
        end if
        if ($button_showMidi=0)
          %playing[30] := 0
        end if
      end while
    end while
    if (%cb_id[30]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[30],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle31)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle31),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[31]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle31),$CONTROL_PAR_CURSOR_PICTURE,"clip title 31",(%clip_info_cursor[31]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[31]<15)
      inc(%clip_info_cursor[31])
    end if
  end if
end on

on ui_control($switch_preview31)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[31] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[31],$CONTROL_PAR_VALUE)=0)
    %playing[31] := 0
    %looping[31] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i32 := 0
    while ($_other_clip_i32<num_elements(%midi_clip_preview_id))
      if (31 # $_other_clip_i32)
        set_control_par(%midi_clip_preview_id[$_other_clip_i32],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i32]=1)
          %playing[$_other_clip_i32] := 0
          %looping[$_other_clip_i32] := 0
        end if
      end if
      inc($_other_clip_i32)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[31] := 1
    while (%looping[31]=1 and (%cb_id[31]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[31]=0)
        %looping[31] := 0
      end if
      if ($button_showMidi=0)
        %looping[31] := 0
      end if
      %cur_event[31] := 0
      %midi_file_pos_ticks[31] := 0
      %time_started[31] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[31] := 1
      while (%playing[31]=1 and (%cb_id[31]=$NI_CALLBACK_ID))
        if (%cur_event[31]=%num_midi_events[31])
          $_ticks_until_next_event32 := %clip_length[31]-%midi_file_pos_ticks[31]
        else
          $_ticks_until_next_event32 := %_midi_pos[1000*31+%cur_event[31]]-%midi_file_pos_ticks[31]
        end if
        if ($_ticks_until_next_event32>0)
          wait(ticks_to_ms($_ticks_until_next_event32))
        end if
        if (%cur_event[31]>%num_midi_events[31])
          %playing[31] := 0
        end if
        if ($button_showMidi=0)
          %playing[31] := 0
        end if
        if (%playing[31]=1 and (%cb_id[31]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[31] := %midi_file_pos_ticks[31]+$_ticks_until_next_event32
          if (%_midi_command[1000*31+%cur_event[31]]=$MIDI_COMMAND_NOTE_ON)
            $_note32 := %_midi_byte_1[1000*31+%cur_event[31]]
            $_velocity32 := %_midi_byte_2[1000*31+%cur_event[31]]
            $_length32 := ticks_to_ms(%_midi_length[1000*31+%cur_event[31]])
            $_note_id34 := play_note($_note32,$_velocity32,0,$_length32)
            %custom_event_triggered_by_mf[$_note_id34 mod 1000000] := 31+1
            %custom_event_active[$_note_id34 mod 1000000] := 1
            %custom_event_source[$_note_id34 mod 1000000] := -1
            set_event_par_arr($_note_id34,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note32,1)
            %key_down[$_note32] := 1
            %velo[$_note32] := $_velocity32
            $_ks_index := search(%articulation_keyswitches,$_note32)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note32)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note32)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note32)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note32)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note32)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note32)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note32
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note32) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note32,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note32] := 1
              %key_timestamp[$_note32] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note32],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note32
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note32+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note32)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note32)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note32-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note32-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note32-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note32-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note32-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity32)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note32
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity32
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id34 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity32,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity32,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity32,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*31+%cur_event[31]]=$MIDI_COMMAND_CC)
            $_cc_num32 := %_midi_byte_1[1000*31+%cur_event[31]]
            set_controller($_cc_num32,%_midi_byte_2[1000*31+%cur_event[31]])
            wait(1)
            if ($_cc_num32=64)
              if (%CC[$_cc_num32]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num32]
            end if
            if ($_cc_num32=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num32])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[31])
        end if
        if (%cur_event[31]>%num_midi_events[31])
          %playing[31] := 0
        end if
        if ($button_showMidi=0)
          %playing[31] := 0
        end if
      end while
    end while
    if (%cb_id[31]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[31],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle32)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle32),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[32]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle32),$CONTROL_PAR_CURSOR_PICTURE,"clip title 32",(%clip_info_cursor[32]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[32]<15)
      inc(%clip_info_cursor[32])
    end if
  end if
end on

on ui_control($switch_preview32)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[32] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[32],$CONTROL_PAR_VALUE)=0)
    %playing[32] := 0
    %looping[32] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i33 := 0
    while ($_other_clip_i33<num_elements(%midi_clip_preview_id))
      if (32 # $_other_clip_i33)
        set_control_par(%midi_clip_preview_id[$_other_clip_i33],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i33]=1)
          %playing[$_other_clip_i33] := 0
          %looping[$_other_clip_i33] := 0
        end if
      end if
      inc($_other_clip_i33)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[32] := 1
    while (%looping[32]=1 and (%cb_id[32]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[32]=0)
        %looping[32] := 0
      end if
      if ($button_showMidi=0)
        %looping[32] := 0
      end if
      %cur_event[32] := 0
      %midi_file_pos_ticks[32] := 0
      %time_started[32] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[32] := 1
      while (%playing[32]=1 and (%cb_id[32]=$NI_CALLBACK_ID))
        if (%cur_event[32]=%num_midi_events[32])
          $_ticks_until_next_event33 := %clip_length[32]-%midi_file_pos_ticks[32]
        else
          $_ticks_until_next_event33 := %_midi_pos[1000*32+%cur_event[32]]-%midi_file_pos_ticks[32]
        end if
        if ($_ticks_until_next_event33>0)
          wait(ticks_to_ms($_ticks_until_next_event33))
        end if
        if (%cur_event[32]>%num_midi_events[32])
          %playing[32] := 0
        end if
        if ($button_showMidi=0)
          %playing[32] := 0
        end if
        if (%playing[32]=1 and (%cb_id[32]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[32] := %midi_file_pos_ticks[32]+$_ticks_until_next_event33
          if (%_midi_command[1000*32+%cur_event[32]]=$MIDI_COMMAND_NOTE_ON)
            $_note33 := %_midi_byte_1[1000*32+%cur_event[32]]
            $_velocity33 := %_midi_byte_2[1000*32+%cur_event[32]]
            $_length33 := ticks_to_ms(%_midi_length[1000*32+%cur_event[32]])
            $_note_id35 := play_note($_note33,$_velocity33,0,$_length33)
            %custom_event_triggered_by_mf[$_note_id35 mod 1000000] := 32+1
            %custom_event_active[$_note_id35 mod 1000000] := 1
            %custom_event_source[$_note_id35 mod 1000000] := -1
            set_event_par_arr($_note_id35,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note33,1)
            %key_down[$_note33] := 1
            %velo[$_note33] := $_velocity33
            $_ks_index := search(%articulation_keyswitches,$_note33)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note33)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note33)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note33)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note33)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note33)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note33)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note33
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note33) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note33,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note33] := 1
              %key_timestamp[$_note33] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note33],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note33
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note33+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note33)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note33)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note33-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note33-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note33-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note33-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note33-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity33)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note33
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity33
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id35 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity33,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity33,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity33,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*32+%cur_event[32]]=$MIDI_COMMAND_CC)
            $_cc_num33 := %_midi_byte_1[1000*32+%cur_event[32]]
            set_controller($_cc_num33,%_midi_byte_2[1000*32+%cur_event[32]])
            wait(1)
            if ($_cc_num33=64)
              if (%CC[$_cc_num33]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num33]
            end if
            if ($_cc_num33=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num33])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[32])
        end if
        if (%cur_event[32]>%num_midi_events[32])
          %playing[32] := 0
        end if
        if ($button_showMidi=0)
          %playing[32] := 0
        end if
      end while
    end while
    if (%cb_id[32]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[32],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle33)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle33),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[33]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle33),$CONTROL_PAR_CURSOR_PICTURE,"clip title 33",(%clip_info_cursor[33]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[33]<15)
      inc(%clip_info_cursor[33])
    end if
  end if
end on

on ui_control($switch_preview33)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[33] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[33],$CONTROL_PAR_VALUE)=0)
    %playing[33] := 0
    %looping[33] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i34 := 0
    while ($_other_clip_i34<num_elements(%midi_clip_preview_id))
      if (33 # $_other_clip_i34)
        set_control_par(%midi_clip_preview_id[$_other_clip_i34],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i34]=1)
          %playing[$_other_clip_i34] := 0
          %looping[$_other_clip_i34] := 0
        end if
      end if
      inc($_other_clip_i34)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[33] := 1
    while (%looping[33]=1 and (%cb_id[33]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[33]=0)
        %looping[33] := 0
      end if
      if ($button_showMidi=0)
        %looping[33] := 0
      end if
      %cur_event[33] := 0
      %midi_file_pos_ticks[33] := 0
      %time_started[33] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[33] := 1
      while (%playing[33]=1 and (%cb_id[33]=$NI_CALLBACK_ID))
        if (%cur_event[33]=%num_midi_events[33])
          $_ticks_until_next_event34 := %clip_length[33]-%midi_file_pos_ticks[33]
        else
          $_ticks_until_next_event34 := %_midi_pos[1000*33+%cur_event[33]]-%midi_file_pos_ticks[33]
        end if
        if ($_ticks_until_next_event34>0)
          wait(ticks_to_ms($_ticks_until_next_event34))
        end if
        if (%cur_event[33]>%num_midi_events[33])
          %playing[33] := 0
        end if
        if ($button_showMidi=0)
          %playing[33] := 0
        end if
        if (%playing[33]=1 and (%cb_id[33]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[33] := %midi_file_pos_ticks[33]+$_ticks_until_next_event34
          if (%_midi_command[1000*33+%cur_event[33]]=$MIDI_COMMAND_NOTE_ON)
            $_note34 := %_midi_byte_1[1000*33+%cur_event[33]]
            $_velocity34 := %_midi_byte_2[1000*33+%cur_event[33]]
            $_length34 := ticks_to_ms(%_midi_length[1000*33+%cur_event[33]])
            $_note_id36 := play_note($_note34,$_velocity34,0,$_length34)
            %custom_event_triggered_by_mf[$_note_id36 mod 1000000] := 33+1
            %custom_event_active[$_note_id36 mod 1000000] := 1
            %custom_event_source[$_note_id36 mod 1000000] := -1
            set_event_par_arr($_note_id36,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note34,1)
            %key_down[$_note34] := 1
            %velo[$_note34] := $_velocity34
            $_ks_index := search(%articulation_keyswitches,$_note34)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note34)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note34)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note34)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note34)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note34)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note34)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note34
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note34) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note34,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note34] := 1
              %key_timestamp[$_note34] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note34],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note34
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note34+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note34)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note34)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note34-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note34-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note34-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note34-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note34-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity34)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note34
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity34
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id36 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity34,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity34,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity34,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*33+%cur_event[33]]=$MIDI_COMMAND_CC)
            $_cc_num34 := %_midi_byte_1[1000*33+%cur_event[33]]
            set_controller($_cc_num34,%_midi_byte_2[1000*33+%cur_event[33]])
            wait(1)
            if ($_cc_num34=64)
              if (%CC[$_cc_num34]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num34]
            end if
            if ($_cc_num34=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num34])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[33])
        end if
        if (%cur_event[33]>%num_midi_events[33])
          %playing[33] := 0
        end if
        if ($button_showMidi=0)
          %playing[33] := 0
        end if
      end while
    end while
    if (%cb_id[33]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[33],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle34)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle34),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[34]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle34),$CONTROL_PAR_CURSOR_PICTURE,"clip title 34",(%clip_info_cursor[34]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[34]<15)
      inc(%clip_info_cursor[34])
    end if
  end if
end on

on ui_control($switch_preview34)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[34] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[34],$CONTROL_PAR_VALUE)=0)
    %playing[34] := 0
    %looping[34] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i35 := 0
    while ($_other_clip_i35<num_elements(%midi_clip_preview_id))
      if (34 # $_other_clip_i35)
        set_control_par(%midi_clip_preview_id[$_other_clip_i35],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i35]=1)
          %playing[$_other_clip_i35] := 0
          %looping[$_other_clip_i35] := 0
        end if
      end if
      inc($_other_clip_i35)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[34] := 1
    while (%looping[34]=1 and (%cb_id[34]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[34]=0)
        %looping[34] := 0
      end if
      if ($button_showMidi=0)
        %looping[34] := 0
      end if
      %cur_event[34] := 0
      %midi_file_pos_ticks[34] := 0
      %time_started[34] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[34] := 1
      while (%playing[34]=1 and (%cb_id[34]=$NI_CALLBACK_ID))
        if (%cur_event[34]=%num_midi_events[34])
          $_ticks_until_next_event35 := %clip_length[34]-%midi_file_pos_ticks[34]
        else
          $_ticks_until_next_event35 := %_midi_pos[1000*34+%cur_event[34]]-%midi_file_pos_ticks[34]
        end if
        if ($_ticks_until_next_event35>0)
          wait(ticks_to_ms($_ticks_until_next_event35))
        end if
        if (%cur_event[34]>%num_midi_events[34])
          %playing[34] := 0
        end if
        if ($button_showMidi=0)
          %playing[34] := 0
        end if
        if (%playing[34]=1 and (%cb_id[34]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[34] := %midi_file_pos_ticks[34]+$_ticks_until_next_event35
          if (%_midi_command[1000*34+%cur_event[34]]=$MIDI_COMMAND_NOTE_ON)
            $_note35 := %_midi_byte_1[1000*34+%cur_event[34]]
            $_velocity35 := %_midi_byte_2[1000*34+%cur_event[34]]
            $_length35 := ticks_to_ms(%_midi_length[1000*34+%cur_event[34]])
            $_note_id37 := play_note($_note35,$_velocity35,0,$_length35)
            %custom_event_triggered_by_mf[$_note_id37 mod 1000000] := 34+1
            %custom_event_active[$_note_id37 mod 1000000] := 1
            %custom_event_source[$_note_id37 mod 1000000] := -1
            set_event_par_arr($_note_id37,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note35,1)
            %key_down[$_note35] := 1
            %velo[$_note35] := $_velocity35
            $_ks_index := search(%articulation_keyswitches,$_note35)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note35)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note35)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note35)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note35)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note35)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note35)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note35
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note35) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note35,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note35] := 1
              %key_timestamp[$_note35] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note35],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note35
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note35+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note35)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note35)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note35-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note35-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note35-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note35-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note35-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity35)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note35
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity35
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id37 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity35,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity35,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity35,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*34+%cur_event[34]]=$MIDI_COMMAND_CC)
            $_cc_num35 := %_midi_byte_1[1000*34+%cur_event[34]]
            set_controller($_cc_num35,%_midi_byte_2[1000*34+%cur_event[34]])
            wait(1)
            if ($_cc_num35=64)
              if (%CC[$_cc_num35]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num35]
            end if
            if ($_cc_num35=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num35])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[34])
        end if
        if (%cur_event[34]>%num_midi_events[34])
          %playing[34] := 0
        end if
        if ($button_showMidi=0)
          %playing[34] := 0
        end if
      end while
    end while
    if (%cb_id[34]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[34],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle35)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle35),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[35]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle35),$CONTROL_PAR_CURSOR_PICTURE,"clip title 35",(%clip_info_cursor[35]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[35]<15)
      inc(%clip_info_cursor[35])
    end if
  end if
end on

on ui_control($switch_preview35)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[35] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[35],$CONTROL_PAR_VALUE)=0)
    %playing[35] := 0
    %looping[35] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i36 := 0
    while ($_other_clip_i36<num_elements(%midi_clip_preview_id))
      if (35 # $_other_clip_i36)
        set_control_par(%midi_clip_preview_id[$_other_clip_i36],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i36]=1)
          %playing[$_other_clip_i36] := 0
          %looping[$_other_clip_i36] := 0
        end if
      end if
      inc($_other_clip_i36)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[35] := 1
    while (%looping[35]=1 and (%cb_id[35]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[35]=0)
        %looping[35] := 0
      end if
      if ($button_showMidi=0)
        %looping[35] := 0
      end if
      %cur_event[35] := 0
      %midi_file_pos_ticks[35] := 0
      %time_started[35] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[35] := 1
      while (%playing[35]=1 and (%cb_id[35]=$NI_CALLBACK_ID))
        if (%cur_event[35]=%num_midi_events[35])
          $_ticks_until_next_event36 := %clip_length[35]-%midi_file_pos_ticks[35]
        else
          $_ticks_until_next_event36 := %_midi_pos[1000*35+%cur_event[35]]-%midi_file_pos_ticks[35]
        end if
        if ($_ticks_until_next_event36>0)
          wait(ticks_to_ms($_ticks_until_next_event36))
        end if
        if (%cur_event[35]>%num_midi_events[35])
          %playing[35] := 0
        end if
        if ($button_showMidi=0)
          %playing[35] := 0
        end if
        if (%playing[35]=1 and (%cb_id[35]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[35] := %midi_file_pos_ticks[35]+$_ticks_until_next_event36
          if (%_midi_command[1000*35+%cur_event[35]]=$MIDI_COMMAND_NOTE_ON)
            $_note36 := %_midi_byte_1[1000*35+%cur_event[35]]
            $_velocity36 := %_midi_byte_2[1000*35+%cur_event[35]]
            $_length36 := ticks_to_ms(%_midi_length[1000*35+%cur_event[35]])
            $_note_id38 := play_note($_note36,$_velocity36,0,$_length36)
            %custom_event_triggered_by_mf[$_note_id38 mod 1000000] := 35+1
            %custom_event_active[$_note_id38 mod 1000000] := 1
            %custom_event_source[$_note_id38 mod 1000000] := -1
            set_event_par_arr($_note_id38,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note36,1)
            %key_down[$_note36] := 1
            %velo[$_note36] := $_velocity36
            $_ks_index := search(%articulation_keyswitches,$_note36)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note36)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note36)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note36)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note36)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note36)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note36)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note36
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note36) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note36,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note36] := 1
              %key_timestamp[$_note36] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note36],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note36
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note36+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note36)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note36)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note36-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note36-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note36-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note36-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note36-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity36)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note36
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity36
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id38 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity36,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity36,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity36,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*35+%cur_event[35]]=$MIDI_COMMAND_CC)
            $_cc_num36 := %_midi_byte_1[1000*35+%cur_event[35]]
            set_controller($_cc_num36,%_midi_byte_2[1000*35+%cur_event[35]])
            wait(1)
            if ($_cc_num36=64)
              if (%CC[$_cc_num36]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num36]
            end if
            if ($_cc_num36=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num36])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[35])
        end if
        if (%cur_event[35]>%num_midi_events[35])
          %playing[35] := 0
        end if
        if ($button_showMidi=0)
          %playing[35] := 0
        end if
      end while
    end while
    if (%cb_id[35]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[35],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle36)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle36),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[36]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle36),$CONTROL_PAR_CURSOR_PICTURE,"clip title 36",(%clip_info_cursor[36]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[36]<15)
      inc(%clip_info_cursor[36])
    end if
  end if
end on

on ui_control($switch_preview36)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[36] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[36],$CONTROL_PAR_VALUE)=0)
    %playing[36] := 0
    %looping[36] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i37 := 0
    while ($_other_clip_i37<num_elements(%midi_clip_preview_id))
      if (36 # $_other_clip_i37)
        set_control_par(%midi_clip_preview_id[$_other_clip_i37],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i37]=1)
          %playing[$_other_clip_i37] := 0
          %looping[$_other_clip_i37] := 0
        end if
      end if
      inc($_other_clip_i37)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[36] := 1
    while (%looping[36]=1 and (%cb_id[36]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[36]=0)
        %looping[36] := 0
      end if
      if ($button_showMidi=0)
        %looping[36] := 0
      end if
      %cur_event[36] := 0
      %midi_file_pos_ticks[36] := 0
      %time_started[36] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[36] := 1
      while (%playing[36]=1 and (%cb_id[36]=$NI_CALLBACK_ID))
        if (%cur_event[36]=%num_midi_events[36])
          $_ticks_until_next_event37 := %clip_length[36]-%midi_file_pos_ticks[36]
        else
          $_ticks_until_next_event37 := %_midi_pos[1000*36+%cur_event[36]]-%midi_file_pos_ticks[36]
        end if
        if ($_ticks_until_next_event37>0)
          wait(ticks_to_ms($_ticks_until_next_event37))
        end if
        if (%cur_event[36]>%num_midi_events[36])
          %playing[36] := 0
        end if
        if ($button_showMidi=0)
          %playing[36] := 0
        end if
        if (%playing[36]=1 and (%cb_id[36]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[36] := %midi_file_pos_ticks[36]+$_ticks_until_next_event37
          if (%_midi_command[1000*36+%cur_event[36]]=$MIDI_COMMAND_NOTE_ON)
            $_note37 := %_midi_byte_1[1000*36+%cur_event[36]]
            $_velocity37 := %_midi_byte_2[1000*36+%cur_event[36]]
            $_length37 := ticks_to_ms(%_midi_length[1000*36+%cur_event[36]])
            $_note_id39 := play_note($_note37,$_velocity37,0,$_length37)
            %custom_event_triggered_by_mf[$_note_id39 mod 1000000] := 36+1
            %custom_event_active[$_note_id39 mod 1000000] := 1
            %custom_event_source[$_note_id39 mod 1000000] := -1
            set_event_par_arr($_note_id39,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note37,1)
            %key_down[$_note37] := 1
            %velo[$_note37] := $_velocity37
            $_ks_index := search(%articulation_keyswitches,$_note37)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note37)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note37)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note37)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note37)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note37)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note37)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note37
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note37) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note37,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note37] := 1
              %key_timestamp[$_note37] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note37],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note37
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note37+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note37)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note37)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note37-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note37-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note37-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note37-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note37-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity37)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note37
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity37
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id39 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity37,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity37,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity37,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*36+%cur_event[36]]=$MIDI_COMMAND_CC)
            $_cc_num37 := %_midi_byte_1[1000*36+%cur_event[36]]
            set_controller($_cc_num37,%_midi_byte_2[1000*36+%cur_event[36]])
            wait(1)
            if ($_cc_num37=64)
              if (%CC[$_cc_num37]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num37]
            end if
            if ($_cc_num37=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num37])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[36])
        end if
        if (%cur_event[36]>%num_midi_events[36])
          %playing[36] := 0
        end if
        if ($button_showMidi=0)
          %playing[36] := 0
        end if
      end while
    end while
    if (%cb_id[36]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[36],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle37)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle37),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[37]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle37),$CONTROL_PAR_CURSOR_PICTURE,"clip title 37",(%clip_info_cursor[37]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[37]<15)
      inc(%clip_info_cursor[37])
    end if
  end if
end on

on ui_control($switch_preview37)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[37] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[37],$CONTROL_PAR_VALUE)=0)
    %playing[37] := 0
    %looping[37] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i38 := 0
    while ($_other_clip_i38<num_elements(%midi_clip_preview_id))
      if (37 # $_other_clip_i38)
        set_control_par(%midi_clip_preview_id[$_other_clip_i38],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i38]=1)
          %playing[$_other_clip_i38] := 0
          %looping[$_other_clip_i38] := 0
        end if
      end if
      inc($_other_clip_i38)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[37] := 1
    while (%looping[37]=1 and (%cb_id[37]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[37]=0)
        %looping[37] := 0
      end if
      if ($button_showMidi=0)
        %looping[37] := 0
      end if
      %cur_event[37] := 0
      %midi_file_pos_ticks[37] := 0
      %time_started[37] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[37] := 1
      while (%playing[37]=1 and (%cb_id[37]=$NI_CALLBACK_ID))
        if (%cur_event[37]=%num_midi_events[37])
          $_ticks_until_next_event38 := %clip_length[37]-%midi_file_pos_ticks[37]
        else
          $_ticks_until_next_event38 := %_midi_pos[1000*37+%cur_event[37]]-%midi_file_pos_ticks[37]
        end if
        if ($_ticks_until_next_event38>0)
          wait(ticks_to_ms($_ticks_until_next_event38))
        end if
        if (%cur_event[37]>%num_midi_events[37])
          %playing[37] := 0
        end if
        if ($button_showMidi=0)
          %playing[37] := 0
        end if
        if (%playing[37]=1 and (%cb_id[37]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[37] := %midi_file_pos_ticks[37]+$_ticks_until_next_event38
          if (%_midi_command[1000*37+%cur_event[37]]=$MIDI_COMMAND_NOTE_ON)
            $_note38 := %_midi_byte_1[1000*37+%cur_event[37]]
            $_velocity38 := %_midi_byte_2[1000*37+%cur_event[37]]
            $_length38 := ticks_to_ms(%_midi_length[1000*37+%cur_event[37]])
            $_note_id40 := play_note($_note38,$_velocity38,0,$_length38)
            %custom_event_triggered_by_mf[$_note_id40 mod 1000000] := 37+1
            %custom_event_active[$_note_id40 mod 1000000] := 1
            %custom_event_source[$_note_id40 mod 1000000] := -1
            set_event_par_arr($_note_id40,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note38,1)
            %key_down[$_note38] := 1
            %velo[$_note38] := $_velocity38
            $_ks_index := search(%articulation_keyswitches,$_note38)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note38)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note38)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note38)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note38)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note38)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note38)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note38
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note38) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note38,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note38] := 1
              %key_timestamp[$_note38] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note38],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note38
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note38+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note38)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note38)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note38-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note38-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note38-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note38-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note38-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity38)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note38
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity38
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id40 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity38,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity38,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity38,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*37+%cur_event[37]]=$MIDI_COMMAND_CC)
            $_cc_num38 := %_midi_byte_1[1000*37+%cur_event[37]]
            set_controller($_cc_num38,%_midi_byte_2[1000*37+%cur_event[37]])
            wait(1)
            if ($_cc_num38=64)
              if (%CC[$_cc_num38]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num38]
            end if
            if ($_cc_num38=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num38])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[37])
        end if
        if (%cur_event[37]>%num_midi_events[37])
          %playing[37] := 0
        end if
        if ($button_showMidi=0)
          %playing[37] := 0
        end if
      end while
    end while
    if (%cb_id[37]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[37],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle38)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle38),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[38]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle38),$CONTROL_PAR_CURSOR_PICTURE,"clip title 38",(%clip_info_cursor[38]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[38]<15)
      inc(%clip_info_cursor[38])
    end if
  end if
end on

on ui_control($switch_preview38)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[38] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[38],$CONTROL_PAR_VALUE)=0)
    %playing[38] := 0
    %looping[38] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i39 := 0
    while ($_other_clip_i39<num_elements(%midi_clip_preview_id))
      if (38 # $_other_clip_i39)
        set_control_par(%midi_clip_preview_id[$_other_clip_i39],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i39]=1)
          %playing[$_other_clip_i39] := 0
          %looping[$_other_clip_i39] := 0
        end if
      end if
      inc($_other_clip_i39)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[38] := 1
    while (%looping[38]=1 and (%cb_id[38]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[38]=0)
        %looping[38] := 0
      end if
      if ($button_showMidi=0)
        %looping[38] := 0
      end if
      %cur_event[38] := 0
      %midi_file_pos_ticks[38] := 0
      %time_started[38] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[38] := 1
      while (%playing[38]=1 and (%cb_id[38]=$NI_CALLBACK_ID))
        if (%cur_event[38]=%num_midi_events[38])
          $_ticks_until_next_event39 := %clip_length[38]-%midi_file_pos_ticks[38]
        else
          $_ticks_until_next_event39 := %_midi_pos[1000*38+%cur_event[38]]-%midi_file_pos_ticks[38]
        end if
        if ($_ticks_until_next_event39>0)
          wait(ticks_to_ms($_ticks_until_next_event39))
        end if
        if (%cur_event[38]>%num_midi_events[38])
          %playing[38] := 0
        end if
        if ($button_showMidi=0)
          %playing[38] := 0
        end if
        if (%playing[38]=1 and (%cb_id[38]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[38] := %midi_file_pos_ticks[38]+$_ticks_until_next_event39
          if (%_midi_command[1000*38+%cur_event[38]]=$MIDI_COMMAND_NOTE_ON)
            $_note39 := %_midi_byte_1[1000*38+%cur_event[38]]
            $_velocity39 := %_midi_byte_2[1000*38+%cur_event[38]]
            $_length39 := ticks_to_ms(%_midi_length[1000*38+%cur_event[38]])
            $_note_id41 := play_note($_note39,$_velocity39,0,$_length39)
            %custom_event_triggered_by_mf[$_note_id41 mod 1000000] := 38+1
            %custom_event_active[$_note_id41 mod 1000000] := 1
            %custom_event_source[$_note_id41 mod 1000000] := -1
            set_event_par_arr($_note_id41,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note39,1)
            %key_down[$_note39] := 1
            %velo[$_note39] := $_velocity39
            $_ks_index := search(%articulation_keyswitches,$_note39)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note39)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note39)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note39)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note39)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note39)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note39)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note39
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note39) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note39,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note39] := 1
              %key_timestamp[$_note39] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note39],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note39
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note39+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note39)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note39)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note39-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note39-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note39-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note39-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note39-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity39)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note39
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity39
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id41 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity39,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity39,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity39,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*38+%cur_event[38]]=$MIDI_COMMAND_CC)
            $_cc_num39 := %_midi_byte_1[1000*38+%cur_event[38]]
            set_controller($_cc_num39,%_midi_byte_2[1000*38+%cur_event[38]])
            wait(1)
            if ($_cc_num39=64)
              if (%CC[$_cc_num39]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num39]
            end if
            if ($_cc_num39=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num39])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[38])
        end if
        if (%cur_event[38]>%num_midi_events[38])
          %playing[38] := 0
        end if
        if ($button_showMidi=0)
          %playing[38] := 0
        end if
      end while
    end while
    if (%cb_id[38]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[38],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle39)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle39),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[39]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle39),$CONTROL_PAR_CURSOR_PICTURE,"clip title 39",(%clip_info_cursor[39]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[39]<15)
      inc(%clip_info_cursor[39])
    end if
  end if
end on

on ui_control($switch_preview39)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[39] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[39],$CONTROL_PAR_VALUE)=0)
    %playing[39] := 0
    %looping[39] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i40 := 0
    while ($_other_clip_i40<num_elements(%midi_clip_preview_id))
      if (39 # $_other_clip_i40)
        set_control_par(%midi_clip_preview_id[$_other_clip_i40],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i40]=1)
          %playing[$_other_clip_i40] := 0
          %looping[$_other_clip_i40] := 0
        end if
      end if
      inc($_other_clip_i40)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[39] := 1
    while (%looping[39]=1 and (%cb_id[39]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[39]=0)
        %looping[39] := 0
      end if
      if ($button_showMidi=0)
        %looping[39] := 0
      end if
      %cur_event[39] := 0
      %midi_file_pos_ticks[39] := 0
      %time_started[39] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[39] := 1
      while (%playing[39]=1 and (%cb_id[39]=$NI_CALLBACK_ID))
        if (%cur_event[39]=%num_midi_events[39])
          $_ticks_until_next_event40 := %clip_length[39]-%midi_file_pos_ticks[39]
        else
          $_ticks_until_next_event40 := %_midi_pos[1000*39+%cur_event[39]]-%midi_file_pos_ticks[39]
        end if
        if ($_ticks_until_next_event40>0)
          wait(ticks_to_ms($_ticks_until_next_event40))
        end if
        if (%cur_event[39]>%num_midi_events[39])
          %playing[39] := 0
        end if
        if ($button_showMidi=0)
          %playing[39] := 0
        end if
        if (%playing[39]=1 and (%cb_id[39]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[39] := %midi_file_pos_ticks[39]+$_ticks_until_next_event40
          if (%_midi_command[1000*39+%cur_event[39]]=$MIDI_COMMAND_NOTE_ON)
            $_note40 := %_midi_byte_1[1000*39+%cur_event[39]]
            $_velocity40 := %_midi_byte_2[1000*39+%cur_event[39]]
            $_length40 := ticks_to_ms(%_midi_length[1000*39+%cur_event[39]])
            $_note_id42 := play_note($_note40,$_velocity40,0,$_length40)
            %custom_event_triggered_by_mf[$_note_id42 mod 1000000] := 39+1
            %custom_event_active[$_note_id42 mod 1000000] := 1
            %custom_event_source[$_note_id42 mod 1000000] := -1
            set_event_par_arr($_note_id42,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note40,1)
            %key_down[$_note40] := 1
            %velo[$_note40] := $_velocity40
            $_ks_index := search(%articulation_keyswitches,$_note40)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note40)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note40)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note40)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note40)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note40)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note40)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note40
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note40) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note40,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note40] := 1
              %key_timestamp[$_note40] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note40],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note40
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note40+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note40)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note40)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note40-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note40-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note40-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note40-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note40-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity40)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note40
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity40
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id42 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity40,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity40,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity40,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*39+%cur_event[39]]=$MIDI_COMMAND_CC)
            $_cc_num40 := %_midi_byte_1[1000*39+%cur_event[39]]
            set_controller($_cc_num40,%_midi_byte_2[1000*39+%cur_event[39]])
            wait(1)
            if ($_cc_num40=64)
              if (%CC[$_cc_num40]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num40]
            end if
            if ($_cc_num40=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num40])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[39])
        end if
        if (%cur_event[39]>%num_midi_events[39])
          %playing[39] := 0
        end if
        if ($button_showMidi=0)
          %playing[39] := 0
        end if
      end while
    end while
    if (%cb_id[39]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[39],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle40)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle40),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[40]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle40),$CONTROL_PAR_CURSOR_PICTURE,"clip title 40",(%clip_info_cursor[40]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[40]<15)
      inc(%clip_info_cursor[40])
    end if
  end if
end on

on ui_control($switch_preview40)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[40] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[40],$CONTROL_PAR_VALUE)=0)
    %playing[40] := 0
    %looping[40] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i41 := 0
    while ($_other_clip_i41<num_elements(%midi_clip_preview_id))
      if (40 # $_other_clip_i41)
        set_control_par(%midi_clip_preview_id[$_other_clip_i41],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i41]=1)
          %playing[$_other_clip_i41] := 0
          %looping[$_other_clip_i41] := 0
        end if
      end if
      inc($_other_clip_i41)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[40] := 1
    while (%looping[40]=1 and (%cb_id[40]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[40]=0)
        %looping[40] := 0
      end if
      if ($button_showMidi=0)
        %looping[40] := 0
      end if
      %cur_event[40] := 0
      %midi_file_pos_ticks[40] := 0
      %time_started[40] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[40] := 1
      while (%playing[40]=1 and (%cb_id[40]=$NI_CALLBACK_ID))
        if (%cur_event[40]=%num_midi_events[40])
          $_ticks_until_next_event41 := %clip_length[40]-%midi_file_pos_ticks[40]
        else
          $_ticks_until_next_event41 := %_midi_pos[1000*40+%cur_event[40]]-%midi_file_pos_ticks[40]
        end if
        if ($_ticks_until_next_event41>0)
          wait(ticks_to_ms($_ticks_until_next_event41))
        end if
        if (%cur_event[40]>%num_midi_events[40])
          %playing[40] := 0
        end if
        if ($button_showMidi=0)
          %playing[40] := 0
        end if
        if (%playing[40]=1 and (%cb_id[40]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[40] := %midi_file_pos_ticks[40]+$_ticks_until_next_event41
          if (%_midi_command[1000*40+%cur_event[40]]=$MIDI_COMMAND_NOTE_ON)
            $_note41 := %_midi_byte_1[1000*40+%cur_event[40]]
            $_velocity41 := %_midi_byte_2[1000*40+%cur_event[40]]
            $_length41 := ticks_to_ms(%_midi_length[1000*40+%cur_event[40]])
            $_note_id43 := play_note($_note41,$_velocity41,0,$_length41)
            %custom_event_triggered_by_mf[$_note_id43 mod 1000000] := 40+1
            %custom_event_active[$_note_id43 mod 1000000] := 1
            %custom_event_source[$_note_id43 mod 1000000] := -1
            set_event_par_arr($_note_id43,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note41,1)
            %key_down[$_note41] := 1
            %velo[$_note41] := $_velocity41
            $_ks_index := search(%articulation_keyswitches,$_note41)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note41)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note41)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note41)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note41)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note41)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note41)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note41
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note41) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note41,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note41] := 1
              %key_timestamp[$_note41] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note41],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note41
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note41+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note41)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note41)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note41-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note41-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note41-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note41-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note41-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity41)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note41
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity41
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id43 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity41,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity41,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity41,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*40+%cur_event[40]]=$MIDI_COMMAND_CC)
            $_cc_num41 := %_midi_byte_1[1000*40+%cur_event[40]]
            set_controller($_cc_num41,%_midi_byte_2[1000*40+%cur_event[40]])
            wait(1)
            if ($_cc_num41=64)
              if (%CC[$_cc_num41]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num41]
            end if
            if ($_cc_num41=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num41])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[40])
        end if
        if (%cur_event[40]>%num_midi_events[40])
          %playing[40] := 0
        end if
        if ($button_showMidi=0)
          %playing[40] := 0
        end if
      end while
    end while
    if (%cb_id[40]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[40],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle41)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle41),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[41]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle41),$CONTROL_PAR_CURSOR_PICTURE,"clip title 41",(%clip_info_cursor[41]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[41]<15)
      inc(%clip_info_cursor[41])
    end if
  end if
end on

on ui_control($switch_preview41)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[41] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[41],$CONTROL_PAR_VALUE)=0)
    %playing[41] := 0
    %looping[41] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i42 := 0
    while ($_other_clip_i42<num_elements(%midi_clip_preview_id))
      if (41 # $_other_clip_i42)
        set_control_par(%midi_clip_preview_id[$_other_clip_i42],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i42]=1)
          %playing[$_other_clip_i42] := 0
          %looping[$_other_clip_i42] := 0
        end if
      end if
      inc($_other_clip_i42)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[41] := 1
    while (%looping[41]=1 and (%cb_id[41]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[41]=0)
        %looping[41] := 0
      end if
      if ($button_showMidi=0)
        %looping[41] := 0
      end if
      %cur_event[41] := 0
      %midi_file_pos_ticks[41] := 0
      %time_started[41] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[41] := 1
      while (%playing[41]=1 and (%cb_id[41]=$NI_CALLBACK_ID))
        if (%cur_event[41]=%num_midi_events[41])
          $_ticks_until_next_event42 := %clip_length[41]-%midi_file_pos_ticks[41]
        else
          $_ticks_until_next_event42 := %_midi_pos[1000*41+%cur_event[41]]-%midi_file_pos_ticks[41]
        end if
        if ($_ticks_until_next_event42>0)
          wait(ticks_to_ms($_ticks_until_next_event42))
        end if
        if (%cur_event[41]>%num_midi_events[41])
          %playing[41] := 0
        end if
        if ($button_showMidi=0)
          %playing[41] := 0
        end if
        if (%playing[41]=1 and (%cb_id[41]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[41] := %midi_file_pos_ticks[41]+$_ticks_until_next_event42
          if (%_midi_command[1000*41+%cur_event[41]]=$MIDI_COMMAND_NOTE_ON)
            $_note42 := %_midi_byte_1[1000*41+%cur_event[41]]
            $_velocity42 := %_midi_byte_2[1000*41+%cur_event[41]]
            $_length42 := ticks_to_ms(%_midi_length[1000*41+%cur_event[41]])
            $_note_id44 := play_note($_note42,$_velocity42,0,$_length42)
            %custom_event_triggered_by_mf[$_note_id44 mod 1000000] := 41+1
            %custom_event_active[$_note_id44 mod 1000000] := 1
            %custom_event_source[$_note_id44 mod 1000000] := -1
            set_event_par_arr($_note_id44,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note42,1)
            %key_down[$_note42] := 1
            %velo[$_note42] := $_velocity42
            $_ks_index := search(%articulation_keyswitches,$_note42)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note42)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note42)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note42)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note42)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note42)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note42)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note42
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note42) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note42,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note42] := 1
              %key_timestamp[$_note42] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note42],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note42
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note42+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note42)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note42)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note42-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note42-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note42-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note42-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note42-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity42)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note42
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity42
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id44 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity42,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity42,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity42,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*41+%cur_event[41]]=$MIDI_COMMAND_CC)
            $_cc_num42 := %_midi_byte_1[1000*41+%cur_event[41]]
            set_controller($_cc_num42,%_midi_byte_2[1000*41+%cur_event[41]])
            wait(1)
            if ($_cc_num42=64)
              if (%CC[$_cc_num42]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num42]
            end if
            if ($_cc_num42=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num42])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[41])
        end if
        if (%cur_event[41]>%num_midi_events[41])
          %playing[41] := 0
        end if
        if ($button_showMidi=0)
          %playing[41] := 0
        end if
      end while
    end while
    if (%cb_id[41]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[41],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle42)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle42),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[42]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle42),$CONTROL_PAR_CURSOR_PICTURE,"clip title 42",(%clip_info_cursor[42]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[42]<15)
      inc(%clip_info_cursor[42])
    end if
  end if
end on

on ui_control($switch_preview42)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[42] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[42],$CONTROL_PAR_VALUE)=0)
    %playing[42] := 0
    %looping[42] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i43 := 0
    while ($_other_clip_i43<num_elements(%midi_clip_preview_id))
      if (42 # $_other_clip_i43)
        set_control_par(%midi_clip_preview_id[$_other_clip_i43],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i43]=1)
          %playing[$_other_clip_i43] := 0
          %looping[$_other_clip_i43] := 0
        end if
      end if
      inc($_other_clip_i43)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[42] := 1
    while (%looping[42]=1 and (%cb_id[42]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[42]=0)
        %looping[42] := 0
      end if
      if ($button_showMidi=0)
        %looping[42] := 0
      end if
      %cur_event[42] := 0
      %midi_file_pos_ticks[42] := 0
      %time_started[42] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[42] := 1
      while (%playing[42]=1 and (%cb_id[42]=$NI_CALLBACK_ID))
        if (%cur_event[42]=%num_midi_events[42])
          $_ticks_until_next_event43 := %clip_length[42]-%midi_file_pos_ticks[42]
        else
          $_ticks_until_next_event43 := %_midi_pos[1000*42+%cur_event[42]]-%midi_file_pos_ticks[42]
        end if
        if ($_ticks_until_next_event43>0)
          wait(ticks_to_ms($_ticks_until_next_event43))
        end if
        if (%cur_event[42]>%num_midi_events[42])
          %playing[42] := 0
        end if
        if ($button_showMidi=0)
          %playing[42] := 0
        end if
        if (%playing[42]=1 and (%cb_id[42]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[42] := %midi_file_pos_ticks[42]+$_ticks_until_next_event43
          if (%_midi_command[1000*42+%cur_event[42]]=$MIDI_COMMAND_NOTE_ON)
            $_note43 := %_midi_byte_1[1000*42+%cur_event[42]]
            $_velocity43 := %_midi_byte_2[1000*42+%cur_event[42]]
            $_length43 := ticks_to_ms(%_midi_length[1000*42+%cur_event[42]])
            $_note_id45 := play_note($_note43,$_velocity43,0,$_length43)
            %custom_event_triggered_by_mf[$_note_id45 mod 1000000] := 42+1
            %custom_event_active[$_note_id45 mod 1000000] := 1
            %custom_event_source[$_note_id45 mod 1000000] := -1
            set_event_par_arr($_note_id45,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note43,1)
            %key_down[$_note43] := 1
            %velo[$_note43] := $_velocity43
            $_ks_index := search(%articulation_keyswitches,$_note43)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note43)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note43)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note43)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note43)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note43)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note43)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note43
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note43) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note43,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note43] := 1
              %key_timestamp[$_note43] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note43],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note43
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note43+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note43)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note43)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note43-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note43-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note43-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note43-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note43-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity43)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note43
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity43
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id45 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity43,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity43,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity43,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*42+%cur_event[42]]=$MIDI_COMMAND_CC)
            $_cc_num43 := %_midi_byte_1[1000*42+%cur_event[42]]
            set_controller($_cc_num43,%_midi_byte_2[1000*42+%cur_event[42]])
            wait(1)
            if ($_cc_num43=64)
              if (%CC[$_cc_num43]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num43]
            end if
            if ($_cc_num43=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num43])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[42])
        end if
        if (%cur_event[42]>%num_midi_events[42])
          %playing[42] := 0
        end if
        if ($button_showMidi=0)
          %playing[42] := 0
        end if
      end while
    end while
    if (%cb_id[42]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[42],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle43)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle43),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[43]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle43),$CONTROL_PAR_CURSOR_PICTURE,"clip title 43",(%clip_info_cursor[43]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[43]<15)
      inc(%clip_info_cursor[43])
    end if
  end if
end on

on ui_control($switch_preview43)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[43] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[43],$CONTROL_PAR_VALUE)=0)
    %playing[43] := 0
    %looping[43] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i44 := 0
    while ($_other_clip_i44<num_elements(%midi_clip_preview_id))
      if (43 # $_other_clip_i44)
        set_control_par(%midi_clip_preview_id[$_other_clip_i44],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i44]=1)
          %playing[$_other_clip_i44] := 0
          %looping[$_other_clip_i44] := 0
        end if
      end if
      inc($_other_clip_i44)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[43] := 1
    while (%looping[43]=1 and (%cb_id[43]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[43]=0)
        %looping[43] := 0
      end if
      if ($button_showMidi=0)
        %looping[43] := 0
      end if
      %cur_event[43] := 0
      %midi_file_pos_ticks[43] := 0
      %time_started[43] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[43] := 1
      while (%playing[43]=1 and (%cb_id[43]=$NI_CALLBACK_ID))
        if (%cur_event[43]=%num_midi_events[43])
          $_ticks_until_next_event44 := %clip_length[43]-%midi_file_pos_ticks[43]
        else
          $_ticks_until_next_event44 := %_midi_pos[1000*43+%cur_event[43]]-%midi_file_pos_ticks[43]
        end if
        if ($_ticks_until_next_event44>0)
          wait(ticks_to_ms($_ticks_until_next_event44))
        end if
        if (%cur_event[43]>%num_midi_events[43])
          %playing[43] := 0
        end if
        if ($button_showMidi=0)
          %playing[43] := 0
        end if
        if (%playing[43]=1 and (%cb_id[43]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[43] := %midi_file_pos_ticks[43]+$_ticks_until_next_event44
          if (%_midi_command[1000*43+%cur_event[43]]=$MIDI_COMMAND_NOTE_ON)
            $_note44 := %_midi_byte_1[1000*43+%cur_event[43]]
            $_velocity44 := %_midi_byte_2[1000*43+%cur_event[43]]
            $_length44 := ticks_to_ms(%_midi_length[1000*43+%cur_event[43]])
            $_note_id46 := play_note($_note44,$_velocity44,0,$_length44)
            %custom_event_triggered_by_mf[$_note_id46 mod 1000000] := 43+1
            %custom_event_active[$_note_id46 mod 1000000] := 1
            %custom_event_source[$_note_id46 mod 1000000] := -1
            set_event_par_arr($_note_id46,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note44,1)
            %key_down[$_note44] := 1
            %velo[$_note44] := $_velocity44
            $_ks_index := search(%articulation_keyswitches,$_note44)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note44)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note44)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note44)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note44)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note44)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note44)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note44
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note44) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note44,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note44] := 1
              %key_timestamp[$_note44] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note44],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note44
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note44+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note44)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note44)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note44-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note44-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note44-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note44-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note44-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity44)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note44
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity44
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id46 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity44,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity44,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity44,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*43+%cur_event[43]]=$MIDI_COMMAND_CC)
            $_cc_num44 := %_midi_byte_1[1000*43+%cur_event[43]]
            set_controller($_cc_num44,%_midi_byte_2[1000*43+%cur_event[43]])
            wait(1)
            if ($_cc_num44=64)
              if (%CC[$_cc_num44]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num44]
            end if
            if ($_cc_num44=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num44])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[43])
        end if
        if (%cur_event[43]>%num_midi_events[43])
          %playing[43] := 0
        end if
        if ($button_showMidi=0)
          %playing[43] := 0
        end if
      end while
    end while
    if (%cb_id[43]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[43],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle44)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle44),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[44]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle44),$CONTROL_PAR_CURSOR_PICTURE,"clip title 44",(%clip_info_cursor[44]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[44]<15)
      inc(%clip_info_cursor[44])
    end if
  end if
end on

on ui_control($switch_preview44)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[44] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[44],$CONTROL_PAR_VALUE)=0)
    %playing[44] := 0
    %looping[44] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i45 := 0
    while ($_other_clip_i45<num_elements(%midi_clip_preview_id))
      if (44 # $_other_clip_i45)
        set_control_par(%midi_clip_preview_id[$_other_clip_i45],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i45]=1)
          %playing[$_other_clip_i45] := 0
          %looping[$_other_clip_i45] := 0
        end if
      end if
      inc($_other_clip_i45)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[44] := 1
    while (%looping[44]=1 and (%cb_id[44]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[44]=0)
        %looping[44] := 0
      end if
      if ($button_showMidi=0)
        %looping[44] := 0
      end if
      %cur_event[44] := 0
      %midi_file_pos_ticks[44] := 0
      %time_started[44] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[44] := 1
      while (%playing[44]=1 and (%cb_id[44]=$NI_CALLBACK_ID))
        if (%cur_event[44]=%num_midi_events[44])
          $_ticks_until_next_event45 := %clip_length[44]-%midi_file_pos_ticks[44]
        else
          $_ticks_until_next_event45 := %_midi_pos[1000*44+%cur_event[44]]-%midi_file_pos_ticks[44]
        end if
        if ($_ticks_until_next_event45>0)
          wait(ticks_to_ms($_ticks_until_next_event45))
        end if
        if (%cur_event[44]>%num_midi_events[44])
          %playing[44] := 0
        end if
        if ($button_showMidi=0)
          %playing[44] := 0
        end if
        if (%playing[44]=1 and (%cb_id[44]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[44] := %midi_file_pos_ticks[44]+$_ticks_until_next_event45
          if (%_midi_command[1000*44+%cur_event[44]]=$MIDI_COMMAND_NOTE_ON)
            $_note45 := %_midi_byte_1[1000*44+%cur_event[44]]
            $_velocity45 := %_midi_byte_2[1000*44+%cur_event[44]]
            $_length45 := ticks_to_ms(%_midi_length[1000*44+%cur_event[44]])
            $_note_id47 := play_note($_note45,$_velocity45,0,$_length45)
            %custom_event_triggered_by_mf[$_note_id47 mod 1000000] := 44+1
            %custom_event_active[$_note_id47 mod 1000000] := 1
            %custom_event_source[$_note_id47 mod 1000000] := -1
            set_event_par_arr($_note_id47,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note45,1)
            %key_down[$_note45] := 1
            %velo[$_note45] := $_velocity45
            $_ks_index := search(%articulation_keyswitches,$_note45)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note45)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note45)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note45)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note45)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note45)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note45)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note45
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note45) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note45,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note45] := 1
              %key_timestamp[$_note45] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note45],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note45
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note45+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note45)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note45)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note45-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note45-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note45-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note45-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note45-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity45)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note45
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity45
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id47 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity45,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity45,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity45,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*44+%cur_event[44]]=$MIDI_COMMAND_CC)
            $_cc_num45 := %_midi_byte_1[1000*44+%cur_event[44]]
            set_controller($_cc_num45,%_midi_byte_2[1000*44+%cur_event[44]])
            wait(1)
            if ($_cc_num45=64)
              if (%CC[$_cc_num45]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num45]
            end if
            if ($_cc_num45=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num45])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[44])
        end if
        if (%cur_event[44]>%num_midi_events[44])
          %playing[44] := 0
        end if
        if ($button_showMidi=0)
          %playing[44] := 0
        end if
      end while
    end while
    if (%cb_id[44]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[44],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle45)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle45),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[45]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle45),$CONTROL_PAR_CURSOR_PICTURE,"clip title 45",(%clip_info_cursor[45]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[45]<15)
      inc(%clip_info_cursor[45])
    end if
  end if
end on

on ui_control($switch_preview45)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[45] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[45],$CONTROL_PAR_VALUE)=0)
    %playing[45] := 0
    %looping[45] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i46 := 0
    while ($_other_clip_i46<num_elements(%midi_clip_preview_id))
      if (45 # $_other_clip_i46)
        set_control_par(%midi_clip_preview_id[$_other_clip_i46],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i46]=1)
          %playing[$_other_clip_i46] := 0
          %looping[$_other_clip_i46] := 0
        end if
      end if
      inc($_other_clip_i46)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[45] := 1
    while (%looping[45]=1 and (%cb_id[45]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[45]=0)
        %looping[45] := 0
      end if
      if ($button_showMidi=0)
        %looping[45] := 0
      end if
      %cur_event[45] := 0
      %midi_file_pos_ticks[45] := 0
      %time_started[45] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[45] := 1
      while (%playing[45]=1 and (%cb_id[45]=$NI_CALLBACK_ID))
        if (%cur_event[45]=%num_midi_events[45])
          $_ticks_until_next_event46 := %clip_length[45]-%midi_file_pos_ticks[45]
        else
          $_ticks_until_next_event46 := %_midi_pos[1000*45+%cur_event[45]]-%midi_file_pos_ticks[45]
        end if
        if ($_ticks_until_next_event46>0)
          wait(ticks_to_ms($_ticks_until_next_event46))
        end if
        if (%cur_event[45]>%num_midi_events[45])
          %playing[45] := 0
        end if
        if ($button_showMidi=0)
          %playing[45] := 0
        end if
        if (%playing[45]=1 and (%cb_id[45]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[45] := %midi_file_pos_ticks[45]+$_ticks_until_next_event46
          if (%_midi_command[1000*45+%cur_event[45]]=$MIDI_COMMAND_NOTE_ON)
            $_note46 := %_midi_byte_1[1000*45+%cur_event[45]]
            $_velocity46 := %_midi_byte_2[1000*45+%cur_event[45]]
            $_length46 := ticks_to_ms(%_midi_length[1000*45+%cur_event[45]])
            $_note_id48 := play_note($_note46,$_velocity46,0,$_length46)
            %custom_event_triggered_by_mf[$_note_id48 mod 1000000] := 45+1
            %custom_event_active[$_note_id48 mod 1000000] := 1
            %custom_event_source[$_note_id48 mod 1000000] := -1
            set_event_par_arr($_note_id48,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note46,1)
            %key_down[$_note46] := 1
            %velo[$_note46] := $_velocity46
            $_ks_index := search(%articulation_keyswitches,$_note46)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note46)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note46)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note46)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note46)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note46)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note46)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note46
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note46) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note46,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note46] := 1
              %key_timestamp[$_note46] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note46],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note46
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note46+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note46)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note46)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note46-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note46-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note46-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note46-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note46-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity46)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note46
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity46
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id48 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity46,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity46,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity46,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*45+%cur_event[45]]=$MIDI_COMMAND_CC)
            $_cc_num46 := %_midi_byte_1[1000*45+%cur_event[45]]
            set_controller($_cc_num46,%_midi_byte_2[1000*45+%cur_event[45]])
            wait(1)
            if ($_cc_num46=64)
              if (%CC[$_cc_num46]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num46]
            end if
            if ($_cc_num46=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num46])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[45])
        end if
        if (%cur_event[45]>%num_midi_events[45])
          %playing[45] := 0
        end if
        if ($button_showMidi=0)
          %playing[45] := 0
        end if
      end while
    end while
    if (%cb_id[45]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[45],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle46)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle46),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[46]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle46),$CONTROL_PAR_CURSOR_PICTURE,"clip title 46",(%clip_info_cursor[46]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[46]<15)
      inc(%clip_info_cursor[46])
    end if
  end if
end on

on ui_control($switch_preview46)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[46] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[46],$CONTROL_PAR_VALUE)=0)
    %playing[46] := 0
    %looping[46] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i47 := 0
    while ($_other_clip_i47<num_elements(%midi_clip_preview_id))
      if (46 # $_other_clip_i47)
        set_control_par(%midi_clip_preview_id[$_other_clip_i47],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i47]=1)
          %playing[$_other_clip_i47] := 0
          %looping[$_other_clip_i47] := 0
        end if
      end if
      inc($_other_clip_i47)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[46] := 1
    while (%looping[46]=1 and (%cb_id[46]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[46]=0)
        %looping[46] := 0
      end if
      if ($button_showMidi=0)
        %looping[46] := 0
      end if
      %cur_event[46] := 0
      %midi_file_pos_ticks[46] := 0
      %time_started[46] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[46] := 1
      while (%playing[46]=1 and (%cb_id[46]=$NI_CALLBACK_ID))
        if (%cur_event[46]=%num_midi_events[46])
          $_ticks_until_next_event47 := %clip_length[46]-%midi_file_pos_ticks[46]
        else
          $_ticks_until_next_event47 := %_midi_pos[1000*46+%cur_event[46]]-%midi_file_pos_ticks[46]
        end if
        if ($_ticks_until_next_event47>0)
          wait(ticks_to_ms($_ticks_until_next_event47))
        end if
        if (%cur_event[46]>%num_midi_events[46])
          %playing[46] := 0
        end if
        if ($button_showMidi=0)
          %playing[46] := 0
        end if
        if (%playing[46]=1 and (%cb_id[46]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[46] := %midi_file_pos_ticks[46]+$_ticks_until_next_event47
          if (%_midi_command[1000*46+%cur_event[46]]=$MIDI_COMMAND_NOTE_ON)
            $_note47 := %_midi_byte_1[1000*46+%cur_event[46]]
            $_velocity47 := %_midi_byte_2[1000*46+%cur_event[46]]
            $_length47 := ticks_to_ms(%_midi_length[1000*46+%cur_event[46]])
            $_note_id49 := play_note($_note47,$_velocity47,0,$_length47)
            %custom_event_triggered_by_mf[$_note_id49 mod 1000000] := 46+1
            %custom_event_active[$_note_id49 mod 1000000] := 1
            %custom_event_source[$_note_id49 mod 1000000] := -1
            set_event_par_arr($_note_id49,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note47,1)
            %key_down[$_note47] := 1
            %velo[$_note47] := $_velocity47
            $_ks_index := search(%articulation_keyswitches,$_note47)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note47)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note47)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note47)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note47)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note47)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note47)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note47
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note47) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note47,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note47] := 1
              %key_timestamp[$_note47] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note47],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note47
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note47+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note47)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note47)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note47-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note47-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note47-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note47-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note47-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity47)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note47
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity47
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id49 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity47,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity47,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity47,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*46+%cur_event[46]]=$MIDI_COMMAND_CC)
            $_cc_num47 := %_midi_byte_1[1000*46+%cur_event[46]]
            set_controller($_cc_num47,%_midi_byte_2[1000*46+%cur_event[46]])
            wait(1)
            if ($_cc_num47=64)
              if (%CC[$_cc_num47]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num47]
            end if
            if ($_cc_num47=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num47])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[46])
        end if
        if (%cur_event[46]>%num_midi_events[46])
          %playing[46] := 0
        end if
        if ($button_showMidi=0)
          %playing[46] := 0
        end if
      end while
    end while
    if (%cb_id[46]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[46],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle47)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle47),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[47]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle47),$CONTROL_PAR_CURSOR_PICTURE,"clip title 47",(%clip_info_cursor[47]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[47]<15)
      inc(%clip_info_cursor[47])
    end if
  end if
end on

on ui_control($switch_preview47)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[47] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[47],$CONTROL_PAR_VALUE)=0)
    %playing[47] := 0
    %looping[47] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i48 := 0
    while ($_other_clip_i48<num_elements(%midi_clip_preview_id))
      if (47 # $_other_clip_i48)
        set_control_par(%midi_clip_preview_id[$_other_clip_i48],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i48]=1)
          %playing[$_other_clip_i48] := 0
          %looping[$_other_clip_i48] := 0
        end if
      end if
      inc($_other_clip_i48)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[47] := 1
    while (%looping[47]=1 and (%cb_id[47]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[47]=0)
        %looping[47] := 0
      end if
      if ($button_showMidi=0)
        %looping[47] := 0
      end if
      %cur_event[47] := 0
      %midi_file_pos_ticks[47] := 0
      %time_started[47] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[47] := 1
      while (%playing[47]=1 and (%cb_id[47]=$NI_CALLBACK_ID))
        if (%cur_event[47]=%num_midi_events[47])
          $_ticks_until_next_event48 := %clip_length[47]-%midi_file_pos_ticks[47]
        else
          $_ticks_until_next_event48 := %_midi_pos[1000*47+%cur_event[47]]-%midi_file_pos_ticks[47]
        end if
        if ($_ticks_until_next_event48>0)
          wait(ticks_to_ms($_ticks_until_next_event48))
        end if
        if (%cur_event[47]>%num_midi_events[47])
          %playing[47] := 0
        end if
        if ($button_showMidi=0)
          %playing[47] := 0
        end if
        if (%playing[47]=1 and (%cb_id[47]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[47] := %midi_file_pos_ticks[47]+$_ticks_until_next_event48
          if (%_midi_command[1000*47+%cur_event[47]]=$MIDI_COMMAND_NOTE_ON)
            $_note48 := %_midi_byte_1[1000*47+%cur_event[47]]
            $_velocity48 := %_midi_byte_2[1000*47+%cur_event[47]]
            $_length48 := ticks_to_ms(%_midi_length[1000*47+%cur_event[47]])
            $_note_id50 := play_note($_note48,$_velocity48,0,$_length48)
            %custom_event_triggered_by_mf[$_note_id50 mod 1000000] := 47+1
            %custom_event_active[$_note_id50 mod 1000000] := 1
            %custom_event_source[$_note_id50 mod 1000000] := -1
            set_event_par_arr($_note_id50,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note48,1)
            %key_down[$_note48] := 1
            %velo[$_note48] := $_velocity48
            $_ks_index := search(%articulation_keyswitches,$_note48)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note48)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note48)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note48)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note48)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note48)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note48)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note48
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note48) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note48,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note48] := 1
              %key_timestamp[$_note48] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note48],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note48
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note48+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note48)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note48)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note48-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note48-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note48-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note48-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note48-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity48)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note48
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity48
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id50 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity48,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity48,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity48,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*47+%cur_event[47]]=$MIDI_COMMAND_CC)
            $_cc_num48 := %_midi_byte_1[1000*47+%cur_event[47]]
            set_controller($_cc_num48,%_midi_byte_2[1000*47+%cur_event[47]])
            wait(1)
            if ($_cc_num48=64)
              if (%CC[$_cc_num48]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num48]
            end if
            if ($_cc_num48=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num48])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[47])
        end if
        if (%cur_event[47]>%num_midi_events[47])
          %playing[47] := 0
        end if
        if ($button_showMidi=0)
          %playing[47] := 0
        end if
      end while
    end while
    if (%cb_id[47]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[47],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle48)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle48),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[48]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle48),$CONTROL_PAR_CURSOR_PICTURE,"clip title 48",(%clip_info_cursor[48]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[48]<15)
      inc(%clip_info_cursor[48])
    end if
  end if
end on

on ui_control($switch_preview48)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[48] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[48],$CONTROL_PAR_VALUE)=0)
    %playing[48] := 0
    %looping[48] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i49 := 0
    while ($_other_clip_i49<num_elements(%midi_clip_preview_id))
      if (48 # $_other_clip_i49)
        set_control_par(%midi_clip_preview_id[$_other_clip_i49],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i49]=1)
          %playing[$_other_clip_i49] := 0
          %looping[$_other_clip_i49] := 0
        end if
      end if
      inc($_other_clip_i49)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[48] := 1
    while (%looping[48]=1 and (%cb_id[48]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[48]=0)
        %looping[48] := 0
      end if
      if ($button_showMidi=0)
        %looping[48] := 0
      end if
      %cur_event[48] := 0
      %midi_file_pos_ticks[48] := 0
      %time_started[48] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[48] := 1
      while (%playing[48]=1 and (%cb_id[48]=$NI_CALLBACK_ID))
        if (%cur_event[48]=%num_midi_events[48])
          $_ticks_until_next_event49 := %clip_length[48]-%midi_file_pos_ticks[48]
        else
          $_ticks_until_next_event49 := %_midi_pos[1000*48+%cur_event[48]]-%midi_file_pos_ticks[48]
        end if
        if ($_ticks_until_next_event49>0)
          wait(ticks_to_ms($_ticks_until_next_event49))
        end if
        if (%cur_event[48]>%num_midi_events[48])
          %playing[48] := 0
        end if
        if ($button_showMidi=0)
          %playing[48] := 0
        end if
        if (%playing[48]=1 and (%cb_id[48]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[48] := %midi_file_pos_ticks[48]+$_ticks_until_next_event49
          if (%_midi_command[1000*48+%cur_event[48]]=$MIDI_COMMAND_NOTE_ON)
            $_note49 := %_midi_byte_1[1000*48+%cur_event[48]]
            $_velocity49 := %_midi_byte_2[1000*48+%cur_event[48]]
            $_length49 := ticks_to_ms(%_midi_length[1000*48+%cur_event[48]])
            $_note_id51 := play_note($_note49,$_velocity49,0,$_length49)
            %custom_event_triggered_by_mf[$_note_id51 mod 1000000] := 48+1
            %custom_event_active[$_note_id51 mod 1000000] := 1
            %custom_event_source[$_note_id51 mod 1000000] := -1
            set_event_par_arr($_note_id51,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note49,1)
            %key_down[$_note49] := 1
            %velo[$_note49] := $_velocity49
            $_ks_index := search(%articulation_keyswitches,$_note49)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note49)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note49)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note49)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note49)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note49)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note49)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note49
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note49) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note49,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note49] := 1
              %key_timestamp[$_note49] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note49],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note49
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note49+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note49)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note49)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note49-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note49-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note49-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note49-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note49-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity49)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note49
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity49
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id51 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity49,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity49,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity49,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*48+%cur_event[48]]=$MIDI_COMMAND_CC)
            $_cc_num49 := %_midi_byte_1[1000*48+%cur_event[48]]
            set_controller($_cc_num49,%_midi_byte_2[1000*48+%cur_event[48]])
            wait(1)
            if ($_cc_num49=64)
              if (%CC[$_cc_num49]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num49]
            end if
            if ($_cc_num49=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num49])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[48])
        end if
        if (%cur_event[48]>%num_midi_events[48])
          %playing[48] := 0
        end if
        if ($button_showMidi=0)
          %playing[48] := 0
        end if
      end while
    end while
    if (%cb_id[48]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[48],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle49)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle49),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[49]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle49),$CONTROL_PAR_CURSOR_PICTURE,"clip title 49",(%clip_info_cursor[49]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[49]<15)
      inc(%clip_info_cursor[49])
    end if
  end if
end on

on ui_control($switch_preview49)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[49] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[49],$CONTROL_PAR_VALUE)=0)
    %playing[49] := 0
    %looping[49] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i50 := 0
    while ($_other_clip_i50<num_elements(%midi_clip_preview_id))
      if (49 # $_other_clip_i50)
        set_control_par(%midi_clip_preview_id[$_other_clip_i50],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i50]=1)
          %playing[$_other_clip_i50] := 0
          %looping[$_other_clip_i50] := 0
        end if
      end if
      inc($_other_clip_i50)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[49] := 1
    while (%looping[49]=1 and (%cb_id[49]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[49]=0)
        %looping[49] := 0
      end if
      if ($button_showMidi=0)
        %looping[49] := 0
      end if
      %cur_event[49] := 0
      %midi_file_pos_ticks[49] := 0
      %time_started[49] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[49] := 1
      while (%playing[49]=1 and (%cb_id[49]=$NI_CALLBACK_ID))
        if (%cur_event[49]=%num_midi_events[49])
          $_ticks_until_next_event50 := %clip_length[49]-%midi_file_pos_ticks[49]
        else
          $_ticks_until_next_event50 := %_midi_pos[1000*49+%cur_event[49]]-%midi_file_pos_ticks[49]
        end if
        if ($_ticks_until_next_event50>0)
          wait(ticks_to_ms($_ticks_until_next_event50))
        end if
        if (%cur_event[49]>%num_midi_events[49])
          %playing[49] := 0
        end if
        if ($button_showMidi=0)
          %playing[49] := 0
        end if
        if (%playing[49]=1 and (%cb_id[49]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[49] := %midi_file_pos_ticks[49]+$_ticks_until_next_event50
          if (%_midi_command[1000*49+%cur_event[49]]=$MIDI_COMMAND_NOTE_ON)
            $_note50 := %_midi_byte_1[1000*49+%cur_event[49]]
            $_velocity50 := %_midi_byte_2[1000*49+%cur_event[49]]
            $_length50 := ticks_to_ms(%_midi_length[1000*49+%cur_event[49]])
            $_note_id52 := play_note($_note50,$_velocity50,0,$_length50)
            %custom_event_triggered_by_mf[$_note_id52 mod 1000000] := 49+1
            %custom_event_active[$_note_id52 mod 1000000] := 1
            %custom_event_source[$_note_id52 mod 1000000] := -1
            set_event_par_arr($_note_id52,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note50,1)
            %key_down[$_note50] := 1
            %velo[$_note50] := $_velocity50
            $_ks_index := search(%articulation_keyswitches,$_note50)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note50)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note50)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note50)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note50)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note50)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note50)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note50
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note50) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note50,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note50] := 1
              %key_timestamp[$_note50] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note50],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note50
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note50+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note50)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note50)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note50-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note50-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note50-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note50-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note50-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity50)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note50
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity50
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id52 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity50,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity50,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity50,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*49+%cur_event[49]]=$MIDI_COMMAND_CC)
            $_cc_num50 := %_midi_byte_1[1000*49+%cur_event[49]]
            set_controller($_cc_num50,%_midi_byte_2[1000*49+%cur_event[49]])
            wait(1)
            if ($_cc_num50=64)
              if (%CC[$_cc_num50]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num50]
            end if
            if ($_cc_num50=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num50])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[49])
        end if
        if (%cur_event[49]>%num_midi_events[49])
          %playing[49] := 0
        end if
        if ($button_showMidi=0)
          %playing[49] := 0
        end if
      end while
    end while
    if (%cb_id[49]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[49],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle50)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle50),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[50]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle50),$CONTROL_PAR_CURSOR_PICTURE,"clip title 50",(%clip_info_cursor[50]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[50]<15)
      inc(%clip_info_cursor[50])
    end if
  end if
end on

on ui_control($switch_preview50)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[50] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[50],$CONTROL_PAR_VALUE)=0)
    %playing[50] := 0
    %looping[50] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i51 := 0
    while ($_other_clip_i51<num_elements(%midi_clip_preview_id))
      if (50 # $_other_clip_i51)
        set_control_par(%midi_clip_preview_id[$_other_clip_i51],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i51]=1)
          %playing[$_other_clip_i51] := 0
          %looping[$_other_clip_i51] := 0
        end if
      end if
      inc($_other_clip_i51)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[50] := 1
    while (%looping[50]=1 and (%cb_id[50]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[50]=0)
        %looping[50] := 0
      end if
      if ($button_showMidi=0)
        %looping[50] := 0
      end if
      %cur_event[50] := 0
      %midi_file_pos_ticks[50] := 0
      %time_started[50] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[50] := 1
      while (%playing[50]=1 and (%cb_id[50]=$NI_CALLBACK_ID))
        if (%cur_event[50]=%num_midi_events[50])
          $_ticks_until_next_event51 := %clip_length[50]-%midi_file_pos_ticks[50]
        else
          $_ticks_until_next_event51 := %_midi_pos[1000*50+%cur_event[50]]-%midi_file_pos_ticks[50]
        end if
        if ($_ticks_until_next_event51>0)
          wait(ticks_to_ms($_ticks_until_next_event51))
        end if
        if (%cur_event[50]>%num_midi_events[50])
          %playing[50] := 0
        end if
        if ($button_showMidi=0)
          %playing[50] := 0
        end if
        if (%playing[50]=1 and (%cb_id[50]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[50] := %midi_file_pos_ticks[50]+$_ticks_until_next_event51
          if (%_midi_command[1000*50+%cur_event[50]]=$MIDI_COMMAND_NOTE_ON)
            $_note51 := %_midi_byte_1[1000*50+%cur_event[50]]
            $_velocity51 := %_midi_byte_2[1000*50+%cur_event[50]]
            $_length51 := ticks_to_ms(%_midi_length[1000*50+%cur_event[50]])
            $_note_id53 := play_note($_note51,$_velocity51,0,$_length51)
            %custom_event_triggered_by_mf[$_note_id53 mod 1000000] := 50+1
            %custom_event_active[$_note_id53 mod 1000000] := 1
            %custom_event_source[$_note_id53 mod 1000000] := -1
            set_event_par_arr($_note_id53,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note51,1)
            %key_down[$_note51] := 1
            %velo[$_note51] := $_velocity51
            $_ks_index := search(%articulation_keyswitches,$_note51)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note51)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note51)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note51)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note51)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note51)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note51)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note51
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note51) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note51,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note51] := 1
              %key_timestamp[$_note51] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note51],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note51
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note51+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note51)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note51)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note51-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note51-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note51-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note51-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note51-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity51)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note51
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity51
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id53 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity51,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity51,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity51,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*50+%cur_event[50]]=$MIDI_COMMAND_CC)
            $_cc_num51 := %_midi_byte_1[1000*50+%cur_event[50]]
            set_controller($_cc_num51,%_midi_byte_2[1000*50+%cur_event[50]])
            wait(1)
            if ($_cc_num51=64)
              if (%CC[$_cc_num51]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num51]
            end if
            if ($_cc_num51=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num51])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[50])
        end if
        if (%cur_event[50]>%num_midi_events[50])
          %playing[50] := 0
        end if
        if ($button_showMidi=0)
          %playing[50] := 0
        end if
      end while
    end while
    if (%cb_id[50]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[50],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle51)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle51),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[51]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle51),$CONTROL_PAR_CURSOR_PICTURE,"clip title 51",(%clip_info_cursor[51]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[51]<15)
      inc(%clip_info_cursor[51])
    end if
  end if
end on

on ui_control($switch_preview51)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[51] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[51],$CONTROL_PAR_VALUE)=0)
    %playing[51] := 0
    %looping[51] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i52 := 0
    while ($_other_clip_i52<num_elements(%midi_clip_preview_id))
      if (51 # $_other_clip_i52)
        set_control_par(%midi_clip_preview_id[$_other_clip_i52],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i52]=1)
          %playing[$_other_clip_i52] := 0
          %looping[$_other_clip_i52] := 0
        end if
      end if
      inc($_other_clip_i52)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[51] := 1
    while (%looping[51]=1 and (%cb_id[51]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[51]=0)
        %looping[51] := 0
      end if
      if ($button_showMidi=0)
        %looping[51] := 0
      end if
      %cur_event[51] := 0
      %midi_file_pos_ticks[51] := 0
      %time_started[51] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[51] := 1
      while (%playing[51]=1 and (%cb_id[51]=$NI_CALLBACK_ID))
        if (%cur_event[51]=%num_midi_events[51])
          $_ticks_until_next_event52 := %clip_length[51]-%midi_file_pos_ticks[51]
        else
          $_ticks_until_next_event52 := %_midi_pos[1000*51+%cur_event[51]]-%midi_file_pos_ticks[51]
        end if
        if ($_ticks_until_next_event52>0)
          wait(ticks_to_ms($_ticks_until_next_event52))
        end if
        if (%cur_event[51]>%num_midi_events[51])
          %playing[51] := 0
        end if
        if ($button_showMidi=0)
          %playing[51] := 0
        end if
        if (%playing[51]=1 and (%cb_id[51]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[51] := %midi_file_pos_ticks[51]+$_ticks_until_next_event52
          if (%_midi_command[1000*51+%cur_event[51]]=$MIDI_COMMAND_NOTE_ON)
            $_note52 := %_midi_byte_1[1000*51+%cur_event[51]]
            $_velocity52 := %_midi_byte_2[1000*51+%cur_event[51]]
            $_length52 := ticks_to_ms(%_midi_length[1000*51+%cur_event[51]])
            $_note_id54 := play_note($_note52,$_velocity52,0,$_length52)
            %custom_event_triggered_by_mf[$_note_id54 mod 1000000] := 51+1
            %custom_event_active[$_note_id54 mod 1000000] := 1
            %custom_event_source[$_note_id54 mod 1000000] := -1
            set_event_par_arr($_note_id54,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note52,1)
            %key_down[$_note52] := 1
            %velo[$_note52] := $_velocity52
            $_ks_index := search(%articulation_keyswitches,$_note52)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note52)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note52)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note52)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note52)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note52)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note52)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note52
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note52) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note52,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note52] := 1
              %key_timestamp[$_note52] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note52],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note52
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note52+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note52)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note52)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note52-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note52-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note52-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note52-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note52-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity52)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note52
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity52
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id54 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity52,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity52,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity52,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*51+%cur_event[51]]=$MIDI_COMMAND_CC)
            $_cc_num52 := %_midi_byte_1[1000*51+%cur_event[51]]
            set_controller($_cc_num52,%_midi_byte_2[1000*51+%cur_event[51]])
            wait(1)
            if ($_cc_num52=64)
              if (%CC[$_cc_num52]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num52]
            end if
            if ($_cc_num52=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num52])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[51])
        end if
        if (%cur_event[51]>%num_midi_events[51])
          %playing[51] := 0
        end if
        if ($button_showMidi=0)
          %playing[51] := 0
        end if
      end while
    end while
    if (%cb_id[51]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[51],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle52)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle52),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[52]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle52),$CONTROL_PAR_CURSOR_PICTURE,"clip title 52",(%clip_info_cursor[52]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[52]<15)
      inc(%clip_info_cursor[52])
    end if
  end if
end on

on ui_control($switch_preview52)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[52] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[52],$CONTROL_PAR_VALUE)=0)
    %playing[52] := 0
    %looping[52] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i53 := 0
    while ($_other_clip_i53<num_elements(%midi_clip_preview_id))
      if (52 # $_other_clip_i53)
        set_control_par(%midi_clip_preview_id[$_other_clip_i53],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i53]=1)
          %playing[$_other_clip_i53] := 0
          %looping[$_other_clip_i53] := 0
        end if
      end if
      inc($_other_clip_i53)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[52] := 1
    while (%looping[52]=1 and (%cb_id[52]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[52]=0)
        %looping[52] := 0
      end if
      if ($button_showMidi=0)
        %looping[52] := 0
      end if
      %cur_event[52] := 0
      %midi_file_pos_ticks[52] := 0
      %time_started[52] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[52] := 1
      while (%playing[52]=1 and (%cb_id[52]=$NI_CALLBACK_ID))
        if (%cur_event[52]=%num_midi_events[52])
          $_ticks_until_next_event53 := %clip_length[52]-%midi_file_pos_ticks[52]
        else
          $_ticks_until_next_event53 := %_midi_pos[1000*52+%cur_event[52]]-%midi_file_pos_ticks[52]
        end if
        if ($_ticks_until_next_event53>0)
          wait(ticks_to_ms($_ticks_until_next_event53))
        end if
        if (%cur_event[52]>%num_midi_events[52])
          %playing[52] := 0
        end if
        if ($button_showMidi=0)
          %playing[52] := 0
        end if
        if (%playing[52]=1 and (%cb_id[52]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[52] := %midi_file_pos_ticks[52]+$_ticks_until_next_event53
          if (%_midi_command[1000*52+%cur_event[52]]=$MIDI_COMMAND_NOTE_ON)
            $_note53 := %_midi_byte_1[1000*52+%cur_event[52]]
            $_velocity53 := %_midi_byte_2[1000*52+%cur_event[52]]
            $_length53 := ticks_to_ms(%_midi_length[1000*52+%cur_event[52]])
            $_note_id55 := play_note($_note53,$_velocity53,0,$_length53)
            %custom_event_triggered_by_mf[$_note_id55 mod 1000000] := 52+1
            %custom_event_active[$_note_id55 mod 1000000] := 1
            %custom_event_source[$_note_id55 mod 1000000] := -1
            set_event_par_arr($_note_id55,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note53,1)
            %key_down[$_note53] := 1
            %velo[$_note53] := $_velocity53
            $_ks_index := search(%articulation_keyswitches,$_note53)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note53)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note53)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note53)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note53)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note53)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note53)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note53
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note53) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note53,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note53] := 1
              %key_timestamp[$_note53] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note53],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note53
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note53+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note53)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note53)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note53-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note53-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note53-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note53-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note53-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity53)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note53
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity53
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id55 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity53,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity53,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity53,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*52+%cur_event[52]]=$MIDI_COMMAND_CC)
            $_cc_num53 := %_midi_byte_1[1000*52+%cur_event[52]]
            set_controller($_cc_num53,%_midi_byte_2[1000*52+%cur_event[52]])
            wait(1)
            if ($_cc_num53=64)
              if (%CC[$_cc_num53]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num53]
            end if
            if ($_cc_num53=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num53])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[52])
        end if
        if (%cur_event[52]>%num_midi_events[52])
          %playing[52] := 0
        end if
        if ($button_showMidi=0)
          %playing[52] := 0
        end if
      end while
    end while
    if (%cb_id[52]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[52],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle53)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle53),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[53]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle53),$CONTROL_PAR_CURSOR_PICTURE,"clip title 53",(%clip_info_cursor[53]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[53]<15)
      inc(%clip_info_cursor[53])
    end if
  end if
end on

on ui_control($switch_preview53)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[53] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[53],$CONTROL_PAR_VALUE)=0)
    %playing[53] := 0
    %looping[53] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i54 := 0
    while ($_other_clip_i54<num_elements(%midi_clip_preview_id))
      if (53 # $_other_clip_i54)
        set_control_par(%midi_clip_preview_id[$_other_clip_i54],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i54]=1)
          %playing[$_other_clip_i54] := 0
          %looping[$_other_clip_i54] := 0
        end if
      end if
      inc($_other_clip_i54)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[53] := 1
    while (%looping[53]=1 and (%cb_id[53]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[53]=0)
        %looping[53] := 0
      end if
      if ($button_showMidi=0)
        %looping[53] := 0
      end if
      %cur_event[53] := 0
      %midi_file_pos_ticks[53] := 0
      %time_started[53] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[53] := 1
      while (%playing[53]=1 and (%cb_id[53]=$NI_CALLBACK_ID))
        if (%cur_event[53]=%num_midi_events[53])
          $_ticks_until_next_event54 := %clip_length[53]-%midi_file_pos_ticks[53]
        else
          $_ticks_until_next_event54 := %_midi_pos[1000*53+%cur_event[53]]-%midi_file_pos_ticks[53]
        end if
        if ($_ticks_until_next_event54>0)
          wait(ticks_to_ms($_ticks_until_next_event54))
        end if
        if (%cur_event[53]>%num_midi_events[53])
          %playing[53] := 0
        end if
        if ($button_showMidi=0)
          %playing[53] := 0
        end if
        if (%playing[53]=1 and (%cb_id[53]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[53] := %midi_file_pos_ticks[53]+$_ticks_until_next_event54
          if (%_midi_command[1000*53+%cur_event[53]]=$MIDI_COMMAND_NOTE_ON)
            $_note54 := %_midi_byte_1[1000*53+%cur_event[53]]
            $_velocity54 := %_midi_byte_2[1000*53+%cur_event[53]]
            $_length54 := ticks_to_ms(%_midi_length[1000*53+%cur_event[53]])
            $_note_id56 := play_note($_note54,$_velocity54,0,$_length54)
            %custom_event_triggered_by_mf[$_note_id56 mod 1000000] := 53+1
            %custom_event_active[$_note_id56 mod 1000000] := 1
            %custom_event_source[$_note_id56 mod 1000000] := -1
            set_event_par_arr($_note_id56,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note54,1)
            %key_down[$_note54] := 1
            %velo[$_note54] := $_velocity54
            $_ks_index := search(%articulation_keyswitches,$_note54)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note54)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note54)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note54)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note54)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note54)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note54)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note54
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note54) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note54,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note54] := 1
              %key_timestamp[$_note54] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note54],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note54
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note54+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note54)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note54)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note54-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note54-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note54-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note54-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note54-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity54)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note54
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity54
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id56 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity54,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity54,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity54,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*53+%cur_event[53]]=$MIDI_COMMAND_CC)
            $_cc_num54 := %_midi_byte_1[1000*53+%cur_event[53]]
            set_controller($_cc_num54,%_midi_byte_2[1000*53+%cur_event[53]])
            wait(1)
            if ($_cc_num54=64)
              if (%CC[$_cc_num54]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num54]
            end if
            if ($_cc_num54=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num54])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[53])
        end if
        if (%cur_event[53]>%num_midi_events[53])
          %playing[53] := 0
        end if
        if ($button_showMidi=0)
          %playing[53] := 0
        end if
      end while
    end while
    if (%cb_id[53]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[53],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle54)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle54),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[54]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle54),$CONTROL_PAR_CURSOR_PICTURE,"clip title 54",(%clip_info_cursor[54]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[54]<15)
      inc(%clip_info_cursor[54])
    end if
  end if
end on

on ui_control($switch_preview54)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[54] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[54],$CONTROL_PAR_VALUE)=0)
    %playing[54] := 0
    %looping[54] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i55 := 0
    while ($_other_clip_i55<num_elements(%midi_clip_preview_id))
      if (54 # $_other_clip_i55)
        set_control_par(%midi_clip_preview_id[$_other_clip_i55],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i55]=1)
          %playing[$_other_clip_i55] := 0
          %looping[$_other_clip_i55] := 0
        end if
      end if
      inc($_other_clip_i55)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[54] := 1
    while (%looping[54]=1 and (%cb_id[54]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[54]=0)
        %looping[54] := 0
      end if
      if ($button_showMidi=0)
        %looping[54] := 0
      end if
      %cur_event[54] := 0
      %midi_file_pos_ticks[54] := 0
      %time_started[54] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[54] := 1
      while (%playing[54]=1 and (%cb_id[54]=$NI_CALLBACK_ID))
        if (%cur_event[54]=%num_midi_events[54])
          $_ticks_until_next_event55 := %clip_length[54]-%midi_file_pos_ticks[54]
        else
          $_ticks_until_next_event55 := %_midi_pos[1000*54+%cur_event[54]]-%midi_file_pos_ticks[54]
        end if
        if ($_ticks_until_next_event55>0)
          wait(ticks_to_ms($_ticks_until_next_event55))
        end if
        if (%cur_event[54]>%num_midi_events[54])
          %playing[54] := 0
        end if
        if ($button_showMidi=0)
          %playing[54] := 0
        end if
        if (%playing[54]=1 and (%cb_id[54]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[54] := %midi_file_pos_ticks[54]+$_ticks_until_next_event55
          if (%_midi_command[1000*54+%cur_event[54]]=$MIDI_COMMAND_NOTE_ON)
            $_note55 := %_midi_byte_1[1000*54+%cur_event[54]]
            $_velocity55 := %_midi_byte_2[1000*54+%cur_event[54]]
            $_length55 := ticks_to_ms(%_midi_length[1000*54+%cur_event[54]])
            $_note_id57 := play_note($_note55,$_velocity55,0,$_length55)
            %custom_event_triggered_by_mf[$_note_id57 mod 1000000] := 54+1
            %custom_event_active[$_note_id57 mod 1000000] := 1
            %custom_event_source[$_note_id57 mod 1000000] := -1
            set_event_par_arr($_note_id57,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note55,1)
            %key_down[$_note55] := 1
            %velo[$_note55] := $_velocity55
            $_ks_index := search(%articulation_keyswitches,$_note55)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note55)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note55)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note55)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note55)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note55)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note55)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note55
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note55) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note55,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note55] := 1
              %key_timestamp[$_note55] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note55],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note55
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note55+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note55)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note55)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note55-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note55-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note55-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note55-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note55-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity55)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note55
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity55
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id57 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity55,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity55,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity55,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*54+%cur_event[54]]=$MIDI_COMMAND_CC)
            $_cc_num55 := %_midi_byte_1[1000*54+%cur_event[54]]
            set_controller($_cc_num55,%_midi_byte_2[1000*54+%cur_event[54]])
            wait(1)
            if ($_cc_num55=64)
              if (%CC[$_cc_num55]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num55]
            end if
            if ($_cc_num55=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num55])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[54])
        end if
        if (%cur_event[54]>%num_midi_events[54])
          %playing[54] := 0
        end if
        if ($button_showMidi=0)
          %playing[54] := 0
        end if
      end while
    end while
    if (%cb_id[54]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[54],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle55)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle55),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[55]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle55),$CONTROL_PAR_CURSOR_PICTURE,"clip title 55",(%clip_info_cursor[55]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[55]<15)
      inc(%clip_info_cursor[55])
    end if
  end if
end on

on ui_control($switch_preview55)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[55] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[55],$CONTROL_PAR_VALUE)=0)
    %playing[55] := 0
    %looping[55] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i56 := 0
    while ($_other_clip_i56<num_elements(%midi_clip_preview_id))
      if (55 # $_other_clip_i56)
        set_control_par(%midi_clip_preview_id[$_other_clip_i56],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i56]=1)
          %playing[$_other_clip_i56] := 0
          %looping[$_other_clip_i56] := 0
        end if
      end if
      inc($_other_clip_i56)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[55] := 1
    while (%looping[55]=1 and (%cb_id[55]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[55]=0)
        %looping[55] := 0
      end if
      if ($button_showMidi=0)
        %looping[55] := 0
      end if
      %cur_event[55] := 0
      %midi_file_pos_ticks[55] := 0
      %time_started[55] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[55] := 1
      while (%playing[55]=1 and (%cb_id[55]=$NI_CALLBACK_ID))
        if (%cur_event[55]=%num_midi_events[55])
          $_ticks_until_next_event56 := %clip_length[55]-%midi_file_pos_ticks[55]
        else
          $_ticks_until_next_event56 := %_midi_pos[1000*55+%cur_event[55]]-%midi_file_pos_ticks[55]
        end if
        if ($_ticks_until_next_event56>0)
          wait(ticks_to_ms($_ticks_until_next_event56))
        end if
        if (%cur_event[55]>%num_midi_events[55])
          %playing[55] := 0
        end if
        if ($button_showMidi=0)
          %playing[55] := 0
        end if
        if (%playing[55]=1 and (%cb_id[55]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[55] := %midi_file_pos_ticks[55]+$_ticks_until_next_event56
          if (%_midi_command[1000*55+%cur_event[55]]=$MIDI_COMMAND_NOTE_ON)
            $_note56 := %_midi_byte_1[1000*55+%cur_event[55]]
            $_velocity56 := %_midi_byte_2[1000*55+%cur_event[55]]
            $_length56 := ticks_to_ms(%_midi_length[1000*55+%cur_event[55]])
            $_note_id58 := play_note($_note56,$_velocity56,0,$_length56)
            %custom_event_triggered_by_mf[$_note_id58 mod 1000000] := 55+1
            %custom_event_active[$_note_id58 mod 1000000] := 1
            %custom_event_source[$_note_id58 mod 1000000] := -1
            set_event_par_arr($_note_id58,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note56,1)
            %key_down[$_note56] := 1
            %velo[$_note56] := $_velocity56
            $_ks_index := search(%articulation_keyswitches,$_note56)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note56)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note56)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note56)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note56)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note56)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note56)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note56
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note56) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note56,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note56] := 1
              %key_timestamp[$_note56] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note56],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note56
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note56+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note56)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note56)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note56-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note56-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note56-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note56-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note56-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity56)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note56
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity56
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id58 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity56,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity56,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity56,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*55+%cur_event[55]]=$MIDI_COMMAND_CC)
            $_cc_num56 := %_midi_byte_1[1000*55+%cur_event[55]]
            set_controller($_cc_num56,%_midi_byte_2[1000*55+%cur_event[55]])
            wait(1)
            if ($_cc_num56=64)
              if (%CC[$_cc_num56]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num56]
            end if
            if ($_cc_num56=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num56])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[55])
        end if
        if (%cur_event[55]>%num_midi_events[55])
          %playing[55] := 0
        end if
        if ($button_showMidi=0)
          %playing[55] := 0
        end if
      end while
    end while
    if (%cb_id[55]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[55],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle56)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle56),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[56]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle56),$CONTROL_PAR_CURSOR_PICTURE,"clip title 56",(%clip_info_cursor[56]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[56]<15)
      inc(%clip_info_cursor[56])
    end if
  end if
end on

on ui_control($switch_preview56)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[56] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[56],$CONTROL_PAR_VALUE)=0)
    %playing[56] := 0
    %looping[56] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i57 := 0
    while ($_other_clip_i57<num_elements(%midi_clip_preview_id))
      if (56 # $_other_clip_i57)
        set_control_par(%midi_clip_preview_id[$_other_clip_i57],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i57]=1)
          %playing[$_other_clip_i57] := 0
          %looping[$_other_clip_i57] := 0
        end if
      end if
      inc($_other_clip_i57)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[56] := 1
    while (%looping[56]=1 and (%cb_id[56]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[56]=0)
        %looping[56] := 0
      end if
      if ($button_showMidi=0)
        %looping[56] := 0
      end if
      %cur_event[56] := 0
      %midi_file_pos_ticks[56] := 0
      %time_started[56] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[56] := 1
      while (%playing[56]=1 and (%cb_id[56]=$NI_CALLBACK_ID))
        if (%cur_event[56]=%num_midi_events[56])
          $_ticks_until_next_event57 := %clip_length[56]-%midi_file_pos_ticks[56]
        else
          $_ticks_until_next_event57 := %_midi_pos[1000*56+%cur_event[56]]-%midi_file_pos_ticks[56]
        end if
        if ($_ticks_until_next_event57>0)
          wait(ticks_to_ms($_ticks_until_next_event57))
        end if
        if (%cur_event[56]>%num_midi_events[56])
          %playing[56] := 0
        end if
        if ($button_showMidi=0)
          %playing[56] := 0
        end if
        if (%playing[56]=1 and (%cb_id[56]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[56] := %midi_file_pos_ticks[56]+$_ticks_until_next_event57
          if (%_midi_command[1000*56+%cur_event[56]]=$MIDI_COMMAND_NOTE_ON)
            $_note57 := %_midi_byte_1[1000*56+%cur_event[56]]
            $_velocity57 := %_midi_byte_2[1000*56+%cur_event[56]]
            $_length57 := ticks_to_ms(%_midi_length[1000*56+%cur_event[56]])
            $_note_id59 := play_note($_note57,$_velocity57,0,$_length57)
            %custom_event_triggered_by_mf[$_note_id59 mod 1000000] := 56+1
            %custom_event_active[$_note_id59 mod 1000000] := 1
            %custom_event_source[$_note_id59 mod 1000000] := -1
            set_event_par_arr($_note_id59,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note57,1)
            %key_down[$_note57] := 1
            %velo[$_note57] := $_velocity57
            $_ks_index := search(%articulation_keyswitches,$_note57)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note57)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note57)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note57)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note57)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note57)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note57)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note57
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note57) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note57,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note57] := 1
              %key_timestamp[$_note57] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note57],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note57
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note57+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note57)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note57)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note57-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note57-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note57-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note57-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note57-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity57)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note57
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity57
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id59 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity57,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity57,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity57,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*56+%cur_event[56]]=$MIDI_COMMAND_CC)
            $_cc_num57 := %_midi_byte_1[1000*56+%cur_event[56]]
            set_controller($_cc_num57,%_midi_byte_2[1000*56+%cur_event[56]])
            wait(1)
            if ($_cc_num57=64)
              if (%CC[$_cc_num57]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num57]
            end if
            if ($_cc_num57=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num57])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[56])
        end if
        if (%cur_event[56]>%num_midi_events[56])
          %playing[56] := 0
        end if
        if ($button_showMidi=0)
          %playing[56] := 0
        end if
      end while
    end while
    if (%cb_id[56]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[56],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle57)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle57),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[57]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle57),$CONTROL_PAR_CURSOR_PICTURE,"clip title 57",(%clip_info_cursor[57]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[57]<15)
      inc(%clip_info_cursor[57])
    end if
  end if
end on

on ui_control($switch_preview57)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[57] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[57],$CONTROL_PAR_VALUE)=0)
    %playing[57] := 0
    %looping[57] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i58 := 0
    while ($_other_clip_i58<num_elements(%midi_clip_preview_id))
      if (57 # $_other_clip_i58)
        set_control_par(%midi_clip_preview_id[$_other_clip_i58],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i58]=1)
          %playing[$_other_clip_i58] := 0
          %looping[$_other_clip_i58] := 0
        end if
      end if
      inc($_other_clip_i58)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[57] := 1
    while (%looping[57]=1 and (%cb_id[57]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[57]=0)
        %looping[57] := 0
      end if
      if ($button_showMidi=0)
        %looping[57] := 0
      end if
      %cur_event[57] := 0
      %midi_file_pos_ticks[57] := 0
      %time_started[57] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[57] := 1
      while (%playing[57]=1 and (%cb_id[57]=$NI_CALLBACK_ID))
        if (%cur_event[57]=%num_midi_events[57])
          $_ticks_until_next_event58 := %clip_length[57]-%midi_file_pos_ticks[57]
        else
          $_ticks_until_next_event58 := %_midi_pos[1000*57+%cur_event[57]]-%midi_file_pos_ticks[57]
        end if
        if ($_ticks_until_next_event58>0)
          wait(ticks_to_ms($_ticks_until_next_event58))
        end if
        if (%cur_event[57]>%num_midi_events[57])
          %playing[57] := 0
        end if
        if ($button_showMidi=0)
          %playing[57] := 0
        end if
        if (%playing[57]=1 and (%cb_id[57]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[57] := %midi_file_pos_ticks[57]+$_ticks_until_next_event58
          if (%_midi_command[1000*57+%cur_event[57]]=$MIDI_COMMAND_NOTE_ON)
            $_note58 := %_midi_byte_1[1000*57+%cur_event[57]]
            $_velocity58 := %_midi_byte_2[1000*57+%cur_event[57]]
            $_length58 := ticks_to_ms(%_midi_length[1000*57+%cur_event[57]])
            $_note_id60 := play_note($_note58,$_velocity58,0,$_length58)
            %custom_event_triggered_by_mf[$_note_id60 mod 1000000] := 57+1
            %custom_event_active[$_note_id60 mod 1000000] := 1
            %custom_event_source[$_note_id60 mod 1000000] := -1
            set_event_par_arr($_note_id60,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note58,1)
            %key_down[$_note58] := 1
            %velo[$_note58] := $_velocity58
            $_ks_index := search(%articulation_keyswitches,$_note58)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note58)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note58)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note58)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note58)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note58)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note58)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note58
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note58) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note58,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note58] := 1
              %key_timestamp[$_note58] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note58],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note58
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note58+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note58)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note58)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note58-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note58-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note58-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note58-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note58-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity58)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note58
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity58
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id60 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity58,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity58,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity58,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*57+%cur_event[57]]=$MIDI_COMMAND_CC)
            $_cc_num58 := %_midi_byte_1[1000*57+%cur_event[57]]
            set_controller($_cc_num58,%_midi_byte_2[1000*57+%cur_event[57]])
            wait(1)
            if ($_cc_num58=64)
              if (%CC[$_cc_num58]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num58]
            end if
            if ($_cc_num58=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num58])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[57])
        end if
        if (%cur_event[57]>%num_midi_events[57])
          %playing[57] := 0
        end if
        if ($button_showMidi=0)
          %playing[57] := 0
        end if
      end while
    end while
    if (%cb_id[57]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[57],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle58)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle58),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[58]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle58),$CONTROL_PAR_CURSOR_PICTURE,"clip title 58",(%clip_info_cursor[58]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[58]<15)
      inc(%clip_info_cursor[58])
    end if
  end if
end on

on ui_control($switch_preview58)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[58] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[58],$CONTROL_PAR_VALUE)=0)
    %playing[58] := 0
    %looping[58] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i59 := 0
    while ($_other_clip_i59<num_elements(%midi_clip_preview_id))
      if (58 # $_other_clip_i59)
        set_control_par(%midi_clip_preview_id[$_other_clip_i59],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i59]=1)
          %playing[$_other_clip_i59] := 0
          %looping[$_other_clip_i59] := 0
        end if
      end if
      inc($_other_clip_i59)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[58] := 1
    while (%looping[58]=1 and (%cb_id[58]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[58]=0)
        %looping[58] := 0
      end if
      if ($button_showMidi=0)
        %looping[58] := 0
      end if
      %cur_event[58] := 0
      %midi_file_pos_ticks[58] := 0
      %time_started[58] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[58] := 1
      while (%playing[58]=1 and (%cb_id[58]=$NI_CALLBACK_ID))
        if (%cur_event[58]=%num_midi_events[58])
          $_ticks_until_next_event59 := %clip_length[58]-%midi_file_pos_ticks[58]
        else
          $_ticks_until_next_event59 := %_midi_pos[1000*58+%cur_event[58]]-%midi_file_pos_ticks[58]
        end if
        if ($_ticks_until_next_event59>0)
          wait(ticks_to_ms($_ticks_until_next_event59))
        end if
        if (%cur_event[58]>%num_midi_events[58])
          %playing[58] := 0
        end if
        if ($button_showMidi=0)
          %playing[58] := 0
        end if
        if (%playing[58]=1 and (%cb_id[58]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[58] := %midi_file_pos_ticks[58]+$_ticks_until_next_event59
          if (%_midi_command[1000*58+%cur_event[58]]=$MIDI_COMMAND_NOTE_ON)
            $_note59 := %_midi_byte_1[1000*58+%cur_event[58]]
            $_velocity59 := %_midi_byte_2[1000*58+%cur_event[58]]
            $_length59 := ticks_to_ms(%_midi_length[1000*58+%cur_event[58]])
            $_note_id61 := play_note($_note59,$_velocity59,0,$_length59)
            %custom_event_triggered_by_mf[$_note_id61 mod 1000000] := 58+1
            %custom_event_active[$_note_id61 mod 1000000] := 1
            %custom_event_source[$_note_id61 mod 1000000] := -1
            set_event_par_arr($_note_id61,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note59,1)
            %key_down[$_note59] := 1
            %velo[$_note59] := $_velocity59
            $_ks_index := search(%articulation_keyswitches,$_note59)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note59)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note59)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note59)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note59)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note59)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note59)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note59
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note59) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note59,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note59] := 1
              %key_timestamp[$_note59] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note59],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note59
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note59+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note59)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note59)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note59-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note59-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note59-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note59-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note59-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity59)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note59
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity59
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id61 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity59,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity59,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity59,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*58+%cur_event[58]]=$MIDI_COMMAND_CC)
            $_cc_num59 := %_midi_byte_1[1000*58+%cur_event[58]]
            set_controller($_cc_num59,%_midi_byte_2[1000*58+%cur_event[58]])
            wait(1)
            if ($_cc_num59=64)
              if (%CC[$_cc_num59]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num59]
            end if
            if ($_cc_num59=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num59])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[58])
        end if
        if (%cur_event[58]>%num_midi_events[58])
          %playing[58] := 0
        end if
        if ($button_showMidi=0)
          %playing[58] := 0
        end if
      end while
    end while
    if (%cb_id[58]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[58],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle59)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle59),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[59]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle59),$CONTROL_PAR_CURSOR_PICTURE,"clip title 59",(%clip_info_cursor[59]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[59]<15)
      inc(%clip_info_cursor[59])
    end if
  end if
end on

on ui_control($switch_preview59)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[59] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[59],$CONTROL_PAR_VALUE)=0)
    %playing[59] := 0
    %looping[59] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i60 := 0
    while ($_other_clip_i60<num_elements(%midi_clip_preview_id))
      if (59 # $_other_clip_i60)
        set_control_par(%midi_clip_preview_id[$_other_clip_i60],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i60]=1)
          %playing[$_other_clip_i60] := 0
          %looping[$_other_clip_i60] := 0
        end if
      end if
      inc($_other_clip_i60)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[59] := 1
    while (%looping[59]=1 and (%cb_id[59]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[59]=0)
        %looping[59] := 0
      end if
      if ($button_showMidi=0)
        %looping[59] := 0
      end if
      %cur_event[59] := 0
      %midi_file_pos_ticks[59] := 0
      %time_started[59] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[59] := 1
      while (%playing[59]=1 and (%cb_id[59]=$NI_CALLBACK_ID))
        if (%cur_event[59]=%num_midi_events[59])
          $_ticks_until_next_event60 := %clip_length[59]-%midi_file_pos_ticks[59]
        else
          $_ticks_until_next_event60 := %_midi_pos[1000*59+%cur_event[59]]-%midi_file_pos_ticks[59]
        end if
        if ($_ticks_until_next_event60>0)
          wait(ticks_to_ms($_ticks_until_next_event60))
        end if
        if (%cur_event[59]>%num_midi_events[59])
          %playing[59] := 0
        end if
        if ($button_showMidi=0)
          %playing[59] := 0
        end if
        if (%playing[59]=1 and (%cb_id[59]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[59] := %midi_file_pos_ticks[59]+$_ticks_until_next_event60
          if (%_midi_command[1000*59+%cur_event[59]]=$MIDI_COMMAND_NOTE_ON)
            $_note60 := %_midi_byte_1[1000*59+%cur_event[59]]
            $_velocity60 := %_midi_byte_2[1000*59+%cur_event[59]]
            $_length60 := ticks_to_ms(%_midi_length[1000*59+%cur_event[59]])
            $_note_id62 := play_note($_note60,$_velocity60,0,$_length60)
            %custom_event_triggered_by_mf[$_note_id62 mod 1000000] := 59+1
            %custom_event_active[$_note_id62 mod 1000000] := 1
            %custom_event_source[$_note_id62 mod 1000000] := -1
            set_event_par_arr($_note_id62,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note60,1)
            %key_down[$_note60] := 1
            %velo[$_note60] := $_velocity60
            $_ks_index := search(%articulation_keyswitches,$_note60)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note60)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note60)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note60)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note60)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note60)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note60)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note60
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note60) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note60,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note60] := 1
              %key_timestamp[$_note60] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note60],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note60
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note60+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note60)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note60)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note60-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note60-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note60-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note60-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note60-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity60)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note60
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity60
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id62 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity60,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity60,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity60,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*59+%cur_event[59]]=$MIDI_COMMAND_CC)
            $_cc_num60 := %_midi_byte_1[1000*59+%cur_event[59]]
            set_controller($_cc_num60,%_midi_byte_2[1000*59+%cur_event[59]])
            wait(1)
            if ($_cc_num60=64)
              if (%CC[$_cc_num60]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num60]
            end if
            if ($_cc_num60=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num60])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[59])
        end if
        if (%cur_event[59]>%num_midi_events[59])
          %playing[59] := 0
        end if
        if ($button_showMidi=0)
          %playing[59] := 0
        end if
      end while
    end while
    if (%cb_id[59]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[59],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle60)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle60),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[60]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle60),$CONTROL_PAR_CURSOR_PICTURE,"clip title 60",(%clip_info_cursor[60]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[60]<15)
      inc(%clip_info_cursor[60])
    end if
  end if
end on

on ui_control($switch_preview60)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[60] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[60],$CONTROL_PAR_VALUE)=0)
    %playing[60] := 0
    %looping[60] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i61 := 0
    while ($_other_clip_i61<num_elements(%midi_clip_preview_id))
      if (60 # $_other_clip_i61)
        set_control_par(%midi_clip_preview_id[$_other_clip_i61],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i61]=1)
          %playing[$_other_clip_i61] := 0
          %looping[$_other_clip_i61] := 0
        end if
      end if
      inc($_other_clip_i61)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[60] := 1
    while (%looping[60]=1 and (%cb_id[60]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[60]=0)
        %looping[60] := 0
      end if
      if ($button_showMidi=0)
        %looping[60] := 0
      end if
      %cur_event[60] := 0
      %midi_file_pos_ticks[60] := 0
      %time_started[60] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[60] := 1
      while (%playing[60]=1 and (%cb_id[60]=$NI_CALLBACK_ID))
        if (%cur_event[60]=%num_midi_events[60])
          $_ticks_until_next_event61 := %clip_length[60]-%midi_file_pos_ticks[60]
        else
          $_ticks_until_next_event61 := %_midi_pos[1000*60+%cur_event[60]]-%midi_file_pos_ticks[60]
        end if
        if ($_ticks_until_next_event61>0)
          wait(ticks_to_ms($_ticks_until_next_event61))
        end if
        if (%cur_event[60]>%num_midi_events[60])
          %playing[60] := 0
        end if
        if ($button_showMidi=0)
          %playing[60] := 0
        end if
        if (%playing[60]=1 and (%cb_id[60]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[60] := %midi_file_pos_ticks[60]+$_ticks_until_next_event61
          if (%_midi_command[1000*60+%cur_event[60]]=$MIDI_COMMAND_NOTE_ON)
            $_note61 := %_midi_byte_1[1000*60+%cur_event[60]]
            $_velocity61 := %_midi_byte_2[1000*60+%cur_event[60]]
            $_length61 := ticks_to_ms(%_midi_length[1000*60+%cur_event[60]])
            $_note_id63 := play_note($_note61,$_velocity61,0,$_length61)
            %custom_event_triggered_by_mf[$_note_id63 mod 1000000] := 60+1
            %custom_event_active[$_note_id63 mod 1000000] := 1
            %custom_event_source[$_note_id63 mod 1000000] := -1
            set_event_par_arr($_note_id63,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note61,1)
            %key_down[$_note61] := 1
            %velo[$_note61] := $_velocity61
            $_ks_index := search(%articulation_keyswitches,$_note61)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note61)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note61)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note61)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note61)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note61)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note61)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note61
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note61) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note61,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note61] := 1
              %key_timestamp[$_note61] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note61],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note61
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note61+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note61)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note61)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note61-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note61-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note61-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note61-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note61-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity61)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note61
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity61
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id63 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity61,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity61,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity61,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*60+%cur_event[60]]=$MIDI_COMMAND_CC)
            $_cc_num61 := %_midi_byte_1[1000*60+%cur_event[60]]
            set_controller($_cc_num61,%_midi_byte_2[1000*60+%cur_event[60]])
            wait(1)
            if ($_cc_num61=64)
              if (%CC[$_cc_num61]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num61]
            end if
            if ($_cc_num61=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num61])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[60])
        end if
        if (%cur_event[60]>%num_midi_events[60])
          %playing[60] := 0
        end if
        if ($button_showMidi=0)
          %playing[60] := 0
        end if
      end while
    end while
    if (%cb_id[60]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[60],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle61)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle61),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[61]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle61),$CONTROL_PAR_CURSOR_PICTURE,"clip title 61",(%clip_info_cursor[61]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[61]<15)
      inc(%clip_info_cursor[61])
    end if
  end if
end on

on ui_control($switch_preview61)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[61] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[61],$CONTROL_PAR_VALUE)=0)
    %playing[61] := 0
    %looping[61] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i62 := 0
    while ($_other_clip_i62<num_elements(%midi_clip_preview_id))
      if (61 # $_other_clip_i62)
        set_control_par(%midi_clip_preview_id[$_other_clip_i62],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i62]=1)
          %playing[$_other_clip_i62] := 0
          %looping[$_other_clip_i62] := 0
        end if
      end if
      inc($_other_clip_i62)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[61] := 1
    while (%looping[61]=1 and (%cb_id[61]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[61]=0)
        %looping[61] := 0
      end if
      if ($button_showMidi=0)
        %looping[61] := 0
      end if
      %cur_event[61] := 0
      %midi_file_pos_ticks[61] := 0
      %time_started[61] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[61] := 1
      while (%playing[61]=1 and (%cb_id[61]=$NI_CALLBACK_ID))
        if (%cur_event[61]=%num_midi_events[61])
          $_ticks_until_next_event62 := %clip_length[61]-%midi_file_pos_ticks[61]
        else
          $_ticks_until_next_event62 := %_midi_pos[1000*61+%cur_event[61]]-%midi_file_pos_ticks[61]
        end if
        if ($_ticks_until_next_event62>0)
          wait(ticks_to_ms($_ticks_until_next_event62))
        end if
        if (%cur_event[61]>%num_midi_events[61])
          %playing[61] := 0
        end if
        if ($button_showMidi=0)
          %playing[61] := 0
        end if
        if (%playing[61]=1 and (%cb_id[61]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[61] := %midi_file_pos_ticks[61]+$_ticks_until_next_event62
          if (%_midi_command[1000*61+%cur_event[61]]=$MIDI_COMMAND_NOTE_ON)
            $_note62 := %_midi_byte_1[1000*61+%cur_event[61]]
            $_velocity62 := %_midi_byte_2[1000*61+%cur_event[61]]
            $_length62 := ticks_to_ms(%_midi_length[1000*61+%cur_event[61]])
            $_note_id64 := play_note($_note62,$_velocity62,0,$_length62)
            %custom_event_triggered_by_mf[$_note_id64 mod 1000000] := 61+1
            %custom_event_active[$_note_id64 mod 1000000] := 1
            %custom_event_source[$_note_id64 mod 1000000] := -1
            set_event_par_arr($_note_id64,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note62,1)
            %key_down[$_note62] := 1
            %velo[$_note62] := $_velocity62
            $_ks_index := search(%articulation_keyswitches,$_note62)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note62)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note62)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note62)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note62)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note62)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note62)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note62
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note62) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note62,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note62] := 1
              %key_timestamp[$_note62] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note62],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note62
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note62+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note62)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note62)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note62-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note62-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note62-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note62-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note62-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity62)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note62
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity62
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id64 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity62,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity62,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity62,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*61+%cur_event[61]]=$MIDI_COMMAND_CC)
            $_cc_num62 := %_midi_byte_1[1000*61+%cur_event[61]]
            set_controller($_cc_num62,%_midi_byte_2[1000*61+%cur_event[61]])
            wait(1)
            if ($_cc_num62=64)
              if (%CC[$_cc_num62]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num62]
            end if
            if ($_cc_num62=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num62])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[61])
        end if
        if (%cur_event[61]>%num_midi_events[61])
          %playing[61] := 0
        end if
        if ($button_showMidi=0)
          %playing[61] := 0
        end if
      end while
    end while
    if (%cb_id[61]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[61],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle62)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle62),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[62]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle62),$CONTROL_PAR_CURSOR_PICTURE,"clip title 62",(%clip_info_cursor[62]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[62]<15)
      inc(%clip_info_cursor[62])
    end if
  end if
end on

on ui_control($switch_preview62)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[62] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[62],$CONTROL_PAR_VALUE)=0)
    %playing[62] := 0
    %looping[62] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i63 := 0
    while ($_other_clip_i63<num_elements(%midi_clip_preview_id))
      if (62 # $_other_clip_i63)
        set_control_par(%midi_clip_preview_id[$_other_clip_i63],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i63]=1)
          %playing[$_other_clip_i63] := 0
          %looping[$_other_clip_i63] := 0
        end if
      end if
      inc($_other_clip_i63)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[62] := 1
    while (%looping[62]=1 and (%cb_id[62]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[62]=0)
        %looping[62] := 0
      end if
      if ($button_showMidi=0)
        %looping[62] := 0
      end if
      %cur_event[62] := 0
      %midi_file_pos_ticks[62] := 0
      %time_started[62] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[62] := 1
      while (%playing[62]=1 and (%cb_id[62]=$NI_CALLBACK_ID))
        if (%cur_event[62]=%num_midi_events[62])
          $_ticks_until_next_event63 := %clip_length[62]-%midi_file_pos_ticks[62]
        else
          $_ticks_until_next_event63 := %_midi_pos[1000*62+%cur_event[62]]-%midi_file_pos_ticks[62]
        end if
        if ($_ticks_until_next_event63>0)
          wait(ticks_to_ms($_ticks_until_next_event63))
        end if
        if (%cur_event[62]>%num_midi_events[62])
          %playing[62] := 0
        end if
        if ($button_showMidi=0)
          %playing[62] := 0
        end if
        if (%playing[62]=1 and (%cb_id[62]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[62] := %midi_file_pos_ticks[62]+$_ticks_until_next_event63
          if (%_midi_command[1000*62+%cur_event[62]]=$MIDI_COMMAND_NOTE_ON)
            $_note63 := %_midi_byte_1[1000*62+%cur_event[62]]
            $_velocity63 := %_midi_byte_2[1000*62+%cur_event[62]]
            $_length63 := ticks_to_ms(%_midi_length[1000*62+%cur_event[62]])
            $_note_id65 := play_note($_note63,$_velocity63,0,$_length63)
            %custom_event_triggered_by_mf[$_note_id65 mod 1000000] := 62+1
            %custom_event_active[$_note_id65 mod 1000000] := 1
            %custom_event_source[$_note_id65 mod 1000000] := -1
            set_event_par_arr($_note_id65,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note63,1)
            %key_down[$_note63] := 1
            %velo[$_note63] := $_velocity63
            $_ks_index := search(%articulation_keyswitches,$_note63)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note63)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note63)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note63)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note63)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note63)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note63)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note63
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note63) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note63,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note63] := 1
              %key_timestamp[$_note63] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note63],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note63
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note63+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note63)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note63)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note63-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note63-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note63-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note63-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note63-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity63)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note63
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity63
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id65 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity63,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity63,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity63,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*62+%cur_event[62]]=$MIDI_COMMAND_CC)
            $_cc_num63 := %_midi_byte_1[1000*62+%cur_event[62]]
            set_controller($_cc_num63,%_midi_byte_2[1000*62+%cur_event[62]])
            wait(1)
            if ($_cc_num63=64)
              if (%CC[$_cc_num63]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num63]
            end if
            if ($_cc_num63=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num63])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[62])
        end if
        if (%cur_event[62]>%num_midi_events[62])
          %playing[62] := 0
        end if
        if ($button_showMidi=0)
          %playing[62] := 0
        end if
      end while
    end while
    if (%cb_id[62]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[62],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle63)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle63),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[63]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle63),$CONTROL_PAR_CURSOR_PICTURE,"clip title 63",(%clip_info_cursor[63]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[63]<15)
      inc(%clip_info_cursor[63])
    end if
  end if
end on

on ui_control($switch_preview63)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[63] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[63],$CONTROL_PAR_VALUE)=0)
    %playing[63] := 0
    %looping[63] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i64 := 0
    while ($_other_clip_i64<num_elements(%midi_clip_preview_id))
      if (63 # $_other_clip_i64)
        set_control_par(%midi_clip_preview_id[$_other_clip_i64],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i64]=1)
          %playing[$_other_clip_i64] := 0
          %looping[$_other_clip_i64] := 0
        end if
      end if
      inc($_other_clip_i64)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[63] := 1
    while (%looping[63]=1 and (%cb_id[63]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[63]=0)
        %looping[63] := 0
      end if
      if ($button_showMidi=0)
        %looping[63] := 0
      end if
      %cur_event[63] := 0
      %midi_file_pos_ticks[63] := 0
      %time_started[63] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[63] := 1
      while (%playing[63]=1 and (%cb_id[63]=$NI_CALLBACK_ID))
        if (%cur_event[63]=%num_midi_events[63])
          $_ticks_until_next_event64 := %clip_length[63]-%midi_file_pos_ticks[63]
        else
          $_ticks_until_next_event64 := %_midi_pos[1000*63+%cur_event[63]]-%midi_file_pos_ticks[63]
        end if
        if ($_ticks_until_next_event64>0)
          wait(ticks_to_ms($_ticks_until_next_event64))
        end if
        if (%cur_event[63]>%num_midi_events[63])
          %playing[63] := 0
        end if
        if ($button_showMidi=0)
          %playing[63] := 0
        end if
        if (%playing[63]=1 and (%cb_id[63]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[63] := %midi_file_pos_ticks[63]+$_ticks_until_next_event64
          if (%_midi_command[1000*63+%cur_event[63]]=$MIDI_COMMAND_NOTE_ON)
            $_note64 := %_midi_byte_1[1000*63+%cur_event[63]]
            $_velocity64 := %_midi_byte_2[1000*63+%cur_event[63]]
            $_length64 := ticks_to_ms(%_midi_length[1000*63+%cur_event[63]])
            $_note_id66 := play_note($_note64,$_velocity64,0,$_length64)
            %custom_event_triggered_by_mf[$_note_id66 mod 1000000] := 63+1
            %custom_event_active[$_note_id66 mod 1000000] := 1
            %custom_event_source[$_note_id66 mod 1000000] := -1
            set_event_par_arr($_note_id66,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note64,1)
            %key_down[$_note64] := 1
            %velo[$_note64] := $_velocity64
            $_ks_index := search(%articulation_keyswitches,$_note64)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note64)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note64)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note64)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note64)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note64)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note64)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note64
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note64) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note64,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note64] := 1
              %key_timestamp[$_note64] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note64],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note64
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note64+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note64)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note64)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note64-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note64-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note64-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note64-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note64-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity64)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note64
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity64
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id66 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity64,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity64,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity64,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*63+%cur_event[63]]=$MIDI_COMMAND_CC)
            $_cc_num64 := %_midi_byte_1[1000*63+%cur_event[63]]
            set_controller($_cc_num64,%_midi_byte_2[1000*63+%cur_event[63]])
            wait(1)
            if ($_cc_num64=64)
              if (%CC[$_cc_num64]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num64]
            end if
            if ($_cc_num64=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num64])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[63])
        end if
        if (%cur_event[63]>%num_midi_events[63])
          %playing[63] := 0
        end if
        if ($button_showMidi=0)
          %playing[63] := 0
        end if
      end while
    end while
    if (%cb_id[63]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[63],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle64)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle64),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[64]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle64),$CONTROL_PAR_CURSOR_PICTURE,"clip title 64",(%clip_info_cursor[64]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[64]<15)
      inc(%clip_info_cursor[64])
    end if
  end if
end on

on ui_control($switch_preview64)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[64] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[64],$CONTROL_PAR_VALUE)=0)
    %playing[64] := 0
    %looping[64] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i65 := 0
    while ($_other_clip_i65<num_elements(%midi_clip_preview_id))
      if (64 # $_other_clip_i65)
        set_control_par(%midi_clip_preview_id[$_other_clip_i65],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i65]=1)
          %playing[$_other_clip_i65] := 0
          %looping[$_other_clip_i65] := 0
        end if
      end if
      inc($_other_clip_i65)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[64] := 1
    while (%looping[64]=1 and (%cb_id[64]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[64]=0)
        %looping[64] := 0
      end if
      if ($button_showMidi=0)
        %looping[64] := 0
      end if
      %cur_event[64] := 0
      %midi_file_pos_ticks[64] := 0
      %time_started[64] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[64] := 1
      while (%playing[64]=1 and (%cb_id[64]=$NI_CALLBACK_ID))
        if (%cur_event[64]=%num_midi_events[64])
          $_ticks_until_next_event65 := %clip_length[64]-%midi_file_pos_ticks[64]
        else
          $_ticks_until_next_event65 := %_midi_pos[1000*64+%cur_event[64]]-%midi_file_pos_ticks[64]
        end if
        if ($_ticks_until_next_event65>0)
          wait(ticks_to_ms($_ticks_until_next_event65))
        end if
        if (%cur_event[64]>%num_midi_events[64])
          %playing[64] := 0
        end if
        if ($button_showMidi=0)
          %playing[64] := 0
        end if
        if (%playing[64]=1 and (%cb_id[64]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[64] := %midi_file_pos_ticks[64]+$_ticks_until_next_event65
          if (%_midi_command[1000*64+%cur_event[64]]=$MIDI_COMMAND_NOTE_ON)
            $_note65 := %_midi_byte_1[1000*64+%cur_event[64]]
            $_velocity65 := %_midi_byte_2[1000*64+%cur_event[64]]
            $_length65 := ticks_to_ms(%_midi_length[1000*64+%cur_event[64]])
            $_note_id67 := play_note($_note65,$_velocity65,0,$_length65)
            %custom_event_triggered_by_mf[$_note_id67 mod 1000000] := 64+1
            %custom_event_active[$_note_id67 mod 1000000] := 1
            %custom_event_source[$_note_id67 mod 1000000] := -1
            set_event_par_arr($_note_id67,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note65,1)
            %key_down[$_note65] := 1
            %velo[$_note65] := $_velocity65
            $_ks_index := search(%articulation_keyswitches,$_note65)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note65)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note65)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note65)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note65)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note65)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note65)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note65
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note65) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note65,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note65] := 1
              %key_timestamp[$_note65] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note65],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note65
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note65+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note65)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note65)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note65-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note65-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note65-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note65-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note65-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity65)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note65
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity65
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id67 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity65,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity65,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity65,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*64+%cur_event[64]]=$MIDI_COMMAND_CC)
            $_cc_num65 := %_midi_byte_1[1000*64+%cur_event[64]]
            set_controller($_cc_num65,%_midi_byte_2[1000*64+%cur_event[64]])
            wait(1)
            if ($_cc_num65=64)
              if (%CC[$_cc_num65]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num65]
            end if
            if ($_cc_num65=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num65])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[64])
        end if
        if (%cur_event[64]>%num_midi_events[64])
          %playing[64] := 0
        end if
        if ($button_showMidi=0)
          %playing[64] := 0
        end if
      end while
    end while
    if (%cb_id[64]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[64],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle65)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle65),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[65]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle65),$CONTROL_PAR_CURSOR_PICTURE,"clip title 65",(%clip_info_cursor[65]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[65]<15)
      inc(%clip_info_cursor[65])
    end if
  end if
end on

on ui_control($switch_preview65)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[65] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[65],$CONTROL_PAR_VALUE)=0)
    %playing[65] := 0
    %looping[65] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i66 := 0
    while ($_other_clip_i66<num_elements(%midi_clip_preview_id))
      if (65 # $_other_clip_i66)
        set_control_par(%midi_clip_preview_id[$_other_clip_i66],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i66]=1)
          %playing[$_other_clip_i66] := 0
          %looping[$_other_clip_i66] := 0
        end if
      end if
      inc($_other_clip_i66)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[65] := 1
    while (%looping[65]=1 and (%cb_id[65]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[65]=0)
        %looping[65] := 0
      end if
      if ($button_showMidi=0)
        %looping[65] := 0
      end if
      %cur_event[65] := 0
      %midi_file_pos_ticks[65] := 0
      %time_started[65] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[65] := 1
      while (%playing[65]=1 and (%cb_id[65]=$NI_CALLBACK_ID))
        if (%cur_event[65]=%num_midi_events[65])
          $_ticks_until_next_event66 := %clip_length[65]-%midi_file_pos_ticks[65]
        else
          $_ticks_until_next_event66 := %_midi_pos[1000*65+%cur_event[65]]-%midi_file_pos_ticks[65]
        end if
        if ($_ticks_until_next_event66>0)
          wait(ticks_to_ms($_ticks_until_next_event66))
        end if
        if (%cur_event[65]>%num_midi_events[65])
          %playing[65] := 0
        end if
        if ($button_showMidi=0)
          %playing[65] := 0
        end if
        if (%playing[65]=1 and (%cb_id[65]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[65] := %midi_file_pos_ticks[65]+$_ticks_until_next_event66
          if (%_midi_command[1000*65+%cur_event[65]]=$MIDI_COMMAND_NOTE_ON)
            $_note66 := %_midi_byte_1[1000*65+%cur_event[65]]
            $_velocity66 := %_midi_byte_2[1000*65+%cur_event[65]]
            $_length66 := ticks_to_ms(%_midi_length[1000*65+%cur_event[65]])
            $_note_id68 := play_note($_note66,$_velocity66,0,$_length66)
            %custom_event_triggered_by_mf[$_note_id68 mod 1000000] := 65+1
            %custom_event_active[$_note_id68 mod 1000000] := 1
            %custom_event_source[$_note_id68 mod 1000000] := -1
            set_event_par_arr($_note_id68,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note66,1)
            %key_down[$_note66] := 1
            %velo[$_note66] := $_velocity66
            $_ks_index := search(%articulation_keyswitches,$_note66)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note66)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note66)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note66)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note66)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note66)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note66)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note66
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note66) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note66,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note66] := 1
              %key_timestamp[$_note66] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note66],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note66
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note66+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note66)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note66)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note66-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note66-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note66-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note66-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note66-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity66)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note66
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity66
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id68 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity66,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity66,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity66,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*65+%cur_event[65]]=$MIDI_COMMAND_CC)
            $_cc_num66 := %_midi_byte_1[1000*65+%cur_event[65]]
            set_controller($_cc_num66,%_midi_byte_2[1000*65+%cur_event[65]])
            wait(1)
            if ($_cc_num66=64)
              if (%CC[$_cc_num66]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num66]
            end if
            if ($_cc_num66=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num66])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[65])
        end if
        if (%cur_event[65]>%num_midi_events[65])
          %playing[65] := 0
        end if
        if ($button_showMidi=0)
          %playing[65] := 0
        end if
      end while
    end while
    if (%cb_id[65]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[65],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle66)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle66),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[66]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle66),$CONTROL_PAR_CURSOR_PICTURE,"clip title 66",(%clip_info_cursor[66]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[66]<15)
      inc(%clip_info_cursor[66])
    end if
  end if
end on

on ui_control($switch_preview66)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[66] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[66],$CONTROL_PAR_VALUE)=0)
    %playing[66] := 0
    %looping[66] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i67 := 0
    while ($_other_clip_i67<num_elements(%midi_clip_preview_id))
      if (66 # $_other_clip_i67)
        set_control_par(%midi_clip_preview_id[$_other_clip_i67],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i67]=1)
          %playing[$_other_clip_i67] := 0
          %looping[$_other_clip_i67] := 0
        end if
      end if
      inc($_other_clip_i67)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[66] := 1
    while (%looping[66]=1 and (%cb_id[66]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[66]=0)
        %looping[66] := 0
      end if
      if ($button_showMidi=0)
        %looping[66] := 0
      end if
      %cur_event[66] := 0
      %midi_file_pos_ticks[66] := 0
      %time_started[66] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[66] := 1
      while (%playing[66]=1 and (%cb_id[66]=$NI_CALLBACK_ID))
        if (%cur_event[66]=%num_midi_events[66])
          $_ticks_until_next_event67 := %clip_length[66]-%midi_file_pos_ticks[66]
        else
          $_ticks_until_next_event67 := %_midi_pos[1000*66+%cur_event[66]]-%midi_file_pos_ticks[66]
        end if
        if ($_ticks_until_next_event67>0)
          wait(ticks_to_ms($_ticks_until_next_event67))
        end if
        if (%cur_event[66]>%num_midi_events[66])
          %playing[66] := 0
        end if
        if ($button_showMidi=0)
          %playing[66] := 0
        end if
        if (%playing[66]=1 and (%cb_id[66]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[66] := %midi_file_pos_ticks[66]+$_ticks_until_next_event67
          if (%_midi_command[1000*66+%cur_event[66]]=$MIDI_COMMAND_NOTE_ON)
            $_note67 := %_midi_byte_1[1000*66+%cur_event[66]]
            $_velocity67 := %_midi_byte_2[1000*66+%cur_event[66]]
            $_length67 := ticks_to_ms(%_midi_length[1000*66+%cur_event[66]])
            $_note_id69 := play_note($_note67,$_velocity67,0,$_length67)
            %custom_event_triggered_by_mf[$_note_id69 mod 1000000] := 66+1
            %custom_event_active[$_note_id69 mod 1000000] := 1
            %custom_event_source[$_note_id69 mod 1000000] := -1
            set_event_par_arr($_note_id69,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note67,1)
            %key_down[$_note67] := 1
            %velo[$_note67] := $_velocity67
            $_ks_index := search(%articulation_keyswitches,$_note67)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note67)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note67)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note67)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note67)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note67)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note67)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note67
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note67) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note67,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note67] := 1
              %key_timestamp[$_note67] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note67],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note67
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note67+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note67)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note67)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note67-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note67-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note67-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note67-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note67-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity67)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note67
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity67
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id69 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity67,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity67,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity67,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*66+%cur_event[66]]=$MIDI_COMMAND_CC)
            $_cc_num67 := %_midi_byte_1[1000*66+%cur_event[66]]
            set_controller($_cc_num67,%_midi_byte_2[1000*66+%cur_event[66]])
            wait(1)
            if ($_cc_num67=64)
              if (%CC[$_cc_num67]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num67]
            end if
            if ($_cc_num67=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num67])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[66])
        end if
        if (%cur_event[66]>%num_midi_events[66])
          %playing[66] := 0
        end if
        if ($button_showMidi=0)
          %playing[66] := 0
        end if
      end while
    end while
    if (%cb_id[66]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[66],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle67)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle67),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[67]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle67),$CONTROL_PAR_CURSOR_PICTURE,"clip title 67",(%clip_info_cursor[67]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[67]<15)
      inc(%clip_info_cursor[67])
    end if
  end if
end on

on ui_control($switch_preview67)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[67] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[67],$CONTROL_PAR_VALUE)=0)
    %playing[67] := 0
    %looping[67] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i68 := 0
    while ($_other_clip_i68<num_elements(%midi_clip_preview_id))
      if (67 # $_other_clip_i68)
        set_control_par(%midi_clip_preview_id[$_other_clip_i68],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i68]=1)
          %playing[$_other_clip_i68] := 0
          %looping[$_other_clip_i68] := 0
        end if
      end if
      inc($_other_clip_i68)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[67] := 1
    while (%looping[67]=1 and (%cb_id[67]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[67]=0)
        %looping[67] := 0
      end if
      if ($button_showMidi=0)
        %looping[67] := 0
      end if
      %cur_event[67] := 0
      %midi_file_pos_ticks[67] := 0
      %time_started[67] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[67] := 1
      while (%playing[67]=1 and (%cb_id[67]=$NI_CALLBACK_ID))
        if (%cur_event[67]=%num_midi_events[67])
          $_ticks_until_next_event68 := %clip_length[67]-%midi_file_pos_ticks[67]
        else
          $_ticks_until_next_event68 := %_midi_pos[1000*67+%cur_event[67]]-%midi_file_pos_ticks[67]
        end if
        if ($_ticks_until_next_event68>0)
          wait(ticks_to_ms($_ticks_until_next_event68))
        end if
        if (%cur_event[67]>%num_midi_events[67])
          %playing[67] := 0
        end if
        if ($button_showMidi=0)
          %playing[67] := 0
        end if
        if (%playing[67]=1 and (%cb_id[67]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[67] := %midi_file_pos_ticks[67]+$_ticks_until_next_event68
          if (%_midi_command[1000*67+%cur_event[67]]=$MIDI_COMMAND_NOTE_ON)
            $_note68 := %_midi_byte_1[1000*67+%cur_event[67]]
            $_velocity68 := %_midi_byte_2[1000*67+%cur_event[67]]
            $_length68 := ticks_to_ms(%_midi_length[1000*67+%cur_event[67]])
            $_note_id70 := play_note($_note68,$_velocity68,0,$_length68)
            %custom_event_triggered_by_mf[$_note_id70 mod 1000000] := 67+1
            %custom_event_active[$_note_id70 mod 1000000] := 1
            %custom_event_source[$_note_id70 mod 1000000] := -1
            set_event_par_arr($_note_id70,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note68,1)
            %key_down[$_note68] := 1
            %velo[$_note68] := $_velocity68
            $_ks_index := search(%articulation_keyswitches,$_note68)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note68)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note68)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note68)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note68)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note68)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note68)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note68
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note68) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note68,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note68] := 1
              %key_timestamp[$_note68] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note68],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note68
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note68+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note68)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note68)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note68-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note68-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note68-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note68-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note68-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity68)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note68
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity68
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id70 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity68,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity68,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity68,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*67+%cur_event[67]]=$MIDI_COMMAND_CC)
            $_cc_num68 := %_midi_byte_1[1000*67+%cur_event[67]]
            set_controller($_cc_num68,%_midi_byte_2[1000*67+%cur_event[67]])
            wait(1)
            if ($_cc_num68=64)
              if (%CC[$_cc_num68]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num68]
            end if
            if ($_cc_num68=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num68])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[67])
        end if
        if (%cur_event[67]>%num_midi_events[67])
          %playing[67] := 0
        end if
        if ($button_showMidi=0)
          %playing[67] := 0
        end if
      end while
    end while
    if (%cb_id[67]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[67],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle68)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle68),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[68]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle68),$CONTROL_PAR_CURSOR_PICTURE,"clip title 68",(%clip_info_cursor[68]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[68]<15)
      inc(%clip_info_cursor[68])
    end if
  end if
end on

on ui_control($switch_preview68)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[68] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[68],$CONTROL_PAR_VALUE)=0)
    %playing[68] := 0
    %looping[68] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i69 := 0
    while ($_other_clip_i69<num_elements(%midi_clip_preview_id))
      if (68 # $_other_clip_i69)
        set_control_par(%midi_clip_preview_id[$_other_clip_i69],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i69]=1)
          %playing[$_other_clip_i69] := 0
          %looping[$_other_clip_i69] := 0
        end if
      end if
      inc($_other_clip_i69)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[68] := 1
    while (%looping[68]=1 and (%cb_id[68]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[68]=0)
        %looping[68] := 0
      end if
      if ($button_showMidi=0)
        %looping[68] := 0
      end if
      %cur_event[68] := 0
      %midi_file_pos_ticks[68] := 0
      %time_started[68] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[68] := 1
      while (%playing[68]=1 and (%cb_id[68]=$NI_CALLBACK_ID))
        if (%cur_event[68]=%num_midi_events[68])
          $_ticks_until_next_event69 := %clip_length[68]-%midi_file_pos_ticks[68]
        else
          $_ticks_until_next_event69 := %_midi_pos[1000*68+%cur_event[68]]-%midi_file_pos_ticks[68]
        end if
        if ($_ticks_until_next_event69>0)
          wait(ticks_to_ms($_ticks_until_next_event69))
        end if
        if (%cur_event[68]>%num_midi_events[68])
          %playing[68] := 0
        end if
        if ($button_showMidi=0)
          %playing[68] := 0
        end if
        if (%playing[68]=1 and (%cb_id[68]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[68] := %midi_file_pos_ticks[68]+$_ticks_until_next_event69
          if (%_midi_command[1000*68+%cur_event[68]]=$MIDI_COMMAND_NOTE_ON)
            $_note69 := %_midi_byte_1[1000*68+%cur_event[68]]
            $_velocity69 := %_midi_byte_2[1000*68+%cur_event[68]]
            $_length69 := ticks_to_ms(%_midi_length[1000*68+%cur_event[68]])
            $_note_id71 := play_note($_note69,$_velocity69,0,$_length69)
            %custom_event_triggered_by_mf[$_note_id71 mod 1000000] := 68+1
            %custom_event_active[$_note_id71 mod 1000000] := 1
            %custom_event_source[$_note_id71 mod 1000000] := -1
            set_event_par_arr($_note_id71,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note69,1)
            %key_down[$_note69] := 1
            %velo[$_note69] := $_velocity69
            $_ks_index := search(%articulation_keyswitches,$_note69)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note69)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note69)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note69)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note69)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note69)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note69)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note69
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note69) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note69,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note69] := 1
              %key_timestamp[$_note69] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note69],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note69
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note69+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note69)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note69)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note69-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note69-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note69-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note69-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note69-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity69)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note69
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity69
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id71 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity69,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity69,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity69,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*68+%cur_event[68]]=$MIDI_COMMAND_CC)
            $_cc_num69 := %_midi_byte_1[1000*68+%cur_event[68]]
            set_controller($_cc_num69,%_midi_byte_2[1000*68+%cur_event[68]])
            wait(1)
            if ($_cc_num69=64)
              if (%CC[$_cc_num69]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num69]
            end if
            if ($_cc_num69=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num69])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[68])
        end if
        if (%cur_event[68]>%num_midi_events[68])
          %playing[68] := 0
        end if
        if ($button_showMidi=0)
          %playing[68] := 0
        end if
      end while
    end while
    if (%cb_id[68]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[68],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle69)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle69),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[69]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle69),$CONTROL_PAR_CURSOR_PICTURE,"clip title 69",(%clip_info_cursor[69]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[69]<15)
      inc(%clip_info_cursor[69])
    end if
  end if
end on

on ui_control($switch_preview69)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[69] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[69],$CONTROL_PAR_VALUE)=0)
    %playing[69] := 0
    %looping[69] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i70 := 0
    while ($_other_clip_i70<num_elements(%midi_clip_preview_id))
      if (69 # $_other_clip_i70)
        set_control_par(%midi_clip_preview_id[$_other_clip_i70],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i70]=1)
          %playing[$_other_clip_i70] := 0
          %looping[$_other_clip_i70] := 0
        end if
      end if
      inc($_other_clip_i70)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[69] := 1
    while (%looping[69]=1 and (%cb_id[69]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[69]=0)
        %looping[69] := 0
      end if
      if ($button_showMidi=0)
        %looping[69] := 0
      end if
      %cur_event[69] := 0
      %midi_file_pos_ticks[69] := 0
      %time_started[69] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[69] := 1
      while (%playing[69]=1 and (%cb_id[69]=$NI_CALLBACK_ID))
        if (%cur_event[69]=%num_midi_events[69])
          $_ticks_until_next_event70 := %clip_length[69]-%midi_file_pos_ticks[69]
        else
          $_ticks_until_next_event70 := %_midi_pos[1000*69+%cur_event[69]]-%midi_file_pos_ticks[69]
        end if
        if ($_ticks_until_next_event70>0)
          wait(ticks_to_ms($_ticks_until_next_event70))
        end if
        if (%cur_event[69]>%num_midi_events[69])
          %playing[69] := 0
        end if
        if ($button_showMidi=0)
          %playing[69] := 0
        end if
        if (%playing[69]=1 and (%cb_id[69]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[69] := %midi_file_pos_ticks[69]+$_ticks_until_next_event70
          if (%_midi_command[1000*69+%cur_event[69]]=$MIDI_COMMAND_NOTE_ON)
            $_note70 := %_midi_byte_1[1000*69+%cur_event[69]]
            $_velocity70 := %_midi_byte_2[1000*69+%cur_event[69]]
            $_length70 := ticks_to_ms(%_midi_length[1000*69+%cur_event[69]])
            $_note_id72 := play_note($_note70,$_velocity70,0,$_length70)
            %custom_event_triggered_by_mf[$_note_id72 mod 1000000] := 69+1
            %custom_event_active[$_note_id72 mod 1000000] := 1
            %custom_event_source[$_note_id72 mod 1000000] := -1
            set_event_par_arr($_note_id72,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note70,1)
            %key_down[$_note70] := 1
            %velo[$_note70] := $_velocity70
            $_ks_index := search(%articulation_keyswitches,$_note70)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note70)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note70)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note70)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note70)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note70)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note70)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note70
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note70) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note70,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note70] := 1
              %key_timestamp[$_note70] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note70],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note70
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note70+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note70)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note70)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note70-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note70-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note70-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note70-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note70-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity70)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note70
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity70
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id72 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity70,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity70,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity70,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*69+%cur_event[69]]=$MIDI_COMMAND_CC)
            $_cc_num70 := %_midi_byte_1[1000*69+%cur_event[69]]
            set_controller($_cc_num70,%_midi_byte_2[1000*69+%cur_event[69]])
            wait(1)
            if ($_cc_num70=64)
              if (%CC[$_cc_num70]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num70]
            end if
            if ($_cc_num70=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num70])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[69])
        end if
        if (%cur_event[69]>%num_midi_events[69])
          %playing[69] := 0
        end if
        if ($button_showMidi=0)
          %playing[69] := 0
        end if
      end while
    end while
    if (%cb_id[69]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[69],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle70)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle70),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[70]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle70),$CONTROL_PAR_CURSOR_PICTURE,"clip title 70",(%clip_info_cursor[70]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[70]<15)
      inc(%clip_info_cursor[70])
    end if
  end if
end on

on ui_control($switch_preview70)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[70] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[70],$CONTROL_PAR_VALUE)=0)
    %playing[70] := 0
    %looping[70] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i71 := 0
    while ($_other_clip_i71<num_elements(%midi_clip_preview_id))
      if (70 # $_other_clip_i71)
        set_control_par(%midi_clip_preview_id[$_other_clip_i71],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i71]=1)
          %playing[$_other_clip_i71] := 0
          %looping[$_other_clip_i71] := 0
        end if
      end if
      inc($_other_clip_i71)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[70] := 1
    while (%looping[70]=1 and (%cb_id[70]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[70]=0)
        %looping[70] := 0
      end if
      if ($button_showMidi=0)
        %looping[70] := 0
      end if
      %cur_event[70] := 0
      %midi_file_pos_ticks[70] := 0
      %time_started[70] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[70] := 1
      while (%playing[70]=1 and (%cb_id[70]=$NI_CALLBACK_ID))
        if (%cur_event[70]=%num_midi_events[70])
          $_ticks_until_next_event71 := %clip_length[70]-%midi_file_pos_ticks[70]
        else
          $_ticks_until_next_event71 := %_midi_pos[1000*70+%cur_event[70]]-%midi_file_pos_ticks[70]
        end if
        if ($_ticks_until_next_event71>0)
          wait(ticks_to_ms($_ticks_until_next_event71))
        end if
        if (%cur_event[70]>%num_midi_events[70])
          %playing[70] := 0
        end if
        if ($button_showMidi=0)
          %playing[70] := 0
        end if
        if (%playing[70]=1 and (%cb_id[70]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[70] := %midi_file_pos_ticks[70]+$_ticks_until_next_event71
          if (%_midi_command[1000*70+%cur_event[70]]=$MIDI_COMMAND_NOTE_ON)
            $_note71 := %_midi_byte_1[1000*70+%cur_event[70]]
            $_velocity71 := %_midi_byte_2[1000*70+%cur_event[70]]
            $_length71 := ticks_to_ms(%_midi_length[1000*70+%cur_event[70]])
            $_note_id73 := play_note($_note71,$_velocity71,0,$_length71)
            %custom_event_triggered_by_mf[$_note_id73 mod 1000000] := 70+1
            %custom_event_active[$_note_id73 mod 1000000] := 1
            %custom_event_source[$_note_id73 mod 1000000] := -1
            set_event_par_arr($_note_id73,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note71,1)
            %key_down[$_note71] := 1
            %velo[$_note71] := $_velocity71
            $_ks_index := search(%articulation_keyswitches,$_note71)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note71)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note71)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note71)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note71)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note71)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note71)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note71
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note71) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note71,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note71] := 1
              %key_timestamp[$_note71] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note71],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note71
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note71+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note71)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note71)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note71-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note71-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note71-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note71-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note71-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity71)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note71
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity71
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id73 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity71,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity71,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity71,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*70+%cur_event[70]]=$MIDI_COMMAND_CC)
            $_cc_num71 := %_midi_byte_1[1000*70+%cur_event[70]]
            set_controller($_cc_num71,%_midi_byte_2[1000*70+%cur_event[70]])
            wait(1)
            if ($_cc_num71=64)
              if (%CC[$_cc_num71]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num71]
            end if
            if ($_cc_num71=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num71])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[70])
        end if
        if (%cur_event[70]>%num_midi_events[70])
          %playing[70] := 0
        end if
        if ($button_showMidi=0)
          %playing[70] := 0
        end if
      end while
    end while
    if (%cb_id[70]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[70],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle71)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle71),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[71]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle71),$CONTROL_PAR_CURSOR_PICTURE,"clip title 71",(%clip_info_cursor[71]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[71]<15)
      inc(%clip_info_cursor[71])
    end if
  end if
end on

on ui_control($switch_preview71)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[71] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[71],$CONTROL_PAR_VALUE)=0)
    %playing[71] := 0
    %looping[71] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i72 := 0
    while ($_other_clip_i72<num_elements(%midi_clip_preview_id))
      if (71 # $_other_clip_i72)
        set_control_par(%midi_clip_preview_id[$_other_clip_i72],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i72]=1)
          %playing[$_other_clip_i72] := 0
          %looping[$_other_clip_i72] := 0
        end if
      end if
      inc($_other_clip_i72)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[71] := 1
    while (%looping[71]=1 and (%cb_id[71]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[71]=0)
        %looping[71] := 0
      end if
      if ($button_showMidi=0)
        %looping[71] := 0
      end if
      %cur_event[71] := 0
      %midi_file_pos_ticks[71] := 0
      %time_started[71] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[71] := 1
      while (%playing[71]=1 and (%cb_id[71]=$NI_CALLBACK_ID))
        if (%cur_event[71]=%num_midi_events[71])
          $_ticks_until_next_event72 := %clip_length[71]-%midi_file_pos_ticks[71]
        else
          $_ticks_until_next_event72 := %_midi_pos[1000*71+%cur_event[71]]-%midi_file_pos_ticks[71]
        end if
        if ($_ticks_until_next_event72>0)
          wait(ticks_to_ms($_ticks_until_next_event72))
        end if
        if (%cur_event[71]>%num_midi_events[71])
          %playing[71] := 0
        end if
        if ($button_showMidi=0)
          %playing[71] := 0
        end if
        if (%playing[71]=1 and (%cb_id[71]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[71] := %midi_file_pos_ticks[71]+$_ticks_until_next_event72
          if (%_midi_command[1000*71+%cur_event[71]]=$MIDI_COMMAND_NOTE_ON)
            $_note72 := %_midi_byte_1[1000*71+%cur_event[71]]
            $_velocity72 := %_midi_byte_2[1000*71+%cur_event[71]]
            $_length72 := ticks_to_ms(%_midi_length[1000*71+%cur_event[71]])
            $_note_id74 := play_note($_note72,$_velocity72,0,$_length72)
            %custom_event_triggered_by_mf[$_note_id74 mod 1000000] := 71+1
            %custom_event_active[$_note_id74 mod 1000000] := 1
            %custom_event_source[$_note_id74 mod 1000000] := -1
            set_event_par_arr($_note_id74,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note72,1)
            %key_down[$_note72] := 1
            %velo[$_note72] := $_velocity72
            $_ks_index := search(%articulation_keyswitches,$_note72)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note72)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note72)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note72)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note72)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note72)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note72)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note72
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note72) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note72,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note72] := 1
              %key_timestamp[$_note72] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note72],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note72
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note72+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note72)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note72)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note72-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note72-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note72-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note72-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note72-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity72)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note72
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity72
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id74 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity72,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity72,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity72,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*71+%cur_event[71]]=$MIDI_COMMAND_CC)
            $_cc_num72 := %_midi_byte_1[1000*71+%cur_event[71]]
            set_controller($_cc_num72,%_midi_byte_2[1000*71+%cur_event[71]])
            wait(1)
            if ($_cc_num72=64)
              if (%CC[$_cc_num72]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num72]
            end if
            if ($_cc_num72=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num72])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[71])
        end if
        if (%cur_event[71]>%num_midi_events[71])
          %playing[71] := 0
        end if
        if ($button_showMidi=0)
          %playing[71] := 0
        end if
      end while
    end while
    if (%cb_id[71]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[71],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle72)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle72),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[72]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle72),$CONTROL_PAR_CURSOR_PICTURE,"clip title 72",(%clip_info_cursor[72]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[72]<15)
      inc(%clip_info_cursor[72])
    end if
  end if
end on

on ui_control($switch_preview72)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[72] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[72],$CONTROL_PAR_VALUE)=0)
    %playing[72] := 0
    %looping[72] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i73 := 0
    while ($_other_clip_i73<num_elements(%midi_clip_preview_id))
      if (72 # $_other_clip_i73)
        set_control_par(%midi_clip_preview_id[$_other_clip_i73],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i73]=1)
          %playing[$_other_clip_i73] := 0
          %looping[$_other_clip_i73] := 0
        end if
      end if
      inc($_other_clip_i73)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[72] := 1
    while (%looping[72]=1 and (%cb_id[72]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[72]=0)
        %looping[72] := 0
      end if
      if ($button_showMidi=0)
        %looping[72] := 0
      end if
      %cur_event[72] := 0
      %midi_file_pos_ticks[72] := 0
      %time_started[72] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[72] := 1
      while (%playing[72]=1 and (%cb_id[72]=$NI_CALLBACK_ID))
        if (%cur_event[72]=%num_midi_events[72])
          $_ticks_until_next_event73 := %clip_length[72]-%midi_file_pos_ticks[72]
        else
          $_ticks_until_next_event73 := %_midi_pos[1000*72+%cur_event[72]]-%midi_file_pos_ticks[72]
        end if
        if ($_ticks_until_next_event73>0)
          wait(ticks_to_ms($_ticks_until_next_event73))
        end if
        if (%cur_event[72]>%num_midi_events[72])
          %playing[72] := 0
        end if
        if ($button_showMidi=0)
          %playing[72] := 0
        end if
        if (%playing[72]=1 and (%cb_id[72]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[72] := %midi_file_pos_ticks[72]+$_ticks_until_next_event73
          if (%_midi_command[1000*72+%cur_event[72]]=$MIDI_COMMAND_NOTE_ON)
            $_note73 := %_midi_byte_1[1000*72+%cur_event[72]]
            $_velocity73 := %_midi_byte_2[1000*72+%cur_event[72]]
            $_length73 := ticks_to_ms(%_midi_length[1000*72+%cur_event[72]])
            $_note_id75 := play_note($_note73,$_velocity73,0,$_length73)
            %custom_event_triggered_by_mf[$_note_id75 mod 1000000] := 72+1
            %custom_event_active[$_note_id75 mod 1000000] := 1
            %custom_event_source[$_note_id75 mod 1000000] := -1
            set_event_par_arr($_note_id75,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note73,1)
            %key_down[$_note73] := 1
            %velo[$_note73] := $_velocity73
            $_ks_index := search(%articulation_keyswitches,$_note73)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note73)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note73)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note73)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note73)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note73)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note73)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note73
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note73) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note73,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note73] := 1
              %key_timestamp[$_note73] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note73],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note73
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note73+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note73)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note73)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note73-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note73-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note73-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note73-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note73-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity73)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note73
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity73
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id75 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity73,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity73,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity73,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*72+%cur_event[72]]=$MIDI_COMMAND_CC)
            $_cc_num73 := %_midi_byte_1[1000*72+%cur_event[72]]
            set_controller($_cc_num73,%_midi_byte_2[1000*72+%cur_event[72]])
            wait(1)
            if ($_cc_num73=64)
              if (%CC[$_cc_num73]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num73]
            end if
            if ($_cc_num73=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num73])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[72])
        end if
        if (%cur_event[72]>%num_midi_events[72])
          %playing[72] := 0
        end if
        if ($button_showMidi=0)
          %playing[72] := 0
        end if
      end while
    end while
    if (%cb_id[72]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[72],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle73)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle73),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[73]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle73),$CONTROL_PAR_CURSOR_PICTURE,"clip title 73",(%clip_info_cursor[73]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[73]<15)
      inc(%clip_info_cursor[73])
    end if
  end if
end on

on ui_control($switch_preview73)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[73] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[73],$CONTROL_PAR_VALUE)=0)
    %playing[73] := 0
    %looping[73] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i74 := 0
    while ($_other_clip_i74<num_elements(%midi_clip_preview_id))
      if (73 # $_other_clip_i74)
        set_control_par(%midi_clip_preview_id[$_other_clip_i74],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i74]=1)
          %playing[$_other_clip_i74] := 0
          %looping[$_other_clip_i74] := 0
        end if
      end if
      inc($_other_clip_i74)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[73] := 1
    while (%looping[73]=1 and (%cb_id[73]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[73]=0)
        %looping[73] := 0
      end if
      if ($button_showMidi=0)
        %looping[73] := 0
      end if
      %cur_event[73] := 0
      %midi_file_pos_ticks[73] := 0
      %time_started[73] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[73] := 1
      while (%playing[73]=1 and (%cb_id[73]=$NI_CALLBACK_ID))
        if (%cur_event[73]=%num_midi_events[73])
          $_ticks_until_next_event74 := %clip_length[73]-%midi_file_pos_ticks[73]
        else
          $_ticks_until_next_event74 := %_midi_pos[1000*73+%cur_event[73]]-%midi_file_pos_ticks[73]
        end if
        if ($_ticks_until_next_event74>0)
          wait(ticks_to_ms($_ticks_until_next_event74))
        end if
        if (%cur_event[73]>%num_midi_events[73])
          %playing[73] := 0
        end if
        if ($button_showMidi=0)
          %playing[73] := 0
        end if
        if (%playing[73]=1 and (%cb_id[73]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[73] := %midi_file_pos_ticks[73]+$_ticks_until_next_event74
          if (%_midi_command[1000*73+%cur_event[73]]=$MIDI_COMMAND_NOTE_ON)
            $_note74 := %_midi_byte_1[1000*73+%cur_event[73]]
            $_velocity74 := %_midi_byte_2[1000*73+%cur_event[73]]
            $_length74 := ticks_to_ms(%_midi_length[1000*73+%cur_event[73]])
            $_note_id76 := play_note($_note74,$_velocity74,0,$_length74)
            %custom_event_triggered_by_mf[$_note_id76 mod 1000000] := 73+1
            %custom_event_active[$_note_id76 mod 1000000] := 1
            %custom_event_source[$_note_id76 mod 1000000] := -1
            set_event_par_arr($_note_id76,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note74,1)
            %key_down[$_note74] := 1
            %velo[$_note74] := $_velocity74
            $_ks_index := search(%articulation_keyswitches,$_note74)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note74)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note74)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note74)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note74)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note74)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note74)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note74
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note74) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note74,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note74] := 1
              %key_timestamp[$_note74] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note74],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note74
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note74+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note74)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note74)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note74-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note74-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note74-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note74-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note74-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity74)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note74
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity74
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id76 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity74,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity74,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity74,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*73+%cur_event[73]]=$MIDI_COMMAND_CC)
            $_cc_num74 := %_midi_byte_1[1000*73+%cur_event[73]]
            set_controller($_cc_num74,%_midi_byte_2[1000*73+%cur_event[73]])
            wait(1)
            if ($_cc_num74=64)
              if (%CC[$_cc_num74]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num74]
            end if
            if ($_cc_num74=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num74])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[73])
        end if
        if (%cur_event[73]>%num_midi_events[73])
          %playing[73] := 0
        end if
        if ($button_showMidi=0)
          %playing[73] := 0
        end if
      end while
    end while
    if (%cb_id[73]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[73],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle74)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle74),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[74]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle74),$CONTROL_PAR_CURSOR_PICTURE,"clip title 74",(%clip_info_cursor[74]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[74]<15)
      inc(%clip_info_cursor[74])
    end if
  end if
end on

on ui_control($switch_preview74)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[74] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[74],$CONTROL_PAR_VALUE)=0)
    %playing[74] := 0
    %looping[74] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i75 := 0
    while ($_other_clip_i75<num_elements(%midi_clip_preview_id))
      if (74 # $_other_clip_i75)
        set_control_par(%midi_clip_preview_id[$_other_clip_i75],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i75]=1)
          %playing[$_other_clip_i75] := 0
          %looping[$_other_clip_i75] := 0
        end if
      end if
      inc($_other_clip_i75)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[74] := 1
    while (%looping[74]=1 and (%cb_id[74]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[74]=0)
        %looping[74] := 0
      end if
      if ($button_showMidi=0)
        %looping[74] := 0
      end if
      %cur_event[74] := 0
      %midi_file_pos_ticks[74] := 0
      %time_started[74] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[74] := 1
      while (%playing[74]=1 and (%cb_id[74]=$NI_CALLBACK_ID))
        if (%cur_event[74]=%num_midi_events[74])
          $_ticks_until_next_event75 := %clip_length[74]-%midi_file_pos_ticks[74]
        else
          $_ticks_until_next_event75 := %_midi_pos[1000*74+%cur_event[74]]-%midi_file_pos_ticks[74]
        end if
        if ($_ticks_until_next_event75>0)
          wait(ticks_to_ms($_ticks_until_next_event75))
        end if
        if (%cur_event[74]>%num_midi_events[74])
          %playing[74] := 0
        end if
        if ($button_showMidi=0)
          %playing[74] := 0
        end if
        if (%playing[74]=1 and (%cb_id[74]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[74] := %midi_file_pos_ticks[74]+$_ticks_until_next_event75
          if (%_midi_command[1000*74+%cur_event[74]]=$MIDI_COMMAND_NOTE_ON)
            $_note75 := %_midi_byte_1[1000*74+%cur_event[74]]
            $_velocity75 := %_midi_byte_2[1000*74+%cur_event[74]]
            $_length75 := ticks_to_ms(%_midi_length[1000*74+%cur_event[74]])
            $_note_id77 := play_note($_note75,$_velocity75,0,$_length75)
            %custom_event_triggered_by_mf[$_note_id77 mod 1000000] := 74+1
            %custom_event_active[$_note_id77 mod 1000000] := 1
            %custom_event_source[$_note_id77 mod 1000000] := -1
            set_event_par_arr($_note_id77,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note75,1)
            %key_down[$_note75] := 1
            %velo[$_note75] := $_velocity75
            $_ks_index := search(%articulation_keyswitches,$_note75)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note75)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note75)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note75)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note75)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note75)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note75)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note75
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note75) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note75,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note75] := 1
              %key_timestamp[$_note75] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note75],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note75
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note75+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note75)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note75)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note75-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note75-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note75-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note75-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note75-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity75)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note75
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity75
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id77 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity75,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity75,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity75,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*74+%cur_event[74]]=$MIDI_COMMAND_CC)
            $_cc_num75 := %_midi_byte_1[1000*74+%cur_event[74]]
            set_controller($_cc_num75,%_midi_byte_2[1000*74+%cur_event[74]])
            wait(1)
            if ($_cc_num75=64)
              if (%CC[$_cc_num75]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num75]
            end if
            if ($_cc_num75=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num75])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[74])
        end if
        if (%cur_event[74]>%num_midi_events[74])
          %playing[74] := 0
        end if
        if ($button_showMidi=0)
          %playing[74] := 0
        end if
      end while
    end while
    if (%cb_id[74]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[74],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle75)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle75),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[75]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle75),$CONTROL_PAR_CURSOR_PICTURE,"clip title 75",(%clip_info_cursor[75]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[75]<15)
      inc(%clip_info_cursor[75])
    end if
  end if
end on

on ui_control($switch_preview75)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[75] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[75],$CONTROL_PAR_VALUE)=0)
    %playing[75] := 0
    %looping[75] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i76 := 0
    while ($_other_clip_i76<num_elements(%midi_clip_preview_id))
      if (75 # $_other_clip_i76)
        set_control_par(%midi_clip_preview_id[$_other_clip_i76],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i76]=1)
          %playing[$_other_clip_i76] := 0
          %looping[$_other_clip_i76] := 0
        end if
      end if
      inc($_other_clip_i76)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[75] := 1
    while (%looping[75]=1 and (%cb_id[75]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[75]=0)
        %looping[75] := 0
      end if
      if ($button_showMidi=0)
        %looping[75] := 0
      end if
      %cur_event[75] := 0
      %midi_file_pos_ticks[75] := 0
      %time_started[75] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[75] := 1
      while (%playing[75]=1 and (%cb_id[75]=$NI_CALLBACK_ID))
        if (%cur_event[75]=%num_midi_events[75])
          $_ticks_until_next_event76 := %clip_length[75]-%midi_file_pos_ticks[75]
        else
          $_ticks_until_next_event76 := %_midi_pos[1000*75+%cur_event[75]]-%midi_file_pos_ticks[75]
        end if
        if ($_ticks_until_next_event76>0)
          wait(ticks_to_ms($_ticks_until_next_event76))
        end if
        if (%cur_event[75]>%num_midi_events[75])
          %playing[75] := 0
        end if
        if ($button_showMidi=0)
          %playing[75] := 0
        end if
        if (%playing[75]=1 and (%cb_id[75]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[75] := %midi_file_pos_ticks[75]+$_ticks_until_next_event76
          if (%_midi_command[1000*75+%cur_event[75]]=$MIDI_COMMAND_NOTE_ON)
            $_note76 := %_midi_byte_1[1000*75+%cur_event[75]]
            $_velocity76 := %_midi_byte_2[1000*75+%cur_event[75]]
            $_length76 := ticks_to_ms(%_midi_length[1000*75+%cur_event[75]])
            $_note_id78 := play_note($_note76,$_velocity76,0,$_length76)
            %custom_event_triggered_by_mf[$_note_id78 mod 1000000] := 75+1
            %custom_event_active[$_note_id78 mod 1000000] := 1
            %custom_event_source[$_note_id78 mod 1000000] := -1
            set_event_par_arr($_note_id78,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note76,1)
            %key_down[$_note76] := 1
            %velo[$_note76] := $_velocity76
            $_ks_index := search(%articulation_keyswitches,$_note76)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note76)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note76)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note76)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note76)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note76)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note76)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note76
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note76) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note76,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note76] := 1
              %key_timestamp[$_note76] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note76],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note76
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note76+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note76)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note76)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note76-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note76-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note76-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note76-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note76-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity76)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note76
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity76
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id78 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity76,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity76,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity76,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*75+%cur_event[75]]=$MIDI_COMMAND_CC)
            $_cc_num76 := %_midi_byte_1[1000*75+%cur_event[75]]
            set_controller($_cc_num76,%_midi_byte_2[1000*75+%cur_event[75]])
            wait(1)
            if ($_cc_num76=64)
              if (%CC[$_cc_num76]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num76]
            end if
            if ($_cc_num76=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num76])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[75])
        end if
        if (%cur_event[75]>%num_midi_events[75])
          %playing[75] := 0
        end if
        if ($button_showMidi=0)
          %playing[75] := 0
        end if
      end while
    end while
    if (%cb_id[75]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[75],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle76)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle76),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[76]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle76),$CONTROL_PAR_CURSOR_PICTURE,"clip title 76",(%clip_info_cursor[76]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[76]<15)
      inc(%clip_info_cursor[76])
    end if
  end if
end on

on ui_control($switch_preview76)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[76] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[76],$CONTROL_PAR_VALUE)=0)
    %playing[76] := 0
    %looping[76] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i77 := 0
    while ($_other_clip_i77<num_elements(%midi_clip_preview_id))
      if (76 # $_other_clip_i77)
        set_control_par(%midi_clip_preview_id[$_other_clip_i77],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i77]=1)
          %playing[$_other_clip_i77] := 0
          %looping[$_other_clip_i77] := 0
        end if
      end if
      inc($_other_clip_i77)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[76] := 1
    while (%looping[76]=1 and (%cb_id[76]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[76]=0)
        %looping[76] := 0
      end if
      if ($button_showMidi=0)
        %looping[76] := 0
      end if
      %cur_event[76] := 0
      %midi_file_pos_ticks[76] := 0
      %time_started[76] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[76] := 1
      while (%playing[76]=1 and (%cb_id[76]=$NI_CALLBACK_ID))
        if (%cur_event[76]=%num_midi_events[76])
          $_ticks_until_next_event77 := %clip_length[76]-%midi_file_pos_ticks[76]
        else
          $_ticks_until_next_event77 := %_midi_pos[1000*76+%cur_event[76]]-%midi_file_pos_ticks[76]
        end if
        if ($_ticks_until_next_event77>0)
          wait(ticks_to_ms($_ticks_until_next_event77))
        end if
        if (%cur_event[76]>%num_midi_events[76])
          %playing[76] := 0
        end if
        if ($button_showMidi=0)
          %playing[76] := 0
        end if
        if (%playing[76]=1 and (%cb_id[76]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[76] := %midi_file_pos_ticks[76]+$_ticks_until_next_event77
          if (%_midi_command[1000*76+%cur_event[76]]=$MIDI_COMMAND_NOTE_ON)
            $_note77 := %_midi_byte_1[1000*76+%cur_event[76]]
            $_velocity77 := %_midi_byte_2[1000*76+%cur_event[76]]
            $_length77 := ticks_to_ms(%_midi_length[1000*76+%cur_event[76]])
            $_note_id79 := play_note($_note77,$_velocity77,0,$_length77)
            %custom_event_triggered_by_mf[$_note_id79 mod 1000000] := 76+1
            %custom_event_active[$_note_id79 mod 1000000] := 1
            %custom_event_source[$_note_id79 mod 1000000] := -1
            set_event_par_arr($_note_id79,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note77,1)
            %key_down[$_note77] := 1
            %velo[$_note77] := $_velocity77
            $_ks_index := search(%articulation_keyswitches,$_note77)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note77)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note77)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note77)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note77)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note77)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note77)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note77
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note77) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note77,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note77] := 1
              %key_timestamp[$_note77] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note77],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note77
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note77+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note77)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note77)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note77-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note77-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note77-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note77-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note77-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity77)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note77
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity77
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id79 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity77,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity77,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity77,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*76+%cur_event[76]]=$MIDI_COMMAND_CC)
            $_cc_num77 := %_midi_byte_1[1000*76+%cur_event[76]]
            set_controller($_cc_num77,%_midi_byte_2[1000*76+%cur_event[76]])
            wait(1)
            if ($_cc_num77=64)
              if (%CC[$_cc_num77]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num77]
            end if
            if ($_cc_num77=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num77])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[76])
        end if
        if (%cur_event[76]>%num_midi_events[76])
          %playing[76] := 0
        end if
        if ($button_showMidi=0)
          %playing[76] := 0
        end if
      end while
    end while
    if (%cb_id[76]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[76],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle77)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle77),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[77]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle77),$CONTROL_PAR_CURSOR_PICTURE,"clip title 77",(%clip_info_cursor[77]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[77]<15)
      inc(%clip_info_cursor[77])
    end if
  end if
end on

on ui_control($switch_preview77)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[77] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[77],$CONTROL_PAR_VALUE)=0)
    %playing[77] := 0
    %looping[77] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i78 := 0
    while ($_other_clip_i78<num_elements(%midi_clip_preview_id))
      if (77 # $_other_clip_i78)
        set_control_par(%midi_clip_preview_id[$_other_clip_i78],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i78]=1)
          %playing[$_other_clip_i78] := 0
          %looping[$_other_clip_i78] := 0
        end if
      end if
      inc($_other_clip_i78)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[77] := 1
    while (%looping[77]=1 and (%cb_id[77]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[77]=0)
        %looping[77] := 0
      end if
      if ($button_showMidi=0)
        %looping[77] := 0
      end if
      %cur_event[77] := 0
      %midi_file_pos_ticks[77] := 0
      %time_started[77] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[77] := 1
      while (%playing[77]=1 and (%cb_id[77]=$NI_CALLBACK_ID))
        if (%cur_event[77]=%num_midi_events[77])
          $_ticks_until_next_event78 := %clip_length[77]-%midi_file_pos_ticks[77]
        else
          $_ticks_until_next_event78 := %_midi_pos[1000*77+%cur_event[77]]-%midi_file_pos_ticks[77]
        end if
        if ($_ticks_until_next_event78>0)
          wait(ticks_to_ms($_ticks_until_next_event78))
        end if
        if (%cur_event[77]>%num_midi_events[77])
          %playing[77] := 0
        end if
        if ($button_showMidi=0)
          %playing[77] := 0
        end if
        if (%playing[77]=1 and (%cb_id[77]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[77] := %midi_file_pos_ticks[77]+$_ticks_until_next_event78
          if (%_midi_command[1000*77+%cur_event[77]]=$MIDI_COMMAND_NOTE_ON)
            $_note78 := %_midi_byte_1[1000*77+%cur_event[77]]
            $_velocity78 := %_midi_byte_2[1000*77+%cur_event[77]]
            $_length78 := ticks_to_ms(%_midi_length[1000*77+%cur_event[77]])
            $_note_id80 := play_note($_note78,$_velocity78,0,$_length78)
            %custom_event_triggered_by_mf[$_note_id80 mod 1000000] := 77+1
            %custom_event_active[$_note_id80 mod 1000000] := 1
            %custom_event_source[$_note_id80 mod 1000000] := -1
            set_event_par_arr($_note_id80,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note78,1)
            %key_down[$_note78] := 1
            %velo[$_note78] := $_velocity78
            $_ks_index := search(%articulation_keyswitches,$_note78)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note78)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note78)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note78)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note78)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note78)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note78)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note78
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note78) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note78,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note78] := 1
              %key_timestamp[$_note78] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note78],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note78
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note78+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note78)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note78)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note78-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note78-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note78-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note78-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note78-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity78)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note78
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity78
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id80 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity78,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity78,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity78,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*77+%cur_event[77]]=$MIDI_COMMAND_CC)
            $_cc_num78 := %_midi_byte_1[1000*77+%cur_event[77]]
            set_controller($_cc_num78,%_midi_byte_2[1000*77+%cur_event[77]])
            wait(1)
            if ($_cc_num78=64)
              if (%CC[$_cc_num78]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num78]
            end if
            if ($_cc_num78=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num78])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[77])
        end if
        if (%cur_event[77]>%num_midi_events[77])
          %playing[77] := 0
        end if
        if ($button_showMidi=0)
          %playing[77] := 0
        end if
      end while
    end while
    if (%cb_id[77]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[77],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle78)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle78),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[78]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle78),$CONTROL_PAR_CURSOR_PICTURE,"clip title 78",(%clip_info_cursor[78]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[78]<15)
      inc(%clip_info_cursor[78])
    end if
  end if
end on

on ui_control($switch_preview78)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[78] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[78],$CONTROL_PAR_VALUE)=0)
    %playing[78] := 0
    %looping[78] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i79 := 0
    while ($_other_clip_i79<num_elements(%midi_clip_preview_id))
      if (78 # $_other_clip_i79)
        set_control_par(%midi_clip_preview_id[$_other_clip_i79],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i79]=1)
          %playing[$_other_clip_i79] := 0
          %looping[$_other_clip_i79] := 0
        end if
      end if
      inc($_other_clip_i79)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[78] := 1
    while (%looping[78]=1 and (%cb_id[78]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[78]=0)
        %looping[78] := 0
      end if
      if ($button_showMidi=0)
        %looping[78] := 0
      end if
      %cur_event[78] := 0
      %midi_file_pos_ticks[78] := 0
      %time_started[78] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[78] := 1
      while (%playing[78]=1 and (%cb_id[78]=$NI_CALLBACK_ID))
        if (%cur_event[78]=%num_midi_events[78])
          $_ticks_until_next_event79 := %clip_length[78]-%midi_file_pos_ticks[78]
        else
          $_ticks_until_next_event79 := %_midi_pos[1000*78+%cur_event[78]]-%midi_file_pos_ticks[78]
        end if
        if ($_ticks_until_next_event79>0)
          wait(ticks_to_ms($_ticks_until_next_event79))
        end if
        if (%cur_event[78]>%num_midi_events[78])
          %playing[78] := 0
        end if
        if ($button_showMidi=0)
          %playing[78] := 0
        end if
        if (%playing[78]=1 and (%cb_id[78]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[78] := %midi_file_pos_ticks[78]+$_ticks_until_next_event79
          if (%_midi_command[1000*78+%cur_event[78]]=$MIDI_COMMAND_NOTE_ON)
            $_note79 := %_midi_byte_1[1000*78+%cur_event[78]]
            $_velocity79 := %_midi_byte_2[1000*78+%cur_event[78]]
            $_length79 := ticks_to_ms(%_midi_length[1000*78+%cur_event[78]])
            $_note_id81 := play_note($_note79,$_velocity79,0,$_length79)
            %custom_event_triggered_by_mf[$_note_id81 mod 1000000] := 78+1
            %custom_event_active[$_note_id81 mod 1000000] := 1
            %custom_event_source[$_note_id81 mod 1000000] := -1
            set_event_par_arr($_note_id81,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note79,1)
            %key_down[$_note79] := 1
            %velo[$_note79] := $_velocity79
            $_ks_index := search(%articulation_keyswitches,$_note79)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note79)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note79)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note79)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note79)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note79)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note79)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note79
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note79) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note79,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note79] := 1
              %key_timestamp[$_note79] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note79],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note79
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note79+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note79)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note79)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note79-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note79-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note79-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note79-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note79-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity79)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note79
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity79
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id81 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity79,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity79,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity79,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*78+%cur_event[78]]=$MIDI_COMMAND_CC)
            $_cc_num79 := %_midi_byte_1[1000*78+%cur_event[78]]
            set_controller($_cc_num79,%_midi_byte_2[1000*78+%cur_event[78]])
            wait(1)
            if ($_cc_num79=64)
              if (%CC[$_cc_num79]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num79]
            end if
            if ($_cc_num79=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num79])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[78])
        end if
        if (%cur_event[78]>%num_midi_events[78])
          %playing[78] := 0
        end if
        if ($button_showMidi=0)
          %playing[78] := 0
        end if
      end while
    end while
    if (%cb_id[78]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[78],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control(?xypad_clipTitle79)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle79),$CONTROL_PAR_CURSOR_PICTURE,"blank",%clip_info_cursor[79]*2)
  set_control_par_str_arr(get_ui_id(?xypad_clipTitle79),$CONTROL_PAR_CURSOR_PICTURE,"clip title 79",(%clip_info_cursor[79]+1)*2)
  if ($NI_MOUSE_EVENT_TYPE=$NI_MOUSE_EVENT_TYPE_LEFT_BUTTON_DOWN)
    if (%clip_info_cursor[79]<15)
      inc(%clip_info_cursor[79])
    end if
  end if
end on

on ui_control($switch_preview79)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[79] := $NI_CALLBACK_ID
  if (get_control_par(%midi_clip_preview_id[79],$CONTROL_PAR_VALUE)=0)
    %playing[79] := 0
    %looping[79] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i80 := 0
    while ($_other_clip_i80<num_elements(%midi_clip_preview_id))
      if (79 # $_other_clip_i80)
        set_control_par(%midi_clip_preview_id[$_other_clip_i80],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i80]=1)
          %playing[$_other_clip_i80] := 0
          %looping[$_other_clip_i80] := 0
        end if
      end if
      inc($_other_clip_i80)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    %looping[79] := 1
    while (%looping[79]=1 and (%cb_id[79]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[79]=0)
        %looping[79] := 0
      end if
      if ($button_showMidi=0)
        %looping[79] := 0
      end if
      %cur_event[79] := 0
      %midi_file_pos_ticks[79] := 0
      %time_started[79] := $ENGINE_UPTIME
      call midi_clip_play_cursors
      %playing[79] := 1
      while (%playing[79]=1 and (%cb_id[79]=$NI_CALLBACK_ID))
        if (%cur_event[79]=%num_midi_events[79])
          $_ticks_until_next_event80 := %clip_length[79]-%midi_file_pos_ticks[79]
        else
          $_ticks_until_next_event80 := %_midi_pos[1000*79+%cur_event[79]]-%midi_file_pos_ticks[79]
        end if
        if ($_ticks_until_next_event80>0)
          wait(ticks_to_ms($_ticks_until_next_event80))
        end if
        if (%cur_event[79]>%num_midi_events[79])
          %playing[79] := 0
        end if
        if ($button_showMidi=0)
          %playing[79] := 0
        end if
        if (%playing[79]=1 and (%cb_id[79]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[79] := %midi_file_pos_ticks[79]+$_ticks_until_next_event80
          if (%_midi_command[1000*79+%cur_event[79]]=$MIDI_COMMAND_NOTE_ON)
            $_note80 := %_midi_byte_1[1000*79+%cur_event[79]]
            $_velocity80 := %_midi_byte_2[1000*79+%cur_event[79]]
            $_length80 := ticks_to_ms(%_midi_length[1000*79+%cur_event[79]])
            $_note_id82 := play_note($_note80,$_velocity80,0,$_length80)
            %custom_event_triggered_by_mf[$_note_id82 mod 1000000] := 79+1
            %custom_event_active[$_note_id82 mod 1000000] := 1
            %custom_event_source[$_note_id82 mod 1000000] := -1
            set_event_par_arr($_note_id82,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note80,1)
            %key_down[$_note80] := 1
            %velo[$_note80] := $_velocity80
            $_ks_index := search(%articulation_keyswitches,$_note80)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note80)
            if ($_ks_index # -1)
              $slider_speed := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note80)
            if ($_ks_index # -1)
              $slider_direction := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note80)
            if ($_ks_index # -1)
              $slider_legato := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note80)
            if ($_ks_index # -1)
              $slider_releaseSamples := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note80)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note80)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note80
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note80) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note80,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note80] := 1
              %key_timestamp[$_note80] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note80],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note80
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note80+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note80)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note80)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if ($slider_direction=$directionMode__UP or ($slider_direction=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note80-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note80-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note80-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note80-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note80-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if ($slider_direction=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if ($slider_direction=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $direction := $UP
                  else
                    $direction := $DOWN
                  end if
                  $_origin_note2 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if ($slider_legato=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    select ($slider_legato)
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[$slider_speed])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time3 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[$slider_speed]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time3 := $_offset_rec_time3 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time3 := $_offset_rec_time3+$_vel_offset
                    $_offset_rec_time3 := $_offset_rec_time3 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note2 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$direction) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time3,0)
                    if ($switch_velToSampleStart=0)
                      $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity80)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                      change_vol($_note_id2,$_volume,0)
                    end if
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                    set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                    %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                    %custom_event_note[$_note_id2 mod 1000000] := $_note80
                    %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                    %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                    %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note2
                    %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                    %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                    %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                    %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity80
                    %custom_event_direction[$_note_id2 mod 1000000] := $direction
                    %custom_event_source[$_note_id2 mod 1000000] := -1
                    %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id82 mod 1000000]
                    $r := 64-2
                    while ($r>=0)
                      %ripple_id_history[$r+1] := %ripple_id_history[$r]
                      dec($r)
                    end while
                    %ripple_id_history[0] := $_note_id2
                    $_fade_in_time := 0
                    if ($_do_legato=0)
                      $_fade_in_time := $menu_latency*1000
                      if ($_fade_in_time=0)
                        $_fade_in_time := 0
                      end if
                    else
                      $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                      $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                      if ($cur_artic=$artic__sixteenths)
                        if ($_real_pos_in_ripple<($_real_ripple_length/4))
                          $_real_pitch_length := $_real_ripple_length/4
                          $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        else
                          $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                        end if
                      else
                        $_real_pitch_length := $_real_ripple_length/2
                        $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                        $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                      end if
                      if (in_range($_velocity80,1,48))
                        $_fade_in_time := $_time_til_end_of_ripple
                      else
                        if (in_range($_velocity80,49,96))
                          $_fade_in_time := $_time_til_end_of_pitch
                        else
                          if (in_range($_velocity80,97,127))
                            $_fade_in_time := $_time_til_end_of_pitch/2
                          end if
                        end if
                      end if
                      if ($_fade_in_time<ticks_to_ms(192))
                        $_fade_in_time := ticks_to_ms(192)
                      end if
                    end if
                    fade_in($_note_id2,$_fade_in_time)
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*79+%cur_event[79]]=$MIDI_COMMAND_CC)
            $_cc_num80 := %_midi_byte_1[1000*79+%cur_event[79]]
            set_controller($_cc_num80,%_midi_byte_2[1000*79+%cur_event[79]])
            wait(1)
            if ($_cc_num80=64)
              if (%CC[$_cc_num80]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num80]
            end if
            if ($_cc_num80=1)
              if ($switch_releaseSamplesModwheelControl=1)
                $slider_releaseSamples := real_to_int(int_to_real(2)+((int_to_real(%CC[$_cc_num80])-int_to_real(0))/(int_to_real(127)-int_to_real(0))*(int_to_real(5)-int_to_real(2))))
                call update_releaseSamples_switches
                %p[$sp-1] := $control__releaseSamples
                call update_nks_label
                call set_keys_pressed
              end if
            end if
          end if
          inc(%cur_event[79])
        end if
        if (%cur_event[79]>%num_midi_events[79])
          %playing[79] := 0
        end if
        if ($button_showMidi=0)
          %playing[79] := 0
        end if
      end while
    end while
    if (%cb_id[79]=$NI_CALLBACK_ID)
      set_control_par(%midi_clip_preview_id[79],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control($switch_quarters)
  $cur_artic := $artic__quarters
  call update_articulation_switches
  call set_keys_pressed
end on

on ui_control($switch_eighths)
  $cur_artic := $artic__eighths
  call update_articulation_switches
  call set_keys_pressed
end on

on ui_control($switch_sixteenths)
  $cur_artic := $artic__sixteenths
  call update_articulation_switches
  call set_keys_pressed
end on

on ui_control($switch_halfSpeed)
  $slider_speed := $speedMode__halfSpeed
  call update_speed_switches
  %p[$sp-1] := $control__speed
  call update_engine_pars
  %p[$sp-1] := $control__speed
  call update_nks_label
  call set_keys_pressed
end on

on ui_control($switch_slowTripletSpeed)
  $slider_speed := $speedMode__slowTripletSpeed
  call update_speed_switches
  %p[$sp-1] := $control__speed
  call update_engine_pars
  %p[$sp-1] := $control__speed
  call update_nks_label
  call set_keys_pressed
end on

on ui_control($switch_fullSpeed)
  $slider_speed := $speedMode__fullSpeed
  call update_speed_switches
  %p[$sp-1] := $control__speed
  call update_engine_pars
  %p[$sp-1] := $control__speed
  call update_nks_label
  call set_keys_pressed
end on

on ui_control($switch_fastTripletSpeed)
  $slider_speed := $speedMode__fastTripletSpeed
  call update_speed_switches
  %p[$sp-1] := $control__speed
  call update_engine_pars
  %p[$sp-1] := $control__speed
  call update_nks_label
  call set_keys_pressed
end on

on ui_control($switch_doubleSpeed)
  $slider_speed := $speedMode__doubleSpeed
  call update_speed_switches
  %p[$sp-1] := $control__speed
  call update_engine_pars
  %p[$sp-1] := $control__speed
  call update_nks_label
  call set_keys_pressed
end on

on ui_control($switch_down)
  $slider_direction := $directionMode__down
  call update_direction_switches
  %p[$sp-1] := $control__direction
  call update_nks_label
  call set_keys_pressed
end on

on ui_control($switch_asPlayed)
  $slider_direction := $directionMode__asPlayed
  call update_direction_switches
  %p[$sp-1] := $control__direction
  call update_nks_label
  call set_keys_pressed
end on

on ui_control($switch_up)
  $slider_direction := $directionMode__up
  call update_direction_switches
  %p[$sp-1] := $control__direction
  call update_nks_label
  call set_keys_pressed
end on

on ui_control($switch_noLegato)
  $slider_legato := $legatoMode__noLegato
  call update_legato_switches
  %p[$sp-1] := $control__legato
  call update_nks_label
  call set_keys_pressed
end on

on ui_control($switch_syncToPitch)
  $slider_legato := $legatoMode__syncToPitch
  call update_legato_switches
  %p[$sp-1] := $control__legato
  call update_nks_label
  call set_keys_pressed
end on

on ui_control($switch_syncToRipple)
  $slider_legato := $legatoMode__syncToRipple
  call update_legato_switches
  %p[$sp-1] := $control__legato
  call update_nks_label
  call set_keys_pressed
end on

on ui_control($switch_syncToSwell)
  $slider_legato := $legatoMode__syncToSwell
  call update_legato_switches
  %p[$sp-1] := $control__legato
  call update_nks_label
  call set_keys_pressed
end on

on ui_control($switch_noReleaseSample)
  $slider_releaseSamples := $releaseSampleMode__noReleaseSample
  call update_releaseSamples_switches
  %p[$sp-1] := $control__releaseSamples
  call update_nks_label
  call set_keys_pressed
end on

on ui_control($switch_autoRelease)
  $slider_releaseSamples := $releaseSampleMode__autoRelease
  call update_releaseSamples_switches
  %p[$sp-1] := $control__releaseSamples
  call update_nks_label
  call set_keys_pressed
end on

on ui_control($switch_Release0)
  $slider_releaseSamples := $releaseSampleMode__Release0
  call update_releaseSamples_switches
  %p[$sp-1] := $control__releaseSamples
  call update_nks_label
  call set_keys_pressed
end on

on ui_control($switch_Release1)
  $slider_releaseSamples := $releaseSampleMode__Release1
  call update_releaseSamples_switches
  %p[$sp-1] := $control__releaseSamples
  call update_nks_label
  call set_keys_pressed
end on

on ui_control($switch_Release2)
  $slider_releaseSamples := $releaseSampleMode__Release2
  call update_releaseSamples_switches
  %p[$sp-1] := $control__releaseSamples
  call update_nks_label
  call set_keys_pressed
end on

on ui_control($switch_Release3)
  $slider_releaseSamples := $releaseSampleMode__Release3
  call update_releaseSamples_switches
  %p[$sp-1] := $control__releaseSamples
  call update_nks_label
  call set_keys_pressed
end on


{ Compiled on Wed Aug 21 17:21:14 2024 }
on init
  declare $sksp_dummy
  declare $concat_it
  declare $concat_offset
  declare $string_it
  declare $list_it
  declare $preproc_i
  message("")
  declare ~power_curve_norm
  declare %hide_states[2] := ($HIDE_WHOLE_CONTROL, $HIDE_PART_NOTHING)
  declare $array_i
  declare %black_keys[5] := (1, 3, 6, 8, 10)
  declare !tempo_names[9]
  !tempo_names[0] := "1/32"
  !tempo_names[1] := "1/16 T"
  !tempo_names[2] := "1/16"
  !tempo_names[3] := "1/8 T"
  !tempo_names[4] := "1/8"
  !tempo_names[5] := "1/4 T"
  !tempo_names[6] := "1/4"
  !tempo_names[7] := "1/2"
  !tempo_names[8] := "Bar"
  declare !NOTE_NAME[127]
  declare const $NOTE_NAME__SIZE := 127
  !NOTE_NAME[0] := "C"
  !NOTE_NAME[1] := "C#"
  !NOTE_NAME[2] := "D"
  !NOTE_NAME[3] := "D#"
  !NOTE_NAME[4] := "E"
  !NOTE_NAME[5] := "F"
  !NOTE_NAME[6] := "F#"
  !NOTE_NAME[7] := "G"
  !NOTE_NAME[8] := "G#"
  !NOTE_NAME[9] := "A"
  !NOTE_NAME[10] := "A#"
  !NOTE_NAME[11] := "B"
  !NOTE_NAME[12] := "C"
  !NOTE_NAME[13] := "C#"
  !NOTE_NAME[14] := "D"
  !NOTE_NAME[15] := "D#"
  !NOTE_NAME[16] := "E"
  !NOTE_NAME[17] := "F"
  !NOTE_NAME[18] := "F#"
  !NOTE_NAME[19] := "G"
  !NOTE_NAME[20] := "G#"
  !NOTE_NAME[21] := "A"
  !NOTE_NAME[22] := "A#"
  !NOTE_NAME[23] := "B"
  !NOTE_NAME[24] := "C"
  !NOTE_NAME[25] := "C#"
  !NOTE_NAME[26] := "D"
  !NOTE_NAME[27] := "D#"
  !NOTE_NAME[28] := "E"
  !NOTE_NAME[29] := "F"
  !NOTE_NAME[30] := "F#"
  !NOTE_NAME[31] := "G"
  !NOTE_NAME[32] := "G#"
  !NOTE_NAME[33] := "A"
  !NOTE_NAME[34] := "A#"
  !NOTE_NAME[35] := "B"
  !NOTE_NAME[36] := "C"
  !NOTE_NAME[37] := "C#"
  !NOTE_NAME[38] := "D"
  !NOTE_NAME[39] := "D#"
  !NOTE_NAME[40] := "E"
  !NOTE_NAME[41] := "F"
  !NOTE_NAME[42] := "F#"
  !NOTE_NAME[43] := "G"
  !NOTE_NAME[44] := "G#"
  !NOTE_NAME[45] := "A"
  !NOTE_NAME[46] := "A#"
  !NOTE_NAME[47] := "B"
  !NOTE_NAME[48] := "C"
  !NOTE_NAME[49] := "C#"
  !NOTE_NAME[50] := "D"
  !NOTE_NAME[51] := "D#"
  !NOTE_NAME[52] := "E"
  !NOTE_NAME[53] := "F"
  !NOTE_NAME[54] := "F#"
  !NOTE_NAME[55] := "G"
  !NOTE_NAME[56] := "G#"
  !NOTE_NAME[57] := "A"
  !NOTE_NAME[58] := "A#"
  !NOTE_NAME[59] := "B"
  !NOTE_NAME[60] := "C"
  !NOTE_NAME[61] := "C#"
  !NOTE_NAME[62] := "D"
  !NOTE_NAME[63] := "D#"
  !NOTE_NAME[64] := "E"
  !NOTE_NAME[65] := "F"
  !NOTE_NAME[66] := "F#"
  !NOTE_NAME[67] := "G"
  !NOTE_NAME[68] := "G#"
  !NOTE_NAME[69] := "A"
  !NOTE_NAME[70] := "A#"
  !NOTE_NAME[71] := "B"
  !NOTE_NAME[72] := "C"
  !NOTE_NAME[73] := "C#"
  !NOTE_NAME[74] := "D"
  !NOTE_NAME[75] := "D#"
  !NOTE_NAME[76] := "E"
  !NOTE_NAME[77] := "F"
  !NOTE_NAME[78] := "F#"
  !NOTE_NAME[79] := "G"
  !NOTE_NAME[80] := "G#"
  !NOTE_NAME[81] := "A"
  !NOTE_NAME[82] := "A#"
  !NOTE_NAME[83] := "B"
  !NOTE_NAME[84] := "C"
  !NOTE_NAME[85] := "C#"
  !NOTE_NAME[86] := "D"
  !NOTE_NAME[87] := "D#"
  !NOTE_NAME[88] := "E"
  !NOTE_NAME[89] := "F"
  !NOTE_NAME[90] := "F#"
  !NOTE_NAME[91] := "G"
  !NOTE_NAME[92] := "G#"
  !NOTE_NAME[93] := "A"
  !NOTE_NAME[94] := "A#"
  !NOTE_NAME[95] := "B"
  !NOTE_NAME[96] := "C"
  !NOTE_NAME[97] := "C#"
  !NOTE_NAME[98] := "D"
  !NOTE_NAME[99] := "D#"
  !NOTE_NAME[100] := "E"
  !NOTE_NAME[101] := "F"
  !NOTE_NAME[102] := "F#"
  !NOTE_NAME[103] := "G"
  !NOTE_NAME[104] := "G#"
  !NOTE_NAME[105] := "A"
  !NOTE_NAME[106] := "A#"
  !NOTE_NAME[107] := "B"
  !NOTE_NAME[108] := "C"
  !NOTE_NAME[109] := "C#"
  !NOTE_NAME[110] := "D"
  !NOTE_NAME[111] := "D#"
  !NOTE_NAME[112] := "E"
  !NOTE_NAME[113] := "F"
  !NOTE_NAME[114] := "F#"
  !NOTE_NAME[115] := "G"
  !NOTE_NAME[116] := "G#"
  !NOTE_NAME[117] := "A"
  !NOTE_NAME[118] := "A#"
  !NOTE_NAME[119] := "B"
  !NOTE_NAME[120] := "C"
  !NOTE_NAME[121] := "C#"
  !NOTE_NAME[122] := "D"
  !NOTE_NAME[123] := "D#"
  !NOTE_NAME[124] := "E"
  !NOTE_NAME[125] := "F"
  !NOTE_NAME[126] := "F#"
  declare const $MEM_SIZE := 1000000
  declare const $STACK_SIZE := 1000
  declare const $MAX_TASKS := $MEM_SIZE/$STACK_SIZE-1
  declare const $TASK_0 := $MEM_SIZE-($STACK_SIZE*$MAX_TASKS)
  declare const $TOO_MANY_TASKS := 1
  declare const $STACK_OVERFLOW := 2
  declare const $STACK_UNDERFLOW := 3
  declare %p[$MEM_SIZE]
  declare $sp
  $sp := $TASK_0+$STACK_SIZE
  declare $fp
  $fp := $TASK_0+$STACK_SIZE
  declare $tx
  declare %tstate__id[$MAX_TASKS]
  declare %tstate__sp[$MAX_TASKS]
  declare %tstate__fp[$MAX_TASKS]
  declare %tstate__fs[$MAX_TASKS]
  $tx := 0
  while ($tx<$MAX_TASKS)
    %tstate__fs[$tx] := $TASK_0+($tx*$STACK_SIZE)
    inc($tx)
  end while
  $tx := 0
  %tstate__id[0] := -1
  pgs_create_key(TCM_EXCEPTION,5)
  pgs_set_key_val(TCM_EXCEPTION,$CURRENT_SCRIPT_SLOT,0)
  set_key_pressed_support(1)
  set_snapshot_type(3)
  declare %dev_mode[1]
  load_array(%dev_mode,2)
  set_listener($NI_SIGNAL_TIMER_MS,1000000/30)
  set_listener($NI_SIGNAL_TRANSP_START,1)
  set_listener($NI_SIGNAL_TRANSP_STOP,1)
  SET_CONDITION(NO_SYS_SCRIPT_PEDAL)
  declare $i
  declare const $DOWN := 0
  declare const $UP := 1
  declare const $SHORT := 0
  declare const $LONG := 1
  declare const $NUM_RRS := 4
  declare const $MAX_NUM_CHORD_IDS := 1000
  declare const $control__vol := 0
  declare const $control__reverb := 1
  declare const $control__speed := 2
  declare const $control__direction := 3
  declare const $control__legato := 4
  declare const $control__releaseSamples := 5
  declare const $control__reverb_type := 6
  declare %custom_event_active[1000000]
  declare %custom_event_current_ripple[1000000]
  declare %custom_event_source[1000000]
  declare %custom_event_note[1000000]
  declare %custom_event_velocity[1000000]
  declare %custom_event_low_note[1000000]
  declare %custom_event_high_note[1000000]
  declare %custom_event_origin_note[1000000]
  declare %custom_event_dest_note[1000000]
  declare %custom_event_first_note[1000000]
  declare %custom_event_second_note[1000000]
  declare %custom_event_direction[1000000]
  declare %custom_event_artic[1000000]
  declare %custom_event_voice[1000000]
  declare %custom_event_note_off_timestamp[1000000]
  declare %custom_event_marked_for_release[1000000]
  declare %custom_event_play_release_sample[1000000]
  declare %custom_event_release_length[1000000]
  declare %custom_event_release_sample_length[1000000]
  declare %custom_event_release_note[1000000]
  declare %custom_event_release_dynamic[1000000]
  declare %custom_event_brightness_when_released[1000000]
  declare %custom_event_waiting_for_release_sample[1000000]
  declare %custom_event_fading_out_for_release_sample[1000000]
  declare %custom_event_rls_sample_id[1000000]
  declare %custom_event_crossfading[1000000]
  declare %custom_event_releasing[1000000]
  declare %custom_event_triggered_by_mf[1000000]
  declare %custom_event_ripple_index[1000000]
  declare %custom_event_preview_being_stopped[1000000]
  declare const $RECORDED_DURATION_QUARTER := 545455
  declare const $RECORDED_DURATION_EIGHTH := 272727
  declare const $MAX_INTERVAL := 5
  declare const $MIN_BRIGHTNESS := 24
  declare !speed_texts[5]
  !speed_texts[0] := "Half"
  !speed_texts[1] := "Triplet"
  !speed_texts[2] := "Original"
  !speed_texts[3] := "Triplet"
  !speed_texts[4] := "Double"
  declare const $speed_texts__SIZE := 5
  declare const $speedMode__halfSpeed := 0
  declare const $speedMode__slowTripletSpeed := 1
  declare const $speedMode__fullSpeed := 2
  declare const $speedMode__fastTripletSpeed := 3
  declare const $speedMode__doubleSpeed := 4
  declare ?speeds[5]
  ?speeds[0] := 2.0
  ?speeds[1] := 1.333
  ?speeds[2] := 1.0
  ?speeds[3] := 0.666
  ?speeds[4] := 0.5
  declare ?latency_offset_multipliers[5]
  ?latency_offset_multipliers[0] := 0.5
  ?latency_offset_multipliers[1] := 0.3333
  ?latency_offset_multipliers[2] := 0.0
  ?latency_offset_multipliers[3] := -0.3333
  ?latency_offset_multipliers[4] := -1.0
  declare !articulation_texts[3]
  !articulation_texts[0] := "Quarters"
  !articulation_texts[1] := "Eighths"
  !articulation_texts[2] := "Sixteenths"
  declare const $articulation_texts__SIZE := 3
  declare const $artic__quarters := 0
  declare const $artic__eighths := 1
  declare const $artic__sixteenths := 2
  declare !direction_texts[3]
  !direction_texts[0] := "Down"
  !direction_texts[1] := "As Played"
  !direction_texts[2] := "Up"
  declare const $direction_texts__SIZE := 3
  declare const $directionMode__down := 0
  declare const $directionMode__asPlayed := 1
  declare const $directionMode__up := 2
  declare !legato_texts[4]
  !legato_texts[0] := "Off"
  !legato_texts[1] := "Sync to Pitch"
  !legato_texts[2] := "Sync to Ripple"
  !legato_texts[3] := "Sync to Swell"
  declare const $legato_texts__SIZE := 4
  declare !vel_to_start_texts[2]
  !vel_to_start_texts[0] := "Vel to Start Off"
  !vel_to_start_texts[1] := "Vel to Start On"
  declare const $vel_to_start_texts__SIZE := 2
  declare const $legatoMode__noLegato := 0
  declare const $legatoMode__syncToPitch := 1
  declare const $legatoMode__syncToRipple := 2
  declare const $legatoMode__syncToSwell := 3
  declare !releaseSamples_texts[6]
  !releaseSamples_texts[0] := "Off"
  !releaseSamples_texts[1] := "Auto"
  !releaseSamples_texts[2] := "1"
  !releaseSamples_texts[3] := "2"
  !releaseSamples_texts[4] := "3"
  !releaseSamples_texts[5] := "4"
  declare const $releaseSamples_texts__SIZE := 6
  declare const $releaseSampleMode__noReleaseSample := 0
  declare const $releaseSampleMode__autoRelease := 1
  declare const $releaseSampleMode__Release0 := 2
  declare const $releaseSampleMode__Release1 := 3
  declare const $releaseSampleMode__Release2 := 4
  declare const $releaseSampleMode__Release3 := 5
  declare !_option_texts[7*10]
  declare const $option_texts__SIZE_D1 := 7
  declare const $option_texts__SIZE_D2 := 10
  declare !_option_texts_shortened[7*10]
  declare const $option_texts_shortened__SIZE_D1 := 7
  declare const $option_texts_shortened__SIZE_D2 := 10
  $i := 0
  while ($i<num_elements(!speed_texts))
    !_option_texts[10*$control__speed+$i] := !speed_texts[$i]
    inc($i)
  end while
  $i := 0
  while ($i<num_elements(!direction_texts))
    !_option_texts[10*$control__direction+$i] := !direction_texts[$i]
    inc($i)
  end while
  $i := 0
  while ($i<num_elements(!legato_texts))
    !_option_texts[10*$control__legato+$i] := !legato_texts[$i]
    inc($i)
  end while
  $i := 0
  while ($i<num_elements(!releaseSamples_texts))
    !_option_texts[10*$control__releaseSamples+$i] := !releaseSamples_texts[$i]
    inc($i)
  end while
  $array_i := 0
  while ($array_i<num_elements(!_option_texts))
    !_option_texts_shortened[$array_i] := !_option_texts[$array_i]
    inc($array_i)
  end while
  !_option_texts_shortened[10*$control__legato+0] := "Off"
  !_option_texts_shortened[10*$control__legato+1] := "Pitches"
  !_option_texts_shortened[10*$control__legato+2] := "Ripples"
  !_option_texts_shortened[10*$control__legato+3] := "Swells"
  declare %release_group[3]
  %release_group[$artic__quarters] := find_group("quarters releases")
  %release_group[$artic__eighths] := find_group("eighths releases")
  %release_group[$artic__sixteenths] := find_group("eighths releases")
  declare const $LOWEST_KEY := 36
  declare const $HIGHEST_KEY := 72
  declare %articulation_keyswitches[3] := (31, 32, 33)
  declare %speed_keyswitches[5] := (72+5, 72+6, 72+7, 72+8, 72+9)
  declare %direction_keyswitches[3] := (72+13, 72+14, 72+15)
  declare %legato_keyswitches[4] := (72+17, 72+18, 72+19, 72+20)
  declare %vel_to_start_keyswitches[2] := (72+21, 72+22)
  declare %release_sample_keyswitches[6] := (72+24, 72+25, 72+26, 72+27, 72+28, 72+29)
  declare %release_trigger_keyswitches[2] := (24, 108)
  declare %all_keyswitches[64]
  declare $total_num_keyswitches
  $i := 0
  while ($i<3)
    %all_keyswitches[$total_num_keyswitches] := %articulation_keyswitches[$i]
    inc($total_num_keyswitches)
    inc($i)
  end while
  $i := 0
  while ($i<5)
    %all_keyswitches[$total_num_keyswitches] := %speed_keyswitches[$i]
    inc($total_num_keyswitches)
    inc($i)
  end while
  $i := 0
  while ($i<3)
    %all_keyswitches[$total_num_keyswitches] := %direction_keyswitches[$i]
    inc($total_num_keyswitches)
    inc($i)
  end while
  $i := 0
  while ($i<4)
    %all_keyswitches[$total_num_keyswitches] := %legato_keyswitches[$i]
    inc($total_num_keyswitches)
    inc($i)
  end while
  $i := 0
  while ($i<6)
    %all_keyswitches[$total_num_keyswitches] := %release_sample_keyswitches[$i]
    inc($total_num_keyswitches)
    inc($i)
  end while
  $i := 0
  while ($i<=1)
    %all_keyswitches[$total_num_keyswitches] := %vel_to_start_keyswitches[$i]
    inc($total_num_keyswitches)
    inc($i)
  end while
  declare %rec_time_sample_lengths[3]
  %rec_time_sample_lengths[$artic__quarters] := $RECORDED_DURATION_QUARTER*16
  %rec_time_sample_lengths[$artic__eighths] := $RECORDED_DURATION_QUARTER*8
  %rec_time_sample_lengths[$artic__sixteenths] := $RECORDED_DURATION_QUARTER*8
  declare %rec_time_ripple_lengths[3]
  %rec_time_ripple_lengths[$artic__quarters] := $RECORDED_DURATION_QUARTER*2
  %rec_time_ripple_lengths[$artic__eighths] := $RECORDED_DURATION_QUARTER
  %rec_time_ripple_lengths[$artic__sixteenths] := $RECORDED_DURATION_QUARTER
  declare %ripple_length_ticks[3]
  %ripple_length_ticks[$artic__quarters] := 960*2
  %ripple_length_ticks[$artic__eighths] := 960
  %ripple_length_ticks[$artic__sixteenths] := 960
  declare %sample_length_ticks[3]
  %sample_length_ticks[$artic__quarters] := 960*16
  %sample_length_ticks[$artic__eighths] := 960*8
  %sample_length_ticks[$artic__sixteenths] := 960*8
  declare %pitch_fractions[3]
  %pitch_fractions[$artic__quarters] := 2
  %pitch_fractions[$artic__eighths] := 2
  %pitch_fractions[$artic__sixteenths] := 4
  declare %stop_offset_rec_time[3]
  %stop_offset_rec_time[$artic__sixteenths] := -20000
  declare $val
  declare $cur_title_page
  declare %rls_note_timestamp[128]
  declare $latency
  declare %ripples_fading_out[128]
  declare $num_ripples_fading_out
  declare %num_rls_spl_ids[128]
  declare ~db
  declare ~vol
  declare $_
  declare $timestamp_version_shown
  declare $num_active_ripples
  declare $num_keys_active
  declare $num_keys_down
  declare %key_active[128]
  declare %key_down[128]
  declare %rls_note_ids[128]
  declare %notes_to_release[1000]
  declare %voices_to_release[1000]
  declare $num_notes_to_release
  declare %num_ripple_voices[128]
  declare %key_timestamp[128]
  declare %key_history[100]
  declare %ripple_id_history[64]
  declare $direction
  declare $row
  declare $first_ripple_timestamp
  declare $latency_adjusted_first_ripple_timestamp
  declare $cur_midi_page
  make_persistent($cur_midi_page)
  read_persistent_var($cur_midi_page)
  declare $cur_artic
  make_persistent($cur_artic)
  read_persistent_var($cur_artic)
  declare $all_keys_inactive := 1
  declare %velo[128]
  declare %event_ids[128]
  declare %ctrl_ids[7]
  declare $recent_release_trigger_key
  $recent_release_trigger_key := %release_trigger_keyswitches[0]
  declare ~midiInstructions_opacity := 0.0
  declare ~midiCover_opacity := 0.0
  declare ~smoothed_midiInstructions_opacity
  declare ~smoothed_midiCover_opacity
  declare %_midi_event_id[80*1000]
  declare const $midi_event_id__SIZE_D1 := 80
  declare const $midi_event_id__SIZE_D2 := 1000
  declare %_midi_command[80*1000]
  declare const $midi_command__SIZE_D1 := 80
  declare const $midi_command__SIZE_D2 := 1000
  declare %_midi_pos[80*1000]
  declare const $midi_pos__SIZE_D1 := 80
  declare const $midi_pos__SIZE_D2 := 1000
  declare %_midi_byte_1[80*1000]
  declare const $midi_byte_1__SIZE_D1 := 80
  declare const $midi_byte_1__SIZE_D2 := 1000
  declare %_midi_byte_2[80*1000]
  declare const $midi_byte_2__SIZE_D1 := 80
  declare const $midi_byte_2__SIZE_D2 := 1000
  declare %_midi_length[80*1000]
  declare const $midi_length__SIZE_D1 := 80
  declare const $midi_length__SIZE_D2 := 1000
  declare %clip_length[80]
  declare %clip_loop_enabled[80]
  declare %num_midi_events[80]
  declare %num_midi_notes[80]
  declare %num_midi_ccs[80]
  declare %time_started[80]
  declare %cur_event[80]
  declare %playing[80]
  declare %looping[80]
  declare %midi_file_pos_ticks[80]
  declare %cb_id[80]
  declare $hist_i
  declare $voice_i
  declare $par_i
  declare $key_i
  declare $ripple_i
  declare $b
  declare $g
  declare $v
  declare $r
  declare $k
  declare $n
  declare $e
  declare $c
  declare $event_i
  declare $other_event_i
  declare $row_i
  declare $vel_i
  declare $clip_i
  mf_reset()
  mf_set_buffer_size(1000)
  mf_set_num_export_areas(80+1)
  mf_insert_file(get_folder($GET_FOLDER_PATCH_DIR) & "/Midi/midi.mid",0,0,0)
  declare !clip_names[80]
  load_array(!clip_names,2)
  $clip_i := 0
  while ($clip_i<80)
    mf_get_first($clip_i)
    while (mf_get_command() # 0)
      if (mf_get_command()=$MIDI_COMMAND_NOTE_ON)
        %_midi_event_id[1000*$clip_i+%num_midi_events[$clip_i]] := mf_get_id()
        %custom_event_source[mf_get_id() mod 1000000] := -1
        %_midi_command[1000*$clip_i+%num_midi_events[$clip_i]] := mf_get_command()
        %_midi_pos[1000*$clip_i+%num_midi_events[$clip_i]] := mf_get_pos()
        %_midi_byte_1[1000*$clip_i+%num_midi_events[$clip_i]] := mf_get_byte_one()
        %_midi_byte_2[1000*$clip_i+%num_midi_events[$clip_i]] := mf_get_byte_two()
        %_midi_length[1000*$clip_i+%num_midi_events[$clip_i]] := mf_get_note_length()
        inc(%num_midi_events[$clip_i])
        inc(%num_midi_notes[$clip_i])
      end if
      mf_get_next($clip_i)
    end while
    mf_get_first($clip_i)
    while (mf_get_command() # 0)
      if (mf_get_command()=$MIDI_COMMAND_CC and (mf_get_byte_one()=64))
        declare $cc_inserted
        $cc_inserted := 0
        $event_i := 0
        while ($event_i<%num_midi_events[$clip_i])
          if ($cc_inserted=0)
            declare $insert_index
            $insert_index := -1
            if ($event_i=0)
              if (mf_get_pos()<%_midi_pos[1000*$clip_i+0])
                $insert_index := 0
              end if
            end if
            if (in_range($event_i,1,%num_midi_events[$clip_i]-2))
              if (mf_get_pos()>%_midi_pos[1000*$clip_i+$event_i] and (mf_get_pos()<%_midi_pos[1000*$clip_i+$event_i+1]))
                $insert_index := $event_i+1
              end if
            end if
            if ($event_i=(%num_midi_events[$clip_i]-1))
              if (mf_get_pos()>%_midi_pos[1000*$clip_i+(%num_midi_events[$clip_i]-1)])
                $insert_index := %num_midi_events[$clip_i]
              end if
            end if
            if (mf_get_pos()=%_midi_pos[1000*$clip_i+$event_i])
              $insert_index := $event_i
            end if
            if ($insert_index # -1)
              $cc_inserted := 1
              $other_event_i := 1000-1
              while ($other_event_i>=($insert_index+1))
                %_midi_event_id[1000*$clip_i+$other_event_i] := %_midi_event_id[1000*$clip_i+($other_event_i-1)]
                %_midi_command[1000*$clip_i+$other_event_i] := %_midi_command[1000*$clip_i+($other_event_i-1)]
                %_midi_pos[1000*$clip_i+$other_event_i] := %_midi_pos[1000*$clip_i+($other_event_i-1)]
                %_midi_byte_1[1000*$clip_i+$other_event_i] := %_midi_byte_1[1000*$clip_i+($other_event_i-1)]
                %_midi_byte_2[1000*$clip_i+$other_event_i] := %_midi_byte_2[1000*$clip_i+($other_event_i-1)]
                %_midi_length[1000*$clip_i+$other_event_i] := %_midi_length[1000*$clip_i+($other_event_i-1)]
                dec($other_event_i)
              end while
              %_midi_event_id[1000*$clip_i+$insert_index] := mf_get_id()
              %_midi_command[1000*$clip_i+$insert_index] := mf_get_command()
              %_midi_pos[1000*$clip_i+$insert_index] := mf_get_pos()
              %_midi_byte_1[1000*$clip_i+$insert_index] := mf_get_byte_one()
              %_midi_byte_2[1000*$clip_i+$insert_index] := mf_get_byte_two()
            end if
          end if
          inc($event_i)
        end while
        inc(%num_midi_events[$clip_i])
        inc(%num_midi_ccs[$clip_i])
      end if
      mf_get_next($clip_i)
    end while
    inc($clip_i)
  end while
  $clip_i := 0
  while ($clip_i<80)
    mf_get_first($clip_i)
    while (mf_get_command() # 0)
      if (mf_get_command()=$MIDI_COMMAND_CC)
        if (mf_get_byte_one()=103)
          %clip_length[$clip_i] := mf_get_pos()
          if (mf_get_byte_two()=127)
            %clip_loop_enabled[$clip_i] := 1
          else
            %clip_loop_enabled[$clip_i] := 0
          end if
        end if
      end if
      mf_get_next($clip_i)
    end while
    inc($clip_i)
  end while
  declare ui_panel $ripples_panel
  set_control_par(get_ui_id($ripples_panel),$CONTROL_PAR_Z_LAYER,-1)
  declare %ripple[64]
  declare ui_slider $ripple0(0,127)
  declare ui_slider $ripple1(0,127)
  declare ui_slider $ripple2(0,127)
  declare ui_slider $ripple3(0,127)
  declare ui_slider $ripple4(0,127)
  declare ui_slider $ripple5(0,127)
  declare ui_slider $ripple6(0,127)
  declare ui_slider $ripple7(0,127)
  declare ui_slider $ripple8(0,127)
  declare ui_slider $ripple9(0,127)
  declare ui_slider $ripple10(0,127)
  declare ui_slider $ripple11(0,127)
  declare ui_slider $ripple12(0,127)
  declare ui_slider $ripple13(0,127)
  declare ui_slider $ripple14(0,127)
  declare ui_slider $ripple15(0,127)
  declare ui_slider $ripple16(0,127)
  declare ui_slider $ripple17(0,127)
  declare ui_slider $ripple18(0,127)
  declare ui_slider $ripple19(0,127)
  declare ui_slider $ripple20(0,127)
  declare ui_slider $ripple21(0,127)
  declare ui_slider $ripple22(0,127)
  declare ui_slider $ripple23(0,127)
  declare ui_slider $ripple24(0,127)
  declare ui_slider $ripple25(0,127)
  declare ui_slider $ripple26(0,127)
  declare ui_slider $ripple27(0,127)
  declare ui_slider $ripple28(0,127)
  declare ui_slider $ripple29(0,127)
  declare ui_slider $ripple30(0,127)
  declare ui_slider $ripple31(0,127)
  declare ui_slider $ripple32(0,127)
  declare ui_slider $ripple33(0,127)
  declare ui_slider $ripple34(0,127)
  declare ui_slider $ripple35(0,127)
  declare ui_slider $ripple36(0,127)
  declare ui_slider $ripple37(0,127)
  declare ui_slider $ripple38(0,127)
  declare ui_slider $ripple39(0,127)
  declare ui_slider $ripple40(0,127)
  declare ui_slider $ripple41(0,127)
  declare ui_slider $ripple42(0,127)
  declare ui_slider $ripple43(0,127)
  declare ui_slider $ripple44(0,127)
  declare ui_slider $ripple45(0,127)
  declare ui_slider $ripple46(0,127)
  declare ui_slider $ripple47(0,127)
  declare ui_slider $ripple48(0,127)
  declare ui_slider $ripple49(0,127)
  declare ui_slider $ripple50(0,127)
  declare ui_slider $ripple51(0,127)
  declare ui_slider $ripple52(0,127)
  declare ui_slider $ripple53(0,127)
  declare ui_slider $ripple54(0,127)
  declare ui_slider $ripple55(0,127)
  declare ui_slider $ripple56(0,127)
  declare ui_slider $ripple57(0,127)
  declare ui_slider $ripple58(0,127)
  declare ui_slider $ripple59(0,127)
  declare ui_slider $ripple60(0,127)
  declare ui_slider $ripple61(0,127)
  declare ui_slider $ripple62(0,127)
  declare ui_slider $ripple63(0,127)
  $preproc_i := 0
  while ($preproc_i<=63)
    %ripple[$preproc_i] := get_ui_id($ripple0)+$preproc_i
    inc($preproc_i)
  end while
  $i := 0
  while ($i<num_elements(%ripple))
    set_control_par(%ripple[$i],$CONTROL_PAR_PARENT_PANEL,get_ui_id($ripples_panel))
    set_control_par(%ripple[$i],$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
    inc($i)
  end while
  declare %ripple_swell[64]
  declare ui_slider $ripple_swell0(0,127)
  declare ui_slider $ripple_swell1(0,127)
  declare ui_slider $ripple_swell2(0,127)
  declare ui_slider $ripple_swell3(0,127)
  declare ui_slider $ripple_swell4(0,127)
  declare ui_slider $ripple_swell5(0,127)
  declare ui_slider $ripple_swell6(0,127)
  declare ui_slider $ripple_swell7(0,127)
  declare ui_slider $ripple_swell8(0,127)
  declare ui_slider $ripple_swell9(0,127)
  declare ui_slider $ripple_swell10(0,127)
  declare ui_slider $ripple_swell11(0,127)
  declare ui_slider $ripple_swell12(0,127)
  declare ui_slider $ripple_swell13(0,127)
  declare ui_slider $ripple_swell14(0,127)
  declare ui_slider $ripple_swell15(0,127)
  declare ui_slider $ripple_swell16(0,127)
  declare ui_slider $ripple_swell17(0,127)
  declare ui_slider $ripple_swell18(0,127)
  declare ui_slider $ripple_swell19(0,127)
  declare ui_slider $ripple_swell20(0,127)
  declare ui_slider $ripple_swell21(0,127)
  declare ui_slider $ripple_swell22(0,127)
  declare ui_slider $ripple_swell23(0,127)
  declare ui_slider $ripple_swell24(0,127)
  declare ui_slider $ripple_swell25(0,127)
  declare ui_slider $ripple_swell26(0,127)
  declare ui_slider $ripple_swell27(0,127)
  declare ui_slider $ripple_swell28(0,127)
  declare ui_slider $ripple_swell29(0,127)
  declare ui_slider $ripple_swell30(0,127)
  declare ui_slider $ripple_swell31(0,127)
  declare ui_slider $ripple_swell32(0,127)
  declare ui_slider $ripple_swell33(0,127)
  declare ui_slider $ripple_swell34(0,127)
  declare ui_slider $ripple_swell35(0,127)
  declare ui_slider $ripple_swell36(0,127)
  declare ui_slider $ripple_swell37(0,127)
  declare ui_slider $ripple_swell38(0,127)
  declare ui_slider $ripple_swell39(0,127)
  declare ui_slider $ripple_swell40(0,127)
  declare ui_slider $ripple_swell41(0,127)
  declare ui_slider $ripple_swell42(0,127)
  declare ui_slider $ripple_swell43(0,127)
  declare ui_slider $ripple_swell44(0,127)
  declare ui_slider $ripple_swell45(0,127)
  declare ui_slider $ripple_swell46(0,127)
  declare ui_slider $ripple_swell47(0,127)
  declare ui_slider $ripple_swell48(0,127)
  declare ui_slider $ripple_swell49(0,127)
  declare ui_slider $ripple_swell50(0,127)
  declare ui_slider $ripple_swell51(0,127)
  declare ui_slider $ripple_swell52(0,127)
  declare ui_slider $ripple_swell53(0,127)
  declare ui_slider $ripple_swell54(0,127)
  declare ui_slider $ripple_swell55(0,127)
  declare ui_slider $ripple_swell56(0,127)
  declare ui_slider $ripple_swell57(0,127)
  declare ui_slider $ripple_swell58(0,127)
  declare ui_slider $ripple_swell59(0,127)
  declare ui_slider $ripple_swell60(0,127)
  declare ui_slider $ripple_swell61(0,127)
  declare ui_slider $ripple_swell62(0,127)
  declare ui_slider $ripple_swell63(0,127)
  $preproc_i := 0
  while ($preproc_i<=63)
    %ripple_swell[$preproc_i] := get_ui_id($ripple_swell0)+$preproc_i
    inc($preproc_i)
  end while
  $i := 0
  while ($i<num_elements(%ripple_swell))
    set_control_par(%ripple_swell[$i],$CONTROL_PAR_PARENT_PANEL,get_ui_id($ripples_panel))
    set_control_par(%ripple_swell[$i],$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
    inc($i)
  end while
  make_perfview
  set_ui_width_px(900)
  set_ui_height_px(427)
  set_control_par_str($INST_ICON_ID,$CONTROL_PAR_PICTURE,"ui_icon")
  set_control_par_str($INST_WALLPAPER_ID,$CONTROL_PAR_PICTURE,"ui_background")
  declare $figma_counter
  declare $figma_counter_multi_line_labels
  declare %UI_x[163] := (0, 2, 692, 498, 340, 109, 607, 168, 48, 2, 26, 0, 2, 294, 1, 146, 120, 94, 68, 28, -1, 139, 93, 44, 13, 116, 129, 54, 7, 183, 137, 86, 41, 5, 9, 435, 316, 197, 716, -1, 31, ...
  63, 95, 127, 159, 191, 223, 255, 287, 750, 602, 454, 306, 750, 602, 454, 306, 855, 707, 559, 411, 855, 707, 559, 411, 124, 181, 10, -1, 12, 345, 0, 0, 0, 0, 0, 0, 0, -1, 485, 453, ...
  421, 389, -10, 4, 0, 0, 20, 27, 47, 88, 27, 4, 6, 18, 545, 176, 57, 152, 0, 5, 704, 3, 236, 829, 806, 760, 714, 668, 645, 599, 553, 783, 737, 691, 622, 576, 530, 484, 438, 392, ...
  369, 323, 277, 507, 461, 415, 346, 300, 254, 208, 162, 116, 93, 47, 1, 231, 185, 139, 70, 24, 865, 0, 751, 603, 455, 307, 751, 603, 455, 307, 856, 708, 560, 412, 856, 708, 560, 412, 11, 150, ...
  177, 2)
  declare %UI_y[163] := (0, 330, 11, 11, 11, 11, 234, 8, 8, 234, 131, 0, 1, 201, 0, 53, 53, 53, 53, 53, 53, 53, 53, 53, 53, -1, 53, 53, 53, 53, 53, 53, 53, 53, 70, 26, 26, 26, 6, 0, 0, ...
  0, 0, 0, 0, 0, 0, 0, 0, 333, 333, 333, 333, 241, 241, 241, 241, 333, 333, 333, 333, 241, 241, 241, 241, 241, 241, 241, -1, 196, 3, -1, -1, 2, -1, -1, -1, -1, -1, 302, 302, ...
  302, 302, 20, 20, 20, 20, -1, -1, -1, -1, 27, 24, 72, 16, 72, 72, 71, 15, 0, 0, 2, 70, 75, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, ...
  1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 49, 0, 334, 334, 334, 334, 242, 242, 242, 242, 334, 334, 334, 334, 242, 242, 242, 242, 242, 44, ...
  73, 68)
  declare %UI_width[163] := (900, 896, 197, 175, 165, 231, 291, 74, 83, 604, 852, 898, 896, 310, 898, 27, 27, 27, 27, 39, 34, 48, 55, 53, 35, 76, 26, 61, 43, 48, 45, 52, 45, 35, 54, 133, 91, 91, 170, 23, 23, ...
  23, 23, 23, 23, 23, 23, 23, 23, 137, 137, 137, 137, 137, 137, 137, 137, 32, 32, 32, 32, 32, 32, 32, 32, 58, 115, 115, 901, 26, 210, 899, 899, 899, 899, 899, 899, 899, 899, 23, 23, ...
  23, 23, 201, 182, 165, 225, 145, 131, 100, 70, 74, 174, 30, 124, 185, 185, 18, 46, 74, 74, 193, 77, 430, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, ...
  22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 22, 38, 896, 136, 136, 136, 136, 136, 136, 136, 136, 31, 31, 31, 31, 31, 31, 31, 31, 285, 53, ...
  553, 896)
  declare %UI_height[163] := (427, 95, 71, 67, 67, 67, 95, 85, 88, 95, 38, 427, 424, 24, 425, 15, 15, 15, 15, 19, 15, 19, 19, 19, 15, 20, 15, 15, 15, 15, 15, 15, 15, 15, 19, 43, 43, 43, 50, 23, 23, ...
  23, 23, 23, 23, 23, 23, 23, 23, 81, 81, 81, 81, 81, 81, 81, 81, 32, 32, 32, 32, 32, 32, 32, 32, 174, 174, 174, 147, 27, 63, 423, 423, 423, 423, 423, 423, 427, 426, 23, 23, ...
  23, 23, 33, 33, 33, 33, 21, 21, 21, 21, 45, 45, 30, 37, 267, 267, 13, 35, 74, 74, 70, 18, 49, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, ...
  36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 36, 18, 424, 80, 80, 80, 80, 80, 80, 80, 80, 31, 31, 31, 31, 31, 31, 31, 31, 173, 18, ...
  266, 165)
  declare %UI_skin[163] := (-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 2, 3, 4, 5, 2, 6, 6, ...
  6, 6, 6, 6, 6, 6, 6, 6, 7, 8, 9, 10, 11, 12, 13, 14, 2, 2, 2, 2, 2, 2, 2, 2, 0, 15, 16, 0, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 6, 6, ...
  6, 6, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 43, 44, 0, 45, 46, 46, 46, 46, 46, 46, 46, 46, 47, 47, 47, 47, 47, 46, 46, 46, 46, ...
  46, 46, 46, 47, 47, 47, 47, 47, 46, 46, 46, 46, 46, 46, 46, 47, 47, 47, 47, 47, 0, 48, 49, 50, 51, 52, 53, 54, 55, 56, 2, 2, 2, 2, 2, 2, 2, 2, 57, 0, ...
  58, 59)
  declare %UI_font[163] := (-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1)
  declare %UI_label_text[163] := (-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1)
  declare %UI_default_value[163] := (-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1)
  declare %UI_mouse_behaviour[163] := (-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -800, -800, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1)
  declare %UI_mouse_behaviour_x[163] := (-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1)
  declare %UI_mouse_behaviour_y[163] := (-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1)
  declare %UI_z_layer[163] := (-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 1, 1, 1, 1, 1, -1, -1, -1, -1, ...
  -1, -1, -1, 1, 1, 1, 1, 1, -1, -1, -1, -1, -1, -1, -1, 1, 1, 1, 1, 1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, ...
  -1, -1)
  declare !skin_picture[60]
  !skin_picture[0] := "label_transparent"
  !skin_picture[1] := "vel to sample start"
  !skin_picture[2] := "blank"
  !skin_picture[3] := "sixteenths"
  !skin_picture[4] := "eighths"
  !skin_picture[5] := "quarters"
  !skin_picture[6] := "dot"
  !skin_picture[7] := "clip title 7"
  !skin_picture[8] := "clip title 6"
  !skin_picture[9] := "clip title 5"
  !skin_picture[10] := "clip title 4"
  !skin_picture[11] := "clip title 3"
  !skin_picture[12] := "clip title 2"
  !skin_picture[13] := "clip title 1"
  !skin_picture[14] := "clip title 0"
  !skin_picture[15] := "next midi page"
  !skin_picture[16] := "prev midi page"
  !skin_picture[17] := "midi output mode"
  !skin_picture[18] := "title"
  !skin_picture[19] := "switch_releaseSamplesInfoDisp"
  !skin_picture[20] := "switch_legatoInfoDisp"
  !skin_picture[21] := "switch_directionInfoDisp"
  !skin_picture[22] := "switch_speedInfoDisp"
  !skin_picture[23] := "switch_optionsInfoDisp"
  !skin_picture[24] := "switch_articulationsInfoDisp"
  !skin_picture[25] := "switch_generalInfoDisp"
  !skin_picture[26] := "switch_closeTitleInfo"
  !skin_picture[27] := "6 step slider"
  !skin_picture[28] := "4 step slider"
  !skin_picture[29] := "3 step slider"
  !skin_picture[30] := "5 step slider"
  !skin_picture[31] := "release samples info"
  !skin_picture[32] := "legato info"
  !skin_picture[33] := "direction info"
  !skin_picture[34] := "speed info"
  !skin_picture[35] := "options info"
  !skin_picture[36] := "articulations info"
  !skin_picture[37] := "general info"
  !skin_picture[38] := "show midi"
  !skin_picture[39] := "next title page"
  !skin_picture[40] := "prev title page"
  !skin_picture[41] := "reverb menu"
  !skin_picture[42] := "latency"
  !skin_picture[43] := "knob"
  !skin_picture[44] := "Logo animation"
  !skin_picture[45] := "label_midiInstructions"
  !skin_picture[46] := "white key"
  !skin_picture[47] := "black key"
  !skin_picture[48] := "label_midiCover"
  !skin_picture[49] := "clip7"
  !skin_picture[50] := "clip6"
  !skin_picture[51] := "clip5"
  !skin_picture[52] := "clip4"
  !skin_picture[53] := "clip3"
  !skin_picture[54] := "clip2"
  !skin_picture[55] := "clip1"
  !skin_picture[56] := "clip0"
  !skin_picture[57] := "midi page description"
  !skin_picture[58] := "title page info"
  !skin_picture[59] := "label_midiOutputModeCover"
  declare !_labels_text[2*10]
  declare const $labels_text__SIZE_D1 := 2
  declare const $labels_text__SIZE_D2 := 10
  !_labels_text[10*0+0] := "EXPRESSION"
  !_labels_text[10*1+0] := "v1.0"
  declare %MULTI_LINE_DATA[2] := (1, 1)
  declare %font_file_ids[2]
  %font_file_ids[0] := get_font_id("Khula Regular Size 15")
  %font_file_ids[1] := get_font_id("Khula Bold Size 11 on")
  declare ui_panel $panel_UI
  declare ui_panel $panel_options
  declare ui_panel $panel_releaseSamples
  declare ui_panel $panel_legato
  declare ui_panel $panel_direction
  declare ui_panel $panel_speed
  declare ui_panel $panel_fx
  declare ui_panel $panel_reverb
  declare ui_panel $panel_vol
  declare ui_panel $panel_articulations
  declare ui_panel $panel_keyboard
  declare ui_panel $panel_midi
  declare ui_panel $panel_midiCover
  declare ui_panel $panel_midiPgChooser
  declare ui_panel $panel_titleInfo
  declare ui_switch $switch_Release3
  make_persistent($switch_Release3)
  read_persistent_var($switch_Release3)
  declare ui_switch $switch_Release2
  make_persistent($switch_Release2)
  read_persistent_var($switch_Release2)
  declare ui_switch $switch_Release1
  make_persistent($switch_Release1)
  read_persistent_var($switch_Release1)
  declare ui_switch $switch_Release0
  make_persistent($switch_Release0)
  read_persistent_var($switch_Release0)
  declare ui_switch $switch_autoRelease
  make_persistent($switch_autoRelease)
  read_persistent_var($switch_autoRelease)
  declare ui_switch $switch_noReleaseSample
  make_persistent($switch_noReleaseSample)
  read_persistent_var($switch_noReleaseSample)
  declare ui_switch $switch_syncToSwell
  make_persistent($switch_syncToSwell)
  read_persistent_var($switch_syncToSwell)
  declare ui_switch $switch_syncToRipple
  make_persistent($switch_syncToRipple)
  read_persistent_var($switch_syncToRipple)
  declare ui_switch $switch_syncToPitch
  make_persistent($switch_syncToPitch)
  read_persistent_var($switch_syncToPitch)
  declare ui_switch $switch_noLegato
  make_persistent($switch_noLegato)
  read_persistent_var($switch_noLegato)
  declare ui_switch $switch_velToSampleStart
  make_persistent($switch_velToSampleStart)
  read_persistent_var($switch_velToSampleStart)
  declare ui_switch $switch_up
  make_persistent($switch_up)
  read_persistent_var($switch_up)
  declare ui_switch $switch_asPlayed
  make_persistent($switch_asPlayed)
  read_persistent_var($switch_asPlayed)
  declare ui_switch $switch_down
  make_persistent($switch_down)
  read_persistent_var($switch_down)
  declare ui_switch $switch_doubleSpeed
  make_persistent($switch_doubleSpeed)
  read_persistent_var($switch_doubleSpeed)
  declare ui_switch $switch_fastTripletSpeed
  make_persistent($switch_fastTripletSpeed)
  read_persistent_var($switch_fastTripletSpeed)
  declare ui_switch $switch_fullSpeed
  make_persistent($switch_fullSpeed)
  read_persistent_var($switch_fullSpeed)
  declare ui_switch $switch_slowTripletSpeed
  make_persistent($switch_slowTripletSpeed)
  read_persistent_var($switch_slowTripletSpeed)
  declare ui_switch $switch_halfSpeed
  make_persistent($switch_halfSpeed)
  read_persistent_var($switch_halfSpeed)
  declare ui_switch $switch_reverbToggle
  make_persistent($switch_reverbToggle)
  read_persistent_var($switch_reverbToggle)
  declare ui_switch $switch_sixteenths
  make_persistent($switch_sixteenths)
  read_persistent_var($switch_sixteenths)
  declare ui_switch $switch_eighths
  make_persistent($switch_eighths)
  read_persistent_var($switch_eighths)
  declare ui_switch $switch_quarters
  make_persistent($switch_quarters)
  read_persistent_var($switch_quarters)
  declare ui_switch $switch_logoAnimTrigger
  make_persistent($switch_logoAnimTrigger)
  read_persistent_var($switch_logoAnimTrigger)
  declare ui_switch $switch_midiPgChooser0
  make_persistent($switch_midiPgChooser0)
  read_persistent_var($switch_midiPgChooser0)
  declare ui_switch $switch_midiPgChooser1
  make_persistent($switch_midiPgChooser1)
  read_persistent_var($switch_midiPgChooser1)
  declare ui_switch $switch_midiPgChooser2
  make_persistent($switch_midiPgChooser2)
  read_persistent_var($switch_midiPgChooser2)
  declare ui_switch $switch_midiPgChooser3
  make_persistent($switch_midiPgChooser3)
  read_persistent_var($switch_midiPgChooser3)
  declare ui_switch $switch_midiPgChooser4
  make_persistent($switch_midiPgChooser4)
  read_persistent_var($switch_midiPgChooser4)
  declare ui_switch $switch_midiPgChooser5
  make_persistent($switch_midiPgChooser5)
  read_persistent_var($switch_midiPgChooser5)
  declare ui_switch $switch_midiPgChooser6
  make_persistent($switch_midiPgChooser6)
  read_persistent_var($switch_midiPgChooser6)
  declare ui_switch $switch_midiPgChooser7
  make_persistent($switch_midiPgChooser7)
  read_persistent_var($switch_midiPgChooser7)
  declare ui_switch $switch_midiPgChooser8
  make_persistent($switch_midiPgChooser8)
  read_persistent_var($switch_midiPgChooser8)
  declare ui_switch $switch_midiPgChooser9
  make_persistent($switch_midiPgChooser9)
  read_persistent_var($switch_midiPgChooser9)
  declare ui_switch $switch_preview7
  make_persistent($switch_preview7)
  read_persistent_var($switch_preview7)
  declare ui_switch $switch_preview6
  make_persistent($switch_preview6)
  read_persistent_var($switch_preview6)
  declare ui_switch $switch_preview5
  make_persistent($switch_preview5)
  read_persistent_var($switch_preview5)
  declare ui_switch $switch_preview4
  make_persistent($switch_preview4)
  read_persistent_var($switch_preview4)
  declare ui_switch $switch_preview3
  make_persistent($switch_preview3)
  read_persistent_var($switch_preview3)
  declare ui_switch $switch_preview2
  make_persistent($switch_preview2)
  read_persistent_var($switch_preview2)
  declare ui_switch $switch_preview1
  make_persistent($switch_preview1)
  read_persistent_var($switch_preview1)
  declare ui_switch $switch_preview0
  make_persistent($switch_preview0)
  read_persistent_var($switch_preview0)
  declare ui_switch $switch_dndCover7
  make_persistent($switch_dndCover7)
  read_persistent_var($switch_dndCover7)
  declare ui_switch $switch_dndCover6
  make_persistent($switch_dndCover6)
  read_persistent_var($switch_dndCover6)
  declare ui_switch $switch_dndCover5
  make_persistent($switch_dndCover5)
  read_persistent_var($switch_dndCover5)
  declare ui_switch $switch_dndCover4
  make_persistent($switch_dndCover4)
  read_persistent_var($switch_dndCover4)
  declare ui_switch $switch_dndCover3
  make_persistent($switch_dndCover3)
  read_persistent_var($switch_dndCover3)
  declare ui_switch $switch_dndCover2
  make_persistent($switch_dndCover2)
  read_persistent_var($switch_dndCover2)
  declare ui_switch $switch_dndCover1
  make_persistent($switch_dndCover1)
  read_persistent_var($switch_dndCover1)
  declare ui_switch $switch_dndCover0
  make_persistent($switch_dndCover0)
  read_persistent_var($switch_dndCover0)
  declare ui_switch $switch_closeMidi2
  make_persistent($switch_closeMidi2)
  read_persistent_var($switch_closeMidi2)
  declare ui_switch $switch_nextMidiPg
  make_persistent($switch_nextMidiPg)
  read_persistent_var($switch_nextMidiPg)
  declare ui_switch $switch_prevMidiPg
  make_persistent($switch_prevMidiPg)
  read_persistent_var($switch_prevMidiPg)
  declare ui_switch $switch_closeMidi
  make_persistent($switch_closeMidi)
  read_persistent_var($switch_closeMidi)
  declare ui_switch $switch_midiOutputMode
  make_persistent($switch_midiOutputMode)
  read_persistent_var($switch_midiOutputMode)
  declare ui_switch $switch_openTitleInfo
  make_persistent($switch_openTitleInfo)
  read_persistent_var($switch_openTitleInfo)
  declare ui_switch $switch_releaseSamplesInfoDisp
  make_persistent($switch_releaseSamplesInfoDisp)
  read_persistent_var($switch_releaseSamplesInfoDisp)
  declare ui_switch $switch_legatoInfoDisp
  make_persistent($switch_legatoInfoDisp)
  read_persistent_var($switch_legatoInfoDisp)
  declare ui_switch $switch_directionInfoDisp
  make_persistent($switch_directionInfoDisp)
  read_persistent_var($switch_directionInfoDisp)
  declare ui_switch $switch_speedInfoDisp
  make_persistent($switch_speedInfoDisp)
  read_persistent_var($switch_speedInfoDisp)
  declare ui_switch $switch_optionsInfoDisp
  make_persistent($switch_optionsInfoDisp)
  read_persistent_var($switch_optionsInfoDisp)
  declare ui_switch $switch_articulationsInfoDisp
  make_persistent($switch_articulationsInfoDisp)
  read_persistent_var($switch_articulationsInfoDisp)
  declare ui_switch $switch_generalInfoDisp
  make_persistent($switch_generalInfoDisp)
  read_persistent_var($switch_generalInfoDisp)
  declare ui_switch $switch_closeTitleInfo
  make_persistent($switch_closeTitleInfo)
  read_persistent_var($switch_closeTitleInfo)
  declare ui_switch $switch_titlePgSelector3
  make_persistent($switch_titlePgSelector3)
  read_persistent_var($switch_titlePgSelector3)
  declare ui_switch $switch_titlePgSelector2
  make_persistent($switch_titlePgSelector2)
  read_persistent_var($switch_titlePgSelector2)
  declare ui_switch $switch_titlePgSelector1
  make_persistent($switch_titlePgSelector1)
  read_persistent_var($switch_titlePgSelector1)
  declare ui_switch $switch_titlePgSelector0
  make_persistent($switch_titlePgSelector0)
  read_persistent_var($switch_titlePgSelector0)
  declare ui_xy ?xypad_releaseSamples[2]
  make_persistent(?xypad_releaseSamples)
  read_persistent_var(?xypad_releaseSamples)
  declare ui_xy ?xypad_legato[2]
  make_persistent(?xypad_legato)
  read_persistent_var(?xypad_legato)
  declare ui_xy ?xypad_direction[2]
  make_persistent(?xypad_direction)
  read_persistent_var(?xypad_direction)
  declare ui_xy ?xypad_speed[2]
  make_persistent(?xypad_speed)
  read_persistent_var(?xypad_speed)
  declare ui_button $button_releaseSamplesInfo
  make_persistent($button_releaseSamplesInfo)
  read_persistent_var($button_releaseSamplesInfo)
  declare ui_button $button_legatoInfo
  make_persistent($button_legatoInfo)
  read_persistent_var($button_legatoInfo)
  declare ui_button $button_directionInfo
  make_persistent($button_directionInfo)
  read_persistent_var($button_directionInfo)
  declare ui_button $button_speedInfo
  make_persistent($button_speedInfo)
  read_persistent_var($button_speedInfo)
  declare ui_button $button_optionsInfo
  make_persistent($button_optionsInfo)
  read_persistent_var($button_optionsInfo)
  declare ui_button $button_articulationsInfo
  make_persistent($button_articulationsInfo)
  read_persistent_var($button_articulationsInfo)
  declare ui_button $button_generalInfo
  make_persistent($button_generalInfo)
  read_persistent_var($button_generalInfo)
  declare ui_button $button_showMidi
  make_persistent($button_showMidi)
  read_persistent_var($button_showMidi)
  declare ui_button $button_nextTitlePg
  make_persistent($button_nextTitlePg)
  read_persistent_var($button_nextTitlePg)
  declare ui_button $button_prevTitlePg
  make_persistent($button_prevTitlePg)
  read_persistent_var($button_prevTitlePg)
  declare ui_menu $menu_reverb
  make_persistent($menu_reverb)
  read_persistent_var($menu_reverb)
  declare ui_menu $menu_latency
  make_persistent($menu_latency)
  read_persistent_var($menu_latency)
  declare ui_slider $slider_reverb(0,1000000)
  make_persistent($slider_reverb)
  read_persistent_var($slider_reverb)
  declare ui_slider $slider_vol(0,1000000)
  make_persistent($slider_vol)
  read_persistent_var($slider_vol)
  declare ui_slider $slider_logoAnim(0,127)
  make_persistent($slider_logoAnim)
  read_persistent_var($slider_logoAnim)
  declare ui_label $label_vol(1,1)
  make_persistent($label_vol)
  read_persistent_var($label_vol)
  declare ui_label $label_midiInstructions(1,1)
  make_persistent($label_midiInstructions)
  read_persistent_var($label_midiInstructions)
  declare ui_label $label_oct2__note12(1,1)
  make_persistent($label_oct2__note12)
  read_persistent_var($label_oct2__note12)
  declare ui_label $label_oct2__note11(1,1)
  make_persistent($label_oct2__note11)
  read_persistent_var($label_oct2__note11)
  declare ui_label $label_oct2__note9(1,1)
  make_persistent($label_oct2__note9)
  read_persistent_var($label_oct2__note9)
  declare ui_label $label_oct2__note7(1,1)
  make_persistent($label_oct2__note7)
  read_persistent_var($label_oct2__note7)
  declare ui_label $label_oct2__note5(1,1)
  make_persistent($label_oct2__note5)
  read_persistent_var($label_oct2__note5)
  declare ui_label $label_oct2__note4(1,1)
  make_persistent($label_oct2__note4)
  read_persistent_var($label_oct2__note4)
  declare ui_label $label_oct2__note2(1,1)
  make_persistent($label_oct2__note2)
  read_persistent_var($label_oct2__note2)
  declare ui_label $label_oct2__note0(1,1)
  make_persistent($label_oct2__note0)
  read_persistent_var($label_oct2__note0)
  declare ui_label $label_oct2__note10(1,1)
  make_persistent($label_oct2__note10)
  read_persistent_var($label_oct2__note10)
  declare ui_label $label_oct2__note8(1,1)
  make_persistent($label_oct2__note8)
  read_persistent_var($label_oct2__note8)
  declare ui_label $label_oct2__note6(1,1)
  make_persistent($label_oct2__note6)
  read_persistent_var($label_oct2__note6)
  declare ui_label $label_oct2__note3(1,1)
  make_persistent($label_oct2__note3)
  read_persistent_var($label_oct2__note3)
  declare ui_label $label_oct2__note1(1,1)
  make_persistent($label_oct2__note1)
  read_persistent_var($label_oct2__note1)
  declare ui_label $label_oct1__note11(1,1)
  make_persistent($label_oct1__note11)
  read_persistent_var($label_oct1__note11)
  declare ui_label $label_oct1__note9(1,1)
  make_persistent($label_oct1__note9)
  read_persistent_var($label_oct1__note9)
  declare ui_label $label_oct1__note7(1,1)
  make_persistent($label_oct1__note7)
  read_persistent_var($label_oct1__note7)
  declare ui_label $label_oct1__note5(1,1)
  make_persistent($label_oct1__note5)
  read_persistent_var($label_oct1__note5)
  declare ui_label $label_oct1__note4(1,1)
  make_persistent($label_oct1__note4)
  read_persistent_var($label_oct1__note4)
  declare ui_label $label_oct1__note2(1,1)
  make_persistent($label_oct1__note2)
  read_persistent_var($label_oct1__note2)
  declare ui_label $label_oct1__note0(1,1)
  make_persistent($label_oct1__note0)
  read_persistent_var($label_oct1__note0)
  declare ui_label $label_oct1__note10(1,1)
  make_persistent($label_oct1__note10)
  read_persistent_var($label_oct1__note10)
  declare ui_label $label_oct1__note8(1,1)
  make_persistent($label_oct1__note8)
  read_persistent_var($label_oct1__note8)
  declare ui_label $label_oct1__note6(1,1)
  make_persistent($label_oct1__note6)
  read_persistent_var($label_oct1__note6)
  declare ui_label $label_oct1__note3(1,1)
  make_persistent($label_oct1__note3)
  read_persistent_var($label_oct1__note3)
  declare ui_label $label_oct1__note1(1,1)
  make_persistent($label_oct1__note1)
  read_persistent_var($label_oct1__note1)
  declare ui_label $label_oct0__note11(1,1)
  make_persistent($label_oct0__note11)
  read_persistent_var($label_oct0__note11)
  declare ui_label $label_oct0__note9(1,1)
  make_persistent($label_oct0__note9)
  read_persistent_var($label_oct0__note9)
  declare ui_label $label_oct0__note7(1,1)
  make_persistent($label_oct0__note7)
  read_persistent_var($label_oct0__note7)
  declare ui_label $label_oct0__note5(1,1)
  make_persistent($label_oct0__note5)
  read_persistent_var($label_oct0__note5)
  declare ui_label $label_oct0__note4(1,1)
  make_persistent($label_oct0__note4)
  read_persistent_var($label_oct0__note4)
  declare ui_label $label_oct0__note2(1,1)
  make_persistent($label_oct0__note2)
  read_persistent_var($label_oct0__note2)
  declare ui_label $label_oct0__note0(1,1)
  make_persistent($label_oct0__note0)
  read_persistent_var($label_oct0__note0)
  declare ui_label $label_oct0__note10(1,1)
  make_persistent($label_oct0__note10)
  read_persistent_var($label_oct0__note10)
  declare ui_label $label_oct0__note8(1,1)
  make_persistent($label_oct0__note8)
  read_persistent_var($label_oct0__note8)
  declare ui_label $label_oct0__note6(1,1)
  make_persistent($label_oct0__note6)
  read_persistent_var($label_oct0__note6)
  declare ui_label $label_oct0__note3(1,1)
  make_persistent($label_oct0__note3)
  read_persistent_var($label_oct0__note3)
  declare ui_label $label_oct0__note1(1,1)
  make_persistent($label_oct0__note1)
  read_persistent_var($label_oct0__note1)
  declare ui_label $label_version(1,1)
  make_persistent($label_version)
  read_persistent_var($label_version)
  declare ui_label $label_midiCover(1,1)
  make_persistent($label_midiCover)
  read_persistent_var($label_midiCover)
  declare ui_label $label_clip7(1,1)
  make_persistent($label_clip7)
  read_persistent_var($label_clip7)
  declare ui_label $label_clip6(1,1)
  make_persistent($label_clip6)
  read_persistent_var($label_clip6)
  declare ui_label $label_clip5(1,1)
  make_persistent($label_clip5)
  read_persistent_var($label_clip5)
  declare ui_label $label_clip4(1,1)
  make_persistent($label_clip4)
  read_persistent_var($label_clip4)
  declare ui_label $label_clip3(1,1)
  make_persistent($label_clip3)
  read_persistent_var($label_clip3)
  declare ui_label $label_clip2(1,1)
  make_persistent($label_clip2)
  read_persistent_var($label_clip2)
  declare ui_label $label_clip1(1,1)
  make_persistent($label_clip1)
  read_persistent_var($label_clip1)
  declare ui_label $label_clip0(1,1)
  make_persistent($label_clip0)
  read_persistent_var($label_clip0)
  declare ui_label $label_clip_dnd7(1,1)
  make_persistent($label_clip_dnd7)
  read_persistent_var($label_clip_dnd7)
  declare ui_label $label_clip_dnd6(1,1)
  make_persistent($label_clip_dnd6)
  read_persistent_var($label_clip_dnd6)
  declare ui_label $label_clip_dnd5(1,1)
  make_persistent($label_clip_dnd5)
  read_persistent_var($label_clip_dnd5)
  declare ui_label $label_clip_dnd4(1,1)
  make_persistent($label_clip_dnd4)
  read_persistent_var($label_clip_dnd4)
  declare ui_label $label_clip_dnd3(1,1)
  make_persistent($label_clip_dnd3)
  read_persistent_var($label_clip_dnd3)
  declare ui_label $label_clip_dnd2(1,1)
  make_persistent($label_clip_dnd2)
  read_persistent_var($label_clip_dnd2)
  declare ui_label $label_clip_dnd1(1,1)
  make_persistent($label_clip_dnd1)
  read_persistent_var($label_clip_dnd1)
  declare ui_label $label_clip_dnd0(1,1)
  make_persistent($label_clip_dnd0)
  read_persistent_var($label_clip_dnd0)
  declare ui_label $label_midiPgDescription(1,1)
  make_persistent($label_midiPgDescription)
  read_persistent_var($label_midiPgDescription)
  declare ui_label $label_latency(1,1)
  make_persistent($label_latency)
  read_persistent_var($label_latency)
  declare ui_label $label_titlePg(1,1)
  make_persistent($label_titlePg)
  read_persistent_var($label_titlePg)
  declare ui_label $label_midiOutputModeCover(1,1)
  make_persistent($label_midiOutputModeCover)
  read_persistent_var($label_midiOutputModeCover)
  declare %UI_ID[10000] := (0)
  %UI_ID[0] := get_ui_id($panel_UI)
  $figma_counter := 1
  while ($figma_counter<163)
    %UI_ID[$figma_counter] := %UI_ID[0]+$figma_counter
    inc($figma_counter)
  end while
  declare %panel_idx[163] := (0, 1, 1, 1, 1, 0, 6, 6, 0, 0, 0, 11, 11, 0, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 4, 4, 4, 5, 5, 5, 5, 5, 7, 9, 9, 9, 0, 13, 13, 13, ...
  13, 13, 13, 13, 13, 13, 13, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 14, 14, 14, 14, ...
  14, 2, 3, 4, 5, 2, 3, 4, 5, 1, 9, 0, 0, 14, 14, 7, 0, 7, 8, 0, 8, 0, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, ...
  10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 0, 12, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 0, 14, ...
  0)
  declare %element_idx[163] := (1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, ...
  42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, ...
  82, 83, 84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97, 98, 99, 100, 101, 102, 103, 104, 105, 106, 107, 108, 109, 110, 111, 112, 113, 114, 115, 116, 117, 118, 119, 120, 121, ...
  122, 123, 124, 125, 126, 127, 128, 129, 130, 131, 132, 133, 134, 135, 136, 137, 138, 139, 140, 141, 142, 143, 144, 145, 146, 147, 148, 149, 150, 151, 152, 153, 154, 155, 156, 157, 158, 159, 160, 161, ...
  162)
  $figma_counter := 1
  while ($figma_counter<num_elements(%panel_idx))
    if (%panel_idx[$figma_counter] # -1)
      set_control_par(%UI_ID[$figma_counter],$CONTROL_PAR_PARENT_PANEL,%UI_ID[%panel_idx[$figma_counter-1]])
    end if
    inc($figma_counter)
  end while
  $figma_counter := 0
  while ($figma_counter<163)
    set_control_par_str(%UI_ID[$figma_counter],$CONTROL_PAR_TEXT,"")
    set_control_par(%UI_ID[$figma_counter],$CONTROL_PAR_WIDTH,%UI_width[$figma_counter])
    set_control_par(%UI_ID[$figma_counter],$CONTROL_PAR_HEIGHT,%UI_height[$figma_counter])
    set_control_par(%UI_ID[$figma_counter],$CONTROL_PAR_POS_X,%UI_x[$figma_counter])
    set_control_par(%UI_ID[$figma_counter],$CONTROL_PAR_POS_Y,%UI_y[$figma_counter])
    set_control_par(%UI_ID[$figma_counter],$CONTROL_PAR_DEFAULT_VALUE,%UI_default_value[$figma_counter])
    set_control_par(%UI_ID[$figma_counter],$CONTROL_PAR_Z_LAYER,%UI_z_layer[$figma_counter])
    if (%UI_mouse_behaviour[$figma_counter] # -1)
      set_control_par(%UI_ID[$figma_counter],$CONTROL_PAR_MOUSE_BEHAVIOUR,%UI_mouse_behaviour[$figma_counter])
    end if
    if (%UI_mouse_behaviour_x[$figma_counter] # -1)
      set_control_par(%UI_ID[$figma_counter],$CONTROL_PAR_MOUSE_BEHAVIOUR_X,%UI_mouse_behaviour_x[$figma_counter])
    end if
    if (%UI_mouse_behaviour_y[$figma_counter] # -1)
      set_control_par(%UI_ID[$figma_counter],$CONTROL_PAR_MOUSE_BEHAVIOUR_Y,%UI_mouse_behaviour[$figma_counter])
    end if
    if (%UI_skin[$figma_counter] # -1)
      set_control_par_str(%UI_ID[$figma_counter],$CONTROL_PAR_PICTURE,!skin_picture[%UI_skin[$figma_counter]])
    end if
    if (%UI_label_text[$figma_counter]>-1)
      set_control_par_str(%UI_ID[$figma_counter],$CONTROL_PAR_TEXT,!_labels_text[10*%UI_label_text[$figma_counter]+0])
      set_control_par(%UI_ID[$figma_counter],$CONTROL_PAR_TEXTPOS_Y,0)
      if (%MULTI_LINE_DATA[%UI_label_text[$figma_counter]]>1)
        $figma_counter_multi_line_labels := 0
        while ($figma_counter_multi_line_labels<(%MULTI_LINE_DATA[%UI_label_text[$figma_counter]]-1))
          set_control_par_str(%UI_ID[$figma_counter],$CONTROL_PAR_TEXTLINE,!_labels_text[10*%UI_label_text[$figma_counter]+$figma_counter_multi_line_labels+1])
          inc($figma_counter_multi_line_labels)
        end while
      end if
    end if
    if (%UI_font[$figma_counter] # -1)
      set_control_par(%UI_ID[$figma_counter],$CONTROL_PAR_FONT_TYPE,%font_file_ids[%UI_font[$figma_counter]])
    end if
    set_control_par(%UI_ID[$figma_counter],$CONTROL_PAR_HIDE,$HIDE_PART_NOTHING)
    inc($figma_counter)
  end while
  set_ui_height_px(427+(%dev_mode[0]*50))
  set_control_par_str($INST_ICON_ID,$CONTROL_PAR_PICTURE,"insticon")
  set_control_par(get_ui_id($label_version),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
  set_control_par(get_ui_id($label_midiOutputModeCover),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
  declare %switch_titlePgSelector[4]
  %switch_titlePgSelector[0] := get_ui_id($switch_titlePgSelector0)
  %switch_titlePgSelector[1] := get_ui_id($switch_titlePgSelector1)
  %switch_titlePgSelector[2] := get_ui_id($switch_titlePgSelector2)
  %switch_titlePgSelector[3] := get_ui_id($switch_titlePgSelector3)
  declare %switch_midiPgChooser[10]
  %switch_midiPgChooser[0] := get_ui_id($switch_midiPgChooser0)
  %switch_midiPgChooser[1] := get_ui_id($switch_midiPgChooser1)
  %switch_midiPgChooser[2] := get_ui_id($switch_midiPgChooser2)
  %switch_midiPgChooser[3] := get_ui_id($switch_midiPgChooser3)
  %switch_midiPgChooser[4] := get_ui_id($switch_midiPgChooser4)
  %switch_midiPgChooser[5] := get_ui_id($switch_midiPgChooser5)
  %switch_midiPgChooser[6] := get_ui_id($switch_midiPgChooser6)
  %switch_midiPgChooser[7] := get_ui_id($switch_midiPgChooser7)
  %switch_midiPgChooser[8] := get_ui_id($switch_midiPgChooser8)
  %switch_midiPgChooser[9] := get_ui_id($switch_midiPgChooser9)
  $i := 0
  while ($i<10)
    set_control_par(%switch_midiPgChooser[$i],$CONTROL_PAR_VALUE,0)
    inc($i)
  end while
  set_control_par(%switch_midiPgChooser[0],$CONTROL_PAR_VALUE,1)
  declare ui_label $mf_cursor(2,2)
  set_control_par_str(get_ui_id($mf_cursor),$CONTROL_PAR_PICTURE,"mf_cursor")
  set_control_par_str(get_ui_id($mf_cursor),$CONTROL_PAR_TEXT,"")
  set_control_par(get_ui_id($mf_cursor),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
  set_control_par(get_ui_id($mf_cursor),$CONTROL_PAR_PARENT_PANEL,get_ui_id($panel_midi))
  set_control_par(get_ui_id($mf_cursor),$CONTROL_PAR_Z_LAYER,-1)
  set_control_par(get_ui_id($mf_cursor),$CONTROL_PAR_POS_X,0)
  set_control_par(get_ui_id($mf_cursor),$CONTROL_PAR_POS_Y,0)
  declare %label_clip[8]
  declare %switch_preview[8]
  declare %midi_clip_title_id[8]
  declare %midi_clip_dnd_id[8]
  %label_clip[0] := get_ui_id($label_clip0)
  %switch_preview[0] := get_ui_id($switch_preview0)
  %midi_clip_dnd_id[0] := get_ui_id($label_clip_dnd0)
  %label_clip[1] := get_ui_id($label_clip1)
  %switch_preview[1] := get_ui_id($switch_preview1)
  %midi_clip_dnd_id[1] := get_ui_id($label_clip_dnd1)
  %label_clip[2] := get_ui_id($label_clip2)
  %switch_preview[2] := get_ui_id($switch_preview2)
  %midi_clip_dnd_id[2] := get_ui_id($label_clip_dnd2)
  %label_clip[3] := get_ui_id($label_clip3)
  %switch_preview[3] := get_ui_id($switch_preview3)
  %midi_clip_dnd_id[3] := get_ui_id($label_clip_dnd3)
  %label_clip[4] := get_ui_id($label_clip4)
  %switch_preview[4] := get_ui_id($switch_preview4)
  %midi_clip_dnd_id[4] := get_ui_id($label_clip_dnd4)
  %label_clip[5] := get_ui_id($label_clip5)
  %switch_preview[5] := get_ui_id($switch_preview5)
  %midi_clip_dnd_id[5] := get_ui_id($label_clip_dnd5)
  %label_clip[6] := get_ui_id($label_clip6)
  %switch_preview[6] := get_ui_id($switch_preview6)
  %midi_clip_dnd_id[6] := get_ui_id($label_clip_dnd6)
  %label_clip[7] := get_ui_id($label_clip7)
  %switch_preview[7] := get_ui_id($switch_preview7)
  %midi_clip_dnd_id[7] := get_ui_id($label_clip_dnd7)
  $i := 0
  while ($i<80)
    mf_set_export_area(!clip_names[$i],-1,-1,$i,$i)
    mf_copy_export_area($i+1)
    inc($i)
  end while
  $i := 0
  while ($i<8)
    set_control_par(%midi_clip_dnd_id[$i],$CONTROL_PAR_DND_BEHAVIOUR,1)
    set_control_par(%switch_preview[$i],$CONTROL_PAR_VALUE,0)
    inc($i)
  end while
  $button_showMidi := 0
  set_control_par(get_ui_id($switch_closeMidi),$CONTROL_PAR_HIDE,%hide_states[$button_showMidi])
  set_control_par(get_ui_id($panel_midi),$CONTROL_PAR_HIDE,%hide_states[$button_showMidi])
  set_control_par(get_ui_id($label_midiInstructions),$CONTROL_PAR_HIDE,%hide_states[$button_showMidi])
  ~midiInstructions_opacity := int_to_real($button_showMidi)
  ~midiCover_opacity := int_to_real($button_showMidi)
  set_control_par(get_ui_id($panel_articulations),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($panel_fx),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($panel_speed),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id(?xypad_speed),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($panel_direction),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id(?xypad_direction),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($panel_legato),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id(?xypad_legato),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($panel_releaseSamples),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id(?xypad_releaseSamples),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($button_generalInfo),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($button_optionsInfo),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($menu_latency),$CONTROL_PAR_TEXTPOS_Y,100)
  add_menu_item($menu_latency,"Start Time: Tightened: 0 ms delay",0)
  add_menu_item($menu_latency,"Start Time: Middle, slight adjustment: 50 ms delay",50)
  add_menu_item($menu_latency,"Start Time: Natural, as played: 100 ms delay",100)
  set_control_par(get_ui_id($label_latency),$CONTROL_PAR_FONT_TYPE,get_font_id("Khula Bold Size 11 on"))
  set_control_par(get_ui_id($label_latency),$CONTROL_PAR_TEXT_ALIGNMENT,1)
  set_control_par_str(get_ui_id($label_latency),$CONTROL_PAR_TEXT,$menu_latency & "ms")
  set_control_par(get_ui_id($label_midiOutputModeCover),$CONTROL_PAR_HIDE,%hide_states[$switch_midiOutputMode])
  set_control_par(get_ui_id($panel_midi),$CONTROL_PAR_Z_LAYER,0)
  set_control_par(get_ui_id($panel_titleInfo),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
  set_control_par(get_ui_id($switch_generalInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
  set_control_par(get_ui_id($switch_articulationsInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
  set_control_par(get_ui_id($switch_optionsInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
  set_control_par(get_ui_id($switch_speedInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
  set_control_par(get_ui_id($switch_directionInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
  set_control_par(get_ui_id($switch_legatoInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
  set_control_par(get_ui_id($switch_releaseSamplesInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
  set_control_par(get_ui_id($panel_titleInfo),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($label_titlePg),$CONTROL_PAR_Z_LAYER,1)
  $i := 0
  while ($i<4)
    set_control_par(%switch_titlePgSelector[$i],$CONTROL_PAR_Z_LAYER,1)
    inc($i)
  end while
  set_control_par(get_ui_id($button_prevTitlePg),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($button_nextTitlePg),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($switch_generalInfoDisp),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($switch_articulationsInfoDisp),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($switch_optionsInfoDisp),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($switch_speedInfoDisp),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($switch_directionInfoDisp),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($switch_legatoInfoDisp),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($switch_releaseSamplesInfoDisp),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($panel_midiPgChooser),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($switch_midiPgChooser0),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($switch_midiPgChooser1),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($panel_articulations),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($panel_fx),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($panel_speed),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($panel_direction),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($panel_legato),$CONTROL_PAR_Z_LAYER,1)
  set_control_par(get_ui_id($panel_releaseSamples),$CONTROL_PAR_Z_LAYER,1)
  declare %key_ids[128]
  %key_ids[0+$LOWEST_KEY] := get_ui_id($label_oct0__note0)
  %key_ids[0+$LOWEST_KEY+12] := get_ui_id($label_oct1__note0)
  %key_ids[0+$LOWEST_KEY+(12*2)] := get_ui_id($label_oct2__note0)
  %key_ids[1+$LOWEST_KEY] := get_ui_id($label_oct0__note1)
  %key_ids[1+$LOWEST_KEY+12] := get_ui_id($label_oct1__note1)
  %key_ids[1+$LOWEST_KEY+(12*2)] := get_ui_id($label_oct2__note1)
  %key_ids[2+$LOWEST_KEY] := get_ui_id($label_oct0__note2)
  %key_ids[2+$LOWEST_KEY+12] := get_ui_id($label_oct1__note2)
  %key_ids[2+$LOWEST_KEY+(12*2)] := get_ui_id($label_oct2__note2)
  %key_ids[3+$LOWEST_KEY] := get_ui_id($label_oct0__note3)
  %key_ids[3+$LOWEST_KEY+12] := get_ui_id($label_oct1__note3)
  %key_ids[3+$LOWEST_KEY+(12*2)] := get_ui_id($label_oct2__note3)
  %key_ids[4+$LOWEST_KEY] := get_ui_id($label_oct0__note4)
  %key_ids[4+$LOWEST_KEY+12] := get_ui_id($label_oct1__note4)
  %key_ids[4+$LOWEST_KEY+(12*2)] := get_ui_id($label_oct2__note4)
  %key_ids[5+$LOWEST_KEY] := get_ui_id($label_oct0__note5)
  %key_ids[5+$LOWEST_KEY+12] := get_ui_id($label_oct1__note5)
  %key_ids[5+$LOWEST_KEY+(12*2)] := get_ui_id($label_oct2__note5)
  %key_ids[6+$LOWEST_KEY] := get_ui_id($label_oct0__note6)
  %key_ids[6+$LOWEST_KEY+12] := get_ui_id($label_oct1__note6)
  %key_ids[6+$LOWEST_KEY+(12*2)] := get_ui_id($label_oct2__note6)
  %key_ids[7+$LOWEST_KEY] := get_ui_id($label_oct0__note7)
  %key_ids[7+$LOWEST_KEY+12] := get_ui_id($label_oct1__note7)
  %key_ids[7+$LOWEST_KEY+(12*2)] := get_ui_id($label_oct2__note7)
  %key_ids[8+$LOWEST_KEY] := get_ui_id($label_oct0__note8)
  %key_ids[8+$LOWEST_KEY+12] := get_ui_id($label_oct1__note8)
  %key_ids[8+$LOWEST_KEY+(12*2)] := get_ui_id($label_oct2__note8)
  %key_ids[9+$LOWEST_KEY] := get_ui_id($label_oct0__note9)
  %key_ids[9+$LOWEST_KEY+12] := get_ui_id($label_oct1__note9)
  %key_ids[9+$LOWEST_KEY+(12*2)] := get_ui_id($label_oct2__note9)
  %key_ids[10+$LOWEST_KEY] := get_ui_id($label_oct0__note10)
  %key_ids[10+$LOWEST_KEY+12] := get_ui_id($label_oct1__note10)
  %key_ids[10+$LOWEST_KEY+(12*2)] := get_ui_id($label_oct2__note10)
  %key_ids[11+$LOWEST_KEY] := get_ui_id($label_oct0__note11)
  %key_ids[11+$LOWEST_KEY+12] := get_ui_id($label_oct1__note11)
  %key_ids[11+$LOWEST_KEY+(12*2)] := get_ui_id($label_oct2__note11)
  %key_ids[72] := get_ui_id($label_oct2__note12)
  $key_i := $LOWEST_KEY
  while ($key_i<=$HIGHEST_KEY)
    set_control_par(%key_ids[$key_i],$CONTROL_PAR_VALUE,0)
    inc($key_i)
  end while
  declare !reverb_preset_names[3]
  !reverb_preset_names[0] := "Small"
  !reverb_preset_names[1] := "Medium"
  !reverb_preset_names[2] := "Large"
  declare %_reverb_preset[3*8]
  make_persistent(%_reverb_preset)
  read_persistent_var(%_reverb_preset)
  declare const $reverb_preset__SIZE_D1 := 3
  declare const $reverb_preset__SIZE_D2 := 8
  $i := 0
  while ($i<3)
    add_menu_item($menu_reverb,!reverb_preset_names[$i],$i)
    inc($i)
  end while
  set_control_par(get_ui_id($switch_reverbToggle),$CONTROL_PAR_TEXT_ALIGNMENT,0)
  set_control_par_str(get_ui_id($switch_reverbToggle),$CONTROL_PAR_TEXT,"REVERB")
  set_control_par(get_ui_id($label_vol),$CONTROL_PAR_FONT_TYPE,get_font_id("Khula Bold Size 11 on"))
  set_control_par(get_ui_id($switch_reverbToggle),$CONTROL_PAR_FONT_TYPE,get_font_id("Khula Bold Size 11 off"))
  set_control_par(get_ui_id($switch_reverbToggle),$CONTROL_PAR_FONT_TYPE_ON,get_font_id("Khula Bold Size 11 on"))
  set_control_par(get_ui_id($switch_reverbToggle),$CONTROL_PAR_FONT_TYPE_OFF_PRESSED,get_font_id("Khula Bold Size 11 off pressed"))
  set_control_par(get_ui_id($switch_reverbToggle),$CONTROL_PAR_FONT_TYPE_ON_PRESSED,get_font_id("Khula Bold Size 11 on pressed"))
  set_control_par(get_ui_id($switch_reverbToggle),$CONTROL_PAR_FONT_TYPE_OFF_HOVER,get_font_id("Khula Bold Size 11 off hover"))
  set_control_par(get_ui_id($switch_reverbToggle),$CONTROL_PAR_FONT_TYPE_ON_HOVER,get_font_id("Khula Bold Size 11 on hover"))
  set_control_par(get_ui_id($switch_reverbToggle),$CONTROL_PAR_DISABLE_TEXT_SHIFTING,1)
  set_control_par_str(get_ui_id($switch_reverbToggle),$CONTROL_PAR_AUTOMATION_NAME,0)
  declare %articulation_ids[3]
  %articulation_ids[$artic__quarters] := get_ui_id($switch_quarters)
  %articulation_ids[$artic__eighths] := get_ui_id($switch_eighths)
  %articulation_ids[$artic__sixteenths] := get_ui_id($switch_sixteenths)
  $i := 0
  while ($i<3)
    set_control_par(%articulation_ids[$i],$CONTROL_PAR_ALLOW_AUTOMATION,0)
    inc($i)
  end while
  $i := 0
  set_control_par(get_ui_id(?xypad_speed),$CONTROL_PAR_MOUSE_MODE,2)
  set_control_par_str_arr(get_ui_id(?xypad_speed),$CONTROL_PAR_CURSOR_PICTURE,"label_transparent",0)
  declare ui_slider $speed_nks(0,5-1)
  make_persistent($speed_nks)
  read_persistent_var($speed_nks)
  set_control_par(get_ui_id($speed_nks),$CONTROL_PAR_POS_X,$i*100)
  set_control_par(get_ui_id($speed_nks),$CONTROL_PAR_POS_Y,427)
  inc($i)
  set_control_par(get_ui_id(?xypad_direction),$CONTROL_PAR_MOUSE_MODE,2)
  set_control_par_str_arr(get_ui_id(?xypad_direction),$CONTROL_PAR_CURSOR_PICTURE,"label_transparent",0)
  declare ui_slider $direction_nks(0,3-1)
  make_persistent($direction_nks)
  read_persistent_var($direction_nks)
  set_control_par(get_ui_id($direction_nks),$CONTROL_PAR_POS_X,$i*100)
  set_control_par(get_ui_id($direction_nks),$CONTROL_PAR_POS_Y,427)
  inc($i)
  set_control_par(get_ui_id(?xypad_legato),$CONTROL_PAR_MOUSE_MODE,2)
  set_control_par_str_arr(get_ui_id(?xypad_legato),$CONTROL_PAR_CURSOR_PICTURE,"label_transparent",0)
  declare ui_slider $legato_nks(0,4-1)
  make_persistent($legato_nks)
  read_persistent_var($legato_nks)
  set_control_par(get_ui_id($legato_nks),$CONTROL_PAR_POS_X,$i*100)
  set_control_par(get_ui_id($legato_nks),$CONTROL_PAR_POS_Y,427)
  inc($i)
  set_control_par(get_ui_id(?xypad_releaseSamples),$CONTROL_PAR_MOUSE_MODE,2)
  set_control_par_str_arr(get_ui_id(?xypad_releaseSamples),$CONTROL_PAR_CURSOR_PICTURE,"label_transparent",0)
  declare ui_slider $releaseSamples_nks(0,6-1)
  make_persistent($releaseSamples_nks)
  read_persistent_var($releaseSamples_nks)
  set_control_par(get_ui_id($releaseSamples_nks),$CONTROL_PAR_POS_X,$i*100)
  set_control_par(get_ui_id($releaseSamples_nks),$CONTROL_PAR_POS_Y,427)
  inc($i)
  declare %speed_ids[5]
  %speed_ids[$speedMode__halfSpeed] := get_ui_id($switch_halfSpeed)
  %speed_ids[$speedMode__slowTripletSpeed] := get_ui_id($switch_slowTripletSpeed)
  %speed_ids[$speedMode__fullSpeed] := get_ui_id($switch_fullSpeed)
  %speed_ids[$speedMode__fastTripletSpeed] := get_ui_id($switch_fastTripletSpeed)
  %speed_ids[$speedMode__doubleSpeed] := get_ui_id($switch_doubleSpeed)
  $i := 0
  while ($i<num_elements(%speed_ids))
    set_control_par(%speed_ids[$i],$CONTROL_PAR_FONT_TYPE,get_font_id("Khula Bold Size 11 off"))
    set_control_par(%speed_ids[$i],$CONTROL_PAR_FONT_TYPE_ON,get_font_id("Khula Bold Size 11 on"))
    set_control_par(%speed_ids[$i],$CONTROL_PAR_FONT_TYPE_OFF_PRESSED,get_font_id("Khula Bold Size 11 off pressed"))
    set_control_par(%speed_ids[$i],$CONTROL_PAR_FONT_TYPE_ON_PRESSED,get_font_id("Khula Bold Size 11 on pressed"))
    set_control_par(%speed_ids[$i],$CONTROL_PAR_FONT_TYPE_OFF_HOVER,get_font_id("Khula Bold Size 11 off hover"))
    set_control_par(%speed_ids[$i],$CONTROL_PAR_FONT_TYPE_ON_HOVER,get_font_id("Khula Bold Size 11 on hover"))
    set_control_par_str(%speed_ids[$i],$CONTROL_PAR_TEXT,!speed_texts[$i])
    set_control_par(%speed_ids[$i],$CONTROL_PAR_WIDTH,get_control_par(%speed_ids[$i],$CONTROL_PAR_WIDTH)+14)
    inc($i)
  end while
  declare %direction_ids[3]
  %direction_ids[$directionMode__down] := get_ui_id($switch_down)
  %direction_ids[$directionMode__asPlayed] := get_ui_id($switch_asPlayed)
  %direction_ids[$directionMode__up] := get_ui_id($switch_up)
  $i := 0
  while ($i<num_elements(%direction_ids))
    set_control_par(%direction_ids[$i],$CONTROL_PAR_FONT_TYPE,get_font_id("Khula Bold Size 11 off"))
    set_control_par(%direction_ids[$i],$CONTROL_PAR_FONT_TYPE_ON,get_font_id("Khula Bold Size 11 on"))
    set_control_par(%direction_ids[$i],$CONTROL_PAR_FONT_TYPE_OFF_PRESSED,get_font_id("Khula Bold Size 11 off pressed"))
    set_control_par(%direction_ids[$i],$CONTROL_PAR_FONT_TYPE_ON_PRESSED,get_font_id("Khula Bold Size 11 on pressed"))
    set_control_par(%direction_ids[$i],$CONTROL_PAR_FONT_TYPE_OFF_HOVER,get_font_id("Khula Bold Size 11 off hover"))
    set_control_par(%direction_ids[$i],$CONTROL_PAR_FONT_TYPE_ON_HOVER,get_font_id("Khula Bold Size 11 on hover"))
    set_control_par_str(%direction_ids[$i],$CONTROL_PAR_TEXT,!direction_texts[$i])
    inc($i)
  end while
  set_control_par(get_ui_id($switch_down),$CONTROL_PAR_WIDTH,get_control_par(get_ui_id($switch_down),$CONTROL_PAR_WIDTH)+13)
  set_control_par(get_ui_id($switch_asPlayed),$CONTROL_PAR_WIDTH,get_control_par(get_ui_id($switch_asPlayed),$CONTROL_PAR_WIDTH)+19)
  set_control_par(get_ui_id($switch_up),$CONTROL_PAR_WIDTH,get_control_par(get_ui_id($switch_up),$CONTROL_PAR_WIDTH)+7)
  declare %legato_ids[4]
  %legato_ids[$legatoMode__noLegato] := get_ui_id($switch_noLegato)
  %legato_ids[$legatoMode__syncToPitch] := get_ui_id($switch_syncToPitch)
  %legato_ids[$legatoMode__syncToRipple] := get_ui_id($switch_syncToRipple)
  %legato_ids[$legatoMode__syncToSwell] := get_ui_id($switch_syncToSwell)
  $i := 0
  while ($i<num_elements(%legato_ids))
    set_control_par(%legato_ids[$i],$CONTROL_PAR_FONT_TYPE,get_font_id("Khula Bold Size 11 off"))
    set_control_par(%legato_ids[$i],$CONTROL_PAR_FONT_TYPE_ON,get_font_id("Khula Bold Size 11 on"))
    set_control_par(%legato_ids[$i],$CONTROL_PAR_FONT_TYPE_OFF_PRESSED,get_font_id("Khula Bold Size 11 off pressed"))
    set_control_par(%legato_ids[$i],$CONTROL_PAR_FONT_TYPE_ON_PRESSED,get_font_id("Khula Bold Size 11 on pressed"))
    set_control_par(%legato_ids[$i],$CONTROL_PAR_FONT_TYPE_OFF_HOVER,get_font_id("Khula Bold Size 11 off hover"))
    set_control_par(%legato_ids[$i],$CONTROL_PAR_FONT_TYPE_ON_HOVER,get_font_id("Khula Bold Size 11 on hover"))
    set_control_par_str(%legato_ids[$i],$CONTROL_PAR_TEXT,!_option_texts_shortened[10*$control__legato+$i])
    inc($i)
  end while
  declare %releaseSamples_ids[6]
  %releaseSamples_ids[$releaseSampleMode__noReleaseSample] := get_ui_id($switch_noReleaseSample)
  %releaseSamples_ids[$releaseSampleMode__autoRelease] := get_ui_id($switch_autoRelease)
  %releaseSamples_ids[$releaseSampleMode__Release0] := get_ui_id($switch_Release0)
  %releaseSamples_ids[$releaseSampleMode__Release1] := get_ui_id($switch_Release1)
  %releaseSamples_ids[$releaseSampleMode__Release2] := get_ui_id($switch_Release2)
  %releaseSamples_ids[$releaseSampleMode__Release3] := get_ui_id($switch_Release3)
  $i := 0
  while ($i<num_elements(%releaseSamples_ids))
    set_control_par(%releaseSamples_ids[$i],$CONTROL_PAR_FONT_TYPE,get_font_id("Khula Bold Size 11 off"))
    set_control_par(%releaseSamples_ids[$i],$CONTROL_PAR_FONT_TYPE_ON,get_font_id("Khula Bold Size 11 on"))
    set_control_par(%releaseSamples_ids[$i],$CONTROL_PAR_FONT_TYPE_OFF_PRESSED,get_font_id("Khula Bold Size 11 off pressed"))
    set_control_par(%releaseSamples_ids[$i],$CONTROL_PAR_FONT_TYPE_ON_PRESSED,get_font_id("Khula Bold Size 11 on pressed"))
    set_control_par(%releaseSamples_ids[$i],$CONTROL_PAR_FONT_TYPE_OFF_HOVER,get_font_id("Khula Bold Size 11 off hover"))
    set_control_par(%releaseSamples_ids[$i],$CONTROL_PAR_FONT_TYPE_ON_HOVER,get_font_id("Khula Bold Size 11 on hover"))
    set_control_par_str(%releaseSamples_ids[$i],$CONTROL_PAR_TEXT,!releaseSamples_texts[$i])
    inc($i)
  end while
  set_control_par(get_ui_id($switch_noReleaseSample),$CONTROL_PAR_POS_X,get_control_par(get_ui_id($switch_noReleaseSample),$CONTROL_PAR_POS_X)+7)
  set_control_par(get_ui_id($switch_autoRelease),$CONTROL_PAR_POS_X,get_control_par(get_ui_id($switch_autoRelease),$CONTROL_PAR_POS_X)+9)
  set_control_par(get_ui_id($switch_autoRelease),$CONTROL_PAR_WIDTH,get_control_par(get_ui_id($switch_autoRelease),$CONTROL_PAR_WIDTH)+10)
  set_control_par(get_ui_id($switch_Release0),$CONTROL_PAR_POS_X,get_control_par(get_ui_id($switch_Release0),$CONTROL_PAR_POS_X)+14)
  set_control_par(get_ui_id($switch_Release1),$CONTROL_PAR_POS_X,get_control_par(get_ui_id($switch_Release1),$CONTROL_PAR_POS_X)+14)
  set_control_par(get_ui_id($switch_Release2),$CONTROL_PAR_POS_X,get_control_par(get_ui_id($switch_Release2),$CONTROL_PAR_POS_X)+16)
  set_control_par(get_ui_id($switch_Release3),$CONTROL_PAR_POS_X,get_control_par(get_ui_id($switch_Release3),$CONTROL_PAR_POS_X)+16)
  %ctrl_ids[$control__vol] := get_ui_id($slider_vol)
  %ctrl_ids[$control__reverb] := get_ui_id($slider_reverb)
  %ctrl_ids[$control__speed] := get_ui_id($speed_nks)
  %ctrl_ids[$control__direction] := get_ui_id($direction_nks)
  %ctrl_ids[$control__legato] := get_ui_id($legato_nks)
  %ctrl_ids[$control__releaseSamples] := get_ui_id($releaseSamples_nks)
  ?xypad_speed[0] := int_to_real($speed_nks)/int_to_real(5)
  set_control_par(get_ui_id(?xypad_speed),$CONTROL_PAR_PICTURE_STATE,$speed_nks)
  $speed_nks := $speed_nks
  ?xypad_direction[0] := int_to_real($direction_nks)/int_to_real(3)
  set_control_par(get_ui_id(?xypad_direction),$CONTROL_PAR_PICTURE_STATE,$direction_nks)
  $direction_nks := $direction_nks
  ?xypad_legato[0] := int_to_real($legato_nks)/int_to_real(4)
  set_control_par(get_ui_id(?xypad_legato),$CONTROL_PAR_PICTURE_STATE,$legato_nks)
  $legato_nks := $legato_nks
  ?xypad_releaseSamples[0] := int_to_real($releaseSamples_nks)/int_to_real(6)
  set_control_par(get_ui_id(?xypad_releaseSamples),$CONTROL_PAR_PICTURE_STATE,$releaseSamples_nks)
  $releaseSamples_nks := $releaseSamples_nks
  set_control_par(get_ui_id($slider_vol),$CONTROL_PAR_DEFAULT_VALUE,500000)
  set_control_par(get_ui_id($slider_reverb),$CONTROL_PAR_DEFAULT_VALUE,500000)
  set_control_par(get_ui_id($menu_reverb),$CONTROL_PAR_TEXTPOS_Y,100)
  set_control_par(get_ui_id($slider_vol),$CONTROL_PAR_AUTOMATION_ID,0)
  set_control_par_str(get_ui_id($slider_vol),$CONTROL_PAR_AUTOMATION_NAME,"Expression")
  set_control_par(get_ui_id($slider_reverb),$CONTROL_PAR_AUTOMATION_ID,1)
  set_control_par_str(get_ui_id($slider_reverb),$CONTROL_PAR_AUTOMATION_NAME,"Reverb")
  set_control_par(get_ui_id($speed_nks),$CONTROL_PAR_AUTOMATION_ID,2)
  set_control_par_str(get_ui_id($speed_nks),$CONTROL_PAR_AUTOMATION_NAME,"Speed")
  set_control_par(get_ui_id($direction_nks),$CONTROL_PAR_AUTOMATION_ID,3)
  set_control_par_str(get_ui_id($direction_nks),$CONTROL_PAR_AUTOMATION_NAME,"Direction")
  set_control_par(get_ui_id($legato_nks),$CONTROL_PAR_AUTOMATION_ID,4)
  set_control_par_str(get_ui_id($legato_nks),$CONTROL_PAR_AUTOMATION_NAME,"Sync")
  set_control_par(get_ui_id($releaseSamples_nks),$CONTROL_PAR_AUTOMATION_ID,5)
  set_control_par_str(get_ui_id($releaseSamples_nks),$CONTROL_PAR_AUTOMATION_NAME,"Release Samples")
  set_voice_limit($NI_VL_TMPRO_STANDARD,32*2)
  declare @siln2
  @siln2 := "START_EVENTS_INTEGERS_ENGINE"
  set_engine_par($ENGINE_PAR_SPEED,1000000-((4*8+4-1)*90909),$artic__quarters,-1,-1)
  set_engine_par($ENGINE_PAR_SPEED,1000000-((20-1)*90909),$artic__eighths,-1,-1)
  set_engine_par($ENGINE_PAR_SPEED,1000000-((19-1)*90909),$artic__sixteenths,-1,-1)
  set_engine_par($ENGINE_PAR_SPEED,1000000-((16-1)*90909),find_group("quarters releases"),-1,-1)
  set_engine_par($ENGINE_PAR_SPEED,1000000-((12-1)*90909),find_group("eighths releases"),-1,-1)
  declare $_other_clip_i8
  declare $_clip_index9
  declare $_cur_event8 := 0
  declare $_ticks_until_next_event8
  declare $_note8
  declare $_velocity8
  declare $_length8
  declare $_note_id10
  declare $_cc_num8
  declare $_other_clip_i7
  declare $_clip_index8
  declare $_cur_event7 := 0
  declare $_ticks_until_next_event7
  declare $_note7
  declare $_velocity7
  declare $_length7
  declare $_note_id9
  declare $_cc_num7
  declare $_other_clip_i6
  declare $_clip_index7
  declare $_cur_event6 := 0
  declare $_ticks_until_next_event6
  declare $_note6
  declare $_velocity6
  declare $_length6
  declare $_note_id8
  declare $_cc_num6
  declare $_other_clip_i5
  declare $_clip_index6
  declare $_cur_event5 := 0
  declare $_ticks_until_next_event5
  declare $_note5
  declare $_velocity5
  declare $_length5
  declare $_note_id7
  declare $_cc_num5
  declare $_other_clip_i4
  declare $_clip_index5
  declare $_cur_event4 := 0
  declare $_ticks_until_next_event4
  declare $_note4
  declare $_velocity4
  declare $_length4
  declare $_note_id6
  declare $_cc_num4
  declare $_other_clip_i3
  declare $_clip_index4
  declare $_cur_event3 := 0
  declare $_ticks_until_next_event3
  declare $_note3
  declare $_velocity3
  declare $_length3
  declare $_note_id5
  declare $_cc_num3
  declare $_other_clip_i2
  declare $_clip_index3
  declare $_cur_event2 := 0
  declare $_ticks_until_next_event2
  declare $_note2
  declare $_velocity2
  declare $_length2
  declare $_note_id4
  declare $_cc_num2
  declare $_other_clip_i
  declare $_clip_index2
  declare $_cur_event := 0
  declare $_ticks_until_next_event
  declare $_note
  declare $_velocity
  declare $_length
  declare $_note_id3
  declare $_cc_num
  declare %_event_ids[128]
  declare $_e
  declare $_prev_cc64
  declare $_r6
  declare $_artic5
  declare $_offset_rec_time5
  declare $_rec_time_play_pos
  declare $_rec_time_pos_in_ripple
  declare $_time_til_end_of_ripple2
  declare $_play_release_sample
  declare $_triggered_by_keyswitch := 0
  declare $_fade_out_time
  declare $_rls_note
  declare $_prev_rls_note_rec_time
  declare $_vol
  declare $_offset := 0
  declare $_cur_ripple
  declare $_vel4
  declare $_history_index
  declare $_ks_index
  declare %_notes[32]
  declare %_intervals[32]
  declare %_played_notes[32]
  declare %_played_intervals[32]
  declare %__notes[32]
  declare %__intervals[32]
  declare $_num_ripples := 0
  declare $_closest_neighbor := -1
  declare $_closest_neighbor_interval := 12
  declare %_neighbor[32]
  declare %_lower_neighbor[32]
  declare %_upper_neighbor[32]
  declare $_num_neighbors := 0
  declare $_num_lower_neighbors := 0
  declare $_num_upper_neighbors := 0
  declare $_dir
  declare $_sign
  declare $_other_note
  declare $_lower_neighbor_time_held
  declare $_upper_neighbor_time_held
  declare $_make_ripples_to_both_adjacent_neighbors
  declare $_low_note2
  declare $_high_note2
  declare $_ripple_dir
  declare $_origin_note3
  declare $_dest_note
  declare $_first_note
  declare $_second_note
  declare $_real_ripple_length
  declare $_real_pitch_length
  declare $_real_sample_length
  declare $_do_legato
  declare $_offset_real_time
  declare $_offset_rec_time4
  declare $_real_legato_time
  declare $_latency_real_time
  declare $_ext_mode_real_legato_time := 0
  declare $_vel_offset
  declare $_already_playing := 0
  declare $_note_id2
  declare $_volume
  declare $_fade_in_time := 0
  declare $_real_pos_in_ripple
  declare $_time_til_end_of_ripple
  declare $_real_pos_in_pitch
  declare $_time_til_end_of_pitch
  declare polyphonic $_ext_first_note
  declare polyphonic $_ext_second_note
  declare polyphonic $_ext_low_note
  declare polyphonic $_ext_high_note
  declare polyphonic $_ext_artic
  declare polyphonic $_note_chooser
  declare polyphonic $_ext_pitch
  declare $_ext_note
  declare ~_vel_norm
  declare $_len
  declare polyphonic $_last_time
  declare $_wait_time
  declare polyphonic $_low_vel
  declare polyphonic $_high_vel
  declare $_vel3
  declare $_previewing := 0
  declare $_time_played
  declare $_clip_index
  declare $_clip_length_ms
  declare $_key_i3
  declare $_r5
  declare $_artic4
  declare $_latency3
  declare $_offset_rec_time3
  declare $_vel2
  declare $_sample_start3
  declare $_release_dynamic2
  declare $_release_sample_length2
  declare $_origin_note2
  declare $_r4
  declare $_artic3
  declare $_latency2
  declare $_offset_rec_time2
  declare $_vel
  declare $_sample_start2
  declare $_release_dynamic
  declare $_release_sample_length
  declare $_origin_note
  declare $_r3
  declare $_artic2
  declare $_pos_in_swell2
  declare $_sample_start
  declare $_note_id
  declare $_r2
  declare $_time_since_note_off2
  declare $_release_length
  declare $_brightness_when_released
  declare $_value
  declare $_artic
  declare $_latency
  declare $_offset_rec_time
  declare $__time_since_note_off2
  declare $__release_length
  declare $__brightness_when_released
  declare $__value
  declare $_low_note
  declare $_high_note
  declare $_direction
  declare $_interval
  declare $__artic
  declare ~_speed_curve
  declare ~_brightness_curve
  declare $_play_pos_in_beat
  declare ~_value_norm
  declare $_pos_in_swell
  declare $__pos_in_swell
  declare $_key_i2
  declare $_key_i
  declare $_index
  declare $_hist_i
  declare $_note_found := 0
  declare @_checkmark
  declare $_i
end on

function set_key_colors_and_types_and_names
  $key_i := 0
  while ($key_i<=127)
    set_key_type($key_i,$NI_KEY_TYPE_NONE)
    set_key_name($key_i,"")
    $_index := search(%articulation_keyswitches,$key_i)
    if ($_index # -1)
      set_key_color($key_i,$KEY_COLOR_RED)
      set_key_name($key_i,!articulation_texts[$_index])
      set_key_type($key_i,$NI_KEY_TYPE_CONTROL)
    end if
    if (in_range($key_i,$LOWEST_KEY,$HIGHEST_KEY))
      set_key_color($key_i,$KEY_COLOR_DEFAULT)
      set_key_type($key_i,$NI_KEY_TYPE_DEFAULT)
    end if
    $_index := search(%speed_keyswitches,$key_i)
    if ($_index # -1)
      set_key_color($key_i,$KEY_COLOR_GREEN)
      set_key_name($key_i,!speed_texts[$_index])
      set_key_type($key_i,$NI_KEY_TYPE_CONTROL)
    end if
    $_index := search(%direction_keyswitches,$key_i)
    if ($_index # -1)
      set_key_color($key_i,$KEY_COLOR_YELLOW)
      set_key_name($key_i,!direction_texts[$_index])
      set_key_type($key_i,$NI_KEY_TYPE_CONTROL)
    end if
    $_index := search(%legato_keyswitches,$key_i)
    if ($_index # -1)
      set_key_color($key_i,$KEY_COLOR_PURPLE)
      set_key_name($key_i,!legato_texts[$_index])
      set_key_type($key_i,$NI_KEY_TYPE_CONTROL)
    end if
    $_index := search(%release_sample_keyswitches,$key_i)
    if ($_index # -1)
      set_key_color($key_i,$KEY_COLOR_ORANGE)
      set_key_name($key_i,!releaseSamples_texts[$_index])
      set_key_type($key_i,$NI_KEY_TYPE_CONTROL)
    end if
    $_index := search(%vel_to_start_keyswitches,$key_i)
    if ($_index # -1)
      set_key_color($key_i,$KEY_COLOR_BLUE)
      set_key_name($key_i,!vel_to_start_texts[$_index])
      set_key_type($key_i,$NI_KEY_TYPE_CONTROL)
    end if
    $_index := search(%release_trigger_keyswitches,$key_i)
    if ($_index # -1)
      set_key_color($key_i,$KEY_COLOR_RED)
      set_key_name($key_i,"Release Trigger Key")
      set_key_type($key_i,$NI_KEY_TYPE_CONTROL)
    end if
    inc($key_i)
  end while
end function

function crossfaded_looping
  $_r3 := 0
  while ($_r3<64)
    if (event_status(%ripple_id_history[$_r3])=$EVENT_STATUS_NOTE_QUEUE)
      $_artic2 := %custom_event_artic[%ripple_id_history[$_r3] mod 1000000]
      if (%custom_event_releasing[%ripple_id_history[$_r3] mod 1000000]=0)
        $_pos_in_swell2 := get_event_par(%ripple_id_history[$_r3],$EVENT_PAR_PLAY_POS)-(500*1000)
        if ($_pos_in_swell2>%rec_time_sample_lengths[$_artic2])
          fade_out(%ripple_id_history[$_r3],$DURATION_SIXTEENTH,1)
          $_sample_start := $_pos_in_swell2 mod %rec_time_sample_lengths[$_artic2]+(500*1000)
          if (%custom_event_preview_being_stopped[%ripple_id_history[$_r3] mod 1000000]=0)
            %custom_event_crossfading[%ripple_id_history[$_r3] mod 1000000] := 1
            $_note_id := play_note(get_event_par(%ripple_id_history[$_r3],$EVENT_PAR_NOTE),get_event_par(%ripple_id_history[$_r3],$EVENT_PAR_VELOCITY),$_sample_start,0)
            set_event_par_arr($_note_id,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_event_par_arr($_note_id,$EVENT_PAR_ALLOW_GROUP,1,$_artic2)
            change_vol($_note_id,get_event_par(%ripple_id_history[$_r3],$EVENT_PAR_VOLUME),0)
            fade_in($_note_id,$DURATION_SIXTEENTH)
            %custom_event_active[$_note_id mod 1000000] := %custom_event_active[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_current_ripple[$_note_id mod 1000000] := %custom_event_current_ripple[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_source[$_note_id mod 1000000] := %custom_event_source[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_note[$_note_id mod 1000000] := %custom_event_note[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_velocity[$_note_id mod 1000000] := %custom_event_velocity[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_low_note[$_note_id mod 1000000] := %custom_event_low_note[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_high_note[$_note_id mod 1000000] := %custom_event_high_note[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_origin_note[$_note_id mod 1000000] := %custom_event_origin_note[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_dest_note[$_note_id mod 1000000] := %custom_event_dest_note[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_first_note[$_note_id mod 1000000] := %custom_event_first_note[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_second_note[$_note_id mod 1000000] := %custom_event_second_note[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_direction[$_note_id mod 1000000] := %custom_event_direction[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_artic[$_note_id mod 1000000] := %custom_event_artic[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_voice[$_note_id mod 1000000] := %custom_event_voice[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_note_off_timestamp[$_note_id mod 1000000] := %custom_event_note_off_timestamp[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_marked_for_release[$_note_id mod 1000000] := %custom_event_marked_for_release[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_play_release_sample[$_note_id mod 1000000] := %custom_event_play_release_sample[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_release_length[$_note_id mod 1000000] := %custom_event_release_length[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_release_sample_length[$_note_id mod 1000000] := %custom_event_release_sample_length[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_release_note[$_note_id mod 1000000] := %custom_event_release_note[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_release_dynamic[$_note_id mod 1000000] := %custom_event_release_dynamic[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_brightness_when_released[$_note_id mod 1000000] := %custom_event_brightness_when_released[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_waiting_for_release_sample[$_note_id mod 1000000] := %custom_event_waiting_for_release_sample[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_fading_out_for_release_sample[$_note_id mod 1000000] := %custom_event_fading_out_for_release_sample[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_rls_sample_id[$_note_id mod 1000000] := %custom_event_rls_sample_id[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_crossfading[$_note_id mod 1000000] := %custom_event_crossfading[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_releasing[$_note_id mod 1000000] := %custom_event_releasing[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_triggered_by_mf[$_note_id mod 1000000] := %custom_event_triggered_by_mf[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_ripple_index[$_note_id mod 1000000] := %custom_event_ripple_index[%ripple_id_history[$_r3] mod 1000000]
            %custom_event_preview_being_stopped[$_note_id mod 1000000] := %custom_event_preview_being_stopped[%ripple_id_history[$_r3] mod 1000000]
            %ripple_id_history[$_r3] := $_note_id
          end if
        end if
      end if
    end if
    inc($_r3)
  end while
end function

function fade_out_ripples_when_release_sample_sounds
  $_r4 := 0
  while ($_r4<64)
    if (event_status(%ripple_id_history[$_r4])=$EVENT_STATUS_NOTE_QUEUE)
      $_artic3 := %custom_event_artic[%ripple_id_history[$_r4] mod 1000000]
      $_latency2 := real_to_int(int_to_real(0)+((int_to_real(real_to_int(int_to_real($menu_latency)/?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
      $_offset_rec_time2 := (500-$_latency2)*1000
      if (get_event_par(%custom_event_rls_sample_id[%ripple_id_history[$_r4] mod 1000000],$EVENT_PAR_PLAY_POS)-$_offset_rec_time2>(%rec_time_ripple_lengths[$_artic3]+%stop_offset_rec_time[$_artic3]))
        if (%custom_event_fading_out_for_release_sample[%ripple_id_history[$_r4] mod 1000000]=0)
          if ($switch_midiOutputMode=1)
            $_vel := %custom_event_current_ripple[%ripple_id_history[$_r4] mod 1000000]*32+1
            message("event[ripple_id_history[r]].note = " & %custom_event_note[%ripple_id_history[$_r4] mod 1000000])
            play_note(%custom_event_note[%ripple_id_history[$_r4] mod 1000000],$_vel,0,$DURATION_QUARTER)
          end if
          fade_out(%ripple_id_history[$_r4],$DURATION_SIXTEENTH,1)
          %custom_event_fading_out_for_release_sample[%ripple_id_history[$_r4] mod 1000000] := 1
          %custom_event_releasing[%ripple_id_history[$_r4] mod 1000000] := 1
          $_release_dynamic := %custom_event_release_dynamic[%ripple_id_history[$_r4] mod 1000000]
          if ($_release_dynamic=$SHORT)
            $_sample_start2 := real_to_int(int_to_real(%rec_time_ripple_lengths[$_artic3])/3.5)
          else
            if ($_release_dynamic=$LONG)
              $_sample_start2 := 0
            end if
          end if
          $_release_sample_length := %rec_time_ripple_lengths[$_artic3]-$_sample_start2
          $_release_sample_length := real_to_int(int_to_real(0)+((int_to_real($_release_sample_length)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))))
          $_origin_note := %custom_event_origin_note[%ripple_id_history[$_r4] mod 1000000]
          %custom_event_brightness_when_released[%ripple_id_history[$_r4] mod 1000000] := get_control_par(%ripple_swell[$_r4],$CONTROL_PAR_VALUE)
          %custom_event_release_sample_length[%ripple_id_history[$_r4] mod 1000000] := $_release_sample_length
          %custom_event_note_off_timestamp[%ripple_id_history[$_r4] mod 1000000] := $ENGINE_UPTIME
        end if
      end if
    end if
    inc($_r4)
  end while
end function

function play_release_notes_when_its_time
  $_r5 := 0
  while ($_r5<64)
    if (event_status(%ripple_id_history[$_r5])=$EVENT_STATUS_NOTE_QUEUE)
      $_artic4 := %custom_event_artic[%ripple_id_history[$_r5] mod 1000000]
      $_latency3 := real_to_int(int_to_real(0)+((int_to_real(real_to_int(int_to_real($menu_latency)/?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
      $_offset_rec_time3 := (500-$_latency3)*1000
      if (get_event_par(%custom_event_rls_sample_id[%ripple_id_history[$_r5] mod 1000000],$EVENT_PAR_PLAY_POS)-$_offset_rec_time3>(%rec_time_ripple_lengths[$_artic4]+%stop_offset_rec_time[$_artic4]))
        if (%custom_event_fading_out_for_release_sample[%ripple_id_history[$_r5] mod 1000000]=0)
          if ($switch_midiOutputMode=1)
            $_vel2 := %custom_event_current_ripple[%ripple_id_history[$_r5] mod 1000000]*32+1
            message("event[ripple_id_history[r]].note = " & %custom_event_note[%ripple_id_history[$_r5] mod 1000000])
            play_note(%custom_event_note[%ripple_id_history[$_r5] mod 1000000],$_vel2,0,$DURATION_QUARTER)
          end if
          fade_out(%ripple_id_history[$_r5],$DURATION_SIXTEENTH,1)
          %custom_event_fading_out_for_release_sample[%ripple_id_history[$_r5] mod 1000000] := 1
          %custom_event_releasing[%ripple_id_history[$_r5] mod 1000000] := 1
          $_release_dynamic2 := %custom_event_release_dynamic[%ripple_id_history[$_r5] mod 1000000]
          if ($_release_dynamic2=$SHORT)
            $_sample_start3 := real_to_int(int_to_real(%rec_time_ripple_lengths[$_artic4])/3.5)
          else
            if ($_release_dynamic2=$LONG)
              $_sample_start3 := 0
            end if
          end if
          $_release_sample_length2 := %rec_time_ripple_lengths[$_artic4]-$_sample_start3
          $_release_sample_length2 := real_to_int(int_to_real(0)+((int_to_real($_release_sample_length2)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))))
          $_origin_note2 := %custom_event_origin_note[%ripple_id_history[$_r5] mod 1000000]
          %custom_event_brightness_when_released[%ripple_id_history[$_r5] mod 1000000] := get_control_par(%ripple_swell[$_r5],$CONTROL_PAR_VALUE)
          %custom_event_release_sample_length[%ripple_id_history[$_r5] mod 1000000] := $_release_sample_length2
          %custom_event_note_off_timestamp[%ripple_id_history[$_r5] mod 1000000] := $ENGINE_UPTIME
        end if
      end if
    end if
    inc($_r5)
  end while
end function

function ripple_animations
  $_r2 := 0
  while ($_r2<64)
    if (%custom_event_play_release_sample[%ripple_id_history[$_r2] mod 1000000]=0)
      if (%custom_event_releasing[%ripple_id_history[$_r2] mod 1000000]=1)
        set_control_par(%ripple[$_r2],$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
        if (event_status(%ripple_id_history[$_r2])=$EVENT_STATUS_NOTE_QUEUE)
          $__time_since_note_off2 := $ENGINE_UPTIME-%custom_event_note_off_timestamp[%ripple_id_history[$_r2] mod 1000000]
          $__release_length := %custom_event_release_length[%ripple_id_history[$_r2] mod 1000000]/1000
          $__brightness_when_released := %custom_event_brightness_when_released[%ripple_id_history[$_r2] mod 1000000]
          if ($__release_length=0)
            $__release_length := 1
          end if
          if ($__brightness_when_released=0)
            $__brightness_when_released := 1
          end if
          $__value := real_to_int(int_to_real($__brightness_when_released)+((int_to_real($__time_since_note_off2)-int_to_real(0))/(int_to_real($__release_length)-int_to_real(0))*(int_to_real(0)-int_to_real($__brightness_when_released))))
          if ($__value>0)
            if ($__time_since_note_off2>0)
              set_control_par(%ripple_swell[$_r2],$CONTROL_PAR_VALUE,$__value)
            end if
          end if
        else
          set_control_par(%ripple_swell[$_r2],$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
        end if
      end if
      if (%custom_event_releasing[%ripple_id_history[$_r2] mod 1000000]=0 or (event_status(%ripple_id_history[$_r2])=$EVENT_STATUS_INACTIVE))
        set_control_par(%ripple_swell[$_r2],$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
        set_control_par(%ripple[$_r2],$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
      end if
    else
      if (%custom_event_play_release_sample[%ripple_id_history[$_r2] mod 1000000]=1)
        if (event_status(%ripple_id_history[$_r2])=$EVENT_STATUS_NOTE_QUEUE or (event_status(%custom_event_rls_sample_id[%ripple_id_history[$_r2] mod 1000000])=$EVENT_STATUS_NOTE_QUEUE))
          $__artic := %custom_event_artic[%ripple_id_history[$_r2] mod 1000000]
          $_latency := real_to_int(int_to_real(0)+((int_to_real(real_to_int(int_to_real($menu_latency)/?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
          $_offset_rec_time := (500-$_latency)*1000
          if (get_event_par(%custom_event_rls_sample_id[%ripple_id_history[$_r2] mod 1000000],$EVENT_PAR_PLAY_POS)-$_offset_rec_time>(%rec_time_ripple_lengths[$__artic]+%stop_offset_rec_time[$__artic]))
            set_control_par(%ripple[$_r2],$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
            $__time_since_note_off2 := $ENGINE_UPTIME-%custom_event_note_off_timestamp[%ripple_id_history[$_r2] mod 1000000]
            $__release_length := %custom_event_release_sample_length[%ripple_id_history[$_r2] mod 1000000]/1000
            $__brightness_when_released := %custom_event_brightness_when_released[%ripple_id_history[$_r2] mod 1000000]
            if ($__release_length=0)
              $__release_length := 1
            end if
            if ($__brightness_when_released=0)
              $__brightness_when_released := 1
            end if
            $__value := real_to_int(int_to_real($__brightness_when_released)+((int_to_real($__time_since_note_off2)-int_to_real(0))/(int_to_real($__release_length)-int_to_real(0))*(int_to_real(0)-int_to_real($__brightness_when_released))))
            if ($__value>0)
              if ($__time_since_note_off2>0)
                set_control_par(%ripple_swell[$_r2],$CONTROL_PAR_VALUE,$__value)
              end if
            else
              set_control_par(%ripple_swell[$_r2],$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
            end if
          end if
        else
          set_control_par(%ripple[$_r2],$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
          set_control_par(%ripple_swell[$_r2],$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
        end if
      end if
    end if
    inc($_r2)
  end while
  $_r2 := 64-1
  while ($_r2>=0)
    if (event_status(%ripple_id_history[$_r2])=$EVENT_STATUS_NOTE_QUEUE)
      if (%custom_event_releasing[%ripple_id_history[$_r2] mod 1000000]=0)
        $_low_note := %custom_event_low_note[%ripple_id_history[$_r2] mod 1000000]
        $_high_note := %custom_event_high_note[%ripple_id_history[$_r2] mod 1000000]
        $_direction := %custom_event_direction[%ripple_id_history[$_r2] mod 1000000]
        $_interval := ($_high_note-$_low_note)*($_direction*2-1)
        $__artic := %custom_event_artic[%ripple_id_history[$_r2] mod 1000000]
        if ($__artic=$artic__quarters)
          ~_speed_curve := 1.0
          ~_brightness_curve := 5.0
        else
          if ($__artic=$artic__eighths)
            ~_speed_curve := 1.5
            ~_brightness_curve := 2.0
          else
            if ($__artic=$artic__sixteenths)
              ~_speed_curve := 0.75
              ~_brightness_curve := 2.0
            end if
          end if
        end if
        set_control_par(%ripple[$_r2],$CONTROL_PAR_POS_X,get_control_par(get_ui_id($panel_keyboard),$CONTROL_PAR_POS_X)+get_control_par(%key_ids[$_low_note],$CONTROL_PAR_POS_X)+(get_control_par(%key_ids[$_low_note],$CONTROL_PAR_WIDTH)/2))
        if ($_interval<0)
          set_control_par(%ripple[$_r2],$CONTROL_PAR_POS_Y,get_control_par(get_ui_id($panel_keyboard),$CONTROL_PAR_POS_Y)-((22*abs($_interval)+1)/2)-1)
        else
          set_control_par(%ripple[$_r2],$CONTROL_PAR_POS_Y,get_control_par(get_ui_id($panel_keyboard),$CONTROL_PAR_POS_Y)+get_control_par(%key_ids[$LOWEST_KEY],$CONTROL_PAR_HEIGHT)-((22*abs($_interval)+1)/2))
        end if
        set_control_par_str(%ripple[$_r2],$CONTROL_PAR_PICTURE,"ripple " & $_interval)
        $_play_pos_in_beat := (get_event_par(%ripple_id_history[$_r2],$EVENT_PAR_PLAY_POS)-(500*1000)) mod %rec_time_ripple_lengths[$__artic]
        ~_value_norm := int_to_real($_play_pos_in_beat)/int_to_real(%rec_time_ripple_lengths[$__artic])
        if (~_value_norm<0.00001)
          ~_value_norm := 0.00001
        end if
        if ($__artic=$artic__sixteenths)
          ~_value_norm := pow(~_value_norm,0.6)
        else
          ~_value_norm := pow(~_value_norm,1.4)
        end if
        set_control_par(%ripple[$_r2],$CONTROL_PAR_VALUE,real_to_int(~_value_norm*127.0))
        set_control_par(%ripple[$_r2],$CONTROL_PAR_HIDE,$HIDE_PART_NOTHING)
        set_control_par(%ripple_swell[$_r2],$CONTROL_PAR_POS_X,get_control_par(%ripple[$_r2],$CONTROL_PAR_POS_X))
        set_control_par(%ripple_swell[$_r2],$CONTROL_PAR_POS_Y,get_control_par(%ripple[$_r2],$CONTROL_PAR_POS_Y))
        set_control_par_str(%ripple_swell[$_r2],$CONTROL_PAR_PICTURE,"ripple swell " & $_interval)
        $__pos_in_swell := get_event_par(%ripple_id_history[$_r2],$EVENT_PAR_PLAY_POS)-(500*1000)
        if ($__pos_in_swell<0)
          $__pos_in_swell := 0
        end if
        $__pos_in_swell := $__pos_in_swell mod %rec_time_sample_lengths[$__artic]
        if (in_range($__pos_in_swell,0,%rec_time_sample_lengths[$__artic]/2))
          set_control_par(%ripple_swell[$_r2],$CONTROL_PAR_VALUE,real_to_int(int_to_real(0)+((int_to_real($__pos_in_swell)-int_to_real(0))/(int_to_real(%rec_time_sample_lengths[$__artic]/2)-int_to_real(0))*(int_to_real(64)-int_to_real(0)))))
        else
          set_control_par(%ripple_swell[$_r2],$CONTROL_PAR_VALUE,real_to_int(int_to_real(64)+((int_to_real($__pos_in_swell)-int_to_real(%rec_time_sample_lengths[$__artic]/2))/(int_to_real(%rec_time_sample_lengths[$__artic])-int_to_real(%rec_time_sample_lengths[$__artic]/2))*(int_to_real(0)-int_to_real(64)))))
        end if
        set_control_par(%ripple_swell[$_r2],$CONTROL_PAR_HIDE,get_control_par(%ripple[$_r2],$CONTROL_PAR_HIDE))
        set_control_par(%ripple_swell[$_r2],$CONTROL_PAR_HIDE,$HIDE_PART_NOTHING)
        %custom_event_brightness_when_released[%ripple_id_history[$_r2] mod 1000000] := get_control_par(%ripple_swell[$_r2],$CONTROL_PAR_VALUE)
      end if
    end if
    dec($_r2)
  end while
end function

function midi_clip_play_cursor
  $_previewing := 0
  $clip_i := 0
  while ($clip_i<8)
    if (get_control_par(%switch_preview[$clip_i],$CONTROL_PAR_VALUE)=1)
      $_time_played := $ENGINE_UPTIME-%time_started[$clip_i]
      $_clip_index := $cur_midi_page*8+$clip_i
      $_clip_length_ms := ticks_to_ms(%clip_length[$_clip_index])/1000
      set_control_par(get_ui_id($mf_cursor),$CONTROL_PAR_POS_X,get_control_par(%switch_preview[$clip_i],$CONTROL_PAR_POS_X))
      set_control_par(get_ui_id($mf_cursor),$CONTROL_PAR_POS_Y,get_control_par(%switch_preview[$clip_i],$CONTROL_PAR_POS_Y))
      set_control_par(get_ui_id($mf_cursor),$CONTROL_PAR_WIDTH,get_control_par(%switch_preview[$clip_i],$CONTROL_PAR_WIDTH))
      set_control_par(get_ui_id($mf_cursor),$CONTROL_PAR_HEIGHT,get_control_par(%switch_preview[$clip_i],$CONTROL_PAR_HEIGHT))
      set_control_par(get_ui_id($mf_cursor),$CONTROL_PAR_POS_X,get_control_par(get_ui_id($mf_cursor),$CONTROL_PAR_POS_X)+1)
      set_control_par(get_ui_id($mf_cursor),$CONTROL_PAR_POS_Y,get_control_par(get_ui_id($mf_cursor),$CONTROL_PAR_POS_Y)+1)
      set_control_par(get_ui_id($mf_cursor),$CONTROL_PAR_WIDTH,get_control_par(get_ui_id($mf_cursor),$CONTROL_PAR_WIDTH)-2)
      set_control_par(get_ui_id($mf_cursor),$CONTROL_PAR_HEIGHT,get_control_par(get_ui_id($mf_cursor),$CONTROL_PAR_HEIGHT)-2)
      set_control_par(get_ui_id($mf_cursor),$CONTROL_PAR_PICTURE_STATE,real_to_int(int_to_real(0)+((int_to_real($_time_played)-int_to_real(0))/(int_to_real($_clip_length_ms)-int_to_real(0))*(int_to_real(127)-int_to_real(0)))))
      $_previewing := 1
    end if
    inc($clip_i)
  end while
  if ($_previewing=1)
    set_control_par(get_ui_id($mf_cursor),$CONTROL_PAR_HIDE,$HIDE_PART_NOTHING)
  else
    set_control_par(get_ui_id($mf_cursor),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
  end if
end function

function info_graphics_animation
  if ($PLAYED_VOICES_INST>0)
    ~midiInstructions_opacity := 0.0
  end if
  ~smoothed_midiInstructions_opacity := ~smoothed_midiInstructions_opacity+((~midiInstructions_opacity-~smoothed_midiInstructions_opacity)/30.0)
  if (~smoothed_midiInstructions_opacity<0.0001)
    ~smoothed_midiInstructions_opacity := 0.0
  end if
  set_control_par(get_ui_id($label_midiInstructions),$CONTROL_PAR_PICTURE_STATE,real_to_int(int_to_real(0)+((~smoothed_midiInstructions_opacity-0.0)/(1.0-0.0)*(int_to_real(127)-int_to_real(0)))))
  ~smoothed_midiCover_opacity := ~smoothed_midiCover_opacity+((~midiCover_opacity-~smoothed_midiCover_opacity)/4.0)
  if (~smoothed_midiCover_opacity<0.0001)
    ~smoothed_midiCover_opacity := 0.0
  end if
  set_control_par(get_ui_id($label_midiCover),$CONTROL_PAR_PICTURE_STATE,real_to_int(int_to_real(0)+((~smoothed_midiCover_opacity-0.0)/(1.0-0.0)*(int_to_real(127)-int_to_real(0)))))
end function

function hide_version
  if ($ENGINE_UPTIME-$timestamp_version_shown>1000)
    set_control_par(get_ui_id($label_version),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
  end if
end function

function update_latency_graphics
  set_control_par_str(get_ui_id($label_latency),$CONTROL_PAR_TEXT,$menu_latency & "ms")
end function

function unpress_all_keys
  $_key_i3 := $LOWEST_KEY
  while ($_key_i3<=$HIGHEST_KEY)
    set_key_pressed($_key_i3,0)
    inc($_key_i3)
  end while
end function

function deactivate_mf_notes
  get_event_ids(%_event_ids)
  $_e := 0
  while ($_e<num_elements(%_event_ids))
    if (%_event_ids[$_e] # 0)
      if (%custom_event_triggered_by_mf[%_event_ids[$_e] mod 1000000]>0)
        %custom_event_active[%_event_ids[$_e] mod 1000000] := 0
      end if
    end if
    inc($_e)
  end while
end function

function count_keys_active
  $num_keys_active := 0
  $_key_i := $LOWEST_KEY
  while ($_key_i<=$HIGHEST_KEY)
    if (%key_active[$_key_i]=1)
      inc($num_keys_active)
    end if
    inc($_key_i)
  end while
end function

function release_marked_ripples
  $_r6 := 0
  while ($_r6<64)
    if (event_status(%ripple_id_history[$_r6])=$EVENT_STATUS_NOTE_QUEUE and (%custom_event_marked_for_release[%ripple_id_history[$_r6] mod 1000000]=1))
      %custom_event_marked_for_release[%ripple_id_history[$_r6] mod 1000000] := 0
      $_artic5 := %custom_event_artic[%ripple_id_history[$_r6] mod 1000000]
      $latency := real_to_int(int_to_real($menu_latency)/?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
      $_offset_rec_time5 := real_to_int(int_to_real(0)+((int_to_real((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))))-$latency)*1000)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
      $_rec_time_play_pos := get_event_par(%ripple_id_history[$_r6],$EVENT_PAR_PLAY_POS)-$_offset_rec_time5
      $_rec_time_pos_in_ripple := $_rec_time_play_pos mod %rec_time_ripple_lengths[$_artic5]
      $_time_til_end_of_ripple2 := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$_artic5]-$_rec_time_pos_in_ripple)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))))
      if (real_to_int(?xypad_releaseSamples[0]*int_to_real(6))=0)
        $_play_release_sample := 0
      else
        if (real_to_int(?xypad_releaseSamples[0]*int_to_real(6))>0)
          $_play_release_sample := 1
        end if
      end if
      $_triggered_by_keyswitch := 0
      if (%key_down[$recent_release_trigger_key]=1)
        $_play_release_sample := 1
        $_triggered_by_keyswitch := 1
      end if
      %custom_event_play_release_sample[%ripple_id_history[$_r6] mod 1000000] := $_play_release_sample
      $val := real_to_int(?xypad_releaseSamples[0]*int_to_real(6))
      if ($_play_release_sample=0)
        %custom_event_note_off_timestamp[%ripple_id_history[$_r6] mod 1000000] := $ENGINE_UPTIME
        %custom_event_releasing[%ripple_id_history[$_r6] mod 1000000] := 1
        $_fade_out_time := $_time_til_end_of_ripple2
        if ($_fade_out_time<30000)
          $_fade_out_time := 30000
        end if
        %custom_event_release_length[%ripple_id_history[$_r6] mod 1000000] := $_fade_out_time/5*4
        fade_out(%ripple_id_history[$_r6],$_fade_out_time,1)
      else
        if (%custom_event_waiting_for_release_sample[%ripple_id_history[$_r6] mod 1000000]=0)
          %custom_event_waiting_for_release_sample[%ripple_id_history[$_r6] mod 1000000] := 1
          $_rls_note := %custom_event_origin_note[%ripple_id_history[$_r6] mod 1000000]
          $_prev_rls_note_rec_time := real_to_int(int_to_real(0)+((int_to_real($ENGINE_UPTIME-%rls_note_timestamp[$_rls_note])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))))*1000
          if (abs($_prev_rls_note_rec_time-($_rec_time_pos_in_ripple+$_offset_rec_time5))<5000)
            fade_out(%rls_note_ids[$_rls_note],50000,0)
          end if
          $_vol := get_event_par(%ripple_id_history[$_r6],$EVENT_PAR_VOLUME)
          $_offset := 0
          if ($_rec_time_play_pos-$_offset<(%rec_time_sample_lengths[$_artic5]/2))
            $_rec_time_play_pos := $_rec_time_play_pos-$_offset
            if ($_rec_time_play_pos<0)
              $_rec_time_play_pos := 0
            end if
          else
            $_rec_time_play_pos := $_rec_time_play_pos+$_offset
          end if
          if (real_to_int(?xypad_releaseSamples[0]*int_to_real(6))=$releaseSampleMode__autoRelease)
            $_cur_ripple := $_rec_time_play_pos/%rec_time_ripple_lengths[$_artic5]
            if ($_cur_ripple>3)
              $_cur_ripple := 4-($_cur_ripple-3)
            end if
          else
            $_cur_ripple := real_to_int(?xypad_releaseSamples[0]*int_to_real(6))-2
          end if
          if ($_triggered_by_keyswitch=1)
            $_cur_ripple := real_to_int(int_to_real(0)+((int_to_real(%velo[$recent_release_trigger_key])-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(4)-int_to_real(0))))
          end if
          if ($_cur_ripple<0)
            $_cur_ripple := 0
          end if
          if ($_cur_ripple>3)
            $_cur_ripple := 3
          end if
          %custom_event_current_ripple[%ripple_id_history[$_r6] mod 1000000] := $_cur_ripple
          $_vel4 := $_cur_ripple*32+1
          %rls_note_ids[$_rls_note] := play_note($_rls_note,$_vel4,$_rec_time_pos_in_ripple+$_offset_rec_time5,0)
          %rls_note_timestamp[$_rls_note] := $ENGINE_UPTIME-real_to_int(int_to_real(0)+((int_to_real(($_rec_time_pos_in_ripple+$_offset_rec_time5)/1000)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
          set_event_par_arr(%rls_note_ids[$_rls_note],$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
          set_event_par_arr(%rls_note_ids[$_rls_note],$EVENT_PAR_ALLOW_GROUP,1,%release_group[$_artic5])
          %custom_event_active[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_active[%ripple_id_history[$_r6] mod 1000000]
          %custom_event_current_ripple[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_current_ripple[%ripple_id_history[$_r6] mod 1000000]
          %custom_event_source[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_source[%ripple_id_history[$_r6] mod 1000000]
          %custom_event_note[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_note[%ripple_id_history[$_r6] mod 1000000]
          %custom_event_velocity[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_velocity[%ripple_id_history[$_r6] mod 1000000]
          %custom_event_low_note[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_low_note[%ripple_id_history[$_r6] mod 1000000]
          %custom_event_high_note[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_high_note[%ripple_id_history[$_r6] mod 1000000]
          %custom_event_origin_note[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_origin_note[%ripple_id_history[$_r6] mod 1000000]
          %custom_event_dest_note[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_dest_note[%ripple_id_history[$_r6] mod 1000000]
          %custom_event_first_note[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_first_note[%ripple_id_history[$_r6] mod 1000000]
          %custom_event_second_note[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_second_note[%ripple_id_history[$_r6] mod 1000000]
          %custom_event_direction[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_direction[%ripple_id_history[$_r6] mod 1000000]
          %custom_event_artic[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_artic[%ripple_id_history[$_r6] mod 1000000]
          %custom_event_voice[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_voice[%ripple_id_history[$_r6] mod 1000000]
          %custom_event_note_off_timestamp[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_note_off_timestamp[%ripple_id_history[$_r6] mod 1000000]
          %custom_event_marked_for_release[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_marked_for_release[%ripple_id_history[$_r6] mod 1000000]
          %custom_event_play_release_sample[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_play_release_sample[%ripple_id_history[$_r6] mod 1000000]
          %custom_event_release_length[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_release_length[%ripple_id_history[$_r6] mod 1000000]
          %custom_event_release_sample_length[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_release_sample_length[%ripple_id_history[$_r6] mod 1000000]
          %custom_event_release_note[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_release_note[%ripple_id_history[$_r6] mod 1000000]
          %custom_event_release_dynamic[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_release_dynamic[%ripple_id_history[$_r6] mod 1000000]
          %custom_event_brightness_when_released[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_brightness_when_released[%ripple_id_history[$_r6] mod 1000000]
          %custom_event_waiting_for_release_sample[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_waiting_for_release_sample[%ripple_id_history[$_r6] mod 1000000]
          %custom_event_fading_out_for_release_sample[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_fading_out_for_release_sample[%ripple_id_history[$_r6] mod 1000000]
          %custom_event_rls_sample_id[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_rls_sample_id[%ripple_id_history[$_r6] mod 1000000]
          %custom_event_crossfading[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_crossfading[%ripple_id_history[$_r6] mod 1000000]
          %custom_event_releasing[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_releasing[%ripple_id_history[$_r6] mod 1000000]
          %custom_event_triggered_by_mf[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_triggered_by_mf[%ripple_id_history[$_r6] mod 1000000]
          %custom_event_ripple_index[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_ripple_index[%ripple_id_history[$_r6] mod 1000000]
          %custom_event_preview_being_stopped[%rls_note_ids[$_rls_note] mod 1000000] := %custom_event_preview_being_stopped[%ripple_id_history[$_r6] mod 1000000]
          %custom_event_source[%rls_note_ids[$_rls_note] mod 1000000] := -1
          change_vol(%rls_note_ids[$_rls_note],get_event_par(%ripple_id_history[$_r6],$EVENT_PAR_VOLUME),0)
          %custom_event_rls_sample_id[%ripple_id_history[$_r6] mod 1000000] := %rls_note_ids[$_rls_note]
        end if
      end if
    end if
    inc($_r6)
  end while
  call count_keys_active
  if ($num_keys_active=0)
    $all_keys_inactive := 1
  end if
end function

function stop_all_clips_and_ripples
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  $r := 0
  while ($r<64)
    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
      %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
      %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
    end if
    inc($r)
  end while
  $key_i := $LOWEST_KEY
  while ($key_i<=$HIGHEST_KEY)
    set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
    %key_down[$key_i] := 0
    %key_active[$key_i] := 0
    inc($key_i)
  end while
  $clip_i := 0
  while ($clip_i<num_elements(%switch_preview))
    set_control_par(%switch_preview[$clip_i],$CONTROL_PAR_VALUE,0)
    if (%playing[$clip_i]=1)
      %playing[$clip_i] := 0
      %looping[$clip_i] := 0
    end if
    inc($clip_i)
  end while
  call deactivate_mf_notes
  call release_marked_ripples
end function

function set_reverb_menu_checkmark
  $_i := 0
  while ($_i<3)
    if ($_i=$menu_reverb)
      @_checkmark := " x "
    else
      @_checkmark := "    "
    end if
    set_menu_item_str(get_ui_id($menu_reverb),$_i,@_checkmark & !reverb_preset_names[$_i])
    inc($_i)
  end while
end function

function update_reverb_slider_picture
  if ($switch_reverbToggle=0)
    set_control_par_str(get_ui_id($slider_reverb),$CONTROL_PAR_PICTURE,"knob gray")
  else
    set_control_par_str(get_ui_id($slider_reverb),$CONTROL_PAR_PICTURE,"knob")
  end if
end function

function update_reverb_send_levels
  if (in_range($slider_reverb,0,500000))
    ~vol := 0.0+((int_to_real($slider_reverb)-int_to_real(0))/(int_to_real(500000)-int_to_real(0))*(0.5-0.0))
  else
    if (in_range($slider_reverb,500000,1000000))
      ~vol := 0.5+((int_to_real($slider_reverb)-int_to_real(500000))/(int_to_real(1000000)-int_to_real(500000))*(2.0-0.5))
    end if
  end if
  if (~vol<0.00001)
    ~vol := 0.00001
  end if
  ~db := 20.0*(log(~vol)/log(int_to_real(10)))
  set_engine_par($ENGINE_PAR_SENDLEVEL_0,-sh_right(abs($menu_reverb-0)-1,31)*-sh_right(abs($switch_reverbToggle-1)-1,31)*real_to_int(pow(2.0,(~db*1000.0+346768.2342478351)/18000.0)),-1,7,1)
  set_engine_par($ENGINE_PAR_SENDLEVEL_1,-sh_right(abs($menu_reverb-1)-1,31)*-sh_right(abs($switch_reverbToggle-1)-1,31)*real_to_int(pow(2.0,(~db*1000.0+346768.2342478351)/18000.0)),-1,7,1)
  set_engine_par($ENGINE_PAR_SENDLEVEL_2,-sh_right(abs($menu_reverb-2)-1,31)*-sh_right(abs($switch_reverbToggle-1)-1,31)*real_to_int(pow(2.0,(~db*1000.0+346768.2342478351)/18000.0)),-1,7,1)
  set_engine_par($ENGINE_PAR_SENDLEVEL_7,real_to_int(pow(2.0,(~db*1000.0+346768.2342478351)/18000.0)),-1,7,1)
end function

function update_engine_pars
  %p[$sp-4] := $fp
  $fp := $sp-4
  $sp := $fp
  %p[$fp+1] := %ctrl_ids[%p[$fp+3]]
  if (%p[$fp+1] # 0)
    %p[$fp+2] := get_control_par(%p[$fp+1],$CONTROL_PAR_VALUE)
  end if
  select (%p[$fp+3])
    case $control__vol
      if (in_range(%p[$fp+2],0,500000))
        set_engine_par($ENGINE_PAR_SEND_EFFECT_OUTPUT_GAIN,real_to_int(int_to_real(real_to_int(pow(2.0,(-16000.0-12000.0+346768.2342478351)/18000.0)))+((int_to_real(%p[$fp+2])-int_to_real(0))/(int_to_real(500000)-int_to_real(0))*(int_to_real(real_to_int(pow(2.0,(0.0-12000.0+346768.2342478351)/18000.0)))-int_to_real(real_to_int(pow(2.0,(-16000.0-12000.0+346768.2342478351)/18000.0)))))),-1,0,1)
      else
        if (in_range(%p[$fp+2],500000,1000000))
          set_engine_par($ENGINE_PAR_SEND_EFFECT_OUTPUT_GAIN,real_to_int(int_to_real(real_to_int(pow(2.0,(0.0-12000.0+346768.2342478351)/18000.0)))+((int_to_real(%p[$fp+2])-int_to_real(500000))/(int_to_real(1000000)-int_to_real(500000))*(int_to_real(real_to_int(pow(2.0,(8000.0-12000.0+346768.2342478351)/18000.0)))-int_to_real(real_to_int(pow(2.0,(0.0-12000.0+346768.2342478351)/18000.0)))))),-1,0,1)
        end if
      end if
      set_engine_par($ENGINE_PAR_SEQ_HF_GAIN,real_to_int(int_to_real(550000)+((int_to_real(%p[$fp+2])-int_to_real(0))/(int_to_real(1000000)-int_to_real(0))*(int_to_real(650000)-int_to_real(550000)))),-1,6,$NI_MAIN_BUS)
      set_engine_par($ENGINE_PAR_STEREO,real_to_int(int_to_real(400000)+((int_to_real(%p[$fp+2])-int_to_real(0))/(int_to_real(1000000)-int_to_real(0))*(int_to_real(600000)-int_to_real(400000)))),-1,7,$NI_MAIN_BUS)
    case $control__reverb
      call update_reverb_send_levels
    case $control__reverb_type
      call update_reverb_send_levels
    case $control__speed
      $g := 0
      while ($g<$NUM_GROUPS)
        if ($switch_halfSpeed=1)
          set_engine_par($ENGINE_PAR_SPEED_UNIT,$NI_SYNC_UNIT_QUARTER,$g,-1,-1)
        end if
        if ($switch_slowTripletSpeed=1)
          set_engine_par($ENGINE_PAR_SPEED_UNIT,$NI_SYNC_UNIT_QUARTER_TRIPLET,$g,-1,-1)
        end if
        if ($switch_fullSpeed=1)
          set_engine_par($ENGINE_PAR_SPEED_UNIT,$NI_SYNC_UNIT_8TH,$g,-1,-1)
        end if
        if ($switch_fastTripletSpeed=1)
          set_engine_par($ENGINE_PAR_SPEED_UNIT,$NI_SYNC_UNIT_8TH_TRIPLET,$g,-1,-1)
        end if
        if ($switch_doubleSpeed=1)
          set_engine_par($ENGINE_PAR_SPEED_UNIT,$NI_SYNC_UNIT_16TH,$g,-1,-1)
        end if
        inc($g)
      end while
  end select
  $sp := $fp
  $fp := %p[$fp]
  $sp := $sp+4
end function

function update_nks_label
  %p[$sp-4] := $fp
  $fp := $sp-4
  $sp := $fp
  %p[$fp+1] := %ctrl_ids[%p[$fp+3]]
  if (%p[$fp+1] # 0)
    %p[$fp+2] := get_control_par(%p[$fp+1],$CONTROL_PAR_VALUE)
  end if
  select (%p[$fp+3])
    case $control__vol
      set_control_par_str(%p[$fp+1],$CONTROL_PAR_LABEL,$slider_vol/10000 & " %")
    case $control__reverb
      set_control_par_str(%p[$fp+1],$CONTROL_PAR_LABEL,get_engine_par_disp($ENGINE_PAR_SENDLEVEL_7,-1,7,1) & " dB")
    case $control__speed to $control__releaseSamples
      set_control_par_str(%p[$fp+1],$CONTROL_PAR_LABEL,!_option_texts_shortened[10*%p[$fp+3]+%p[$fp+2]])
  end select
  $sp := $fp
  $fp := %p[$fp]
  $sp := $sp+4
end function

function update_title_page
  if ($cur_title_page=0)
    set_control_par(get_ui_id($button_prevTitlePg),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
  else
    set_control_par(get_ui_id($button_prevTitlePg),$CONTROL_PAR_HIDE,$HIDE_PART_NOTHING)
  end if
  if ($cur_title_page=(4-1))
    set_control_par(get_ui_id($button_nextTitlePg),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
  else
    set_control_par(get_ui_id($button_nextTitlePg),$CONTROL_PAR_HIDE,$HIDE_PART_NOTHING)
  end if
  set_control_par(get_ui_id($label_titlePg),$CONTROL_PAR_PICTURE_STATE,$cur_title_page)
  $i := 0
  while ($i<4)
    if ($i=$cur_title_page)
      set_control_par(%switch_titlePgSelector[$i],$CONTROL_PAR_VALUE,1)
    else
      set_control_par(%switch_titlePgSelector[$i],$CONTROL_PAR_VALUE,0)
    end if
    inc($i)
  end while
end function

function update_midi_clips
  $i := 0
  while ($i<=7)
    set_control_par(%midi_clip_dnd_id[$i],$CONTROL_PAR_MIDI_EXPORT_AREA_IDX,$cur_midi_page*8+$i+1)
    set_control_par_str(%label_clip[$i],$CONTROL_PAR_PICTURE,"clip" & ($cur_midi_page*8+$i))
    set_control_par(get_ui_id($label_midiPgDescription),$CONTROL_PAR_PICTURE_STATE,$cur_midi_page)
    set_control_par_str(%switch_preview[$i],$CONTROL_PAR_PICTURE,"clip title " & ($cur_midi_page*8+$i))
    inc($i)
  end while
end function

function update_midi_visibility
  set_control_par(get_ui_id($switch_closeMidi),$CONTROL_PAR_HIDE,%hide_states[$button_showMidi])
  set_control_par(get_ui_id($panel_midi),$CONTROL_PAR_HIDE,%hide_states[$button_showMidi])
  set_control_par(get_ui_id($label_midiInstructions),$CONTROL_PAR_HIDE,%hide_states[$button_showMidi])
  ~midiInstructions_opacity := int_to_real($button_showMidi)
  ~midiCover_opacity := int_to_real($button_showMidi)
  set_control_par(get_ui_id($panel_articulations),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($panel_fx),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($panel_speed),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id(?xypad_speed),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($panel_direction),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id(?xypad_direction),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($panel_legato),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id(?xypad_legato),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($panel_releaseSamples),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id(?xypad_releaseSamples),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($button_generalInfo),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
  set_control_par(get_ui_id($button_optionsInfo),$CONTROL_PAR_HIDE,%hide_states[1-$button_showMidi])
end function

function update_midi_page_chooser_switches
  $i := 0
  while ($i<10)
    if ($i=$cur_midi_page)
      set_control_par(%switch_midiPgChooser[$i],$CONTROL_PAR_VALUE,1)
    else
      set_control_par(%switch_midiPgChooser[$i],$CONTROL_PAR_VALUE,0)
    end if
    inc($i)
  end while
end function

function count_keys_down
  $num_keys_down := 0
  $_key_i2 := $LOWEST_KEY
  while ($_key_i2<=$HIGHEST_KEY)
    if (%key_down[$_key_i2]=1)
      inc($num_keys_down)
    end if
    inc($_key_i2)
  end while
end function

function update_articulation_switches
  $i := 0
  while ($i<num_elements(%articulation_ids))
    if ($i=$cur_artic)
      set_control_par(%articulation_ids[$i],$CONTROL_PAR_VALUE,1)
    else
      set_control_par(%articulation_ids[$i],$CONTROL_PAR_VALUE,0)
    end if
    inc($i)
  end while
end function

function update_speed_switches
  $i := 0
  while ($i<num_elements(%speed_ids))
    if ($i=$speed_nks)
      set_control_par(%speed_ids[$i],$CONTROL_PAR_VALUE,1)
    else
      set_control_par(%speed_ids[$i],$CONTROL_PAR_VALUE,0)
    end if
    inc($i)
  end while
end function

function set_keys_pressed
  $i := 0
  while ($i<3)
    if ($i=$cur_artic)
      set_key_pressed(%articulation_keyswitches[$i],1)
    else
      set_key_pressed(%articulation_keyswitches[$i],0)
    end if
    inc($i)
  end while
  $i := 0
  while ($i<5)
    if ($i=real_to_int(?xypad_speed[0]*int_to_real(5)))
      set_key_pressed(%speed_keyswitches[$i],1)
    else
      set_key_pressed(%speed_keyswitches[$i],0)
    end if
    inc($i)
  end while
  $i := 0
  while ($i<3)
    if ($i=real_to_int(?xypad_direction[0]*int_to_real(3)))
      set_key_pressed(%direction_keyswitches[$i],1)
    else
      set_key_pressed(%direction_keyswitches[$i],0)
    end if
    inc($i)
  end while
  $i := 0
  while ($i<4)
    if ($i=real_to_int(?xypad_legato[0]*int_to_real(4)))
      set_key_pressed(%legato_keyswitches[$i],1)
    else
      set_key_pressed(%legato_keyswitches[$i],0)
    end if
    inc($i)
  end while
  $i := 0
  while ($i<6)
    if ($i=real_to_int(?xypad_releaseSamples[0]*int_to_real(6)))
      set_key_pressed(%release_sample_keyswitches[$i],1)
    else
      set_key_pressed(%release_sample_keyswitches[$i],0)
    end if
    inc($i)
  end while
  $i := 0
  while ($i<=1)
    if ($i=$switch_velToSampleStart)
      set_key_pressed(%vel_to_start_keyswitches[$i],1)
    else
      set_key_pressed(%vel_to_start_keyswitches[$i],0)
    end if
    inc($i)
  end while
end function

function set_speed
  $i := 0
  while ($i<num_elements(%speed_ids))
    if ($i=$speed_nks)
      set_control_par(%speed_ids[$i],$CONTROL_PAR_VALUE,1)
    else
      set_control_par(%speed_ids[$i],$CONTROL_PAR_VALUE,0)
    end if
    inc($i)
  end while
  %p[$sp-1] := $control__speed
  call update_engine_pars
  %p[$sp-1] := $control__speed
  call update_nks_label
  call set_keys_pressed
end function

function update_direction_switches
  $i := 0
  while ($i<num_elements(%direction_ids))
    if ($i=$direction_nks)
      set_control_par(%direction_ids[$i],$CONTROL_PAR_VALUE,1)
    else
      set_control_par(%direction_ids[$i],$CONTROL_PAR_VALUE,0)
    end if
    inc($i)
  end while
end function

function set_direction
  call update_direction_switches
  %p[$sp-1] := $control__direction
  call update_nks_label
  call set_keys_pressed
end function

function update_legato_switches
  $i := 0
  while ($i<num_elements(%legato_ids))
    if ($i=$legato_nks)
      set_control_par(%legato_ids[$i],$CONTROL_PAR_VALUE,1)
    else
      set_control_par(%legato_ids[$i],$CONTROL_PAR_VALUE,0)
    end if
    inc($i)
  end while
end function

function set_legato
  call update_legato_switches
  %p[$sp-1] := $control__legato
  call update_nks_label
  call set_keys_pressed
end function

function update_releaseSamples_switches
  $i := 0
  while ($i<num_elements(%releaseSamples_ids))
    if ($i=$releaseSamples_nks)
      set_control_par(%releaseSamples_ids[$i],$CONTROL_PAR_VALUE,1)
    else
      set_control_par(%releaseSamples_ids[$i],$CONTROL_PAR_VALUE,0)
    end if
    inc($i)
  end while
end function

function set_releaseSamples
  call update_releaseSamples_switches
  %p[$sp-1] := $control__releaseSamples
  call update_nks_label
  call set_keys_pressed
end function

on persistence_changed
  call set_key_colors_and_types_and_names
  call set_keys_pressed
  call set_reverb_menu_checkmark
  call update_reverb_slider_picture
  call update_midi_page_chooser_switches
  call update_midi_clips
  ?xypad_speed[0] := int_to_real($speed_nks)/int_to_real(5)
  set_control_par(get_ui_id(?xypad_speed),$CONTROL_PAR_PICTURE_STATE,$speed_nks)
  $speed_nks := $speed_nks
  ?xypad_direction[0] := int_to_real($direction_nks)/int_to_real(3)
  set_control_par(get_ui_id(?xypad_direction),$CONTROL_PAR_PICTURE_STATE,$direction_nks)
  $direction_nks := $direction_nks
  ?xypad_legato[0] := int_to_real($legato_nks)/int_to_real(4)
  set_control_par(get_ui_id(?xypad_legato),$CONTROL_PAR_PICTURE_STATE,$legato_nks)
  $legato_nks := $legato_nks
  ?xypad_releaseSamples[0] := int_to_real($releaseSamples_nks)/int_to_real(6)
  set_control_par(get_ui_id(?xypad_releaseSamples),$CONTROL_PAR_PICTURE_STATE,$releaseSamples_nks)
  $releaseSamples_nks := $releaseSamples_nks
  $i := 0
  while ($i<7)
    %p[$sp-1] := $i
    call update_nks_label
    %p[$sp-1] := $i
    call update_engine_pars
    inc($i)
  end while
end on

on note
  %custom_event_source[$EVENT_ID mod 1000000] := -1
  set_event_par_arr($EVENT_ID,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
  set_key_pressed($EVENT_NOTE,1)
  %key_down[$EVENT_NOTE] := 1
  %velo[$EVENT_NOTE] := $EVENT_VELOCITY
  $_ks_index := search(%articulation_keyswitches,$EVENT_NOTE)
  if ($_ks_index # -1)
    $cur_artic := $_ks_index
    call update_articulation_switches
  end if
  $_ks_index := search(%speed_keyswitches,$EVENT_NOTE)
  if ($_ks_index # -1)
    ?xypad_speed[0] := int_to_real($_ks_index)/int_to_real(5)
    set_control_par(get_ui_id(?xypad_speed),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
    $speed_nks := $_ks_index
    call update_speed_switches
    %p[$sp-1] := $control__speed
    call update_engine_pars
    %p[$sp-1] := $control__speed
    call update_nks_label
  end if
  $_ks_index := search(%direction_keyswitches,$EVENT_NOTE)
  if ($_ks_index # -1)
    ?xypad_direction[0] := int_to_real($_ks_index)/int_to_real(3)
    set_control_par(get_ui_id(?xypad_direction),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
    $direction_nks := $_ks_index
    call update_direction_switches
    %p[$sp-1] := $control__direction
    call update_nks_label
  end if
  $_ks_index := search(%legato_keyswitches,$EVENT_NOTE)
  if ($_ks_index # -1)
    ?xypad_legato[0] := int_to_real($_ks_index)/int_to_real(4)
    set_control_par(get_ui_id(?xypad_legato),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
    $legato_nks := $_ks_index
    call update_legato_switches
    %p[$sp-1] := $control__legato
    call update_nks_label
  end if
  $_ks_index := search(%release_sample_keyswitches,$EVENT_NOTE)
  if ($_ks_index # -1)
    ?xypad_releaseSamples[0] := int_to_real($_ks_index)/int_to_real(6)
    set_control_par(get_ui_id(?xypad_releaseSamples),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
    $releaseSamples_nks := $_ks_index
    call update_releaseSamples_switches
    %p[$sp-1] := $control__releaseSamples
    call update_nks_label
  end if
  $_ks_index := search(%vel_to_start_keyswitches,$EVENT_NOTE)
  if ($_ks_index # -1)
    $switch_velToSampleStart := $_ks_index
  end if
  $_ks_index := search(%release_trigger_keyswitches,$EVENT_NOTE)
  if ($_ks_index # -1)
    $recent_release_trigger_key := $EVENT_NOTE
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    call release_marked_ripples
  end if
  if (search(%all_keyswitches,$EVENT_NOTE) # -1)
    call set_keys_pressed
  end if
  if (in_range($EVENT_NOTE,$LOWEST_KEY,$HIGHEST_KEY))
    %key_active[$EVENT_NOTE] := 1
    %key_timestamp[$EVENT_NOTE] := $ENGINE_UPTIME
    set_control_par(%key_ids[$EVENT_NOTE],$CONTROL_PAR_PICTURE_STATE,1)
    $key_i := num_elements(%key_history)-2
    while ($key_i>=0)
      %key_history[$key_i+1] := %key_history[$key_i]
      dec($key_i)
    end while
    %key_history[0] := $EVENT_NOTE
    call count_keys_down
    if ($num_keys_down>1)
      $_num_ripples := 0
      $_closest_neighbor := -1
      $_closest_neighbor_interval := 12
      $array_i := 0
      while ($array_i<num_elements(%_neighbor))
        %_neighbor[$array_i] := 0
        inc($array_i)
      end while
      $array_i := 0
      while ($array_i<num_elements(%_lower_neighbor))
        %_lower_neighbor[$array_i] := 0
        inc($array_i)
      end while
      $array_i := 0
      while ($array_i<num_elements(%_upper_neighbor))
        %_upper_neighbor[$array_i] := 0
        inc($array_i)
      end while
      $_num_neighbors := 0
      $_num_lower_neighbors := 0
      $_num_upper_neighbors := 0
      $i := 1
      while ($i<=$MAX_INTERVAL)
        $_dir := 0
        while ($_dir<=1)
          $_sign := $_dir*2-1
          $_other_note := $EVENT_NOTE+($i*$_sign)
          if (%key_down[$_other_note]=1)
            %_neighbor[$_num_neighbors] := $_other_note
            inc($_num_neighbors)
            if ($_other_note<$EVENT_NOTE)
              %_lower_neighbor[$_num_lower_neighbors] := $_other_note
              inc($_num_lower_neighbors)
            end if
            if ($_other_note>$EVENT_NOTE)
              %_upper_neighbor[$_num_upper_neighbors] := $_other_note
              inc($_num_upper_neighbors)
            end if
          end if
          inc($_dir)
        end while
        inc($i)
      end while
      if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
        $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
        $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
        if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
          $_make_ripples_to_both_adjacent_neighbors := 1
        else
          $_make_ripples_to_both_adjacent_neighbors := 0
        end if
        if (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__UP or (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__DOWN))
          $_make_ripples_to_both_adjacent_neighbors := 1
        end if
        if ($_make_ripples_to_both_adjacent_neighbors=1)
          %__notes[0] := %_lower_neighbor[0]
          %__intervals[0] := $EVENT_NOTE-%_lower_neighbor[0]
          %__notes[1] := %_upper_neighbor[0]
          %__intervals[1] := $EVENT_NOTE-%_upper_neighbor[0]
          $_num_ripples := 2
        else
          if ($_make_ripples_to_both_adjacent_neighbors=0)
            if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
              %__notes[0] := %_lower_neighbor[0]
              %__intervals[0] := $EVENT_NOTE-%_lower_neighbor[0]
            else
              %__notes[0] := %_upper_neighbor[0]
              %__intervals[0] := $EVENT_NOTE-%_upper_neighbor[0]
            end if
            $_num_ripples := 1
          end if
        end if
      else
        %__notes[0] := %key_history[1]
        %__intervals[0] := %key_history[0]-%key_history[1]
        $_num_ripples := 1
        if (abs(%__intervals[0])>$MAX_INTERVAL)
          if ($_num_neighbors>0)
            %__notes[0] := %_neighbor[0]
            %__intervals[0] := $EVENT_NOTE-%_neighbor[0]
            $_num_ripples := 1
          else
            $array_i := 0
            while ($array_i<num_elements(%__notes))
              %__notes[$array_i] := 0
              inc($array_i)
            end while
            $array_i := 0
            while ($array_i<num_elements(%__intervals))
              %__intervals[$array_i] := 0
              inc($array_i)
            end while
            $_num_ripples := 0
          end if
        end if
      end if
      $array_i := 0
      while ($array_i<num_elements(%__notes))
        %_played_notes[$array_i] := %__notes[$array_i]
        inc($array_i)
      end while
      $array_i := 0
      while ($array_i<num_elements(%__intervals))
        %_played_intervals[$array_i] := %__intervals[$array_i]
        inc($array_i)
      end while
      $ripple_i := 0
      while ($ripple_i<$_num_ripples)
        if (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__UP)
          if (%__intervals[$ripple_i]<0)
            %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
            %__intervals[$ripple_i] := -%__intervals[$ripple_i]
          end if
        else
          if (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__DOWN)
            if (%__intervals[$ripple_i]>0)
              %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
              %__intervals[$ripple_i] := -%__intervals[$ripple_i]
            end if
          end if
        end if
        if (%__intervals[$ripple_i]<0)
          $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
          $_high_note2 := %__notes[$ripple_i]
        else
          $_low_note2 := %__notes[$ripple_i]
          $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
        end if
        if (%__intervals[$ripple_i]>0)
          $_ripple_dir := $UP
        else
          $_ripple_dir := $DOWN
        end if
        $_origin_note3 := %__notes[$ripple_i]
        $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
        $_first_note := %_played_notes[$ripple_i]
        $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
        $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))))
        $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
        $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))))
        if ($all_keys_inactive=1)
          $_do_legato := 0
        else
          $_do_legato := 1
        end if
        $all_keys_inactive := 0
        if (real_to_int(?xypad_legato[0]*int_to_real(4))=0)
          $_do_legato := 0
        end if
        if ($_do_legato=0)
          $first_ripple_timestamp := $ENGINE_UPTIME
          $_real_legato_time := 0
          $_offset_real_time := 0
          $_ext_mode_real_legato_time := 0
        else
          $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
          $_ext_mode_real_legato_time := $_real_legato_time
          select (real_to_int(?xypad_legato[0]*int_to_real(4)))
            case $legatoMode__syncToPitch
              $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
              $_offset_real_time := $_real_legato_time mod $_real_pitch_length
              $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
            case $legatoMode__syncToRipple
              $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
              $_offset_real_time := $_real_legato_time mod $_real_ripple_length
              $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
            case $legatoMode__syncToSwell
              $_offset_real_time := $_real_legato_time mod $_real_sample_length
          end select
          if ($_offset_real_time<0)
            $_offset_real_time := 0
          end if
        end if
        $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
        $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))))-$_latency_real_time)*1000)
        $_offset_rec_time4 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
        if ($switch_velToSampleStart=1)
          $_offset_rec_time4 := $_offset_rec_time4 mod %rec_time_ripple_lengths[$cur_artic]
          $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
          $_offset_rec_time4 := $_offset_rec_time4+$_vel_offset
          $_offset_rec_time4 := $_offset_rec_time4 mod $_real_sample_length
        end if
        $_already_playing := 0
        $r := 0
        while ($r<64)
          if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
            if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note3 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$_ripple_dir) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time4<5000))
              $_already_playing := 1
              %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
            end if
          end if
          inc($r)
        end while
        if ($_already_playing=0)
          if ($switch_midiOutputMode=0)
            $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time4,0)
            if ($switch_velToSampleStart=0)
              $_volume := real_to_int(int_to_real(-7000)+((int_to_real($EVENT_VELOCITY)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
              change_vol($_note_id2,$_volume,0)
            end if
            set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
            %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
            %custom_event_note[$_note_id2 mod 1000000] := $EVENT_NOTE
            %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
            %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
            %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note3
            %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
            %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
            %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
            %custom_event_velocity[$_note_id2 mod 1000000] := $EVENT_VELOCITY
            %custom_event_direction[$_note_id2 mod 1000000] := $_ripple_dir
            %custom_event_source[$_note_id2 mod 1000000] := -1
            %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$EVENT_ID mod 1000000]
            $r := 64-2
            while ($r>=0)
              %ripple_id_history[$r+1] := %ripple_id_history[$r]
              dec($r)
            end while
            %ripple_id_history[0] := $_note_id2
            $_fade_in_time := 0
            if ($_do_legato=0)
              $_fade_in_time := $menu_latency*1000
              if ($_fade_in_time=0)
                $_fade_in_time := 0
              end if
            else
              $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
              $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
              if ($cur_artic=$artic__sixteenths)
                if ($_real_pos_in_ripple<($_real_ripple_length/4))
                  $_real_pitch_length := $_real_ripple_length/4
                  $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                  $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                else
                  $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                end if
              else
                $_real_pitch_length := $_real_ripple_length/2
                $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
              end if
              if (in_range($EVENT_VELOCITY,1,48))
                $_fade_in_time := $_time_til_end_of_ripple
              else
                if (in_range($EVENT_VELOCITY,49,96))
                  $_fade_in_time := $_time_til_end_of_pitch
                else
                  if (in_range($EVENT_VELOCITY,97,127))
                    $_fade_in_time := $_time_til_end_of_pitch/2
                  end if
                end if
              end if
              if ($_fade_in_time<ticks_to_ms(192))
                $_fade_in_time := ticks_to_ms(192)
              end if
            end if
            fade_in($_note_id2,$_fade_in_time)
          else
            $_ext_first_note := $_first_note
            $_ext_second_note := $_second_note
            $_ext_low_note := $_low_note2
            $_ext_high_note := $_high_note2
            $_ext_artic := $cur_artic
            $_wait_time := $_ext_mode_real_legato_time
            if ($_wait_time>0)
              select (real_to_int(?xypad_legato[0]*int_to_real(4)))
                case $legatoMode__syncToPitch
                  $_wait_time := $_real_pitch_length-($_wait_time mod $_real_pitch_length)
                case $legatoMode__syncToRipple
                  if ($_wait_time mod $_real_ripple_length<=$_real_pitch_length)
                    $_note_chooser := 1
                  end if
                  $_wait_time := $_real_pitch_length-($_wait_time mod $_real_pitch_length)
                case $legatoMode__syncToSwell
                  if ($_wait_time mod $_real_ripple_length<=$_real_pitch_length)
                    $_note_chooser := 1
                  end if
                  $_ext_pitch := $_wait_time/$_real_pitch_length
                  $_wait_time := $_real_pitch_length-($_wait_time mod $_real_pitch_length)
              end select
            end if
            $_low_vel := %velo[$EVENT_NOTE]-35
            $_high_vel := $_low_vel+35
            if ($_high_vel>127)
              $_high_vel := 127
            end if
            if ($_low_vel<1)
              $_low_vel := 1
            end if
            if ($_wait_time>0)
              wait($_wait_time)
            end if
            while (%key_active[$EVENT_NOTE]=1)
              if ($_note_chooser=0)
                $_ext_note := $_ext_first_note
              else
                $_ext_note := $_ext_second_note
              end if
              ~_vel_norm := int_to_real($slider_vol)/1000000.0*(int_to_real(%velo[$EVENT_NOTE])/127.0)
              $_vel3 := real_to_int(~_vel_norm*int_to_real(127-60))+30
              if (in_range($_ext_pitch,0,7))
                $_vel3 := real_to_int(int_to_real($_vel3-30)+((int_to_real($_ext_pitch)-int_to_real(0))/(int_to_real(7)-int_to_real(0))*(int_to_real($_vel3+30)-int_to_real($_vel3-30))))
              else
                $_vel3 := real_to_int(int_to_real($_vel3+30)+((int_to_real($_ext_pitch)-int_to_real(8))/(int_to_real(15)-int_to_real(8))*(int_to_real($_vel3-30)-int_to_real($_vel3+30))))
              end if
              if ($_note_chooser=1)
                $_vel3 := $_vel3-20
              end if
              if ($_vel3<1)
                $_vel3 := 1
              end if
              if ($_vel3>127)
                $_vel3 := 127
              end if
              if ($_ext_artic=$artic__sixteenths)
                if ($_note_chooser=0)
                  $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                else
                  $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                end if
              else
                $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
              end if
              $_note_id2 := play_note($_ext_note,$_vel3,0,$_len)
              if ($_ext_artic=$artic__sixteenths)
                if ($_note_chooser=0)
                  $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                else
                  $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                end if
              else
                $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
              end if
              $_wait_time := real_to_int(int_to_real($_wait_time)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
              if ($_wait_time>0)
                wait($_wait_time)
              end if
              $_ext_pitch := ($_ext_pitch+1) mod 16
              $_note_chooser := 1-$_note_chooser
            end while
            if ($_note_chooser=0)
              $_ext_note := $_ext_first_note
            else
              $_ext_note := $_ext_second_note
            end if
            ~_vel_norm := int_to_real($slider_vol)/1000000.0*(int_to_real(%velo[$EVENT_NOTE])/127.0)
            $_vel3 := real_to_int(~_vel_norm*int_to_real(127-60))+30
            if (in_range($_ext_pitch,0,7))
              $_vel3 := real_to_int(int_to_real($_vel3-30)+((int_to_real($_ext_pitch)-int_to_real(0))/(int_to_real(7)-int_to_real(0))*(int_to_real($_vel3+30)-int_to_real($_vel3-30))))
            else
              $_vel3 := real_to_int(int_to_real($_vel3+30)+((int_to_real($_ext_pitch)-int_to_real(8))/(int_to_real(15)-int_to_real(8))*(int_to_real($_vel3-30)-int_to_real($_vel3+30))))
            end if
            if ($_note_chooser=1)
              $_vel3 := $_vel3-20
            end if
            if ($_vel3<1)
              $_vel3 := 1
            end if
            if ($_vel3>127)
              $_vel3 := 127
            end if
            if ($_ext_artic=$artic__sixteenths)
              if ($_note_chooser=0)
                $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
              else
                $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
              end if
            else
              $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
            end if
            $_note_id2 := play_note($_ext_note,$_vel3,0,$_len)
            if ($_ext_artic=$artic__sixteenths)
              if ($_note_chooser=0)
                $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
              else
                $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
              end if
            else
              $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
            end if
            $_wait_time := real_to_int(int_to_real($_wait_time)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
            if ($_wait_time>0)
              wait($_wait_time)
            end if
            $_ext_pitch := ($_ext_pitch+1) mod 16
            $_note_chooser := 1-$_note_chooser
            if ($_note_chooser=0)
              if ($_note_chooser=0)
                $_ext_note := $_ext_first_note
              else
                $_ext_note := $_ext_second_note
              end if
              ~_vel_norm := int_to_real($slider_vol)/1000000.0*(int_to_real(%velo[$EVENT_NOTE])/127.0)
              $_vel3 := real_to_int(~_vel_norm*int_to_real(127-60))+30
              if (in_range($_ext_pitch,0,7))
                $_vel3 := real_to_int(int_to_real($_vel3-30)+((int_to_real($_ext_pitch)-int_to_real(0))/(int_to_real(7)-int_to_real(0))*(int_to_real($_vel3+30)-int_to_real($_vel3-30))))
              else
                $_vel3 := real_to_int(int_to_real($_vel3+30)+((int_to_real($_ext_pitch)-int_to_real(8))/(int_to_real(15)-int_to_real(8))*(int_to_real($_vel3-30)-int_to_real($_vel3+30))))
              end if
              if ($_note_chooser=1)
                $_vel3 := $_vel3-20
              end if
              if ($_vel3<1)
                $_vel3 := 1
              end if
              if ($_vel3>127)
                $_vel3 := 127
              end if
              if ($_ext_artic=$artic__sixteenths)
                if ($_note_chooser=0)
                  $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                else
                  $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                end if
              else
                $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
              end if
              $_note_id2 := play_note($_ext_note,$_vel3,0,$_len)
              if ($_ext_artic=$artic__sixteenths)
                if ($_note_chooser=0)
                  $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                else
                  $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                end if
              else
                $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
              end if
              $_wait_time := real_to_int(int_to_real($_wait_time)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
              if ($_wait_time>0)
                wait($_wait_time)
              end if
              $_ext_pitch := ($_ext_pitch+1) mod 16
              $_note_chooser := 1-$_note_chooser
            end if
          end if
        end if
        inc($ripple_i)
      end while
    end if
  end if
end on

on release
  if (%custom_event_triggered_by_mf[$EVENT_ID mod 1000000]>0 and (%custom_event_active[$EVENT_ID mod 1000000]=0))
    $sksp_dummy := $sksp_dummy
    exit
  end if
  %key_down[$EVENT_NOTE] := 0
  if (search(%all_keyswitches,$EVENT_NOTE)=-1)
    set_key_pressed($EVENT_NOTE,0)
  end if
  if (in_range($EVENT_NOTE,$LOWEST_KEY,$HIGHEST_KEY) and (%custom_event_source[$EVENT_ID mod 1000000]=-1))
    set_control_par(%key_ids[$EVENT_NOTE],$CONTROL_PAR_PICTURE_STATE,0)
    $_note_found := 0
    $_hist_i := 0
    while ($_hist_i<num_elements(%key_history))
      if ($_note_found=0)
        if (%key_history[$_hist_i]=$EVENT_NOTE)
          $_note_found := 1
          $_history_index := $_hist_i
        end if
      end if
      inc($_hist_i)
    end while
    if ($_note_found=0)
      $_history_index := -1
    end if
    if ($_history_index>-1)
      $key_i := $_history_index
      while ($key_i<=(num_elements(%key_history)-2))
        %key_history[$key_i] := %key_history[$key_i+1]
        inc($key_i)
      end while
    end if
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        if ($EVENT_NOTE=%custom_event_second_note[%ripple_id_history[$r] mod 1000000])
          %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        end if
      end if
      inc($r)
    end while
    if (%CC[64]<10)
      if ($switch_midiOutputMode=1)
        %key_down[$EVENT_NOTE] := 0
      end if
      %key_active[$EVENT_NOTE] := 0
      call release_marked_ripples
    end if
  end if
end on

on controller
  if ($CC_NUM=64)
    if (%CC[$CC_NUM]<10 and ($_prev_cc64>=10))
      $key_i := $LOWEST_KEY
      while ($key_i<=$HIGHEST_KEY)
        if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
          %key_active[$key_i] := 0
        end if
        inc($key_i)
      end while
      call release_marked_ripples
    end if
    $_prev_cc64 := %CC[$CC_NUM]
  end if
end on

on listener
  if ($NI_SIGNAL_TYPE=$NI_SIGNAL_TIMER_MS)
    call crossfaded_looping
    call fade_out_ripples_when_release_sample_sounds
    call play_release_notes_when_its_time
    call ripple_animations
    call midi_clip_play_cursor
    call info_graphics_animation
    call hide_version
  end if
  if ($NI_SIGNAL_TYPE=$NI_SIGNAL_TRANSP_START)
  end if
  if ($NI_SIGNAL_TYPE=$NI_SIGNAL_TRANSP_STOP)
  end if
end on

on ui_control($button_showMidi)
  if ($button_showMidi=0)
    call stop_all_clips_and_ripples
  end if
  call update_midi_visibility
end on

on ui_control($switch_closeMidi)
  $button_showMidi := 0
  call stop_all_clips_and_ripples
  call update_midi_visibility
end on

on ui_control($switch_closeMidi2)
  $button_showMidi := 0
  call stop_all_clips_and_ripples
  call update_midi_visibility
end on

on ui_control($switch_midiOutputMode)
  set_control_par(get_ui_id($label_midiOutputModeCover),$CONTROL_PAR_HIDE,%hide_states[$switch_midiOutputMode])
end on

on ui_control($menu_latency)
  call update_latency_graphics
end on

on ui_control($switch_openTitleInfo)
  $button_showMidi := 0
  call update_midi_visibility
  if (get_control_par(get_ui_id($panel_titleInfo),$CONTROL_PAR_HIDE)=$HIDE_WHOLE_CONTROL)
    set_control_par(get_ui_id($panel_titleInfo),$CONTROL_PAR_HIDE,$HIDE_PART_NOTHING)
  else
    set_control_par(get_ui_id($panel_titleInfo),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
  end if
  call update_title_page
end on

on ui_control($switch_closeTitleInfo)
  set_control_par(get_ui_id($panel_titleInfo),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
  $cur_title_page := 0
end on

on ui_control($button_nextTitlePg)
  $cur_title_page := $cur_title_page+1
  if ($cur_title_page<0)
    $cur_title_page := 0
  end if
  if ($cur_title_page>(4-1))
    $cur_title_page := 4-1
  end if
  call update_title_page
end on

on ui_control($button_prevTitlePg)
  $cur_title_page := $cur_title_page+-1
  if ($cur_title_page<0)
    $cur_title_page := 0
  end if
  if ($cur_title_page>(4-1))
    $cur_title_page := 4-1
  end if
  call update_title_page
end on

on ui_control($button_generalInfo)
  $button_showMidi := 0
  call update_midi_visibility
  if (get_control_par(get_ui_id($switch_generalInfoDisp),$CONTROL_PAR_HIDE)=$HIDE_WHOLE_CONTROL)
    set_control_par(get_ui_id($switch_generalInfoDisp),$CONTROL_PAR_HIDE,$HIDE_PART_NOTHING)
  else
    set_control_par(get_ui_id($switch_generalInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
  end if
end on

on ui_control($switch_generalInfoDisp)
  set_control_par(get_ui_id($switch_generalInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
end on

on ui_control($button_articulationsInfo)
  set_control_par(get_ui_id($switch_articulationsInfoDisp),$CONTROL_PAR_HIDE,$HIDE_PART_NOTHING)
end on

on ui_control($switch_articulationsInfoDisp)
  set_control_par(get_ui_id($switch_articulationsInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
end on

on ui_control($button_optionsInfo)
  $button_showMidi := 0
  call update_midi_visibility
  if (get_control_par(get_ui_id($switch_optionsInfoDisp),$CONTROL_PAR_HIDE)=$HIDE_WHOLE_CONTROL)
    set_control_par(get_ui_id($switch_optionsInfoDisp),$CONTROL_PAR_HIDE,$HIDE_PART_NOTHING)
  else
    set_control_par(get_ui_id($switch_optionsInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
  end if
end on

on ui_control($switch_optionsInfoDisp)
  set_control_par(get_ui_id($switch_optionsInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
end on

on ui_control($button_speedInfo)
  set_control_par(get_ui_id($switch_speedInfoDisp),$CONTROL_PAR_HIDE,$HIDE_PART_NOTHING)
end on

on ui_control($switch_speedInfoDisp)
  set_control_par(get_ui_id($switch_speedInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
end on

on ui_control($button_directionInfo)
  set_control_par(get_ui_id($switch_directionInfoDisp),$CONTROL_PAR_HIDE,$HIDE_PART_NOTHING)
end on

on ui_control($switch_directionInfoDisp)
  set_control_par(get_ui_id($switch_directionInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
end on

on ui_control($button_legatoInfo)
  set_control_par(get_ui_id($switch_legatoInfoDisp),$CONTROL_PAR_HIDE,$HIDE_PART_NOTHING)
end on

on ui_control($switch_legatoInfoDisp)
  set_control_par(get_ui_id($switch_legatoInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
end on

on ui_control($button_releaseSamplesInfo)
  set_control_par(get_ui_id($switch_releaseSamplesInfoDisp),$CONTROL_PAR_HIDE,$HIDE_PART_NOTHING)
end on

on ui_control($switch_releaseSamplesInfoDisp)
  set_control_par(get_ui_id($switch_releaseSamplesInfoDisp),$CONTROL_PAR_HIDE,$HIDE_WHOLE_CONTROL)
end on

on ui_control($switch_prevMidiPg)
  call stop_all_clips_and_ripples
  $cur_midi_page := ($cur_midi_page+10+-1) mod 10
  call update_midi_clips
  call update_midi_visibility
  call update_midi_page_chooser_switches
end on

on ui_control($switch_nextMidiPg)
  call stop_all_clips_and_ripples
  $cur_midi_page := ($cur_midi_page+10+1) mod 10
  call update_midi_clips
  call update_midi_visibility
  call update_midi_page_chooser_switches
end on

on ui_control($slider_vol)
  %p[$sp-1] := $control__vol
  call update_engine_pars
  %p[$sp-1] := $control__vol
  call update_nks_label
  call set_keys_pressed
end on

on ui_control($menu_reverb)
  call set_reverb_menu_checkmark
  %p[$sp-1] := $control__reverb_type
  call update_engine_pars
end on

on ui_control($switch_reverbToggle)
  call update_reverb_slider_picture
  call update_reverb_send_levels
end on

on ui_control($slider_reverb)
  %p[$sp-1] := $control__reverb
  call update_engine_pars
  %p[$sp-1] := $control__reverb
  call update_nks_label
end on

on ui_control(?xypad_speed)
  if (?xypad_speed[0]=1.0)
    ?xypad_speed[0] := 0.999
  end if
  $val := real_to_int(?xypad_speed[0]*int_to_real(5))
  set_control_par(get_ui_id(?xypad_speed),$CONTROL_PAR_PICTURE_STATE,$val)
  $speed_nks := $val
  call set_speed
end on

on ui_control($speed_nks)
  ?xypad_speed[0] := int_to_real($speed_nks)/int_to_real(5)
  set_control_par(get_ui_id(?xypad_speed),$CONTROL_PAR_PICTURE_STATE,$speed_nks)
  $speed_nks := $speed_nks
  call set_speed
end on

on ui_control(?xypad_direction)
  if (?xypad_direction[0]=1.0)
    ?xypad_direction[0] := 0.999
  end if
  $val := real_to_int(?xypad_direction[0]*int_to_real(3))
  set_control_par(get_ui_id(?xypad_direction),$CONTROL_PAR_PICTURE_STATE,$val)
  $direction_nks := $val
  call set_direction
end on

on ui_control($direction_nks)
  ?xypad_direction[0] := int_to_real($direction_nks)/int_to_real(3)
  set_control_par(get_ui_id(?xypad_direction),$CONTROL_PAR_PICTURE_STATE,$direction_nks)
  $direction_nks := $direction_nks
  call set_direction
end on

on ui_control(?xypad_legato)
  if (?xypad_legato[0]=1.0)
    ?xypad_legato[0] := 0.999
  end if
  $val := real_to_int(?xypad_legato[0]*int_to_real(4))
  set_control_par(get_ui_id(?xypad_legato),$CONTROL_PAR_PICTURE_STATE,$val)
  $legato_nks := $val
  call set_legato
end on

on ui_control($legato_nks)
  ?xypad_legato[0] := int_to_real($legato_nks)/int_to_real(4)
  set_control_par(get_ui_id(?xypad_legato),$CONTROL_PAR_PICTURE_STATE,$legato_nks)
  $legato_nks := $legato_nks
  call set_legato
end on

on ui_control($switch_velToSampleStart)
  call set_keys_pressed
end on

on ui_control(?xypad_releaseSamples)
  if (?xypad_releaseSamples[0]=1.0)
    ?xypad_releaseSamples[0] := 0.999
  end if
  $val := real_to_int(?xypad_releaseSamples[0]*int_to_real(6))
  set_control_par(get_ui_id(?xypad_releaseSamples),$CONTROL_PAR_PICTURE_STATE,$val)
  $releaseSamples_nks := $val
  call set_releaseSamples
end on

on ui_control($releaseSamples_nks)
  ?xypad_releaseSamples[0] := int_to_real($releaseSamples_nks)/int_to_real(6)
  set_control_par(get_ui_id(?xypad_releaseSamples),$CONTROL_PAR_PICTURE_STATE,$releaseSamples_nks)
  $releaseSamples_nks := $releaseSamples_nks
  call set_releaseSamples
end on

on ui_control($switch_logoAnimTrigger)
  set_control_par(get_ui_id($label_version),$CONTROL_PAR_HIDE,$HIDE_PART_NOTHING)
  $timestamp_version_shown := $ENGINE_UPTIME
  if ($slider_logoAnim=0)
    $slider_logoAnim := 0
    while ($slider_logoAnim<127)
      inc($slider_logoAnim)
      wait(5000)
    end while
    $slider_logoAnim := 0
  end if
end on

on ui_control($switch_titlePgSelector0)
  $cur_title_page := 0
  call update_title_page
end on

on ui_control($switch_titlePgSelector1)
  $cur_title_page := 1
  call update_title_page
end on

on ui_control($switch_titlePgSelector2)
  $cur_title_page := 2
  call update_title_page
end on

on ui_control($switch_titlePgSelector3)
  $cur_title_page := 3
  call update_title_page
end on

on ui_control($switch_midiPgChooser0)
  $cur_midi_page := 0
  call update_midi_clips
  call update_midi_visibility
  call update_midi_page_chooser_switches
end on

on ui_control($switch_midiPgChooser1)
  $cur_midi_page := 1
  call update_midi_clips
  call update_midi_visibility
  call update_midi_page_chooser_switches
end on

on ui_control($switch_midiPgChooser2)
  $cur_midi_page := 2
  call update_midi_clips
  call update_midi_visibility
  call update_midi_page_chooser_switches
end on

on ui_control($switch_midiPgChooser3)
  $cur_midi_page := 3
  call update_midi_clips
  call update_midi_visibility
  call update_midi_page_chooser_switches
end on

on ui_control($switch_midiPgChooser4)
  $cur_midi_page := 4
  call update_midi_clips
  call update_midi_visibility
  call update_midi_page_chooser_switches
end on

on ui_control($switch_midiPgChooser5)
  $cur_midi_page := 5
  call update_midi_clips
  call update_midi_visibility
  call update_midi_page_chooser_switches
end on

on ui_control($switch_midiPgChooser6)
  $cur_midi_page := 6
  call update_midi_clips
  call update_midi_visibility
  call update_midi_page_chooser_switches
end on

on ui_control($switch_midiPgChooser7)
  $cur_midi_page := 7
  call update_midi_clips
  call update_midi_visibility
  call update_midi_page_chooser_switches
end on

on ui_control($switch_midiPgChooser8)
  $cur_midi_page := 8
  call update_midi_clips
  call update_midi_visibility
  call update_midi_page_chooser_switches
end on

on ui_control($switch_midiPgChooser9)
  $cur_midi_page := 9
  call update_midi_clips
  call update_midi_visibility
  call update_midi_page_chooser_switches
end on

on ui_control($switch_preview0)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[0] := $NI_CALLBACK_ID
  if (get_control_par(%switch_preview[0],$CONTROL_PAR_VALUE)=0)
    %playing[0] := 0
    %looping[0] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i := 0
    while ($_other_clip_i<num_elements(%switch_preview))
      if (0 # $_other_clip_i)
        set_control_par(%switch_preview[$_other_clip_i],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i]=1)
          %playing[$_other_clip_i] := 0
          %looping[$_other_clip_i] := 0
        end if
      end if
      inc($_other_clip_i)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    $_clip_index2 := $cur_midi_page*8+0
    %looping[0] := 1
    while (%looping[0]=1 and (%cb_id[0]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[0]=0)
        %looping[0] := 0
      end if
      if ($button_showMidi=0)
        %looping[0] := 0
      end if
      $_cur_event := 0
      %midi_file_pos_ticks[0] := 0
      %time_started[0] := $ENGINE_UPTIME
      call midi_clip_play_cursor
      %playing[0] := 1
      while (%playing[0]=1 and (%cb_id[0]=$NI_CALLBACK_ID))
        if ($_cur_event=%num_midi_events[$_clip_index2])
          $_ticks_until_next_event := %clip_length[$_clip_index2]-%midi_file_pos_ticks[0]
        else
          $_ticks_until_next_event := %_midi_pos[1000*$_clip_index2+$_cur_event]-%midi_file_pos_ticks[0]
        end if
        if ($_ticks_until_next_event>0)
          wait(ticks_to_ms($_ticks_until_next_event))
        end if
        if ($_cur_event>%num_midi_events[$_clip_index2])
          %playing[0] := 0
        end if
        if ($button_showMidi=0)
          %playing[0] := 0
        end if
        if (%playing[0]=1 and (%cb_id[0]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[0] := %midi_file_pos_ticks[0]+$_ticks_until_next_event
          if (%_midi_command[1000*$_clip_index2+$_cur_event]=$MIDI_COMMAND_NOTE_ON)
            $_note := %_midi_byte_1[1000*$_clip_index2+$_cur_event]
            $_velocity := %_midi_byte_2[1000*$_clip_index2+$_cur_event]
            $_length := ticks_to_ms(%_midi_length[1000*$_clip_index2+$_cur_event])
            $_note_id3 := play_note($_note,$_velocity,0,$_length)
            %custom_event_triggered_by_mf[$_note_id3 mod 1000000] := $_clip_index2+1
            %custom_event_active[$_note_id3 mod 1000000] := 1
            %custom_event_source[$_note_id3 mod 1000000] := -1
            set_event_par_arr($_note_id3,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note,1)
            %key_down[$_note] := 1
            %velo[$_note] := $_velocity
            $_ks_index := search(%articulation_keyswitches,$_note)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note)
            if ($_ks_index # -1)
              ?xypad_speed[0] := int_to_real($_ks_index)/int_to_real(5)
              set_control_par(get_ui_id(?xypad_speed),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
              $speed_nks := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note)
            if ($_ks_index # -1)
              ?xypad_direction[0] := int_to_real($_ks_index)/int_to_real(3)
              set_control_par(get_ui_id(?xypad_direction),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
              $direction_nks := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note)
            if ($_ks_index # -1)
              ?xypad_legato[0] := int_to_real($_ks_index)/int_to_real(4)
              set_control_par(get_ui_id(?xypad_legato),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
              $legato_nks := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note)
            if ($_ks_index # -1)
              ?xypad_releaseSamples[0] := int_to_real($_ks_index)/int_to_real(6)
              set_control_par(get_ui_id(?xypad_releaseSamples),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
              $releaseSamples_nks := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note] := 1
              %key_timestamp[$_note] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__UP or (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $_ripple_dir := $UP
                  else
                    $_ripple_dir := $DOWN
                  end if
                  $_origin_note3 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if (real_to_int(?xypad_legato[0]*int_to_real(4))=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                    $_ext_mode_real_legato_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    $_ext_mode_real_legato_time := $_real_legato_time
                    select (real_to_int(?xypad_legato[0]*int_to_real(4)))
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time4 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time4 := $_offset_rec_time4 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time4 := $_offset_rec_time4+$_vel_offset
                    $_offset_rec_time4 := $_offset_rec_time4 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note3 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$_ripple_dir) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time4<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    if ($switch_midiOutputMode=0)
                      $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time4,0)
                      if ($switch_velToSampleStart=0)
                        $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                        change_vol($_note_id2,$_volume,0)
                      end if
                      set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                      set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                      %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                      %custom_event_note[$_note_id2 mod 1000000] := $_note
                      %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                      %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                      %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note3
                      %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                      %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                      %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                      %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity
                      %custom_event_direction[$_note_id2 mod 1000000] := $_ripple_dir
                      %custom_event_source[$_note_id2 mod 1000000] := -1
                      %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id3 mod 1000000]
                      $r := 64-2
                      while ($r>=0)
                        %ripple_id_history[$r+1] := %ripple_id_history[$r]
                        dec($r)
                      end while
                      %ripple_id_history[0] := $_note_id2
                      $_fade_in_time := 0
                      if ($_do_legato=0)
                        $_fade_in_time := $menu_latency*1000
                        if ($_fade_in_time=0)
                          $_fade_in_time := 0
                        end if
                      else
                        $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                        $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                        if ($cur_artic=$artic__sixteenths)
                          if ($_real_pos_in_ripple<($_real_ripple_length/4))
                            $_real_pitch_length := $_real_ripple_length/4
                            $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                            $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                          else
                            $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                          end if
                        else
                          $_real_pitch_length := $_real_ripple_length/2
                          $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        end if
                        if (in_range($_velocity,1,48))
                          $_fade_in_time := $_time_til_end_of_ripple
                        else
                          if (in_range($_velocity,49,96))
                            $_fade_in_time := $_time_til_end_of_pitch
                          else
                            if (in_range($_velocity,97,127))
                              $_fade_in_time := $_time_til_end_of_pitch/2
                            end if
                          end if
                        end if
                        if ($_fade_in_time<ticks_to_ms(192))
                          $_fade_in_time := ticks_to_ms(192)
                        end if
                      end if
                      fade_in($_note_id2,$_fade_in_time)
                    else
                      $_ext_first_note := $_first_note
                      $_ext_second_note := $_second_note
                      $_ext_low_note := $_low_note2
                      $_ext_high_note := $_high_note2
                      $_ext_artic := $cur_artic
                      $_wait_time := $_ext_mode_real_legato_time
                      if ($_wait_time>0)
                        select (real_to_int(?xypad_legato[0]*int_to_real(4)))
                          case $legatoMode__syncToPitch
                            $_wait_time := $_real_pitch_length-($_wait_time mod $_real_pitch_length)
                          case $legatoMode__syncToRipple
                            if ($_wait_time mod $_real_ripple_length<=$_real_pitch_length)
                              $_note_chooser := 1
                            end if
                            $_wait_time := $_real_pitch_length-($_wait_time mod $_real_pitch_length)
                          case $legatoMode__syncToSwell
                            if ($_wait_time mod $_real_ripple_length<=$_real_pitch_length)
                              $_note_chooser := 1
                            end if
                            $_ext_pitch := $_wait_time/$_real_pitch_length
                            $_wait_time := $_real_pitch_length-($_wait_time mod $_real_pitch_length)
                        end select
                      end if
                      $_low_vel := %velo[$_note]-35
                      $_high_vel := $_low_vel+35
                      if ($_high_vel>127)
                        $_high_vel := 127
                      end if
                      if ($_low_vel<1)
                        $_low_vel := 1
                      end if
                      if ($_wait_time>0)
                        wait($_wait_time)
                      end if
                      while (%key_active[$_note]=1)
                        if ($_note_chooser=0)
                          $_ext_note := $_ext_first_note
                        else
                          $_ext_note := $_ext_second_note
                        end if
                        ~_vel_norm := int_to_real($slider_vol)/1000000.0*(int_to_real(%velo[$_note])/127.0)
                        $_vel3 := real_to_int(~_vel_norm*int_to_real(127-60))+30
                        if (in_range($_ext_pitch,0,7))
                          $_vel3 := real_to_int(int_to_real($_vel3-30)+((int_to_real($_ext_pitch)-int_to_real(0))/(int_to_real(7)-int_to_real(0))*(int_to_real($_vel3+30)-int_to_real($_vel3-30))))
                        else
                          $_vel3 := real_to_int(int_to_real($_vel3+30)+((int_to_real($_ext_pitch)-int_to_real(8))/(int_to_real(15)-int_to_real(8))*(int_to_real($_vel3-30)-int_to_real($_vel3+30))))
                        end if
                        if ($_note_chooser=1)
                          $_vel3 := $_vel3-20
                        end if
                        if ($_vel3<1)
                          $_vel3 := 1
                        end if
                        if ($_vel3>127)
                          $_vel3 := 127
                        end if
                        if ($_ext_artic=$artic__sixteenths)
                          if ($_note_chooser=0)
                            $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                          else
                            $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                          end if
                        else
                          $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                        end if
                        $_note_id2 := play_note($_ext_note,$_vel3,0,$_len)
                        if ($_ext_artic=$artic__sixteenths)
                          if ($_note_chooser=0)
                            $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                          else
                            $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                          end if
                        else
                          $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                        end if
                        $_wait_time := real_to_int(int_to_real($_wait_time)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
                        if ($_wait_time>0)
                          wait($_wait_time)
                        end if
                        $_ext_pitch := ($_ext_pitch+1) mod 16
                        $_note_chooser := 1-$_note_chooser
                      end while
                      if ($_note_chooser=0)
                        $_ext_note := $_ext_first_note
                      else
                        $_ext_note := $_ext_second_note
                      end if
                      ~_vel_norm := int_to_real($slider_vol)/1000000.0*(int_to_real(%velo[$_note])/127.0)
                      $_vel3 := real_to_int(~_vel_norm*int_to_real(127-60))+30
                      if (in_range($_ext_pitch,0,7))
                        $_vel3 := real_to_int(int_to_real($_vel3-30)+((int_to_real($_ext_pitch)-int_to_real(0))/(int_to_real(7)-int_to_real(0))*(int_to_real($_vel3+30)-int_to_real($_vel3-30))))
                      else
                        $_vel3 := real_to_int(int_to_real($_vel3+30)+((int_to_real($_ext_pitch)-int_to_real(8))/(int_to_real(15)-int_to_real(8))*(int_to_real($_vel3-30)-int_to_real($_vel3+30))))
                      end if
                      if ($_note_chooser=1)
                        $_vel3 := $_vel3-20
                      end if
                      if ($_vel3<1)
                        $_vel3 := 1
                      end if
                      if ($_vel3>127)
                        $_vel3 := 127
                      end if
                      if ($_ext_artic=$artic__sixteenths)
                        if ($_note_chooser=0)
                          $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                        else
                          $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                        end if
                      else
                        $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                      end if
                      $_note_id2 := play_note($_ext_note,$_vel3,0,$_len)
                      if ($_ext_artic=$artic__sixteenths)
                        if ($_note_chooser=0)
                          $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                        else
                          $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                        end if
                      else
                        $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                      end if
                      $_wait_time := real_to_int(int_to_real($_wait_time)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
                      if ($_wait_time>0)
                        wait($_wait_time)
                      end if
                      $_ext_pitch := ($_ext_pitch+1) mod 16
                      $_note_chooser := 1-$_note_chooser
                      if ($_note_chooser=0)
                        if ($_note_chooser=0)
                          $_ext_note := $_ext_first_note
                        else
                          $_ext_note := $_ext_second_note
                        end if
                        ~_vel_norm := int_to_real($slider_vol)/1000000.0*(int_to_real(%velo[$_note])/127.0)
                        $_vel3 := real_to_int(~_vel_norm*int_to_real(127-60))+30
                        if (in_range($_ext_pitch,0,7))
                          $_vel3 := real_to_int(int_to_real($_vel3-30)+((int_to_real($_ext_pitch)-int_to_real(0))/(int_to_real(7)-int_to_real(0))*(int_to_real($_vel3+30)-int_to_real($_vel3-30))))
                        else
                          $_vel3 := real_to_int(int_to_real($_vel3+30)+((int_to_real($_ext_pitch)-int_to_real(8))/(int_to_real(15)-int_to_real(8))*(int_to_real($_vel3-30)-int_to_real($_vel3+30))))
                        end if
                        if ($_note_chooser=1)
                          $_vel3 := $_vel3-20
                        end if
                        if ($_vel3<1)
                          $_vel3 := 1
                        end if
                        if ($_vel3>127)
                          $_vel3 := 127
                        end if
                        if ($_ext_artic=$artic__sixteenths)
                          if ($_note_chooser=0)
                            $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                          else
                            $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                          end if
                        else
                          $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                        end if
                        $_note_id2 := play_note($_ext_note,$_vel3,0,$_len)
                        if ($_ext_artic=$artic__sixteenths)
                          if ($_note_chooser=0)
                            $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                          else
                            $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                          end if
                        else
                          $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                        end if
                        $_wait_time := real_to_int(int_to_real($_wait_time)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
                        if ($_wait_time>0)
                          wait($_wait_time)
                        end if
                        $_ext_pitch := ($_ext_pitch+1) mod 16
                        $_note_chooser := 1-$_note_chooser
                      end if
                    end if
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*$_clip_index2+$_cur_event]=$MIDI_COMMAND_CC)
            $_cc_num := %_midi_byte_1[1000*$_clip_index2+$_cur_event]
            set_controller($_cc_num,%_midi_byte_2[1000*$_clip_index2+$_cur_event])
            wait(1)
            if ($_cc_num=64)
              if (%CC[$_cc_num]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num]
            end if
          end if
          inc($_cur_event)
        end if
        if ($_cur_event>%num_midi_events[$_clip_index2])
          %playing[0] := 0
        end if
        if ($button_showMidi=0)
          %playing[0] := 0
        end if
      end while
    end while
    if (%cb_id[0]=$NI_CALLBACK_ID)
      set_control_par(%switch_preview[0],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control($switch_preview1)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[1] := $NI_CALLBACK_ID
  if (get_control_par(%switch_preview[1],$CONTROL_PAR_VALUE)=0)
    %playing[1] := 0
    %looping[1] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i2 := 0
    while ($_other_clip_i2<num_elements(%switch_preview))
      if (1 # $_other_clip_i2)
        set_control_par(%switch_preview[$_other_clip_i2],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i2]=1)
          %playing[$_other_clip_i2] := 0
          %looping[$_other_clip_i2] := 0
        end if
      end if
      inc($_other_clip_i2)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    $_clip_index3 := $cur_midi_page*8+1
    %looping[1] := 1
    while (%looping[1]=1 and (%cb_id[1]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[1]=0)
        %looping[1] := 0
      end if
      if ($button_showMidi=0)
        %looping[1] := 0
      end if
      $_cur_event2 := 0
      %midi_file_pos_ticks[1] := 0
      %time_started[1] := $ENGINE_UPTIME
      call midi_clip_play_cursor
      %playing[1] := 1
      while (%playing[1]=1 and (%cb_id[1]=$NI_CALLBACK_ID))
        if ($_cur_event2=%num_midi_events[$_clip_index3])
          $_ticks_until_next_event2 := %clip_length[$_clip_index3]-%midi_file_pos_ticks[1]
        else
          $_ticks_until_next_event2 := %_midi_pos[1000*$_clip_index3+$_cur_event2]-%midi_file_pos_ticks[1]
        end if
        if ($_ticks_until_next_event2>0)
          wait(ticks_to_ms($_ticks_until_next_event2))
        end if
        if ($_cur_event2>%num_midi_events[$_clip_index3])
          %playing[1] := 0
        end if
        if ($button_showMidi=0)
          %playing[1] := 0
        end if
        if (%playing[1]=1 and (%cb_id[1]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[1] := %midi_file_pos_ticks[1]+$_ticks_until_next_event2
          if (%_midi_command[1000*$_clip_index3+$_cur_event2]=$MIDI_COMMAND_NOTE_ON)
            $_note2 := %_midi_byte_1[1000*$_clip_index3+$_cur_event2]
            $_velocity2 := %_midi_byte_2[1000*$_clip_index3+$_cur_event2]
            $_length2 := ticks_to_ms(%_midi_length[1000*$_clip_index3+$_cur_event2])
            $_note_id4 := play_note($_note2,$_velocity2,0,$_length2)
            %custom_event_triggered_by_mf[$_note_id4 mod 1000000] := $_clip_index3+1
            %custom_event_active[$_note_id4 mod 1000000] := 1
            %custom_event_source[$_note_id4 mod 1000000] := -1
            set_event_par_arr($_note_id4,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note2,1)
            %key_down[$_note2] := 1
            %velo[$_note2] := $_velocity2
            $_ks_index := search(%articulation_keyswitches,$_note2)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note2)
            if ($_ks_index # -1)
              ?xypad_speed[0] := int_to_real($_ks_index)/int_to_real(5)
              set_control_par(get_ui_id(?xypad_speed),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
              $speed_nks := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note2)
            if ($_ks_index # -1)
              ?xypad_direction[0] := int_to_real($_ks_index)/int_to_real(3)
              set_control_par(get_ui_id(?xypad_direction),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
              $direction_nks := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note2)
            if ($_ks_index # -1)
              ?xypad_legato[0] := int_to_real($_ks_index)/int_to_real(4)
              set_control_par(get_ui_id(?xypad_legato),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
              $legato_nks := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note2)
            if ($_ks_index # -1)
              ?xypad_releaseSamples[0] := int_to_real($_ks_index)/int_to_real(6)
              set_control_par(get_ui_id(?xypad_releaseSamples),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
              $releaseSamples_nks := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note2)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note2)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note2
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note2) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note2,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note2] := 1
              %key_timestamp[$_note2] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note2],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note2
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note2+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note2)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note2)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__UP or (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note2-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note2-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note2-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note2-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note2-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $_ripple_dir := $UP
                  else
                    $_ripple_dir := $DOWN
                  end if
                  $_origin_note3 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if (real_to_int(?xypad_legato[0]*int_to_real(4))=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                    $_ext_mode_real_legato_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    $_ext_mode_real_legato_time := $_real_legato_time
                    select (real_to_int(?xypad_legato[0]*int_to_real(4)))
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time4 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time4 := $_offset_rec_time4 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time4 := $_offset_rec_time4+$_vel_offset
                    $_offset_rec_time4 := $_offset_rec_time4 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note3 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$_ripple_dir) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time4<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    if ($switch_midiOutputMode=0)
                      $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time4,0)
                      if ($switch_velToSampleStart=0)
                        $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity2)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                        change_vol($_note_id2,$_volume,0)
                      end if
                      set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                      set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                      %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                      %custom_event_note[$_note_id2 mod 1000000] := $_note2
                      %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                      %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                      %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note3
                      %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                      %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                      %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                      %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity2
                      %custom_event_direction[$_note_id2 mod 1000000] := $_ripple_dir
                      %custom_event_source[$_note_id2 mod 1000000] := -1
                      %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id4 mod 1000000]
                      $r := 64-2
                      while ($r>=0)
                        %ripple_id_history[$r+1] := %ripple_id_history[$r]
                        dec($r)
                      end while
                      %ripple_id_history[0] := $_note_id2
                      $_fade_in_time := 0
                      if ($_do_legato=0)
                        $_fade_in_time := $menu_latency*1000
                        if ($_fade_in_time=0)
                          $_fade_in_time := 0
                        end if
                      else
                        $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                        $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                        if ($cur_artic=$artic__sixteenths)
                          if ($_real_pos_in_ripple<($_real_ripple_length/4))
                            $_real_pitch_length := $_real_ripple_length/4
                            $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                            $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                          else
                            $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                          end if
                        else
                          $_real_pitch_length := $_real_ripple_length/2
                          $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        end if
                        if (in_range($_velocity2,1,48))
                          $_fade_in_time := $_time_til_end_of_ripple
                        else
                          if (in_range($_velocity2,49,96))
                            $_fade_in_time := $_time_til_end_of_pitch
                          else
                            if (in_range($_velocity2,97,127))
                              $_fade_in_time := $_time_til_end_of_pitch/2
                            end if
                          end if
                        end if
                        if ($_fade_in_time<ticks_to_ms(192))
                          $_fade_in_time := ticks_to_ms(192)
                        end if
                      end if
                      fade_in($_note_id2,$_fade_in_time)
                    else
                      $_ext_first_note := $_first_note
                      $_ext_second_note := $_second_note
                      $_ext_low_note := $_low_note2
                      $_ext_high_note := $_high_note2
                      $_ext_artic := $cur_artic
                      $_wait_time := $_ext_mode_real_legato_time
                      if ($_wait_time>0)
                        select (real_to_int(?xypad_legato[0]*int_to_real(4)))
                          case $legatoMode__syncToPitch
                            $_wait_time := $_real_pitch_length-($_wait_time mod $_real_pitch_length)
                          case $legatoMode__syncToRipple
                            if ($_wait_time mod $_real_ripple_length<=$_real_pitch_length)
                              $_note_chooser := 1
                            end if
                            $_wait_time := $_real_pitch_length-($_wait_time mod $_real_pitch_length)
                          case $legatoMode__syncToSwell
                            if ($_wait_time mod $_real_ripple_length<=$_real_pitch_length)
                              $_note_chooser := 1
                            end if
                            $_ext_pitch := $_wait_time/$_real_pitch_length
                            $_wait_time := $_real_pitch_length-($_wait_time mod $_real_pitch_length)
                        end select
                      end if
                      $_low_vel := %velo[$_note2]-35
                      $_high_vel := $_low_vel+35
                      if ($_high_vel>127)
                        $_high_vel := 127
                      end if
                      if ($_low_vel<1)
                        $_low_vel := 1
                      end if
                      if ($_wait_time>0)
                        wait($_wait_time)
                      end if
                      while (%key_active[$_note2]=1)
                        if ($_note_chooser=0)
                          $_ext_note := $_ext_first_note
                        else
                          $_ext_note := $_ext_second_note
                        end if
                        ~_vel_norm := int_to_real($slider_vol)/1000000.0*(int_to_real(%velo[$_note2])/127.0)
                        $_vel3 := real_to_int(~_vel_norm*int_to_real(127-60))+30
                        if (in_range($_ext_pitch,0,7))
                          $_vel3 := real_to_int(int_to_real($_vel3-30)+((int_to_real($_ext_pitch)-int_to_real(0))/(int_to_real(7)-int_to_real(0))*(int_to_real($_vel3+30)-int_to_real($_vel3-30))))
                        else
                          $_vel3 := real_to_int(int_to_real($_vel3+30)+((int_to_real($_ext_pitch)-int_to_real(8))/(int_to_real(15)-int_to_real(8))*(int_to_real($_vel3-30)-int_to_real($_vel3+30))))
                        end if
                        if ($_note_chooser=1)
                          $_vel3 := $_vel3-20
                        end if
                        if ($_vel3<1)
                          $_vel3 := 1
                        end if
                        if ($_vel3>127)
                          $_vel3 := 127
                        end if
                        if ($_ext_artic=$artic__sixteenths)
                          if ($_note_chooser=0)
                            $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                          else
                            $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                          end if
                        else
                          $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                        end if
                        $_note_id2 := play_note($_ext_note,$_vel3,0,$_len)
                        if ($_ext_artic=$artic__sixteenths)
                          if ($_note_chooser=0)
                            $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                          else
                            $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                          end if
                        else
                          $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                        end if
                        $_wait_time := real_to_int(int_to_real($_wait_time)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
                        if ($_wait_time>0)
                          wait($_wait_time)
                        end if
                        $_ext_pitch := ($_ext_pitch+1) mod 16
                        $_note_chooser := 1-$_note_chooser
                      end while
                      if ($_note_chooser=0)
                        $_ext_note := $_ext_first_note
                      else
                        $_ext_note := $_ext_second_note
                      end if
                      ~_vel_norm := int_to_real($slider_vol)/1000000.0*(int_to_real(%velo[$_note2])/127.0)
                      $_vel3 := real_to_int(~_vel_norm*int_to_real(127-60))+30
                      if (in_range($_ext_pitch,0,7))
                        $_vel3 := real_to_int(int_to_real($_vel3-30)+((int_to_real($_ext_pitch)-int_to_real(0))/(int_to_real(7)-int_to_real(0))*(int_to_real($_vel3+30)-int_to_real($_vel3-30))))
                      else
                        $_vel3 := real_to_int(int_to_real($_vel3+30)+((int_to_real($_ext_pitch)-int_to_real(8))/(int_to_real(15)-int_to_real(8))*(int_to_real($_vel3-30)-int_to_real($_vel3+30))))
                      end if
                      if ($_note_chooser=1)
                        $_vel3 := $_vel3-20
                      end if
                      if ($_vel3<1)
                        $_vel3 := 1
                      end if
                      if ($_vel3>127)
                        $_vel3 := 127
                      end if
                      if ($_ext_artic=$artic__sixteenths)
                        if ($_note_chooser=0)
                          $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                        else
                          $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                        end if
                      else
                        $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                      end if
                      $_note_id2 := play_note($_ext_note,$_vel3,0,$_len)
                      if ($_ext_artic=$artic__sixteenths)
                        if ($_note_chooser=0)
                          $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                        else
                          $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                        end if
                      else
                        $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                      end if
                      $_wait_time := real_to_int(int_to_real($_wait_time)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
                      if ($_wait_time>0)
                        wait($_wait_time)
                      end if
                      $_ext_pitch := ($_ext_pitch+1) mod 16
                      $_note_chooser := 1-$_note_chooser
                      if ($_note_chooser=0)
                        if ($_note_chooser=0)
                          $_ext_note := $_ext_first_note
                        else
                          $_ext_note := $_ext_second_note
                        end if
                        ~_vel_norm := int_to_real($slider_vol)/1000000.0*(int_to_real(%velo[$_note2])/127.0)
                        $_vel3 := real_to_int(~_vel_norm*int_to_real(127-60))+30
                        if (in_range($_ext_pitch,0,7))
                          $_vel3 := real_to_int(int_to_real($_vel3-30)+((int_to_real($_ext_pitch)-int_to_real(0))/(int_to_real(7)-int_to_real(0))*(int_to_real($_vel3+30)-int_to_real($_vel3-30))))
                        else
                          $_vel3 := real_to_int(int_to_real($_vel3+30)+((int_to_real($_ext_pitch)-int_to_real(8))/(int_to_real(15)-int_to_real(8))*(int_to_real($_vel3-30)-int_to_real($_vel3+30))))
                        end if
                        if ($_note_chooser=1)
                          $_vel3 := $_vel3-20
                        end if
                        if ($_vel3<1)
                          $_vel3 := 1
                        end if
                        if ($_vel3>127)
                          $_vel3 := 127
                        end if
                        if ($_ext_artic=$artic__sixteenths)
                          if ($_note_chooser=0)
                            $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                          else
                            $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                          end if
                        else
                          $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                        end if
                        $_note_id2 := play_note($_ext_note,$_vel3,0,$_len)
                        if ($_ext_artic=$artic__sixteenths)
                          if ($_note_chooser=0)
                            $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                          else
                            $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                          end if
                        else
                          $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                        end if
                        $_wait_time := real_to_int(int_to_real($_wait_time)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
                        if ($_wait_time>0)
                          wait($_wait_time)
                        end if
                        $_ext_pitch := ($_ext_pitch+1) mod 16
                        $_note_chooser := 1-$_note_chooser
                      end if
                    end if
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*$_clip_index3+$_cur_event2]=$MIDI_COMMAND_CC)
            $_cc_num2 := %_midi_byte_1[1000*$_clip_index3+$_cur_event2]
            set_controller($_cc_num2,%_midi_byte_2[1000*$_clip_index3+$_cur_event2])
            wait(1)
            if ($_cc_num2=64)
              if (%CC[$_cc_num2]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num2]
            end if
          end if
          inc($_cur_event2)
        end if
        if ($_cur_event2>%num_midi_events[$_clip_index3])
          %playing[1] := 0
        end if
        if ($button_showMidi=0)
          %playing[1] := 0
        end if
      end while
    end while
    if (%cb_id[1]=$NI_CALLBACK_ID)
      set_control_par(%switch_preview[1],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control($switch_preview2)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[2] := $NI_CALLBACK_ID
  if (get_control_par(%switch_preview[2],$CONTROL_PAR_VALUE)=0)
    %playing[2] := 0
    %looping[2] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i3 := 0
    while ($_other_clip_i3<num_elements(%switch_preview))
      if (2 # $_other_clip_i3)
        set_control_par(%switch_preview[$_other_clip_i3],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i3]=1)
          %playing[$_other_clip_i3] := 0
          %looping[$_other_clip_i3] := 0
        end if
      end if
      inc($_other_clip_i3)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    $_clip_index4 := $cur_midi_page*8+2
    %looping[2] := 1
    while (%looping[2]=1 and (%cb_id[2]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[2]=0)
        %looping[2] := 0
      end if
      if ($button_showMidi=0)
        %looping[2] := 0
      end if
      $_cur_event3 := 0
      %midi_file_pos_ticks[2] := 0
      %time_started[2] := $ENGINE_UPTIME
      call midi_clip_play_cursor
      %playing[2] := 1
      while (%playing[2]=1 and (%cb_id[2]=$NI_CALLBACK_ID))
        if ($_cur_event3=%num_midi_events[$_clip_index4])
          $_ticks_until_next_event3 := %clip_length[$_clip_index4]-%midi_file_pos_ticks[2]
        else
          $_ticks_until_next_event3 := %_midi_pos[1000*$_clip_index4+$_cur_event3]-%midi_file_pos_ticks[2]
        end if
        if ($_ticks_until_next_event3>0)
          wait(ticks_to_ms($_ticks_until_next_event3))
        end if
        if ($_cur_event3>%num_midi_events[$_clip_index4])
          %playing[2] := 0
        end if
        if ($button_showMidi=0)
          %playing[2] := 0
        end if
        if (%playing[2]=1 and (%cb_id[2]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[2] := %midi_file_pos_ticks[2]+$_ticks_until_next_event3
          if (%_midi_command[1000*$_clip_index4+$_cur_event3]=$MIDI_COMMAND_NOTE_ON)
            $_note3 := %_midi_byte_1[1000*$_clip_index4+$_cur_event3]
            $_velocity3 := %_midi_byte_2[1000*$_clip_index4+$_cur_event3]
            $_length3 := ticks_to_ms(%_midi_length[1000*$_clip_index4+$_cur_event3])
            $_note_id5 := play_note($_note3,$_velocity3,0,$_length3)
            %custom_event_triggered_by_mf[$_note_id5 mod 1000000] := $_clip_index4+1
            %custom_event_active[$_note_id5 mod 1000000] := 1
            %custom_event_source[$_note_id5 mod 1000000] := -1
            set_event_par_arr($_note_id5,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note3,1)
            %key_down[$_note3] := 1
            %velo[$_note3] := $_velocity3
            $_ks_index := search(%articulation_keyswitches,$_note3)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note3)
            if ($_ks_index # -1)
              ?xypad_speed[0] := int_to_real($_ks_index)/int_to_real(5)
              set_control_par(get_ui_id(?xypad_speed),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
              $speed_nks := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note3)
            if ($_ks_index # -1)
              ?xypad_direction[0] := int_to_real($_ks_index)/int_to_real(3)
              set_control_par(get_ui_id(?xypad_direction),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
              $direction_nks := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note3)
            if ($_ks_index # -1)
              ?xypad_legato[0] := int_to_real($_ks_index)/int_to_real(4)
              set_control_par(get_ui_id(?xypad_legato),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
              $legato_nks := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note3)
            if ($_ks_index # -1)
              ?xypad_releaseSamples[0] := int_to_real($_ks_index)/int_to_real(6)
              set_control_par(get_ui_id(?xypad_releaseSamples),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
              $releaseSamples_nks := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note3)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note3)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note3
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note3) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note3,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note3] := 1
              %key_timestamp[$_note3] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note3],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note3
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note3+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note3)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note3)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__UP or (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note3-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note3-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note3-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note3-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note3-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $_ripple_dir := $UP
                  else
                    $_ripple_dir := $DOWN
                  end if
                  $_origin_note3 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if (real_to_int(?xypad_legato[0]*int_to_real(4))=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                    $_ext_mode_real_legato_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    $_ext_mode_real_legato_time := $_real_legato_time
                    select (real_to_int(?xypad_legato[0]*int_to_real(4)))
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time4 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time4 := $_offset_rec_time4 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time4 := $_offset_rec_time4+$_vel_offset
                    $_offset_rec_time4 := $_offset_rec_time4 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note3 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$_ripple_dir) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time4<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    if ($switch_midiOutputMode=0)
                      $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time4,0)
                      if ($switch_velToSampleStart=0)
                        $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity3)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                        change_vol($_note_id2,$_volume,0)
                      end if
                      set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                      set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                      %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                      %custom_event_note[$_note_id2 mod 1000000] := $_note3
                      %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                      %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                      %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note3
                      %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                      %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                      %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                      %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity3
                      %custom_event_direction[$_note_id2 mod 1000000] := $_ripple_dir
                      %custom_event_source[$_note_id2 mod 1000000] := -1
                      %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id5 mod 1000000]
                      $r := 64-2
                      while ($r>=0)
                        %ripple_id_history[$r+1] := %ripple_id_history[$r]
                        dec($r)
                      end while
                      %ripple_id_history[0] := $_note_id2
                      $_fade_in_time := 0
                      if ($_do_legato=0)
                        $_fade_in_time := $menu_latency*1000
                        if ($_fade_in_time=0)
                          $_fade_in_time := 0
                        end if
                      else
                        $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                        $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                        if ($cur_artic=$artic__sixteenths)
                          if ($_real_pos_in_ripple<($_real_ripple_length/4))
                            $_real_pitch_length := $_real_ripple_length/4
                            $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                            $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                          else
                            $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                          end if
                        else
                          $_real_pitch_length := $_real_ripple_length/2
                          $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        end if
                        if (in_range($_velocity3,1,48))
                          $_fade_in_time := $_time_til_end_of_ripple
                        else
                          if (in_range($_velocity3,49,96))
                            $_fade_in_time := $_time_til_end_of_pitch
                          else
                            if (in_range($_velocity3,97,127))
                              $_fade_in_time := $_time_til_end_of_pitch/2
                            end if
                          end if
                        end if
                        if ($_fade_in_time<ticks_to_ms(192))
                          $_fade_in_time := ticks_to_ms(192)
                        end if
                      end if
                      fade_in($_note_id2,$_fade_in_time)
                    else
                      $_ext_first_note := $_first_note
                      $_ext_second_note := $_second_note
                      $_ext_low_note := $_low_note2
                      $_ext_high_note := $_high_note2
                      $_ext_artic := $cur_artic
                      $_wait_time := $_ext_mode_real_legato_time
                      if ($_wait_time>0)
                        select (real_to_int(?xypad_legato[0]*int_to_real(4)))
                          case $legatoMode__syncToPitch
                            $_wait_time := $_real_pitch_length-($_wait_time mod $_real_pitch_length)
                          case $legatoMode__syncToRipple
                            if ($_wait_time mod $_real_ripple_length<=$_real_pitch_length)
                              $_note_chooser := 1
                            end if
                            $_wait_time := $_real_pitch_length-($_wait_time mod $_real_pitch_length)
                          case $legatoMode__syncToSwell
                            if ($_wait_time mod $_real_ripple_length<=$_real_pitch_length)
                              $_note_chooser := 1
                            end if
                            $_ext_pitch := $_wait_time/$_real_pitch_length
                            $_wait_time := $_real_pitch_length-($_wait_time mod $_real_pitch_length)
                        end select
                      end if
                      $_low_vel := %velo[$_note3]-35
                      $_high_vel := $_low_vel+35
                      if ($_high_vel>127)
                        $_high_vel := 127
                      end if
                      if ($_low_vel<1)
                        $_low_vel := 1
                      end if
                      if ($_wait_time>0)
                        wait($_wait_time)
                      end if
                      while (%key_active[$_note3]=1)
                        if ($_note_chooser=0)
                          $_ext_note := $_ext_first_note
                        else
                          $_ext_note := $_ext_second_note
                        end if
                        ~_vel_norm := int_to_real($slider_vol)/1000000.0*(int_to_real(%velo[$_note3])/127.0)
                        $_vel3 := real_to_int(~_vel_norm*int_to_real(127-60))+30
                        if (in_range($_ext_pitch,0,7))
                          $_vel3 := real_to_int(int_to_real($_vel3-30)+((int_to_real($_ext_pitch)-int_to_real(0))/(int_to_real(7)-int_to_real(0))*(int_to_real($_vel3+30)-int_to_real($_vel3-30))))
                        else
                          $_vel3 := real_to_int(int_to_real($_vel3+30)+((int_to_real($_ext_pitch)-int_to_real(8))/(int_to_real(15)-int_to_real(8))*(int_to_real($_vel3-30)-int_to_real($_vel3+30))))
                        end if
                        if ($_note_chooser=1)
                          $_vel3 := $_vel3-20
                        end if
                        if ($_vel3<1)
                          $_vel3 := 1
                        end if
                        if ($_vel3>127)
                          $_vel3 := 127
                        end if
                        if ($_ext_artic=$artic__sixteenths)
                          if ($_note_chooser=0)
                            $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                          else
                            $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                          end if
                        else
                          $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                        end if
                        $_note_id2 := play_note($_ext_note,$_vel3,0,$_len)
                        if ($_ext_artic=$artic__sixteenths)
                          if ($_note_chooser=0)
                            $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                          else
                            $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                          end if
                        else
                          $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                        end if
                        $_wait_time := real_to_int(int_to_real($_wait_time)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
                        if ($_wait_time>0)
                          wait($_wait_time)
                        end if
                        $_ext_pitch := ($_ext_pitch+1) mod 16
                        $_note_chooser := 1-$_note_chooser
                      end while
                      if ($_note_chooser=0)
                        $_ext_note := $_ext_first_note
                      else
                        $_ext_note := $_ext_second_note
                      end if
                      ~_vel_norm := int_to_real($slider_vol)/1000000.0*(int_to_real(%velo[$_note3])/127.0)
                      $_vel3 := real_to_int(~_vel_norm*int_to_real(127-60))+30
                      if (in_range($_ext_pitch,0,7))
                        $_vel3 := real_to_int(int_to_real($_vel3-30)+((int_to_real($_ext_pitch)-int_to_real(0))/(int_to_real(7)-int_to_real(0))*(int_to_real($_vel3+30)-int_to_real($_vel3-30))))
                      else
                        $_vel3 := real_to_int(int_to_real($_vel3+30)+((int_to_real($_ext_pitch)-int_to_real(8))/(int_to_real(15)-int_to_real(8))*(int_to_real($_vel3-30)-int_to_real($_vel3+30))))
                      end if
                      if ($_note_chooser=1)
                        $_vel3 := $_vel3-20
                      end if
                      if ($_vel3<1)
                        $_vel3 := 1
                      end if
                      if ($_vel3>127)
                        $_vel3 := 127
                      end if
                      if ($_ext_artic=$artic__sixteenths)
                        if ($_note_chooser=0)
                          $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                        else
                          $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                        end if
                      else
                        $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                      end if
                      $_note_id2 := play_note($_ext_note,$_vel3,0,$_len)
                      if ($_ext_artic=$artic__sixteenths)
                        if ($_note_chooser=0)
                          $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                        else
                          $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                        end if
                      else
                        $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                      end if
                      $_wait_time := real_to_int(int_to_real($_wait_time)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
                      if ($_wait_time>0)
                        wait($_wait_time)
                      end if
                      $_ext_pitch := ($_ext_pitch+1) mod 16
                      $_note_chooser := 1-$_note_chooser
                      if ($_note_chooser=0)
                        if ($_note_chooser=0)
                          $_ext_note := $_ext_first_note
                        else
                          $_ext_note := $_ext_second_note
                        end if
                        ~_vel_norm := int_to_real($slider_vol)/1000000.0*(int_to_real(%velo[$_note3])/127.0)
                        $_vel3 := real_to_int(~_vel_norm*int_to_real(127-60))+30
                        if (in_range($_ext_pitch,0,7))
                          $_vel3 := real_to_int(int_to_real($_vel3-30)+((int_to_real($_ext_pitch)-int_to_real(0))/(int_to_real(7)-int_to_real(0))*(int_to_real($_vel3+30)-int_to_real($_vel3-30))))
                        else
                          $_vel3 := real_to_int(int_to_real($_vel3+30)+((int_to_real($_ext_pitch)-int_to_real(8))/(int_to_real(15)-int_to_real(8))*(int_to_real($_vel3-30)-int_to_real($_vel3+30))))
                        end if
                        if ($_note_chooser=1)
                          $_vel3 := $_vel3-20
                        end if
                        if ($_vel3<1)
                          $_vel3 := 1
                        end if
                        if ($_vel3>127)
                          $_vel3 := 127
                        end if
                        if ($_ext_artic=$artic__sixteenths)
                          if ($_note_chooser=0)
                            $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                          else
                            $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                          end if
                        else
                          $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                        end if
                        $_note_id2 := play_note($_ext_note,$_vel3,0,$_len)
                        if ($_ext_artic=$artic__sixteenths)
                          if ($_note_chooser=0)
                            $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                          else
                            $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                          end if
                        else
                          $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                        end if
                        $_wait_time := real_to_int(int_to_real($_wait_time)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
                        if ($_wait_time>0)
                          wait($_wait_time)
                        end if
                        $_ext_pitch := ($_ext_pitch+1) mod 16
                        $_note_chooser := 1-$_note_chooser
                      end if
                    end if
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*$_clip_index4+$_cur_event3]=$MIDI_COMMAND_CC)
            $_cc_num3 := %_midi_byte_1[1000*$_clip_index4+$_cur_event3]
            set_controller($_cc_num3,%_midi_byte_2[1000*$_clip_index4+$_cur_event3])
            wait(1)
            if ($_cc_num3=64)
              if (%CC[$_cc_num3]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num3]
            end if
          end if
          inc($_cur_event3)
        end if
        if ($_cur_event3>%num_midi_events[$_clip_index4])
          %playing[2] := 0
        end if
        if ($button_showMidi=0)
          %playing[2] := 0
        end if
      end while
    end while
    if (%cb_id[2]=$NI_CALLBACK_ID)
      set_control_par(%switch_preview[2],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control($switch_preview3)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[3] := $NI_CALLBACK_ID
  if (get_control_par(%switch_preview[3],$CONTROL_PAR_VALUE)=0)
    %playing[3] := 0
    %looping[3] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i4 := 0
    while ($_other_clip_i4<num_elements(%switch_preview))
      if (3 # $_other_clip_i4)
        set_control_par(%switch_preview[$_other_clip_i4],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i4]=1)
          %playing[$_other_clip_i4] := 0
          %looping[$_other_clip_i4] := 0
        end if
      end if
      inc($_other_clip_i4)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    $_clip_index5 := $cur_midi_page*8+3
    %looping[3] := 1
    while (%looping[3]=1 and (%cb_id[3]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[3]=0)
        %looping[3] := 0
      end if
      if ($button_showMidi=0)
        %looping[3] := 0
      end if
      $_cur_event4 := 0
      %midi_file_pos_ticks[3] := 0
      %time_started[3] := $ENGINE_UPTIME
      call midi_clip_play_cursor
      %playing[3] := 1
      while (%playing[3]=1 and (%cb_id[3]=$NI_CALLBACK_ID))
        if ($_cur_event4=%num_midi_events[$_clip_index5])
          $_ticks_until_next_event4 := %clip_length[$_clip_index5]-%midi_file_pos_ticks[3]
        else
          $_ticks_until_next_event4 := %_midi_pos[1000*$_clip_index5+$_cur_event4]-%midi_file_pos_ticks[3]
        end if
        if ($_ticks_until_next_event4>0)
          wait(ticks_to_ms($_ticks_until_next_event4))
        end if
        if ($_cur_event4>%num_midi_events[$_clip_index5])
          %playing[3] := 0
        end if
        if ($button_showMidi=0)
          %playing[3] := 0
        end if
        if (%playing[3]=1 and (%cb_id[3]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[3] := %midi_file_pos_ticks[3]+$_ticks_until_next_event4
          if (%_midi_command[1000*$_clip_index5+$_cur_event4]=$MIDI_COMMAND_NOTE_ON)
            $_note4 := %_midi_byte_1[1000*$_clip_index5+$_cur_event4]
            $_velocity4 := %_midi_byte_2[1000*$_clip_index5+$_cur_event4]
            $_length4 := ticks_to_ms(%_midi_length[1000*$_clip_index5+$_cur_event4])
            $_note_id6 := play_note($_note4,$_velocity4,0,$_length4)
            %custom_event_triggered_by_mf[$_note_id6 mod 1000000] := $_clip_index5+1
            %custom_event_active[$_note_id6 mod 1000000] := 1
            %custom_event_source[$_note_id6 mod 1000000] := -1
            set_event_par_arr($_note_id6,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note4,1)
            %key_down[$_note4] := 1
            %velo[$_note4] := $_velocity4
            $_ks_index := search(%articulation_keyswitches,$_note4)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note4)
            if ($_ks_index # -1)
              ?xypad_speed[0] := int_to_real($_ks_index)/int_to_real(5)
              set_control_par(get_ui_id(?xypad_speed),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
              $speed_nks := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note4)
            if ($_ks_index # -1)
              ?xypad_direction[0] := int_to_real($_ks_index)/int_to_real(3)
              set_control_par(get_ui_id(?xypad_direction),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
              $direction_nks := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note4)
            if ($_ks_index # -1)
              ?xypad_legato[0] := int_to_real($_ks_index)/int_to_real(4)
              set_control_par(get_ui_id(?xypad_legato),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
              $legato_nks := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note4)
            if ($_ks_index # -1)
              ?xypad_releaseSamples[0] := int_to_real($_ks_index)/int_to_real(6)
              set_control_par(get_ui_id(?xypad_releaseSamples),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
              $releaseSamples_nks := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note4)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note4)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note4
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note4) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note4,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note4] := 1
              %key_timestamp[$_note4] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note4],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note4
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note4+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note4)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note4)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__UP or (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note4-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note4-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note4-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note4-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note4-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $_ripple_dir := $UP
                  else
                    $_ripple_dir := $DOWN
                  end if
                  $_origin_note3 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if (real_to_int(?xypad_legato[0]*int_to_real(4))=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                    $_ext_mode_real_legato_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    $_ext_mode_real_legato_time := $_real_legato_time
                    select (real_to_int(?xypad_legato[0]*int_to_real(4)))
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time4 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time4 := $_offset_rec_time4 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time4 := $_offset_rec_time4+$_vel_offset
                    $_offset_rec_time4 := $_offset_rec_time4 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note3 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$_ripple_dir) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time4<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    if ($switch_midiOutputMode=0)
                      $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time4,0)
                      if ($switch_velToSampleStart=0)
                        $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity4)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                        change_vol($_note_id2,$_volume,0)
                      end if
                      set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                      set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                      %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                      %custom_event_note[$_note_id2 mod 1000000] := $_note4
                      %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                      %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                      %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note3
                      %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                      %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                      %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                      %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity4
                      %custom_event_direction[$_note_id2 mod 1000000] := $_ripple_dir
                      %custom_event_source[$_note_id2 mod 1000000] := -1
                      %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id6 mod 1000000]
                      $r := 64-2
                      while ($r>=0)
                        %ripple_id_history[$r+1] := %ripple_id_history[$r]
                        dec($r)
                      end while
                      %ripple_id_history[0] := $_note_id2
                      $_fade_in_time := 0
                      if ($_do_legato=0)
                        $_fade_in_time := $menu_latency*1000
                        if ($_fade_in_time=0)
                          $_fade_in_time := 0
                        end if
                      else
                        $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                        $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                        if ($cur_artic=$artic__sixteenths)
                          if ($_real_pos_in_ripple<($_real_ripple_length/4))
                            $_real_pitch_length := $_real_ripple_length/4
                            $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                            $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                          else
                            $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                          end if
                        else
                          $_real_pitch_length := $_real_ripple_length/2
                          $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        end if
                        if (in_range($_velocity4,1,48))
                          $_fade_in_time := $_time_til_end_of_ripple
                        else
                          if (in_range($_velocity4,49,96))
                            $_fade_in_time := $_time_til_end_of_pitch
                          else
                            if (in_range($_velocity4,97,127))
                              $_fade_in_time := $_time_til_end_of_pitch/2
                            end if
                          end if
                        end if
                        if ($_fade_in_time<ticks_to_ms(192))
                          $_fade_in_time := ticks_to_ms(192)
                        end if
                      end if
                      fade_in($_note_id2,$_fade_in_time)
                    else
                      $_ext_first_note := $_first_note
                      $_ext_second_note := $_second_note
                      $_ext_low_note := $_low_note2
                      $_ext_high_note := $_high_note2
                      $_ext_artic := $cur_artic
                      $_wait_time := $_ext_mode_real_legato_time
                      if ($_wait_time>0)
                        select (real_to_int(?xypad_legato[0]*int_to_real(4)))
                          case $legatoMode__syncToPitch
                            $_wait_time := $_real_pitch_length-($_wait_time mod $_real_pitch_length)
                          case $legatoMode__syncToRipple
                            if ($_wait_time mod $_real_ripple_length<=$_real_pitch_length)
                              $_note_chooser := 1
                            end if
                            $_wait_time := $_real_pitch_length-($_wait_time mod $_real_pitch_length)
                          case $legatoMode__syncToSwell
                            if ($_wait_time mod $_real_ripple_length<=$_real_pitch_length)
                              $_note_chooser := 1
                            end if
                            $_ext_pitch := $_wait_time/$_real_pitch_length
                            $_wait_time := $_real_pitch_length-($_wait_time mod $_real_pitch_length)
                        end select
                      end if
                      $_low_vel := %velo[$_note4]-35
                      $_high_vel := $_low_vel+35
                      if ($_high_vel>127)
                        $_high_vel := 127
                      end if
                      if ($_low_vel<1)
                        $_low_vel := 1
                      end if
                      if ($_wait_time>0)
                        wait($_wait_time)
                      end if
                      while (%key_active[$_note4]=1)
                        if ($_note_chooser=0)
                          $_ext_note := $_ext_first_note
                        else
                          $_ext_note := $_ext_second_note
                        end if
                        ~_vel_norm := int_to_real($slider_vol)/1000000.0*(int_to_real(%velo[$_note4])/127.0)
                        $_vel3 := real_to_int(~_vel_norm*int_to_real(127-60))+30
                        if (in_range($_ext_pitch,0,7))
                          $_vel3 := real_to_int(int_to_real($_vel3-30)+((int_to_real($_ext_pitch)-int_to_real(0))/(int_to_real(7)-int_to_real(0))*(int_to_real($_vel3+30)-int_to_real($_vel3-30))))
                        else
                          $_vel3 := real_to_int(int_to_real($_vel3+30)+((int_to_real($_ext_pitch)-int_to_real(8))/(int_to_real(15)-int_to_real(8))*(int_to_real($_vel3-30)-int_to_real($_vel3+30))))
                        end if
                        if ($_note_chooser=1)
                          $_vel3 := $_vel3-20
                        end if
                        if ($_vel3<1)
                          $_vel3 := 1
                        end if
                        if ($_vel3>127)
                          $_vel3 := 127
                        end if
                        if ($_ext_artic=$artic__sixteenths)
                          if ($_note_chooser=0)
                            $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                          else
                            $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                          end if
                        else
                          $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                        end if
                        $_note_id2 := play_note($_ext_note,$_vel3,0,$_len)
                        if ($_ext_artic=$artic__sixteenths)
                          if ($_note_chooser=0)
                            $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                          else
                            $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                          end if
                        else
                          $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                        end if
                        $_wait_time := real_to_int(int_to_real($_wait_time)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
                        if ($_wait_time>0)
                          wait($_wait_time)
                        end if
                        $_ext_pitch := ($_ext_pitch+1) mod 16
                        $_note_chooser := 1-$_note_chooser
                      end while
                      if ($_note_chooser=0)
                        $_ext_note := $_ext_first_note
                      else
                        $_ext_note := $_ext_second_note
                      end if
                      ~_vel_norm := int_to_real($slider_vol)/1000000.0*(int_to_real(%velo[$_note4])/127.0)
                      $_vel3 := real_to_int(~_vel_norm*int_to_real(127-60))+30
                      if (in_range($_ext_pitch,0,7))
                        $_vel3 := real_to_int(int_to_real($_vel3-30)+((int_to_real($_ext_pitch)-int_to_real(0))/(int_to_real(7)-int_to_real(0))*(int_to_real($_vel3+30)-int_to_real($_vel3-30))))
                      else
                        $_vel3 := real_to_int(int_to_real($_vel3+30)+((int_to_real($_ext_pitch)-int_to_real(8))/(int_to_real(15)-int_to_real(8))*(int_to_real($_vel3-30)-int_to_real($_vel3+30))))
                      end if
                      if ($_note_chooser=1)
                        $_vel3 := $_vel3-20
                      end if
                      if ($_vel3<1)
                        $_vel3 := 1
                      end if
                      if ($_vel3>127)
                        $_vel3 := 127
                      end if
                      if ($_ext_artic=$artic__sixteenths)
                        if ($_note_chooser=0)
                          $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                        else
                          $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                        end if
                      else
                        $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                      end if
                      $_note_id2 := play_note($_ext_note,$_vel3,0,$_len)
                      if ($_ext_artic=$artic__sixteenths)
                        if ($_note_chooser=0)
                          $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                        else
                          $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                        end if
                      else
                        $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                      end if
                      $_wait_time := real_to_int(int_to_real($_wait_time)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
                      if ($_wait_time>0)
                        wait($_wait_time)
                      end if
                      $_ext_pitch := ($_ext_pitch+1) mod 16
                      $_note_chooser := 1-$_note_chooser
                      if ($_note_chooser=0)
                        if ($_note_chooser=0)
                          $_ext_note := $_ext_first_note
                        else
                          $_ext_note := $_ext_second_note
                        end if
                        ~_vel_norm := int_to_real($slider_vol)/1000000.0*(int_to_real(%velo[$_note4])/127.0)
                        $_vel3 := real_to_int(~_vel_norm*int_to_real(127-60))+30
                        if (in_range($_ext_pitch,0,7))
                          $_vel3 := real_to_int(int_to_real($_vel3-30)+((int_to_real($_ext_pitch)-int_to_real(0))/(int_to_real(7)-int_to_real(0))*(int_to_real($_vel3+30)-int_to_real($_vel3-30))))
                        else
                          $_vel3 := real_to_int(int_to_real($_vel3+30)+((int_to_real($_ext_pitch)-int_to_real(8))/(int_to_real(15)-int_to_real(8))*(int_to_real($_vel3-30)-int_to_real($_vel3+30))))
                        end if
                        if ($_note_chooser=1)
                          $_vel3 := $_vel3-20
                        end if
                        if ($_vel3<1)
                          $_vel3 := 1
                        end if
                        if ($_vel3>127)
                          $_vel3 := 127
                        end if
                        if ($_ext_artic=$artic__sixteenths)
                          if ($_note_chooser=0)
                            $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                          else
                            $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                          end if
                        else
                          $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                        end if
                        $_note_id2 := play_note($_ext_note,$_vel3,0,$_len)
                        if ($_ext_artic=$artic__sixteenths)
                          if ($_note_chooser=0)
                            $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                          else
                            $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                          end if
                        else
                          $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                        end if
                        $_wait_time := real_to_int(int_to_real($_wait_time)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
                        if ($_wait_time>0)
                          wait($_wait_time)
                        end if
                        $_ext_pitch := ($_ext_pitch+1) mod 16
                        $_note_chooser := 1-$_note_chooser
                      end if
                    end if
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*$_clip_index5+$_cur_event4]=$MIDI_COMMAND_CC)
            $_cc_num4 := %_midi_byte_1[1000*$_clip_index5+$_cur_event4]
            set_controller($_cc_num4,%_midi_byte_2[1000*$_clip_index5+$_cur_event4])
            wait(1)
            if ($_cc_num4=64)
              if (%CC[$_cc_num4]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num4]
            end if
          end if
          inc($_cur_event4)
        end if
        if ($_cur_event4>%num_midi_events[$_clip_index5])
          %playing[3] := 0
        end if
        if ($button_showMidi=0)
          %playing[3] := 0
        end if
      end while
    end while
    if (%cb_id[3]=$NI_CALLBACK_ID)
      set_control_par(%switch_preview[3],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control($switch_preview4)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[4] := $NI_CALLBACK_ID
  if (get_control_par(%switch_preview[4],$CONTROL_PAR_VALUE)=0)
    %playing[4] := 0
    %looping[4] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i5 := 0
    while ($_other_clip_i5<num_elements(%switch_preview))
      if (4 # $_other_clip_i5)
        set_control_par(%switch_preview[$_other_clip_i5],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i5]=1)
          %playing[$_other_clip_i5] := 0
          %looping[$_other_clip_i5] := 0
        end if
      end if
      inc($_other_clip_i5)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    $_clip_index6 := $cur_midi_page*8+4
    %looping[4] := 1
    while (%looping[4]=1 and (%cb_id[4]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[4]=0)
        %looping[4] := 0
      end if
      if ($button_showMidi=0)
        %looping[4] := 0
      end if
      $_cur_event5 := 0
      %midi_file_pos_ticks[4] := 0
      %time_started[4] := $ENGINE_UPTIME
      call midi_clip_play_cursor
      %playing[4] := 1
      while (%playing[4]=1 and (%cb_id[4]=$NI_CALLBACK_ID))
        if ($_cur_event5=%num_midi_events[$_clip_index6])
          $_ticks_until_next_event5 := %clip_length[$_clip_index6]-%midi_file_pos_ticks[4]
        else
          $_ticks_until_next_event5 := %_midi_pos[1000*$_clip_index6+$_cur_event5]-%midi_file_pos_ticks[4]
        end if
        if ($_ticks_until_next_event5>0)
          wait(ticks_to_ms($_ticks_until_next_event5))
        end if
        if ($_cur_event5>%num_midi_events[$_clip_index6])
          %playing[4] := 0
        end if
        if ($button_showMidi=0)
          %playing[4] := 0
        end if
        if (%playing[4]=1 and (%cb_id[4]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[4] := %midi_file_pos_ticks[4]+$_ticks_until_next_event5
          if (%_midi_command[1000*$_clip_index6+$_cur_event5]=$MIDI_COMMAND_NOTE_ON)
            $_note5 := %_midi_byte_1[1000*$_clip_index6+$_cur_event5]
            $_velocity5 := %_midi_byte_2[1000*$_clip_index6+$_cur_event5]
            $_length5 := ticks_to_ms(%_midi_length[1000*$_clip_index6+$_cur_event5])
            $_note_id7 := play_note($_note5,$_velocity5,0,$_length5)
            %custom_event_triggered_by_mf[$_note_id7 mod 1000000] := $_clip_index6+1
            %custom_event_active[$_note_id7 mod 1000000] := 1
            %custom_event_source[$_note_id7 mod 1000000] := -1
            set_event_par_arr($_note_id7,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note5,1)
            %key_down[$_note5] := 1
            %velo[$_note5] := $_velocity5
            $_ks_index := search(%articulation_keyswitches,$_note5)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note5)
            if ($_ks_index # -1)
              ?xypad_speed[0] := int_to_real($_ks_index)/int_to_real(5)
              set_control_par(get_ui_id(?xypad_speed),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
              $speed_nks := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note5)
            if ($_ks_index # -1)
              ?xypad_direction[0] := int_to_real($_ks_index)/int_to_real(3)
              set_control_par(get_ui_id(?xypad_direction),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
              $direction_nks := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note5)
            if ($_ks_index # -1)
              ?xypad_legato[0] := int_to_real($_ks_index)/int_to_real(4)
              set_control_par(get_ui_id(?xypad_legato),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
              $legato_nks := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note5)
            if ($_ks_index # -1)
              ?xypad_releaseSamples[0] := int_to_real($_ks_index)/int_to_real(6)
              set_control_par(get_ui_id(?xypad_releaseSamples),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
              $releaseSamples_nks := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note5)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note5)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note5
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note5) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note5,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note5] := 1
              %key_timestamp[$_note5] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note5],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note5
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note5+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note5)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note5)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__UP or (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note5-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note5-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note5-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note5-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note5-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $_ripple_dir := $UP
                  else
                    $_ripple_dir := $DOWN
                  end if
                  $_origin_note3 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if (real_to_int(?xypad_legato[0]*int_to_real(4))=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                    $_ext_mode_real_legato_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    $_ext_mode_real_legato_time := $_real_legato_time
                    select (real_to_int(?xypad_legato[0]*int_to_real(4)))
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time4 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time4 := $_offset_rec_time4 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time4 := $_offset_rec_time4+$_vel_offset
                    $_offset_rec_time4 := $_offset_rec_time4 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note3 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$_ripple_dir) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time4<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    if ($switch_midiOutputMode=0)
                      $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time4,0)
                      if ($switch_velToSampleStart=0)
                        $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity5)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                        change_vol($_note_id2,$_volume,0)
                      end if
                      set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                      set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                      %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                      %custom_event_note[$_note_id2 mod 1000000] := $_note5
                      %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                      %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                      %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note3
                      %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                      %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                      %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                      %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity5
                      %custom_event_direction[$_note_id2 mod 1000000] := $_ripple_dir
                      %custom_event_source[$_note_id2 mod 1000000] := -1
                      %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id7 mod 1000000]
                      $r := 64-2
                      while ($r>=0)
                        %ripple_id_history[$r+1] := %ripple_id_history[$r]
                        dec($r)
                      end while
                      %ripple_id_history[0] := $_note_id2
                      $_fade_in_time := 0
                      if ($_do_legato=0)
                        $_fade_in_time := $menu_latency*1000
                        if ($_fade_in_time=0)
                          $_fade_in_time := 0
                        end if
                      else
                        $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                        $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                        if ($cur_artic=$artic__sixteenths)
                          if ($_real_pos_in_ripple<($_real_ripple_length/4))
                            $_real_pitch_length := $_real_ripple_length/4
                            $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                            $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                          else
                            $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                          end if
                        else
                          $_real_pitch_length := $_real_ripple_length/2
                          $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        end if
                        if (in_range($_velocity5,1,48))
                          $_fade_in_time := $_time_til_end_of_ripple
                        else
                          if (in_range($_velocity5,49,96))
                            $_fade_in_time := $_time_til_end_of_pitch
                          else
                            if (in_range($_velocity5,97,127))
                              $_fade_in_time := $_time_til_end_of_pitch/2
                            end if
                          end if
                        end if
                        if ($_fade_in_time<ticks_to_ms(192))
                          $_fade_in_time := ticks_to_ms(192)
                        end if
                      end if
                      fade_in($_note_id2,$_fade_in_time)
                    else
                      $_ext_first_note := $_first_note
                      $_ext_second_note := $_second_note
                      $_ext_low_note := $_low_note2
                      $_ext_high_note := $_high_note2
                      $_ext_artic := $cur_artic
                      $_wait_time := $_ext_mode_real_legato_time
                      if ($_wait_time>0)
                        select (real_to_int(?xypad_legato[0]*int_to_real(4)))
                          case $legatoMode__syncToPitch
                            $_wait_time := $_real_pitch_length-($_wait_time mod $_real_pitch_length)
                          case $legatoMode__syncToRipple
                            if ($_wait_time mod $_real_ripple_length<=$_real_pitch_length)
                              $_note_chooser := 1
                            end if
                            $_wait_time := $_real_pitch_length-($_wait_time mod $_real_pitch_length)
                          case $legatoMode__syncToSwell
                            if ($_wait_time mod $_real_ripple_length<=$_real_pitch_length)
                              $_note_chooser := 1
                            end if
                            $_ext_pitch := $_wait_time/$_real_pitch_length
                            $_wait_time := $_real_pitch_length-($_wait_time mod $_real_pitch_length)
                        end select
                      end if
                      $_low_vel := %velo[$_note5]-35
                      $_high_vel := $_low_vel+35
                      if ($_high_vel>127)
                        $_high_vel := 127
                      end if
                      if ($_low_vel<1)
                        $_low_vel := 1
                      end if
                      if ($_wait_time>0)
                        wait($_wait_time)
                      end if
                      while (%key_active[$_note5]=1)
                        if ($_note_chooser=0)
                          $_ext_note := $_ext_first_note
                        else
                          $_ext_note := $_ext_second_note
                        end if
                        ~_vel_norm := int_to_real($slider_vol)/1000000.0*(int_to_real(%velo[$_note5])/127.0)
                        $_vel3 := real_to_int(~_vel_norm*int_to_real(127-60))+30
                        if (in_range($_ext_pitch,0,7))
                          $_vel3 := real_to_int(int_to_real($_vel3-30)+((int_to_real($_ext_pitch)-int_to_real(0))/(int_to_real(7)-int_to_real(0))*(int_to_real($_vel3+30)-int_to_real($_vel3-30))))
                        else
                          $_vel3 := real_to_int(int_to_real($_vel3+30)+((int_to_real($_ext_pitch)-int_to_real(8))/(int_to_real(15)-int_to_real(8))*(int_to_real($_vel3-30)-int_to_real($_vel3+30))))
                        end if
                        if ($_note_chooser=1)
                          $_vel3 := $_vel3-20
                        end if
                        if ($_vel3<1)
                          $_vel3 := 1
                        end if
                        if ($_vel3>127)
                          $_vel3 := 127
                        end if
                        if ($_ext_artic=$artic__sixteenths)
                          if ($_note_chooser=0)
                            $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                          else
                            $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                          end if
                        else
                          $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                        end if
                        $_note_id2 := play_note($_ext_note,$_vel3,0,$_len)
                        if ($_ext_artic=$artic__sixteenths)
                          if ($_note_chooser=0)
                            $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                          else
                            $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                          end if
                        else
                          $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                        end if
                        $_wait_time := real_to_int(int_to_real($_wait_time)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
                        if ($_wait_time>0)
                          wait($_wait_time)
                        end if
                        $_ext_pitch := ($_ext_pitch+1) mod 16
                        $_note_chooser := 1-$_note_chooser
                      end while
                      if ($_note_chooser=0)
                        $_ext_note := $_ext_first_note
                      else
                        $_ext_note := $_ext_second_note
                      end if
                      ~_vel_norm := int_to_real($slider_vol)/1000000.0*(int_to_real(%velo[$_note5])/127.0)
                      $_vel3 := real_to_int(~_vel_norm*int_to_real(127-60))+30
                      if (in_range($_ext_pitch,0,7))
                        $_vel3 := real_to_int(int_to_real($_vel3-30)+((int_to_real($_ext_pitch)-int_to_real(0))/(int_to_real(7)-int_to_real(0))*(int_to_real($_vel3+30)-int_to_real($_vel3-30))))
                      else
                        $_vel3 := real_to_int(int_to_real($_vel3+30)+((int_to_real($_ext_pitch)-int_to_real(8))/(int_to_real(15)-int_to_real(8))*(int_to_real($_vel3-30)-int_to_real($_vel3+30))))
                      end if
                      if ($_note_chooser=1)
                        $_vel3 := $_vel3-20
                      end if
                      if ($_vel3<1)
                        $_vel3 := 1
                      end if
                      if ($_vel3>127)
                        $_vel3 := 127
                      end if
                      if ($_ext_artic=$artic__sixteenths)
                        if ($_note_chooser=0)
                          $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                        else
                          $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                        end if
                      else
                        $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                      end if
                      $_note_id2 := play_note($_ext_note,$_vel3,0,$_len)
                      if ($_ext_artic=$artic__sixteenths)
                        if ($_note_chooser=0)
                          $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                        else
                          $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                        end if
                      else
                        $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                      end if
                      $_wait_time := real_to_int(int_to_real($_wait_time)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
                      if ($_wait_time>0)
                        wait($_wait_time)
                      end if
                      $_ext_pitch := ($_ext_pitch+1) mod 16
                      $_note_chooser := 1-$_note_chooser
                      if ($_note_chooser=0)
                        if ($_note_chooser=0)
                          $_ext_note := $_ext_first_note
                        else
                          $_ext_note := $_ext_second_note
                        end if
                        ~_vel_norm := int_to_real($slider_vol)/1000000.0*(int_to_real(%velo[$_note5])/127.0)
                        $_vel3 := real_to_int(~_vel_norm*int_to_real(127-60))+30
                        if (in_range($_ext_pitch,0,7))
                          $_vel3 := real_to_int(int_to_real($_vel3-30)+((int_to_real($_ext_pitch)-int_to_real(0))/(int_to_real(7)-int_to_real(0))*(int_to_real($_vel3+30)-int_to_real($_vel3-30))))
                        else
                          $_vel3 := real_to_int(int_to_real($_vel3+30)+((int_to_real($_ext_pitch)-int_to_real(8))/(int_to_real(15)-int_to_real(8))*(int_to_real($_vel3-30)-int_to_real($_vel3+30))))
                        end if
                        if ($_note_chooser=1)
                          $_vel3 := $_vel3-20
                        end if
                        if ($_vel3<1)
                          $_vel3 := 1
                        end if
                        if ($_vel3>127)
                          $_vel3 := 127
                        end if
                        if ($_ext_artic=$artic__sixteenths)
                          if ($_note_chooser=0)
                            $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                          else
                            $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                          end if
                        else
                          $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                        end if
                        $_note_id2 := play_note($_ext_note,$_vel3,0,$_len)
                        if ($_ext_artic=$artic__sixteenths)
                          if ($_note_chooser=0)
                            $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                          else
                            $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                          end if
                        else
                          $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                        end if
                        $_wait_time := real_to_int(int_to_real($_wait_time)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
                        if ($_wait_time>0)
                          wait($_wait_time)
                        end if
                        $_ext_pitch := ($_ext_pitch+1) mod 16
                        $_note_chooser := 1-$_note_chooser
                      end if
                    end if
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*$_clip_index6+$_cur_event5]=$MIDI_COMMAND_CC)
            $_cc_num5 := %_midi_byte_1[1000*$_clip_index6+$_cur_event5]
            set_controller($_cc_num5,%_midi_byte_2[1000*$_clip_index6+$_cur_event5])
            wait(1)
            if ($_cc_num5=64)
              if (%CC[$_cc_num5]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num5]
            end if
          end if
          inc($_cur_event5)
        end if
        if ($_cur_event5>%num_midi_events[$_clip_index6])
          %playing[4] := 0
        end if
        if ($button_showMidi=0)
          %playing[4] := 0
        end if
      end while
    end while
    if (%cb_id[4]=$NI_CALLBACK_ID)
      set_control_par(%switch_preview[4],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control($switch_preview5)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[5] := $NI_CALLBACK_ID
  if (get_control_par(%switch_preview[5],$CONTROL_PAR_VALUE)=0)
    %playing[5] := 0
    %looping[5] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i6 := 0
    while ($_other_clip_i6<num_elements(%switch_preview))
      if (5 # $_other_clip_i6)
        set_control_par(%switch_preview[$_other_clip_i6],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i6]=1)
          %playing[$_other_clip_i6] := 0
          %looping[$_other_clip_i6] := 0
        end if
      end if
      inc($_other_clip_i6)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    $_clip_index7 := $cur_midi_page*8+5
    %looping[5] := 1
    while (%looping[5]=1 and (%cb_id[5]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[5]=0)
        %looping[5] := 0
      end if
      if ($button_showMidi=0)
        %looping[5] := 0
      end if
      $_cur_event6 := 0
      %midi_file_pos_ticks[5] := 0
      %time_started[5] := $ENGINE_UPTIME
      call midi_clip_play_cursor
      %playing[5] := 1
      while (%playing[5]=1 and (%cb_id[5]=$NI_CALLBACK_ID))
        if ($_cur_event6=%num_midi_events[$_clip_index7])
          $_ticks_until_next_event6 := %clip_length[$_clip_index7]-%midi_file_pos_ticks[5]
        else
          $_ticks_until_next_event6 := %_midi_pos[1000*$_clip_index7+$_cur_event6]-%midi_file_pos_ticks[5]
        end if
        if ($_ticks_until_next_event6>0)
          wait(ticks_to_ms($_ticks_until_next_event6))
        end if
        if ($_cur_event6>%num_midi_events[$_clip_index7])
          %playing[5] := 0
        end if
        if ($button_showMidi=0)
          %playing[5] := 0
        end if
        if (%playing[5]=1 and (%cb_id[5]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[5] := %midi_file_pos_ticks[5]+$_ticks_until_next_event6
          if (%_midi_command[1000*$_clip_index7+$_cur_event6]=$MIDI_COMMAND_NOTE_ON)
            $_note6 := %_midi_byte_1[1000*$_clip_index7+$_cur_event6]
            $_velocity6 := %_midi_byte_2[1000*$_clip_index7+$_cur_event6]
            $_length6 := ticks_to_ms(%_midi_length[1000*$_clip_index7+$_cur_event6])
            $_note_id8 := play_note($_note6,$_velocity6,0,$_length6)
            %custom_event_triggered_by_mf[$_note_id8 mod 1000000] := $_clip_index7+1
            %custom_event_active[$_note_id8 mod 1000000] := 1
            %custom_event_source[$_note_id8 mod 1000000] := -1
            set_event_par_arr($_note_id8,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note6,1)
            %key_down[$_note6] := 1
            %velo[$_note6] := $_velocity6
            $_ks_index := search(%articulation_keyswitches,$_note6)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note6)
            if ($_ks_index # -1)
              ?xypad_speed[0] := int_to_real($_ks_index)/int_to_real(5)
              set_control_par(get_ui_id(?xypad_speed),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
              $speed_nks := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note6)
            if ($_ks_index # -1)
              ?xypad_direction[0] := int_to_real($_ks_index)/int_to_real(3)
              set_control_par(get_ui_id(?xypad_direction),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
              $direction_nks := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note6)
            if ($_ks_index # -1)
              ?xypad_legato[0] := int_to_real($_ks_index)/int_to_real(4)
              set_control_par(get_ui_id(?xypad_legato),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
              $legato_nks := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note6)
            if ($_ks_index # -1)
              ?xypad_releaseSamples[0] := int_to_real($_ks_index)/int_to_real(6)
              set_control_par(get_ui_id(?xypad_releaseSamples),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
              $releaseSamples_nks := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note6)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note6)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note6
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note6) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note6,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note6] := 1
              %key_timestamp[$_note6] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note6],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note6
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note6+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note6)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note6)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__UP or (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note6-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note6-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note6-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note6-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note6-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $_ripple_dir := $UP
                  else
                    $_ripple_dir := $DOWN
                  end if
                  $_origin_note3 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if (real_to_int(?xypad_legato[0]*int_to_real(4))=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                    $_ext_mode_real_legato_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    $_ext_mode_real_legato_time := $_real_legato_time
                    select (real_to_int(?xypad_legato[0]*int_to_real(4)))
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time4 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time4 := $_offset_rec_time4 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time4 := $_offset_rec_time4+$_vel_offset
                    $_offset_rec_time4 := $_offset_rec_time4 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note3 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$_ripple_dir) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time4<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    if ($switch_midiOutputMode=0)
                      $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time4,0)
                      if ($switch_velToSampleStart=0)
                        $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity6)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                        change_vol($_note_id2,$_volume,0)
                      end if
                      set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                      set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                      %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                      %custom_event_note[$_note_id2 mod 1000000] := $_note6
                      %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                      %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                      %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note3
                      %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                      %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                      %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                      %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity6
                      %custom_event_direction[$_note_id2 mod 1000000] := $_ripple_dir
                      %custom_event_source[$_note_id2 mod 1000000] := -1
                      %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id8 mod 1000000]
                      $r := 64-2
                      while ($r>=0)
                        %ripple_id_history[$r+1] := %ripple_id_history[$r]
                        dec($r)
                      end while
                      %ripple_id_history[0] := $_note_id2
                      $_fade_in_time := 0
                      if ($_do_legato=0)
                        $_fade_in_time := $menu_latency*1000
                        if ($_fade_in_time=0)
                          $_fade_in_time := 0
                        end if
                      else
                        $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                        $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                        if ($cur_artic=$artic__sixteenths)
                          if ($_real_pos_in_ripple<($_real_ripple_length/4))
                            $_real_pitch_length := $_real_ripple_length/4
                            $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                            $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                          else
                            $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                          end if
                        else
                          $_real_pitch_length := $_real_ripple_length/2
                          $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        end if
                        if (in_range($_velocity6,1,48))
                          $_fade_in_time := $_time_til_end_of_ripple
                        else
                          if (in_range($_velocity6,49,96))
                            $_fade_in_time := $_time_til_end_of_pitch
                          else
                            if (in_range($_velocity6,97,127))
                              $_fade_in_time := $_time_til_end_of_pitch/2
                            end if
                          end if
                        end if
                        if ($_fade_in_time<ticks_to_ms(192))
                          $_fade_in_time := ticks_to_ms(192)
                        end if
                      end if
                      fade_in($_note_id2,$_fade_in_time)
                    else
                      $_ext_first_note := $_first_note
                      $_ext_second_note := $_second_note
                      $_ext_low_note := $_low_note2
                      $_ext_high_note := $_high_note2
                      $_ext_artic := $cur_artic
                      $_wait_time := $_ext_mode_real_legato_time
                      if ($_wait_time>0)
                        select (real_to_int(?xypad_legato[0]*int_to_real(4)))
                          case $legatoMode__syncToPitch
                            $_wait_time := $_real_pitch_length-($_wait_time mod $_real_pitch_length)
                          case $legatoMode__syncToRipple
                            if ($_wait_time mod $_real_ripple_length<=$_real_pitch_length)
                              $_note_chooser := 1
                            end if
                            $_wait_time := $_real_pitch_length-($_wait_time mod $_real_pitch_length)
                          case $legatoMode__syncToSwell
                            if ($_wait_time mod $_real_ripple_length<=$_real_pitch_length)
                              $_note_chooser := 1
                            end if
                            $_ext_pitch := $_wait_time/$_real_pitch_length
                            $_wait_time := $_real_pitch_length-($_wait_time mod $_real_pitch_length)
                        end select
                      end if
                      $_low_vel := %velo[$_note6]-35
                      $_high_vel := $_low_vel+35
                      if ($_high_vel>127)
                        $_high_vel := 127
                      end if
                      if ($_low_vel<1)
                        $_low_vel := 1
                      end if
                      if ($_wait_time>0)
                        wait($_wait_time)
                      end if
                      while (%key_active[$_note6]=1)
                        if ($_note_chooser=0)
                          $_ext_note := $_ext_first_note
                        else
                          $_ext_note := $_ext_second_note
                        end if
                        ~_vel_norm := int_to_real($slider_vol)/1000000.0*(int_to_real(%velo[$_note6])/127.0)
                        $_vel3 := real_to_int(~_vel_norm*int_to_real(127-60))+30
                        if (in_range($_ext_pitch,0,7))
                          $_vel3 := real_to_int(int_to_real($_vel3-30)+((int_to_real($_ext_pitch)-int_to_real(0))/(int_to_real(7)-int_to_real(0))*(int_to_real($_vel3+30)-int_to_real($_vel3-30))))
                        else
                          $_vel3 := real_to_int(int_to_real($_vel3+30)+((int_to_real($_ext_pitch)-int_to_real(8))/(int_to_real(15)-int_to_real(8))*(int_to_real($_vel3-30)-int_to_real($_vel3+30))))
                        end if
                        if ($_note_chooser=1)
                          $_vel3 := $_vel3-20
                        end if
                        if ($_vel3<1)
                          $_vel3 := 1
                        end if
                        if ($_vel3>127)
                          $_vel3 := 127
                        end if
                        if ($_ext_artic=$artic__sixteenths)
                          if ($_note_chooser=0)
                            $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                          else
                            $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                          end if
                        else
                          $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                        end if
                        $_note_id2 := play_note($_ext_note,$_vel3,0,$_len)
                        if ($_ext_artic=$artic__sixteenths)
                          if ($_note_chooser=0)
                            $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                          else
                            $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                          end if
                        else
                          $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                        end if
                        $_wait_time := real_to_int(int_to_real($_wait_time)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
                        if ($_wait_time>0)
                          wait($_wait_time)
                        end if
                        $_ext_pitch := ($_ext_pitch+1) mod 16
                        $_note_chooser := 1-$_note_chooser
                      end while
                      if ($_note_chooser=0)
                        $_ext_note := $_ext_first_note
                      else
                        $_ext_note := $_ext_second_note
                      end if
                      ~_vel_norm := int_to_real($slider_vol)/1000000.0*(int_to_real(%velo[$_note6])/127.0)
                      $_vel3 := real_to_int(~_vel_norm*int_to_real(127-60))+30
                      if (in_range($_ext_pitch,0,7))
                        $_vel3 := real_to_int(int_to_real($_vel3-30)+((int_to_real($_ext_pitch)-int_to_real(0))/(int_to_real(7)-int_to_real(0))*(int_to_real($_vel3+30)-int_to_real($_vel3-30))))
                      else
                        $_vel3 := real_to_int(int_to_real($_vel3+30)+((int_to_real($_ext_pitch)-int_to_real(8))/(int_to_real(15)-int_to_real(8))*(int_to_real($_vel3-30)-int_to_real($_vel3+30))))
                      end if
                      if ($_note_chooser=1)
                        $_vel3 := $_vel3-20
                      end if
                      if ($_vel3<1)
                        $_vel3 := 1
                      end if
                      if ($_vel3>127)
                        $_vel3 := 127
                      end if
                      if ($_ext_artic=$artic__sixteenths)
                        if ($_note_chooser=0)
                          $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                        else
                          $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                        end if
                      else
                        $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                      end if
                      $_note_id2 := play_note($_ext_note,$_vel3,0,$_len)
                      if ($_ext_artic=$artic__sixteenths)
                        if ($_note_chooser=0)
                          $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                        else
                          $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                        end if
                      else
                        $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                      end if
                      $_wait_time := real_to_int(int_to_real($_wait_time)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
                      if ($_wait_time>0)
                        wait($_wait_time)
                      end if
                      $_ext_pitch := ($_ext_pitch+1) mod 16
                      $_note_chooser := 1-$_note_chooser
                      if ($_note_chooser=0)
                        if ($_note_chooser=0)
                          $_ext_note := $_ext_first_note
                        else
                          $_ext_note := $_ext_second_note
                        end if
                        ~_vel_norm := int_to_real($slider_vol)/1000000.0*(int_to_real(%velo[$_note6])/127.0)
                        $_vel3 := real_to_int(~_vel_norm*int_to_real(127-60))+30
                        if (in_range($_ext_pitch,0,7))
                          $_vel3 := real_to_int(int_to_real($_vel3-30)+((int_to_real($_ext_pitch)-int_to_real(0))/(int_to_real(7)-int_to_real(0))*(int_to_real($_vel3+30)-int_to_real($_vel3-30))))
                        else
                          $_vel3 := real_to_int(int_to_real($_vel3+30)+((int_to_real($_ext_pitch)-int_to_real(8))/(int_to_real(15)-int_to_real(8))*(int_to_real($_vel3-30)-int_to_real($_vel3+30))))
                        end if
                        if ($_note_chooser=1)
                          $_vel3 := $_vel3-20
                        end if
                        if ($_vel3<1)
                          $_vel3 := 1
                        end if
                        if ($_vel3>127)
                          $_vel3 := 127
                        end if
                        if ($_ext_artic=$artic__sixteenths)
                          if ($_note_chooser=0)
                            $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                          else
                            $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                          end if
                        else
                          $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                        end if
                        $_note_id2 := play_note($_ext_note,$_vel3,0,$_len)
                        if ($_ext_artic=$artic__sixteenths)
                          if ($_note_chooser=0)
                            $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                          else
                            $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                          end if
                        else
                          $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                        end if
                        $_wait_time := real_to_int(int_to_real($_wait_time)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
                        if ($_wait_time>0)
                          wait($_wait_time)
                        end if
                        $_ext_pitch := ($_ext_pitch+1) mod 16
                        $_note_chooser := 1-$_note_chooser
                      end if
                    end if
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*$_clip_index7+$_cur_event6]=$MIDI_COMMAND_CC)
            $_cc_num6 := %_midi_byte_1[1000*$_clip_index7+$_cur_event6]
            set_controller($_cc_num6,%_midi_byte_2[1000*$_clip_index7+$_cur_event6])
            wait(1)
            if ($_cc_num6=64)
              if (%CC[$_cc_num6]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num6]
            end if
          end if
          inc($_cur_event6)
        end if
        if ($_cur_event6>%num_midi_events[$_clip_index7])
          %playing[5] := 0
        end if
        if ($button_showMidi=0)
          %playing[5] := 0
        end if
      end while
    end while
    if (%cb_id[5]=$NI_CALLBACK_ID)
      set_control_par(%switch_preview[5],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control($switch_preview6)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[6] := $NI_CALLBACK_ID
  if (get_control_par(%switch_preview[6],$CONTROL_PAR_VALUE)=0)
    %playing[6] := 0
    %looping[6] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i7 := 0
    while ($_other_clip_i7<num_elements(%switch_preview))
      if (6 # $_other_clip_i7)
        set_control_par(%switch_preview[$_other_clip_i7],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i7]=1)
          %playing[$_other_clip_i7] := 0
          %looping[$_other_clip_i7] := 0
        end if
      end if
      inc($_other_clip_i7)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    $_clip_index8 := $cur_midi_page*8+6
    %looping[6] := 1
    while (%looping[6]=1 and (%cb_id[6]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[6]=0)
        %looping[6] := 0
      end if
      if ($button_showMidi=0)
        %looping[6] := 0
      end if
      $_cur_event7 := 0
      %midi_file_pos_ticks[6] := 0
      %time_started[6] := $ENGINE_UPTIME
      call midi_clip_play_cursor
      %playing[6] := 1
      while (%playing[6]=1 and (%cb_id[6]=$NI_CALLBACK_ID))
        if ($_cur_event7=%num_midi_events[$_clip_index8])
          $_ticks_until_next_event7 := %clip_length[$_clip_index8]-%midi_file_pos_ticks[6]
        else
          $_ticks_until_next_event7 := %_midi_pos[1000*$_clip_index8+$_cur_event7]-%midi_file_pos_ticks[6]
        end if
        if ($_ticks_until_next_event7>0)
          wait(ticks_to_ms($_ticks_until_next_event7))
        end if
        if ($_cur_event7>%num_midi_events[$_clip_index8])
          %playing[6] := 0
        end if
        if ($button_showMidi=0)
          %playing[6] := 0
        end if
        if (%playing[6]=1 and (%cb_id[6]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[6] := %midi_file_pos_ticks[6]+$_ticks_until_next_event7
          if (%_midi_command[1000*$_clip_index8+$_cur_event7]=$MIDI_COMMAND_NOTE_ON)
            $_note7 := %_midi_byte_1[1000*$_clip_index8+$_cur_event7]
            $_velocity7 := %_midi_byte_2[1000*$_clip_index8+$_cur_event7]
            $_length7 := ticks_to_ms(%_midi_length[1000*$_clip_index8+$_cur_event7])
            $_note_id9 := play_note($_note7,$_velocity7,0,$_length7)
            %custom_event_triggered_by_mf[$_note_id9 mod 1000000] := $_clip_index8+1
            %custom_event_active[$_note_id9 mod 1000000] := 1
            %custom_event_source[$_note_id9 mod 1000000] := -1
            set_event_par_arr($_note_id9,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note7,1)
            %key_down[$_note7] := 1
            %velo[$_note7] := $_velocity7
            $_ks_index := search(%articulation_keyswitches,$_note7)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note7)
            if ($_ks_index # -1)
              ?xypad_speed[0] := int_to_real($_ks_index)/int_to_real(5)
              set_control_par(get_ui_id(?xypad_speed),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
              $speed_nks := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note7)
            if ($_ks_index # -1)
              ?xypad_direction[0] := int_to_real($_ks_index)/int_to_real(3)
              set_control_par(get_ui_id(?xypad_direction),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
              $direction_nks := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note7)
            if ($_ks_index # -1)
              ?xypad_legato[0] := int_to_real($_ks_index)/int_to_real(4)
              set_control_par(get_ui_id(?xypad_legato),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
              $legato_nks := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note7)
            if ($_ks_index # -1)
              ?xypad_releaseSamples[0] := int_to_real($_ks_index)/int_to_real(6)
              set_control_par(get_ui_id(?xypad_releaseSamples),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
              $releaseSamples_nks := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note7)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note7)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note7
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note7) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note7,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note7] := 1
              %key_timestamp[$_note7] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note7],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note7
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note7+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note7)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note7)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__UP or (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note7-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note7-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note7-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note7-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note7-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $_ripple_dir := $UP
                  else
                    $_ripple_dir := $DOWN
                  end if
                  $_origin_note3 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if (real_to_int(?xypad_legato[0]*int_to_real(4))=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                    $_ext_mode_real_legato_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    $_ext_mode_real_legato_time := $_real_legato_time
                    select (real_to_int(?xypad_legato[0]*int_to_real(4)))
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time4 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time4 := $_offset_rec_time4 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time4 := $_offset_rec_time4+$_vel_offset
                    $_offset_rec_time4 := $_offset_rec_time4 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note3 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$_ripple_dir) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time4<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    if ($switch_midiOutputMode=0)
                      $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time4,0)
                      if ($switch_velToSampleStart=0)
                        $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity7)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                        change_vol($_note_id2,$_volume,0)
                      end if
                      set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                      set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                      %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                      %custom_event_note[$_note_id2 mod 1000000] := $_note7
                      %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                      %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                      %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note3
                      %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                      %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                      %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                      %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity7
                      %custom_event_direction[$_note_id2 mod 1000000] := $_ripple_dir
                      %custom_event_source[$_note_id2 mod 1000000] := -1
                      %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id9 mod 1000000]
                      $r := 64-2
                      while ($r>=0)
                        %ripple_id_history[$r+1] := %ripple_id_history[$r]
                        dec($r)
                      end while
                      %ripple_id_history[0] := $_note_id2
                      $_fade_in_time := 0
                      if ($_do_legato=0)
                        $_fade_in_time := $menu_latency*1000
                        if ($_fade_in_time=0)
                          $_fade_in_time := 0
                        end if
                      else
                        $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                        $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                        if ($cur_artic=$artic__sixteenths)
                          if ($_real_pos_in_ripple<($_real_ripple_length/4))
                            $_real_pitch_length := $_real_ripple_length/4
                            $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                            $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                          else
                            $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                          end if
                        else
                          $_real_pitch_length := $_real_ripple_length/2
                          $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        end if
                        if (in_range($_velocity7,1,48))
                          $_fade_in_time := $_time_til_end_of_ripple
                        else
                          if (in_range($_velocity7,49,96))
                            $_fade_in_time := $_time_til_end_of_pitch
                          else
                            if (in_range($_velocity7,97,127))
                              $_fade_in_time := $_time_til_end_of_pitch/2
                            end if
                          end if
                        end if
                        if ($_fade_in_time<ticks_to_ms(192))
                          $_fade_in_time := ticks_to_ms(192)
                        end if
                      end if
                      fade_in($_note_id2,$_fade_in_time)
                    else
                      $_ext_first_note := $_first_note
                      $_ext_second_note := $_second_note
                      $_ext_low_note := $_low_note2
                      $_ext_high_note := $_high_note2
                      $_ext_artic := $cur_artic
                      $_wait_time := $_ext_mode_real_legato_time
                      if ($_wait_time>0)
                        select (real_to_int(?xypad_legato[0]*int_to_real(4)))
                          case $legatoMode__syncToPitch
                            $_wait_time := $_real_pitch_length-($_wait_time mod $_real_pitch_length)
                          case $legatoMode__syncToRipple
                            if ($_wait_time mod $_real_ripple_length<=$_real_pitch_length)
                              $_note_chooser := 1
                            end if
                            $_wait_time := $_real_pitch_length-($_wait_time mod $_real_pitch_length)
                          case $legatoMode__syncToSwell
                            if ($_wait_time mod $_real_ripple_length<=$_real_pitch_length)
                              $_note_chooser := 1
                            end if
                            $_ext_pitch := $_wait_time/$_real_pitch_length
                            $_wait_time := $_real_pitch_length-($_wait_time mod $_real_pitch_length)
                        end select
                      end if
                      $_low_vel := %velo[$_note7]-35
                      $_high_vel := $_low_vel+35
                      if ($_high_vel>127)
                        $_high_vel := 127
                      end if
                      if ($_low_vel<1)
                        $_low_vel := 1
                      end if
                      if ($_wait_time>0)
                        wait($_wait_time)
                      end if
                      while (%key_active[$_note7]=1)
                        if ($_note_chooser=0)
                          $_ext_note := $_ext_first_note
                        else
                          $_ext_note := $_ext_second_note
                        end if
                        ~_vel_norm := int_to_real($slider_vol)/1000000.0*(int_to_real(%velo[$_note7])/127.0)
                        $_vel3 := real_to_int(~_vel_norm*int_to_real(127-60))+30
                        if (in_range($_ext_pitch,0,7))
                          $_vel3 := real_to_int(int_to_real($_vel3-30)+((int_to_real($_ext_pitch)-int_to_real(0))/(int_to_real(7)-int_to_real(0))*(int_to_real($_vel3+30)-int_to_real($_vel3-30))))
                        else
                          $_vel3 := real_to_int(int_to_real($_vel3+30)+((int_to_real($_ext_pitch)-int_to_real(8))/(int_to_real(15)-int_to_real(8))*(int_to_real($_vel3-30)-int_to_real($_vel3+30))))
                        end if
                        if ($_note_chooser=1)
                          $_vel3 := $_vel3-20
                        end if
                        if ($_vel3<1)
                          $_vel3 := 1
                        end if
                        if ($_vel3>127)
                          $_vel3 := 127
                        end if
                        if ($_ext_artic=$artic__sixteenths)
                          if ($_note_chooser=0)
                            $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                          else
                            $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                          end if
                        else
                          $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                        end if
                        $_note_id2 := play_note($_ext_note,$_vel3,0,$_len)
                        if ($_ext_artic=$artic__sixteenths)
                          if ($_note_chooser=0)
                            $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                          else
                            $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                          end if
                        else
                          $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                        end if
                        $_wait_time := real_to_int(int_to_real($_wait_time)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
                        if ($_wait_time>0)
                          wait($_wait_time)
                        end if
                        $_ext_pitch := ($_ext_pitch+1) mod 16
                        $_note_chooser := 1-$_note_chooser
                      end while
                      if ($_note_chooser=0)
                        $_ext_note := $_ext_first_note
                      else
                        $_ext_note := $_ext_second_note
                      end if
                      ~_vel_norm := int_to_real($slider_vol)/1000000.0*(int_to_real(%velo[$_note7])/127.0)
                      $_vel3 := real_to_int(~_vel_norm*int_to_real(127-60))+30
                      if (in_range($_ext_pitch,0,7))
                        $_vel3 := real_to_int(int_to_real($_vel3-30)+((int_to_real($_ext_pitch)-int_to_real(0))/(int_to_real(7)-int_to_real(0))*(int_to_real($_vel3+30)-int_to_real($_vel3-30))))
                      else
                        $_vel3 := real_to_int(int_to_real($_vel3+30)+((int_to_real($_ext_pitch)-int_to_real(8))/(int_to_real(15)-int_to_real(8))*(int_to_real($_vel3-30)-int_to_real($_vel3+30))))
                      end if
                      if ($_note_chooser=1)
                        $_vel3 := $_vel3-20
                      end if
                      if ($_vel3<1)
                        $_vel3 := 1
                      end if
                      if ($_vel3>127)
                        $_vel3 := 127
                      end if
                      if ($_ext_artic=$artic__sixteenths)
                        if ($_note_chooser=0)
                          $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                        else
                          $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                        end if
                      else
                        $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                      end if
                      $_note_id2 := play_note($_ext_note,$_vel3,0,$_len)
                      if ($_ext_artic=$artic__sixteenths)
                        if ($_note_chooser=0)
                          $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                        else
                          $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                        end if
                      else
                        $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                      end if
                      $_wait_time := real_to_int(int_to_real($_wait_time)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
                      if ($_wait_time>0)
                        wait($_wait_time)
                      end if
                      $_ext_pitch := ($_ext_pitch+1) mod 16
                      $_note_chooser := 1-$_note_chooser
                      if ($_note_chooser=0)
                        if ($_note_chooser=0)
                          $_ext_note := $_ext_first_note
                        else
                          $_ext_note := $_ext_second_note
                        end if
                        ~_vel_norm := int_to_real($slider_vol)/1000000.0*(int_to_real(%velo[$_note7])/127.0)
                        $_vel3 := real_to_int(~_vel_norm*int_to_real(127-60))+30
                        if (in_range($_ext_pitch,0,7))
                          $_vel3 := real_to_int(int_to_real($_vel3-30)+((int_to_real($_ext_pitch)-int_to_real(0))/(int_to_real(7)-int_to_real(0))*(int_to_real($_vel3+30)-int_to_real($_vel3-30))))
                        else
                          $_vel3 := real_to_int(int_to_real($_vel3+30)+((int_to_real($_ext_pitch)-int_to_real(8))/(int_to_real(15)-int_to_real(8))*(int_to_real($_vel3-30)-int_to_real($_vel3+30))))
                        end if
                        if ($_note_chooser=1)
                          $_vel3 := $_vel3-20
                        end if
                        if ($_vel3<1)
                          $_vel3 := 1
                        end if
                        if ($_vel3>127)
                          $_vel3 := 127
                        end if
                        if ($_ext_artic=$artic__sixteenths)
                          if ($_note_chooser=0)
                            $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                          else
                            $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                          end if
                        else
                          $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                        end if
                        $_note_id2 := play_note($_ext_note,$_vel3,0,$_len)
                        if ($_ext_artic=$artic__sixteenths)
                          if ($_note_chooser=0)
                            $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                          else
                            $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                          end if
                        else
                          $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                        end if
                        $_wait_time := real_to_int(int_to_real($_wait_time)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
                        if ($_wait_time>0)
                          wait($_wait_time)
                        end if
                        $_ext_pitch := ($_ext_pitch+1) mod 16
                        $_note_chooser := 1-$_note_chooser
                      end if
                    end if
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*$_clip_index8+$_cur_event7]=$MIDI_COMMAND_CC)
            $_cc_num7 := %_midi_byte_1[1000*$_clip_index8+$_cur_event7]
            set_controller($_cc_num7,%_midi_byte_2[1000*$_clip_index8+$_cur_event7])
            wait(1)
            if ($_cc_num7=64)
              if (%CC[$_cc_num7]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num7]
            end if
          end if
          inc($_cur_event7)
        end if
        if ($_cur_event7>%num_midi_events[$_clip_index8])
          %playing[6] := 0
        end if
        if ($button_showMidi=0)
          %playing[6] := 0
        end if
      end while
    end while
    if (%cb_id[6]=$NI_CALLBACK_ID)
      set_control_par(%switch_preview[6],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control($switch_preview7)
  set_controller(64,0)
  wait(1)
  call unpress_all_keys
  %cb_id[7] := $NI_CALLBACK_ID
  if (get_control_par(%switch_preview[7],$CONTROL_PAR_VALUE)=0)
    %playing[7] := 0
    %looping[7] := 0
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
  else
    $_other_clip_i8 := 0
    while ($_other_clip_i8<num_elements(%switch_preview))
      if (7 # $_other_clip_i8)
        set_control_par(%switch_preview[$_other_clip_i8],$CONTROL_PAR_VALUE,0)
        if (%playing[$_other_clip_i8]=1)
          %playing[$_other_clip_i8] := 0
          %looping[$_other_clip_i8] := 0
        end if
      end if
      inc($_other_clip_i8)
    end while
    $r := 0
    while ($r<64)
      if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
        %custom_event_preview_being_stopped[%ripple_id_history[$r] mod 1000000] := 1
      end if
      inc($r)
    end while
    $key_i := $LOWEST_KEY
    while ($key_i<=$HIGHEST_KEY)
      set_control_par(%key_ids[$key_i],$CONTROL_PAR_PICTURE_STATE,0)
      %key_down[$key_i] := 0
      %key_active[$key_i] := 0
      inc($key_i)
    end while
    call release_marked_ripples
    call deactivate_mf_notes
    $_clip_index9 := $cur_midi_page*8+7
    %looping[7] := 1
    while (%looping[7]=1 and (%cb_id[7]=$NI_CALLBACK_ID))
      if (%clip_loop_enabled[7]=0)
        %looping[7] := 0
      end if
      if ($button_showMidi=0)
        %looping[7] := 0
      end if
      $_cur_event8 := 0
      %midi_file_pos_ticks[7] := 0
      %time_started[7] := $ENGINE_UPTIME
      call midi_clip_play_cursor
      %playing[7] := 1
      while (%playing[7]=1 and (%cb_id[7]=$NI_CALLBACK_ID))
        if ($_cur_event8=%num_midi_events[$_clip_index9])
          $_ticks_until_next_event8 := %clip_length[$_clip_index9]-%midi_file_pos_ticks[7]
        else
          $_ticks_until_next_event8 := %_midi_pos[1000*$_clip_index9+$_cur_event8]-%midi_file_pos_ticks[7]
        end if
        if ($_ticks_until_next_event8>0)
          wait(ticks_to_ms($_ticks_until_next_event8))
        end if
        if ($_cur_event8>%num_midi_events[$_clip_index9])
          %playing[7] := 0
        end if
        if ($button_showMidi=0)
          %playing[7] := 0
        end if
        if (%playing[7]=1 and (%cb_id[7]=$NI_CALLBACK_ID))
          %midi_file_pos_ticks[7] := %midi_file_pos_ticks[7]+$_ticks_until_next_event8
          if (%_midi_command[1000*$_clip_index9+$_cur_event8]=$MIDI_COMMAND_NOTE_ON)
            $_note8 := %_midi_byte_1[1000*$_clip_index9+$_cur_event8]
            $_velocity8 := %_midi_byte_2[1000*$_clip_index9+$_cur_event8]
            $_length8 := ticks_to_ms(%_midi_length[1000*$_clip_index9+$_cur_event8])
            $_note_id10 := play_note($_note8,$_velocity8,0,$_length8)
            %custom_event_triggered_by_mf[$_note_id10 mod 1000000] := $_clip_index9+1
            %custom_event_active[$_note_id10 mod 1000000] := 1
            %custom_event_source[$_note_id10 mod 1000000] := -1
            set_event_par_arr($_note_id10,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
            set_key_pressed($_note8,1)
            %key_down[$_note8] := 1
            %velo[$_note8] := $_velocity8
            $_ks_index := search(%articulation_keyswitches,$_note8)
            if ($_ks_index # -1)
              $cur_artic := $_ks_index
              call update_articulation_switches
            end if
            $_ks_index := search(%speed_keyswitches,$_note8)
            if ($_ks_index # -1)
              ?xypad_speed[0] := int_to_real($_ks_index)/int_to_real(5)
              set_control_par(get_ui_id(?xypad_speed),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
              $speed_nks := $_ks_index
              call update_speed_switches
              %p[$sp-1] := $control__speed
              call update_engine_pars
              %p[$sp-1] := $control__speed
              call update_nks_label
            end if
            $_ks_index := search(%direction_keyswitches,$_note8)
            if ($_ks_index # -1)
              ?xypad_direction[0] := int_to_real($_ks_index)/int_to_real(3)
              set_control_par(get_ui_id(?xypad_direction),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
              $direction_nks := $_ks_index
              call update_direction_switches
              %p[$sp-1] := $control__direction
              call update_nks_label
            end if
            $_ks_index := search(%legato_keyswitches,$_note8)
            if ($_ks_index # -1)
              ?xypad_legato[0] := int_to_real($_ks_index)/int_to_real(4)
              set_control_par(get_ui_id(?xypad_legato),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
              $legato_nks := $_ks_index
              call update_legato_switches
              %p[$sp-1] := $control__legato
              call update_nks_label
            end if
            $_ks_index := search(%release_sample_keyswitches,$_note8)
            if ($_ks_index # -1)
              ?xypad_releaseSamples[0] := int_to_real($_ks_index)/int_to_real(6)
              set_control_par(get_ui_id(?xypad_releaseSamples),$CONTROL_PAR_PICTURE_STATE,$_ks_index)
              $releaseSamples_nks := $_ks_index
              call update_releaseSamples_switches
              %p[$sp-1] := $control__releaseSamples
              call update_nks_label
            end if
            $_ks_index := search(%vel_to_start_keyswitches,$_note8)
            if ($_ks_index # -1)
              $switch_velToSampleStart := $_ks_index
            end if
            $_ks_index := search(%release_trigger_keyswitches,$_note8)
            if ($_ks_index # -1)
              $recent_release_trigger_key := $_note8
              $r := 0
              while ($r<64)
                if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                  %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 1
                end if
                inc($r)
              end while
              call release_marked_ripples
            end if
            if (search(%all_keyswitches,$_note8) # -1)
              call set_keys_pressed
            end if
            if (in_range($_note8,$LOWEST_KEY,$HIGHEST_KEY))
              %key_active[$_note8] := 1
              %key_timestamp[$_note8] := $ENGINE_UPTIME
              set_control_par(%key_ids[$_note8],$CONTROL_PAR_PICTURE_STATE,1)
              $key_i := num_elements(%key_history)-2
              while ($key_i>=0)
                %key_history[$key_i+1] := %key_history[$key_i]
                dec($key_i)
              end while
              %key_history[0] := $_note8
              call count_keys_down
              if ($num_keys_down>1)
                $_num_ripples := 0
                $_closest_neighbor := -1
                $_closest_neighbor_interval := 12
                $array_i := 0
                while ($array_i<num_elements(%_neighbor))
                  %_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_lower_neighbor))
                  %_lower_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%_upper_neighbor))
                  %_upper_neighbor[$array_i] := 0
                  inc($array_i)
                end while
                $_num_neighbors := 0
                $_num_lower_neighbors := 0
                $_num_upper_neighbors := 0
                $i := 1
                while ($i<=$MAX_INTERVAL)
                  $_dir := 0
                  while ($_dir<=1)
                    $_sign := $_dir*2-1
                    $_other_note := $_note8+($i*$_sign)
                    if (%key_down[$_other_note]=1)
                      %_neighbor[$_num_neighbors] := $_other_note
                      inc($_num_neighbors)
                      if ($_other_note<$_note8)
                        %_lower_neighbor[$_num_lower_neighbors] := $_other_note
                        inc($_num_lower_neighbors)
                      end if
                      if ($_other_note>$_note8)
                        %_upper_neighbor[$_num_upper_neighbors] := $_other_note
                        inc($_num_upper_neighbors)
                      end if
                    end if
                    inc($_dir)
                  end while
                  inc($i)
                end while
                if (%_lower_neighbor[0] # 0 and (%_upper_neighbor[0] # 0))
                  $_lower_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_lower_neighbor[0]]
                  $_upper_neighbor_time_held := $ENGINE_UPTIME-%key_timestamp[%_upper_neighbor[0]]
                  if (abs($_upper_neighbor_time_held-$_lower_neighbor_time_held)<50)
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  else
                    $_make_ripples_to_both_adjacent_neighbors := 0
                  end if
                  if (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__UP or (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__DOWN))
                    $_make_ripples_to_both_adjacent_neighbors := 1
                  end if
                  if ($_make_ripples_to_both_adjacent_neighbors=1)
                    %__notes[0] := %_lower_neighbor[0]
                    %__intervals[0] := $_note8-%_lower_neighbor[0]
                    %__notes[1] := %_upper_neighbor[0]
                    %__intervals[1] := $_note8-%_upper_neighbor[0]
                    $_num_ripples := 2
                  else
                    if ($_make_ripples_to_both_adjacent_neighbors=0)
                      if (search(%key_history,%_lower_neighbor[0])<search(%key_history,%_upper_neighbor[0]))
                        %__notes[0] := %_lower_neighbor[0]
                        %__intervals[0] := $_note8-%_lower_neighbor[0]
                      else
                        %__notes[0] := %_upper_neighbor[0]
                        %__intervals[0] := $_note8-%_upper_neighbor[0]
                      end if
                      $_num_ripples := 1
                    end if
                  end if
                else
                  %__notes[0] := %key_history[1]
                  %__intervals[0] := %key_history[0]-%key_history[1]
                  $_num_ripples := 1
                  if (abs(%__intervals[0])>$MAX_INTERVAL)
                    if ($_num_neighbors>0)
                      %__notes[0] := %_neighbor[0]
                      %__intervals[0] := $_note8-%_neighbor[0]
                      $_num_ripples := 1
                    else
                      $array_i := 0
                      while ($array_i<num_elements(%__notes))
                        %__notes[$array_i] := 0
                        inc($array_i)
                      end while
                      $array_i := 0
                      while ($array_i<num_elements(%__intervals))
                        %__intervals[$array_i] := 0
                        inc($array_i)
                      end while
                      $_num_ripples := 0
                    end if
                  end if
                end if
                $array_i := 0
                while ($array_i<num_elements(%__notes))
                  %_played_notes[$array_i] := %__notes[$array_i]
                  inc($array_i)
                end while
                $array_i := 0
                while ($array_i<num_elements(%__intervals))
                  %_played_intervals[$array_i] := %__intervals[$array_i]
                  inc($array_i)
                end while
                $ripple_i := 0
                while ($ripple_i<$_num_ripples)
                  if (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__UP)
                    if (%__intervals[$ripple_i]<0)
                      %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                      %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                    end if
                  else
                    if (real_to_int(?xypad_direction[0]*int_to_real(3))=$directionMode__DOWN)
                      if (%__intervals[$ripple_i]>0)
                        %__notes[$ripple_i] := %__notes[$ripple_i]+%__intervals[$ripple_i]
                        %__intervals[$ripple_i] := -%__intervals[$ripple_i]
                      end if
                    end if
                  end if
                  if (%__intervals[$ripple_i]<0)
                    $_low_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]
                  else
                    $_low_note2 := %__notes[$ripple_i]
                    $_high_note2 := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  end if
                  if (%__intervals[$ripple_i]>0)
                    $_ripple_dir := $UP
                  else
                    $_ripple_dir := $DOWN
                  end if
                  $_origin_note3 := %__notes[$ripple_i]
                  $_dest_note := %__notes[$ripple_i]+%__intervals[$ripple_i]
                  $_first_note := %_played_notes[$ripple_i]
                  $_second_note := %_played_notes[$ripple_i]+%_played_intervals[$ripple_i]
                  $_real_ripple_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_ripple_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))))
                  $_real_pitch_length := $_real_ripple_length/%pitch_fractions[$cur_artic]
                  $_real_sample_length := real_to_int(int_to_real(0)+((int_to_real(%rec_time_sample_lengths[$cur_artic])-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))))
                  if ($all_keys_inactive=1)
                    $_do_legato := 0
                  else
                    $_do_legato := 1
                  end if
                  $all_keys_inactive := 0
                  if (real_to_int(?xypad_legato[0]*int_to_real(4))=0)
                    $_do_legato := 0
                  end if
                  if ($_do_legato=0)
                    $first_ripple_timestamp := $ENGINE_UPTIME
                    $_real_legato_time := 0
                    $_offset_real_time := 0
                    $_ext_mode_real_legato_time := 0
                  else
                    $_real_legato_time := ($ENGINE_UPTIME-$first_ripple_timestamp)*1000
                    $_ext_mode_real_legato_time := $_real_legato_time
                    select (real_to_int(?xypad_legato[0]*int_to_real(4)))
                      case $legatoMode__syncToPitch
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_pitch_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToRipple
                        $_real_legato_time := $_real_legato_time+ticks_to_ms(30)
                        $_offset_real_time := $_real_legato_time mod $_real_ripple_length
                        $_offset_real_time := $_offset_real_time-ticks_to_ms(30)
                      case $legatoMode__syncToSwell
                        $_offset_real_time := $_real_legato_time mod $_real_sample_length
                    end select
                    if ($_offset_real_time<0)
                      $_offset_real_time := 0
                    end if
                  end if
                  $_latency_real_time := real_to_int(int_to_real($menu_latency)/?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
                  $_offset_real_time := $_offset_real_time+((real_to_int(int_to_real(0)+((int_to_real(500)-int_to_real(0))/(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))*(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))))-$_latency_real_time)*1000)
                  $_offset_rec_time4 := real_to_int(int_to_real(0)+((int_to_real($_offset_real_time)-int_to_real(0))/(int_to_real(real_to_int(int_to_real($DURATION_QUARTER)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))]))-int_to_real(0))*(int_to_real($RECORDED_DURATION_QUARTER)-int_to_real(0))))
                  if ($switch_velToSampleStart=1)
                    $_offset_rec_time4 := $_offset_rec_time4 mod %rec_time_ripple_lengths[$cur_artic]
                    $_vel_offset := %velo[$_second_note]/26*%rec_time_ripple_lengths[$cur_artic]
                    $_offset_rec_time4 := $_offset_rec_time4+$_vel_offset
                    $_offset_rec_time4 := $_offset_rec_time4 mod $_real_sample_length
                  end if
                  $_already_playing := 0
                  $r := 0
                  while ($r<64)
                    if (event_status(%ripple_id_history[$r])=$EVENT_STATUS_NOTE_QUEUE)
                      if ((%custom_event_low_note[%ripple_id_history[$r] mod 1000000]=$_low_note2 and (%custom_event_high_note[%ripple_id_history[$r] mod 1000000]=$_high_note2) or (%custom_event_origin_note[%ripple_id_history[$r] mod 1000000]=$_origin_note3 and (%custom_event_dest_note[%ripple_id_history[$r] mod 1000000]=$_dest_note))) and (%custom_event_direction[%ripple_id_history[$r] mod 1000000]=$_ripple_dir) and (%custom_event_releasing[%ripple_id_history[$r] mod 1000000]=0) and (get_event_par(%ripple_id_history[$r],$EVENT_PAR_PLAY_POS)-$_offset_rec_time4<5000))
                        $_already_playing := 1
                        %custom_event_marked_for_release[%ripple_id_history[$r] mod 1000000] := 0
                      end if
                    end if
                    inc($r)
                  end while
                  if ($_already_playing=0)
                    if ($switch_midiOutputMode=0)
                      $_note_id2 := play_note(%__notes[$ripple_i],64+%__intervals[$ripple_i],$_offset_rec_time4,0)
                      if ($switch_velToSampleStart=0)
                        $_volume := real_to_int(int_to_real(-7000)+((int_to_real($_velocity8)-int_to_real(1))/(int_to_real(127)-int_to_real(1))*(int_to_real(3000)-int_to_real(-7000))))
                        change_vol($_note_id2,$_volume,0)
                      end if
                      set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,0,$ALL_GROUPS)
                      set_event_par_arr($_note_id2,$EVENT_PAR_ALLOW_GROUP,1,$cur_artic)
                      %custom_event_artic[$_note_id2 mod 1000000] := $cur_artic
                      %custom_event_note[$_note_id2 mod 1000000] := $_note8
                      %custom_event_low_note[$_note_id2 mod 1000000] := $_low_note2
                      %custom_event_high_note[$_note_id2 mod 1000000] := $_high_note2
                      %custom_event_origin_note[$_note_id2 mod 1000000] := $_origin_note3
                      %custom_event_dest_note[$_note_id2 mod 1000000] := $_dest_note
                      %custom_event_first_note[$_note_id2 mod 1000000] := $_first_note
                      %custom_event_second_note[$_note_id2 mod 1000000] := $_second_note
                      %custom_event_velocity[$_note_id2 mod 1000000] := $_velocity8
                      %custom_event_direction[$_note_id2 mod 1000000] := $_ripple_dir
                      %custom_event_source[$_note_id2 mod 1000000] := -1
                      %custom_event_triggered_by_mf[$_note_id2 mod 1000000] := %custom_event_triggered_by_mf[$_note_id10 mod 1000000]
                      $r := 64-2
                      while ($r>=0)
                        %ripple_id_history[$r+1] := %ripple_id_history[$r]
                        dec($r)
                      end while
                      %ripple_id_history[0] := $_note_id2
                      $_fade_in_time := 0
                      if ($_do_legato=0)
                        $_fade_in_time := $menu_latency*1000
                        if ($_fade_in_time=0)
                          $_fade_in_time := 0
                        end if
                      else
                        $_real_pos_in_ripple := ($_real_legato_time+$_real_ripple_length-ticks_to_ms(48)) mod $_real_ripple_length
                        $_time_til_end_of_ripple := $_real_ripple_length-$_real_pos_in_ripple
                        if ($cur_artic=$artic__sixteenths)
                          if ($_real_pos_in_ripple<($_real_ripple_length/4))
                            $_real_pitch_length := $_real_ripple_length/4
                            $_real_pos_in_pitch := $_real_pos_in_ripple mod $_real_pitch_length
                            $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                          else
                            $_time_til_end_of_pitch := $_real_ripple_length-$_real_pos_in_ripple
                          end if
                        else
                          $_real_pitch_length := $_real_ripple_length/2
                          $_real_pos_in_pitch := $_real_legato_time mod $_real_pitch_length
                          $_time_til_end_of_pitch := $_real_pitch_length-$_real_pos_in_pitch
                        end if
                        if (in_range($_velocity8,1,48))
                          $_fade_in_time := $_time_til_end_of_ripple
                        else
                          if (in_range($_velocity8,49,96))
                            $_fade_in_time := $_time_til_end_of_pitch
                          else
                            if (in_range($_velocity8,97,127))
                              $_fade_in_time := $_time_til_end_of_pitch/2
                            end if
                          end if
                        end if
                        if ($_fade_in_time<ticks_to_ms(192))
                          $_fade_in_time := ticks_to_ms(192)
                        end if
                      end if
                      fade_in($_note_id2,$_fade_in_time)
                    else
                      $_ext_first_note := $_first_note
                      $_ext_second_note := $_second_note
                      $_ext_low_note := $_low_note2
                      $_ext_high_note := $_high_note2
                      $_ext_artic := $cur_artic
                      $_wait_time := $_ext_mode_real_legato_time
                      if ($_wait_time>0)
                        select (real_to_int(?xypad_legato[0]*int_to_real(4)))
                          case $legatoMode__syncToPitch
                            $_wait_time := $_real_pitch_length-($_wait_time mod $_real_pitch_length)
                          case $legatoMode__syncToRipple
                            if ($_wait_time mod $_real_ripple_length<=$_real_pitch_length)
                              $_note_chooser := 1
                            end if
                            $_wait_time := $_real_pitch_length-($_wait_time mod $_real_pitch_length)
                          case $legatoMode__syncToSwell
                            if ($_wait_time mod $_real_ripple_length<=$_real_pitch_length)
                              $_note_chooser := 1
                            end if
                            $_ext_pitch := $_wait_time/$_real_pitch_length
                            $_wait_time := $_real_pitch_length-($_wait_time mod $_real_pitch_length)
                        end select
                      end if
                      $_low_vel := %velo[$_note8]-35
                      $_high_vel := $_low_vel+35
                      if ($_high_vel>127)
                        $_high_vel := 127
                      end if
                      if ($_low_vel<1)
                        $_low_vel := 1
                      end if
                      if ($_wait_time>0)
                        wait($_wait_time)
                      end if
                      while (%key_active[$_note8]=1)
                        if ($_note_chooser=0)
                          $_ext_note := $_ext_first_note
                        else
                          $_ext_note := $_ext_second_note
                        end if
                        ~_vel_norm := int_to_real($slider_vol)/1000000.0*(int_to_real(%velo[$_note8])/127.0)
                        $_vel3 := real_to_int(~_vel_norm*int_to_real(127-60))+30
                        if (in_range($_ext_pitch,0,7))
                          $_vel3 := real_to_int(int_to_real($_vel3-30)+((int_to_real($_ext_pitch)-int_to_real(0))/(int_to_real(7)-int_to_real(0))*(int_to_real($_vel3+30)-int_to_real($_vel3-30))))
                        else
                          $_vel3 := real_to_int(int_to_real($_vel3+30)+((int_to_real($_ext_pitch)-int_to_real(8))/(int_to_real(15)-int_to_real(8))*(int_to_real($_vel3-30)-int_to_real($_vel3+30))))
                        end if
                        if ($_note_chooser=1)
                          $_vel3 := $_vel3-20
                        end if
                        if ($_vel3<1)
                          $_vel3 := 1
                        end if
                        if ($_vel3>127)
                          $_vel3 := 127
                        end if
                        if ($_ext_artic=$artic__sixteenths)
                          if ($_note_chooser=0)
                            $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                          else
                            $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                          end if
                        else
                          $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                        end if
                        $_note_id2 := play_note($_ext_note,$_vel3,0,$_len)
                        if ($_ext_artic=$artic__sixteenths)
                          if ($_note_chooser=0)
                            $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                          else
                            $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                          end if
                        else
                          $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                        end if
                        $_wait_time := real_to_int(int_to_real($_wait_time)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
                        if ($_wait_time>0)
                          wait($_wait_time)
                        end if
                        $_ext_pitch := ($_ext_pitch+1) mod 16
                        $_note_chooser := 1-$_note_chooser
                      end while
                      if ($_note_chooser=0)
                        $_ext_note := $_ext_first_note
                      else
                        $_ext_note := $_ext_second_note
                      end if
                      ~_vel_norm := int_to_real($slider_vol)/1000000.0*(int_to_real(%velo[$_note8])/127.0)
                      $_vel3 := real_to_int(~_vel_norm*int_to_real(127-60))+30
                      if (in_range($_ext_pitch,0,7))
                        $_vel3 := real_to_int(int_to_real($_vel3-30)+((int_to_real($_ext_pitch)-int_to_real(0))/(int_to_real(7)-int_to_real(0))*(int_to_real($_vel3+30)-int_to_real($_vel3-30))))
                      else
                        $_vel3 := real_to_int(int_to_real($_vel3+30)+((int_to_real($_ext_pitch)-int_to_real(8))/(int_to_real(15)-int_to_real(8))*(int_to_real($_vel3-30)-int_to_real($_vel3+30))))
                      end if
                      if ($_note_chooser=1)
                        $_vel3 := $_vel3-20
                      end if
                      if ($_vel3<1)
                        $_vel3 := 1
                      end if
                      if ($_vel3>127)
                        $_vel3 := 127
                      end if
                      if ($_ext_artic=$artic__sixteenths)
                        if ($_note_chooser=0)
                          $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                        else
                          $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                        end if
                      else
                        $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                      end if
                      $_note_id2 := play_note($_ext_note,$_vel3,0,$_len)
                      if ($_ext_artic=$artic__sixteenths)
                        if ($_note_chooser=0)
                          $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                        else
                          $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                        end if
                      else
                        $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                      end if
                      $_wait_time := real_to_int(int_to_real($_wait_time)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
                      if ($_wait_time>0)
                        wait($_wait_time)
                      end if
                      $_ext_pitch := ($_ext_pitch+1) mod 16
                      $_note_chooser := 1-$_note_chooser
                      if ($_note_chooser=0)
                        if ($_note_chooser=0)
                          $_ext_note := $_ext_first_note
                        else
                          $_ext_note := $_ext_second_note
                        end if
                        ~_vel_norm := int_to_real($slider_vol)/1000000.0*(int_to_real(%velo[$_note8])/127.0)
                        $_vel3 := real_to_int(~_vel_norm*int_to_real(127-60))+30
                        if (in_range($_ext_pitch,0,7))
                          $_vel3 := real_to_int(int_to_real($_vel3-30)+((int_to_real($_ext_pitch)-int_to_real(0))/(int_to_real(7)-int_to_real(0))*(int_to_real($_vel3+30)-int_to_real($_vel3-30))))
                        else
                          $_vel3 := real_to_int(int_to_real($_vel3+30)+((int_to_real($_ext_pitch)-int_to_real(8))/(int_to_real(15)-int_to_real(8))*(int_to_real($_vel3-30)-int_to_real($_vel3+30))))
                        end if
                        if ($_note_chooser=1)
                          $_vel3 := $_vel3-20
                        end if
                        if ($_vel3<1)
                          $_vel3 := 1
                        end if
                        if ($_vel3>127)
                          $_vel3 := 127
                        end if
                        if ($_ext_artic=$artic__sixteenths)
                          if ($_note_chooser=0)
                            $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                          else
                            $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                          end if
                        else
                          $_len := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                        end if
                        $_note_id2 := play_note($_ext_note,$_vel3,0,$_len)
                        if ($_ext_artic=$artic__sixteenths)
                          if ($_note_chooser=0)
                            $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4)
                          else
                            $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/4*3)
                          end if
                        else
                          $_wait_time := ticks_to_ms(%ripple_length_ticks[$_ext_artic]/2)
                        end if
                        $_wait_time := real_to_int(int_to_real($_wait_time)*?speeds[real_to_int(?xypad_speed[0]*int_to_real(5))])
                        if ($_wait_time>0)
                          wait($_wait_time)
                        end if
                        $_ext_pitch := ($_ext_pitch+1) mod 16
                        $_note_chooser := 1-$_note_chooser
                      end if
                    end if
                  end if
                  inc($ripple_i)
                end while
              end if
            end if
          end if
          if (%_midi_command[1000*$_clip_index9+$_cur_event8]=$MIDI_COMMAND_CC)
            $_cc_num8 := %_midi_byte_1[1000*$_clip_index9+$_cur_event8]
            set_controller($_cc_num8,%_midi_byte_2[1000*$_clip_index9+$_cur_event8])
            wait(1)
            if ($_cc_num8=64)
              if (%CC[$_cc_num8]<10 and ($_prev_cc64>=10))
                $key_i := $LOWEST_KEY
                while ($key_i<=$HIGHEST_KEY)
                  if (%key_active[$key_i]=1 and (%key_down[$key_i]=0))
                    %key_active[$key_i] := 0
                  end if
                  inc($key_i)
                end while
                call release_marked_ripples
              end if
              $_prev_cc64 := %CC[$_cc_num8]
            end if
          end if
          inc($_cur_event8)
        end if
        if ($_cur_event8>%num_midi_events[$_clip_index9])
          %playing[7] := 0
        end if
        if ($button_showMidi=0)
          %playing[7] := 0
        end if
      end while
    end while
    if (%cb_id[7]=$NI_CALLBACK_ID)
      set_control_par(%switch_preview[7],$CONTROL_PAR_VALUE,0)
    end if
  end if
end on

on ui_control($switch_quarters)
  $cur_artic := $artic__quarters
  call update_articulation_switches
  call set_keys_pressed
end on

on ui_control($switch_eighths)
  $cur_artic := $artic__eighths
  call update_articulation_switches
  call set_keys_pressed
end on

on ui_control($switch_sixteenths)
  $cur_artic := $artic__sixteenths
  call update_articulation_switches
  call set_keys_pressed
end on

on ui_control($switch_halfSpeed)
  ?xypad_speed[0] := int_to_real($speedMode__halfSpeed)/int_to_real(5)
  set_control_par(get_ui_id(?xypad_speed),$CONTROL_PAR_PICTURE_STATE,$speedMode__halfSpeed)
  $speed_nks := $speedMode__halfSpeed
  call set_speed
end on

on ui_control($switch_slowTripletSpeed)
  ?xypad_speed[0] := int_to_real($speedMode__slowTripletSpeed)/int_to_real(5)
  set_control_par(get_ui_id(?xypad_speed),$CONTROL_PAR_PICTURE_STATE,$speedMode__slowTripletSpeed)
  $speed_nks := $speedMode__slowTripletSpeed
  call set_speed
end on

on ui_control($switch_fullSpeed)
  ?xypad_speed[0] := int_to_real($speedMode__fullSpeed)/int_to_real(5)
  set_control_par(get_ui_id(?xypad_speed),$CONTROL_PAR_PICTURE_STATE,$speedMode__fullSpeed)
  $speed_nks := $speedMode__fullSpeed
  call set_speed
end on

on ui_control($switch_fastTripletSpeed)
  ?xypad_speed[0] := int_to_real($speedMode__fastTripletSpeed)/int_to_real(5)
  set_control_par(get_ui_id(?xypad_speed),$CONTROL_PAR_PICTURE_STATE,$speedMode__fastTripletSpeed)
  $speed_nks := $speedMode__fastTripletSpeed
  call set_speed
end on

on ui_control($switch_doubleSpeed)
  ?xypad_speed[0] := int_to_real($speedMode__doubleSpeed)/int_to_real(5)
  set_control_par(get_ui_id(?xypad_speed),$CONTROL_PAR_PICTURE_STATE,$speedMode__doubleSpeed)
  $speed_nks := $speedMode__doubleSpeed
  call set_speed
end on

on ui_control($switch_down)
  ?xypad_direction[0] := int_to_real($directionMode__down)/int_to_real(3)
  set_control_par(get_ui_id(?xypad_direction),$CONTROL_PAR_PICTURE_STATE,$directionMode__down)
  $direction_nks := $directionMode__down
  call set_direction
end on

on ui_control($switch_asPlayed)
  ?xypad_direction[0] := int_to_real($directionMode__asPlayed)/int_to_real(3)
  set_control_par(get_ui_id(?xypad_direction),$CONTROL_PAR_PICTURE_STATE,$directionMode__asPlayed)
  $direction_nks := $directionMode__asPlayed
  call set_direction
end on

on ui_control($switch_up)
  ?xypad_direction[0] := int_to_real($directionMode__up)/int_to_real(3)
  set_control_par(get_ui_id(?xypad_direction),$CONTROL_PAR_PICTURE_STATE,$directionMode__up)
  $direction_nks := $directionMode__up
  call set_direction
end on

on ui_control($switch_noLegato)
  ?xypad_legato[0] := int_to_real($legatoMode__noLegato)/int_to_real(4)
  set_control_par(get_ui_id(?xypad_legato),$CONTROL_PAR_PICTURE_STATE,$legatoMode__noLegato)
  $legato_nks := $legatoMode__noLegato
  call set_legato
end on

on ui_control($switch_syncToPitch)
  ?xypad_legato[0] := int_to_real($legatoMode__syncToPitch)/int_to_real(4)
  set_control_par(get_ui_id(?xypad_legato),$CONTROL_PAR_PICTURE_STATE,$legatoMode__syncToPitch)
  $legato_nks := $legatoMode__syncToPitch
  call set_legato
end on

on ui_control($switch_syncToRipple)
  ?xypad_legato[0] := int_to_real($legatoMode__syncToRipple)/int_to_real(4)
  set_control_par(get_ui_id(?xypad_legato),$CONTROL_PAR_PICTURE_STATE,$legatoMode__syncToRipple)
  $legato_nks := $legatoMode__syncToRipple
  call set_legato
end on

on ui_control($switch_syncToSwell)
  ?xypad_legato[0] := int_to_real($legatoMode__syncToSwell)/int_to_real(4)
  set_control_par(get_ui_id(?xypad_legato),$CONTROL_PAR_PICTURE_STATE,$legatoMode__syncToSwell)
  $legato_nks := $legatoMode__syncToSwell
  call set_legato
end on

on ui_control($switch_noReleaseSample)
  ?xypad_releaseSamples[0] := int_to_real($releaseSampleMode__noReleaseSample)/int_to_real(6)
  set_control_par(get_ui_id(?xypad_releaseSamples),$CONTROL_PAR_PICTURE_STATE,$releaseSampleMode__noReleaseSample)
  $releaseSamples_nks := $releaseSampleMode__noReleaseSample
  call set_releaseSamples
end on

on ui_control($switch_autoRelease)
  ?xypad_releaseSamples[0] := int_to_real($releaseSampleMode__autoRelease)/int_to_real(6)
  set_control_par(get_ui_id(?xypad_releaseSamples),$CONTROL_PAR_PICTURE_STATE,$releaseSampleMode__autoRelease)
  $releaseSamples_nks := $releaseSampleMode__autoRelease
  call set_releaseSamples
end on

on ui_control($switch_Release0)
  ?xypad_releaseSamples[0] := int_to_real($releaseSampleMode__Release0)/int_to_real(6)
  set_control_par(get_ui_id(?xypad_releaseSamples),$CONTROL_PAR_PICTURE_STATE,$releaseSampleMode__Release0)
  $releaseSamples_nks := $releaseSampleMode__Release0
  call set_releaseSamples
end on

on ui_control($switch_Release1)
  ?xypad_releaseSamples[0] := int_to_real($releaseSampleMode__Release1)/int_to_real(6)
  set_control_par(get_ui_id(?xypad_releaseSamples),$CONTROL_PAR_PICTURE_STATE,$releaseSampleMode__Release1)
  $releaseSamples_nks := $releaseSampleMode__Release1
  call set_releaseSamples
end on

on ui_control($switch_Release2)
  ?xypad_releaseSamples[0] := int_to_real($releaseSampleMode__Release2)/int_to_real(6)
  set_control_par(get_ui_id(?xypad_releaseSamples),$CONTROL_PAR_PICTURE_STATE,$releaseSampleMode__Release2)
  $releaseSamples_nks := $releaseSampleMode__Release2
  call set_releaseSamples
end on

on ui_control($switch_Release3)
  ?xypad_releaseSamples[0] := int_to_real($releaseSampleMode__Release3)/int_to_real(6)
  set_control_par(get_ui_id(?xypad_releaseSamples),$CONTROL_PAR_PICTURE_STATE,$releaseSampleMode__Release3)
  $releaseSamples_nks := $releaseSampleMode__Release3
  call set_releaseSamples
end on

